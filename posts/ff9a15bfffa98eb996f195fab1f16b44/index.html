<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>《学会 SpringMVC 系列 · 剖析篇（上）》 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/ff9a15bfffa98eb996f195fab1f16b44/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="《学会 SpringMVC 系列 · 剖析篇（上）》">
  <meta property="og:description" content="📢 大家好，我是 【战神刘玉栋】，有10多年的研发经验，致力于前后端技术栈的知识沉淀和传播。 💗
🌻 CSDN入驻不久，希望大家多多支持，后续会继续提升文章质量，绝不滥竽充数，欢迎多多交流。👍
文章目录 写在前面的话学前准备 请求流程分析Step1、DispatcherServlet#doDispatchStep2、DispatcherServlet#getHandlerStep3、DispatcherServlet#getHandlerAdapterStep4、DispatcherServlet#handleStep5、InvocableHandlerMethod#getMethodArgumentValuesStep6、InvocableHandlerMethod#doInvokeStep7、HandlerMethodReturnValueHandlerComposite#handleReturnValueStep8、RequestResponseBodyMethodProcessor#writeWithMessageConverters 请求分析复盘整个流程梳理（精简版）doDispatch（部分代码） 总结陈词 写在前面的话 通过上一篇博文《学会 SpringMVC 系列 · 基础篇》的学习，可以掌握 SpringMVC 的项目搭建和部分用法，从搭建过程中我们看到，SpringMVC 的入口是在 web.xml 中添加 DispatcherServlet，它是一个Servlet，那请求流程也遵循 Servlet 相关规范展开。
接下来，让我们进一步分析相关源码，顺带引出相关扩展点和实战运用。
学前准备 1、SpringMVC 源码分析分为初始化流程和请求流程两部分，本篇先重点介绍后者。可以把 SpringMVC的请求流程，比作一个请求（Servlet）的完整生命周期，那就是包括“请求前 - 实际请求 - 请求后”，以此思路展开；
2、本篇 SpringMVC 源码分析系列文章，将以 《搭建拥有数据交互的 SpringBoot 》的 SpringBoot3.x 为基础，学习相关源码，对应 SpringMVC 版本为 6.1.11，不过核心流程上，基本大同小异；
3、先添加一个入参和返回值都是实体对象的接口，如下所示，正所谓麻雀虽小，但也覆盖到入参解析逻辑了，启动Boot项目，Postman测试一下，恩，功能都正常，可以开始源码学习了！
@ResponseBody @RequestMapping(&#34;/studyJson&#34;) public ZyTeacherInfo studyJson(@RequestBody ZyTeacherInfo teacherInfo) { teacherInfo.setTeaName(&#34;战神&#34;); return teacherInfo; } 相关文章
《学会 SpringMVC 系列 · 剖析篇（上）》
请求流程分析 Tips：先通过示例方法的执行，梳理一下相对完整的链路，后续在此基础上扩展自定义逻辑。
Step1、DispatcherServlet#doDispatch 前面提到 DispatcherServlet 是 SpringMVC 的入口，不管是否为 SpringBoot 项目，都是如此。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-31T22:31:59+08:00">
    <meta property="article:modified_time" content="2024-07-31T22:31:59+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">《学会 SpringMVC 系列 · 剖析篇（上）》</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>📢 大家好，我是 【战神刘玉栋】，有10多年的研发经验，致力于前后端技术栈的知识沉淀和传播。 💗<br> 🌻 CSDN入驻不久，希望大家多多支持，后续会继续提升文章质量，绝不滥竽充数，欢迎多多交流。👍</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_9" rel="nofollow">写在前面的话</a></li><li><ul><li><a href="#_15" rel="nofollow">学前准备</a></li></ul> 
   </li><li><a href="#_34" rel="nofollow">请求流程分析</a></li><li><ul><li><a href="#Step1DispatcherServletdoDispatch_38" rel="nofollow">Step1、DispatcherServlet#doDispatch</a></li><li><a href="#Step2DispatcherServletgetHandler_48" rel="nofollow">Step2、DispatcherServlet#getHandler</a></li><li><a href="#Step3DispatcherServletgetHandlerAdapter_82" rel="nofollow">Step3、DispatcherServlet#getHandlerAdapter</a></li><li><a href="#Step4DispatcherServlethandle_122" rel="nofollow">Step4、DispatcherServlet#handle</a></li><li><a href="#Step5InvocableHandlerMethodgetMethodArgumentValues_169" rel="nofollow">Step5、InvocableHandlerMethod#getMethodArgumentValues</a></li><li><a href="#Step6InvocableHandlerMethoddoInvoke_242" rel="nofollow">Step6、InvocableHandlerMethod#doInvoke</a></li><li><a href="#Step7HandlerMethodReturnValueHandlerCompositehandleReturnValue_248" rel="nofollow">Step7、HandlerMethodReturnValueHandlerComposite#handleReturnValue</a></li><li><a href="#Step8RequestResponseBodyMethodProcessorwriteWithMessageConverters_280" rel="nofollow">Step8、RequestResponseBodyMethodProcessor#writeWithMessageConverters</a></li></ul> 
   </li><li><a href="#_317" rel="nofollow">请求分析复盘</a></li><li><ul><li><a href="#_319" rel="nofollow">整个流程梳理（精简版）</a></li><li><a href="#doDispatch_364" rel="nofollow">doDispatch（部分代码）</a></li></ul> 
   </li><li><a href="#_459" rel="nofollow">总结陈词</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><img src="https://images2.imgbox.com/1c/12/D6HEHqLe_o.gif" alt="CSDN.gif"></p> 
<h3><a id="_9"></a>写在前面的话</h3> 
<p>通过上一篇博文<a href="https://zhanshen.blog.csdn.net/article/details/140799689" rel="nofollow">《学会 SpringMVC 系列 · 基础篇》</a>的学习，可以掌握 SpringMVC 的项目搭建和部分用法，从搭建过程中我们看到，SpringMVC 的入口是在 web.xml 中添加 DispatcherServlet，它是一个Servlet，那请求流程也遵循 Servlet 相关规范展开。<br> 接下来，让我们进一步分析相关源码，顺带引出相关扩展点和实战运用。</p> 
<hr> 
<h4><a id="_15"></a>学前准备</h4> 
<p>1、SpringMVC 源码分析分为初始化流程和请求流程两部分，本篇先重点介绍后者。可以把 SpringMVC的请求流程，比作一个请求（Servlet）的完整生命周期，那就是包括“请求前 - 实际请求 - 请求后”，以此思路展开；<br> 2、本篇 SpringMVC 源码分析系列文章，将以 <a href="https://zhanshen.blog.csdn.net/article/details/140621952" rel="nofollow">《搭建拥有数据交互的 SpringBoot 》</a>的 SpringBoot3.x 为基础，学习相关源码，对应 SpringMVC 版本为 6.1.11，不过核心流程上，基本大同小异；<br> 3、先添加一个入参和返回值都是实体对象的接口，如下所示，正所谓麻雀虽小，但也覆盖到入参解析逻辑了，启动Boot项目，Postman测试一下，恩，功能都正常，可以开始源码学习了！</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/studyJson"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ZyTeacherInfo</span> <span class="token function">studyJson</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ZyTeacherInfo</span> teacherInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    teacherInfo<span class="token punctuation">.</span><span class="token function">setTeaName</span><span class="token punctuation">(</span><span class="token string">"战神"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> teacherInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ae/fc/qnqjb19P_o.png" alt="image.png"></p> 
<p><strong>相关文章</strong><br> <a href="https://zhanshen.blog.csdn.net/article/details/140809735" rel="nofollow">《学会 SpringMVC 系列 · 剖析篇（上）》</a></p> 
<hr> 
<h3><a id="_34"></a>请求流程分析</h3> 
<blockquote> 
 <p>Tips：先通过示例方法的执行，梳理一下相对完整的链路，后续在此基础上扩展自定义逻辑。</p> 
</blockquote> 
<h4><a id="Step1DispatcherServletdoDispatch_38"></a>Step1、DispatcherServlet#doDispatch</h4> 
<p>前面提到 DispatcherServlet 是 SpringMVC 的入口，不管是否为 SpringBoot 项目，都是如此。<br> 从下面这张图很明显可以看出 DispatcherServlet 和 Servlet 的父子关系。<br> <img src="https://images2.imgbox.com/53/2c/ipumAcNk_o.png" alt="image.png"><br> 有过 JavaWeb 开发经验的人应该了解，Servlet 的请求入口方法是 service 方法。在访问接口后，可以把断点停留在 DispatcherServlet#doDispatch 方法，可以从IDEA的调试器，观察到请求的调用栈信息。<br> 这边先不展开细节，后续再按专栏展开，总之是在 DispatcherServlet、FrameworkServlet、HttpServlet 等类之间反复横跳，最后到了 doDispatch，当然，这里面才是请求的核心逻辑。<br> <img src="https://images2.imgbox.com/db/57/DyCsmm3Y_o.png" alt="image.png"></p> 
<hr> 
<h4><a id="Step2DispatcherServletgetHandler_48"></a>Step2、DispatcherServlet#getHandler</h4> 
<p><strong>关键代码：</strong><code>HandlerExecutionChain mappedHandler = getHandler(processedRequest);</code><br> <strong>逻辑说明：</strong></p> 
<ul><li>目的是获取 HandlerExecutionChain 执行链对象，除了包含 HandlerMethod 方法（具体 Controller 的方法），还包含拦截器信息；</li><li>执行过程，如下图所示，遍历 HandlerMapping 列表（在初始化时加载列表），依次执行 HandlerMapping 的 getHandler 方法，仅有 RequestMappingHandlerMapping 满足，同时在其父类 AbstractHandlerMapping 的方法 getHandlerExecutionChain 中，会加载拦截器链，如图二所示；</li></ul> 
<p><img src="https://images2.imgbox.com/c2/1f/L5lmgkXm_o.png" alt="image.png"><br> <img src="https://images2.imgbox.com/8e/2e/QQyMYnET_o.png" alt="image.png"><br> 如上图所示，获取到的 HandlerExecutionChain 对象，指向具体业务接口，并且包含三个内置拦截器。<br> 到此，DispatcherServlet#getHandler 流程基本结束。</p> 
<p><strong>题外话 - 如何判定 RequestMappingHandlerMapping：</strong><br> 在 SpringBoot 开发中，大部分接口添加了 @Controller 注解，示例方法也是如此，从<code>RequestMappingHandlerMapping#isHandler</code> 的代码也可以看出来，只要类包含 @Controller 注解，就可以满足加载要求。</p> 
<blockquote> 
 <p>Tips：SpringMVC的5.x，也允许只存在 RequestMapping 注解的情况，6.x 只剩下Controller了。<br> Tips：该方法是服务启动的时候，逐个Bean去调用该方法，判定归属，后续再展开介绍。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHandler</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>beanType<span class="token punctuation">,</span> <span class="token class-name">Controller</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>Tips：另外，RequestMappingHandlerMapping 会在初始化的时候会将<code>url/controller的映射</code>存到handlerMethods 变量中，<code>url/mapping的映射</code>存在urlMap变量中，如下所示，目的是方便快速查找。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">&gt;</span></span> handlerMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> urlMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>温馨提示：很多代码还可继续深挖，但建议分析源码还是要把握主线、浅尝辄止，不然深陷其中，无法自拔，当然，后续会针对每个重要板块单独展开分析，本篇只是展示一个全貌。</strong></p> 
</blockquote> 
<hr> 
<h4><a id="Step3DispatcherServletgetHandlerAdapter_82"></a>Step3、DispatcherServlet#getHandlerAdapter</h4> 
<p><strong>关键代码：</strong><code>HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</code><br> <strong>逻辑说明：</strong></p> 
<ul><li>目的是获取 HandlerAdapter 处理器对象（虽然单词是适配器，实际做的是处理器的事情），逻辑有点类似前面找Mapping 的方式；</li><li>如下图所示，从 HandlerAdapter 列表遍历，依次寻找符合要求的，匹配到 RequestMappingHandlerAdapter；</li></ul> 
<p><img src="https://images2.imgbox.com/e5/12/zd3lSSWY_o.png" alt="image.png"></p> 
<ul><li>如下方代码也可以看出，是根据 supports 方法判断 adapter 是否支持这个 handler，很明显这个要求很简单，RequestMappingHandlerAdapter 是肯定满足的；</li></ul> 
<pre><code class="prism language-java"><span class="token comment">// 存在父类 AbstractHandlerMethodAdapter#supports</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 判断handler是否属于HandlerMethod  并且 supportsInternal 为true</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span> <span class="token operator">&amp;&amp;</span> <span class="token function">supportsInternal</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>题外话：getHandlerAdapter 添加注释信息</strong><br> 如下所示，看起来和前面获取 HandlerExecutionChain 的获取逻辑差不多。</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">HandlerAdapter</span> <span class="token function">getHandlerAdapter</span><span class="token punctuation">(</span><span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//遍历所有handlerAdapters 选择合适的handlerAdapters</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HandlerAdapter</span> ha <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerAdapters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Testing handler adapter ["</span> <span class="token operator">+</span> ha <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//判断这个adapter是否支持这个handler</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ha<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> ha<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">"No adapter for handler ["</span> <span class="token operator">+</span> handler <span class="token operator">+</span>
			<span class="token string">"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr> 
<h4><a id="Step4DispatcherServlethandle_122"></a>Step4、DispatcherServlet#handle</h4> 
<p>接下来到了核心代码片段，直接看如下代码：可以看到 handle 才是绝对的核心，前后包裹了前置和后置拦截器。</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedHandler<span class="token punctuation">.</span><span class="token function">applyPreHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Actually invoke the handler.</span>
mv <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mappedHandler<span class="token punctuation">.</span><span class="token function">applyPostHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>逻辑说明：</strong><br> 1、此时已经得到 HandlerAdapter，先执行所有拦截器的 applyPreHandle 方法；<br> 2、接着调用其 handle 方法，再执行拦截器的 applyPostHandle 方法；<br> 3、这里的 handle 是主要逻辑，由于 RequestMappingHandlerAdapter 没有 handle 方法，所以进入父类的 handle，再经过一系列方法，最终进入InvocableHandlerMethod#invokeForRequest；</p> 
<pre><code class="prism language-java"><span class="token comment">//请求链路：</span>
<span class="token comment">// AbstractHandlerMethodAdapter#handle</span>
<span class="token comment">// RequestMappingHandlerAdapter#invokeHandleMethod</span>
<span class="token comment">// ServletInvocableHandlerMethod#invokeAndHandle</span>
<span class="token comment">// InvocableHandlerMethod#invokeForRequest，下方代码（参数解析和实际请求）</span>
<span class="token comment">// HandlerMethodReturnValueHandlerComposite#returnValueHandlers（返回值处理）</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">invokeForRequest</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span>
		<span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> providedArgs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	
    <span class="token comment">// 利用参数解析器解析参数，最终得到参数列表</span>
	<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token function">getMethodArgumentValues</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> providedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"Invoking ["</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getBeanType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"] method with arguments "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">//此处执行反射调用controller的方法</span>
	<span class="token class-name">Object</span> returnValue <span class="token operator">=</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Method ["</span> <span class="token operator">+</span> <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] returned ["</span> <span class="token operator">+</span> returnValue <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> returnValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h4><a id="Step5InvocableHandlerMethodgetMethodArgumentValues_169"></a>Step5、InvocableHandlerMethod#getMethodArgumentValues</h4> 
<p>接上回，getMethodArgumentValues 这步通俗一点来说，就是解析参数，得到最后的参数列表。<br> 部分代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getMethodArgumentValues</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span>
		<span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> providedArgs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

	<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>parameters<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parameters<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 判断是否支持解析这个参数，如果支持会把参数解析器加入到缓存中</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolvers<span class="token punctuation">.</span><span class="token function">supportsParameter</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token function">formatArgumentError</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> <span class="token string">"No suitable resolver"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		    <span class="token comment">解析请求参数</span>
			args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolvers<span class="token punctuation">.</span><span class="token function">resolveArgument</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataBinderFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> args<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中，最重要的方法应该是 resolveArgument，其部分代码如下，逻辑也是把所有参数解析器拿出来溜溜，看看哪个解析器的 supportsParameter 方法满足。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">resolveArgument</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> parameter<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span>
		<span class="token class-name">NativeWebRequest</span> webRequest<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">WebDataBinderFactory</span> binderFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">HandlerMethodArgumentResolver</span> resolver <span class="token operator">=</span> <span class="token function">getArgumentResolver</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> resolver<span class="token punctuation">.</span><span class="token function">resolveArgument</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> webRequest<span class="token punctuation">,</span> binderFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">HandlerMethodArgumentResolver</span> <span class="token function">getArgumentResolver</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">HandlerMethodArgumentResolver</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentResolverCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HandlerMethodArgumentResolver</span> resolver <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentResolvers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>resolver<span class="token punctuation">.</span><span class="token function">supportsParameter</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				result <span class="token operator">=</span> resolver<span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>argumentResolverCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>不出意外，满足的是 RequestResponseBodyMethodProcessor，运行截图如下，从27个参数解析器中选中了这个。<br> <img src="https://images2.imgbox.com/0f/28/U0Jh6w3y_o.png" alt="image.png"><br> 流程重新梳理一下：</p> 
<ol><li>遍历所有参数列表，依次利用 supportsParameter 方法，判断是否有解析器是否满足；</li><li>再进行下面的一系列判定逻辑，最终可以找到 RequestResponseBodyMethodProcessor 这一解析器是符合的，紧接着把参数解析器放到 argumentResolverCache 缓存中；</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsParameter</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> parameter<span class="token punctuation">.</span><span class="token function">hasParameterAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RequestBody</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsReturnType</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>returnType<span class="token punctuation">.</span><span class="token function">getContainingClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ResponseBody</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">||</span>
			returnType<span class="token punctuation">.</span><span class="token function">hasMethodAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ResponseBody</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>最终调用RequestResponseBodyMethodProcessor 的 resolveArgument 进行参数解析；</li></ol> 
<blockquote> 
 <p>Tips：这里其实又是一个适配器的套路（适配器模式），Spring为我们提供了多种场景的支持。</p> 
</blockquote> 
<p><strong>题外话：如何是 @RequestParam 注解呢？</strong><br> 如果接口的参数使用 @RequestParam 注解，那么这里满足的是 RequestParamMethodArgumentResolver ，运行截图如下，当然它也是第一顺位。<br> 值得一提，如果没找到合适的参数处理器，那么最后还是会用 RequestParamMethodArgumentResolver 兜底，此时后话，暂且不提。<br> <img src="https://images2.imgbox.com/61/a6/HOEAFGaW_o.png" alt="image.png"></p> 
<hr> 
<h4><a id="Step6InvocableHandlerMethoddoInvoke_242"></a>Step6、InvocableHandlerMethod#doInvoke</h4> 
<p>接前面的<code>InvocableHandlerMethod#invokeForRequest</code>，在执行完<code>getMethodArgumentValues</code>获得最终参数列表后，就直接调用<code>InvocableHandlerMethod#doInvoke</code>进行真实逻辑调用，得到返回值。<br> 利用的是反射机制，细节不展开，后续专栏再补充说明。</p> 
<hr> 
<h4><a id="Step7HandlerMethodReturnValueHandlerCompositehandleReturnValue_248"></a>Step7、HandlerMethodReturnValueHandlerComposite#handleReturnValue</h4> 
<p>实际业务接口执行完，也拿到了返回值，接下来就该针对返回值进行加工处理。<br> 部分代码如下，又是一样的讨论，先从返回值处理器的列表里面，找到匹配的，然后执行处理逻辑。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleReturnValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> returnValue<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span>
		<span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span> webRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//找到合适的返回值处理器</span>
    <span class="token class-name">HandlerMethodReturnValueHandler</span> handler <span class="token operator">=</span> <span class="token function">selectHandler</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> returnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown return value type: "</span> <span class="token operator">+</span> returnType<span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">//执行处理逻辑</span>
	handler<span class="token punctuation">.</span><span class="token function">handleReturnValue</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> returnType<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">HandlerMethodReturnValueHandler</span> <span class="token function">selectHandler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">boolean</span> isAsyncValue <span class="token operator">=</span> <span class="token function">isAsyncReturnValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> returnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HandlerMethodReturnValueHandler</span> handler <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>isAsyncValue <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">AsyncHandlerMethodReturnValueHandler</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">supportsReturnType</span><span class="token punctuation">(</span>returnType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> handler<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/98/ec/qeyTiOY9_o.png" alt="image.png"></p> 
<hr> 
<h4><a id="Step8RequestResponseBodyMethodProcessorwriteWithMessageConverters_280"></a>Step8、RequestResponseBodyMethodProcessor#writeWithMessageConverters</h4> 
<p>接上回，进去 RequestResponseBodyMethodProcessor 返回值处理器。<br> 这里还要再经历一次消息转换器遍历，找到合适的，进行逻辑处理。<br> <img src="https://images2.imgbox.com/f4/e9/b4bNGGtY_o.png" alt="image.png"><br> <img src="https://images2.imgbox.com/36/ec/HvXMSRg2_o.png" alt="image.png"><br> 接着进入write逻辑，如下所示，经过<code>outputMessage.getBody().flush()</code>，数据已经输出给调用方了。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">T</span> t<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaType</span> contentType<span class="token punctuation">,</span> <span class="token class-name">HttpOutputMessage</span> outputMessage<span class="token punctuation">)</span>
		<span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">HttpMessageNotWritableException</span> <span class="token punctuation">{<!-- --></span>
    
	<span class="token keyword">final</span> <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> outputMessage<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token function">addDefaultHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> t<span class="token punctuation">,</span> contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token keyword">if</span> <span class="token punctuation">(</span>outputMessage <span class="token keyword">instanceof</span> <span class="token class-name">StreamingHttpOutputMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">StreamingHttpOutputMessage</span> streamingOutputMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StreamingHttpOutputMessage</span><span class="token punctuation">)</span> outputMessage<span class="token punctuation">;</span>
		streamingOutputMessage<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>outputStream <span class="token operator">-&gt;</span> <span class="token function">writeInternal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpOutputMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token class-name">OutputStream</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> outputStream<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token class-name">HttpHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> headers<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">writeInternal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> outputMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		outputMessage<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>write 完毕之后，请求链路又回到DispatcherServlet#doDispatch，再来后置拦截器等处理，这边暂且不继续展开。</p> 
<hr> 
<h3><a id="_317"></a>请求分析复盘</h3> 
<h4><a id="_319"></a>整个流程梳理（精简版）</h4> 
<blockquote> 
 <p>Tips：上述分析流程精简一下，可以得出如下结论。</p> 
</blockquote> 
<p>1、总入口 DispatcherServlet，最底层其实是 HttpServlet#service<br> 2、根据请求URL，找到处理方法Method，DispatcherServlet#getHandler<br> 3、参数处理，HandlerMethodArgumentResolver，RequestResponseBodyMethodProcessor<br> 4、执行原方法逻辑，invoke<br> 5、返回值处理，HandlerMethodReturnValueHandler，RequestResponseBodyMethodProcessor</p> 
<p><strong>【补充：上述流程分析】</strong><br> 1、HandlerMapping 阶段，匹配到一个HandlerMapping，通过Url找到某个controller的某个方法。返回HandlerExecutionChain 对象；<br> 2、根据HandlerMethod匹配到某个HandlerAdapter，也就是我们的RequestMappingHandlerAdapter；<br> 3、this.argumentResolvers.supportsParameter(parameter)匹配参数处理器，这里会匹配到RequestResponseBodyMethodProcessor；<br> 4、从messageConverters集合中匹配出参数转换器，这里是MappingJackson2HttpMessageConverter。调用Jackson API转换成对象；<br> 5、得到参数后，利用反射执行某个controller中某个方法；<br> 从这里我们可以看出，Spring框架是相当灵活的，适配器模式是被其发挥得淋漓尽致。支持我们自定义HandlerMapping、HandlerAdapter、messageConverters等等，以适应更多的应用场景。</p> 
<blockquote> 
 <p>Tips：虽然可以注册多个 argumentResolver 和 messageConverters，但最终只会选择一个合适的执行。</p> 
</blockquote> 
<p><strong>【补充：@RequestBody 介绍】</strong><br> @RequestBody 注解是 Spring MVC 中的一个注解，用于指示控制器方法参数应该绑定到 HTTP 请求的主体（body）部分。当客户端向服务器发送 POST 或 PUT 请求时，请求的数据通常包含在请求主体中，而不是在 URL 参数中。@RequestBody 注解告诉 Spring MVC 框架将请求主体中的数据反序列化为指定的 Java 对象，并将其作为方法的参数传递给控制器方法。<br> 具体来说，@RequestBody 注解的作用包括以下几个方面：<br> 反序列化请求主体： 当客户端发送一个包含 JSON、XML 等格式的数据主体的 POST 或 PUT 请求时，Spring MVC 框架将请求主体中的数据反序列化为指定的 Java 对象。这个过程通常使用 Jackson、JAXB 等库来完成，将请求主体中的数据转换为相应的 Java 对象。<br> 绑定到方法参数： 反序列化后的 Java 对象将作为 @RequestBody 注解标注的方法参数的值传递给控制器方法。通过使用 @RequestBody 注解，你可以直接将请求主体中的数据映射到方法参数，而不必手动解析请求主体或处理输入流。<br> 处理多种数据格式： @RequestBody 注解不仅可以处理 JSON 格式的数据，还可以处理 XML、表单数据等多种格式的数据。Spring MVC 框架会根据请求的 Content-Type 头部来确定请求主体的数据格式，并使用相应的消息转换器（MessageConverter）来进行反序列化。<br> 综上所述，@RequestBody 注解在 Spring MVC 中的作用是将请求主体中的数据反序列化为指定的 Java 对象，并绑定到控制器方法的参数上，使得控制器方法能够直接处理请求主体中的数据。</p> 
<p><strong>【补充：关于 HandlerMapping 和 HandlerAdapter 的初始化】</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initStrategies</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//初始化HandlerMappings</span>
	<span class="token function">initHandlerMappings</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化HandlerAdapters</span>
	<span class="token function">initHandlerAdapters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>HandlerMapping和HandlerAdapter是可以多个的，Spring默认会注册几个HandlerMapping（如BeanNameUrlHandlerMapping、SimpleUrlHandlerMapping），有请求来的时候，去匹配到合适的那个。<br> 在Spring MVC时代，我们通常会显式去注册一个HandlerMapping和HandlerAdapter，分别是RequestMappingHandlerMapping和RequestMappingHandlerAdapter。<br> 当然要使用MappingJackson2HttpMessageConverter转换器还需要jackson-databind、jackson-core、jackson-mapper-lgpl、jackson-mapper-asl、jackson-core-lgpl、jackson-core-asl这些Jar包。<br> HandlerAdapter 和 HandlerMapping 也是类似的逻辑，一样是支持多个，默认注册HttpRequestHandlerAdapter、SimpleControllerHandlerAdapter。</p> 
<hr> 
<h4><a id="doDispatch_364"></a>doDispatch（部分代码）</h4> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doDispatch</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">HttpServletRequest</span> processedRequest <span class="token operator">=</span> request<span class="token punctuation">;</span>
	<span class="token class-name">HandlerExecutionChain</span> mappedHandler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> multipartRequestParsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

	<span class="token class-name">WebAsyncManager</span> asyncManager <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">ModelAndView</span> mv <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">Exception</span> dispatchException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 检查是否是文件上传的请求</span>
			processedRequest <span class="token operator">=</span> <span class="token function">checkMultipart</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			multipartRequestParsed <span class="token operator">=</span> <span class="token punctuation">(</span>processedRequest <span class="token operator">!=</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 找出处理这个请求的执行链对象 HandlerExecutionChain，包含方法和拦截器</span>
			mappedHandler <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">noHandlerFound</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

            <span class="token comment">// 根据 HandlerMethod 获取处理器 HandlerAdapter</span>
			<span class="token class-name">HandlerAdapter</span> ha <span class="token operator">=</span> <span class="token function">getHandlerAdapter</span><span class="token punctuation">(</span>mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Process last-modified header, if supported by the handler.</span>
			<span class="token class-name">String</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">boolean</span> isGet <span class="token operator">=</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>isGet <span class="token operator">||</span> <span class="token string">"HEAD"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//RequestMappingHandlerAdapter#getLastModified返回-1</span>
				<span class="token keyword">long</span> lastModified <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">getLastModified</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Last-Modified value for ["</span> <span class="token operator">+</span> <span class="token function">getRequestUri</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] is: "</span> <span class="token operator">+</span> lastModified<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 检测是否未改变 并且 是get请求</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletWebRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkNotModified</span><span class="token punctuation">(</span>lastModified<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isGet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// 执行拦截器的前置处理方法 applyPreHandle</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedHandler<span class="token punctuation">.</span><span class="token function">applyPreHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
				<span class="token comment">//不为true则return</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 执行实际的处理器处理请求，这步骤是最核心的</span>
			mv <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// 视图对象的处理，mv不为null并且view不存在则应用默认的viewName</span>
			<span class="token function">applyDefaultViewName</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
			<span class="token comment">// 执行拦截器的后置处理方法 postHandle</span>
			mappedHandler<span class="token punctuation">.</span><span class="token function">applyPostHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			dispatchException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
		<span class="token comment">//请求成功响应之后的方法，即要解析为ModelAndView或异常。</span>
		<span class="token function">processDispatchResult</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> mv<span class="token punctuation">,</span> dispatchException<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 主要是发生异常时执行拦截器afterCompletion方法</span>
		<span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">triggerAfterCompletionWithError</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 执行拦截器 afterCompletion</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				mappedHandler<span class="token punctuation">.</span><span class="token function">applyAfterConcurrentHandlingStarted</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Clean up any resources used by a multipart request.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>multipartRequestParsed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">cleanupMultipart</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h3><a id="_459"></a>总结陈词</h3> 
<p>此篇文章介绍了<code>SpringMVC</code> 请求流程的源码分析，仅供参考。<br> 无论是 handlerAdapters 还是 argumentResolvers，或者其他，基本几个用法都类似。</p> 
<ol><li>预先加载List</li><li>遍历List判断是否满足</li><li>适配器思想</li><li>缓存复用思想</li><li>。。。</li></ol> 
<p>篇幅所限，主要介绍了一个具体请求的流程，后续系列文章会针对其中重要步骤继续展开介绍，同时添加实战说明。<br> 💗 后续会逐步分享企业实际开发中的实战经验，有需要交流的可以联系博主。</p> 
<p><img src="https://images2.imgbox.com/0a/03/FCajqpgx_o.gif" alt="CSDN_END.gif"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9a8efd4c1d12b896772cdd9b7323d654/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">string类简单模拟实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/21eadf99ff106b104b8bdd9fdd969033/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">postman接口测试工具介绍与使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>