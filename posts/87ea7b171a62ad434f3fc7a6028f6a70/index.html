<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Golang TCP网络编程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/87ea7b171a62ad434f3fc7a6028f6a70/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Golang TCP网络编程">
  <meta property="og:description" content="文章目录 网络编程介绍TCP网络编程服务器监听客户端连接服务器服务端获取连接向连接中写入数据从连接中读取数据关闭连接/监听器 简易的TCP回声服务器效果展示服务端处理逻辑客户端处理逻辑 网络编程介绍 网络编程介绍
网络编程是指通过计算机网络实现程序间通信的一种编程技术，涉及到在不同计算机之间建立连接、传输数据和协议解析等操作。套接字（Socket）编程是网络编程的一种实现方式，其提供了一种机制，使得应用程序能够通过网络进行数据传输和通信。Go中的net包是标准库中提供的网络编程包，是基于套接字编程的一种实现方式，提供了对TCP、UDP、IP、ICMP、Unix域套接字等常见网络协议的支持，通过net包可以完成创建套接字、建立连接、发送和接收数据等操作，实现网络通信。 TCP网络编程 服务器监听 服务器监听
在Go的net包中，Listen函数用于创建并返回一个网络监听器（Listener），以监听指定网络地址和端口上的连接请求。该函数的函数原型如下：
func Listen(network, address string) (Listener, error) 参数说明：
network：用于指定网络类型，其值必须是&#34;tcp&#34;, “tcp4”, “tcp6”, “unix&#34;或&#34;unixpacket”。address：用于指定需要被监听的IP地址和端口号，格式为&#34;host:port&#34;。 返回值说明：
第一个返回值：表示创建的网络监听器。第二个返回值：如果创建网络监听器过程中出错，将返回非nil的错误值。 通过Listen函数创建得到的网络监听器是Listener类型的，该类型是一个接口类型，其定义如下：
type Listener interface { // Accept waits for and returns the next connection to the listener. Accept() (Conn, error) // Close closes the listener. // Any blocked Accept operations will be unblocked and return errors. Close() error // Addr returns the listener&#39;s network address. Addr() Addr } Listener接口中各方法说明：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-03T21:13:41+08:00">
    <meta property="article:modified_time" content="2024-06-03T21:13:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Golang TCP网络编程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">网络编程介绍</a></li><li><a href="#TCP_9" rel="nofollow">TCP网络编程</a></li><li><ul><li><a href="#_10" rel="nofollow">服务器监听</a></li><li><a href="#_121" rel="nofollow">客户端连接服务器</a></li><li><a href="#_234" rel="nofollow">服务端获取连接</a></li><li><a href="#_297" rel="nofollow">向连接中写入数据</a></li><li><a href="#_317" rel="nofollow">从连接中读取数据</a></li><li><a href="#_336" rel="nofollow">关闭连接/监听器</a></li></ul> 
  </li><li><a href="#TCP_351" rel="nofollow">简易的TCP回声服务器</a></li><li><ul><li><a href="#_353" rel="nofollow">效果展示</a></li><li><a href="#_366" rel="nofollow">服务端处理逻辑</a></li><li><a href="#_442" rel="nofollow">客户端处理逻辑</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>网络编程介绍</h2> 
<blockquote> 
 <p>网络编程介绍</p> 
</blockquote> 
<ul><li>网络编程是指通过计算机网络实现程序间通信的一种编程技术，涉及到在不同计算机之间建立连接、传输数据和协议解析等操作。</li><li>套接字（Socket）编程是网络编程的一种实现方式，其提供了一种机制，使得应用程序能够通过网络进行数据传输和通信。</li><li>Go中的net包是标准库中提供的网络编程包，是基于套接字编程的一种实现方式，提供了对TCP、UDP、IP、ICMP、Unix域套接字等常见网络协议的支持，通过net包可以完成创建套接字、建立连接、发送和接收数据等操作，实现网络通信。</li></ul> 
<h2><a id="TCP_9"></a>TCP网络编程</h2> 
<h3><a id="_10"></a>服务器监听</h3> 
<blockquote> 
 <p>服务器监听</p> 
</blockquote> 
<p>在Go的net包中，Listen函数用于创建并返回一个网络监听器（Listener），以监听指定网络地址和端口上的连接请求。该函数的函数原型如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Listen</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Listener<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul><li>network：用于指定网络类型，其值必须是"tcp", “tcp4”, “tcp6”, “unix"或"unixpacket”。</li><li>address：用于指定需要被监听的IP地址和端口号，格式为"host:port"。</li></ul> 
<p><strong>返回值说明：</strong></p> 
<ul><li>第一个返回值：表示创建的网络监听器。</li><li>第二个返回值：如果创建网络监听器过程中出错，将返回非nil的错误值。</li></ul> 
<p>通过Listen函数创建得到的网络监听器是Listener类型的，该类型是一个接口类型，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Listener <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Accept waits for and returns the next connection to the listener.</span>
	<span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token comment">// Close closes the listener.</span>
	<span class="token comment">// Any blocked Accept operations will be unblocked and return errors.</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// Addr returns the listener's network address.</span>
	<span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Addr
<span class="token punctuation">}</span>
</code></pre> 
<p>Listener接口中各方法说明：</p> 
<ul><li>Accept方法：从底层获取下一个已经建立好的连接给监听器。</li><li>Close方法：关闭监听器。</li><li>Addr方法：返回监听器对应的网络地址（由IP地址和端口号组成）。</li></ul> 
<p>当使用Listen函数创建TCP类型的监听器时，其返回的监听器底层具体的类型是TCPListener，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> TCPListener <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	fd <span class="token operator">*</span>netFD
	lc ListenConfig
<span class="token punctuation">}</span>
</code></pre> 
<p>TCPListener结构体各字段说明：</p> 
<ul><li>fd：对底层网络文件描述符的封装，提供了对网络连接的读写和控制操作。</li><li>lc：用于配置监听器创建的行为，比如设置监听地址、控制网络参数等。</li></ul> 
<p>TCPListener结构体中的fd字段是netFD类型的，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> netFD <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	pfd poll<span class="token punctuation">.</span>FD

	<span class="token comment">// immutable until Close</span>
	family      <span class="token builtin">int</span>
	sotype      <span class="token builtin">int</span>
	isConnected <span class="token builtin">bool</span> <span class="token comment">// handshake completed or use of association with peer</span>
	net         <span class="token builtin">string</span>
	laddr       Addr
	raddr       Addr
<span class="token punctuation">}</span>
</code></pre> 
<p>netFD结构体各字段说明：</p> 
<ul><li>pfd：用于与底层的操作系统文件描述符进行交互。</li><li>family：表示套接字的协议家族，比如IPv4或IPv6。</li><li>sotype：表示套接字的类型，比如TCP或UDP</li><li>isConnected：表示连接是否已完成握手或与对方建立关联。</li><li>net：表示网络协议，比如"tcp"或"udp"。</li><li>laddr：表示本地网络连接的地址。</li><li>raddr：表示远程网络连接的地址。</li></ul> 
<blockquote> 
 <p>服务器监听示例</p> 
</blockquote> 
<p>服务器监听示例如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 服务器监听</span>
	listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0:8081"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"listen error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> listen<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"listen success..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>说明一下：</strong></p> 
<ul><li>服务器在创建监听套接字时，将其绑定到<code>0.0.0.0</code>（通常表示为INADDR_ANY）地址，这样服务器就可以同时监听和接受来自不同网络接口的连接请求，而不需要为每个接口分别创建监听套接字。</li><li>为了避免网络文件描述符资源泄露，在创建监听器后及时利用defer机制关闭监听器。监听器被关闭后会停止监听新的连接请求，并且任何被阻塞的Accept操作都会被解除阻塞并返回错误。</li></ul> 
<h3><a id="_121"></a>客户端连接服务器</h3> 
<blockquote> 
 <p>客户端连接服务器</p> 
</blockquote> 
<p>在Go的net包中，Dial函数用于客户端应用程序与远程服务器建立连接。该函数的函数原型如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Dial</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul><li>network：用于指定网络协议，比如"tcp", "udp"等。</li><li>address：用于指定连接的目标地址。</li></ul> 
<p><strong>返回值说明：</strong></p> 
<ul><li>第一个返回值：表示建立的网络连接。</li><li>第二个返回值：如果建立网络连接过程中出错，将返回非nil的错误值。</li></ul> 
<p>通过Dial函数建立得到的连接Conn类型的，该类型是一个接口类型，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Conn <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Read reads data from the connection.</span>
	<span class="token function">Read</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token comment">// Write writes data to the connection.</span>
	<span class="token function">Write</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token comment">// Close closes the connection.</span>
	<span class="token comment">// Any blocked Read or Write operations will be unblocked and return errors.</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// LocalAddr returns the local network address, if known.</span>
	<span class="token function">LocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Addr

	<span class="token comment">// RemoteAddr returns the remote network address, if known.</span>
	<span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Addr

	<span class="token comment">// SetDeadline sets the read and write deadlines associated</span>
	<span class="token comment">// with the connection. It is equivalent to calling both</span>
	<span class="token comment">// SetReadDeadline and SetWriteDeadline.</span>
	<span class="token function">SetDeadline</span><span class="token punctuation">(</span>t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// SetReadDeadline sets the deadline for future Read calls</span>
	<span class="token comment">// and any currently-blocked Read call.</span>
	<span class="token function">SetReadDeadline</span><span class="token punctuation">(</span>t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// SetWriteDeadline sets the deadline for future Write calls</span>
	<span class="token comment">// and any currently-blocked Write call.</span>
	<span class="token function">SetWriteDeadline</span><span class="token punctuation">(</span>t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Conn接口中各方法说明：</p> 
<ul><li>Read方法：从连接中读取数据。</li><li>Write方法：向连接中写入数据。</li><li>Close方法：关闭连接。</li><li>LocalAddr方法：返回连接对应的本地网络地址（由IP地址和端口号组成）。</li><li>RemoteAddr方法：返回连接对应的远程网络地址（由IP地址和端口号组成）。</li><li>SetDeadline方法：设置连接读取和写入的截止时间。</li><li>SetReadDeadline方法：设置连接读取的截止时间。</li><li>SetWriteDeadline方法：设置连接写入的截止时间。</li></ul> 
<p>当使用Dial函数与TCP服务器建立连接时，其返回的网络连接底层具体的类型是TCPConn，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> TCPConn <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	conn
<span class="token punctuation">}</span>
</code></pre> 
<p>TCPConn结构体中仅嵌套了一个conn类型的匿名结构体，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> conn <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	fd <span class="token operator">*</span>netFD
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，conn结构体中的fd字段与TCPListener结构体中的fd字段的类型相同，它们都是对底层网络文件描述符的封装，提供了对网络连接的读写和控制操作。</p> 
<blockquote> 
 <p>客户端连接服务器示例</p> 
</blockquote> 
<p>客户端连接服务器示例如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 客户端连接服务器</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:8081"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"connect server error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"connect server success..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>说明一下：</strong></p> 
<ul><li>当客户端连接TCP服务器时，服务器必须处于监听状态。</li><li>为了避免网络文件描述符资源泄露，客户端在与服务器建立连接后及时利用defer机制关闭连接。</li></ul> 
<h3><a id="_234"></a>服务端获取连接</h3> 
<blockquote> 
 <p>服务端获取连接</p> 
</blockquote> 
<p>在创建TCP网络监听器后，调用Listener接口的Accept方法，本质调用的是TCPListener的Accept方法，该方法用于从底层获取下一个已经建立好的连接给监听器，如果底层没有建立好的连接则会进行阻塞等待。该方法的原型如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>TCPListener<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>返回值说明：</strong></p> 
<ul><li>第一个返回值：表示获取到的与客户端建立好的连接。</li><li>第二个返回值：如果在获取连接过程中出错，将返回非nil的错误值。</li></ul> 
<blockquote> 
 <p>服务端获取连接示例</p> 
</blockquote> 
<p>服务端获取连接示例如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"handle a link %v...\n"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 服务器监听</span>
	listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0:8081"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"listen error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> listen<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"listen success..."</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"waiting client connect..."</span><span class="token punctuation">)</span>
		<span class="token comment">// 服务端获取连接</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listen<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"accept error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"get a link from %v...\n"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// 开启新协程为客户端提供服务</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>说明一下：</strong></p> 
<ul><li>网络监听器的任务就是不断调用Accept方法，从底层获取已经建立好的连接并为其提供服务，通常在获取到一个连接后会开启一个新协程为其提供服务，而主协程则继续调用Accept方法获取新的连接。</li><li>为了让新协程能够获取需要被处理的连接，需要将对应的连接通过参数传递的方式，传递给协程对应的处理函数。此外，为了避免网络文件描述符资源泄露，需要在处理函数中利用defer机制关闭连接，保证连接处理完毕后能够及时关闭连接。</li></ul> 
<h3><a id="_297"></a>向连接中写入数据</h3> 
<blockquote> 
 <p>向连接中写入数据</p> 
</blockquote> 
<p>在创建TCP连接后，调用Conn接口的Write方法，本质调用的是TCPConn的Write方法，该方法用于向连接中写入数据。该方法的原型如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>TCPConn<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul><li>b：表示要写入连接的数据。</li></ul> 
<p><strong>返回值说明：</strong></p> 
<ul><li>第一个返回值：表示实际写入的字节数。</li><li>第二个返回值：如果在写入数据过程中出错，将返回非nil的错误值。</li></ul> 
<h3><a id="_317"></a>从连接中读取数据</h3> 
<blockquote> 
 <p>从连接中读取数据</p> 
</blockquote> 
<p>在创建TCP连接后，调用Conn接口的Read方法，本质调用的是TCPConn的Read方法，该方法用于从连接中读取数据。该方法的原型如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>TCPConn<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>参数说明：</strong></p> 
<ul><li>b：输出型参数，用于存储读取到的数据。</li></ul> 
<p><strong>返回值说明：</strong></p> 
<ul><li>第一个返回值：表示实际读取的字节数。</li><li>第二个返回值：如果在读取数据过程中出错，将返回非nil的错误值。</li></ul> 
<h3><a id="_336"></a>关闭连接/监听器</h3> 
<blockquote> 
 <p>关闭连接/监听器</p> 
</blockquote> 
<p>为了避免网络文件描述符泄露，TCP网络监听器和TCP连接在使用完毕后都需要及时将其关闭，对应调用的分别是TCPListener和TCPConn的Close方法，这两个方法的原型如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>TCPListener<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>TCPConn<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre> 
<p><strong>返回值说明：</strong></p> 
<ul><li>如果在关闭监听器或关闭连接过程中出错，将返回非nil的错误值。</li></ul> 
<h2><a id="TCP_351"></a>简易的TCP回声服务器</h2> 
<h3><a id="_353"></a>效果展示</h3> 
<blockquote> 
 <p>效果展示</p> 
</blockquote> 
<p>为了演示使用net包实现网络通信，下面实现了一个简易的TCP回声服务器，其功能如下：</p> 
<ul><li>服务端能够同时处理多个客户端的连接请求，在为每个客户端提供服务时，能够将各个客户端发来的数据显示在服务端，同时将客户端发来的数据再发回给客户端。</li><li>客户端在连接到服务器后，能够不断从控制台读取用户输入的数据发送给服务端，并将服务端发来的数据显示在客户端，用户在控制台输入exit能够退出客户端。</li></ul> 
<p>最终效果如下：</p> 
<p><img src="https://images2.imgbox.com/ca/74/sy0IJoPb_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="_366"></a>服务端处理逻辑</h3> 
<blockquote> 
 <p>服务端处理逻辑</p> 
</blockquote> 
<p>服务端处理逻辑如下：</p> 
<ul><li>主协程调用Listen函数完成服务器的监听后，通过监听器不断调用Accept方法从底层获取已经建立好的连接，并为每一个获取到的连接创建一个新协程为其提供服务，而主协程则继续获取新的连接。</li><li>每个新协程在为其对应的连接提供服务时，通过调用连接的Read方法不断读取客户端发来的数据，将数据其显示在服务端，同时通过调用连接的Write方法将客户端发来的数据再发回给客户端。</li><li>每个新协程在为其对应的连接提供服务的过程中，如果从连接中读取数据或向连接中写入数据时出错，或是客户端退出，则通过调用连接的Close方法将对应的连接关闭。</li></ul> 
<p>服务端代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"io"</span>
	<span class="token string">"net"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 1、读取客户端发来的数据</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"client %v quit\n"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"read client message error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"client message[%v]: %v\n"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">// 2、发送数据给客户端</span>
		<span class="token builtin">len</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token builtin">len</span> <span class="token operator">!=</span> n <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"send back message error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 服务器监听</span>
	listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"0.0.0.0:8081"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"listen error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> listen<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"listen success..."</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"waiting client connect..."</span><span class="token punctuation">)</span>
		<span class="token comment">// 服务端获取连接</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listen<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"accept error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"get a link from %v...\n"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// 开启新协程为客户端提供服务</span>
		<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>说明一下：</strong></p> 
<ul><li>当服务端从某个连接中读取数据时，如果该连接对应的客户端已经将连接关闭，那么服务端的读操作将会返回io.EOF错误。</li></ul> 
<h3><a id="_442"></a>客户端处理逻辑</h3> 
<blockquote> 
 <p>客户端处理逻辑</p> 
</blockquote> 
<p>客户端处理逻辑如下：</p> 
<ul><li>客户端在调用Dial函数与服务端建立连接后，不断读取用户的输入，通过调用连接Write方法将用户输入的数据发送给服务端，然后通过调用连接的Read方法读取服务端发来的数据并显示在客户端，如果用户输入exit则调用连接的Close方法将连接关闭。</li></ul> 
<p>客户端代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bufio"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 客户端连接服务器</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1:8081"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"connect server error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"connect server success..."</span><span class="token punctuation">)</span>

	reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 1、读取用户输入</span>
		str<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"read input error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// 去掉\r\n</span>
		<span class="token keyword">if</span> str <span class="token operator">==</span> <span class="token string">"exit"</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"exit success..."</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 2、发送数据给服务端</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> n <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"send message error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"send %d byte message to server...\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>

		<span class="token comment">// 3、读取服务端发来的数据</span>
		n<span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"read message error, err = %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"server message: %v\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>说明一下：</strong></p> 
<ul><li>Stdin、Stdout和Stderr是os包中的全局变量，分别表示标准输入流、标准输出流和标准错误流。</li><li>客户端在读取用户输入时，通过bufio包中的Reader，以带缓冲的方式每次从标准输入流中读取一行数据。</li><li>Windows系统中通常使用<code>\r\n</code>作为换行符，因此客户端在每次读取一行用户输入的数据后需要将末尾的两个字符去掉。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1aaefec32844e16ebd47b396785d44fb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">半导体光子电学期末笔记2: 光子晶体 Photonic crystals</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/39b23fbdb419eab0b98fd271833a7909/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言：（动态内存管理）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>