<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>重修设计模式-创建型-原型模式 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4fdb159544cf7fcfc9af702ad305a14e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="重修设计模式-创建型-原型模式">
  <meta property="og:description" content="重修设计模式-创建型-原型模式 原型模式就是利用已有对象（原型）通过拷贝方式来创建对象的模式，达到节省对象创建时间的目的。适用于对象创建成本较大，且同一类的不同对象之间差别不大的场景。
比如一个对象中的数据需要经过复杂计算才能得到（如排序），或者对象是从网络、文件系统等通过IO读取的，这种情况下就可以用原型模式快速拷贝出一个新对象来使用，而不是再经过复杂计算或读取 IO 来创建对象。
原型模式的核心就是对象的拷贝，且有浅拷贝和深拷贝的区别。
浅拷贝：只会复制基本类型的数据和引用对象的内存地址，不会递归的拷贝引用对象本身，比如 Java 中 Object 的 clonse() 方法。深拷贝：不仅复制基本类型的数据，也会拷贝引用类型的对象（会开辟新的内存空间，并将新开辟的内存地址引用给新对象），从而得到一份完全独立的对象。 Kotlin 中 data class 的 copy() 方法，或 Java 中 Object 的 clone() 方法都是浅拷贝的实现，下面验证一下：
data class User(var name: String, var age: Int, val address: Address): Cloneable { public override fun clone(): Any { return super.clone() } } data class Address(var street: String, var city: String) : Cloneable { override fun clone(): Any { return super.clone() } } 测试 copy() 和 clone() 方法：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-14T09:37:15+08:00">
    <meta property="article:modified_time" content="2024-08-14T09:37:15+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">重修设计模式-创建型-原型模式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>重修设计模式-创建型-原型模式</h2> 
<p>原型模式就是利用已有对象（原型）通过拷贝方式来创建对象的模式，达到节省对象创建时间的目的。适用于对象创建成本较大，且同一类的不同对象之间差别不大的场景。</p> 
<p>比如一个对象中的数据需要经过复杂计算才能得到（如排序），或者对象是从网络、文件系统等通过IO读取的，这种情况下就可以用原型模式快速拷贝出一个新对象来使用，而不是再经过复杂计算或读取 IO 来创建对象。</p> 
<p>原型模式的核心就是对象的拷贝，且有浅拷贝和深拷贝的区别。</p> 
<ul><li><strong>浅拷贝</strong>：只会复制基本类型的数据和引用对象的内存地址，不会递归的拷贝引用对象本身，比如 Java 中 Object 的 clonse() 方法。</li><li><strong>深拷贝</strong>：不仅复制基本类型的数据，也会拷贝引用类型的对象（会开辟新的内存空间，并将新开辟的内存地址引用给新对象），从而得到一份完全独立的对象。</li></ul> 
<p>Kotlin 中 data class 的 copy() 方法，或 Java 中 Object 的 clone() 方法都是浅拷贝的实现，下面验证一下：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token keyword">var</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">var</span> age<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">val</span> address<span class="token operator">:</span> Address<span class="token punctuation">)</span><span class="token operator">:</span> Cloneable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token keyword">var</span> street<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">var</span> city<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> Cloneable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试 copy() 和 clone() 方法：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> user <span class="token operator">=</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"白泽"</span></span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"浦东新区花园石桥路28弄"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"上海"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> userCopy <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> userCopy1 <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> User

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">userCopy</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">==</span> userCopy<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>     <span class="token comment">//判断值，相当于equal</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">===</span> userCopy<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token comment">//判断内存地址</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"---"</span></span><span class="token punctuation">)</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">userCopy1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">==</span> userCopy1<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>     <span class="token comment">//判断值，相当于equal</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">===</span> userCopy1<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token comment">//判断内存地址</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代码执行结果：</p> 
<pre><code class="prism language-tex">user1:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user2:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user address:true
user address:true
---
user1:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user2:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user address:true
user address:true
</code></pre> 
<p>可见引用类型对象指向的内存地址还是同一个，并没有真正地进行拷贝，这一点通过源码也可以得到验证。将 User 编译成字节码后，再反编译成 Java 语言：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{<!-- --></span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>

   <span class="token comment">//调用的是Object的clone()方法</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//componentX()方法，用于解构赋值语法</span>

   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">User</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">Address</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Intrinsics</span><span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Intrinsics</span><span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token string">"address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Address</span> <span class="token keyword">implements</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{<!-- --></span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> street<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Address</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">String</span> street<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">String</span> city<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Intrinsics</span><span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>street<span class="token punctuation">,</span> <span class="token string">"street"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Intrinsics</span><span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>city<span class="token punctuation">,</span> <span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>street<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，copy() 方法并不会对引用类型对象进行拷贝工作，而是直接传入。而 clone() 方法则是由底层实现，执行逻辑相同。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@HotSpotIntrinsicCandidate</span>
<span class="token keyword">protected</span> <span class="token keyword">native</span> <span class="token class-name">Object</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CloneNotSupportedException</span><span class="token punctuation">;</span>
</code></pre> 
<p>下面介绍深拷贝的几种实现方式：<br> <strong>1.深拷贝实现—自己实现Cloneable的clone方法：</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token keyword">var</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">var</span> age<span class="token operator">:</span> Int<span class="token punctuation">,</span> <span class="token keyword">val</span> address<span class="token operator">:</span> Address<span class="token punctuation">)</span><span class="token operator">:</span> Cloneable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">User</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> address<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Address<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token keyword">var</span> street<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">var</span> city<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">:</span> Cloneable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">Address</span><span class="token punctuation">(</span>street<span class="token punctuation">,</span> city<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-tex">user1:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user2:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user address:true
user address:false
</code></pre> 
<p>引用地址不相同了，说明是两个独立的对象，这种方式比较麻烦，增减字段都需要对 clone() 方法进行维护，如果引用对象嵌套较深还容易出错。</p> 
<p><strong>2.深拷贝实现—序列化：</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> user <span class="token operator">=</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"白泽"</span></span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"浦东新区花园石桥路28弄"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"上海"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> userCopy <span class="token operator">=</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">as</span> User

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">userCopy</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">==</span> userCopy<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>     <span class="token comment">//判断值，相当于equal</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">===</span> userCopy<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token comment">//判断内存地址</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> bo <span class="token operator">=</span> <span class="token function">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> oo <span class="token operator">=</span> <span class="token function">ObjectOutputStream</span><span class="token punctuation">(</span>bo<span class="token punctuation">)</span>
    oo<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

    <span class="token keyword">val</span> bi <span class="token operator">=</span> <span class="token function">ByteArrayInputStream</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> oi <span class="token operator">=</span> <span class="token function">ObjectInputStream</span><span class="token punctuation">(</span>bi<span class="token punctuation">)</span>

    <span class="token keyword">return</span> oi<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-tex">user1:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user2:User(name=白泽, age=18, address=Address(street=浦东新区花园石桥路28弄, city=上海))
user address:true
user address:false
</code></pre> 
<p>这种实现方式需要类中所有引用类型（包括嵌套的）都实现 Serializable 接口，否则会抛出 <code>NotSerializableException</code> 异常。</p> 
<p><strong>3.深拷贝实现—Json</strong>：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> user <span class="token operator">=</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"白泽"</span></span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"浦东新区花园石桥路28弄"</span></span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"上海"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> userCopy <span class="token operator">=</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>

    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">userCopy</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">==</span> userCopy<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>     <span class="token comment">//判断值，相当于equal</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"user address:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">user<span class="token punctuation">.</span>address <span class="token operator">===</span> userCopy<span class="token punctuation">.</span>address</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token comment">//判断内存地址</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span><span class="token keyword">reified</span> T<span class="token operator">&gt;</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> gson <span class="token operator">=</span> <span class="token function">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> json <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> gson<span class="token punctuation">.</span>fromJson<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> T<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打印结果：</p> 
<pre><code class="prism language-kotlin">user1<span class="token operator">:</span><span class="token function">User</span><span class="token punctuation">(</span>name<span class="token operator">=</span>白泽<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token function">Address</span><span class="token punctuation">(</span>street<span class="token operator">=</span>浦东新区花园石桥路<span class="token number">28</span>弄<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">)</span><span class="token punctuation">)</span>
user2<span class="token operator">:</span><span class="token function">User</span><span class="token punctuation">(</span>name<span class="token operator">=</span>白泽<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">,</span> address<span class="token operator">=</span><span class="token function">Address</span><span class="token punctuation">(</span>street<span class="token operator">=</span>浦东新区花园石桥路<span class="token number">28</span>弄<span class="token punctuation">,</span> city<span class="token operator">=</span>上海<span class="token punctuation">)</span><span class="token punctuation">)</span>
user address<span class="token operator">:</span><span class="token boolean">true</span>
user address<span class="token operator">:</span><span class="token boolean">false</span>
</code></pre> 
<p>这里使用 Kotlin 的内联函数配合范型实化封装了 deepCopy 方法，其内部是通过Google 的 Json 解析库 Gson 进行实现的，先将对象转为 Json 字符串，然后再解析 Json 来创建新对象。</p> 
<p><strong>4.深拷贝实现—写时复制思想</strong></p> 
<p>以上深拷贝方式由于在拷贝时创建了大量对象，都会伴随性能损耗。其实可以借助 Copy On Write 思想，先通过浅拷贝将对象复制出来，再使用中再进行对象的创建，从而将对象创建的损耗平摊到后续业务中。</p> 
<p>当然这种方式需要看具体业务场景再决定如何实现，如果应用一个复杂的模式，只得到一点点的性能提升，这就是所谓的过度设计，得不偿失。</p> 
<h5><a id="_218"></a>经典场景</h5> 
<p>理论说完了，再结合实际场景来尝试使用。比如 App 的个人中心展示了用户的所有信息，如用户名，生日，地址，个性签名等，同时还有保存和重置按钮，其中保存按钮需要实时更新状态：只有真正的修改了用户信息才可以点击，否则置灰无法点击。重置按钮点击后会恢复页面原信息。</p> 
<p>这种需求场景可以利用原型模式的思想，通过拷贝得到一个新对象，后续的信息修改都基于新对象，并且每次改动后都和原对象进行对比，判断字段值是否真正修改来更新保存按钮状态。在点击重置按钮时，重新基于原对象拷贝新对象，并根据该对象刷新页面实现重置功能。</p> 
<h5><a id="_226"></a>总结</h5> 
<p>利用已有对象来创建新对象，以达到节省创建时间的目的，就叫做原型模式。</p> 
<p>原型模式的核心是对象的拷贝，对象拷贝又分为浅拷贝和深拷贝，其中浅拷贝会共用引用类型对象，而深拷贝会创建新的引用对象。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/839d05c6e0c8494fdaaf1ea14771facb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">comfyui入门｜超详细安装教程（汉化&#43;管理器）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c53007a30bb43ad2a4ee37c9e21bb3db/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python酷库之旅-第三方库Pandas(080)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>