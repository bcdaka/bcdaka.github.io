<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FastAPI教程III - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/91b585364b3505fd84f2dca245815915/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="FastAPI教程III">
  <meta property="og:description" content="本文参考FastAPI教程https://fastapi.tiangolo.com/zh/tutorial
这部分暂无需求的没有记录，仅放置标题。
依赖项 安全性 中间件 你可以向FastAPI应用添加中间件。
”中间件“是一个函数，它在每个请求被特定的路径操作处理之前，以及在每个响应返回之前工作。
它接收你的应用程序的每一个请求。然后它可以对这个请求做一些事情或者执行任何需要的代码。然后它将请求传递给应用程序的其他部分（通过某种路径操作）。然后它获取应用程序生产的响应（通过某种路径操作）。它可以对该响应做些什么或者执行任何需要的代码。然后它返回这个响应。 创建中间件 要创建中间件你可以在函数的顶部使用装饰器@app.middleware(&#34;http&#34;)。
中间件参数接收如下参数：
request。一个函数call_next，它将接收request作为参数。这个函数将request传递给相应的路径操作。然后它将返回由相应的路径操作生成的response。然后你可以在返回response前进一步修改它。 import time from fastapi import FastAPI, Request app = FastAPI() @app.middleware(&#34;http&#34;) async def add_process_time_header(request: Request, call_next): start_time = time.time() response = await call_next(request) process_time = time.time() - start_time response.headers[&#34;X-Process-Time&#34;] = str(process_time) return response 在response的前和后 在任何路径操作收到request前，可以添加要和请求一起运行的代码。
也可以在响应生成但是返回之前添加代码。
例如你可以添加自定义请求头X-Process-Time包含以秒为单位的接收请求和生成响应的时间。
import time from fastapi import FastAPI, Request app = FastAPI() @app.middleware(&#34;http&#34;) async def add_process_time_header(request: Request, call_next): start_time = time.time() response = await call_next(request) process_time = time.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-30T12:23:48+08:00">
    <meta property="article:modified_time" content="2024-06-30T12:23:48+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FastAPI教程III</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文参考FastAPI教程https://fastapi.tiangolo.com/zh/tutorial<br> 这部分暂无需求的没有记录，仅放置标题。</p> 
<h2><a id="_3"></a>依赖项</h2> 
<h2><a id="_4"></a>安全性</h2> 
<h2><a id="_5"></a>中间件</h2> 
<p>你可以向FastAPI应用添加中间件。</p> 
<p>”中间件“是一个函数，它在每个<strong>请求</strong>被特定的路径操作处理之前，以及在每个<strong>响应</strong>返回之前工作。</p> 
<ul><li>它接收你的应用程序的每一个<strong>请求</strong>。</li><li>然后它可以对这个<strong>请求</strong>做一些事情或者执行任何需要的代码。</li><li>然后它将<strong>请求</strong>传递给应用程序的其他部分（通过某种路径操作）。</li><li>然后它获取应用程序生产的<strong>响应</strong>（通过某种路径操作）。</li><li>它可以对该<strong>响应</strong>做些什么或者执行任何需要的代码。</li><li>然后它返回这个<strong>响应</strong>。</li></ul> 
<h3><a id="_16"></a>创建中间件</h3> 
<p>要创建中间件你可以在函数的顶部使用装饰器<code>@app.middleware("http")</code>。</p> 
<p>中间件参数接收如下参数：</p> 
<ul><li><code>request</code>。</li><li>一个函数<code>call_next</code>，它将接收<code>request</code>作为参数。</li><li>这个函数将<code>request</code>传递给相应的路径操作。</li><li>然后它将返回由相应的路径操作生成的<code>response</code>。</li><li>然后你可以在返回<code>response</code>前进一步修改它。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Request

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>middleware</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_process_time_header</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    process_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Process-Time"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>process_time<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response
</code></pre> 
<p><img src="https://images2.imgbox.com/b6/19/Ue6vbr4V_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="response_44"></a>在<code>response</code>的前和后</h3> 
<p>在任何路径操作收到<code>request</code>前，可以添加要和请求一起运行的代码。</p> 
<p>也可以在响应生成但是返回之前添加代码。</p> 
<p>例如你可以添加自定义请求头<code>X-Process-Time</code>包含以秒为单位的接收请求和生成响应的时间。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Request

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>middleware</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_process_time_header</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> call_next<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> call_next<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    process_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"X-Process-Time"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>process_time<span class="token punctuation">)</span>
    <span class="token keyword">return</span> response
</code></pre> 
<h3><a id="_67"></a>其他中间件</h3> 
<p>可以在<a href="https://fastapi.tiangolo.com/zh/advanced/middleware/" rel="nofollow">Advanced User Guide: Advanced Middleware</a>阅读更多关于中间件的教程。</p> 
<p>下一节中会学习如何使用中间件处理CORS。</p> 
<h2><a id="CORS_72"></a>CORS（跨域资源共享）</h2> 
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="nofollow">CORS或者跨域资源共享</a>指浏览器中运行的前端拥有与后端通信的JavaScript代码，而后端处于与前端不同的【源】的情况。</p> 
<h3><a id="_75"></a>源</h3> 
<p>源是协议（<code>http</code>，<code>https</code>）、域（<code>myapp.com</code>，<code>localhost</code>，<code>localhost.tiangolo.com</code>）以及端口（<code>80</code>、<code>443</code>、<code>8080</code>）的组合。</p> 
<p>因此，这些都是不同的源：</p> 
<ul><li><code>http://localhost</code></li><li><code>https://localhost</code></li><li><code>http://localhost:8000</code></li></ul> 
<p>即使它们都在<code>localhost</code>中，但是它们使用不同的协议或者端口，所以它们都是不同的[源]。</p> 
<h3><a id="_85"></a>步骤</h3> 
<p>假设你的浏览器中有一个前端运行在<code>http://localhost:8080</code>，并且它的JavaScript正在尝试与运行在<code>http://localhost</code>的后端通信（因为我们没有指定端口，浏览器会采用默认的端口<code>80</code>）。</p> 
<p>然后，浏览器会向后端发送一个HTTP<code>OPTIONS</code>请求，如果后端发送适当的headers来授权来自这个不同源（<code>http://localhost:8080</code>）的通信，浏览器将允许前端的JavaScript向后端发送请求。</p> 
<p>为此，后端必须有一个【允许的源】列表。</p> 
<p>在这种情况下，它必须包含<code>http://localhost:8080</code>，前端才能正常工作。</p> 
<h3><a id="_94"></a>通配符</h3> 
<p>也可以使用<code>"*"</code>声明这个列表，表示全部都是允许的。</p> 
<p>但这仅允许某些类型的通信，不包括所有涉及凭据的内容：像Cookies以及那些使用Bearer令牌的授权headers等。</p> 
<p>因此，为了一切都能正常工作，最好显式地指定允许的源。</p> 
<h3><a id="CORSMiddleware_101"></a>使用<code>CORSMiddleware</code></h3> 
<p>你可以在FastAPI应用中使用<code>CORSMiddleware</code>来配置它。</p> 
<ul><li>导入<code>CORSMiddleware</code>。</li><li>创建一个允许的源列表（由字符串组成）。</li><li>将其作为【中间件】添加到你的FastAPI应用中。</li></ul> 
<p>你也可以指定后端是否允许：</p> 
<ul><li>凭证（授权headers，Cookies）等</li><li>特定的HTTP方法（<code>POST</code>，<code>PUT</code>）或者使用通配符<code>"*"</code>允许所有方法。</li><li>特定的HTTP headers或者使用通配符<code>"*"</code>允许所有headers。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>cors <span class="token keyword">import</span> CORSMiddleware

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

origins <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"http://localhost.tiangolo.com"</span><span class="token punctuation">,</span>
    <span class="token string">"https://localhost.tiangolo.com"</span><span class="token punctuation">,</span>
    <span class="token string">"http://localhost"</span><span class="token punctuation">,</span>
    <span class="token string">"http://localhost:8080"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span>origins<span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">}</span>
</code></pre> 
<p>默认情况下，这个<code>CORSMiddleware</code>实现所使用地默认参数较为保守，所以你需要显式地启用特定的源、方法或者headers，以便浏览器能够在跨域上下文中使用它们。</p> 
<p>支持一下参数：</p> 
<ul><li><code>allow_origins</code>-一个允许跨域请求的源列表。例如<code>['https://example.org', 'https://www.example.org']</code>。你可以使用 <code>['*']</code> 允许任何源。</li><li><code>allow_origin_regex</code> - 一个正则表达式字符串，匹配的源允许跨域请求。例如 <code>'https://.*\.example\.org'</code>。</li><li><code>allow_methods</code> - 一个允许跨域请求的 HTTP 方法列表。默认为 <code>['GET']</code>。你可以使用 <code>['*']</code> 来允许所有标准方法。</li><li><code>allow_headers</code> - 一个允许跨域请求的 HTTP 请求头列表。默认为 <code>[]</code>。你可以使用 <code>['*']</code> 允许所有的请求头。<code>Accept</code>、<code>Accept-Language</code>、<code>Content-Language</code> 以及 <code>Content-Type</code> 请求头总是允许 CORS 请求。</li><li><code>allow_credentials</code> - 指示跨域请求支持 cookies。默认是 <code>False</code>。另外，允许凭证时 <code>allow_origins</code> 不能设定为 <code>['*']</code>，必须指定源。</li><li><code>expose_headers</code> - 指示可以被浏览器访问的响应头。默认为 <code>[]</code>。</li><li><code>max_age</code> - 设定浏览器缓存 CORS 响应的最长时间，单位是秒。默认为 600。</li></ul> 
<p>中间件响应两种特定类型的 HTTP 请求……</p> 
<h4><a id="CORS__151"></a>CORS 预检请求</h4> 
<p>这是些带有 <code>Origin</code> 和 <code>Access-Control-Request-Method</code> 请求头的 OPTIONS 请求。</p> 
<p>在这种情况下，中间件将拦截传入的请求并进行响应，出于提供信息的目的返回一个使用了适当的 CORS headers 的 <code>200</code> 或 <code>400</code> 响应。</p> 
<h4><a id="_156"></a>简单请求</h4> 
<p>任何带有 <code>Origin</code> 请求头的请求。在这种情况下，中间件将像平常一样传递请求，但是在响应中包含适当的 CORS headers。</p> 
<h3><a id="_159"></a>更多信息</h3> 
<p>更多关于CORS的信息，请查看<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="nofollow">Mozilla CORS文档</a>。</p> 
<h2><a id="SQL_162"></a>SQL（关系型）数据库</h2> 
<h2><a id="_164"></a>更大的应用-多个文件</h2> 
<h2><a id="_165"></a>后台任务</h2> 
<p>你可以定义在返回响应后运行的后台任务。</p> 
<p>这对需要在请求之后执行的操作很有用，但客户端不必在接收响应之前等待操作完成。</p> 
<p>包括这些例子：</p> 
<ul><li>执行操作后发送的电子邮件通知：</li><li> 
  <ul><li>由于连接到电子邮件服务器并发送电子邮件往往很”慢“（几秒钟），您可以立即返回响应并在后台发送电子邮件通知。</li></ul> </li><li>处理数据：</li><li> 
  <ul><li>例如，假设您收到的文件必须经过一个缓慢的过程，您可以返回一个”Accepted“（HTTP 202）响应并在后台处理它。</li></ul> </li></ul> 
<h3><a id="BackgroundTasks_176"></a>使用<code>BackgroundTasks</code></h3> 
<p>首先导入<code>BackgroundTasks</code>并在路径操作函数中使用类型声明<code>BackgroundTasks</code>定义一个参数，FastAPI会创建一个<code>BackgroundTasks</code>类型的对象并作为该参数传入。</p> 
<p>创建一个任务函数，创建要作为后台任务运行的函数。它只是一个可以接收参数的标准函数。它可以是<code>async def</code>或普通的<code>def</code>函数，FastAPI知道如何正确处理。在这种情况下，任务函数将写入一个文件（模拟发送电子邮件）。由于写操作不使用<code>async</code>和<code>await</code>，我们用普通的<code>def</code>定义函数。</p> 
<p>添加后台任务，在你的路径操作函数里，用<code>.add_task()</code>方法将任务函数传到后台任务对象中。</p> 
<p><code>.add_task()</code>接收以下参数：</p> 
<ul><li>在后台运行的任务函数（<code>write_notification</code>）。</li><li>应按顺序传递给任务函数的任意参数序列（<code>email</code>）。</li><li>应传递给任务函数的任意关键字参数（<code>message="some notification"</code>）。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> BackgroundTasks<span class="token punctuation">,</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">write_notification</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"log.txt"</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> email_file<span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"notification for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>email<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        email_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/send-notification/{email}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_notification</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>write_notification<span class="token punctuation">,</span> email<span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"some notification"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Notification sent in the background"</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_205"></a>依赖注入</h3> 
<p>使用<code>BackgroundTasks</code>也适用于依赖注入系统，你可以在多个级别声明<code>BackgroundTasks</code>类型的参数：在路径操作函数里，在依赖中（可依赖），在子依赖中，等等。</p> 
<p>FastAPI知道在每种情况下该做什么以及如何复用同一对象，因此所有后台任务被合并在一起并且随后在后台运行。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Annotated<span class="token punctuation">,</span> Union

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> BackgroundTasks<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">write_log</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"log.txt"</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> log<span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>write<span class="token punctuation">(</span>message<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_query</span><span class="token punctuation">(</span>background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">,</span> q<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> q<span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"found query: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>q<span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
        background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>write_log<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">return</span> q


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/send-notification/{email}"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">send_notification</span><span class="token punctuation">(</span>
    email<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> background_tasks<span class="token punctuation">:</span> BackgroundTasks<span class="token punctuation">,</span> q<span class="token punctuation">:</span> Annotated<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Depends<span class="token punctuation">(</span>get_query<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"message to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>email<span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
    background_tasks<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>write_log<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Message sent"</span><span class="token punctuation">}</span>
</code></pre> 
<p>该示例中，信息会在响应发出之后被写到<code>log.txt</code>文件。</p> 
<p>如果请求中有查询，它将在后台任务中写入日志。</p> 
<p>然后另一个在路径操作函数生成的后台任务会使用路径参数<code>email</code>写入一条信息。<br> <img src="https://images2.imgbox.com/1b/a6/cthxG3un_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="URL_244"></a>元数据和文档URL</h2> 
<h2><a id="_245"></a>静态文件</h2> 
<h2><a id="_246"></a>测试</h2> 
<p>感谢 <a href="https://www.starlette.io/testclient/" rel="nofollow">Starlette</a>，测试FastAPI 应用轻松又愉快。</p> 
<p>它基于 <a href="https://www.python-httpx.org/" rel="nofollow">HTTPX</a>， 而HTTPX又是基于Requests设计的，所以很相似且易懂。</p> 
<p>有了它，你可以直接与FastAPI一起使用 <a href="https://docs.pytest.org/en/8.2.x/" rel="nofollow">pytest</a>。</p> 
<h3><a id="TestClient_253"></a>使用<code>TestClient</code></h3> 
<p>要使用<code>TestClient</code>，先要安装<code>httpx</code>（例<code>pip install httpx</code>）</p> 
<ul><li>导入<code>TestClient</code></li><li>通过传入你的FastAPI应用创建一个<code>TestClient</code>。</li><li>创建名字以<code>test_</code>开头的函数（这是标准的<code>pytest</code>约定）。</li><li>像使用<code>httpx</code>那样使用<code>TestClient</code>对象。</li><li>为你需要检查的地方用标准的Python表达式写个简单的<code>assert</code>语句（重申，标准的<code>pytest</code>）。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">}</span>


client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_read_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bc/9a/6rYHkBJH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_283"></a>分离测试</h3> 
<p>在实际应用中，你可能会把你的测试放在另一个文件里。</p> 
<p>您的FastAPI应用程序也可能由一些文件/模块组成等等。</p> 
<h4><a id="FastAPI_app_288"></a>FastAPI app文件</h4> 
<p>假设你有一个像<a href="https://fastapi.tiangolo.com/zh/tutorial/bigger-applications/" rel="nofollow">更大的应用</a>中所描述的文件结构：</p> 
<pre><code class="prism language-python"><span class="token punctuation">.</span>
├── app
│   ├── __init__<span class="token punctuation">.</span>py
│   └── main<span class="token punctuation">.</span>py
</code></pre> 
<p>在<code>main.py</code>文件中你有一个FastAPI app:</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_309"></a>测试文件</h4> 
<p>然后你会有一个包含测试的文件<code>test_main.py</code>。app可以像Python包那样存在（一样是目录，但有个<code>__init__.py</code>文件）：</p> 
<pre><code class="prism language-python"><span class="token punctuation">.</span>
├── app
│   ├── __init__<span class="token punctuation">.</span>py
│   ├── main<span class="token punctuation">.</span>py
│   └── test_main<span class="token punctuation">.</span>py
</code></pre> 
<p>因为这文件在同一个包中，所以你可以通过相对导入从<code>main</code>模块（<code>main.py</code>）导入<code>app</code>对象：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient

<span class="token keyword">from</span> <span class="token punctuation">.</span>main <span class="token keyword">import</span> app

client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_read_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">}</span>
</code></pre> 
<p>然后测试代码和之前一样的。</p> 
<h3><a id="_336"></a>测试：扩展示例</h3> 
<p>现在让我们扩展这个例子，并添加更多细节，看下如何测试不同部分。</p> 
<h4><a id="FastAPI_app_339"></a>扩展后的FastAPI app文件</h4> 
<p>让我们继续之前的文件结构：</p> 
<pre><code class="prism language-python"><span class="token punctuation">.</span>
├── app
│   ├── __init__<span class="token punctuation">.</span>py
│   ├── main<span class="token punctuation">.</span>py
│   └── test_main<span class="token punctuation">.</span>py
</code></pre> 
<p>假设现在包含FastAPI app的文件<code>main.py</code>有些其他路径操作。</p> 
<p>有个<code>GET</code>操作会返回错误。</p> 
<p>有个<code>POST</code>操作会返回一些错误。</p> 
<p>所有路径操作都需要一个<code>X-Token</code>头。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Annotated

<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Header<span class="token punctuation">,</span> HTTPException
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel

fake_secret_token <span class="token operator">=</span> <span class="token string">"coneofsilence"</span>

fake_db <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"foo"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my hero"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"bar"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The bartenders"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span>
    title<span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_main</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> x_token<span class="token punctuation">:</span> Annotated<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Header<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> x_token <span class="token operator">!=</span> fake_secret_token<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid X-Token header"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> item_id <span class="token keyword">not</span> <span class="token keyword">in</span> fake_db<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Item not found"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> fake_db<span class="token punctuation">[</span>item_id<span class="token punctuation">]</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>Item<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">,</span> x_token<span class="token punctuation">:</span> Annotated<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Header<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> x_token <span class="token operator">!=</span> fake_secret_token<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Invalid X-Token header"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> item<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword">in</span> fake_db<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">"Item already exists"</span><span class="token punctuation">)</span>
    fake_db<span class="token punctuation">[</span>item<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> item
    <span class="token keyword">return</span> item
</code></pre> 
<h4><a id="_397"></a>扩展后的测试文件</h4> 
<p>然后您可以使用扩展后的测试更新<code>test_main.py</code>：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>testclient <span class="token keyword">import</span> TestClient

<span class="token keyword">from</span> <span class="token punctuation">.</span>main <span class="token keyword">import</span> app

client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>app<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">test_read_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/foo"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
        <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my hero"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">test_read_item_bad_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/foo"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"hailhydra"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">400</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Invalid X-Token header"</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">test_read_nonexistent_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/baz"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">404</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Item not found"</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">test_create_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/items/"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foobar"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo Bar"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The Foo Barters"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foobar"</span><span class="token punctuation">,</span>
        <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Foo Bar"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"The Foo Barters"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">test_create_item_bad_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/items/"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"hailhydra"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"bazz"</span><span class="token punctuation">,</span> <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Bazz"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Drop the bazz"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">400</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Invalid X-Token header"</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">test_create_existing_item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/items/"</span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"X-Token"</span><span class="token punctuation">:</span> <span class="token string">"coneofsilence"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"The Foo ID Stealers"</span><span class="token punctuation">,</span>
            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"There goes my stealer"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">409</span>
    <span class="token keyword">assert</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">{<!-- --></span><span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token string">"Item already exists"</span><span class="token punctuation">}</span>
</code></pre> 
<p>每当你需要客户端在请求中传递信息，但你不知道如何传递时，你可以通过搜索（谷歌）如何用<code>httpx</code>做，或者是用<code>requests</code>做，毕竟HTTPX的设计是基于Requests的设计的。</p> 
<p>接着只需在测试中同样操作。</p> 
<p>示例：</p> 
<ul><li>传一个路径或查询参数，添加到URL上。</li><li>传一个JSON体，传一个Python对象（例如一个<code>dict</code>）到参数<code>json</code>。</li><li>如果你需要发送Form Data而不是JSON，使用<code>data</code>参数。</li><li>要发送headers，传<code>dict</code>给<code>headers</code>参数。</li><li>对于cookies，传<code>dict</code>给<code>cookies</code>参数。</li></ul> 
<p>关于如何传数据给后端的更多信息（使用<code>httpx</code>或<code>TestClient</code>），请查阅<a href="https://www.python-httpx.org/" rel="nofollow">HTTPX文档</a>。</p> 
<h3><a id="_480"></a>运行起来</h3> 
<p>之后，你只需要安装<code>pytest</code>，他会自动检测文件和测试，执行测试，然后向你报告结果。</p> 
<h2><a id="_483"></a>调试</h2> 
<p>你可以在编辑器中连接调试器，例如使用Visual Studio Code或PyCharm。</p> 
<h3><a id="uvicorn_486"></a>调用<code>uvicorn</code></h3> 
<p>在你的FastAPI应用中直接导入<code>uvicorn</code>并运行：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token string">"a"</span>
    b <span class="token operator">=</span> <span class="token string">"b"</span> <span class="token operator">+</span> a
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"hello world"</span><span class="token punctuation">:</span> b<span class="token punctuation">}</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93aeafa18a31bdc6425d8f7265b6eecd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spark Core内核调度机制详解(第5天）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/76cec5d9c87a331aef89f0d4d3fe6973/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Jetson系列机载电脑创建热点模式配置方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>