<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Pytorch】利用PyTorch实现图像识别 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/14cf7cf53e4cc2d9e0f360d206cfec69/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Pytorch】利用PyTorch实现图像识别">
  <meta property="og:description" content="这是目录 使用torchvision库的datasets类加载常用的数据集或自定义数据集使用torchvision库进行数据增强和变换，自定义自己的图像分类数据集并使用torchvision库加载它们使用torchvision库的models类加载预训练模型或自定义模型forward方法进行模型训练和测试，使用matplotlib.pyplot库可视化结果 使用torchvision库的datasets类加载常用的数据集或自定义数据集 图像识别是计算机视觉中的一个基础任务，它的目标是让计算机能够识别图像中的物体、场景或者概念，并将它们分配到预定义的类别中。例如，给定一张猫的图片，图像识别系统应该能够输出“猫”这个类别。
为了训练和评估图像识别系统，我们需要有大量的带有标注的图像数据集。常用的图像分类数据集有：
ImageNet：一个包含超过1400万张图片和2万多个类别的大型数据库，是目前最流行和最具挑战性的图像分类基准之一。CIFAR-10/CIFAR-100：一个包含6万张32×32大小的彩色图片和10或100个类别的小型数据库，适合入门级和快速实验。MNIST：一个包含7万张28×28大小的灰度手写数字图片和10个类别的经典数据库，是深度学习中最常用的测试集之一。Fashion-MNIST：一个包含7万张28×28大小的灰度服装图片和10个类别的数据库，是MNIST数据库在时尚领域上更加复杂和现代化版本。 使用torchvision库可以方便地加载这些常用数据集或者自定义数据集。torchvision.datasets提供了一些加载数据集或者下载数据集到本地缓存文件夹（默认为./data）并返回Dataset对象（torch.utils.data.Dataset） 的函数。Dataset对象可以存储样本及其对应标签，并提供索引方式（dataset[i]）来获取第i个样本。例如，要加载CIFAR-10训练集并进行随机打乱，可以使用以下代码：
import torchvision import torchvision.transforms as transforms transform = transforms.Compose([transforms.ToTensor()]) # 定义转换函数，将PIL.Image转换为torch.Tensor trainset = torchvision.datasets.CIFAR10(root=&#39;./data&#39;, train=True, download=True, transform=transform) # 加载CIFAR-10训练集 trainloader = torch.utils.data.DataLoader(trainset, batch_size=4, shuffle=True) # 定义DataLoader对象，用于批量加载数据 使用torchvision库进行数据增强和变换，自定义自己的图像分类数据集并使用torchvision库加载它们 数据增强和变换：为了提高模型的泛化能力和数据利用率，我们通常会对图像数据进行一些随机的变换，例如裁剪、旋转、翻转、缩放、亮度调整等。这些变换可以在一定程度上模拟真实场景中的图像变化，增加模型对不同视角和光照条件下的物体识别能力。torchvision.transforms提供了一些常用的图像变换函数，可以组合成一个transform对象，并传入datasets类中作为参数。例如，要对CIFAR-10训练集进行随机水平翻转和随机裁剪，并将图像归一化到[-1, 1]范围内，可以使用以下代码： import torchvision import torchvision.transforms as transforms transform = transforms.Compose([ transforms.RandomHorizontalFlip(), # 随机水平翻转 transforms.RandomCrop(32, padding=4), # 随机裁剪到32×32大小，并在边缘填充4个像素 transforms.ToTensor(), # 将PIL.Image转换为torch.Tensor transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5)) # 将RGB三个通道的值归一化到[-1, 1]范围内 ]) trainset = torchvision.datasets.CIFAR10(root=&#39;./data&#39;, train=True, download=True, transform=transform) # 加载CIFAR-10训练集，并应用上述变换 trainloader = torch.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-17T16:13:26+08:00">
    <meta property="article:modified_time" content="2023-04-17T16:13:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Pytorch】利用PyTorch实现图像识别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/24/0c/pd877Qlf_o.gif" alt="在这里插入图片描述"></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>这是目录</h4> 
 <ul><li><a href="#torchvisiondatasets_6" rel="nofollow">使用torchvision库的datasets类加载常用的数据集或自定义数据集</a></li><li><a href="#torchvisiontorchvision_27" rel="nofollow">使用torchvision库进行数据增强和变换，自定义自己的图像分类数据集并使用torchvision库加载它们</a></li><li><a href="#torchvisionmodels_84" rel="nofollow">使用torchvision库的models类加载预训练模型或自定义模型</a></li><li><a href="#forward_113" rel="nofollow">forward方法</a></li><li><a href="#matplotlibpyplot_135" rel="nofollow">进行模型训练和测试，使用matplotlib.pyplot库可视化结果</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="torchvisiondatasets_6"></a>使用torchvision库的datasets类加载常用的数据集或自定义数据集</h2> 
<p>图像识别是计算机视觉中的一个基础任务，它的目标是让计算机能够识别图像中的物体、场景或者概念，并将它们分配到预定义的类别中。例如，给定一张猫的图片，图像识别系统应该能够输出“猫”这个类别。</p> 
<p>为了训练和评估图像识别系统，我们需要有大量的带有标注的图像数据集。常用的图像分类数据集有：</p> 
<ul><li>ImageNet：一个包含超过1400万张图片和2万多个类别的大型数据库，是目前最流行和最具挑战性的图像分类基准之一。</li><li>CIFAR-10/CIFAR-100：一个包含6万张32×32大小的彩色图片和10或100个类别的小型数据库，适合入门级和快速实验。</li><li>MNIST：一个包含7万张28×28大小的灰度手写数字图片和10个类别的经典数据库，是深度学习中最常用的测试集之一。</li><li>Fashion-MNIST：一个包含7万张28×28大小的灰度服装图片和10个类别的数据库，是MNIST数据库在时尚领域上更加复杂和现代化版本。</li></ul> 
<p>使用torchvision库可以方便地加载这些常用数据集或者自定义数据集。torchvision.datasets提供了一些加载数据集或者下载数据集到本地缓存文件夹（默认为./data）并返回Dataset对象（torch.utils.data.Dataset） 的函数。Dataset对象可以存储样本及其对应标签，并提供索引方式（dataset[i]）来获取第i个样本。例如，要加载CIFAR-10训练集并进行随机打乱，可以使用以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torchvision
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms

transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 定义转换函数，将PIL.Image转换为torch.Tensor</span>
trainset <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>CIFAR10<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">'./data'</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transform<span class="token punctuation">)</span> <span class="token comment"># 加载CIFAR-10训练集</span>
trainloader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>trainset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 定义DataLoader对象，用于批量加载数据</span>
</code></pre> 
<h2><a id="torchvisiontorchvision_27"></a>使用torchvision库进行数据增强和变换，自定义自己的图像分类数据集并使用torchvision库加载它们</h2> 
<ul><li>数据增强和变换：为了提高模型的泛化能力和数据利用率，我们通常会对图像数据进行一些随机的变换，例如裁剪、旋转、翻转、缩放、亮度调整等。这些变换可以在一定程度上模拟真实场景中的图像变化，增加模型对不同视角和光照条件下的物体识别能力。torchvision.transforms提供了一些常用的图像变换函数，可以组合成一个transform对象，并传入datasets类中作为参数。例如，要对CIFAR-10训练集进行随机水平翻转和随机裁剪，并将图像归一化到[-1, 1]范围内，可以使用以下代码：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torchvision
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms

transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 随机水平翻转</span>
    transforms<span class="token punctuation">.</span>RandomCrop<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 随机裁剪到32×32大小，并在边缘填充4个像素</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 将PIL.Image转换为torch.Tensor</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将RGB三个通道的值归一化到[-1, 1]范围内</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
trainset <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>CIFAR10<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">'./data'</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transform<span class="token punctuation">)</span> <span class="token comment"># 加载CIFAR-10训练集，并应用上述变换</span>
trainloader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>trainset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 定义DataLoader对象，用于批量加载数据</span>
</code></pre> 
<ul><li>自定义图像分类数据集：如果我们有自己的图像分类数据集，我们可以通过继承torch.utils.data.Dataset类来自定义一个Dataset对象，并实现__len__和__getitem__两个方法。__len__方法返回数据集中样本的数量，__getitem__方法根据给定的索引返回一个样本及其标签。例如，假设我们有一个文件夹结构如下：</li></ul> 
<pre><code>my_dataset/
├── class_0/
│   ├── image_000.jpg
│   ├── image_001.jpg
│   └── ...
├── class_1/
│   ├── image_000.jpg
│   ├── image_001.jpg
│   └── ...
└── ...
</code></pre> 
<p>其中每个子文件夹代表一个类别，每个子文件夹中包含该类别对应的图像文件。我们可以使用以下代码来自定义一个Dataset对象，并加载这个数据集：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> data
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> os

<span class="token keyword">class</span> <span class="token class-name">MyDataset</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> root_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>root_dir <span class="token operator">=</span> root_dir <span class="token comment"># 根目录路径</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform <span class="token comment"># 变换函数</span>
        
        self<span class="token punctuation">.</span>classes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 类别列表（按字母顺序排序）</span>
        self<span class="token punctuation">.</span>class_to_idx <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>c<span class="token punctuation">:</span> i <span class="token keyword">for</span> i<span class="token punctuation">,</span>c <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token comment"># 类别名到索引的映射</span>
        
        self<span class="token punctuation">.</span>images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 图片路径列表（相对于根目录）</span>
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 标签列表（整数）</span>
        
        <span class="token keyword">for</span> c <span class="token keyword">in</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">:</span>
            c_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token comment"># 类别子目录路径</span>
            <span class="token keyword">for</span> img_name <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>c_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 遍历每个图片文件名（按字母顺序排序）</span>
                img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>c<span class="token punctuation">,</span>img_name<span class="token punctuation">)</span> <span class="token comment"># 图片相对路径（相对于根目录）</span>
                label <span class="token operator">=</span> self<span class="token punctuation">.</span>class_to_idx<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token comment"># 图</span>
</code></pre> 
<h2><a id="torchvisionmodels_84"></a>使用torchvision库的models类加载预训练模型或自定义模型</h2> 
<ul><li>加载预训练模型或自定义模型：torchvision.models提供了一些常用的图像分类模型，例如AlexNet、VGG、ResNet等，并且可以选择是否加载在ImageNet数据集上预训练好的权重。这些模型可以直接用于图像分类任务，也可以作为特征提取器或者微调（fine-tune）的基础。例如，要加载一个预训练好的ResNet-18模型，并冻结除最后一层外的所有参数，可以使用以下代码：</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models

model <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet18<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 加载预训练好的ResNet-18模型</span>
<span class="token keyword">for</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 遍历所有参数</span>
    param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span> <span class="token comment"># 将参数的梯度设置为False，表示不需要更新</span>
num_features <span class="token operator">=</span> model<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features <span class="token comment"># 获取全连接层（fc）的输入特征数</span>
model<span class="token punctuation">.</span>fc <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_features<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># 替换全连接层为一个新的线性层，输出特征数为10（假设有10个类别）</span>
</code></pre> 
<p>如果我们想要自定义自己的图像分类模型，我们可以通过继承torch.nn.Module类来实现一个Module对象，并实现__init__和forward两个方法。__init__方法用于定义模型中需要的各种层和参数，forward方法用于定义前向传播过程。例如，要自定义一个简单的卷积神经网络（CNN）模型，可以使用以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">class</span> <span class="token class-name">MyCNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 调用父类构造函数</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 定义第一个卷积层，输入通道数为3（RGB），输出通道数为6，卷积核大小为5×5</span>
        self<span class="token punctuation">.</span>pool <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 定义最大池化层，池化核大小为2×2，步长为2</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 定义第二个卷积层，输入通道数为6，输出通道数为16，卷积核大小为5×5</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token comment"># 定义第一个全连接层，输入特征数为16×5×5（根据卷积和池化后的图像大小计算得到），输出特征数为120</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">)</span> <span class="token comment"># 定义第二个全连接层，输入特征数为120，输出特征数为84</span>
        self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># 定义第三个全连接层，输入特征数为84，</span>
</code></pre> 
<h2><a id="forward_113"></a>forward方法</h2> 
<p>forward方法用于定义前向传播过程，即如何根据输入的图像张量（Tensor）计算出输出的类别概率分布。我们可以使用定义好的各种层和参数，并结合一些激活函数（如ReLU）和归一化函数（如softmax）来实现forward方法。例如，要实现上面自定义的CNN模型的forward方法，可以使用以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">MyCNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 省略__init__方法的内容</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 定义前向传播过程，x是输入的图像张量</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pool<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将x通过第一个卷积层和ReLU激活函数，然后通过最大池化层</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pool<span class="token punctuation">(</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将x通过第二个卷积层和ReLU激活函数，然后通过最大池化层</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 将x展平为一维向量，-1表示自动推断批量大小</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将x通过第一个全连接层和ReLU激活函数</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将x通过第二个全连接层和ReLU激活函数</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># 将x通过第三个全连接层</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 将x通过softmax函数，沿着第一个维度（类别维度）进行归一化，得到类别概率分布</span>
        <span class="token keyword">return</span> x <span class="token comment"># 返回输出的类别概率分布</span>
</code></pre> 
<h2><a id="matplotlibpyplot_135"></a>进行模型训练和测试，使用matplotlib.pyplot库可视化结果</h2> 
<p>模型训练和测试是机器学习中的重要步骤，它们可以帮助我们评估模型的性能和泛化能力。matplotlib.pyplot是一个Python库，它可以用来绘制各种类型的图形，包括曲线图、散点图、直方图等。使用matplotlib.pyplot库可视化结果的一般步骤如下：</p> 
<ul><li>导入matplotlib.pyplot模块，并设置一些参数，如字体、分辨率等。</li><li>创建一个或多个图形对象（figure），并指定大小、标题等属性。</li><li>在每个图形对象中创建一个或多个子图（subplot），并指定位置、坐标轴等属性。</li><li>在每个子图中绘制数据，使用不同的函数和参数，如plot、scatter、bar等。</li><li>添加一些修饰元素，如图例（legend）、标签（label）、标题（title）等。</li><li>保存或显示图形。</li></ul> 
<p>例如：<mark>使用matplotlib.pyplot库绘制了一个线性回归模型的训练误差和测试误差曲线：</mark></p> 
<pre><code class="prism language-python"><span class="token comment"># 导入模块</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># 设置字体和分辨率</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">"font.sans-serif"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"SimHei"</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">"axes.unicode_minus"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token operator">%</span>config InlineBackend<span class="token punctuation">.</span>figure_format <span class="token operator">=</span> <span class="token string">"retina"</span>

<span class="token comment"># 生成数据</span>
x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> x <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token comment"># 真实值</span>
w <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 随机初始化权重</span>
b <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 随机初始化偏置</span>

<span class="token comment"># 定义损失函数</span>
<span class="token keyword">def</span> <span class="token function">loss</span><span class="token punctuation">(</span>y_true<span class="token punctuation">,</span> y_pred<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y_true <span class="token operator">-</span> y_pred<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 定义梯度下降函数</span>
<span class="token keyword">def</span> <span class="token function">gradient_descent</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y_true<span class="token punctuation">,</span> w<span class="token punctuation">,</span> b<span class="token punctuation">,</span> lr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    y_pred <span class="token operator">=</span> w <span class="token operator">*</span> x <span class="token operator">+</span> b <span class="token comment"># 预测值</span>
    dw <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token punctuation">(</span>y_true <span class="token operator">-</span> y_pred<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 权重梯度</span>
    db <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y_true <span class="token operator">-</span> y_pred<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 偏置梯度</span>
    w <span class="token operator">=</span> w <span class="token operator">-</span> lr <span class="token operator">*</span> dw <span class="token comment"># 更新权重</span>
    b <span class="token operator">=</span> b <span class="token operator">-</span> lr <span class="token operator">*</span> db <span class="token comment"># 更新偏置</span>
    <span class="token keyword">return</span> w<span class="token punctuation">,</span> b

<span class="token comment"># 训练模型，并记录每轮的训练误差和测试误差</span>
epochs <span class="token operator">=</span> <span class="token number">20</span> <span class="token comment"># 训练轮数</span>
lr <span class="token operator">=</span> <span class="token number">0.01</span> <span class="token comment"># 学习率</span>
train_loss_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 训练误差列表</span>
test_loss_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 测试误差列表</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 划分训练集和测试集（8:2）</span>
    train_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    test_index <span class="token operator">=</span> np<span class="token punctuation">.</span>setdiff1d<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_index<span class="token punctuation">)</span>
    x_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> x<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span>
    x_test<span class="token punctuation">,</span> y_test <span class="token operator">=</span> x<span class="token punctuation">[</span>test_index<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>test_index<span class="token punctuation">]</span>

    <span class="token comment"># 梯度下降更新参数，并计算训练误差和测试误差</span>
    w<span class="token punctuation">,</span> b <span class="token operator">=</span> gradient_descent<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> w<span class="token punctuation">,</span> b<span class="token punctuation">,</span> lr<span class="token punctuation">)</span>
    train_loss <span class="token operator">=</span> loss<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> w <span class="token operator">*</span> x_train <span class="token operator">+</span> b<span class="token punctuation">)</span>
    test_loss <span class="token operator">=</span> loss<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> w <span class="token operator">*</span> x_test <span class="token operator">+</span> b<span class="token punctuation">)</span>

    <span class="token comment"># 打印结果，并将误差添加到列表中</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">, Train Loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>train_loss<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">, Test Loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>test_loss<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    train_loss_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span>
    test_loss_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_loss<span class="token punctuation">)</span>

<span class="token comment"># 创建一个图形对象，并设置大小为8*6英寸    </span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 在图形对象中创建一个子图，并设置位置为1行1列的第1个</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 在子图中绘制训练误差和测试误差曲线，使用不同的颜色和标签</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">,</span> train_loss_list<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Train Loss"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">,</span> test_loss_list<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"Test Loss"</span><span class="token punctuation">)</span>

<span class="token comment"># 添加图例、坐标轴标签和标题</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Epoch"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"Loss"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Linear Regression Loss Curve"</span><span class="token punctuation">)</span>

<span class="token comment"># 保存或显示图形</span>
<span class="token comment">#plt.savefig("loss_curve.png")</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>运行后，可以看到如下的图形：<br> <img src="https://images2.imgbox.com/3c/a8/hud5u3yI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6a/fb/bYbFw8Vw_o.png" alt="在这里插入图片描述"></p> 
<p>参考：：<a href="https://pytorch.org/" rel="nofollow"> PyTorch官方网站</a></p> 
<p><img src="https://images2.imgbox.com/3d/25/EGrhu6Q4_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d037c3e37f8a38d217cbfc641be8057c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Web】WebHook详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fb0490be6cc2106077016bb76dcd1087/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">动手学深度学习(李沐)的pytorch版本（包含代码和PDF版本）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>