<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>四、zabbix7.0推送告警至钉钉webhook机器人 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2423566feb7f52098bb2265107cc6127/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="四、zabbix7.0推送告警至钉钉webhook机器人">
  <meta property="og:description" content="一、前提条件
1、zabbix服务器能够访问钉钉的服务器，具体说是能访问https://oapi.dingtalk.com/robot/send
2、钉钉的webhook是有安全要求的，我采用的是ip的方式，我的zabbix服务器在内网，我的网络出口有多个固定公网ip，所以这样做省事，其他方式也可以你自己考虑。下图是webhook机器人的配置。
二、zabbix7配置报警媒介以及消息模板配置
告警----媒介---创建媒介类型
这一步，参数里面默认的跟我下图里不一样的，按我下图修改。Key是你的webhook机器人地址里的access_token=后面的内容。
脚本内容如下
var dingding = { key: null, message: null, msgtype: &#34;markdown&#34;, proxy: null, // 发送消息的函数 sendMessage: function () { var params = { msgtype: dingding.msgtype, markdown: { title: &#34;网络设备告警&#34;, // 消息的标题 text: dingding.message // 消息的内容 }, }; // 钉钉的Webhook URL var url = &#34;https://oapi.dingtalk.com/robot/send?access_token=&#34; &#43; dingding.key; // 创建一个新的HttpRequest对象 var request = new HttpRequest(); if (dingding.proxy) { request.setProxy(dingding.proxy); // 设置代理，如果有的话 } // 设置请求头 request.addHeader(&#34;Content-Type: application/json&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-11T10:25:15+08:00">
    <meta property="article:modified_time" content="2024-06-11T10:25:15+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">四、zabbix7.0推送告警至钉钉webhook机器人</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>一、前提条件</p> 
<p>1、zabbix服务器能够访问钉钉的服务器，具体说是能访问<a href="https://oapi.dingtalk.com/robot/send" rel="nofollow" title="https://oapi.dingtalk.com/robot/send">https://oapi.dingtalk.com/robot/send</a></p> 
<p> 2、钉钉的webhook是有安全要求的，我采用的是ip的方式，我的zabbix服务器在内网，我的网络出口有多个固定公网ip，所以这样做省事，其他方式也可以你自己考虑。下图是webhook机器人的配置。</p> 
<p><img alt="" height="980" src="https://images2.imgbox.com/ff/ca/s316HP3a_o.png" width="1200"></p> 
<p>二、zabbix7配置报警媒介以及消息模板配置</p> 
<p>告警----媒介---创建媒介类型</p> 
<p><img alt="" height="919" src="https://images2.imgbox.com/da/d9/baSfMMAl_o.png" width="1200"></p> 
<p><img alt="" height="729" src="https://images2.imgbox.com/b1/d1/AA5yiNoz_o.png" width="754"></p> 
<p>这一步，参数里面默认的跟我下图里不一样的，按我下图修改。Key是你的webhook机器人地址里的access_token=后面的内容。</p> 
<p>脚本内容如下</p> 
<pre><code>var dingding = {
  key: null,
  message: null,
  msgtype: "markdown",
  proxy: null,

  // 发送消息的函数
  sendMessage: function () {
    var params = {
      msgtype: dingding.msgtype,
      markdown: {
        title: "网络设备告警", // 消息的标题
        text: dingding.message // 消息的内容
      },
    };

    // 钉钉的Webhook URL
    var url = "https://oapi.dingtalk.com/robot/send?access_token=" + dingding.key;

    // 创建一个新的HttpRequest对象
    var request = new HttpRequest();
    if (dingding.proxy) {
      request.setProxy(dingding.proxy); // 设置代理，如果有的话
    }

    // 设置请求头
    request.addHeader("Content-Type: application/json");
    var data = JSON.stringify(params); // 将参数转换为JSON字符串

    // 记录URL日志，替换掉key以保护隐私
    Zabbix.Log(4, "[dingding Webhook] URL: " + url.replace(dingding.key, "&lt;BOT KEY&gt;"));
    Zabbix.Log(4, "[dingding Webhook] params: " + data);

    // 发送POST请求
    var response = request.post(url, data);
    Zabbix.Log(4, "[dingding Webhook] HTTP code: " + request.getStatus());

    try {
      response = JSON.parse(response); // 解析响应
    } catch (error) {
      response = null;
    }

    // 检查响应状态和错误码
    if (request.getStatus() !== 200 || response.errcode !== 0) {
      if (typeof response.errmsg === "string") {
        throw response.errmsg; // 抛出错误信息
      } else {
        throw "Unknown error. Check debug log for more information."; // 抛出未知错误
      }
    }
  },
};

try {
  // 解析传入的参数
  var params = JSON.parse(value);
  if (typeof params.Key === "undefined") {
    throw 'Incorrect value is given for parameter "Key": parameter is missing'; // 检查Key参数
  }
  dingding.key = params.Key;
  if (params.HTTPProxy) {
    dingding.proxy = params.HTTPProxy; // 设置代理
  }
  dingding.message = params.Subject + "\n" + params.Message; // 组合消息内容
  dingding.sendMessage(); // 发送消息
  return "OK";
} catch (error) {
  Zabbix.Log(4, "[dingding Webhook] notification failed: " + error); // 记录错误日志
  throw "Sending failed: " + error + "."; // 抛出发送失败错误
}</code></pre> 
<p>消息模板配置如下</p> 
<p><img alt="" height="271" src="https://images2.imgbox.com/fe/db/6TroEvU7_o.png" width="731"></p> 
<p>问题</p> 
<p><img alt="" height="274" src="https://images2.imgbox.com/7f/32/lu4hEbQ0_o.png" width="586"></p> 
<p>主题留空就行了，内容如下：</p> 
<pre><code>&lt;font color="comment"&gt;主机IP：{HOST.IP}&lt;/font&gt;

&lt;font color="comment"&gt;告警主机：{HOST.NAME}&lt;/font&gt;

&lt;font color="comment"&gt;告警时间：{EVENT.DATE} {EVENT.TIME}&lt;/font&gt;

&lt;font color="comment"&gt;告警等级：{TRIGGER.SEVERITY}&lt;/font&gt;

&lt;font color="comment"&gt;告警信息：{TRIGGER.NAME}&lt;/font&gt;

&lt;font color="comment"&gt;当前状态：{TRIGGER.STATUS}&lt;/font&gt;

&lt;font color="comment"&gt;事件ID：{EVENT.ID}&lt;/font&gt;</code></pre> 
<p>主题留空，问题回复如下配置： </p> 
<p><img alt="" height="283" src="https://images2.imgbox.com/87/c1/Dg09tOn7_o.png" width="719"></p> 
<pre><code>&lt;font color="Green"&gt;主机IP：{HOST.IP}&lt;/font&gt;

&lt;font color="Green"&gt;告警主机：{HOST.NAME}&lt;/font&gt;

&lt;font color="Green"&gt;恢复时间：{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}&lt;/font&gt;

&lt;font color="Green"&gt;告警等级：{TRIGGER.SEVERITY}&lt;/font&gt;

&lt;font color="Green"&gt;告警信息：{TRIGGER.NAME}&lt;/font&gt;

&lt;font color="Green"&gt;当前状态：{TRIGGER.STATUS}&lt;/font&gt;

&lt;font color="Green"&gt;事件ID：{EVENT.ID}&lt;/font&gt;</code></pre> 
<p> 三、报警用户配置</p> 
<p><img alt="" height="623" src="https://images2.imgbox.com/a9/c7/S2DgjBSa_o.png" width="1200"></p> 
<p><img alt="" height="380" src="https://images2.imgbox.com/37/89/iKeepygO_o.png" width="971"></p> 
<p>选择你创建的告警媒介</p> 
<p><img alt="" height="418" src="https://images2.imgbox.com/69/32/Y8pK1ytW_o.png" width="788"></p> 
<p><img alt="" height="316" src="https://images2.imgbox.com/8b/86/HFwczdpb_o.png" width="1020"></p> 
<p>四、配置告警动作</p> 
<p><img alt="" height="619" src="https://images2.imgbox.com/2a/93/8kXioqUY_o.png" width="1200"></p> 
<p>设置动作规则</p> 
<p><img alt="" height="411" src="https://images2.imgbox.com/1b/ba/cn7nx2v0_o.png" width="1071"></p> 
<p>设置动作操作。</p> 
<p><img alt="" height="583" src="https://images2.imgbox.com/58/2c/JvZf7xBt_o.png" width="1053"></p> 
<p>整个逻辑就是告警动作匹配告警媒介与用户，然后进行告警的发送。</p> 
<p>用户里面需要有使用媒介的权限和时间。大概就这个意思</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/13b381adac4f14366491fa55238a1fa5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据结构（邓俊辉）学习笔记】图05——优先级搜索</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ffa01395889bf038fc20406a884bc44c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【HarmonyOS】HUAWEI DevEco Studio 下载地址汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>