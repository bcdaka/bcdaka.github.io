<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>6-5，web3浏览器链接区块链（react&#43;区块链实战） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/25a71060b3691918539b4d04ee6049fa/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="6-5，web3浏览器链接区块链（react&#43;区块链实战）">
  <meta property="og:description" content="6-5，web3浏览器链接区块链（react&#43;区块链实战） 6-5 web3浏览器链接区块链（调用读写合约与metamask联动） 6-5 web3浏览器链接区块链（调用读写合约与metamask联动） 这里就是浏览器端和智能合约的交互
两个库
Web3
Truffle contract //truffle在链接前端合约简单包了一层，比较好用
来到react项目的根目录下（在第一章进行了创建），
这里重新创建一个react项目
https://blog.csdn.net/u012118993/article/details/87288516
react创建新项目 使用creat-react-app快速新建一个react项目
（1）npm install -g create-react-app 全局安装（安装到整体）
（2）create-react-app reactproject 新建并对react项目进行命名（注:项目名称不能有大写）
（3）cd reactproject 通过命令进入文件夹内部，准备运行项目
（4）npm start 运行项目
E:\truffle\woniu-pet-shop 在truffle目录下创建
在react的项目下安装下面的文件
安装web3（安装到文件夹下面）
npm install web3 --save 再安装truffle-contract
npm install truffle-contract --save Demo完成
1.链接合约
2.执行一下合约内部函数
3.添加ant.design ui库支持
4.完成项目
注意新的
App.js中的内容
如下
import React from &#39;react&#39; import Web3 from &#39;web3&#39; import TruffleContract from &#39;truffle-contract&#39; import AdoptionJson from &#39;./truffle/build/contracts/Adoption.json&#39;	//引入前面智能合约编译好得到的json文件 class App extends React.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-11T22:12:09+08:00">
    <meta property="article:modified_time" content="2024-07-11T22:12:09+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">6-5，web3浏览器链接区块链（react&#43;区块链实战）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>6-5，web3浏览器链接区块链（react+区块链实战）</h4> 
 <ul><li><a href="#65_web3metamask_1" rel="nofollow">6-5 web3浏览器链接区块链（调用读写合约与metamask联动）</a></li></ul> 
</div> 
<p></p> 
<h2><a id="65_web3metamask_1"></a>6-5 web3浏览器链接区块链（调用读写合约与metamask联动）</h2> 
<p>这里就是浏览器端和智能合约的交互</p> 
<p>两个库</p> 
<p>Web3<br> Truffle contract //truffle在链接前端合约简单包了一层，比较好用</p> 
<p>来到react项目的根目录下（在第一章进行了创建），<br> <img src="https://images2.imgbox.com/ef/1b/nrc5zXx4_o.png" alt="在这里插入图片描述"></p> 
<p>这里重新创建一个react项目<br> https://blog.csdn.net/u012118993/article/details/87288516<br> react创建新项目 使用creat-react-app快速新建一个react项目</p> 
<p>（1）<code>npm install -g create-react-app</code> 全局安装（安装到整体）</p> 
<p>（2）<code>create-react-app reactproject</code> 新建并对react项目进行命名（注:项目名称不能有大写）</p> 
<p>（3）<code>cd reactproject</code> 通过命令进入文件夹内部，准备运行项目</p> 
<p>（4）<code>npm start</code> 运行项目</p> 
<pre><code>E:\truffle\woniu-pet-shop
</code></pre> 
<p>在truffle目录下创建<br> <img src="https://images2.imgbox.com/a3/b8/tnEp9ice_o.png" alt="在这里插入图片描述"></p> 
<p>在react的项目下安装下面的文件<br> 安装web3（安装到文件夹下面）</p> 
<pre><code>npm install web3 --save
</code></pre> 
<p><img src="https://images2.imgbox.com/e6/ec/E9571S0h_o.png" alt="在这里插入图片描述"></p> 
<p>再安装truffle-contract</p> 
<pre><code>npm install truffle-contract --save
</code></pre> 
<p>Demo完成</p> 
<p>1.链接合约<br> 2.执行一下合约内部函数<br> 3.添加ant.design ui库支持<br> 4.完成项目</p> 
<p><img src="https://images2.imgbox.com/c4/fa/RAwYJU9p_o.png" alt="在这里插入图片描述"></p> 
<p>注意新的<br> <img src="https://images2.imgbox.com/3a/3c/LfTjYr1m_o.png" alt="在这里插入图片描述"></p> 
<p>App.js中的内容<br> 如下</p> 
<pre><code>import React from 'react'
import Web3 from 'web3'
import TruffleContract from 'truffle-contract'
import AdoptionJson from './truffle/build/contracts/Adoption.json'	//引入前面智能合约编译好得到的json文件





class App extends React.Component{
	constructor(props){
		super(props)
		this.web3 = null
		this.Adoption = null
		this.init()

		this.state = {
			//name:'woniu'
		}
	}

	init(){
		//如果网页中的web3不是undefined
		if(typeof window.web3 != 'undefined'){
		}
	}

	render(){
		return &lt;button&gt;&lt;/button&gt;//hello,{this.state.name}
	}
}

export default App
</code></pre> 
<p><img src="https://images2.imgbox.com/e3/16/376v6z1W_o.png" alt="在这里插入图片描述"></p> 
<p>如果浏览器中装入了metamask插件</p> 
<p>在浏览器中全局变量就有值<br> <img src="https://images2.imgbox.com/51/5c/XOHs1XP0_o.png" alt="在这里插入图片描述"></p> 
<p>可以手动链接metamask，也可以自动连接<br> <img src="https://images2.imgbox.com/54/62/Yo3MxTI4_o.png" alt="在这里插入图片描述"></p> 
<p>进行脚本启动，之前web3在浏览器控制台undefined是因为空网页，此时</p> 
<p>在react项目自建的petshop中启动</p> 
<pre><code>Npm start
</code></pre> 
<p>在浏览器打开<br> http://localhost:3000/</p> 
<p>视频效果<br> <img src="https://images2.imgbox.com/0c/94/rDDZ0BV9_o.png" alt="在这里插入图片描述"></p> 
<p>视频安装新的包<br> <img src="https://images2.imgbox.com/51/db/G2lza74V_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b4/a5/qeWzKW4O_o.png" alt="在这里插入图片描述"></p> 
<p>自己的有报错，原因init函数没有保存</p> 
<p><img src="https://images2.imgbox.com/7f/4d/FJ3hgFs6_o.png" alt="在这里插入图片描述"></p> 
<p>实际成功后如下效果<br> <img src="https://images2.imgbox.com/6d/94/4TG2pCuE_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c9/a5/vfPAZpde_o.png" alt="在这里插入图片描述"></p> 
<p>新加入</p> 
<pre><code>init(){
		//如果网页中的web3不是undefined
		if(typeof window.web3 != 'undefined'){
			this.web3Provider = window.web3.currentProvider;	//metamask内置了web3的实例，实际可以手动链接
		}else{
			alert('请按照metamask')
		}
	}
</code></pre> 
<p>更改代码保存后，再次访问网络，无需关闭重新npm start</p> 
<p>此时刷新一下<br> 当然这时无弹窗，将metamask钱包删掉之后就有弹窗</p> 
<p>这时使用chrome没有钱包的浏览器访问<br> <img src="https://images2.imgbox.com/05/83/VcaEM94c_o.png" alt="在这里插入图片描述"></p> 
<p>有弹窗出现，但是有些乱码了</p> 
<p>又加入代码</p> 
<p><img src="https://images2.imgbox.com/73/e5/ayNK6wRP_o.png" alt="在这里插入图片描述"></p> 
<p>所有代码如下</p> 
<pre><code>import React from 'react'
import Web3 from 'web3'
import TruffleContract from 'truffle-contract'
import AdoptionJson from './truffle/build/contracts/Adoption.json'	//引入前面智能合约编译好得到的json文件

//1.链接合约
//2.执行一下合约内部函数
//3.添加ant.design ui库支持
//4.完成项目
class App extends React.Component{
	constructor(props){
		super(props)
		this.web3 = null
		this.Adoption = null
		this.init()

		this.state = {
			//name:'woniu'
		}
	}

	init(){
		//如果网页中的web3不是undefined
		if(typeof window.web3 != 'undefined'){
			this.web3Provider = window.web3.currentProvider;	//metamask内置了web3的实例，实际可以手动链接
		}else{
			alert('please install metamask')
		}
		
		this.web3 = new Web3(this.web3Provider)		//将我们的this.web3Provider装载进来
		this.initAdoption()

	}

	initAdoption(){
		this.Adoption = TruffleContract(AdoptionJson)	//使用TruffleContract传入编译后的合约，然后创建实例，可以调用合约内部函数
		this.Adoption.setProvider(this.web3Provider)	//设置来源，链接合约
		return this.markAdopted()
	}
	
	//部署，这个是异步的，使用this.Adoption.deployed().then()也可以，这里用
	//this.markAdopted(){
		//部署链接一下
	//	const adoptionInstance = this.Adoption.deployed().then()	

	//}

	async markAdopted(){
		//部署链接一下
		//await同步方式获取异步数据
		const adoptionInstance = await this.Adoption.deployed()	//部署，这个是异步的，使用this.Adoption.deployed().then()也可以，这里用
		//调用合约内部函数getAdopters
		const adopters = await adoptionInstance.getAdopters.call()
		console.log(adopters)
	}

	render(){
		return &lt;button&gt;&lt;/button&gt;//hello,{this.state.name}
	}
}

export default App
</code></pre> 
<p>刷新界面如下<br> <img src="https://images2.imgbox.com/ef/39/icfspxgv_o.png" alt="在这里插入图片描述"></p> 
<p>获取到合约的address了<br> <img src="https://images2.imgbox.com/a5/e1/M3lspX8K_o.png" alt="在这里插入图片描述"></p> 
<p>使用上方的变量可以获取本地的地址及metamask的默认账号地址了<br> <img src="https://images2.imgbox.com/86/3d/uPqkYch1_o.png" alt="在这里插入图片描述"></p> 
<p>https://blog.csdn.net/weixin_41937552/article/details/106990561?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-1&amp;spm=1001.2101.3001.4242</p> 
<p>这里无法获得metamask的地址的原因如上<br> https://blog.csdn.net/weixin_39421014/article/details/103323245</p> 
<p>可以先把metamask的隐私权限关闭<br> https://www.freesion.com/article/8518937500/<br> 隐私模式的设置与兼容JS代码<br> <img src="https://images2.imgbox.com/3a/1f/L5ROtJzm_o.png" alt="在这里插入图片描述"></p> 
<p>https://blog.csdn.net/JackieDYH/article/details/115380677?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-0&amp;spm=1001.2101.3001.4242<br> 获取账户信息</p> 
<p>经过代码的修改后在初始化的函数部分修改，</p> 
<p>可以使用metamask链接网站了，并且能够打印出当前的metamask地址<br> <img src="https://images2.imgbox.com/3b/89/GCuV6TMq_o.png" alt="在这里插入图片描述"></p> 
<p>接下来进行点击事件的代码更改<br> <img src="https://images2.imgbox.com/c0/17/K4IjX3PE_o.png" alt="在这里插入图片描述"></p> 
<p>此处点击领养会弹出框用来支付的，因为要调用写入函数，写到链上的，此处的领养不用转钱但需要父手续费</p> 
<p>本地成功调用需要写入区块链的函数（当点击按钮时如下）<br> <img src="https://images2.imgbox.com/e4/61/U47GtAfo_o.png" alt="在这里插入图片描述"></p> 
<p>最终成功运行的所有的代码如下：</p> 
<pre><code>import React from 'react'
import Web3 from 'web3'
import TruffleContract from 'truffle-contract'
import AdoptionJson from './truffle/build/contracts/Adoption.json'	//引入前面智能合约编译好得到的json文件

//1.链接合约
//2.执行一下合约内部函数
//3.添加ant.design ui库支持
//4.完成项目
class App extends React.Component{
	constructor(props){
		super(props)
		this.web3 = null
		this.Adoption = null
		this.init()

		this.state = {
			//name:'woniu'
		}
	}

	async init(){
		//如果网页中的web3不是undefined
		//if(typeof window.web3 != 'undefined'){
		//	this.web3Provider = window.web3.currentProvider;	//metamask内置了web3的实例，实际可以手动链接
		//}else{
		//	alert('please install metamask')
		//}
		
		//this.web3 = new Web3(this.web3Provider)		//将我们的this.web3Provider装载进来
		//this.initAdoption()
		
		/* 新版的方式 */
	  //var web3Provider;
	  if (window.ethereum) {
		this.web3Provider = window.ethereum;
		try {
		  // 请求用户授权
		  await window.ethereum.enable();
		} catch (error) {
		  // 用户不授权时
		  console.error("User denied account access")
		}
	  } else if (window.web3) {   // 老版 MetaMask Legacy dapp browsers...
		this.web3Provider = window.web3.currentProvider;
	  } else {
		this.web3Provider = new Web3.providers.HttpProvider('http://localhost:7545');
	  }
	  this.web3 = new Web3(this.web3Provider);//web3js就是你需要的web3实例
	  

	  this.web3.eth.getAccounts(function (error, result) {
		if (!error)
		  console.log(result)//授权成功后result能正常获取到账号了
		  //this.account = result
	  });
	  //this.account =result
	  //this.account =account
	  this.initAdoption()
	}

	initAdoption(){
		this.Adoption = TruffleContract(AdoptionJson)	//使用TruffleContract传入编译后的合约，然后创建实例，可以调用合约内部函数
		this.Adoption.setProvider(this.web3Provider)	//设置来源，链接合约
		return this.markAdopted()
	}
	
	//部署，这个是异步的，使用this.Adoption.deployed().then()也可以，这里用
	//this.markAdopted(){
		//部署链接一下
	//	const adoptionInstance = this.Adoption.deployed().then()	

	//}

	async markAdopted(){
		//部署链接一下
		//await同步方式获取异步数据
		const adoptionInstance = await this.Adoption.deployed()	//部署，这个是异步的，使用this.Adoption.deployed().then()也可以，这里用
		//调用合约内部函数getAdopters
		const adopters = await adoptionInstance.getAdopters.call()
		console.log(adopters)
	}
	
	async adopt(petId){
		//const account = window.web3.eth.defaultAccount		//获取metamask中默认的账户
		// 授权获取账户
	    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const myAccount = accounts[0];	//获取当前metamask的地址

		const adoptionInstance = await this.Adoption.deployed()		//再次进行部署
		await adoptionInstance.adopt(petId,{from:myAccount})	//调用adopt只传递唯一一个参数，以及来源之前获取的地址，进行写入函数
		this.markAdopted()
	}

	render(){
		//onclick点击事件，调用领养函数
		return &lt;button onClick={()=&gt;this.adopt(2)}&gt;领养第二个&lt;/button&gt;//hello,{this.state.name}
	}
}

export default App
</code></pre> 
<p>已经成功执行所有的函数，读取写入函数</p> 
<p>此代码还有一些缺陷，若交易失败会报错，页面也会报错，<br> 点击拒绝，或者直接退出时<br> <img src="https://images2.imgbox.com/90/bb/s69D6uso_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/91/56/g2cJwxJC_o.png" alt="在这里插入图片描述"></p> 
<p>接下来就是美化ui</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9e45bb3097190634a12647173fd302e8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jstat命令介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df896de34d00fe5a9235e58a617e60e8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Seamlessly Manipulate SVG Files in Python</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>