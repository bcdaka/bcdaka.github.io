<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>建模杂谈系列253 序列突变点的判定 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/8c38c324235737bc5a04635b3e972a81/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="建模杂谈系列253 序列突变点的判定">
  <meta property="og:description" content="说明 使用pycm3进行推断。
内容 1 环境搭建 使用conda创建对应的包环境，然后再通过jupyter运行
conda create -c conda-forge -n pymc_env &#34;pymc&gt;=5&#34; conda activate pymc_env pip3 install ipython -i https://mirrors.cloud.tencent.com/pypi/simple pip3 install jupyter -i https://mirrors.cloud.tencent.com/pypi/simple nohup jupyter lab --allow-root --ip=&#39;*&#39; --port=8888 &gt; /dev/null 2&gt;&amp;1 &amp; 嗯，我发现启动jupyter后竟然没有pymc,又重装了一下。最近阿里的镜像慢的不行了，腾讯快。
!pip3 install pymc -i https://mirrors.cloud.tencent.com/pypi/simple
2 实验 判定一个时间序列，产生突变点的位置
主要算是重启一下之前的记忆，确保新的环境搭建成功
%matplotlib inline from IPython.core.pylabtools import figsize import numpy as np from matplotlib import pyplot as plt import matplotlib as mpl mpl.style.use(&#34;ggplot&#34;) # figsize(11, 9) figsize(12.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-02T22:03:28+08:00">
    <meta property="article:modified_time" content="2024-09-02T22:03:28+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">建模杂谈系列253 序列突变点的判定</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>说明</h2> 
<p>使用pycm3进行推断。</p> 
<h2><a id="_4"></a>内容</h2> 
<h3><a id="1__6"></a>1 环境搭建</h3> 
<p>使用conda创建对应的包环境，然后再通过jupyter运行</p> 
<pre><code class="prism language-python">conda create <span class="token operator">-</span>c conda<span class="token operator">-</span>forge <span class="token operator">-</span>n pymc_env <span class="token string">"pymc&gt;=5"</span>
conda activate pymc_env

pip3 install  ipython <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple
pip3 install  jupyter <span class="token operator">-</span>i https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>pypi<span class="token operator">/</span>simple

nohup jupyter lab <span class="token operator">-</span><span class="token operator">-</span>allow<span class="token operator">-</span>root <span class="token operator">-</span><span class="token operator">-</span>ip<span class="token operator">=</span><span class="token string">'*'</span> <span class="token operator">-</span><span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">8888</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>null <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">1</span> <span class="token operator">&amp;</span>
</code></pre> 
<p>嗯，我发现启动jupyter后竟然没有pymc,又重装了一下。最近阿里的镜像慢的不行了，腾讯快。<br> <code>!pip3 install pymc -i https://mirrors.cloud.tencent.com/pypi/simple</code></p> 
<h3><a id="2__22"></a>2 实验</h3> 
<blockquote> 
 <p>判定一个时间序列，产生突变点的位置</p> 
</blockquote> 
<p>主要算是重启一下之前的记忆，确保新的环境搭建成功</p> 
<pre><code class="prism language-python"><span class="token operator">%</span>matplotlib inline
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>core<span class="token punctuation">.</span>pylabtools <span class="token keyword">import</span> figsize
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> matplotlib <span class="token keyword">as</span> mpl
mpl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>use<span class="token punctuation">(</span><span class="token string">"ggplot"</span><span class="token punctuation">)</span>
<span class="token comment"># figsize(11, 9)</span>

figsize<span class="token punctuation">(</span><span class="token number">12.5</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">)</span>
count_data <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token string">"txtdata.csv"</span><span class="token punctuation">)</span>
n_count_data <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>count_data<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>n_count_data<span class="token punctuation">)</span><span class="token punctuation">,</span> count_data<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"#348ABD"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"Time (days)"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"count of text-msgs received"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Did the user's texting habits change over time?"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n_count_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>说的是作者自己发短信的数据，有一天发生了变化，但是从图上看不出来。<br> <img src="https://images2.imgbox.com/4d/4c/tlaVnGqY_o.png" alt="在这里插入图片描述"></p> 
<p>然后构建了一个模型框架，假设有两种不同的模式</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymc <span class="token keyword">as</span> pm

<span class="token keyword">with</span> pm<span class="token punctuation">.</span>Model<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> model<span class="token punctuation">:</span>
    alpha <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span>count_data<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Recall count_data is the</span>
                                   <span class="token comment"># variable that holds our txt counts</span>
    lambda_1 <span class="token operator">=</span> pm<span class="token punctuation">.</span>Exponential<span class="token punctuation">(</span><span class="token string">"lambda_1"</span><span class="token punctuation">,</span> alpha<span class="token punctuation">)</span>
    lambda_2 <span class="token operator">=</span> pm<span class="token punctuation">.</span>Exponential<span class="token punctuation">(</span><span class="token string">"lambda_2"</span><span class="token punctuation">,</span> alpha<span class="token punctuation">)</span>
    
    tau <span class="token operator">=</span> pm<span class="token punctuation">.</span>DiscreteUniform<span class="token punctuation">(</span><span class="token string">"tau"</span><span class="token punctuation">,</span> lower<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> upper<span class="token operator">=</span>n_count_data <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> model<span class="token punctuation">:</span>
    idx <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>n_count_data<span class="token punctuation">)</span> <span class="token comment"># Index</span>
    lambda_ <span class="token operator">=</span> pm<span class="token punctuation">.</span>math<span class="token punctuation">.</span>switch<span class="token punctuation">(</span>tau <span class="token operator">&gt;</span> idx<span class="token punctuation">,</span> lambda_1<span class="token punctuation">,</span> lambda_2<span class="token punctuation">)</span>

<span class="token keyword">with</span> model<span class="token punctuation">:</span>
    observation <span class="token operator">=</span> pm<span class="token punctuation">.</span>Poisson<span class="token punctuation">(</span><span class="token string">"obs"</span><span class="token punctuation">,</span> lambda_<span class="token punctuation">,</span> observed<span class="token operator">=</span>count_data<span class="token punctuation">)</span>

</code></pre> 
<p>然后将观察数据给到模型，执行mcmc,然后画图</p> 
<pre><code class="prism language-python"><span class="token comment">### Mysterious code to be explained in Chapter 3.</span>
<span class="token keyword">with</span> model<span class="token punctuation">:</span>
    step <span class="token operator">=</span> pm<span class="token punctuation">.</span>Metropolis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    trace <span class="token operator">=</span> pm<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> tune<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">,</span> step<span class="token operator">=</span>step<span class="token punctuation">,</span> return_inferencedata<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

lambda_1_samples <span class="token operator">=</span> trace<span class="token punctuation">[</span><span class="token string">'lambda_1'</span><span class="token punctuation">]</span>
lambda_2_samples <span class="token operator">=</span> trace<span class="token punctuation">[</span><span class="token string">'lambda_2'</span><span class="token punctuation">]</span>
tau_samples <span class="token operator">=</span> trace<span class="token punctuation">[</span><span class="token string">'tau'</span><span class="token punctuation">]</span>

figsize<span class="token punctuation">(</span><span class="token number">12.5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">#histogram of the samples:</span>

ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">311</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>set_autoscaley_on<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>lambda_1_samples<span class="token punctuation">,</span> histtype<span class="token operator">=</span><span class="token string">'stepfilled'</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.85</span><span class="token punctuation">,</span>
         label<span class="token operator">=</span><span class="token string">"posterior of $\lambda_1$"</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"#A60628"</span><span class="token punctuation">,</span> density<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"upper left"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token triple-quoted-string string">r"""Posterior distributions of the variables
    $\lambda_1,\;\lambda_2,\;\tau$"""</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"$\lambda_1$ value"</span><span class="token punctuation">)</span>

ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">312</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>set_autoscaley_on<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>lambda_2_samples<span class="token punctuation">,</span> histtype<span class="token operator">=</span><span class="token string">'stepfilled'</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.85</span><span class="token punctuation">,</span>
         label<span class="token operator">=</span><span class="token string">"posterior of $\lambda_2$"</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"#7A68A6"</span><span class="token punctuation">,</span> density<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"upper left"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"$\lambda_2$ value"</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">313</span><span class="token punctuation">)</span>
w <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> tau_samples<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>tau_samples<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>tau_samples<span class="token punctuation">,</span> bins<span class="token operator">=</span>n_count_data<span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
         label<span class="token operator">=</span><span class="token string">r"posterior of $\tau$"</span><span class="token punctuation">,</span>
         color<span class="token operator">=</span><span class="token string">"#467821"</span><span class="token punctuation">,</span> weights<span class="token operator">=</span>w<span class="token punctuation">,</span> rwidth<span class="token operator">=</span><span class="token number">2.</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>n_count_data<span class="token punctuation">)</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"upper left"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.75</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">35</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>count_data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">r"$\tau$ (in days)"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"probability"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后可以推断在45天的时候发生跳变（作者自己承认了这一点）<br> <img src="https://images2.imgbox.com/a3/6c/zRgMb7JV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__124"></a>3 总结</h3> 
<ul><li>1 这种模型可以推断看不见的事实</li><li>2 matplotlib用好了也可以画出很好看的图</li></ul> 
<p>注意：理论上，pymc是可以借用显卡计算的。只不过之前它的后端比较奇葩，现在可能失传了。然后我不太清楚的是现在怎么和显卡挂上，单靠cpu只能做一些小规模的计算。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3c3e003c76181166f718491f721e51e7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【高阶数据结构】秘法（一）——并查集：探索如何高效地管理集合</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2eb93d395d103ab7b381996adf5b03b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">华为od统一考试B卷【密钥格式化】Java 实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>