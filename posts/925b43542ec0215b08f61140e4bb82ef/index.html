<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Android】系统启动流程分析 —— Zygote 进程启动过程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/925b43542ec0215b08f61140e4bb82ef/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Android】系统启动流程分析 —— Zygote 进程启动过程">
  <meta property="og:description" content="本文基于 Android 14.0.0_r2 的系统启动流程分析。
一、概述 Zygote 是 Android 系统中的一个核心进程，它在系统启动时被初始化。Zygote 的主要任务是加载系统的核心类库（如 Java 核心库和 Android 核心库），然后进入一个循环，等待请求来创建新的 Android 应用程序进程。
当一个新的 Android 应用程序需要启动时，Zygote 会 fork 出一个新的进程，这个新的进程继承了 Zygote 的内存空间，包括已经预加载的类库。这种方式可以大大提高新进程的启动速度，因为不需要再次加载这些类库。
Zygote 进程是所有 Android 应用程序进程的父进程，它的启动和初始化对于 Android 系统的运行至关重要。
二、源码分析 在 init.rc 文件中会执行 class_start main 来启动 Zygote，源代码如下：
路径：/system/core/rootdir/init.rc on nonencrypted class_start main class_start late_start 这个 main 就是 Zygote，可以通过 init.zygote64.rc 来查看，源代码如下：
路径：/system/core/rootdir/init.zygote64.rc // 定义了一个名为 zygote 的服务，它运行的是 /system/bin/app_process64 可执行文件。 // “-Xzygote” 参数指定了这是一个 Zygote 进程，用于启动 Android 应用进程和系统服务。 // “--zygote” 标志表明这是一个 Zygote 服务实例。 // “--start-system-server” 意味着在 Zygote 启动时同时启动系统服务。 service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote // 指定服务所属的主要控制类，即在 init 进程中优先启动。 class main // 设置服务启动的优先级为-20（数值越低，优先级越高）。 priority -20 // 指定服务运行时的用户和组，这里是 root 用户，以及包含 root 组和其他两个附加权限组 readproc 和 reserved_disk。 user root group root readproc reserved_disk // 创建两个命名 socket。 // zygote socket 用于与系统进行通信，以便请求创建新的应用程序进程。 // usap_pool_primary 用途可能与进程间通信或资源池管理有关。 socket zygote stream 660 root system socket usap_pool_primary stream 660 root system // 定义了一系列在 zygote 服务重启时执行的操作。 onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart write /sys/power/wake_lock zygote_kwl onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart media.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-26T16:38:09+08:00">
    <meta property="article:modified_time" content="2024-03-26T16:38:09+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Android】系统启动流程分析 —— Zygote 进程启动过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本文基于 <a href="http://aospxref.com/android-14.0.0_r2/" rel="nofollow">Android 14.0.0_r2</a> 的系统启动流程分析。</p> 
</blockquote> 
<h3><a id="_2"></a>一、概述</h3> 
<p>Zygote 是 Android 系统中的一个核心进程，它在系统启动时被初始化。Zygote 的主要任务是加载系统的核心类库（如 Java 核心库和 Android 核心库），然后进入一个循环，等待请求来创建新的 Android 应用程序进程。</p> 
<p>当一个新的 Android 应用程序需要启动时，Zygote 会 fork 出一个新的进程，这个新的进程继承了 Zygote 的内存空间，包括已经预加载的类库。这种方式可以大大提高新进程的启动速度，因为不需要再次加载这些类库。</p> 
<p>Zygote 进程是所有 Android 应用程序进程的父进程，它的启动和初始化对于 Android 系统的运行至关重要。</p> 
<h3><a id="_10"></a>二、源码分析</h3> 
<p>在 <a href="http://aospxref.com/android-14.0.0_r2/xref/system/core/rootdir/init.rc" rel="nofollow">init.rc</a> 文件中会执行 <code>class_start main</code> 来启动 <code>Zygote</code>，源代码如下：</p> 
<pre><code class="prism language-rc">路径：/system/core/rootdir/init.rc

on nonencrypted
    class_start main
    class_start late_start
</code></pre> 
<p>这个 <code>main</code> 就是 <code>Zygote</code>，可以通过 <a href="http://aospxref.com/android-14.0.0_r2/xref/system/core/rootdir/init.zygote64.rc" rel="nofollow">init.zygote64.rc</a> 来查看，源代码如下：</p> 
<pre><code class="prism language-rc">路径：/system/core/rootdir/init.zygote64.rc

// 定义了一个名为 zygote 的服务，它运行的是 /system/bin/app_process64 可执行文件。
// “-Xzygote” 参数指定了这是一个 Zygote 进程，用于启动 Android 应用进程和系统服务。
// “--zygote” 标志表明这是一个 Zygote 服务实例。
// “--start-system-server” 意味着在 Zygote 启动时同时启动系统服务。
service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote
    // 指定服务所属的主要控制类，即在 init 进程中优先启动。
    class main

    // 设置服务启动的优先级为-20（数值越低，优先级越高）。
    priority -20

    // 指定服务运行时的用户和组，这里是 root 用户，以及包含 root 组和其他两个附加权限组 readproc 和 reserved_disk。
    user root
    group root readproc reserved_disk

    // 创建两个命名 socket。
    // zygote socket 用于与系统进行通信，以便请求创建新的应用程序进程。
    // usap_pool_primary 用途可能与进程间通信或资源池管理有关。
    socket zygote stream 660 root system
    socket usap_pool_primary stream 660 root system

    // 定义了一系列在 zygote 服务重启时执行的操作。
    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse
    onrestart write /sys/power/state on
    onrestart write /sys/power/wake_lock zygote_kwl
    onrestart restart audioserver
    onrestart restart cameraserver
    onrestart restart media
    onrestart restart media.tuner
    onrestart restart netd
    onrestart restart wificond

    // 指定 zygote 任务应具有高处理能力和最大性能配置文件。
    task_profiles ProcessCapacityHigh MaxPerformance

    // 设置 zygote 服务的关键窗口时间，在此期间如果服务未成功启动，则视为致命错误。
    critical window=${zygote.critical_window.minute:-off} target=zygote-fatal
</code></pre> 
<p>可以看到 audioserver、cameraserver、media、netd、wificond 这些进程都隶属于 Zygote 进程中，那就代表着：</p> 
<ul><li>如果 Zygote died，这些进程将一起 died。</li><li>如果这些进程 died，并不会影响 Zygote died。</li></ul> 
<p>如果 Zygote died 将会捕获到进程异常信号，将 Zygote 进程进行重启，Zygote main 入口位置：<code>/frameworks/base/cmds/app_process/app_main.cpp</code>。</p> 
<ol><li> <p><a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/cmds/app_process/app_main.cpp" rel="nofollow">app_main.cpp</a> 源码分析</p> <pre><code class="prism language-cpp">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>app_process<span class="token operator">/</span>app_main<span class="token punctuation">.</span>cpp

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    AppRuntime <span class="token function">runtime</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">computeArgBlockSize</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 如果 zygote 为 true 则代表即将创建该进程。</span>
    <span class="token keyword">bool</span> zygote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果 startSystemServer 为 true 则代表创建 zygote 时也会创建 SystemServer。</span>
    <span class="token keyword">bool</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 系统正常启动都会将这两个 bool 默认给到 true，因为 rc 启动 main 后携带了--zygote 和 --start-system-server 两个参数。</span>
    <span class="token keyword">bool</span> application <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    String8 niceName<span class="token punctuation">;</span>
    String8 className<span class="token punctuation">;</span>

    <span class="token operator">++</span>i<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--zygote"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// zygote 将为 true，名称就叫 zygote。</span>
            zygote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            niceName <span class="token operator">=</span> ZYGOTE_NICE_NAME<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--start-system-server"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// startSystemServer 将为 true。</span>
            startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--application"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            application <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--nice-name="</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            niceName<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>arg <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            className<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">--</span>i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Vector<span class="token operator">&lt;</span>String8<span class="token operator">&gt;</span> args<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 进入创建 zygote 模式。</span>
        <span class="token comment">// 创建 /data/dalvik-cache，为后续会创建 Dalvik 虚拟机做准备。</span>
        <span class="token function">maybeCreateDalvikCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">char</span> prop<span class="token punctuation">[</span>PROP_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 将所有剩余参数传递给 args，例如 application 或 tool 或 start-system-server 或 abi。</span>
        <span class="token comment">// 这些启动参数将会传递到其他进程中，后续取出参数决定是否启动 systemServer 等操作。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>niceName<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        runtime<span class="token punctuation">.</span><span class="token function">setArgv0</span><span class="token punctuation">(</span>niceName<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// zygote 为真，将创建 zygote，该 args 启动参数会包含 start-system-server。</span>
    <span class="token comment">// 调用 runtime(AppRuntime) 的 start 来启动 zygote，将 args 传入，因为 args 包含了启动 SystemServer 的标志。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        runtime<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"com.android.internal.os.ZygoteInit"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        runtime<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"com.android.internal.os.RuntimeInit"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: no class name or --zygote supplied.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">app_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"app_process: no class name or --zygote supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>以上代码就是启动 Zygote 和将 start-system-server 放入启动参数，后续会读取参数启动 SystemServer，继续分析一下 <code>runtime.start</code> 的 <code>com.android.internal.os.ZygoteInit</code> 进程，位于 <code>/frameworks/base/core/jni/AndroidRuntime.cpp</code>。</p> </li><li> <p><a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/jni/AndroidRuntime.cpp" rel="nofollow">AndroidRuntime.cpp</a> 源码分析</p> <pre><code class="prism language-cpp">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>jni<span class="token operator">/</span>AndroidRuntime<span class="token punctuation">.</span>cpp

<span class="token comment">// Vector&lt;String8&gt;&amp; options 就是包含了 start-system-server 的启动参数，通过 app_main.cpp 传递过来的。</span>
<span class="token keyword">void</span> <span class="token class-name">AndroidRuntime</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>String8<span class="token operator">&gt;</span><span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">bool</span> zygote<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n"</span><span class="token punctuation">,</span>
            className <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> className <span class="token operator">:</span> <span class="token string">"(unknown)"</span><span class="token punctuation">,</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 默认会启动 SystemServer。</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> String8 <span class="token function">startSystemServer</span><span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否私有，如果 SystemServer 会被创建时，将会设置为私有。</span>
    <span class="token keyword">bool</span> primary_zygote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// options 就是传递过来的 args，默认是包含了 start-system-server。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            primary_zygote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取环境变量，这里第一次执行时默认为空，所以 rootDir 不存在。</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> rootDir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_ROOT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将直接拿到 /system 作为 rootDir 并设置环境变量。</span>
        rootDir <span class="token operator">=</span> <span class="token string">"/system"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasDir</span><span class="token punctuation">(</span><span class="token string">"/system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG_FATAL</span><span class="token punctuation">(</span><span class="token string">"No root directory specified, and /system does not exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_ROOT"</span><span class="token punctuation">,</span> rootDir<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 这里就开始启动虚拟机了。</span>
    <span class="token comment">// JNI 功能初始化。</span>
    JniInvocation jni_invocation<span class="token punctuation">;</span>
    jni_invocation<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
    <span class="token comment">// 创建 Dalvik 虚拟机(这里 --&gt; DVM == JavaVM)。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startVm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mJavaVM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> zygote<span class="token punctuation">,</span> primary_zygote<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">onVmCreated</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用 startReg 函数用来为 DVM 注册 JNI。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startReg</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to register all android natives\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    jclass stringClass<span class="token punctuation">;</span>
    jobjectArray strArray<span class="token punctuation">;</span>
    jstring classNameStr<span class="token punctuation">;</span>

    <span class="token comment">// 通过反射拿到 String 类型。</span>
    stringClass <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>stringClass <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// options 就是 app_main.cpp 传递过来的 args，包含了 start-system-server。</span>
    <span class="token comment">// 将 options 转换为 array list 对象。</span>
    strArray <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> stringClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>strArray <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从 app_main.cpp 的 main 函数得知 className 为 com.android.internal.os.ZygoteInit。</span>
    classNameStr <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>classNameStr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将数据转换给 java 类型的 array 数组。</span>
    env<span class="token operator">-&gt;</span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>strArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        jstring optionsStr <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>optionsStr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-&gt;</span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>strArray<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> optionsStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动 com.android.internal.os.ZygoteInit，该线程成为 JVM 的主进程，在 VM 退出之前不会返回。</span>
    <span class="token keyword">char</span><span class="token operator">*</span> slashClassName <span class="token operator">=</span> <span class="token function">toSlashClassName</span><span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> className <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jclass startClass <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">FindClass</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 通过反射的方式，找到 ZygoteInit 的 main 函数。</span>
        <span class="token comment">// 若获取到内容则执行 else。</span>
        jmethodID startMeth <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
            <span class="token string">"([Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startMeth <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to find main() in '%s'\n"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过 JNI 调用 ZygoteInit 的 main 函数，将 args(strArray) 传递到 java 层。</span>
            <span class="token comment">// 因为 ZygoteInit 的 main 函数是 Java 编写的，因此需要通过 JNI 调用。</span>
            <span class="token comment">// 所以这里继续跟到 java 层面：ZygoteInit.java。</span>
            env<span class="token operator">-&gt;</span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> startMeth<span class="token punctuation">,</span> strArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若执行到这里，则会结束 Zygote 创建，关闭 JVM。</span>
    <span class="token function">free</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"Shutting down VM\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJavaVM<span class="token operator">-&gt;</span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Warning: unable to detach main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJavaVM<span class="token operator">-&gt;</span><span class="token function">DestroyJavaVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Warning: VM did not shut down cleanly\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>可以看到以上的代码主要就是初始化了 JNI（C++ 与 Java 交互）功能并创建并启动了 JVM 虚拟机，通过反射的方式去启动 ZygoteInit.java 的 main 方法，并将 args 参数（包含了是否启动 SystemServer 的参数）传递过去。而 JVM 虚拟机进程就是 com.android.internal.os.ZygoteInit，而 ZygoteInit 进程位于 /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 。</p> </li><li> <p><a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java" rel="nofollow">ZygoteInit.java</a> 源码分析</p> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 标记 zygote 开始了。</span>
    <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">startZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置 zygote 自己的用户组 pid。</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to setpgid(0,0)"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Runnable</span> caller<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取系统是否已经启动完成。</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isRuntimeRestarted <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sys.boot_completed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将行为写入 trace log 标记目前正处于 ZygoteInit 阶段。</span>
        <span class="token class-name">String</span> bootTimeTag <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">is64Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"Zygote64Timing"</span> <span class="token operator">:</span> <span class="token string">"Zygote32Timing"</span><span class="token punctuation">;</span>
        <span class="token class-name">TimingsTraceLog</span> bootTimingsTraceLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimingsTraceLog</span><span class="token punctuation">(</span>bootTimeTag<span class="token punctuation">,</span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_DALVIK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"ZygoteInit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">preForkInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// zygote 进程就是一个 socket，名称就叫 zygote。</span>
        <span class="token class-name">String</span> zygoteSocketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> abiList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 从 AndroidRuntime.cpp 中传递上来，已经包含了 start-system-server。</span>
            <span class="token comment">// 所以 startSystemServer = true。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 为 true，是私有 zygote。</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPrimaryZygote <span class="token operator">=</span> zygoteSocketName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">PRIMARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 记录的 trace log，只记录到这个地方。</span>
        bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化 socket，从环境中获取套接字 FD(ANDROID_SOCKET_zygote)。</span>
        <span class="token comment">// 若获取不到则创建一个用于和 systemServer 通信的 socket，当 systemServer fork 出来后 socket 进程将关闭。</span>
        <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">initNativeState</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 根据环境变量（LocalServerSocket）获取 zygote 文件描述符并重新创建一个 socket，可以从这里看到 zygote 其实就是一个 socket。</span>
        <span class="token comment">// 这个 name 为 zygote 的 Socket 用来等待 ActivityManagerService 来请求 Zygote 来 fork 出新的应用程序进程。</span>
        <span class="token comment">// 所以 ActivityManagerService 里启动应用程序（APP），都是由该 zygote socket 进行处理并 fork 出的子进程。</span>
        zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 默认为 true，将启动 systemServer。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// zygote 就是一个孵化器，所以这里直接 fork 出来 SystemServer。</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> zygoteSocketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 让 SystemServer 子进程运行起来。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 让 zygote socket（注意不是 systemServer zygote）循环运行。</span>
        <span class="token comment">// 等待 client 进程来请求调用，请求创建子进程（fork 出子进程（例如等待 AMS 的请求））。</span>
        caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 停止关于 systemServer 的 socket，保留和 AMS 通信的 socket。</span>
            <span class="token comment">// 在 initNativeState 阶段创建了一个和 systemServer 通信的 socket。</span>
            <span class="token comment">// 接着拿到 systemServer socket 文件描述符重新创建了一个可以和 AMS 通信的 socket（/dev/socket/zygote）。</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <p>以上代码讲述了 SystemServer Socket 的创建，将行为写入到 trace log 日志系统中，并通过 JNI 调用到底层的 fork 函数，孵化出 SystemServer 进程，如果 SystemServer 创建成功并已经运行了就会将当前 Socket 进行 close。期间会创建一个 Zygote Socket，用于等待其他子进程来连接，例如等待 AMS(Activity Manager Service)来连接该 Socket，然后继续 fork 出子进程（也就是应用程序，所以应用程序就是通过 Zygote 来 fork 出来的）。创建了 2 个 Socket，一个是 SystemServer Socket（<code>Zygote.initNativeState(isPrimaryZygote)</code> 来创建），一个是 Zygote Socket（<code>new ZygoteServer(isPrimaryZygote)</code> 来创建），注意区分。</p> <p>继续来看一下 <code>zygoteServer = new ZygoteServer(isPrimaryZygote);</code> 。</p> </li><li> <p><a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java" rel="nofollow">ZygoteServer.java</a> 源码分析</p> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteServer</span><span class="token punctuation">.</span>java

<span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mUsapPoolEventFD <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">getUsapPoolEventFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 socket，名称为 zygote，路径：/dev/sockets/zygote 。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mZygoteSocket <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">PRIMARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span>java

<span class="token keyword">static</span> <span class="token class-name">LocalServerSocket</span> <span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span><span class="token class-name">String</span> socketName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 文件描述符通过 ANDROID_socket_&lt;socketName&gt; 环境变量共享。</span>
    <span class="token keyword">int</span> fileDesc<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> fullSocketName <span class="token operator">=</span> <span class="token constant">ANDROID_SOCKET_PREFIX</span> <span class="token operator">+</span> socketName<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> env <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span>fullSocketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拿到文件描述符内容。</span>
        fileDesc <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Socket unset or invalid: "</span> <span class="token operator">+</span> fullSocketName<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 生成文件描述符。</span>
        <span class="token class-name">FileDescriptor</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fd<span class="token punctuation">.</span>setInt$<span class="token punctuation">(</span>fileDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LocalServerSocket</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
            <span class="token string">"Error building socket from file descriptor: "</span> <span class="token operator">+</span> fileDesc<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>android<span class="token operator">/</span>net<span class="token operator">/</span><span class="token class-name">LocalServerSocket</span><span class="token punctuation">.</span>java

<span class="token keyword">public</span> <span class="token class-name">LocalServerSocket</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建 socket 并持续监听（等待 client 来调用）。</span>
    impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocketImpl</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    impl<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">LISTEN_BACKLOG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    localAddress <span class="token operator">=</span> impl<span class="token punctuation">.</span><span class="token function">getSockAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>简单点来说就是创建了一个 Zygoye Socket，位于 /dev/sockets/zygote，并调用了 runSelectLoop 让其循环运行，等待新进程发来的请求并进行连接 zygoteServer.runSelectLoop(abiList) 然后 fork 出子应用程序进程。</p> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteServer</span><span class="token punctuation">.</span>java

<span class="token class-name">Runnable</span> <span class="token function">runSelectLoop</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileDescriptor</span><span class="token punctuation">&gt;</span></span> socketFDs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZygoteConnection</span><span class="token punctuation">&gt;</span></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 拿到 socket 的文件描述符。</span>
    socketFDs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mZygoteSocket<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollReturnValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> usapPoolFDRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>pollIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> <span class="token constant">POLLIN</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// acceptCommandPeer 函数得到 ZygoteConnection 类并添加到 Socket 连接列表 peers 中。</span>
                    <span class="token comment">// 接着将该 ZygoteConnection 的文件描述符添加到 fd 列表 fds 中，以便可以接收到 ActivityManagerService 发送过来的请求。</span>
                    <span class="token class-name">ZygoteConnection</span> newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    socketFDs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>zygoteServer.runSelectLoop(abiList) 持续等待进程来请求连接并 fork 出应用。</p> <p>至此 Zygote Socket 已经启动完毕了，该 Socket 会等待 AMS 进程发来的应用程序进程 fork。</p> <p>继续看看 SystemServer 是怎么被 fork 出来的 <code>forkSystemServer(abiList, zygoteSocketName, zygoteServer);</code>。</p> </li><li> <p><a href="http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java" rel="nofollow">forkSystemServer</a> 源码分析</p> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">,</span> <span class="token class-name">String</span> socketName<span class="token punctuation">,</span>
        <span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 创建 args 数组，这个数组用来保存启动 SystemServer 的启动参数，其中可以看出 SystemServer 进程的用户 id 和用户组 id 被设置为 1000。</span>
    <span class="token comment">// 并且拥有用户组 1001 ～ 1010,1018,1021,1023,1024,1032,1065,3001 ～ 3003,3005 ～ 3007,3009 ～ 3012 的权限，进程名为 system_server。</span>
    <span class="token comment">// 启动的类名为 com.android.server.SystemServer</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"--setuid=1000"</span><span class="token punctuation">,</span>
            <span class="token string">"--setgid=1000"</span><span class="token punctuation">,</span>
            <span class="token string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,"</span>
                    <span class="token operator">+</span> <span class="token string">"1024,1032,1065,3001,3002,3003,3005,3006,3007,3009,3010,3011,3012"</span><span class="token punctuation">,</span>
            <span class="token string">"--capabilities="</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>
            <span class="token string">"--nice-name=system_server"</span><span class="token punctuation">,</span>
            <span class="token string">"--runtime-args"</span><span class="token punctuation">,</span>
            <span class="token string">"--target-sdk-version="</span> <span class="token operator">+</span> <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token constant">SDK_VERSION_CUR_DEVELOPMENT</span><span class="token punctuation">,</span>
            <span class="token string">"com.android.server.SystemServer"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">;</span>

    <span class="token keyword">int</span> pid<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 通过 JNI 形式去调用 init 进程下的 fork 函数，派生出 systemServer 进程。</span>
        pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>
                parsedArgs<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGid<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mGids<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mRuntimeFlags<span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mPermittedCapabilities<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mEffectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// pid == 0 代表已经运行在子进程(SystemServer)上了。</span>
    <span class="token comment">// 代表 SystemServer 创建成功，创建成功后会关闭该 socket。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 销毁 zygoteServer，保留和 AMS 通信的 socket（runSelectLoop）。</span>
        <span class="token comment">// 当 SystemServer 创建过后，zygoteServerSocket 就没有用处了，进行关闭。</span>
        zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理 system server 进程初始化工作并启动 SystemServer 进程。</span>
        <span class="token comment">// 并启动了一个 binder 线程池供 system server 进程和其他进程通信使用。</span>
        <span class="token comment">// 最后调用 RuntimeInit.applicationInit() 执行进程启动自身初始化工作。</span>
        <span class="token comment">// applicationInit() 最后是通过反射调用了 SystemServer.java 中的 main() 方法。</span>
        <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p><code>Zygote.forkSystemServer</code> 就是调用了底层的 fork 函数。以上代码已知 SystemServer 子进程已经创建成功，将调用 handleSystemServerProcess 来启动 SystemServer.java 的入口。handleSystemServerProcess 会一直调用到 RuntimeInit.java 的 findStaticMain 方法中：</p> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span><span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">zygoteInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">applicationInit</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span> argv<span class="token punctuation">,</span>
            classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>java

<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <pre><code class="prism language-java">路径：<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>core<span class="token operator">/</span>java<span class="token operator">/</span>com<span class="token operator">/</span>android<span class="token operator">/</span>internal<span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span>java

<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>
        <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 反射拿到 SystemServer 类</span>
        cl <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 反射拿到 SystemServer.java 的 main 函数，并启动。</span>
        m <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>可以看到 handleSystemServerProcess 下面的子方法去调用了 com.android.server.SystemServer 的 main 方法，至此 SystemServer 就创建和启动完毕了，那么 SystemServer Socket 就会销毁并关闭。</p> </li></ol> 
<h3><a id="_620"></a>三、总结</h3> 
<p>Zygote 进程是从 init.rc 脚本中启动的。Zygote 进程本质上是一个服务端 Socket，它会一直运行，等待新的进程请求。在创建 Zygote 进程时，会携带 <code>StartSystemServer</code> 参数，这个参数会触发 Zygote 进程创建 <code>SystemServer</code> 子进程。<code>SystemServer</code> 进程是通过 Zygote 进程 fork 出来的，它的启动是由 <code>ZygoteInit</code> 通过反射的方式调用 <code>SystemServer</code> 的 <code>main</code> 方法实现的。</p> 
<p>Zygote 进程在启动时创建了一个服务端 Socket，这个 Socket 用于与 <code>SystemServer</code> 进程的通信。当 <code>SystemServer</code> 进程创建完成后，Zygote 进程会关闭与 <code>SystemServer</code> 进程的 Socket 连接。此时，Zygote 进程已经完成了它的主要任务，它会进入一个循环，等待 Activity Manager Service (AMS) 或其他进程来请求新的应用程序进程。这个循环是通过调用 <code>runSelectLoop</code> 方法实现的。</p> 
<p>请注意，Zygote 进程本身并不会关闭或销毁，它会一直运行，等待新的进程请求。而与 <code>SystemServer</code> 进程的 Socket 连接在 <code>SystemServer</code> 进程创建完成后就会关闭，因为此时已经没有必要维持这个连接了。</p> 
<h3><a id="_628"></a>参考</h3> 
<ul><li><a href="https://blog.csdn.net/q1210249579/article/details/128782204?spm=1001.2014.3001.5502">基于Android13的系统启动流程分析（五）之Zygote和SystemServer启动流程</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5b3f1c10e8a2e54f1f28e12c1e52a3e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SD(Stable Diffusion) 简易教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5fbc968098491f55002aa49cdb34cef0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">通义千文大模型API调用示例(python)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>