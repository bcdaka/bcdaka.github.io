<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android网络抓包--Charles - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d3d284c47fa4eb041f125b15f1b0d897/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android网络抓包--Charles">
  <meta property="og:description" content="一、Android抓包方式 对Https降级进行抓包，降级成Http使用抓包工具对Https进行抓包 二、常用的抓包工具 wireshark：侧重于TCP、UDP传输层，HTTP/HTTPS也能抓包，但不能解密HTTPS报文。比较复杂fiddler：支持HTTP/HTTPS协议，篡改请求入参，篡改响应效据，设置请求断点重发，弱网模拟。但是只支持Windowcharles：基本功能跟fiddler一样。并且所有平台都支持，界面简洁，操作简单（重点） 三、抓包工具Charles 1.下载： 官网地址：Download a Free Trial of Charles • Charles Web Debugging Proxy
2.安装： 下载完成之后，直接点击安装即可。安装完成之后的界面
3.原理： 网络编程Http知识
拦截请求，代理客户端向服务端发送请求拦截服务端响应，拿到服务端返回的公钥，并返回自己的公钥证书，目的是为了接下来的流程中加密会话秘钥客户端需要安装charies证书，并添加信任，否则会报证书无效错误；客户端生成会话秘钥，并使用charies公钥加密发送到服务端再次拦截请求，用自己的私钥解密会话秘钥，并使用前面拿到服务端公钥加密会话秘钥发送到服务端服务端使用自己的私钥解密会话秘钥使用会话秘钥去加密response，并返回charies再次拦截响应，使用会话秘钥去解密response，展示明文，从而达到https抓包的日志 4.证书配置 注意： 在使用6.0及以下的手机的时候，如果想要抓包Https，只需要在手机上安装Charles证书就可以了，但是如果使用的手机是7.0及以上版本的时候，这个时候就不管用了，需要手动的添加该证书的信任
原因： 因为Android在不同的版本，系统为了网络安全，网络配置发生了一些变化
系统的网络安全配置： Android6.0及以下既支持信任系统证书，也支持信任用户安装的证书，也运行明文传输 &lt;base-config cleartextTrafficPermitted=&#34;true&#34;&gt; &lt;trust-anchors&gt; &lt;certificates src=&#34;system&#34; /&gt; &lt;certificates src=&#34;user&#34; /&gt; &lt;/trust-anchors&gt; &lt;/base-config&gt; 在Android7.0及以上，不在信任用户安装的证书。这也就是为什么7.0以上的手机即便安装了charles证书，依旧无法抓包的原因 &lt;base-config cleartextTrafficPermitted=&#34;true&#34;&gt; &lt;trust-anchors&gt; &lt;certificates src=&#34;system&#34; /&gt; &lt;/trust-anchors&gt; &lt;/base-config&gt; 在android9.0及以上，只信任系统证书，并且不允许明文http的传输 &lt;base-config cleartextTrafficPermitted=&#34;false&#34;&gt; &lt;trust-anchors&gt; &lt;certificates src=&#34;system&#34; /&gt; &lt;/trust-anchors&gt; &lt;/base-config&gt; 解决方案： 为了解决Android7.0及以上手机https无法抓包，http无法传输的问题，需要自定义网络安全配置：
在res/raw目录下，添加charles的证书文件charles.pem新增文件 res/xml/network_security_config.xml 文件，将cleartextTrafficPermitted设置成true，并增加trust-anchors标签引用添加进来的charles的证书 cleartextTrafficPermitted=&#34;true&#34; //允许在高版本上开启Http的明文传
&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; &lt;network-security-config&gt; &lt;base-config cleartextTrafficPermitted=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-12T20:31:27+08:00">
    <meta property="article:modified_time" content="2024-04-12T20:31:27+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android网络抓包--Charles</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、Android抓包方式</h2> 
<ol><li>对Https降级进行抓包，降级成Http</li><li>使用抓包工具对Https进行抓包</li></ol> 
<h2>二、常用的抓包工具</h2> 
<ul><li>wireshark：侧重于TCP、UDP传输层，HTTP/HTTPS也能抓包，但不能解密HTTPS报文。比较复杂</li><li>fiddler：支持HTTP/HTTPS协议，篡改请求入参，篡改响应效据，设置请求断点重发，弱网模拟。但是只支持Window</li><li>charles：基本功能跟fiddler一样。并且所有平台都支持，界面简洁，操作简单（<strong>重点</strong>）</li></ul> 
<h2>三、抓包工具Charles</h2> 
<h3>1.下载：</h3> 
<p>官网地址：<a href="https://www.charlesproxy.com/download/" rel="nofollow" title="Download a Free Trial of Charles • Charles Web Debugging Proxy">Download a Free Trial of Charles • Charles Web Debugging Proxy</a></p> 
<h3>2.安装：</h3> 
<p>下载完成之后，直接点击安装即可。安装完成之后的界面</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/0a/7c/2XroUxM5_o.png" width="1200"></p> 
<h3>3.原理：</h3> 
<p><a class="link-info" href="https://blog.csdn.net/weixin_42277946/article/details/134797973" title="网络编程Http知识">网络编程Http知识</a></p> 
<ol><li>拦截请求，代理客户端向服务端发送请求</li><li>拦截服务端响应，拿到服务端返回的公钥，并返回自己的公钥证书，目的是为了接下来的流程中加密会话秘钥</li><li>客户端需要安装charies证书，并添加信任，否则会报证书无效错误；客户端生成会话秘钥，并使用charies公钥加密发送到服务端</li><li>再次拦截请求，用自己的私钥解密会话秘钥，并使用前面拿到服务端公钥加密会话秘钥发送到服务端</li><li>服务端使用自己的私钥解密会话秘钥</li><li>使用会话秘钥去加密response，并返回</li><li>charies再次拦截响应，使用会话秘钥去解密response，展示明文，从而达到https抓包的日志</li></ol> 
<p><img alt="" height="1140" src="https://images2.imgbox.com/9c/05/2x4zMyPC_o.png" width="1200"></p> 
<h3>4.证书配置</h3> 
<h4><strong>注意：</strong></h4> 
<p>        在使用6.0及以下的手机的时候，如果想要抓包Https，只需要在手机上安装Charles证书就可以了，但是如果使用的手机是7.0及以上版本的时候，这个时候就不管用了，需要手动的添加该证书的信任</p> 
<h4><strong>原因：</strong></h4> 
<p>        因为Android在不同的版本，系统为了网络安全，网络配置发生了一些变化</p> 
<h4><strong>系统的网络安全配置：</strong></h4> 
<ul><li>Android6.0及以下既支持信任系统证书，也支持信任用户安装的证书，也运行明文传输</li></ul> 
<pre><code class="language-XML">&lt;base-config cleartextTrafficPermitted="true"&gt;
    &lt;trust-anchors&gt;
        &lt;certificates src="system" /&gt;
        &lt;certificates src="user" /&gt;
    &lt;/trust-anchors&gt;
&lt;/base-config&gt;</code></pre> 
<ul><li>在Android7.0及以上，不在信任用户安装的证书。这也就是为什么7.0以上的手机即便安装了charles证书，依旧无法抓包的原因</li></ul> 
<pre><code class="language-XML">&lt;base-config cleartextTrafficPermitted="true"&gt;
    &lt;trust-anchors&gt;
        &lt;certificates src="system" /&gt;
    &lt;/trust-anchors&gt;
&lt;/base-config&gt;</code></pre> 
<ul><li>在android9.0及以上，只信任系统证书，并且不允许明文http的传输</li></ul> 
<pre><code class="language-XML">&lt;base-config cleartextTrafficPermitted="false"&gt;
    &lt;trust-anchors&gt;
        &lt;certificates src="system" /&gt;
    &lt;/trust-anchors&gt;
&lt;/base-config&gt;</code></pre> 
<h4><strong>解决方案：</strong></h4> 
<p>        为了解决Android7.0及以上手机https无法抓包，http无法传输的问题，需要自定义网络安全配置：</p> 
<ul><li>在res/raw目录下，添加charles的证书文件charles.pem</li><li>新增文件 res/xml/network_security_config.xml 文件，将<strong>cleartextTrafficPermitted</strong>设置成true，并增加trust-anchors标签引用添加进来的charles的证书</li></ul> 
<blockquote> 
 <p><strong> cleartextTrafficPermitted="true"  </strong>//允许在高版本上开启Http的明文传</p> 
</blockquote> 
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;network-security-config&gt;
    &lt;base-config cleartextTrafficPermitted="true"/&gt;
    &lt;trust-anchors&gt;
        &lt;certificates src="@raw/charles"/&gt;
    &lt;/trust-anchors&gt;
&lt;/network-security-config&gt;</code></pre> 
<ul><li>在清单文件manifest中的Application下添加网络安全配置文件，这样就能抓包了</li></ul> 
<pre><code class="language-XML">&lt;application
    android:networkSecurityConfig="@xml/network_security_config"
&lt;/application&gt;  
</code></pre> 
<ul><li>增加debug-overrides标签，只在debuggable为true的情况下，才会应用这个网络安全配置文件</li></ul> 
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;network-security-config&gt;
    &lt;base-config cleartextTrafficPermitted="true" /&gt;
    &lt;debug-overrides&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src="@raw/charles" /&gt;
        &lt;/trust-anchors&gt;
    &lt;/debug-overrides&gt;
&lt;/network-security-config&gt;</code></pre> 
<h3>5.使用：</h3> 
<p>如何配置charles，完成Https数据报文的抓包？</p> 
<p>1.点击Proxy -&gt; Proxy Settings…，查看charles的端口号：8888</p> 
<p><img alt="" height="305" src="https://images2.imgbox.com/d1/3a/pXlSRUjQ_o.png" width="328"><img alt="" height="305" src="https://images2.imgbox.com/27/89/oFa20wdF_o.png" width="346"></p> 
<p>2.点击Help -&gt; Local IP Address，查看本机的IP地址：192.168.40.38</p> 
<p><img alt="" height="283" src="https://images2.imgbox.com/14/30/nGhhCYEW_o.png" width="305"><img alt="" height="231" src="https://images2.imgbox.com/ea/1c/bTkjfd1L_o.png" width="376"></p> 
<p></p> 
<p>3.将手机wifi连接的代理设置成手动，并输入上面的端口号和IP地址</p> 
<p><img alt="" height="694" src="https://images2.imgbox.com/3b/79/kCXbt9PT_o.png" width="321"><img alt="" height="696" src="https://images2.imgbox.com/c3/b1/TxQCVPdo_o.png" width="326"></p> 
<p>4.让应用去信任charles证书</p> 
<p>点击Help -&gt; SSL Proxying -&gt; Save Charles Root Certificate… 保存证书</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/56/9e/IrdJT3y1_o.png" width="1200"></p> 
<p>5.将证书拷贝到项目中。在app下的res目录下新建一个raw文件夹，并且把charles.pem文件拷贝过来</p> 
<p><img alt="" height="676" src="https://images2.imgbox.com/0d/71/7zq2zDpY_o.png" width="562"></p> 
<p>6.创建配置文件。在app下的res目录下新建一个xml文件夹，在这个文件夹下新建一个network_security_config.xml 文件，并填写配置信息</p> 
<p><img alt="" height="846" src="https://images2.imgbox.com/b5/46/8SE5ISb3_o.png" width="1200"></p> 
<p></p> 
<p>打开手机设置-密码与安全-系统安全-加密与凭据-安装证书-证书</p> 
<p>然后将上面保存的证书push到手机上，找到位置添加证书信任</p> 
<p></p> 
<p><img alt="" height="134" src="https://images2.imgbox.com/ba/f2/XYussXcZ_o.png" width="652"></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5ed810183e62e5fd1febc631417aa3b7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python自动化办公：提升效率，释放潜力（借助AI实现）_学习python实现办公自动化的技能可以培养什么能力</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5c093a155b9ba0c317ecb549f152d620/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【行业洞察】AIGC证书到底有用吗？费用、认证流程全解析！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>