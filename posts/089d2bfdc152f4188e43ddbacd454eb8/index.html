<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LLaMA-Factory 8卡4090 deepspeed zero3 微调Qwen14B-chat - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/089d2bfdc152f4188e43ddbacd454eb8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="LLaMA-Factory 8卡4090 deepspeed zero3 微调Qwen14B-chat">
  <meta property="og:description" content="环境安装 推荐使用docker，Ubuntu20.04
https://www.modelscope.cn/docs/%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85
docker pull registry.cn-beijing.aliyuncs.com/modelscope-repo/modelscope:ubuntu22.04-cuda12.1.0-py310-torch2.1.2-tf2.14.0-1.12.0 下载模型 在modelscope主页，找到模型
https://modelscope.cn/models/qwen/Qwen-14B-Chat/summary
可以使用如下脚本
import os from modelscope import snapshot_download # cache_dir 指定你的保存模型的路径 model_dir = snapshot_download(&#39;qwen/Qwen-14B-Chat&#39;,cache_dir=&#34;/workspace/models/AI-ModelScope&#34;) 微调 使用LLaMA-Factory，
下载下面仓库的代码，
https://github.com/hiyouga/LLaMA-Factory
在代码目录，新建一个脚本 run_train_bash.sh
CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7 accelerate launch src/train_bash.py \ --deepspeed ds_config_zero3.json \ --stage sft \ --do_train True \ --model_name_or_path /workspace/models/AI-ModelScope/qwen/Qwen-14B-Chat/ \ --finetuning_type lora \ --template qwen \ --dataset_dir data \ --dataset lhs_merged_data \ --cutoff_len 1024 \ --learning_rate 5e-04 \ --num_train_epochs 3 \ --max_samples 100000 \ --per_device_train_batch_size 4 \ --gradient_accumulation_steps 4 \ --lr_scheduler_type cosine \ --max_grad_norm 1.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-27T17:00:01+08:00">
    <meta property="article:modified_time" content="2024-02-27T17:00:01+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LLaMA-Factory 8卡4090 deepspeed zero3 微调Qwen14B-chat</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/ed/ff/1nlGYYaL_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="_3"></a>环境安装</h4> 
<p>推荐使用docker，Ubuntu20.04<br> <a href="https://www.modelscope.cn/docs/%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85" rel="nofollow">https://www.modelscope.cn/docs/%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85</a></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull registry.cn-beijing.aliyuncs.com/modelscope-repo/modelscope:ubuntu22.04-cuda12.1.0-py310-torch2.1.2-tf2.14.0-1.12.0
</code></pre> 
<h4><a id="_10"></a>下载模型</h4> 
<p>在modelscope主页，找到模型<br> <a href="https://modelscope.cn/models/qwen/Qwen-14B-Chat/summary" rel="nofollow">https://modelscope.cn/models/qwen/Qwen-14B-Chat/summary</a></p> 
<p>可以使用如下脚本</p> 
<pre><code class="prism language-bash"><span class="token function">import</span> os
from modelscope <span class="token function">import</span> snapshot_download

<span class="token comment"># cache_dir 指定你的保存模型的路径</span>
model_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'qwen/Qwen-14B-Chat'</span>,cache_dir<span class="token operator">=</span><span class="token string">"/workspace/models/AI-ModelScope"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_24"></a>微调</h4> 
<p>使用LLaMA-Factory，<br> 下载下面仓库的代码，<br> <a href="https://github.com/hiyouga/LLaMA-Factory">https://github.com/hiyouga/LLaMA-Factory</a></p> 
<p>在代码目录，新建一个脚本 run_train_bash.sh</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">CUDA_VISIBLE_DEVICES</span><span class="token operator">=</span><span class="token number">0,1</span>,2,3,4,5,6,7 accelerate launch  src/train_bash.py <span class="token punctuation">\</span>
    <span class="token parameter variable">--deepspeed</span> ds_config_zero3.json <span class="token punctuation">\</span>
    <span class="token parameter variable">--stage</span> sft <span class="token punctuation">\</span>
    <span class="token parameter variable">--do_train</span> True <span class="token punctuation">\</span>
    <span class="token parameter variable">--model_name_or_path</span> /workspace/models/AI-ModelScope/qwen/Qwen-14B-Chat/ <span class="token punctuation">\</span>
    <span class="token parameter variable">--finetuning_type</span> lora <span class="token punctuation">\</span>
    <span class="token parameter variable">--template</span> qwen <span class="token punctuation">\</span>
    <span class="token parameter variable">--dataset_dir</span> data <span class="token punctuation">\</span>
    <span class="token parameter variable">--dataset</span> lhs_merged_data <span class="token punctuation">\</span>
    <span class="token parameter variable">--cutoff_len</span> <span class="token number">1024</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--learning_rate</span> 5e-04 <span class="token punctuation">\</span>
    <span class="token parameter variable">--num_train_epochs</span> <span class="token number">3</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--max_samples</span> <span class="token number">100000</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--per_device_train_batch_size</span> <span class="token number">4</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--gradient_accumulation_steps</span> <span class="token number">4</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lr_scheduler_type</span> cosine <span class="token punctuation">\</span>
    <span class="token parameter variable">--max_grad_norm</span> <span class="token number">1.0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--logging_steps</span> <span class="token number">5</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--save_steps</span> <span class="token number">100</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--warmup_steps</span> <span class="token number">0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--neftune_noise_alpha</span> <span class="token number">0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_rank</span> <span class="token number">8</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_dropout</span> <span class="token number">0.1</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_target</span>  c_attn <span class="token punctuation">\</span>
    <span class="token parameter variable">--output_dir</span> output/qwen_14b_ds/train_2024_02_27 <span class="token punctuation">\</span>
    <span class="token parameter variable">--bf16</span> True <span class="token punctuation">\</span>
    <span class="token parameter variable">--plot_loss</span> True
</code></pre> 
<p>另外，还需要新建一个deepspeed的配置文件，这里使用qwen官方给的例子，新建一个ds_config_zero3.json<br> <a href="https://github.com/QwenLM/Qwen/blob/main/finetune/ds_config_zero3.json">https://github.com/QwenLM/Qwen/blob/main/finetune/ds_config_zero3.json</a></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"fp16"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"enabled"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"loss_scale"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string-property property">"loss_scale_window"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token string-property property">"initial_scale_power"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token string-property property">"hysteresis"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string-property property">"min_loss_scale"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"bf16"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"enabled"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"optimizer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"AdamW"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"lr"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"betas"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"eps"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"weight_decay"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string-property property">"scheduler"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"WarmupLR"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"warmup_min_lr"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"warmup_max_lr"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"warmup_num_steps"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string-property property">"zero_optimization"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"stage"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string-property property">"offload_optimizer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"device"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"pin_memory"</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"offload_param"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"device"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"pin_memory"</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"overlap_comm"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">"contiguous_gradients"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">"sub_group_size"</span><span class="token operator">:</span> <span class="token number">1e9</span><span class="token punctuation">,</span>
        <span class="token string-property property">"reduce_bucket_size"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"stage3_prefetch_bucket_size"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"stage3_param_persistence_threshold"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"stage3_max_live_parameters"</span><span class="token operator">:</span> <span class="token number">1e9</span><span class="token punctuation">,</span>
        <span class="token string-property property">"stage3_max_reuse_distance"</span><span class="token operator">:</span> <span class="token number">1e9</span><span class="token punctuation">,</span>
        <span class="token string-property property">"stage3_gather_16bit_weights_on_model_save"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token string-property property">"gradient_accumulation_steps"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"gradient_clipping"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"steps_per_print"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token string-property property">"train_batch_size"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"train_micro_batch_size_per_gpu"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"wall_clock_breakdown"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体的代码路径如下：</p> 
<p>ds_config_zero3.json<br> <img src="https://images2.imgbox.com/15/90/yMNozsNP_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_129"></a>运行</h4> 
<p>直接在终端输入即可，缺什么包，再安装对应的包就可以了。</p> 
<pre><code class="prism language-bash"><span class="token function">bash</span> run_train_bash.sh
</code></pre> 
<h4><a id="_137"></a>合并权重</h4> 
<p>训练完成后，按照LLaMA-Factory readme中提到的合并权重命令进行合并即可，自行修改其中的路径参数<br> <a href="https://github.com/hiyouga/LLaMA-Factory?tab=readme-ov-file#merge-lora-weights-and-export-model">https://github.com/hiyouga/LLaMA-Factory?tab=readme-ov-file#merge-lora-weights-and-export-model</a></p> 
<pre><code class="prism language-bash">python src/export_model.py <span class="token punctuation">\</span>
    <span class="token parameter variable">--model_name_or_path</span> path_to_llama_model <span class="token punctuation">\</span>
    <span class="token parameter variable">--adapter_name_or_path</span> path_to_checkpoint <span class="token punctuation">\</span>
    <span class="token parameter variable">--template</span> default <span class="token punctuation">\</span>
    <span class="token parameter variable">--finetuning_type</span> lora <span class="token punctuation">\</span>
    <span class="token parameter variable">--export_dir</span> path_to_export <span class="token punctuation">\</span>
    <span class="token parameter variable">--export_size</span> <span class="token number">2</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--export_legacy_format</span> False
</code></pre> 
<p>最后，可以使用加载模型测试微调结果。</p> 
<p>显存占用：<br> <img src="https://images2.imgbox.com/52/bf/YOuJbaDh_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a33dfb9f13e19be52004ca1e8ce70e09/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JAVA PDF 给PDF添加文字/图片水印（指定内容），并且设置位置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5415d3a950669332ccbede8d75163b1c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Kafka安全模式之身份认证</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>