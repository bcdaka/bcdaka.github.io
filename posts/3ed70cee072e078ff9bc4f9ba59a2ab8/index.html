<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据仓库实践：使用 SQL 计算材料BOM成本单价 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3ed70cee072e078ff9bc4f9ba59a2ab8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="数据仓库实践：使用 SQL 计算材料BOM成本单价">
  <meta property="og:description" content="背景 在制造业财务数据分析建设过程中，有时需要通过BOM汇总计算材料的单价，一般会有采购核价，库存成本，还有下阶材料单价按用量汇总得到的单价参与。
这些单价来源一般会根据优先级获取并在计算后作为最终的BOM 单价结果。参与财务三大报表中的损益表计算。
获取数据：采购核价、币种和汇率 采购核价 核价一般会包括成品和底层材料，而且优先级一般会比较高，所以这里直接使用核价的方式设置一个成品的单价，以用于测试。
库存成本 除了采购核价外，库存成本一般是覆盖范围比较广的单价，能够覆盖到最底层的大量材料料号。
这里我们在初始化时设置最底层材料成本时，将使用库存成本金额。
币种 为了兼容多个货币和地区，价格会有一个字段表示币种。金额则是此币种的单价金额。
同时需要带上一个汇率明细。以满足各个币种单价金额的汇算。
获取数据：BOM汇总结构 初始化时使用核价和成本单间仍然不能完全覆盖企业内使用的所有的材料，尤其是BOM结构复杂、材料料号过多的情况下。
所以一般情况下，企业会使用BOM关系，将材料的单价汇总计算到上阶材料。
本文将使用 bom 结构重新汇总后的BOM数据分析维度，具体可见：
数据仓库实践：使用SQL汇总BOM数据分析维度 http://t.csdnimg.cn/gZ1pS
部分 dim_bom 结构
初始化 使用BOM关联并计算核价和成本单价
insert into dw_mt_bom_unit_price_mview(material_code_prod, material_code, currency_cost, price_cost_ori, price_cost, currency_verify, price_verify_ori, price_verify, price_calculate) select * from (with tmp_prod as (select material_code material_code_prod, material_code, null currency_cost, null as price_cost_ori, null as price_cost, c.currency_verify, c.price_verify as price_verify_ori, d.exchange_rate * IFNULL(c.price_verify, 0) as price_verify, null price_calculate from (select distinct bom_subordinate.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-19T08:00:00+08:00">
    <meta property="article:modified_time" content="2024-07-19T08:00:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据仓库实践：使用 SQL 计算材料BOM成本单价</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>背景</h3> 
<p>在制造业财务数据分析建设过程中，有时需要通过BOM汇总计算材料的单价，一般会有采购核价，库存成本，还有下阶材料单价按用量汇总得到的单价参与。</p> 
<p>这些单价来源一般会根据优先级获取并在计算后作为最终的BOM 单价结果。参与财务三大报表中的损益表计算。</p> 
<h3><a id="_7"></a>获取数据：采购核价、币种和汇率</h3> 
<h4><a id="_9"></a>采购核价</h4> 
<p>核价一般会包括成品和底层材料，而且优先级一般会比较高，所以这里直接使用核价的方式设置一个成品的单价，以用于测试。</p> 
<p><img src="https://images2.imgbox.com/38/ab/bUkul33j_o.png" alt="采购核价"></p> 
<h4><a id="_16"></a>库存成本</h4> 
<p>除了采购核价外，库存成本一般是覆盖范围比较广的单价，能够覆盖到最底层的大量材料料号。</p> 
<p>这里我们在初始化时设置最底层材料成本时，将使用库存成本金额。</p> 
<p><img src="https://images2.imgbox.com/01/79/BDqUVwiV_o.png" alt="库存成本"></p> 
<h4><a id="_25"></a>币种</h4> 
<p>为了兼容多个货币和地区，价格会有一个字段表示币种。金额则是此币种的单价金额。</p> 
<p>同时需要带上一个汇率明细。以满足各个币种单价金额的汇算。</p> 
<p><img src="https://images2.imgbox.com/2c/00/tvhwbPNk_o.png" alt="币种汇率"></p> 
<h3><a id="BOM_34"></a>获取数据：BOM汇总结构</h3> 
<p>初始化时使用核价和成本单间仍然不能完全覆盖企业内使用的所有的材料，尤其是BOM结构复杂、材料料号过多的情况下。</p> 
<p>所以一般情况下，企业会使用BOM关系，将材料的单价汇总计算到上阶材料。</p> 
<p>本文将使用 bom 结构重新汇总后的BOM数据分析维度，具体可见：</p> 
<p><a href="http://t.csdnimg.cn/gZ1pS" rel="nofollow">数据仓库实践：使用SQL汇总BOM数据分析维度 http://t.csdnimg.cn/gZ1pS</a></p> 
<p>部分 dim_bom 结构</p> 
<p><img src="https://images2.imgbox.com/5b/28/beawYibr_o.png" alt="部分BOM"></p> 
<h3><a id="_49"></a>初始化</h3> 
<p>使用BOM关联并计算核价和成本单价</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> dw_mt_bom_unit_price_mview<span class="token punctuation">(</span>material_code_prod<span class="token punctuation">,</span>
                                       material_code<span class="token punctuation">,</span>
                                       currency_cost<span class="token punctuation">,</span>
                                       price_cost_ori<span class="token punctuation">,</span>
                                       price_cost<span class="token punctuation">,</span>
                                       currency_verify<span class="token punctuation">,</span>
                                       price_verify_ori<span class="token punctuation">,</span>
                                       price_verify<span class="token punctuation">,</span>
                                       price_calculate<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">with</span> tmp_prod <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code                                  material_code_prod<span class="token punctuation">,</span>
                               material_code<span class="token punctuation">,</span>
                               <span class="token boolean">null</span>                                           currency_cost<span class="token punctuation">,</span>
                               <span class="token boolean">null</span>                                        <span class="token keyword">as</span> price_cost_ori<span class="token punctuation">,</span>
                               <span class="token boolean">null</span>                                        <span class="token keyword">as</span> price_cost<span class="token punctuation">,</span>

                               c<span class="token punctuation">.</span>currency_verify<span class="token punctuation">,</span>
                               c<span class="token punctuation">.</span>price_verify                              <span class="token keyword">as</span> price_verify_ori<span class="token punctuation">,</span>
                               d<span class="token punctuation">.</span>exchange_rate <span class="token operator">*</span> IFNULL<span class="token punctuation">(</span>c<span class="token punctuation">.</span>price_verify<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> price_verify<span class="token punctuation">,</span>
                               <span class="token boolean">null</span>                                           price_calculate
                        <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token keyword">as</span> material_code
                              <span class="token comment"># BOM 中只在 product_code 字段存在 不在 material_code 存在代表 该物料没有上阶物料 推断出本身是成品</span>
                              <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code
                                    <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_subordinate
                                       <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code
                                                  <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_superior
                                                 <span class="token keyword">on</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token operator">=</span> bom_superior<span class="token punctuation">.</span>material_code
                              <span class="token keyword">where</span> bom_superior<span class="token punctuation">.</span>material_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                 <span class="token comment"># 采购核价</span>
                                 <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                  currency      currency_verify<span class="token punctuation">,</span>
                                                  amount_price  price_verify
                                           <span class="token keyword">FROM</span> clip_ods<span class="token punctuation">.</span>price_verify<span class="token punctuation">)</span> c
                                          <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> c<span class="token punctuation">.</span>mat_code
                            <span class="token comment"># 汇率</span>
                                 <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                   exchange_rate
                                            <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                            <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> d
                                           <span class="token keyword">on</span> c<span class="token punctuation">.</span>currency_verify <span class="token operator">=</span> d<span class="token punctuation">.</span>currency_transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>

           tmp_mat <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code                                                                 material_code_prod<span class="token punctuation">,</span>
                              material_code<span class="token punctuation">,</span>

                              currency_cost<span class="token punctuation">,</span>
                              price_cost                                                                <span class="token keyword">as</span> price_cost_ori<span class="token punctuation">,</span>
                              <span class="token keyword">case</span> <span class="token keyword">when</span> price_cost <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span> <span class="token keyword">as</span> price_cost<span class="token punctuation">,</span>

                              currency_verify<span class="token punctuation">,</span>
                              price_verify                                                              <span class="token keyword">as</span> price_verify_ori<span class="token punctuation">,</span>
                              <span class="token keyword">case</span>
                                  <span class="token keyword">when</span> price_verify <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span>
                                  <span class="token keyword">else</span> price_verify <span class="token operator">*</span> d<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span>                               <span class="token keyword">as</span> price_verify<span class="token punctuation">,</span>

                              <span class="token keyword">case</span>
                                  <span class="token keyword">when</span> price_cost <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate
                                  <span class="token keyword">when</span> price_verify <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> price_verify <span class="token operator">*</span> d<span class="token punctuation">.</span>exchange_rate
                                  <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span>                                                               price_calculate
                       <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>product_code<span class="token punctuation">,</span>
                                    a<span class="token punctuation">.</span>material_code
                             <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> bom_superior<span class="token punctuation">.</span>product_code<span class="token punctuation">,</span>
                                                   bom_superior<span class="token punctuation">.</span>material_code
                                   <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code<span class="token punctuation">,</span>
                                                material_code
                                         <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_superior
                                            <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code
                                                       <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_subordinate
                                                      <span class="token keyword">on</span> bom_superior<span class="token punctuation">.</span>material_code <span class="token operator">=</span> bom_subordinate<span class="token punctuation">.</span>product_code
                                   <span class="token keyword">where</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                      <span class="token keyword">inner</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> bom_subordinate<span class="token punctuation">.</span>product_code prod_code
                                                 <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code
                                                       <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_subordinate
                                                          <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code
                                                                     <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_superior
                                                                    <span class="token keyword">on</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token operator">=</span> bom_superior<span class="token punctuation">.</span>material_code
                                                 <span class="token keyword">where</span> bom_superior<span class="token punctuation">.</span>material_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> b
                                                <span class="token keyword">on</span> a<span class="token punctuation">.</span>product_code <span class="token operator">=</span> b<span class="token punctuation">.</span>prod_code<span class="token punctuation">)</span> a
                                <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                 currency      currency_cost<span class="token punctuation">,</span>
                                                 <span class="token comment"># 库存成本</span>
                                                 amount_price  price_cost
                                          <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>price_cost<span class="token punctuation">)</span> b
                                         <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>mat_code
                                <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                 currency      currency_verify<span class="token punctuation">,</span>
                                                 <span class="token comment"># 核价</span>
                                                 amount_price  price_verify
                                          <span class="token keyword">FROM</span> clip_ods<span class="token punctuation">.</span>price_verify<span class="token punctuation">)</span> c
                                         <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> c<span class="token punctuation">.</span>mat_code
                                <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                  exchange_rate
                                           <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                           <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> d
                                          <span class="token keyword">on</span> c<span class="token punctuation">.</span>currency_verify <span class="token operator">=</span> d<span class="token punctuation">.</span>currency_transaction
                                <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                  exchange_rate
                                           <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                           <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> e
                                          <span class="token keyword">on</span> b<span class="token punctuation">.</span>currency_cost <span class="token operator">=</span> e<span class="token punctuation">.</span>currency_transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>

           tmp_semi <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> productid                                                                    material_code_prod<span class="token punctuation">,</span>
                               material_code<span class="token punctuation">,</span>
                               currency_cost<span class="token punctuation">,</span>
                               price_cost                                                                <span class="token keyword">as</span> price_cost_ori<span class="token punctuation">,</span>
                               <span class="token keyword">case</span> <span class="token keyword">when</span> price_cost <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span> <span class="token keyword">as</span> price_cost<span class="token punctuation">,</span>

                               currency_verify<span class="token punctuation">,</span>
                               price_verify                                                              <span class="token keyword">as</span> price_verify_ori<span class="token punctuation">,</span>
                               <span class="token keyword">case</span>
                                   <span class="token keyword">when</span> price_verify <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span>
                                   <span class="token keyword">else</span> price_verify <span class="token operator">*</span> d<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span>                               <span class="token keyword">as</span> price_verify<span class="token punctuation">,</span>

                               price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate                                                 price_calculate
                        <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>productid<span class="token punctuation">,</span>
                                     a<span class="token punctuation">.</span>material_code
                              <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> b<span class="token punctuation">.</span>productid<span class="token punctuation">,</span>
                                           b<span class="token punctuation">.</span>material_code
                                    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>productid
                                          <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code productid
                                                <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> a
                                                   <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code subprodid
                                                              <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> b
                                                             <span class="token keyword">on</span> a<span class="token punctuation">.</span>productid <span class="token operator">=</span> b<span class="token punctuation">.</span>subprodid
                                          <span class="token keyword">where</span> b<span class="token punctuation">.</span>subprodid <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                             <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> product_code productid<span class="token punctuation">,</span>
                                                                         material_code
                                                         <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> b
                                                        <span class="token keyword">on</span> a<span class="token punctuation">.</span>productid <span class="token operator">=</span> b<span class="token punctuation">.</span>productid<span class="token punctuation">)</span> a
                                       <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                                                         material_code
                                                  <span class="token keyword">from</span> tmp_mat
                                                  <span class="token keyword">where</span> price_calculate <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">)</span> b
                                                 <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code
                                                     <span class="token operator">and</span> a<span class="token punctuation">.</span>productid <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code_prod
                              <span class="token keyword">where</span> b<span class="token punctuation">.</span>material_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                 <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                  currency      currency_cost<span class="token punctuation">,</span>
                                                  <span class="token comment"># 库存成本</span>
                                                  amount_price  price_cost
                                           <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>price_cost<span class="token punctuation">)</span> b
                                          <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>mat_code
                                 <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                  currency      currency_verify<span class="token punctuation">,</span>
                                                  <span class="token comment"># 核价</span>
                                                  amount_price  price_verify
                                           <span class="token keyword">FROM</span> clip_ods<span class="token punctuation">.</span>price_verify<span class="token punctuation">)</span> c
                                          <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> c<span class="token punctuation">.</span>mat_code
                                 <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                   exchange_rate
                                            <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                            <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> d
                                           <span class="token keyword">on</span> c<span class="token punctuation">.</span>currency_verify <span class="token operator">=</span> d<span class="token punctuation">.</span>currency_transaction
                                 <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                   exchange_rate
                                            <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                            <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> e
                                           <span class="token keyword">on</span> b<span class="token punctuation">.</span>currency_cost <span class="token operator">=</span> e<span class="token punctuation">.</span>currency_transaction<span class="token punctuation">)</span>


      <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
             material_code<span class="token punctuation">,</span>
             currency_cost<span class="token punctuation">,</span>
             price_cost_ori<span class="token punctuation">,</span>
             price_cost<span class="token punctuation">,</span>
             currency_verify<span class="token punctuation">,</span>
             price_verify_ori<span class="token punctuation">,</span>
             price_verify<span class="token punctuation">,</span>
             price_calculate
      <span class="token keyword">from</span> tmp_prod
      <span class="token keyword">union</span>
      <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
             material_code<span class="token punctuation">,</span>
             currency_cost<span class="token punctuation">,</span>
             price_cost_ori<span class="token punctuation">,</span>
             price_cost<span class="token punctuation">,</span>
             currency_verify<span class="token punctuation">,</span>
             price_verify_ori<span class="token punctuation">,</span>
             price_verify<span class="token punctuation">,</span>
             price_calculate
      <span class="token keyword">from</span> tmp_mat
      <span class="token keyword">union</span>
      <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
             material_code<span class="token punctuation">,</span>
             currency_cost<span class="token punctuation">,</span>
             price_cost_ori<span class="token punctuation">,</span>
             price_cost<span class="token punctuation">,</span>
             currency_verify<span class="token punctuation">,</span>
             price_verify_ori<span class="token punctuation">,</span>
             price_verify<span class="token punctuation">,</span>
             price_calculate
      <span class="token keyword">from</span> tmp_semi<span class="token punctuation">)</span> initial_tmp
</code></pre> 
<h3><a id="BOM_247"></a>按BOM结构汇总</h3> 
<p>从最底层材料向上汇总，这里需要保证所有的最底层材料都有初始化后的单价，即使单价值为0；</p> 
<p>因为如果下阶材料单价为空（Null）, 系统将无法判断此空值（Null）是否有意义，</p> 
<p>而且，系统和开发人员所处的角色自身没有权限决定【单价为空时设置为0】，因为有可能这个单价另有其他来源。</p> 
<p>如果财务相关对接人员有确定为空时单价设置为0，则应该在初始化时设置为0；</p> 
<p>同时【下阶材料单价为空时不汇总】这一操作会在递归汇总中作为判断【该材料的下阶材料是否在之前的递归过程中计算完成】的标准；</p> 
<p>最底层材料为空则会导致此材料所有的上阶材料【等待此材料计算出单价值后参与上阶材料的计算】；</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> dw_mt_bom_unit_price_mview<span class="token punctuation">(</span>material_code_prod<span class="token punctuation">,</span>
                                       material_code<span class="token punctuation">,</span>
                                       currency_cost<span class="token punctuation">,</span>
                                       price_cost_ori<span class="token punctuation">,</span>
                                       price_cost<span class="token punctuation">,</span>
                                       currency_verify<span class="token punctuation">,</span>
                                       price_verify_ori<span class="token punctuation">,</span>
                                       price_verify<span class="token punctuation">,</span>
                                       price_calculate<span class="token punctuation">)</span>
<span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
       material_code<span class="token punctuation">,</span>
       currency_cost<span class="token punctuation">,</span>
       price_cost_ori<span class="token punctuation">,</span>
       price_cost<span class="token punctuation">,</span>
       currency_verify<span class="token punctuation">,</span>
       price_verify_ori<span class="token punctuation">,</span>
       price_verify<span class="token punctuation">,</span>
       price_calculate
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
             a<span class="token punctuation">.</span>material_code<span class="token punctuation">,</span>
             currency_cost<span class="token punctuation">,</span>
             price_cost_ori<span class="token punctuation">,</span>
             price_cost<span class="token punctuation">,</span>
             currency_verify<span class="token punctuation">,</span>
             price_verify_ori<span class="token punctuation">,</span>
             price_verify<span class="token punctuation">,</span>
             a<span class="token punctuation">.</span>price_calculate
      <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code<span class="token punctuation">,</span>
                   <span class="token function">sum</span><span class="token punctuation">(</span>bom_cost<span class="token punctuation">)</span> price_calculate
            <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code<span class="token punctuation">,</span>
                         bom_cost<span class="token punctuation">,</span>
                         <span class="token function">avg</span><span class="token punctuation">(</span>symbol_contrains<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> material_code<span class="token punctuation">)</span> a2
                  <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> b<span class="token punctuation">.</span>material_code<span class="token punctuation">,</span>
                               amount_base<span class="token punctuation">,</span>
                               PRICE_CALCULATE<span class="token punctuation">,</span>
                               amount_base <span class="token operator">*</span> PRICE_CALCULATE         bom_cost<span class="token punctuation">,</span>
                               <span class="token keyword">IF</span><span class="token punctuation">(</span>PRICE_CALCULATE <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> symbol_contrains
                        <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code  material_code<span class="token punctuation">,</span>
                                     material_code subprodid<span class="token punctuation">,</span>
                                     qpa           amount_base
                              <span class="token keyword">from</span> dim_bom
                              <span class="token keyword">where</span> lvl <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> a
                                 <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> material_code
                                             <span class="token keyword">from</span> dw_mt_bom_unit_price_mview
                                             <span class="token keyword">where</span> PRICE_CALCULATE <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> b
                                            <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code
                                 <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> material_code<span class="token punctuation">,</span>
                                                            price_calculate
                                            <span class="token keyword">from</span> dw_mt_bom_unit_price_mview<span class="token punctuation">)</span> c
                                           <span class="token keyword">on</span> a<span class="token punctuation">.</span>subprodid <span class="token operator">=</span> c<span class="token punctuation">.</span>material_code<span class="token punctuation">)</span> a<span class="token punctuation">)</span> a
            <span class="token keyword">where</span> a2 <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">group</span> <span class="token keyword">by</span> material_code<span class="token punctuation">)</span> a
               <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                                  material_code<span class="token punctuation">,</span>
                                  currency_cost<span class="token punctuation">,</span>
                                  price_cost_ori<span class="token punctuation">,</span>
                                  price_cost<span class="token punctuation">,</span>
                                  currency_verify<span class="token punctuation">,</span>
                                  price_verify_ori<span class="token punctuation">,</span>
                                  price_verify
                           <span class="token keyword">from</span> dw_mt_bom_unit_price_mview<span class="token punctuation">)</span> b
                          <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code<span class="token punctuation">)</span> iter_result
<span class="token keyword">on</span> <span class="token keyword">duplicate</span> <span class="token keyword">key</span> <span class="token keyword">update</span> currency_cost   <span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>currency_cost<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        price_cost_ori<span class="token operator">=</span><span class="token keyword">values</span><span class="token punctuation">(</span>price_cost_ori<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        currency_verify<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>currency_verify<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        price_verify_ori<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>price_verify_ori<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        price_verify<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>price_verify<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        price_calculate<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>price_calculate<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_332"></a>汇总部分结果</h3> 
<p>使用存储过程运行的结果</p> 
<p><img src="https://images2.imgbox.com/7e/2f/KvidTGRJ_o.png" alt="计算结果"></p> 
<h3><a id="_339"></a>参与计算的表结构</h3> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> currency_exchange
<span class="token punctuation">(</span>
    currency_transaction <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'交易币种'</span><span class="token punctuation">,</span>
    currency_base        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'基础币种'</span><span class="token punctuation">,</span>
    exchange_rate        <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'汇率'</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>currency_transaction<span class="token punctuation">,</span> currency_base<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">'汇率明细'</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> price_cost
<span class="token punctuation">(</span>
    material_code <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'料号'</span><span class="token punctuation">,</span>
    currency      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'交易币种'</span><span class="token punctuation">,</span>
    amount_price  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>material_code<span class="token punctuation">,</span> currency<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">'成本单价明细'</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> price_verify
<span class="token punctuation">(</span>
    material_code <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'料号'</span><span class="token punctuation">,</span>
    currency      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'交易币种'</span><span class="token punctuation">,</span>
    amount_price  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>material_code<span class="token punctuation">,</span> currency<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">'核价单价明细'</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> clip_dwh<span class="token punctuation">.</span>dim_bom
<span class="token punctuation">(</span>
    product_code  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'上阶料'</span><span class="token punctuation">,</span>
    material_code <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'下阶料'</span><span class="token punctuation">,</span>
    bom_hierarchy <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">260</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'BOM 分层'</span><span class="token punctuation">,</span>
    lvl           <span class="token keyword">int</span>          <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'分层等级'</span><span class="token punctuation">,</span>
    qpa           <span class="token keyword">double</span>       <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'组成用量'</span><span class="token punctuation">,</span>
    main          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'主料'</span><span class="token punctuation">,</span>
    <span class="token keyword">enable</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'启用'</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>product_code<span class="token punctuation">,</span> material_code<span class="token punctuation">,</span> bom_hierarchy<span class="token punctuation">)</span>
<span class="token punctuation">)</span>    <span class="token keyword">comment</span> <span class="token string">'BOM 明细'</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_382"></a>完整存储过程代码</h3> 
<pre><code class="prism language-sql"><span class="token keyword">create</span>
    <span class="token keyword">definer</span> <span class="token operator">=</span> root<span class="token variable">@localhost</span> <span class="token keyword">procedure</span> recursion_bom_unit_price<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> iter <span class="token keyword">integer</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">truncate</span> <span class="token keyword">table</span> clip_dwh<span class="token punctuation">.</span>dw_mt_bom_unit_price_mview<span class="token punctuation">;</span>

    <span class="token keyword">commit</span><span class="token punctuation">;</span>

    <span class="token keyword">insert</span> <span class="token keyword">into</span> dw_mt_bom_unit_price_mview<span class="token punctuation">(</span>material_code_prod<span class="token punctuation">,</span>
                                           material_code<span class="token punctuation">,</span>
                                           currency_cost<span class="token punctuation">,</span>
                                           price_cost_ori<span class="token punctuation">,</span>
                                           price_cost<span class="token punctuation">,</span>
                                           currency_verify<span class="token punctuation">,</span>
                                           price_verify_ori<span class="token punctuation">,</span>
                                           price_verify<span class="token punctuation">,</span>
                                           price_calculate<span class="token punctuation">)</span>
    <span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">with</span> tmp_prod <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code                                  material_code_prod<span class="token punctuation">,</span>
                                   material_code<span class="token punctuation">,</span>
                                   <span class="token boolean">null</span>                                           currency_cost<span class="token punctuation">,</span>
                                   <span class="token boolean">null</span>                                        <span class="token keyword">as</span> price_cost_ori<span class="token punctuation">,</span>
                                   <span class="token boolean">null</span>                                        <span class="token keyword">as</span> price_cost<span class="token punctuation">,</span>

                                   c<span class="token punctuation">.</span>currency_verify<span class="token punctuation">,</span>
                                   c<span class="token punctuation">.</span>price_verify                              <span class="token keyword">as</span> price_verify_ori<span class="token punctuation">,</span>
                                   d<span class="token punctuation">.</span>exchange_rate <span class="token operator">*</span> IFNULL<span class="token punctuation">(</span>c<span class="token punctuation">.</span>price_verify<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> price_verify<span class="token punctuation">,</span>
                                   <span class="token boolean">null</span>                                           price_calculate
                            <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token keyword">as</span> material_code
                                  <span class="token comment"># BOM 中只在 product_code 字段存在 不在 material_code 存在代表 该物料没有上阶物料 推断出本身是成品</span>
                                  <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code
                                        <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_subordinate
                                           <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code
                                                      <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_superior
                                                     <span class="token keyword">on</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token operator">=</span> bom_superior<span class="token punctuation">.</span>material_code
                                  <span class="token keyword">where</span> bom_superior<span class="token punctuation">.</span>material_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                     <span class="token comment"># 采购核价</span>
                                     <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                      currency      currency_verify<span class="token punctuation">,</span>
                                                      amount_price  price_verify
                                               <span class="token keyword">FROM</span> clip_ods<span class="token punctuation">.</span>price_verify<span class="token punctuation">)</span> c
                                              <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> c<span class="token punctuation">.</span>mat_code
                                <span class="token comment"># 汇率</span>
                                     <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                       exchange_rate
                                                <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                                <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> d
                                               <span class="token keyword">on</span> c<span class="token punctuation">.</span>currency_verify <span class="token operator">=</span> d<span class="token punctuation">.</span>currency_transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>

               tmp_mat <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code                                                                 material_code_prod<span class="token punctuation">,</span>
                                  material_code<span class="token punctuation">,</span>

                                  currency_cost<span class="token punctuation">,</span>
                                  price_cost                                                                <span class="token keyword">as</span> price_cost_ori<span class="token punctuation">,</span>
                                  <span class="token keyword">case</span> <span class="token keyword">when</span> price_cost <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span> <span class="token keyword">as</span> price_cost<span class="token punctuation">,</span>

                                  currency_verify<span class="token punctuation">,</span>
                                  price_verify                                                              <span class="token keyword">as</span> price_verify_ori<span class="token punctuation">,</span>
                                  <span class="token keyword">case</span>
                                      <span class="token keyword">when</span> price_verify <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span>
                                      <span class="token keyword">else</span> price_verify <span class="token operator">*</span> d<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span>                               <span class="token keyword">as</span> price_verify<span class="token punctuation">,</span>

                                  <span class="token keyword">case</span>
                                      <span class="token keyword">when</span> price_cost <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate
                                      <span class="token keyword">when</span> price_verify <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> price_verify <span class="token operator">*</span> d<span class="token punctuation">.</span>exchange_rate
                                      <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span>                                                               price_calculate
                           <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>product_code<span class="token punctuation">,</span>
                                        a<span class="token punctuation">.</span>material_code
                                 <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> bom_superior<span class="token punctuation">.</span>product_code<span class="token punctuation">,</span>
                                                       bom_superior<span class="token punctuation">.</span>material_code
                                       <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code<span class="token punctuation">,</span>
                                                    material_code
                                             <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_superior
                                                <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code
                                                           <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_subordinate
                                                          <span class="token keyword">on</span> bom_superior<span class="token punctuation">.</span>material_code <span class="token operator">=</span> bom_subordinate<span class="token punctuation">.</span>product_code
                                       <span class="token comment"># BOM 中只在 material_code 字段存在 不在 product_code 存在代表 该物料没有下阶物料 推断出本身是最底层材料</span>
                                       <span class="token keyword">where</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                          <span class="token keyword">inner</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> bom_subordinate<span class="token punctuation">.</span>product_code prod_code
                                                     <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code
                                                           <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_subordinate
                                                              <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code
                                                                         <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> bom_superior
                                                                        <span class="token keyword">on</span> bom_subordinate<span class="token punctuation">.</span>product_code <span class="token operator">=</span> bom_superior<span class="token punctuation">.</span>material_code
                                                     <span class="token comment"># 与 BOM中的最上层成品 join 保证不会有多余的材料料号参与</span>
                                                     <span class="token keyword">where</span> bom_superior<span class="token punctuation">.</span>material_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> b
                                                    <span class="token keyword">on</span> a<span class="token punctuation">.</span>product_code <span class="token operator">=</span> b<span class="token punctuation">.</span>prod_code<span class="token punctuation">)</span> a
                                    <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                     currency      currency_cost<span class="token punctuation">,</span>
                                                     <span class="token comment"># 库存成本</span>
                                                     amount_price  price_cost
                                              <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>price_cost<span class="token punctuation">)</span> b
                                             <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>mat_code
                                    <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                     currency      currency_verify<span class="token punctuation">,</span>
                                                     <span class="token comment"># 核价</span>
                                                     amount_price  price_verify
                                              <span class="token keyword">FROM</span> clip_ods<span class="token punctuation">.</span>price_verify<span class="token punctuation">)</span> c
                                             <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> c<span class="token punctuation">.</span>mat_code
                                    <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                      exchange_rate
                                               <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                               <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> d
                                              <span class="token keyword">on</span> c<span class="token punctuation">.</span>currency_verify <span class="token operator">=</span> d<span class="token punctuation">.</span>currency_transaction
                                    <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                      exchange_rate
                                               <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                               <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> e
                                              <span class="token keyword">on</span> b<span class="token punctuation">.</span>currency_cost <span class="token operator">=</span> e<span class="token punctuation">.</span>currency_transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>

               tmp_semi <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> productid                                                                    material_code_prod<span class="token punctuation">,</span>
                                   material_code<span class="token punctuation">,</span>
                                   currency_cost<span class="token punctuation">,</span>
                                   price_cost                                                                <span class="token keyword">as</span> price_cost_ori<span class="token punctuation">,</span>
                                   <span class="token keyword">case</span> <span class="token keyword">when</span> price_cost <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span> <span class="token keyword">as</span> price_cost<span class="token punctuation">,</span>

                                   currency_verify<span class="token punctuation">,</span>
                                   price_verify                                                              <span class="token keyword">as</span> price_verify_ori<span class="token punctuation">,</span>
                                   <span class="token keyword">case</span>
                                       <span class="token keyword">when</span> price_verify <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span>
                                       <span class="token keyword">else</span> price_verify <span class="token operator">*</span> d<span class="token punctuation">.</span>exchange_rate <span class="token keyword">end</span>                               <span class="token keyword">as</span> price_verify<span class="token punctuation">,</span>

                                   price_cost <span class="token operator">*</span> e<span class="token punctuation">.</span>exchange_rate                                                 price_calculate
                            <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>productid<span class="token punctuation">,</span>
                                         a<span class="token punctuation">.</span>material_code
                                  <span class="token comment"># 然后是 成品 和 材料 之间 的 半成品料号，使用join保证不会有多余料号参与</span>
                                  <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> b<span class="token punctuation">.</span>productid<span class="token punctuation">,</span>
                                               b<span class="token punctuation">.</span>material_code
                                        <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>productid
                                              <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code productid
                                                    <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> a
                                                       <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code subprodid
                                                                  <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> b
                                                                 <span class="token keyword">on</span> a<span class="token punctuation">.</span>productid <span class="token operator">=</span> b<span class="token punctuation">.</span>subprodid
                                              <span class="token keyword">where</span> b<span class="token punctuation">.</span>subprodid <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                                 <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> product_code productid<span class="token punctuation">,</span>
                                                                             material_code
                                                             <span class="token keyword">from</span> dim_bom<span class="token punctuation">)</span> b
                                                            <span class="token keyword">on</span> a<span class="token punctuation">.</span>productid <span class="token operator">=</span> b<span class="token punctuation">.</span>productid<span class="token punctuation">)</span> a
                                           <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                                                             material_code
                                                      <span class="token keyword">from</span> tmp_mat
                                                      <span class="token keyword">where</span> price_calculate <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">)</span> b
                                                     <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code
                                                         <span class="token operator">and</span> a<span class="token punctuation">.</span>productid <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code_prod
                                  <span class="token keyword">where</span> b<span class="token punctuation">.</span>material_code <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> a
                                     <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                      currency      currency_cost<span class="token punctuation">,</span>
                                                      <span class="token comment"># 库存成本</span>
                                                      amount_price  price_cost
                                               <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>price_cost<span class="token punctuation">)</span> b
                                              <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>mat_code
                                     <span class="token keyword">left</span> <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> material_code mat_code<span class="token punctuation">,</span>
                                                      currency      currency_verify<span class="token punctuation">,</span>
                                                      <span class="token comment"># 核价</span>
                                                      amount_price  price_verify
                                               <span class="token keyword">FROM</span> clip_ods<span class="token punctuation">.</span>price_verify<span class="token punctuation">)</span> c
                                              <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> c<span class="token punctuation">.</span>mat_code
                                     <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                       exchange_rate
                                                <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                                <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> d
                                               <span class="token keyword">on</span> c<span class="token punctuation">.</span>currency_verify <span class="token operator">=</span> d<span class="token punctuation">.</span>currency_transaction
                                     <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> currency_transaction<span class="token punctuation">,</span>
                                                       exchange_rate
                                                <span class="token keyword">from</span> clip_ods<span class="token punctuation">.</span>currency_exchange
                                                <span class="token keyword">where</span> currency_base <span class="token operator">=</span> <span class="token string">'CNY'</span><span class="token punctuation">)</span> e
                                               <span class="token keyword">on</span> b<span class="token punctuation">.</span>currency_cost <span class="token operator">=</span> e<span class="token punctuation">.</span>currency_transaction<span class="token punctuation">)</span>

            <span class="token comment"># 成品、材料、半成品 结构相同，使用union拼接再插入</span>
          <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                 material_code<span class="token punctuation">,</span>
                 currency_cost<span class="token punctuation">,</span>
                 price_cost_ori<span class="token punctuation">,</span>
                 price_cost<span class="token punctuation">,</span>
                 currency_verify<span class="token punctuation">,</span>
                 price_verify_ori<span class="token punctuation">,</span>
                 price_verify<span class="token punctuation">,</span>
                 price_calculate
          <span class="token keyword">from</span> tmp_prod
          <span class="token keyword">union</span>
          <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                 material_code<span class="token punctuation">,</span>
                 currency_cost<span class="token punctuation">,</span>
                 price_cost_ori<span class="token punctuation">,</span>
                 price_cost<span class="token punctuation">,</span>
                 currency_verify<span class="token punctuation">,</span>
                 price_verify_ori<span class="token punctuation">,</span>
                 price_verify<span class="token punctuation">,</span>
                 price_calculate
          <span class="token keyword">from</span> tmp_mat
          <span class="token keyword">union</span>
          <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                 material_code<span class="token punctuation">,</span>
                 currency_cost<span class="token punctuation">,</span>
                 price_cost_ori<span class="token punctuation">,</span>
                 price_cost<span class="token punctuation">,</span>
                 currency_verify<span class="token punctuation">,</span>
                 price_verify_ori<span class="token punctuation">,</span>
                 price_verify<span class="token punctuation">,</span>
                 price_calculate
          <span class="token keyword">from</span> tmp_semi<span class="token punctuation">)</span> initial_tmp<span class="token punctuation">;</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span>

    <span class="token keyword">WHILE</span> iter <span class="token operator">&lt;=</span> <span class="token number">10</span>
        <span class="token keyword">DO</span>
            <span class="token keyword">set</span> iter <span class="token operator">=</span> iter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">insert</span> <span class="token keyword">into</span> dw_mt_bom_unit_price_mview<span class="token punctuation">(</span>material_code_prod<span class="token punctuation">,</span>
                                                   material_code<span class="token punctuation">,</span>
                                                   currency_cost<span class="token punctuation">,</span>
                                                   price_cost_ori<span class="token punctuation">,</span>
                                                   price_cost<span class="token punctuation">,</span>
                                                   currency_verify<span class="token punctuation">,</span>
                                                   price_verify_ori<span class="token punctuation">,</span>
                                                   price_verify<span class="token punctuation">,</span>
                                                   price_calculate<span class="token punctuation">)</span>
            <span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                   material_code<span class="token punctuation">,</span>
                   currency_cost<span class="token punctuation">,</span>
                   price_cost_ori<span class="token punctuation">,</span>
                   price_cost<span class="token punctuation">,</span>
                   currency_verify<span class="token punctuation">,</span>
                   price_verify_ori<span class="token punctuation">,</span>
                   price_verify<span class="token punctuation">,</span>
                   price_calculate
            <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                         a<span class="token punctuation">.</span>material_code<span class="token punctuation">,</span>
                         currency_cost<span class="token punctuation">,</span>
                         price_cost_ori<span class="token punctuation">,</span>
                         price_cost<span class="token punctuation">,</span>
                         currency_verify<span class="token punctuation">,</span>
                         price_verify_ori<span class="token punctuation">,</span>
                         price_verify<span class="token punctuation">,</span>
                         a<span class="token punctuation">.</span>price_calculate
                  <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code<span class="token punctuation">,</span>
                               <span class="token function">sum</span><span class="token punctuation">(</span>bom_cost<span class="token punctuation">)</span> price_calculate
                        
                        <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code<span class="token punctuation">,</span>
                                     bom_cost<span class="token punctuation">,</span>
                                     <span class="token function">avg</span><span class="token punctuation">(</span>symbol_contrains<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> material_code<span class="token punctuation">)</span> a2
                              <span class="token comment"># 使用 平均数 保证 此 材料 的所有下阶材料都存在，如果不存在计算出来的材料单价会有问题</span>
                              <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> b<span class="token punctuation">.</span>material_code<span class="token punctuation">,</span>
                                           amount_base<span class="token punctuation">,</span>
                                           PRICE_CALCULATE<span class="token punctuation">,</span>
                                           amount_base <span class="token operator">*</span> PRICE_CALCULATE         bom_cost<span class="token punctuation">,</span>
                                           <span class="token keyword">IF</span><span class="token punctuation">(</span>PRICE_CALCULATE <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> symbol_contrains
                                    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> product_code  material_code<span class="token punctuation">,</span>
                                                 material_code subprodid<span class="token punctuation">,</span>
                                                 qpa           amount_base
                                          <span class="token keyword">from</span> dim_bom
                                          <span class="token keyword">where</span> lvl <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> a
                                             <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> material_code
                                                         <span class="token keyword">from</span> dw_mt_bom_unit_price_mview
                                                         <span class="token keyword">where</span> PRICE_CALCULATE <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> b
                                                        <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code
                                             <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> material_code<span class="token punctuation">,</span>
                                                                        price_calculate
                                                        <span class="token keyword">from</span> dw_mt_bom_unit_price_mview<span class="token punctuation">)</span> c
                                                       <span class="token keyword">on</span> a<span class="token punctuation">.</span>subprodid <span class="token operator">=</span> c<span class="token punctuation">.</span>material_code<span class="token punctuation">)</span> a<span class="token punctuation">)</span> a
                        <span class="token keyword">where</span> a2 <span class="token operator">=</span> <span class="token number">1</span>
                        <span class="token keyword">group</span> <span class="token keyword">by</span> material_code<span class="token punctuation">)</span> a
                           <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> material_code_prod<span class="token punctuation">,</span>
                                              material_code<span class="token punctuation">,</span>
                                              currency_cost<span class="token punctuation">,</span>
                                              price_cost_ori<span class="token punctuation">,</span>
                                              price_cost<span class="token punctuation">,</span>
                                              currency_verify<span class="token punctuation">,</span>
                                              price_verify_ori<span class="token punctuation">,</span>
                                              price_verify
                                       <span class="token keyword">from</span> dw_mt_bom_unit_price_mview<span class="token punctuation">)</span> b
                                      <span class="token keyword">on</span> a<span class="token punctuation">.</span>material_code <span class="token operator">=</span> b<span class="token punctuation">.</span>material_code<span class="token punctuation">)</span> iter_result
            <span class="token comment"># 出现重复键时覆盖，因为我们一般在初始化时已写入此主键，覆盖重复键则是为了更新</span>
            <span class="token keyword">on</span> <span class="token keyword">duplicate</span> <span class="token keyword">key</span> <span class="token keyword">update</span> currency_cost   <span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>currency_cost<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    price_cost_ori<span class="token operator">=</span><span class="token keyword">values</span><span class="token punctuation">(</span>price_cost_ori<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    currency_verify<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>currency_verify<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    price_verify_ori<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>price_verify_ori<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    price_verify<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>price_verify<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    price_calculate<span class="token operator">=</span> <span class="token keyword">values</span><span class="token punctuation">(</span>price_calculate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93530b19509d19b00eee70f5baafc1f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解密AI绘画与修图： Stable Diffusion&#43;Photoshop</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/718da317cc378c5d833ac21f78ccd1ae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C语言初阶】C语言函数全解析：编写高效代码的秘密武器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>