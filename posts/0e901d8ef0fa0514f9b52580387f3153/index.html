<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[嵌入式AI从0开始到入土]17_Ascend C算子开发 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0e901d8ef0fa0514f9b52580387f3153/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="[嵌入式AI从0开始到入土]17_Ascend C算子开发">
  <meta property="og:description" content="[嵌入式AI从0开始到入土]嵌入式AI系列教程 注：等我摸完鱼再把链接补上
可以关注我的B站号工具人呵呵的个人空间，后期会考虑出视频教程，务必催更，以防我变身鸽王。
第1期 昇腾Altas 200 DK上手
第2期 下载昇腾案例并运行
第3期 官方模型适配工具使用
第4期 炼丹炉的搭建（基于Ubuntu23.04 Desktop）
第5期 炼丹炉的搭建（基于wsl2_Ubuntu22.04）
第6期 Ubuntu远程桌面配置
第7期 下载yolo源码及样例运行验证
第8期 在线Gpu环境训练（基于启智ai协作平台）
第9期 转化为昇腾支持的om离线模型
第10期 jupyter lab的使用
第11期 yolov5在昇腾上推理
第12期 yolov5在昇腾上应用
第13期_orangepi aipro开箱测评
第14期 orangepi_aipro小修补含yolov7多线程案例
第15期 orangepi_aipro欢迎界面、ATC bug修复、镜像导出备份
第16期 ffmpeg_ascend编译安装及性能测试
第17期 Ascend C算子开发
未完待续…
文章目录 [嵌入式AI从0开始到入土]嵌入式AI系列教程前言一、环境配置1、CANN包安装2、配置ssh密钥（可选）3、配置git（可选） 二、获取sample样例1、add算子1、KernelLaunch2、Framework3、AclNN 2、Addcdiv算子 三、编写自己的算子1、搭建框架2、 KernelLaunch编写1、myCustom.cpp2、main.cpp3、scripts/gen_data.py 3、 framework编写4、 Aclnn测试 四、torch_npu重新编译（可选）五、常用api问题1、fatal error: register/tilingdata_base.h: No such file or directory 总结 前言 我在24年3月和我的小伙伴一起参加了第一届昇腾AI原生创新精英挑战赛，在这里做一下总结。这里以orangepi Ai Pro为例。
注：我们的代码仓最早将于24.05.10开放，大家可以直接看op_kernel内的compute，kernelLaunch内可能有错，实在来不及改了
代码仓地址：https://gitee.com/toolsmanhehe/acl_ops
一、环境配置 我们基于正常能够使用的镜像作为基础镜像。这里我推荐使用minimal镜像。这样就不用先卸载cann了，甚至你可以直接删除/opt/compress目录，反正咱后面直接远程连接敲代码了，也用不上。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-04T17:57:30+08:00">
    <meta property="article:modified_time" content="2024-05-04T17:57:30+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[嵌入式AI从0开始到入土]17_Ascend C算子开发</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="AI0AI_0"></a>[嵌入式AI从0开始到入土]嵌入式AI系列教程</h2> 
<p><code>注：等我摸完鱼再把链接补上</code><br> 可以关注我的B站号<a href="https://space.bilibili.com/153159482" rel="nofollow">工具人呵呵的个人空间</a>，后期会考虑出视频教程，务必催更，以防我变身鸽王。</p> 
<p><a href="https://blog.csdn.net/weixin_44354614/article/details/133579532">第1期 昇腾Altas 200 DK上手</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/133610680">第2期 下载昇腾案例并运行</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/133610701">第3期 官方模型适配工具使用</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/133610719">第4期 炼丹炉的搭建（基于Ubuntu23.04 Desktop）</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/135490038">第5期 炼丹炉的搭建（基于wsl2_Ubuntu22.04）</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/133518520">第6期 Ubuntu远程桌面配置</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/133610730">第7期 下载yolo源码及样例运行验证</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/136026963">第8期 在线Gpu环境训练（基于启智ai协作平台）</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/135018077">第9期 转化为昇腾支持的om离线模型</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/135047505">第10期 jupyter lab的使用</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/135298104">第11期 yolov5在昇腾上推理</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/135368091">第12期 yolov5在昇腾上应用</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/136049545">第13期_orangepi aipro开箱测评</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/136114185">第14期 orangepi_aipro小修补含yolov7多线程案例</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/136160669">第15期 orangepi_aipro欢迎界面、ATC bug修复、镜像导出备份</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/136625418">第16期 ffmpeg_ascend编译安装及性能测试</a><br> <a href="https://blog.csdn.net/weixin_44354614/article/details/138424102">第17期 Ascend C算子开发</a><br> 未完待续…</p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#AI0AI_0" rel="nofollow">[嵌入式AI从0开始到入土]嵌入式AI系列教程</a></li><li><a href="#_29" rel="nofollow">前言</a></li><li><a href="#_33" rel="nofollow">一、环境配置</a></li><li><ul><li><a href="#1CANN_35" rel="nofollow">1、CANN包安装</a></li><li><a href="#2ssh_52" rel="nofollow">2、配置ssh密钥（可选）</a></li><li><a href="#3git_55" rel="nofollow">3、配置git（可选）</a></li></ul> 
  </li><li><a href="#sample_67" rel="nofollow">二、获取sample样例</a></li><li><ul><li><a href="#1add_73" rel="nofollow">1、add算子</a></li><li><ul><li><a href="#1KernelLaunch_75" rel="nofollow">1、KernelLaunch</a></li><li><a href="#2Framework_107" rel="nofollow">2、Framework</a></li><li><a href="#3AclNN_127" rel="nofollow">3、AclNN</a></li></ul> 
   </li><li><a href="#2Addcdiv_138" rel="nofollow">2、Addcdiv算子</a></li></ul> 
  </li><li><a href="#_235" rel="nofollow">三、编写自己的算子</a></li><li><ul><li><a href="#1_236" rel="nofollow">1、搭建框架</a></li><li><a href="#2_KernelLaunch_255" rel="nofollow">2、 KernelLaunch编写</a></li><li><ul><li><a href="#1myCustomcpp_256" rel="nofollow">1、myCustom.cpp</a></li><li><a href="#2maincpp_258" rel="nofollow">2、main.cpp</a></li><li><a href="#3scriptsgen_datapy_261" rel="nofollow">3、scripts/gen_data.py</a></li></ul> 
   </li><li><a href="#3_framework_263" rel="nofollow">3、 framework编写</a></li><li><a href="#4_Aclnn_303" rel="nofollow">4、 Aclnn测试</a></li></ul> 
  </li><li><a href="#torch_npu_305" rel="nofollow">四、torch_npu重新编译（可选）</a></li><li><a href="#api_307" rel="nofollow">五、常用api</a></li><li><a href="#_326" rel="nofollow">问题</a></li><li><ul><li><a href="#1fatal_error_registertilingdata_baseh_No_such_file_or_directory_328" rel="nofollow">1、fatal error: register/tilingdata_base.h: No such file or directory</a></li></ul> 
  </li><li><a href="#_334" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_29"></a>前言</h2> 
<p>我在24年3月和我的小伙伴一起参加了<a href="https://www.hiascend.com/zh/developer/contests/details/c639eda60fda4188bd7dce3a2daadebd" rel="nofollow">第一届昇腾AI原生创新精英挑战赛</a>，在这里做一下总结。这里以orangepi Ai Pro为例。<br> <mark>注：我们的代码仓最早将于24.05.10开放，大家可以直接看op_kernel内的compute，kernelLaunch内可能有错，实在来不及改了</mark><br> 代码仓地址：<a href="https://gitee.com/toolsmanhehe/acl_ops" rel="nofollow">https://gitee.com/toolsmanhehe/acl_ops</a></p> 
<h2><a id="_33"></a>一、环境配置</h2> 
<p>我们基于正常能够使用的镜像作为基础镜像。这里我推荐使用minimal镜像。这样就不用先卸载cann了，甚至你可以直接删除<code>/opt/compress</code>目录，反正咱后面直接远程连接敲代码了，也用不上。</p> 
<h3><a id="1CANN_35"></a>1、CANN包安装</h3> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://ascend-repo.obs.cn-east-2.myhuaweicloud.com/Milan-ASL/Milan-ASL%20V100R001C17SPC702/Ascend-cann-toolkit_8.0.RC1.alpha002_linux-aarch64.run
<span class="token function">chmod</span> +x Ascend-cann-toolkit_8.0.RC1.alpha002_linux-aarch64.run

<span class="token comment">#卸载旧的CANN</span>
./Ascend-cann-toolkit_8.0.RC1.alpha002_linux-aarch64.run <span class="token parameter variable">--uninstall</span>
<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /usr/local/Ascend/ascend-toolkit/*

<span class="token comment">#安装指定版本的CANN</span>
./Ascend-cann-toolkit_8.0.RC1.alpha002_linux-aarch64.run <span class="token parameter variable">--install</span>
<span class="token comment">#安装依赖</span>
pip <span class="token function">install</span> <span class="token assign-left variable">protobuf</span><span class="token operator">==</span><span class="token number">3.20</span>.0
<span class="token comment">#添加环境变量</span>
<span class="token builtin class-name">echo</span> “source /usr/local/Ascend/ascend-toolkit/set_env.sh” <span class="token operator">&gt;&gt;</span> /home/HwHiAiUser/.bashrc
<span class="token builtin class-name">source</span> /home/HwHiAiUser/.bashrc
</code></pre> 
<h3><a id="2ssh_52"></a>2、配置ssh密钥（可选）</h3> 
<p>主要是vscode等ide连接时都需要输入密码，比较麻烦。<br> 这里可以参考我<a href="https://blog.csdn.net/weixin_44354614/article/details/133610719">之前的文章来实现免密登录</a>，在<code>七、问题 的第5点</code></p> 
<h3><a id="3git_55"></a>3、配置git（可选）</h3> 
<p>因为我们三个人在三个城市，因此为了方便讨论和开发，我们建立了代码仓库，但是每次推送和拉取都需要账号密码（在完赛前是不可能公开的），这不符合本懒人的性格啊。<br> 这里我们需要在开发环境上执行</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> ~
<span class="token function">touch</span> .git-credentials
<span class="token function">vim</span> .git-credentials
<span class="token comment">#输入以下内容，请自行替换username和password</span>
https://username:password@gitee.com
<span class="token function">git</span> config <span class="token parameter variable">--global</span> credential.helper store
</code></pre> 
<h2><a id="sample_67"></a>二、获取sample样例</h2> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> 
<span class="token function">git</span> clone https://gitee.com/ascend/samples.git
</code></pre> 
<p>在不修改算子名称，输入输出的时候，我们只需要关注图中框出来的文件即可。</p> 
<h3><a id="1add_73"></a>1、add算子</h3> 
<p>打开目录<code>operator/AddCustomSample</code></p> 
<h4><a id="1KernelLaunch_75"></a>1、KernelLaunch</h4> 
<p><img src="https://images2.imgbox.com/d3/3c/v0peJW4n_o.png" alt="在这里插入图片描述"><br> 我们的调用顺序是<code>main.cpp-&gt;add_custom_do-&gt;add_custom-&gt;op.Init-&gt;op.Process</code>。<br> <img src="https://images2.imgbox.com/23/92/BJCcSVmH_o.png" alt="在这里插入图片描述"><br> 因为我们要实现的算子的<code>Z=X+Y</code>，因此我们需要将这三个变量传入计算过程。<br> <mark>虽然这里只有2个输入，但是输出也需要申请内存，因此是3个输入参数</mark></p> 
<p>然后我们需要申明相关的变量和常量（这里使用静态shape）。<br> <img src="https://images2.imgbox.com/4d/2d/FHN3iTJf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/35/ad/egttXzpK_o.png" alt="在这里插入图片描述"><br> 接着就是初始化，为各个张量申请内存<br> <img src="https://images2.imgbox.com/f3/c2/KoNRsdQf_o.png" alt="在这里插入图片描述"><br> 接着就是计算过程，这里因为使用的是静态shape，因此循环次数是定值（芯片内存空间有限，不可能一次性全部计算完成）<br> <img src="https://images2.imgbox.com/19/70/grOinIfk_o.png" alt="在这里插入图片描述"><br> 在copyin的时候从xGM和yGM分别取出TILE_LENGTH个数据，存入xLocal和yLocal以供compute使用。<br> 在compute结束以后，我们需要先使用outQueueZ.EnQue来表示计算完成，但是此时不能释放zLocal的内存，因为我们还没有保存到zGM。<br> 在copyout环节，将输出结果存入zGM。</p> 
<p>接着我们看生成测试数据的程序，这里我们生成了2条16384个1~100随机half格式的数据。我们最后可以直接对比<code>output/golden.bin</code>和<code>output/output_z.bin</code>的md5值来判断算子正确与否。或者修改<code>scripts/verify_result.py</code>直接打印误差数量。<br> <img src="https://images2.imgbox.com/a9/81/AhUIiAAY_o.png" alt="在这里插入图片描述"><br> 最后来到KernelLaunch目录执行以下命令，测试核函数正确性。<br> <mark>务必先进行cpu测试，通过后执行npu测试，在npu下有些报错不显示</mark></p> 
<pre><code class="prism language-bash"><span class="token function">su</span>			   <span class="token comment">#使用root用户执行，否则可能报错</span>
<span class="token function">bash</span> run.sh <span class="token parameter variable">-r</span> cpu <span class="token parameter variable">-v</span> ascend310B1   <span class="token comment">#cpu测试</span>
<span class="token function">bash</span> run.sh <span class="token parameter variable">-r</span> npu <span class="token parameter variable">-v</span> ascend310B1   <span class="token comment">#npu测试</span>
</code></pre> 
<p>以下为cpu测试结果<br> <img src="https://images2.imgbox.com/5b/89/HIOwXAFf_o.png" alt="在这里插入图片描述"><br> 以下为npu测试结果<br> <img src="https://images2.imgbox.com/2b/46/OJaM1yXr_o.png" alt="在这里插入图片描述"><br> 测试均通过的情况下，我们就可以进行下一步的framework的编写了</p> 
<h4><a id="2Framework_107"></a>2、Framework</h4> 
<p>我们先看<code>AddCustomSample/FrameworkLaunch/AddCustom.json</code>这个文件，上面为输入变量，下面为输出变量。我们需要使用这个配置文件来生成framework工程。此处的变量应该和工程内的一致。<br> <img src="https://images2.imgbox.com/77/5e/S1qHqJ0A_o.png" alt="在这里插入图片描述"><br> 接着我们看工程。<br> <img src="https://images2.imgbox.com/2a/0e/eAlXDx9b_o.png" alt="在这里插入图片描述"><br> op_host没什么可说的，可以去看本文下一个案例Addcdiv。<br> op_kernel基本上就是把上面在kernelLaunch中测试通过的代码cv过来。<br> 注意图中的地方就可以了，这个tiling是从host侧传入的。然后在开头将静态shape删除了，因为这里我们是通过op_host实现的动态shape的切分，然后传入kernel侧的。<br> <img src="https://images2.imgbox.com/d0/be/1oW69Bwo_o.png" alt="在这里插入图片描述"><br> 接下来修改<code>CMakePresets.json</code>，将框出来的地方改成你的CANN路径。<br> <img src="https://images2.imgbox.com/f2/75/DfckcL4H_o.png" alt="在这里插入图片描述"><br> 最后，我们进入framework目录，编译算子并安装</p> 
<pre><code class="prism language-bash"><span class="token function">bash</span> build.sh
./build_out/custom_opp_ubuntu_aarch64.run
</code></pre> 
<p><img src="https://images2.imgbox.com/63/b5/FKVpWDND_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3AclNN_127"></a>3、AclNN</h4> 
<p>在算子大赛的时候，这个是由官方发布的（就是可能有错误），我们直接使用即可，一般测试能通过，就会有4-8分（10分满分）。<br> <img src="https://images2.imgbox.com/cf/21/c5NCV2PW_o.png" alt="在这里插入图片描述"><br> 这里的gen_data和kernelLaunch里是一样的，我们执行以下命令，验证算子正确与否。</p> 
<pre><code class="prism language-bash"><span class="token function">bash</span> run.sh
</code></pre> 
<p>测试通过会有如下提示<br> <img src="https://images2.imgbox.com/74/6c/dm2BkeKK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2Addcdiv_138"></a>2、Addcdiv算子</h3> 
<p>打开目录<code>operator/AddcdivCustomSample</code><br> 大部分与add算子相似，因此我们这里只看op_host和op_kernel部分。<br> 在头文件中你会发现多了许多东西,所有的东西我们都需要传入kernel侧。具体实现过程就去阅读代码吧，就是这个案例也是赶出来的，可能里面的切分策略不是最好的，但是确实是能用的。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">ADDCDIV_CUSTOM_TILING_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADDCDIV_CUSTOM_TILING_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"register/tilingdata_base.h"</span></span>

namespace optiling <span class="token punctuation">{<!-- --></span>
<span class="token function">BEGIN_TILING_DATA_DEF</span><span class="token punctuation">(</span>AddcdivCustomTilingData<span class="token punctuation">)</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//参与计算的标量</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> blockLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> tileNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> tileLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> lasttileLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> formerNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> formerLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> formertileNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> formertileLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> formerlasttileLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> tailNum<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> tailLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> tailtileNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> tailtileLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TILING_DATA_FIELD_DEF</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> taillasttileLength<span class="token punctuation">)</span><span class="token punctuation">;</span>    
END_TILING_DATA_DEF<span class="token punctuation">;</span>

<span class="token function">REGISTER_TILING_DATA_CLASS</span><span class="token punctuation">(</span>AddcdivCustom<span class="token punctuation">,</span> AddcdivCustomTilingData<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// ADDCDIV_CUSTOM_TILING_H</span></span>
</code></pre> 
<p>以下为op_kernel内的部分代码</p> 
<pre><code class="prism language-c"> private<span class="token operator">:</span>
  TPipe pipe<span class="token punctuation">;</span>
  <span class="token comment">// TQue&lt;QuePosition::VECIN, BUFFER_NUM&gt; inQueueX, inQueueY, inQueueZ;</span>
  TQue<span class="token operator">&lt;</span>QuePosition<span class="token operator">::</span>VECIN<span class="token punctuation">,</span> BUFFER_NUM<span class="token operator">&gt;</span> inQueueIN<span class="token punctuation">;</span>
  TQue<span class="token operator">&lt;</span>QuePosition<span class="token operator">::</span>VECOUT<span class="token punctuation">,</span> BUFFER_NUM<span class="token operator">&gt;</span> outQueueOUT<span class="token punctuation">;</span>
  GlobalTensor<span class="token operator">&lt;</span>half<span class="token operator">&gt;</span> xGm<span class="token punctuation">;</span>
  GlobalTensor<span class="token operator">&lt;</span>half<span class="token operator">&gt;</span> yGm<span class="token punctuation">;</span>
  GlobalTensor<span class="token operator">&lt;</span>half<span class="token operator">&gt;</span> zGm<span class="token punctuation">;</span>
  GlobalTensor<span class="token operator">&lt;</span>half<span class="token operator">&gt;</span> outGm<span class="token punctuation">;</span>
  half value<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> blockLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> tileNum<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> tileLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> lasttileLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> formerNum<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> formerLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> formertileNum<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> formertileLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> formerlasttileLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> tailNum<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> tailLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> tailtileNum<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> tailtileLength<span class="token punctuation">;</span>
  <span class="token class-name">uint32_t</span> taillasttileLength<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> __global__ __aicore__ <span class="token keyword">void</span> <span class="token function">addcdiv_custom</span><span class="token punctuation">(</span>GM_ADDR x<span class="token punctuation">,</span> GM_ADDR y<span class="token punctuation">,</span>
                                                     GM_ADDR z<span class="token punctuation">,</span> GM_ADDR out<span class="token punctuation">,</span>
                                                     GM_ADDR workspace<span class="token punctuation">,</span>
                                                     GM_ADDR tiling<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">GET_TILING_DATA</span><span class="token punctuation">(</span>tiling_data<span class="token punctuation">,</span> tiling<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO: user kernel impl</span>
  KernelAddcdiv op<span class="token punctuation">;</span>

  <span class="token class-name">uint32_t</span> tilingKey <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TILING_KEY_IS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    tilingKey <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TILING_KEY_IS</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    tilingKey <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    tilingKey <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  op<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> out<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>value<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>blockLength<span class="token punctuation">,</span>
          tiling_data<span class="token punctuation">.</span>tileNum<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>tileLength<span class="token punctuation">,</span>
          tiling_data<span class="token punctuation">.</span>lasttileLength<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>formerNum<span class="token punctuation">,</span>
          tiling_data<span class="token punctuation">.</span>formerLength<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>formertileNum<span class="token punctuation">,</span>
          tiling_data<span class="token punctuation">.</span>formertileLength<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>formerlasttileLength<span class="token punctuation">,</span>
          tiling_data<span class="token punctuation">.</span>tailNum<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>tailLength<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>tailtileNum<span class="token punctuation">,</span>
          tiling_data<span class="token punctuation">.</span>tailtileLength<span class="token punctuation">,</span> tiling_data<span class="token punctuation">.</span>taillasttileLength<span class="token punctuation">,</span>
          tilingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  op<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__CCE_KT_TEST__</span></span>
<span class="token comment">// call of kernel function</span>
<span class="token keyword">void</span> <span class="token function">addcdiv_custom_do</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> blockDim<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> l2ctrl<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> stream<span class="token punctuation">,</span>
                       <span class="token class-name">uint8_t</span><span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> y<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> z<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> out<span class="token punctuation">,</span>
                       <span class="token class-name">uint8_t</span><span class="token operator">*</span> workspace<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> tiling<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  addcdiv_custom<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>blockDim<span class="token punctuation">,</span> l2ctrl<span class="token punctuation">,</span> stream<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> out<span class="token punctuation">,</span> workspace<span class="token punctuation">,</span> tiling<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h2><a id="_235"></a>三、编写自己的算子</h2> 
<h3><a id="1_236"></a>1、搭建框架</h3> 
<p>我们可以使用参考add算子搭建以下目录结构。以下文件夹内的文件没有特别说明就直接从add算子工程内复制。</p> 
<pre><code class="prism language-bash">myCustom
├── AclNNInvocation
│   ├── inc
│   ├── scripts
│   └── src
│   ├── run.sh
├── myCustom 		<span class="token operator">&lt;</span>-由msopgen工具生成
├── KernelLaunch
│   ├── myCustom.cpp
│   ├── cmake
│   ├── CMakeLists.txt
│   ├── data_utils.h
│   ├── run.sh
│   └── scripts
└── myCustom.json
</code></pre> 
<h3><a id="2_KernelLaunch_255"></a>2、 KernelLaunch编写</h3> 
<h4><a id="1myCustomcpp_256"></a>1、myCustom.cpp</h4> 
<p>我们直接cv add算子的，对输入做下修改，然后修改compute就行了。</p> 
<h4><a id="2maincpp_258"></a>2、main.cpp</h4> 
<p>这里主要是将算子名称以及传入的参数修改下<br> <img src="https://images2.imgbox.com/e9/53/rRudAGIU_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3scriptsgen_datapy_261"></a>3、scripts/gen_data.py</h4> 
<p>这里根据你要实现的代码编写生成数据和真值的程序就行了，在比赛时，我们可以直接从官方给出的AclNN中取。</p> 
<h3><a id="3_framework_263"></a>3、 framework编写</h3> 
<p>在kernelLaunch测试通过后我们直接修改myCustom.json。如果是多个数据类型，如下所示。</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"op"</span><span class="token operator">:</span> <span class="token string">"myCustom"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"language"</span><span class="token operator">:</span> <span class="token string">"cpp"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"input_desc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"x"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"param_type"</span><span class="token operator">:</span> <span class="token string">"required"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"ND"</span><span class="token punctuation">,</span><span class="token string">"ND"</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"fp16"</span><span class="token punctuation">,</span><span class="token string">"fp32"</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"output_desc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"y"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"param_type"</span><span class="token operator">:</span> <span class="token string">"required"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"format"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"ND"</span><span class="token punctuation">,</span><span class="token string">"ND"</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"fp16"</span><span class="token punctuation">,</span><span class="token string">"fp32"</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>然后生成工程（具体目录请自行修改）</p> 
<pre><code class="prism language-bash">/usr/local/Ascend/ascend-toolkit/latest/python/site-packages/bin/msopgen gen <span class="token parameter variable">-i</span> /home/HwHiAiUser/myCustom/myCustom.json <span class="token parameter variable">-c</span> ai_core-ascend310B1 <span class="token parameter variable">-lan</span> cpp <span class="token parameter variable">-out</span> /home/HwHiAiUser/myCustom/myCustom
</code></pre> 
<p>接着就是参考add和addcdiv算子在op_host中实现tiling策略，将kernelLaunch中测试通过的代码加上tiling相关的代码后搬运到op_kernel。编译安装算子。</p> 
<h3><a id="4_Aclnn_303"></a>4、 Aclnn测试</h3> 
<p>这里因为我做的是比赛里给出的题目，因此直接使用官方给的案例进行测试。对于自定义算子，除修改gen_data外，我们还需要修改op_runner以及main.cpp。</p> 
<h2><a id="torch_npu_305"></a>四、torch_npu重新编译（可选）</h2> 
<p>参考仓库说明：<a href="https://gitee.com/ascend/op-plugin" rel="nofollow">https://gitee.com/ascend/op-plugin</a></p> 
<h2><a id="api_307"></a>五、常用api</h2> 
<p>为了简化使用，以下仅列出常用的2级接口，如需高性能实现，请使用0级接口。310b系列似乎不支持高级api，因此也不列出了。详细内容请直接看<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/80RC1alpha002/apiref/opdevgapi/atlasascendc_api_07_0011.html" rel="nofollow">api文档</a></p> 
<table><thead><tr><th>名称</th><th>功能</th><th>表达式</th><th>二级接口样例</th></tr></thead><tbody><tr><td>Exp</td><td>按元素取自然指数</td><td><img src="https://images2.imgbox.com/de/f0/MpCSkMo4_o.png" alt="在这里插入图片描述"></td><td>Exp(dstLocal, srcLocal, 512);</td></tr><tr><td>Abs</td><td>按元素取绝对值</td><td><img src="https://images2.imgbox.com/0e/b7/llB0L4W5_o.png" alt="在这里插入图片描述"></td><td>Abs(dstLocal, srcLocal, 512);</td></tr><tr><td>Reciprocal</td><td>按元素取倒数</td><td><img src="https://images2.imgbox.com/68/28/xZibkHVy_o.png" alt="在这里插入图片描述"></td><td>Reciprocal(dstLocal, srcLocal, 512);</td></tr><tr><td>Sqrt</td><td>按元素做开方</td><td><img src="https://images2.imgbox.com/6f/88/zD2UioFn_o.png" alt="在这里插入图片描述"></td><td>Sqrt(dstLocal, srcLocal, 512);</td></tr><tr><td>Ln</td><td>按元素取自然对数</td><td><img src="https://images2.imgbox.com/9c/3e/4f4Z4ib6_o.png" alt="在这里插入图片描述"></td><td>Ln(dstLocal, srcLocal, 512);</td></tr><tr><td>Add</td><td>按元素求和</td><td><img src="https://images2.imgbox.com/72/a0/JmgmQpl9_o.png" alt="在这里插入图片描述"></td><td>Add(dstLocal, src0Local, src1Local, 512);</td></tr><tr><td>Mul</td><td>按元素求积</td><td><img src="https://images2.imgbox.com/e9/8b/8I2C8Ko8_o.png" alt="在这里插入图片描述"></td><td>Mul(dstLocal, src0Local, src1Local, 512);</td></tr><tr><td>Adds/Muls</td><td>矢量内每个element与标量求和/积</td><td>同上</td><td>Adds(dstLocal, srcLocal, half(2), 512);</td></tr><tr><td>Sub</td><td>按元素求差</td><td><img src="https://images2.imgbox.com/12/e9/BZFQkNTy_o.png" alt="在这里插入图片描述"></td><td>Sub(dstLocal, src0Local, src1Local, 512);</td></tr><tr><td>Div</td><td>按element求商</td><td><img src="https://images2.imgbox.com/93/ee/kYm5pjHC_o.png" alt="在这里插入图片描述"></td><td>Div(dstLocal, src0Local, src1Local, 512);</td></tr><tr><td>Max</td><td>按element求最大值</td><td><img src="https://images2.imgbox.com/b6/2c/GdLFO0Sp_o.png" alt="在这里插入图片描述"></td><td>Max(dstLocal, src0Local, src1Local, 512);</td></tr><tr><td>Min</td><td>按element求最小值</td><td><img src="https://images2.imgbox.com/06/63/AQp0KZ18_o.png" alt="在这里插入图片描述"></td><td>Min(dstLocal, src0Local, src1Local, 512);</td></tr><tr><td>Duplicate</td><td>将一个变量或一个立即数，复制多次并填充到向量</td><td><img src="https://images2.imgbox.com/4a/3a/65sDB3gU_o.png" alt="在这里插入图片描述"></td><td>Duplicate(dstLocal, half(18.0), 512);</td></tr></tbody></table> 
<p><mark>注意：标量双目指令中没有减法和除法，基础api没有log只有ln。</mark></p> 
<h2><a id="_326"></a>问题</h2> 
<p>一句话，<a href="https://www.hiascend.com/document/detail/zh/CANNCommunityEdition/80RC1alpha002/quickstart/quickstart/quickstart_18_0001.html" rel="nofollow">多看文档</a>，有问题就先去社区搜一下。<code>160001，error code 0</code>这种就直接查代码吧，没有具体原因。</p> 
<h3><a id="1fatal_error_registertilingdata_baseh_No_such_file_or_directory_328"></a>1、fatal error: register/tilingdata_base.h: No such file or directory</h3> 
<p><img src="https://images2.imgbox.com/24/92/Q3W0ZjK2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ca/32/8D9pUHcc_o.png" alt="在这里插入图片描述"><br> 检查一下CANN路径</p> 
<p>其他能稳定复现的bug等我后面遇到了再补充解决办法吧。</p> 
<h2><a id="_334"></a>总结</h2> 
<p>也许，有时歪门邪道比正道更简单。不要被文档和案例限制了，不要问能不能，<mark>跑下试试最快</mark>。<br> 就像adds直接乘标量不好使，那就直接把这个标量填满整个local，直接用张量去计算嘛。而且这样能用的api还更多呢。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f207d1153801f70e174805aa146b94b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# 实现HTTP自承载WebApi服务</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4f8f572462629265a78232d7206e93b9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在windows 11本地搭建RAG数据查询的AI大模型环境</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>