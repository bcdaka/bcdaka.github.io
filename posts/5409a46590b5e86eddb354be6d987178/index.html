<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>前端监控方案sentry整体概览 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/5409a46590b5e86eddb354be6d987178/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="前端监控方案sentry整体概览">
  <meta property="og:description" content="查看PDF​​​​​​​
目 录
1. Sentry介绍 1.1. 编写目的 1.2. 名词定义 2. Sentry监控原理概述 2.1. 常见的性能优化指标及获取方式 2.2. 常见的前端异常及其捕获方式 3. Sentry 整体架构 4. Sentry安装部署 4.1. 前提条件 4.2. 安装 5. Sentry环境配置 5.1. 初始化配置 5.2. 应用服务配置 6. Sentry项目创建配置 6.1. 前端接入和使用 6.2. 域名解析配置示例 7. 常见问题解决 Sentry介绍 Sentry 是一套开源的实时的异常收集、追踪、监控系统。这套解决方案由对应各种语言的 SDK 和一套庞大的数据后台服务组成，通过 Sentry SDK 的配置，还可以上报错误关联的版本信息、发布环境。同时 Sentry SDK 会自动捕捉异常发生前的相关操作，便于后续异常追踪。异常数据上报到数据服务之后，会通过过滤、关键信息提取、归纳展示在数据后台的 Web 界面中。
编写目的 此文档主要为帮助运维人员了解Sentry系统的原理、架构、配置、运行和维护，以确保软件系统的稳定性和可靠性，为自动化运维相关工作实施提供依据。
名词定义 本文相关名词定义如下：
名称
说明
FP
first paint, 表示页面开始首次绘制的时间点，值越小约好。在 FP 时间点之前，用户看到的是导航之前的页面。
FCP
first contentful paint, lighthouse 面板的六大指标之一，表示首次绘制任何文本、图像、非空白 canvas 或者 SVG 的时间点，值越小约好。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-05T11:37:50+08:00">
    <meta property="article:modified_time" content="2024-02-05T11:37:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">前端监控方案sentry整体概览</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:.0001pt;text-align:left;"><a class="link-info" href="https://download.csdn.net/download/weixin_43860603/88809584" title="查看PDF">查看PDF</a>​​​​​​​</p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>目  </strong><strong>录</strong></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc27376" rel="nofollow">1. Sentry介绍 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc24791" rel="nofollow">1.1. 编写目的 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc13423" rel="nofollow">1.2. 名词定义 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc4205" rel="nofollow">2. Sentry监控原理概述 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc21521" rel="nofollow">2.1. 常见的性能优化指标及获取方式 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc11901" rel="nofollow">2.2. 常见的前端异常及其捕获方式 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc27296" rel="nofollow">3. Sentry 整体架构 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc25010" rel="nofollow">4. Sentry安装部署 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc4352" rel="nofollow">4.1. 前提条件 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc16567" rel="nofollow">4.2. 安装 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc18207" rel="nofollow">5. Sentry环境配置 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc18416" rel="nofollow">5.1. 初始化配置 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc19285" rel="nofollow">5.2. 应用服务配置 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc10699" rel="nofollow">6. Sentry项目创建配置 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc9705" rel="nofollow">6.1. 前端接入和使用 </a></p> 
<p style="margin-left:21pt;text-align:justify;"><a href="#_Toc14017" rel="nofollow">6.2. 域名解析配置示例 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="#_Toc20883" rel="nofollow">7. 常见问题解决 </a></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<ol><li><a name="_Toc27376"></a><strong><strong>Sentry介绍</strong></strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">Sentry 是一套开源的实时的异常收集、追踪、监控系统。这套解决方案由对应各种语言的 SDK 和一套庞大的数据后台服务组成，通过 Sentry SDK 的配置，还可以上报错误关联的版本信息、发布环境。同时 Sentry SDK 会自动捕捉异常发生前的相关操作，便于后续异常追踪。异常数据上报到数据服务之后，会通过过滤、关键信息提取、归纳展示在数据后台的 Web 界面中。</p> 
<ol><li> 
  <ol><li><a name="_Toc24791"></a><strong>编写目的</strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">此文档主要为帮助运维人员了解Sentry系统的原理、架构、配置、运行和维护，以确保软件系统的稳定性和可靠性，为自动化运维相关工作实施提供依据。</p> 
<ol><li> 
  <ol><li><a name="_Toc13423"></a><strong>名词定义</strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">本文相关名词定义如下：</p> 
<table align="center" border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><strong><strong>名称</strong></strong></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:center;"><strong><strong>说明</strong></strong></p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">FP</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">first paint</span>, 表示页面开始首次绘制的时间点，值越小约好。在 FP 时间点之前，用户看到的是导航之前的页面。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">FCP</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">first contentful paint</span>, lighthouse 面板的六大指标之一，表示首次绘制任何文本、图像、非空白 canvas 或者 SVG 的时间点，值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">FMP</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">first meaningful</span> <span style="color:#c00000;">paint</span>, 首次完成有意义内容绘制的时间点，值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">SI</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">speed index</span>, 速度指标, lighthouse 面板中的六大指标之一，用于衡量页面加载期间内容的绘制速度，值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">LCP</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">lagest contentful paint</span>,  lighthouse 面板中的六大指标之一，完成最大内容绘制的时间点，值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">TTI</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">time to ineractive</span>, 可交互时间， lighthouse 面板中的六大指标之一, 用于测量页面从开始加载到主要资源完成渲染，并能够快速、可靠地响应用户输入所需的时间, 值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">TBT</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">total blocking time</span>，总的阻塞时间， lighthouse 面板中的六大指标之一，用于测量FCP到TTI之间的总的阻塞时间，值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">FID</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">first input delay</span>, 首次输入延迟，测量从用户第一次与页面交互（例如当他们单击链接、点按按钮或使用由 JavaScript 驱动的自定义控件）直到浏览器对交互作出响应，并实际能够开始处理事件处理程序所经过的时间，指标的值越小约好。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">CLS</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">Cumulative Layout Shift</span>, 累积布局偏移，用于测量整个页面生命周期内发生的所有意外布局偏移中最大一连串的布局偏移情况，值越小，表示页面视觉越稳定。</p> </td></tr><tr><td style="width:91.1pt;"> <p style="margin-left:.0001pt;text-align:center;"><span style="color:#c00000;">DSN</span></p> </td><td style="vertical-align:top;width:338.5pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">Data Source Name </span>, DSN告诉Sentry SDK 将事件发送到哪里，以便事件与正确的项目相关联。</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">实际在做性能分析时，上面列举的性能指标并不会全部使用。如果是本地通过 <a href="https://developer.chrome.com/docs/lighthouse/overview/" rel="nofollow" title="lighthouse">lighthouse</a> 进行性能分析，会使用6大指标: <span style="color:#c00000;">FCP、LCP、SI、TTI、TBT、CLS</span>。这些指标涵盖了页面渲染、交互和视觉稳定性情况。如果是通过 Sentry 等工具进行性能分析，会使用 4 大指标: <span style="color:#c00000;">FCP、LCP、FID、CLS</span>。这些指标也涵盖了页面渲染、交互、视觉稳定性情况。</p> 
<ol><li><a name="_Toc4205"></a><strong><strong>Sentry监控原理概述</strong></strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">衡量一个<span style="color:#c00000;">站点性能</span>的好坏，我们通常看两个方面: 首屏性能和页面加载以后整个交互的流畅程度。这两个指标的好坏，决定了站点是否可以吸引用户和留住用户。为了能获得好的用户体验，我们常常需要对站点做性能优化。做性能优化，首先要对站点进行性能分析，寻找到底是哪个阶段性能较差，然后具体问题具体分析，找到对应的解决方案。最直接的方式是打开<span style="color:#c00000;">浏览器</span> <span style="color:#c00000;">performance</span><span style="color:#c00000;">、network、lighthouse 面板</span>，然后对页面加载过程进行分析，这是一个有效的办法，但在实际使用时却存在非常大的局限性。也许，我们自己访问站点的时候性能很好，没有什么问题，但用户在实际访问时，由于设备、网络、使用姿势、使用人数、使用时间段、服务吞吐量等原因，整个体验很可能会没有达到我们的预期。这种情况下进行性能分析就非常麻烦了，首先我们无法感知，其次我们也无法在本地直接复现出用户的使用情形。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#c00000;">异常监控</span>的核心作用就是通过上报的异常，帮开发人员及时发现线上问题并快速修复。要达到这个目的，异常监控需要做到以下 3 点: 线上应用出现异常时，可以及时推送给开发人员，安排相关人员去处理。上报的异常，含有异常类型、发生异常的源文件及行列信息、异常的追踪栈信息等详细信息，可以帮助开发人员快速定位问题。可以获取发生异常的用户行为，帮助开发人员、测试人员重现问题和测试回归。这三点，分别对应<span style="color:#c00000;">异常自动推送</span>、<span style="color:#c00000;">异常详情获取</span>、<span style="color:#c00000;">用户行为获取</span>。</p> 
<p style="margin-left:.0001pt;text-align:left;">这个时候，我们可以借助监控工具来处理这个问题，如 Sentry这类工具，可以在用户访问站点时，将<span style="color:#c00000;">性能指标数据</span><span style="color:#c00000;">、</span><span style="color:#c00000;">异常详细信息</span>通过接口上报给监控平台。监控平台接收到上报数据以后，对数据做汇总、计算，然后以可视化图表的方式展示。通过这些图表，我们就可以进行性能分析和快速定位问题，找到影响用户体验的因素或帮助开发人员、测试人员重现问题和测试回规，非常方便。</p> 
<ol><li> 
  <ol><li><a name="_Toc21521"></a><strong>常见的性能优化指标及获取方式</strong></li></ol></li></ol> 
<p style="text-align:left;"><span style="background-color:#ffffff;">做性能分析，不管是在本地，还是通过工具，最重要的是要有数据支撑。目前，w3c 对性能相关数据，已经有了详尽的分类标准和与之配套的获取方式。详细分析常用的性能优化指标以及获取指标数据的方式。页面加载过程模型如下图：</span><img alt="" height="720" src="https://images2.imgbox.com/78/6c/j4jrzH4M_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">这个加载过程模型，是<a href="https://link.juejin.cn/?target=https://www.w3.org/webperf/" rel="nofollow" title="web性能工作组">web性能工作组</a>早在 2012 年就针对页面加载过程制定的，定义了从上一个页面结束，到下一个页面从开始加载到完成加载的整个过程。基于这个模型，我们可以获取到页面加载过程中各个阶段的耗时情况，然后分析出页面加载性能。</p> 
<p style="margin-left:.0001pt;text-align:left;">通过 window.performance.timing 这个接口获取加载过程模型中各个阶段的耗时数据：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> timing = window.performance.timing;    </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;">// 返回数据格式  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">{    </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    navigationStart,  </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 同一个浏览器上下文中，上一个文档结束时的时间戳。如果没有上一个文档，这个值会和 fetchStart 相同。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    unloadEventStart,  </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 上一个文档 unload 事件触发时的时间戳。如果没有上一个文档，为 0。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    unloadEventEnd, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 上一个文档 unload 事件结束时的时间戳。如果没有上一个文档，为 0。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    redirectStart, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 表示第一个 http 重定向开始时的时间戳。如果没有重定向或者有一个非同源的重定向，为 0。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    redirectEnd, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 表示最后一个 http 重定向结束时的时间戳。如果没有重定向或者有一个非同源的重定向，为 0。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    fetchStart, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 表示浏览器准备好使用 http 请求来获取文档的时间戳。这个时间点会在检查任何缓存之前。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    domainLookupStart, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 域名查询开始的时间戳。如果使用了持久连接或者本地有缓存，这个值会和 fetchStart 相同。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    domainLookupEnd, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 域名查询结束的时间戳。如果使用了持久连接或者本地有缓存，这个值会和 fetchStart 相同。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    connectStart, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// http 请求向服务器发送连接请求时的时间戳。如果使用了持久连接，这个值会和 fetchStart 相同。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    connectEnd, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 浏览器和服务器之前建立连接的时间戳，所有握手和认证过程全部结束。如果使用了持久连接，这个值会和 fetchStart 相同。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    secureConnectionStart, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 浏览器与服务器开始安全链接的握手时的时间戳。如果当前网页不要求安全连接，返回 0。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    requestStart, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 浏览器向服务器发起 http 请求(或者读取本地缓存)时的时间戳，即获取 html 文档。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    responseStart, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 浏览器从服务器接收到第一个字节时的时间戳。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    responseEnd, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// 浏览器从服务器接受到最后一个字节时的时间戳。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    domLoading, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// dom 结构开始解析的时间戳，document.readyState 的值为 loading。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    domInteractive, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// dom 结构解析结束，开始加载内嵌资源的时间戳，document.readyState 的状态为 interactive。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    domContentLoadedEventStart, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// DOMContentLoaded 事件触发时的时间戳，所有需要执行的脚本执行完毕。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    domContentLoadedEventEnd,  </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// DOMContentLoaded 事件结束时的时间戳  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    domComplete, </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// dom 文档完成解析的时间戳， document.readyState 的值为 complete。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    loadEventStart, </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// load 事件触发的时间。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    loadEventEnd </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// load 时间结束时的时间。  </span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">}    </span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">window.performance.timing 已被废弃，改用 window.performance.getEntriesByType('navigation')。window.performance.timing，返回的是一个 UNIX 类型的绝对时间，和用户的系统时间相关，分析的时候需要再次计算。而新的 api，返回的是一个相对时间，可以直接用来分析，非常方便。</p> 
<ol><li><strong>页面何时开始渲染 - FP &amp; FCP</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">FP, first paint,</span> 表示页面开始首次绘制的时间点，值越小约好。在FP时间点之前，用户看到的是导航之前的页面。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">FCP, first contentful paint, lighthouse</span> 面板的六大指标之一，表示首次绘制任何文本、图像、非空白canvas或者SVG的时间点，值越小约好。</p> 
<p style="margin-left:.0001pt;text-align:left;">指标可以通过以下接口performance.getEntry、performance.getEntriesByName、performanceObserver 来获取示例如下：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">performance.getEntries().filter(item =&gt; item.name === </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'first-paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">)[0];  </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 获取 FP 时间</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">performance.getEntries().filter(item =&gt; item.name === </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'first-contentful-paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">)[0];  </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 获取 FCP 时间</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">performance.getEntriesByName(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'first-paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">); </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 获取 FP 时间</span></span>   </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">performance.getEntriesByName(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'first-contentful-paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">);  </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// 获取 FCP 时间</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;">// 也可以通过 performanceObserver 的方式获取</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> observer = </span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>new</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> PerformanceObserver(</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>function</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">(list, obj) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> entries = list.getEntries();  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    entries.forEach(item =&gt; {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">        <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>if</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> (item.name === </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'first-paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">            ...  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">        <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>if</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> (item.name === </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'first-contentful-paint'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">            ...  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    })  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">});  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">observer.observe({type: </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">});  </span></span></span></li></ol> 
<ol><li><strong>页面何时渲染主要内容 - FMP &amp; SI &amp; LCP</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">FMP</span><span style="color:#c00000;">, </span><span style="color:#c00000;">first meaningful paint</span><span style="color:#c00000;">, </span>首次完成有意义内容绘制的时间点，值越小约好。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">SI, speed index,</span> 速度指标, lighthouse 面板中的六大指标之一，用于衡量页面加载期间内容的绘制速度，值越小约好。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">LCP</span><span style="color:#c00000;">, </span><span style="color:#c00000;">lagest contentful paint</span><span style="color:#c00000;">, </span>lighthouse 面板中的六大指标之一，完成最大内容绘制的时间点，值越小约好。</p> 
<p style="margin-left:.0001pt;text-align:left;">FMP,是一个已经废弃的性能指标。在实践过程中，由于FMP对页面加载的微小差异过于敏感，经常会出现结果不一致的情况，因此性能分析的时候不再使用这个指标。</p> 
<p style="margin-left:.0001pt;text-align:left;">SI和FMP一样，官方也没有提供有效的获取接口，只能通过lighthouse面板来查看，不作为Sentry 等工具做性能分析的指标。</p> 
<p style="margin-left:.0001pt;text-align:left;">通过 performanceObserver 这个接口，我们可以获取到 LCP 指标数据：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>new</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> PerformanceObserver((entryList) =&gt; {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>for</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> (</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>const</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> entry of entryList.getEntries()) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        console.log(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'LCP candidate:'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">, entry.startTime, entry);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">}).observe({type: </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'largest-contentful-paint'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">, buffered: </span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>true</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;">}); </span></span></span></li></ol> 
<ol><li style="text-align:left;"><strong>何时可以交互 - TTI &amp; TBT</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">衡量页面何时可以交互，有两个指标: TTI 和 TBT。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">TTI, time to ineractive</span>, 可交互时间， lighthouse 面板中的六大指标之一, 用于测量页面从开始加载到主要资源完成渲染，并能够快速、可靠地响应用户输入所需的时间, 值越小约好。</p> 
<p style="margin-left:.0001pt;text-align:left;">和 FMP、SI 一样，官方并没有提供获取 TTI 的有效接口，只能通过 lighthouse 面板来查看，不会作为 Sentry 做性能分析的指标。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">TBT,</span><span style="color:#c00000;"> total blocking time</span>, 总的阻塞时间， lighthouse 面板中的六大指标之一，用于测量 FCP 到 TTI 之间的总的阻塞时间，值越小约好。和 TTI 一样，官方也没有提供获取 TBT 的有效接口，只能通过 lighthouse 面板来查看，不会作为 Sentry 做性能分析的指标。</p> 
<ol><li><strong>交互是否有延迟 - FID &amp; MPFID &amp; Long Task</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">衡量交互是否有延迟，有3个指标: FID、MPFID、Long Task。其中，FID和MPFID可用来衡量用户首次交互延迟的情况，Long Task用来衡量用户在使用应用的过程中遇到的延迟、阻塞情况。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">FID</span><span style="color:#c00000;">, </span><span style="color:#c00000;">first input delay, </span>首次输入延迟，测量从用户第一次与页面交互（例如当他们单击链接、点按按钮或使用由 JavaScript 驱动的自定义控件）直到浏览器对交互作出响应，并实际能够开始处理事件处理程序所经过的时间。FID 指标的值越小约好。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">MPFID, Max Potential First Input Delay</span>，最大潜在首次输入延迟，用于测量用户可能遇到的最坏情况的首次输入延迟。和FMP一样，这个指标已经被废弃不再使用。</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">Long Task</span>，衡量用户在使用过程中遇到的交互延迟、阻塞情况。这个指标，可以告诉我们哪些任务执行耗费了 50ms 或更多时间。</p> 
<p style="margin-left:.0001pt;text-align:left;">通过 performanceObserver，我们可以获取到 FID 指标数据示例如下：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>new</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> PerformanceObserver((entryList) =&gt; {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>for</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> (</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>const</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> entry of entryList.getEntries()) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>const</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> delay = entry.processingStart - entry.startTime;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    console.log(</span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'FID candidate:'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">, delay, entry);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">}).observe({type: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'first-input'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">, buffered: </span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>true</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">}); </span></span></span></li></ol> 
<ol><li><strong>页面视觉是否有稳定 - CLS</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">衡量页面视觉是否稳定，有 1 个指标: CLS</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#c00000;">CLS, Cumulative Layout Shift</span>, 累积布局偏移，用于测量整个页面生命周期内发生的所有意外布局偏移中最大一连串的布局偏移情况。CLS, 值越小，表示页面视觉越稳定。</p> 
<p style="margin-left:.0001pt;text-align:left;">通过 performanceObserver，我们可以获取到 CLS 指标数据示例如下：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>new</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> PerformanceObserver(</span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>function</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;">(list) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> perfEntries = list.getEntries();  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>for</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> (</span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> i = 0; i &lt; perfEntries.length; i++) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        ...  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">})observe({type: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'layout-shift'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">, buffered: </span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>true</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">});  </span></span></span></li></ol> 
<p><strong>Sentry性能监控原理</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">简单来说，就是通过 window.performance.getEntries 和 performanceObserver 这两个 api，获取用户在使用应用过程中涉及的 load 相关、fcp、lcp、fid、cls 等指标数据，然后通过接口上报。监控平台拿到数据以后，通过可视化图标的方式展示性能指标数据，帮助我们分析。</p> 
<ol><li> 
  <ol><li style="text-align:left;"><a name="_Toc11901"></a><strong>常见的前端异常及其捕获方式</strong></li></ol></li><li style="text-align:left;"><strong>JS代码执行时异常</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">js代码执行异常，是最常遇到的异常。这一类型的异常，又可以具体细分为:Error，最基本的错误类型，其他的错误类型都继承自该类型。</p> 
<ul><li style="text-align:left;"><span style="color:#c00000;">RangeError</span>: <span style="color:#c00000;">范围错误</span>。当出现堆栈溢出(递归没有终止条件)、数值超出范围(new Array 传入负数或者一个特别大的整数)情况时会抛出这个异常。</li><li style="text-align:left;"><span style="color:#c00000;">ReferenceError</span>，<span style="color:#c00000;">引用错误</span>。当一个不存在的对象被引用时发生的异常。</li><li style="text-align:left;"><span style="color:#c00000;">SyntaxError</span>，<span style="color:#c00000;">语法错误</span>。如变量以数字开头；花括号没有闭合等。</li><li style="text-align:left;"><span style="color:#c00000;">TypeError</span>，<span style="color:#c00000;">类型错误</span>。如把 number 当 str 使用。</li><li style="text-align:left;"><span style="color:#c00000;">URIError</span>，<span style="color:#c00000;">向全局 URI 处理函数传递一个不合法的 URI 时，就会抛出这个异常</span>。如使用decodeURI('%')、decodeURIComponent('%')。</li><li style="text-align:left;"><span style="color:#c00000;">EvalError</span>， <span style="color:#c00000;">一个关于 eval 的异常</span>，不会被 javascript 抛出。</li></ul> 
<p style="margin-left:.0001pt;text-align:left;">通常，我们会通过 try...catch 语句块来捕获这一类型异常。如果不使用 try...catch，我们也可以通过 window.onerror = callback 或者 window.addEventListener('error', callback) 的方式进行全局捕获。</p> 
<ol><li style="text-align:left;"><strong>Promise类型异常</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">在使用promise时，如果promise被reject但没有做catch处理时，就会抛出promise类异常。</p> 
<ol><li style="text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">Promise.reject(); // Uncaught (in promise) undefined  </span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">promise 类型的异常无法被 try...catch 捕获，也无法被 window.onerror = callback 或者 window.addEventListener('error', callback) 的方式全局捕获。针对这一类型的异常, 我们需要通过window.onrejectionhandled = callback 或者 window.addListener('rejectionhandled'， callback) 的方式去全局捕获。</p> 
<ol><li style="text-align:left;"><strong>资源加载类型异常</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">如果我们页面的img、js、css 等资源链接失效，就会提示资源类型加载如异常。如果我们页面的img、js、css 等资源链接失效，就会提示资源类型加载如异常。</p> 
<ol><li style="text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">&lt;img src=</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"localhost:3000/data.png"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;"> /&gt; </span></span><span style="background-color:#ffffff;"><span style="color:#008200;">// Get localhost:3000/data.png net::ERR_FILE_NOT_FOUND</span></span>  </span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">针对这一类的异常，我们可以通过 window.addEventListener('error', callback, true) 的方式进行全局捕获，使用window.onerror = callback的方式是无法捕获静态资源类异常的。原因是资源类型错误没有冒泡，只能在捕获阶段捕获，而window.onerror是通过在冒泡阶段捕获错误，对静态资源加载类型异常无效，所以只能借助 window.addEventListener('error', callback, true) 的方式捕获。</p> 
<ol><li style="text-align:left;"><strong>接口请求类型异常</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">在浏览器端发起一个接口请求时，如果请求的 url 的有问题，也会抛出异常。</p> 
<p style="margin-left:.0001pt;text-align:left;">不同的请求方式，异常捕获方式也不相同:</p> 
<ul><li style="text-align:left;">接口调用是通过 fetch 发起的</li></ul> 
<p style="margin-left:.0001pt;text-align:left;">我们可以通过 fetch(url).then(callback).catch(callback) 的方式去捕获异常。</p> 
<ul><li style="text-align:left;">接口调用通过 xhr 实例发起</li></ul> 
<p style="margin-left:.0001pt;text-align:left;">如果是 xhr.open 方法执行时出现异常，可以通过 window.addEventListener('error', callback) 或者 window.onerror 的方式捕获异常。</p> 
<ol><li style="text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">xhr.open(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'GET'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">, </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"https://"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">)  // Uncaught DOMException: Failed to execute </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'open'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;"> on </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'XMLHttpRequest'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">: Invalid URL </span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">at ....  </span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">如果是 xhr.send 方法执行时出现异常，可以通过 xhr.onerror 或者 xhr.addEventListener('error', callback) 的方式捕获异常。</p> 
<ol><li style="text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">xhr.open(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'get'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">， </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'/user/userInfo'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">);  </span></span></span></li><li style="text-align:left;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">xhr.send();  </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">// send localhost:3000/user/userinfo net::ERR_FAILED</span></span>  </span></li></ol> 
<ol><li style="text-align:left;"><strong>跨域脚本执行异常</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">当项目中引用的第三方脚本执行发生错误时，会抛出一类特殊的异常。这类型异常和之前讲过的异常都不同，它的msg只有 'Script error' 信息，没有具体的行、列、类型信息。之以会这样，是因为浏览器的安全机制: 浏览器只允许同域下的脚本捕获具体异常信息，跨域脚本中的异常，不会报告错误的细节。针对这类型的异常，我们可以通过 window.addEventListener('error', callback) 或者 window.onerror 的方式捕获异常。</p> 
<p style="margin-left:.0001pt;text-align:left;">如果我们想获取这类异常的详情，需要做以下两个操作:</p> 
<ul><li style="text-align:left;">在发起请求的 script 标签上添加 crossorigin="anonymous"</li><li style="text-align:left;">请求响应头中添加 Access-Control-Allow-Origin: *</li></ul> 
<p style="margin-left:.0001pt;text-align:left;">这样就可以获取到跨域异常的细节信息了。</p> 
<p><strong>Sentry异常监控原理</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">为了能自动捕获应用异常，Sentry劫持覆写了window.onerror和window.unhandledrejection这两个api。劫持覆写 window.onerror 的代码如下:</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">oldErrorHandler = window.onerror;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">window.onerror = </span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>function</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> (msg, url, line, column, error) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <span style="background-color:#ffffff;"><span style="color:#008200;">// 收集异常信息并上报</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    triggerHandlers(</span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'error'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">, {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        column: column,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        error: error,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        line: line,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        msg: msg,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        url: url,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    });  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>if</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> (oldErrorHandler) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">        <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>return</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> oldErrorHandler.apply(</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>this</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">, arguments);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>return</strong></span></span></strong> <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>false</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">};</span></span>  </span></li></ol> 
<p style="margin-left:10.5pt;text-align:left;">劫持覆写 window.unhandledrejection 的代码如下:</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">oldOnUnhandledRejectionHandler = window.onunhandledrejection;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">window.onunhandledrejection = </span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>function</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> (e) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <span style="background-color:#ffffff;"><span style="color:#008200;">// 收集异常信息并上报</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    triggerHandlers(</span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'unhandledrejection'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">, e);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>if</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> (oldOnUnhandledRejectionHandler) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">        <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>return</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> oldOnUnhandledRejectionHandler.apply(</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>this</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">, arguments);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>return</strong></span></span></strong> <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>true</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">};  </span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">虽然通过劫持覆写 window.onerror和window.unhandledrejection已足以完成异常自动捕获，但为了能获取更详尽的异常信息, Sentry 在内部做了一些更细微的异常捕获。具体来说，就是 Sentry 内部对异常发生的特殊上下文，做了标记。这些特殊上下文包括: dom节点事件回调、setTimeout / setInterval 回调、xhr 接口调用、requestAnimationFrame 回调等。举个例子，如果是click事件的handler中发生了异常， Sentry会捕获这个异常，并将异常发生时的事件name、dom节点描述、handler函数名等信息上报。</p> 
<ol><li><a name="_Toc27296"></a><strong><strong>Sentry 整体架构</strong></strong><img alt="" height="720" src="https://images2.imgbox.com/f6/cd/0s2pfNc9_o.png" width="1200"></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">从上到下：</p> 
<ol><li style="text-align:left;">第一层</li></ol> 
<ul><li style="text-align:left;">Load Balancer（负载均衡器）负责路由转发。错误上报转发到 /api/\d+/store 。这一层承担数据入口。</li></ul> 
<ol><li style="text-align:left;">第二层</li></ol> 
<ul><li style="text-align:left;">Sentry Web主要跟配置等持久化数据打交道，创建项目、权限控制、限流分配等都是它负责。查询搜索错误消息、Dashboard 聚合等功能则是 Snuba 承担，由它来当翻译官，把用户查询条件转化为 SQL 语句发给 ClickHouse。</li></ul> 
<ol><li style="text-align:left;">第三层</li></ol> 
<ul><li style="text-align:left;">Relay 负责消息中继转发，并把数据先汇集到 Kafka。</li><li style="text-align:left;">Snuba 负责接收 SentryWeb 的请求，进行数据的聚合、搜索。</li><li style="text-align:left;">Sentry Worker 则是一个队列服务，主要负责数据的存储。</li></ul> 
<ol><li style="text-align:left;">第四层</li></ol> 
<ul><li style="text-align:left;">Kafka 作为消息队列。</li><li style="text-align:left;">ClickHouse 负责实时的数据分析。</li><li style="text-align:left;">Redis 和 Memcached 负责项目配置、错误基础信息的存储和统计。</li><li style="text-align:left;">Postgres 承担基础数据持久化（主要是项目、用户权限管理等）。</li><li style="text-align:left;">Symbolicator 主要用于错误信息格式化。</li></ul> 
<ol><li style="text-align:left;">第五层</li></ol> 
<ul><li style="text-align:left;">最底下的 Zookeeper 是 Kafka 用于节点信息同步，如果我们设置了多个 ClickHouse 节点，也可以用它来保存主从同步信息或者做分布式表。</li></ul> 
<ol><li><a name="_Toc25010"></a><strong><strong>Sentry安装部署</strong></strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">Sentry 的管理后台是基于 Python Django 开发的。这个管理后台由背后的 Postgres 数据库（管理后台默认的数据库）、ClickHouse（存数据特征的数据库）、relay、kafka、redis 等一些基础服务或由 Sentry 官方维护的总共 23 个服务支撑运行。可见的是，如果独立的部署和维护这 23 个服务将是异常复杂和困难的。幸运的是，官方提供了基于 docker 镜像的一键部署实现。<u><u>具体落地方案可将sentry应用单机单节点部署在某一台独立服务器上，保证各环境数据上报网络通畅即可，具体环境和项目可以通过设置合理规范的前缀名区分，重要项目数据需要设置定时备份策略。</u></u></p> 
<ol><li> 
  <ol><li style="text-align:left;"><a name="_Toc4352"></a><strong>前提条件 </strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">部署 Sentry的实例要求最低配置如下:</p> 
<ul><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#212529;">Docker 19.03.6+</span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#212529;">Docker-Compose 1.28.0+</span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#212529;">4 CPU Cores</span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#212529;">8 GB RAM</span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="color:#212529;">20 GB Free Disk Space</span></span></li></ul> 
<p style="margin-left:.0001pt;text-align:left;">示例操作系统：Debian 10.3</p> 
<ol><li> 
  <ol><li><a name="_Toc16567"></a><strong>安装</strong></li></ol></li></ol> 
<h4 style="text-align:left;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>第1步 - 安装docker</strong></span></span></strong></span></h4> 
<p style="margin-left:.0001pt;text-align:left;">准备docker.service系统配置文件</p> 
<p style="margin-left:.0001pt;text-align:left;">touch /opt/docker.service </p> 
<p style="margin-left:.0001pt;text-align:left;">vi /opt/docker.service  </p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">[Unit]  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">Description=Docker Application Container Engine   </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">Documentation=https:</span></span><span style="background-color:#ffffff;"><span style="color:#008200;">//docs.docker.com</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">After=network-online.target firewalld.service  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">Wants=network-online.target  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">   </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">[Service]  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">Type=notify  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># the default is not to use systemd for cgroups because the delegate issues still</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;"># exists and systemd currently does not support the cgroup feature set required</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># for containers run by docker</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">ExecStart=/usr/bin/dockerd  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">ExecReload=/bin/kill -s HUP $MAINPID  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">LimitNOFILE=infinity  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">LimitNPROC=infinity  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">LimitCORE=infinity  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># Uncomment TasksMax if your systemd version supports it.</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;"># Only systemd 226 and above support this version.</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;">#TasksMax=infinity</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">TimeoutStartSec=0  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">Delegate=yes  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># kill only the docker process, not all processes in the cgroup</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">KillMode=process  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># restart the docker process if it exits prematurely</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">Restart=on-failure  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">StartLimitBurst=3  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">StartLimitInterval=60s  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">   </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">[Install]  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">WantedBy=multi-user.target </span></span> </span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">编写并执行安装shell脚本：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;">#.</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">1</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">.</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">e</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">nable-ip-forward</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo sed -i </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'s/^net.ipv4.ip_forward.*/net.ipv4.ip_forward=1/g'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;"> /etc/sysctl.conf  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo cat /etc/sysctl.conf | grep </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"^net.ipv4.ip_forward"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;"> &gt; /dev/</span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>null</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> || echo </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"net.ipv4.ip_forward=1"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;"> &gt;&gt; /etc/sysctl.conf  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo /sbin/sysctl -p /etc/sysctl.conf  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"> </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;">#.</span></span><span style="background-color:#f8f8f8;"><span style="color:#808080;">2</span></span><span style="background-color:#f8f8f8;"><span style="color:#808080;">.</span></span><span style="background-color:#f8f8f8;"><span style="color:#808080;">s</span></span><span style="background-color:#f8f8f8;"><span style="color:#808080;">etup-docker-ce</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo curl -L https:</span></span><span style="background-color:#ffffff;"><span style="color:#008200;">//download.docker.com/linux/static/stable/x86_64/docker-20.10.8.tgz -o /opt/docker-20.10.8.tgz</span></span>   </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo tar -xvf /opt/docker-20.10.8.tgz --directory=/opt/  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo mv /opt/docker/* /usr/bin/  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo mv /opt/docker.service /etc/systemd/system/  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo rm -rf /opt/docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo chmod +x /etc/systemd/system/docker.service  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo systemctl daemon-reload  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo systemctl start docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo systemctl is-active docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"> </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;">#.</span></span><span style="background-color:#f8f8f8;"><span style="color:#808080;">3</span></span><span style="background-color:#f8f8f8;"><span style="color:#808080;">.set-on-start</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo systemctl enable docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo systemctl is-enabled docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"> </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;">#################################################################</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;">#.</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">4.d</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">o</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">-</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">it</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">-</span></span><span style="background-color:#ffffff;"><span style="color:#808080;">again</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;"># systemctl stop docker</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># systemctl disable docker.service</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;"># rm -rf /opt/{docker,docker.service}</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># rm -f /etc/systemd/system/docker.service</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#808080;"># rm -f /usr/bin/{docker*,containerd*,ctr,runc}</span></span>  </span></li></ol> 
<h4 style="text-align:left;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>第2步 - 安装docker-compose</strong></span></span></strong></span></h4> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo curl -L </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;"> -o /usr/local/bin/docker-compos</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">e</span></span> </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">sudo chmod +x /usr/bin/docker-compose  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">sudo docker-compose --version  </span></span></span></li></ol> 
<h4 style="text-align:left;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>第3步 - 安装sentry</strong></span></span></strong></span></h4> 
<ol><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">#</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">将</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">一键部署项目</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">onpremise的源代码克隆到工作台目录</span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">mkdir -p /data/app/ &amp;&amp; cd /data/app/</span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">git clone </span></span><a href="https://github.com/getsentry/onpremise.git" title="GitHub - getsentry/self-hosted: Sentry, feature-complete and packaged up for low-volume deployments and proofs-of-concept">GitHub - getsentry/self-hosted: Sentry, feature-complete and packaged up for low-volume deployments and proofs-of-concept</a></span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>onpremise部署主要文件结构和作用：</strong></span></span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;">clickhouse/config.xml：clickhouse 配置文件</p> 
<p style="margin-left:.0001pt;text-align:left;">cron/：定时任务的镜像构建配置和启动脚本</p> 
<p style="margin-left:.0001pt;text-align:left;">nginx/nginx.conf：nginx 配置</p> 
<p style="margin-left:.0001pt;text-align:left;">relay/config.example.yml：relay 服务配置文件</p> 
<p style="margin-left:.0001pt;text-align:left;">sentry/：sentry-onpremise-local镜像的构建和基于此镜像启动的主服务的配置都在这个文件夹下</p> 
<ul><li style="text-align:left;">Dockerfile：sentry-onpremise-local 的镜像构建配置，会以此启动很多服务</li><li style="text-align:left;">requirements.example.txt：由此生成 requirements.txt，需要额外安装的 Django 插件需要被写在这里面</li><li style="text-align:left;">config.example.yml：由此生成 config.yml，一般放运行时不能通过管理后台修改的配置</li><li style="text-align:left;">sentry.conf.example.py：由此生成 sentry.conf.py，为 python 代码，覆盖或合并至 sentry 服务中，从而影响 sentry 运行。</li></ul> 
<p style="margin-left:.0001pt;text-align:left;">.env：镜像版本、数据保留天数、端口等配置</p> 
<p style="margin-left:.0001pt;text-align:left;">docker-compose.yml：Compose工具配置，多docker的批量配置和启动设置</p> 
<p style="margin-left:.0001pt;text-align:left;">install.sh：Sentry 一键部署流程脚本</p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>执行一键部署脚本：</strong></span></span></strong></p> 
<ol><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">cd onpremise  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;"># 直接运行 ./install.sh 将 Sentry 及其依赖都通过 docker 安装  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">./install.sh </span></span> </span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">执行onpremise的根路径下install.sh此即可完成快速部署，脚本运行的过程中，大致会经历以下步骤：</p> 
<ol><li style="text-align:left;">环境检查</li><li style="text-align:left;">生成服务配置</li><li style="text-align:left;">docker volume 数据卷创建（可理解为 docker 运行的应用的数据存储路径的创建）</li><li style="text-align:left;">拉取和升级基础镜像</li><li style="text-align:left;">构建镜像</li><li style="text-align:left;">服务初始化</li><li style="text-align:left;">设置管理员账号（如果跳过此步，可手动创建）</li></ol> 
<p style="margin-left:.0001pt;text-align:left;">在执行结束后，会提示创建完毕，运行 docker-compose up -d 启动服务<img alt="" height="578" src="https://images2.imgbox.com/cc/64/BWJVh7Y2_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>删除服务：</strong></span></span></strong></p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 停止所有运行</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">docker-compose down  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 移除所有 volume</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">docker volume prune  </span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;"><strong><span style="background-color:#ffffff;"><span style="color:#4f4f4f;"><strong>重启服务：</strong></span></span></strong></p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 关闭服务</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">docker-compose down  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 启动服务</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">docker-compose up -d  </span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<ol><li><a name="_Toc18207"></a><strong><strong>Sentry环境配置</strong></strong> 
  <ol><li><a name="_Toc18416"></a><strong>初始化配置 </strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">第一次访问管理后台，可以看到欢迎页面，完成必填项的配置，即可正式访问管理后台。<img alt="" height="628" src="https://images2.imgbox.com/63/a9/7MvZlCoQ_o.png" width="1200"></p> 
<p><img alt="" height="522" src="https://images2.imgbox.com/6b/e0/ZyrfQP57_o.png" width="1200"></p> 
<ol><li style="text-align:left;">Root URL：异常上报接口的公网根地址（在做网络解析配置时，后台服务可以配置到内网外网两个域名，只将上报接口的解析规则 /api/[id]/store/ 配置到公网环境，保证数据不会泄密）。</li><li style="text-align:left;">Admin Email：在 install.sh 阶段创建的管理员账号。</li></ol> 
<p><img alt="" height="657" src="https://images2.imgbox.com/f5/3b/jIVymBDI_o.png" width="1200"></p> 
<ol><li style="text-align:left;">Outbound email：这部分内容为邮件服务配置，可以先不配置。</li><li style="text-align:left;">设置语言和时区</li></ol> 
<p style="margin-left:.0001pt;text-align:left;">Sentry部署成功之后，我们可以进行一些设置。点击头像【User settings】 -【 Account Details】来设置语言何时区等</p> 
<p><img alt="" height="628" src="https://images2.imgbox.com/65/0c/Bfs41Sza_o.png" width="1200"></p> 
<ol><li> 
  <ol><li><a name="_Toc19285"></a><strong>应用服务配置</strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">一键部署的 Sentry 服务总会有不符合我们使用和维护设计的地方，需要通过对部署配置的修改来满足自己的需求。</p> 
<ol><li><strong>D</strong><strong>ocker数据存储位置修改</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">在服务运行的过程中，会在docker volume数据卷挂载位置存储数据，如Postgres、运行日志等，docker volume默认挂载在/var目录下，如果你的/var目录容量较小，随着服务的运行会很快占满，需要对docker volume挂载目录进行修改。</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># 在容量最大的目录下创建文件夹</span></span> </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">mkdir -p /data/</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">/lib/  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># 停止 docker 服务</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">systemctl stop docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># 将 docker 的默认数据复制到新路径下，删除旧数据并创建软连接，即使得存储实际占用磁盘为新路径</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">/bin/cp -a /</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">/lib/docker /data/</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">/lib/docker &amp;&amp; rm -rf /</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">/lib/docker &amp;&amp;  ln -s /data/</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">/lib/docker /</span></span><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>var</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;">/lib/docker  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#808080;"># 重启 docker 服务</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">systemctl start docker </span></span> </span></li></ol> 
<ol><li><strong>使用独立数据库确保数据稳定性</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">在数据库单机化部署的情况下，一旦出现机器故障，数据会损坏丢失，而onpremise的一键部署就是以 docker的形式单机运行的数据库服务，且数据库数据也存储在本地。可以看到 Sentry 的数据库有两个，Postgres和ClickHouse。虽然Sentry不是业务应用，在宕机后不影响业务正常运行，数据的稳定并不是特别重要，但是Postgres中存储了接入Sentry的业务应用的id和token与对应关系，在这些数据丢失后，业务应用必须要修改代码以修改 token 重新上线。为了避免这种影响，且公司有现成的可容灾和定期备份的Postgres数据库，所以将数据库切换为外部数据库。</p> 
<p style="margin-left:.0001pt;text-align:left;">修改 sentry.conf.example.py 文件中 DATABASES 变量即可：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">DATABASES = {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  <span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'default'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">: {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <span style="background-color:#ffffff;"><span style="color:#0000ff;">'ENGINE'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">: </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'sentry.db.postgres'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'NAME'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'数据库名'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <span style="background-color:#ffffff;"><span style="color:#0000ff;">'USER'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">: </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'数据库用户名'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'PASSWORD'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'数据库密码'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <span style="background-color:#ffffff;"><span style="color:#0000ff;">'HOST'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">: </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'数据库域名'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'PORT'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'数据库端口号'</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">}</span></span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">将Postgres相关信息从docker-compose.yml文件中删除：</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">depends_on:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    - redis  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    - postgres </span></span><span style="background-color:#ffffff;"><span style="color:#008200;"># 删除</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#008200;"># ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">services:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#008200;"># ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 删除开始</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">  postgres:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    &lt;&lt; : *restart_policy  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    image: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'postgres:14.5'</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    environment:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">      POSTGRES_HOST_AUTH_METHOD: </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'trust'</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    volumes:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">      - </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">'sentry-postgres:/var/lib/postgresql/data'</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 删除结束</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#008200;"># ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">volumes:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">  sentry-data:  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    external: </span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>true</strong></span></span></strong>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">  sentry-postgres: </span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;"># 删除</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    external: </span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>true</strong></span></span></strong> <span style="background-color:#ffffff;"><span style="color:#008200;"># 删除</span></span>  </span></li></ol> 
<ol><li><strong>控制磁盘占用</strong></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">随着数据的上报，服务器本地的磁盘占用和数据库大小会越来越大，按照 Sentry 定时数据任务的配置保留90天来说，全量接入后磁盘占用会维持在一个比较大的值，同时这么大的数据量对数据的查询也是一个负担。为了减轻负担，需要从服务端和业务应用端同时入手。根据实际情况可以将数据保留时长改为30天或者7天等更短时长。</p> 
<ul><li style="text-align:justify;">修改 .env 文件：</li></ul> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">SENTRY_EVENT_RETENTION_DAYS=7  </span></span></span></li></ol> 
<ul><li style="text-align:justify;">手动清除 </li></ul> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 因为cleanup的使用delete命令删除postgresql数据，但postgrdsql对于</span></span>   <span style="background-color:#ffffff;"><span style="color:#008200;">delete, update等操作，只是将对应行标志为DEAD，并没有真正释放磁盘空间。</span></span>    </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 清除 postgres 中的无效数据</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">vacuumdb -U postgres -d postgres -v -f --analyze </span></span> </span></li></ol> 
<ul><li style="text-align:justify;">定期清除</li></ul> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">crontab -e </span></span><span style="background-color:#ffffff;"><span style="color:#008200;"># 使用 crontab 在linux实现定时任务</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;"># 输入</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">0 0 * * *  vacuumdb -U postgres -d postgres -v -f --analyze</span></span></span></li></ol> 
<ol><li><a name="_Toc10699"></a><strong><strong>Sentry项目创建配置</strong></strong> 
  <ol><li><a name="_Toc9705"></a><strong>前端接入和使用</strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;">Sentry中项目接入的类型有很多，以Vue 项目示范:</p> 
<ol><li style="text-align:left;">创建对应团队和项目</li></ol> 
<p><img alt="" height="125" src="https://images2.imgbox.com/5d/3f/HplLjzLK_o.png" width="1200"></p> 
<ol><li style="text-align:left;">选取平台语言创建团队和项目</li></ol> 
<p><img alt="" height="624" src="https://images2.imgbox.com/a2/cc/LmhlYx4d_o.png" width="1200"></p> 
<ol><li style="text-align:left;">接入sentry</li></ol> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">npm i @vue/cli -g  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#008200;"># 初始化vue3项目</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">vue create vue3-sentry  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#008200;"># 安装sentry插件</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">npm install --save @sentry/vue @sentry/tracing </span></span> </span></li></ol> 
<ol><li style="text-align:left;">查看当前项目绑定的 DSN（客户端秘钥）</li></ol> 
<p><img alt="" height="628" src="https://images2.imgbox.com/95/56/zcEPnJ1f_o.png" width="1200"></p> 
<p><img alt="" height="628" src="https://images2.imgbox.com/57/53/Q8XPY92v_o.png" width="1200"></p> 
<ol><li style="text-align:left;">在入口文件main.js中初始化sentry</li></ol> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>import</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> { createApp } from </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"vue"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>import</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> { createRouter } from </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">"vue-router"</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>import</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> * as Sentry from </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"@sentry/vue"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>import</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> { Integrations } from </span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">"@sentry/tracing"</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>const</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> app = createApp({  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  <span style="background-color:#ffffff;"><span style="color:#008200;">// ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">});  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>const</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> router = createRouter({  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  <span style="background-color:#f8f8f8;"><span style="color:#008200;">// ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">});  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">Sentry.init({  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">  app,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  dsn: </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"http://61a3c1c2ac124286ae2a13e0bd0f3824@10.84.4.231:9000/3"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">  integrations: [  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>new</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> Integrations.BrowserTracing({  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">      routingInstrumentation: Sentry.vueRouterInstrumentation(router),  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">      tracingOrigins: [</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"localhost"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">, </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"my-site-url.com"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">, /^\</span></span><span style="background-color:#ffffff;"><span style="color:#008200;">//],</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    }),  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  ],  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  <span style="background-color:#f8f8f8;"><span style="color:#008200;">// Set tracesSampleRate to 1.0 to capture 100%</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  <span style="background-color:#ffffff;"><span style="color:#008200;">// of transactions for performance monitoring.</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  <span style="background-color:#f8f8f8;"><span style="color:#008200;">// We recommend adjusting this value in production</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  tracesSampleRate: 1.0,  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">});  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">app.use(router);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">app.mount(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">"#app"</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">);</span></span> </span></li></ol> 
<ol><li style="text-align:left;">手动模拟一个异常sentry控制台捕获错误</li></ol> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;">// ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">&lt;button @click=</span></span><span style="background-color:#f8f8f8;"><span style="color:#0000ff;">"throwError"</span></span><span style="background-color:#f8f8f8;"><span style="color:#000000;">&gt;Throw error&lt;/button&gt;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#008200;">// ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>export</strong></span></span></strong> <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>default</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  <span style="background-color:#f8f8f8;"><span style="color:#008200;">// ...</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  methods: {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    throwError() {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">      <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>throw</strong></span></span></strong> <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>new</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> Error(</span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'Sentry Error'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">);  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">  }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">}; </span></span> </span></li></ol> 
<ol><li style="text-align:left;">其他的功能，如报警配置、性能监控可以自行探索 
  <ol><li><a name="_Toc14017"></a><strong>域名解析配置示例</strong></li></ol></li></ol> 
<p style="margin-left:.0001pt;text-align:left;">Nginx域名配置模板</p> 
<ol><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">upstream track-web {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    server  ip:9000;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    keepalive 300;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">}  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">server {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    listen 80;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    server_name track.reckfeng.com;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    access_log /data/logs/nginx/external/track.reckfeng.com/track.reckfeng.com.access.log.$log_date main;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    error_log /data/logs/nginx/external/track.reckfeng.com/track.reckfeng.com.error.log error;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    set $upstream </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">'track-web'</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    set $allow </span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>false</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">    <strong><span style="background-color:#f8f8f8;"><span style="color:#006699;"><strong>if</strong></span></span></strong><span style="background-color:#f8f8f8;"><span style="color:#000000;"> ($http_x_forwarded_for ~* ^(101.227.90.131|101.227.90.132|211.144.205.2|101.227.90.208|223.252.222.16|101.37.117.138)) {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        set $allow </span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>true</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">    <strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>if</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> ($allow = </span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>false</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;">) {<!-- --></span></span><strong><span style="background-color:#ffffff;"><span style="color:#006699;"><strong>return</strong></span></span></strong><span style="background-color:#ffffff;"><span style="color:#000000;"> 403;}  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;">  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;">  </span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">    location / {  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        proxy_set_header Connection </span></span><span style="background-color:#ffffff;"><span style="color:#0000ff;">""</span></span><span style="background-color:#ffffff;"><span style="color:#000000;">;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        proxy_http_version 1.1;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        proxy_set_header Host $host;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        proxy_set_header X-real-ip $remote_addr;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">        proxy_pass http:</span></span><span style="background-color:#f8f8f8;"><span style="color:#008200;">//$upstream;</span></span>  </span></li><li style="text-align:justify;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#000000;">    }  </span></span></span></li><li style="text-align:justify;"><span style="background-color:#f8f8f8;"><span style="background-color:#f8f8f8;"><span style="color:#000000;">}</span></span> </span></li></ol> 
<ol><li><a name="_Toc20883"></a><strong><strong>常见问题解决</strong></strong></li></ol> 
<ol><li style="text-align:left;">在开发机管理平台上申请的服务器安装sentry提示访问http://deb.debian.org/debian超时</li></ol> 
<p><img alt="" height="256" src="https://images2.imgbox.com/c4/d9/df31V3ts_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">详细信息显示为执行dockerfile构建容器时在基础镜像上执行apt-get update更新失败</p> 
<p><img alt="" height="197" src="https://images2.imgbox.com/fa/11/n8HAXoJG_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">一般这种问题原因要么是出口ip不在公司白名单里，要么是网络不太对，比如mtu这些有点问题，ip不再白名单需要找it协助，针对原因二需要做以下修改来解决：</p> 
<p style="margin-left:.0001pt;text-align:left;">执行ip a查看本机eth0网卡mtu值</p> 
<p><img alt="" height="323" src="https://images2.imgbox.com/66/71/grJA4DDc_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">按下图提示修改相关配置重启docker后重新执行install.sh脚本</p> 
<p style="margin-left:.0001pt;text-align:left;">若未安装ifconfig可用以下命令代替</p> 
<p style="margin-left:.0001pt;text-align:left;">ip link set docker0 mtu 1400</p> 
<p><img alt="" height="512" src="https://images2.imgbox.com/08/cf/Jf7sHJjB_o.png" width="1200"></p> 
<p style="text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">参考文档：</p> 
<p style="margin-left:.0001pt;text-align:justify;"><a href="https://www.one-tab.com/page/emIOEuB4TTCutaJ7j-AGOw" rel="nofollow" title="OneTab - Shared tabs">OneTab - Shared tabs</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8c02e31d4cfaeedb11867ee0294d4c52/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Oracle数据表ID自增操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dee3cba3d32d07439c5e07d2231df30a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据库的事务四大特性（ACID）、详解隔离性以及隔离级别、锁</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>