<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Bootæºæ‰‹OAuth2.0ï¼Œè½»æ¾å®ç°å¾®ä¿¡æ‰«ç ç™»å½•ï¼ - ç¼–ç¨‹å¤§å’–</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/59ea90d40731b1d675dfde634ac9b2c2/">
  <meta property="og:site_name" content="ç¼–ç¨‹å¤§å’–">
  <meta property="og:title" content="Spring Bootæºæ‰‹OAuth2.0ï¼Œè½»æ¾å®ç°å¾®ä¿¡æ‰«ç ç™»å½•ï¼">
  <meta property="og:description" content="ä½œè€…ä»‹ç»ï¼šâœŒï¸å¤§å‚å…¨æ ˆç å†œ|æ¯•è®¾å®æˆ˜å¼€å‘ï¼Œä¸“æ³¨äºå¤§å­¦ç”Ÿé¡¹ç›®å®æˆ˜å¼€å‘ã€è®²è§£å’Œæ¯•ä¸šç­”ç–‘è¾…å¯¼ã€‚
æ¨èè®¢é˜…ç²¾å½©ä¸“æ  ğŸ‘‡ğŸ» é¿å…é”™è¿‡ä¸‹æ¬¡æ›´æ–°
Springbooté¡¹ç›®ç²¾é€‰å®æˆ˜æ¡ˆä¾‹
æ›´å¤šé¡¹ç›®ï¼šCSDNä¸»é¡µYAMLå¢¨éŸµ
å­¦å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€‚å­¦ä¹ å¦‚èµ¶è·¯ï¼Œä¸èƒ½æ…¢ä¸€æ­¥ã€‚
WechatAccountConfigÂ å¾®ä¿¡å¼€æ”¾å¹³å°ï¼šå¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½
å®˜æ–¹æ–‡æ¡£ï¼šå¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½
1ã€æˆæƒæµç¨‹è¯´æ˜ å¾®ä¿¡OAuth2.0æˆæƒç™»å½•è®©å¾®ä¿¡ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡èº«ä»½å®‰å…¨ç™»å½•ç¬¬ä¸‰æ–¹åº”ç”¨æˆ–ç½‘ç«™ï¼Œåœ¨å¾®ä¿¡ç”¨æˆ·æˆæƒç™»å½•å·²æ¥å…¥å¾®ä¿¡OAuth2.0çš„ç¬¬ä¸‰æ–¹åº”ç”¨åï¼Œç¬¬ä¸‰æ–¹å¯ä»¥è·å–åˆ°ç”¨æˆ·çš„æ¥å£è°ƒç”¨å‡­è¯ï¼ˆaccess_tokenï¼‰ï¼Œé€šè¿‡access_tokenå¯ä»¥è¿›è¡Œå¾®ä¿¡å¼€æ”¾å¹³å°æˆæƒå…³ç³»æ¥å£è°ƒç”¨ï¼Œä»è€Œå¯å®ç°è·å–å¾®ä¿¡ç”¨æˆ·åŸºæœ¬å¼€æ”¾ä¿¡æ¯å’Œå¸®åŠ©ç”¨æˆ·å®ç°åŸºç¡€å¼€æ”¾åŠŸèƒ½ç­‰ã€‚å¾®ä¿¡OAuth2.0æˆæƒç™»å½•ç›®å‰æ”¯æŒauthorization_codeæ¨¡å¼ï¼Œé€‚ç”¨äºæ‹¥æœ‰serverç«¯çš„åº”ç”¨æˆæƒã€‚è¯¥æ¨¡å¼æ•´ä½“æµç¨‹ä¸ºï¼š
â‘  ç¬¬ä¸‰æ–¹å‘èµ·å¾®ä¿¡æˆæƒç™»å½•è¯·æ±‚ï¼Œå¾®ä¿¡ç”¨æˆ·å…è®¸æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨åï¼Œå¾®ä¿¡ä¼šæ‹‰èµ·åº”ç”¨æˆ–é‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹ç½‘ç«™ï¼Œå¹¶ä¸”å¸¦ä¸Šæˆæƒä¸´æ—¶ç¥¨æ®codeå‚æ•°ï¼›
â‘¡ é€šè¿‡codeå‚æ•°åŠ ä¸ŠAppIDå’ŒAppSecretç­‰ï¼Œé€šè¿‡APIæ¢å–access_tokenï¼›
â‘¢ é€šè¿‡access_tokenè¿›è¡Œæ¥å£è°ƒç”¨ï¼Œè·å–ç”¨æˆ·åŸºæœ¬æ•°æ®èµ„æºæˆ–å¸®åŠ©ç”¨æˆ·å®ç°åŸºæœ¬æ“ä½œã€‚
ç¬¬ä¸€æ­¥ï¼šè¯·æ±‚CODE ç¬¬ä¸‰æ–¹ä½¿ç”¨ç½‘ç«™åº”ç”¨æˆæƒç™»å½•å‰è¯·æ³¨æ„å·²è·å–ç›¸åº”ç½‘é¡µæˆæƒä½œç”¨åŸŸï¼ˆscope=snsapi_loginï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨PCç«¯æ‰“å¼€ä»¥ä¸‹é“¾æ¥ï¼šhttps://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect
è¿”å›è¯´æ˜ ç”¨æˆ·å…è®¸æˆæƒåï¼Œå°†ä¼šé‡å®šå‘åˆ°redirect_uriçš„ç½‘å€ä¸Šï¼Œå¹¶ä¸”å¸¦ä¸Šcodeå’Œstateå‚æ•°
redirect_uri?code=CODE&amp;state=STATE è‹¥ç”¨æˆ·ç¦æ­¢æˆæƒï¼Œåˆ™é‡å®šå‘åä¸ä¼šå¸¦ä¸Šcodeå‚æ•°ï¼Œä»…ä¼šå¸¦ä¸Šstateå‚æ•°
redirect_uri?state=STATE ä¾‹å¦‚ï¼šç™»å½•ä¸€å·åº—ç½‘ç«™åº”ç”¨ https://passport.yhd.com/wechat/login.do æ‰“å¼€åï¼Œä¸€å·åº—ä¼šç”Ÿæˆstateå‚æ•°ï¼Œè·³è½¬åˆ° https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=
https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;
scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect å¾®ä¿¡ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å¹¶ä¸”ç¡®è®¤ç™»å½•åï¼ŒPCç«¯ä¼šè·³è½¬åˆ° https://passport.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a4035d839573b04816624a415e
ç¬¬äºŒæ­¥ï¼šé€šè¿‡codeè·å–access_token é€šè¿‡codeè·å–access_token
https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code
è¿”å›è¯´æ˜ æ­£ç¡®çš„è¿”å›ï¼š
{ &#34;access_token&#34;:&#34;ACCESS_TOKEN&#34;, &#34;expires_in&#34;:7200, &#34;refresh_token&#34;:&#34;REFRESH_TOKEN&#34;, &#34;openid&#34;:&#34;OPENID&#34;, &#34;scope&#34;:&#34;SCOPE&#34;, &#34;unionid&#34;:Â &#34;o6_bmasdasdsad6_2sgVt7hMZOPfL&#34; } é”™è¯¯è¿”å›æ ·ä¾‹ï¼š
{&#34;errcode&#34;:40029,&#34;errmsg&#34;:&#34;invalid code&#34;} 1ã€Appsecret æ˜¯åº”ç”¨æ¥å£ä½¿ç”¨å¯†é’¥ï¼Œæ³„æ¼åå°†å¯èƒ½å¯¼è‡´åº”ç”¨æ•°æ®æ³„æ¼ã€åº”ç”¨çš„ç”¨æˆ·æ•°æ®æ³„æ¼ç­‰é«˜é£é™©åæœï¼›å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œææœ‰å¯èƒ½è¢«æ¶æ„çªƒå–ï¼ˆå¦‚åç¼–è¯‘è·å–Appsecretï¼‰ï¼›
2ã€access_token ä¸ºç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨å‘èµ·æ¥å£è°ƒç”¨çš„å‡­è¯ï¼ˆç›¸å½“äºç”¨æˆ·ç™»å½•æ€ï¼‰ï¼Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œå¯èƒ½å‡ºç°æ¶æ„è·å–access_token åå¯¼è‡´çš„ç”¨æˆ·æ•°æ®æ³„æ¼ã€ç”¨æˆ·å¾®ä¿¡ç›¸å…³æ¥å£åŠŸèƒ½è¢«æ¶æ„å‘èµ·ç­‰è¡Œä¸ºï¼›
3ã€refresh_token ä¸ºç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨çš„é•¿æ•ˆå‡­è¯ï¼Œä»…ç”¨äºåˆ·æ–°access_tokenï¼Œä½†æ³„æ¼åç›¸å½“äºaccess_token æ³„æ¼ï¼Œé£é™©åŒä¸Šã€‚
å»ºè®®å°†secretã€ç”¨æˆ·æ•°æ®ï¼ˆå¦‚access_tokenï¼‰æ”¾åœ¨Appäº‘ç«¯æœåŠ¡å™¨ï¼Œç”±äº‘ç«¯ä¸­è½¬æ¥å£è°ƒç”¨è¯·æ±‚
ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡access_tokenè°ƒç”¨æ¥å£ è·å–access_tokenåï¼Œè¿›è¡Œæ¥å£è°ƒç”¨ï¼Œæœ‰ä»¥ä¸‹å‰æï¼š
1.Â access_tokenæœ‰æ•ˆä¸”æœªè¶…æ—¶ï¼› 2.Â å¾®ä¿¡ç”¨æˆ·å·²æˆæƒç»™ç¬¬ä¸‰æ–¹åº”ç”¨å¸å·ç›¸åº”æ¥å£ä½œç”¨åŸŸï¼ˆscopeï¼‰ã€‚ å¯¹äºæ¥å£ä½œç”¨åŸŸï¼ˆscopeï¼‰ï¼Œèƒ½è°ƒç”¨çš„æ¥å£æœ‰ä»¥ä¸‹ï¼š
2ã€æˆæƒæµç¨‹ä»£ç  å› ä¸ºå¾®ä¿¡å¼€æ”¾å¹³å°çš„AppiDå’ŒAPPSecretå’Œå¾®ä¿¡å…¬ä¼—å¹³å°çš„AppiDå’ŒAppSecretéƒ½æ˜¯ä¸åŒçš„ï¼Œå› æ­¤éœ€è¦é…ç½®ä¸€ä¸‹ï¼š
# å¼€æ”¾å¹³å° wechat.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-26T16:33:52+08:00">
    <meta property="article:modified_time" content="2024-04-26T16:33:52+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§å’–" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§å’–</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Bootæºæ‰‹OAuth2.0ï¼Œè½»æ¾å®ç°å¾®ä¿¡æ‰«ç ç™»å½•ï¼</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p><strong>ä½œè€…ä»‹ç»ï¼š</strong>âœŒï¸å¤§å‚å…¨æ ˆç å†œ|æ¯•è®¾å®æˆ˜å¼€å‘ï¼Œä¸“æ³¨äºå¤§å­¦ç”Ÿé¡¹ç›®å®æˆ˜å¼€å‘ã€è®²è§£å’Œæ¯•ä¸šç­”ç–‘è¾…å¯¼ã€‚</p> 
 <p>Â æ¨èè®¢é˜…ç²¾å½©ä¸“æ  ğŸ‘‡ğŸ» é¿å…é”™è¿‡ä¸‹æ¬¡æ›´æ–°</p> 
 <p><a href="https://blog.csdn.net/yaml4/category_12533038.html" title="Springbooté¡¹ç›®ç²¾é€‰å®æˆ˜æ¡ˆä¾‹">Springbooté¡¹ç›®ç²¾é€‰å®æˆ˜æ¡ˆä¾‹</a></p> 
 <p><strong>æ›´å¤šé¡¹ç›®ï¼š</strong>CSDNä¸»é¡µ<a href="https://blog.csdn.net/Yaml4?type=blog" title="YAMLå¢¨éŸµ">YAMLå¢¨éŸµ</a></p> 
 <p>å­¦å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€‚å­¦ä¹ å¦‚èµ¶è·¯ï¼Œä¸èƒ½æ…¢ä¸€æ­¥ã€‚</p> 
</blockquote> 
<p>WechatAccountConfigÂ <strong>å¾®ä¿¡å¼€æ”¾å¹³å°ï¼šå¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½</strong></p> 
<blockquote> 
 <p>å®˜æ–¹æ–‡æ¡£ï¼š<a class="link-info" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html" rel="nofollow" title="å¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½">å¾®ä¿¡æ‰«ç ç™»å½•åŠŸèƒ½</a></p> 
</blockquote> 
<h3>1ã€æˆæƒæµç¨‹è¯´æ˜</h3> 
<p>å¾®ä¿¡OAuth2.0æˆæƒç™»å½•è®©å¾®ä¿¡ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡èº«ä»½å®‰å…¨ç™»å½•ç¬¬ä¸‰æ–¹åº”ç”¨æˆ–ç½‘ç«™ï¼Œåœ¨å¾®ä¿¡ç”¨æˆ·æˆæƒç™»å½•å·²æ¥å…¥å¾®ä¿¡OAuth2.0çš„ç¬¬ä¸‰æ–¹åº”ç”¨åï¼Œç¬¬ä¸‰æ–¹å¯ä»¥è·å–åˆ°ç”¨æˆ·çš„æ¥å£è°ƒç”¨å‡­è¯ï¼ˆaccess_tokenï¼‰ï¼Œé€šè¿‡access_tokenå¯ä»¥è¿›è¡Œå¾®ä¿¡å¼€æ”¾å¹³å°æˆæƒå…³ç³»æ¥å£è°ƒç”¨ï¼Œä»è€Œå¯å®ç°è·å–å¾®ä¿¡ç”¨æˆ·åŸºæœ¬å¼€æ”¾ä¿¡æ¯å’Œå¸®åŠ©ç”¨æˆ·å®ç°åŸºç¡€å¼€æ”¾åŠŸèƒ½ç­‰ã€‚å¾®ä¿¡OAuth2.0æˆæƒç™»å½•ç›®å‰æ”¯æŒauthorization_codeæ¨¡å¼ï¼Œé€‚ç”¨äºæ‹¥æœ‰serverç«¯çš„åº”ç”¨æˆæƒã€‚è¯¥æ¨¡å¼æ•´ä½“æµç¨‹ä¸ºï¼š</p> 
<p>â‘  ç¬¬ä¸‰æ–¹å‘èµ·å¾®ä¿¡æˆæƒç™»å½•è¯·æ±‚ï¼Œå¾®ä¿¡ç”¨æˆ·å…è®¸æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨åï¼Œå¾®ä¿¡ä¼šæ‹‰èµ·åº”ç”¨æˆ–é‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹ç½‘ç«™ï¼Œå¹¶ä¸”å¸¦ä¸Šæˆæƒä¸´æ—¶ç¥¨æ®codeå‚æ•°ï¼›</p> 
<p>â‘¡ é€šè¿‡codeå‚æ•°åŠ ä¸ŠAppIDå’ŒAppSecretç­‰ï¼Œé€šè¿‡APIæ¢å–access_tokenï¼›</p> 
<p>â‘¢ é€šè¿‡access_tokenè¿›è¡Œæ¥å£è°ƒç”¨ï¼Œè·å–ç”¨æˆ·åŸºæœ¬æ•°æ®èµ„æºæˆ–å¸®åŠ©ç”¨æˆ·å®ç°åŸºæœ¬æ“ä½œã€‚</p> 
<p><img alt="" height="474" src="https://images2.imgbox.com/67/9e/3c6xGuzY_o.png" width="1080"></p> 
<h4><strong>ç¬¬ä¸€æ­¥ï¼šè¯·æ±‚CODE</strong></h4> 
<p>ç¬¬ä¸‰æ–¹ä½¿ç”¨ç½‘ç«™åº”ç”¨æˆæƒç™»å½•å‰è¯·æ³¨æ„å·²è·å–ç›¸åº”ç½‘é¡µæˆæƒä½œç”¨åŸŸï¼ˆscope=snsapi_loginï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨PCç«¯æ‰“å¼€ä»¥ä¸‹é“¾æ¥ï¼šhttps://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</p> 
<h5><strong>è¿”å›è¯´æ˜</strong></h5> 
<p>ç”¨æˆ·å…è®¸æˆæƒåï¼Œå°†ä¼šé‡å®šå‘åˆ°redirect_uriçš„ç½‘å€ä¸Šï¼Œå¹¶ä¸”å¸¦ä¸Šcodeå’Œstateå‚æ•°</p> 
<pre><code>redirect_uri?code=CODE&amp;state=STATE</code></pre> 
<p>è‹¥ç”¨æˆ·ç¦æ­¢æˆæƒï¼Œåˆ™é‡å®šå‘åä¸ä¼šå¸¦ä¸Šcodeå‚æ•°ï¼Œä»…ä¼šå¸¦ä¸Šstateå‚æ•°</p> 
<pre><code>redirect_uri?state=STATE</code></pre> 
<blockquote> 
 <p>ä¾‹å¦‚ï¼šç™»å½•ä¸€å·åº—ç½‘ç«™åº”ç”¨ https://passport.yhd.com/wechat/login.do æ‰“å¼€åï¼Œä¸€å·åº—ä¼šç”Ÿæˆstateå‚æ•°ï¼Œè·³è½¬åˆ° https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=</p> 
 <p>https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;</p> 
 <p>scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect å¾®ä¿¡ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å¹¶ä¸”ç¡®è®¤ç™»å½•åï¼ŒPCç«¯ä¼šè·³è½¬åˆ° https://passport.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a4035d839573b04816624a415e</p> 
</blockquote> 
<h4><strong>ç¬¬äºŒæ­¥ï¼šé€šè¿‡codeè·å–access_token</strong></h4> 
<p><span style="color:#fe2c24;">é€šè¿‡codeè·å–access_token</span></p> 
<blockquote> 
 <p>https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</p> 
</blockquote> 
<h5><strong>è¿”å›è¯´æ˜</strong></h5> 
<p>æ­£ç¡®çš„è¿”å›ï¼š</p> 
<pre><code>{
"access_token":"ACCESS_TOKEN",
"expires_in":7200,
"refresh_token":"REFRESH_TOKEN",
"openid":"OPENID",
"scope":"SCOPE",
"unionid":Â "o6_bmasdasdsad6_2sgVt7hMZOPfL"
}</code></pre> 
<p>é”™è¯¯è¿”å›æ ·ä¾‹ï¼š</p> 
<pre><code>{"errcode":40029,"errmsg":"invalid code"}</code></pre> 
<p>1ã€Appsecret æ˜¯åº”ç”¨æ¥å£ä½¿ç”¨å¯†é’¥ï¼Œæ³„æ¼åå°†å¯èƒ½å¯¼è‡´åº”ç”¨æ•°æ®æ³„æ¼ã€åº”ç”¨çš„ç”¨æˆ·æ•°æ®æ³„æ¼ç­‰é«˜é£é™©åæœï¼›å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œææœ‰å¯èƒ½è¢«æ¶æ„çªƒå–ï¼ˆå¦‚åç¼–è¯‘è·å–Appsecretï¼‰ï¼›</p> 
<p>2ã€access_token ä¸ºç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨å‘èµ·æ¥å£è°ƒç”¨çš„å‡­è¯ï¼ˆç›¸å½“äºç”¨æˆ·ç™»å½•æ€ï¼‰ï¼Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œå¯èƒ½å‡ºç°æ¶æ„è·å–access_token åå¯¼è‡´çš„ç”¨æˆ·æ•°æ®æ³„æ¼ã€ç”¨æˆ·å¾®ä¿¡ç›¸å…³æ¥å£åŠŸèƒ½è¢«æ¶æ„å‘èµ·ç­‰è¡Œä¸ºï¼›</p> 
<p>3ã€refresh_token ä¸ºç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨çš„é•¿æ•ˆå‡­è¯ï¼Œä»…ç”¨äºåˆ·æ–°access_tokenï¼Œä½†æ³„æ¼åç›¸å½“äºaccess_token æ³„æ¼ï¼Œé£é™©åŒä¸Šã€‚</p> 
<p>å»ºè®®å°†secretã€ç”¨æˆ·æ•°æ®ï¼ˆå¦‚access_tokenï¼‰æ”¾åœ¨Appäº‘ç«¯æœåŠ¡å™¨ï¼Œç”±äº‘ç«¯ä¸­è½¬æ¥å£è°ƒç”¨è¯·æ±‚</p> 
<h4><strong>ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡access_tokenè°ƒç”¨æ¥å£</strong></h4> 
<p>è·å–access_tokenåï¼Œè¿›è¡Œæ¥å£è°ƒç”¨ï¼Œæœ‰ä»¥ä¸‹å‰æï¼š</p> 
<pre><code>1.Â access_tokenæœ‰æ•ˆä¸”æœªè¶…æ—¶ï¼›
2.Â å¾®ä¿¡ç”¨æˆ·å·²æˆæƒç»™ç¬¬ä¸‰æ–¹åº”ç”¨å¸å·ç›¸åº”æ¥å£ä½œç”¨åŸŸï¼ˆscopeï¼‰ã€‚</code></pre> 
<p>å¯¹äºæ¥å£ä½œç”¨åŸŸï¼ˆscopeï¼‰ï¼Œèƒ½è°ƒç”¨çš„æ¥å£æœ‰ä»¥ä¸‹ï¼š</p> 
<p><img alt="" height="214" src="https://images2.imgbox.com/80/f4/0qGSdRAP_o.png" width="979"></p> 
<h3>2ã€æˆæƒæµç¨‹ä»£ç </h3> 
<p>å› ä¸ºå¾®ä¿¡å¼€æ”¾å¹³å°çš„AppiDå’ŒAPPSecretå’Œå¾®ä¿¡å…¬ä¼—å¹³å°çš„AppiDå’ŒAppSecretéƒ½æ˜¯ä¸åŒçš„ï¼Œå› æ­¤éœ€è¦é…ç½®ä¸€ä¸‹ï¼š</p> 
<pre><code># å¼€æ”¾å¹³å°
wechat.open-app-id=ä½ çš„id
wechat.open-app-secret=ä½ çš„secret</code></pre> 
<h4>å®ä½“ç±»Â </h4> 
<p>WechatAccountConfig.java</p> 
<pre><code>@Data
@Component
@ConfigurationProperties(prefix =Â "wechat")
publicÂ classÂ WechatAccountConfig {

Â Â Â Â //å…¬ä¼—å·appid
Â Â Â Â privateÂ StringÂ mpAppId;

Â Â Â Â //å…¬ä¼—å·appSecret
Â Â Â Â privateÂ StringÂ mpAppSecret;

Â Â Â Â //å•†æˆ·å·
Â Â Â Â privateÂ StringÂ mchId;

Â Â Â Â //å•†æˆ·ç§˜é’¥
Â Â Â Â privateÂ StringÂ mchKey;
Â Â Â Â 
Â Â Â Â //å•†æˆ·è¯ä¹¦è·¯å¾„
Â Â Â Â privateÂ StringÂ keyPath;

Â Â Â Â //å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥
Â Â Â Â privateÂ StringÂ notifyUrl;

Â Â Â Â //å¼€æ”¾å¹³å°id
Â Â Â Â privateÂ StringÂ openAppId;

Â Â Â Â //å¼€æ”¾å¹³å°ç§˜é’¥
Â Â Â Â privateÂ StringÂ openAppSecret;
}</code></pre> 
<h4>configåŒ…</h4> 
<p>WechatOpenConfig.java</p> 
<pre><code>@Configuration
publicÂ classÂ WechatOpenConfigÂ {

Â Â Â Â @Autowired
Â Â Â Â privateÂ WechatAccountConfig accountConfig;

Â Â Â Â @Bean
Â Â Â Â publicÂ WxMpServiceÂ wxOpenService()Â {
Â Â Â Â Â Â Â Â WxMpService wxOpenService =Â newÂ WxMpServiceImpl();
Â Â Â Â Â Â Â Â wxOpenService.setWxMpConfigStorage(wxOpenConfigStorage());
Â Â Â Â Â Â Â Â returnÂ wxOpenService;
Â Â Â Â }

Â Â Â Â @Bean
Â Â Â Â publicÂ WxMpConfigStorageÂ wxOpenConfigStorage()Â {
Â Â Â Â Â Â Â Â WxMpInMemoryConfigStorage wxMpInMemoryConfigStorage =Â newÂ WxMpInMemoryConfigStorage();
Â Â Â Â Â Â Â Â wxMpInMemoryConfigStorage.setAppId(accountConfig.getOpenAppId());
Â Â Â Â Â Â Â Â wxMpInMemoryConfigStorage.setSecret(accountConfig.getOpenAppSecret());
Â Â Â Â Â Â Â Â returnÂ wxMpInMemoryConfigStorage;
Â Â Â Â }
}</code></pre> 
<h4>controlleråŒ…</h4> 
<p>WeChatController.javaÂ </p> 
<pre><code>@Controller
@RequestMapping("/wechat")
@Slf4j
publicÂ classÂ WeChatController {
Â Â Â Â @Autowired
Â Â Â Â privateÂ WxMpService wxMpService;

Â Â Â Â @Autowired
Â Â Â Â privateÂ WxMpService wxOpenService;

Â Â Â Â @GetMapping("/qrAuthorize")
Â Â Â Â publicÂ StringÂ qrAuthorize() {
Â Â Â Â Â Â Â Â //returnUrlå°±æ˜¯ç”¨æˆ·æˆæƒåŒæ„åå›è°ƒçš„åœ°å€
Â Â Â Â Â Â Â Â StringÂ returnUrl =Â "http://heng.nat300.top/sell/wechat/qrUserInfo";

Â Â Â Â Â Â Â Â //å¼•å¯¼ç”¨æˆ·è®¿é—®è¿™ä¸ªé“¾æ¥ï¼Œè¿›è¡Œæˆæƒ
Â Â Â Â Â Â Â Â StringÂ url = wxOpenService.buildQrConnectUrl(returnUrl, WxConsts.QRCONNECT_SCOPE_SNSAPI_LOGIN, URLEncoder.encode(returnUrl));
Â Â Â Â Â Â Â Â returnÂ "redirect:"Â + url;
Â Â Â Â }

Â Â Â Â //ç”¨æˆ·æˆæƒåŒæ„åå›è°ƒçš„åœ°å€ï¼Œä»è¯·æ±‚å‚æ•°ä¸­è·å–code
Â Â Â Â @GetMapping("/qrUserInfo")
Â Â Â Â publicÂ StringÂ qrUserInfo(@RequestParam("code")Â StringÂ code) {
Â Â Â Â Â Â Â Â WxMpOAuth2AccessToken wxMpOAuth2AccessToken =Â newÂ WxMpOAuth2AccessToken();
Â Â Â Â Â Â Â Â tryÂ {
Â Â Â Â Â Â Â Â Â Â Â Â //é€šè¿‡codeè·å–access_token
Â Â Â Â Â Â Â Â Â Â Â Â wxMpOAuth2AccessToken = wxOpenService.oauth2getAccessToken(code);
Â Â Â Â Â Â Â Â }Â catchÂ (WxErrorException e) {
Â Â Â Â Â Â Â Â Â Â Â Â log.error("ã€å¾®ä¿¡ç½‘é¡µæˆæƒã€‘{}", e);
Â Â Â Â Â Â Â Â Â Â Â Â throwÂ newÂ SellException(ResultEnum.WECHAT_MP_ERROR.getCode(), e.getError().getErrorMsg());
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â //ä»tokenä¸­è·å–openid
Â Â Â Â Â Â Â Â StringÂ openId = wxMpOAuth2AccessToken.getOpenId();

Â Â Â Â Â Â Â Â //è¿™ä¸ªåœ°å€å¯æœ‰å¯æ— ï¼Œåæ­£åªæ˜¯ä¸ºäº†æ‹¿åˆ°openidï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ä¼šæŠ¥404é”™è¯¯ï¼Œä¸ºäº†å¥½çœ‹éšä¾¿è¿”å›ä¸€ä¸ªç™¾åº¦çš„åœ°å€
Â Â Â Â Â Â Â Â StringÂ Â returnUrl =Â "http://www.baidu.com";

Â Â Â Â Â Â Â Â log.info("openid={}", openId);

Â Â Â Â Â Â Â Â returnÂ "redirect:"Â + returnUrl +Â "?openid="+openId;
Â Â Â Â }
}</code></pre> 
<p>è¯·æ±‚è·¯å¾„ï¼šåœ¨æµè§ˆå™¨æ‰“å¼€</p> 
<blockquote> 
 <p>https://open.weixin.qq.com/connect/qrconnect?</p> 
 <p>appid=wx6ad144e54af67d87</p> 
 <p></p> 
 <p>&amp;redirect_uri=http%3A%2F%2Fsell.springboot.cn%2Fsell%2Fqr%</p> 
 <p>2FoTgZpwenC6lwO2eTDDf_-UYyFtqI&amp;response_type=code</p> 
 <p></p> 
 <p>&amp;scope=snsapi_login</p> 
 <p></p> 
 <p>&amp;state=http%3a%2f%2fheng.nat300.top%2fsell%2fwechat%2fqrUserInfo</p> 
</blockquote> 
<p>è·å–äº†openidï¼šopenid=o9AREv7Xr22ZUk6BtVqw82bb6AFk</p> 
<p><img alt="" height="249" src="https://images2.imgbox.com/be/11/wC9RD8uK_o.png" width="808"></p> 
<h3>3ã€ç”¨æˆ·ç™»å½•å’Œç™»å‡º</h3> 
<p>è¿™é‡Œç”¨åˆ°redisä¿å­˜ç”¨æˆ·çš„ä¿¡æ¯</p> 
<p><strong><span style="color:#fe2c24;">redisæ€ä¹ˆé…ç½®å…¥å£ï¼š<a class="link-info" href="https://blog.csdn.net/Yaml4/article/details/137125225" title="Spring Bootä¸Redisæ·±åº¦æ•´åˆï¼šå®æˆ˜æŒ‡å—">Spring Bootä¸Redisæ·±åº¦æ•´åˆï¼šå®æˆ˜æŒ‡å—</a></span></strong></p> 
<pre><code class="language-java">@Controller
@RequestMapping("/seller")
public class SellerUserController {

    @Autowired
    private SellerService sellerService;

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Autowired
    private ProjectUrlConfig projectUrlConfig;

    @GetMapping("/login")
    public ModelAndView login(@RequestParam("openid") String openid,
                              HttpServletResponse response,
                              Map&lt;String, Object&gt; map) {

        //1. openidå»å’Œæ•°æ®åº“é‡Œçš„æ•°æ®åŒ¹é…
        SellerInfo sellerInfo = sellerService.findSellerInfoByOpenid(openid);
        if (sellerInfo == null) {
            map.put("msg", ResultEnum.LOGIN_FAIL.getMessage());
            map.put("url", "/sell/seller/order/list");
            return new ModelAndView("common/error");
        }

        //2. è®¾ç½®tokenè‡³redis
        String token = UUID.randomUUID().toString();
        //è®¾ç½®tokençš„è¿‡æœŸæ—¶é—´
        Integer expire = RedisConstant.EXPIRE;

        redisTemplate.opsForValue().set(String.format(RedisConstant.TOKEN_PREFIX, token), openid, expire, TimeUnit.SECONDS);

        //3. è®¾ç½®tokenè‡³cookie
        CookieUtil.set(response, CookieConstant.TOKEN, token, expire);

        return new ModelAndView("redirect:" + "http://heng.nat300.top/sell/seller/order/list");
    }

    @GetMapping("/logout")
    public ModelAndView logout(HttpServletRequest request,
                       HttpServletResponse response,
                       Map&lt;String, Object&gt; map) {
        //1. ä»cookieé‡ŒæŸ¥è¯¢
        Cookie cookie = CookieUtil.get(request, CookieConstant.TOKEN);
        if (cookie != null) {
            //2. æ¸…é™¤redis
            redisTemplate.opsForValue().getOperations().delete(String.format(RedisConstant.TOKEN_PREFIX, cookie.getValue()));

            //3. æ¸…é™¤cookie
            CookieUtil.set(response, CookieConstant.TOKEN, null, 0);
        }

        map.put("msg", ResultEnum.LOGOUT_SUCCESS.getMessage());
        map.put("url", "/sell/seller/order/list");
        return new ModelAndView("common/success", map);
    }
}
</code></pre> 
<p></p> 
<p>â‘  å°†ä¸Šä¸€æ­¥è·å–åˆ°çš„openidå­˜å…¥æ•°æ®åº“<img alt="" height="76" src="https://images2.imgbox.com/a4/d2/vcv7weqW_o.png" width="750"></p> 
<p></p> 
<p>â‘¡ å°†æˆæƒåè·³è½¬çš„åœ°å€æ”¹ä¸ºç™»å½•åœ°å€</p> 
<pre><code>//ç”¨æˆ·æˆæƒåŒæ„åå›è°ƒçš„åœ°å€ï¼Œä»è¯·æ±‚å‚æ•°ä¸­è·å–code
@GetMapping("/qrUserInfo")
publicÂ StringÂ qrUserInfo(@RequestParam("code")Â StringÂ code) {
Â Â Â Â WxMpOAuth2AccessToken wxMpOAuth2AccessToken =Â newÂ WxMpOAuth2AccessToken();
Â Â Â Â tryÂ {
Â Â Â Â Â Â Â Â //é€šè¿‡codeè·å–access_token
Â Â Â Â Â Â Â Â wxMpOAuth2AccessToken = wxOpenService.oauth2getAccessToken(code);
Â Â Â Â }Â catchÂ (WxErrorException e) {
Â Â Â Â Â Â Â Â log.error("ã€å¾®ä¿¡ç½‘é¡µæˆæƒã€‘{}", e);
Â Â Â Â Â Â Â Â throwÂ newÂ SellException(ResultEnum.WECHAT_MP_ERROR.getCode(), e.getError().getErrorMsg());
Â Â Â Â }
Â Â Â Â //ä»tokenä¸­è·å–openid
Â Â Â Â StringÂ openId = wxMpOAuth2AccessToken.getOpenId();

Â Â Â Â //æˆæƒæˆåŠŸåè·³è½¬åˆ°å–å®¶ç³»ç»Ÿçš„ç™»å½•åœ°å€
Â Â Â Â StringÂ Â returnUrl =Â "http://heng.nat300.top/sell/seller/login";

Â Â Â Â log.info("openid={}", openId);

Â Â Â Â returnÂ "redirect:"Â + returnUrl +Â "?openid="+openId;
}</code></pre> 
<p>â‘¢ åœ¨æµè§ˆå™¨è¯·æ±‚è¿™ä¸ªé“¾æ¥ï¼š</p> 
<blockquote> 
 <p>https://open.weixin.qq.com/connect/qrconnect?</p> 
 <p><span style="color:#fe2c24;"><strong>appid</strong></span>=wx6ad144e54af67d87&amp;</p> 
 <p></p> 
 <p><span style="color:#fe2c24;"><strong>redirect_uri</strong></span>=http%3A%2F%2Fsell.springboot.cn%2Fsell%2Fqr%</p> 
 <p>2FoTgZpwenC6lwO2eTDDf_-UYyFtqI&amp;</p> 
 <p></p> 
 <p><strong><span style="color:#fe2c24;">response_type</span></strong>=code&amp;</p> 
 <p></p> 
 <p><strong><span style="color:#fe2c24;">scope</span></strong>=snsapi_login&amp;</p> 
 <p></p> 
 <p><span style="color:#fe2c24;"><strong>state</strong></span>=http%3a%2f%2fheng.nat300.top%2fsell%2fwechat%2fqrUserInfo</p> 
</blockquote> 
<p></p> 
<p>ç¬¬ä¸‰åº”ç”¨è¯·æ±‚ä½¿ç”¨å¾®ä¿¡æ‰«ç ç™»å½•ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æœ¬ç½‘ç«™çš„å¯†ç ï¼š</p> 
<p></p> 
<p><img alt="" height="375" src="https://images2.imgbox.com/11/65/IPD1iUc4_o.png" width="805"></p> 
<p>ç”¨æˆ·åŒæ„æˆæƒåç™»å…¥ç¬¬ä¸‰æ–¹åº”ç”¨çš„åå°ç®¡ç†ç³»ç»Ÿï¼š</p> 
<p><img alt="" height="426" src="https://images2.imgbox.com/5d/a1/XQVqjSAK_o.png" width="540"></p> 
<p><img alt="" height="366" src="https://images2.imgbox.com/47/34/esSPkYwj_o.png" width="1080"></p> 
<h3>4ã€Spring AOPæ ¡éªŒç”¨æˆ·æœ‰æ²¡æœ‰ç™»å½•</h3> 
<pre><code class="language-java">@Aspect
@Component
@Slf4j
public class SellerAuthorizeAspect {

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Pointcut("execution(public * com.hh.controller.Seller*.*(..))" +
    "&amp;&amp; !execution(public * com.hh.controller.SellerUserController.*(..))")
    public void verify() {}

    @Before("verify()")
    public void doVerify() {
        
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();

        //æŸ¥è¯¢cookie
        Cookie cookie = CookieUtil.get(request, CookieConstant.TOKEN);
        //å¦‚æœcookieä¸­æ²¡æœ‰tokenè¯´æ˜å·²ç»ç™»å‡ºæˆ–è€…æ ¹æœ¬æ²¡æœ‰ç™»å½•
        if (cookie == null) {
            log.warn("ã€ç™»å½•æ ¡éªŒã€‘Cookieä¸­æŸ¥ä¸åˆ°token");
            //æ ¡éªŒä¸é€šè¿‡ï¼ŒæŠ›å‡ºå¼‚å¸¸
            throw new SellerAuthorizeException();
        }

        //å»redisé‡ŒæŸ¥è¯¢
        String tokenValue = redisTemplate.opsForValue().get(String.format(RedisConstant.TOKEN_PREFIX, cookie.getValue()));
        //å¦‚æœredisä¸­æ²¡æœ‰å¯¹åº”çš„openidï¼ŒåŒæ ·è¡¨ç¤ºç™»å‡ºæˆ–è€…æ ¹æœ¬æ²¡æœ‰ç™»å½•
        if (StringUtils.isEmpty(tokenValue)) {
            log.warn("ã€ç™»å½•æ ¡éªŒã€‘Redisä¸­æŸ¥ä¸åˆ°token");
            throw new SellerAuthorizeException();
        }
    }
}
</code></pre> 
<h3>5ã€æ‹¦æˆªç™»å½•æ ¡éªŒä¸é€šè¿‡æŠ›å‡ºçš„å¼‚å¸¸</h3> 
<p>æ‹¦æˆªåŠç™»å½•æ ¡éªŒä¸é€šè¿‡çš„å¼‚å¸¸ï¼Œè®©å…¶è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œæ‰«ç ç™»å½•</p> 
<pre><code>@ControllerAdvice
publicÂ classÂ SellExceptionHandlerÂ {
Â Â Â Â //æ‹¦æˆªç™»å½•å¼‚å¸¸
Â Â Â Â @ExceptionHandler(value = SellerAuthorizeException.class)
Â Â Â Â publicÂ ModelAndViewÂ handlerAuthorizeException()Â {
Â Â Â Â Â Â Â Â //æ‹¦æˆªå¼‚å¸¸åï¼Œè·³è½¬åˆ°ç™»å½•ç•Œé¢
Â Â Â Â Â Â Â Â returnÂ newÂ ModelAndView("redirect:".concat("https://open.weixin.qq.com/connect/qrconnect?"Â +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "appid=wx6ad144e54af67d87"Â +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "&amp;redirect_uri=http%3A%2F%2Fsell.springboot.cn%2Fsell%2Fqr%2F"Â +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "oTgZpwenC6lwO2eTDDf_-UYyFtqI"Â +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "&amp;response_type=code&amp;scope=snsapi_login"Â +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "&amp;state=http%3a%2f%2fheng.nat300.top%2fsell%2fwechat%2fqrUserInfo"));
Â Â Â Â }
Â Â Â Â @ExceptionHandler(value = SellException.class)
Â Â Â Â @ResponseBody
Â Â Â Â publicÂ ResultVOÂ handlerSellerException(SellException e)Â {
Â Â Â Â Â Â Â Â returnÂ ResultVOUtil.error(e.getCode(), e.getMessage());
Â Â Â Â }
Â Â Â Â @ExceptionHandler(value = ResponseBankException.class)
Â Â Â Â @ResponseStatus(HttpStatus.FORBIDDEN)
Â Â Â Â publicÂ voidÂ handleResponseBankException()Â {
Â Â Â Â }
}</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e266901ebd816fd81090c77edcb1e2e/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">stable diffusionå¸¸ç”¨çš„æ¨¡å‹</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a62973eb60230cd2b286298190c261c9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Atlas Vector Searchï¼šå€ŸåŠ©è¯­ä¹‰æœç´¢å’Œ AI é’ˆå¯¹ä»»ä½•ç±»å‹çš„æ•°æ®æ„å»ºæ™ºèƒ½åº”ç”¨</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§å’–.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>