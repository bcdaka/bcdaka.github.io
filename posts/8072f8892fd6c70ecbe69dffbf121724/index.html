<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis三主三从集群搭建(docker版) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/8072f8892fd6c70ecbe69dffbf121724/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Redis三主三从集群搭建(docker版)">
  <meta property="og:description" content="文章目录 1.分布式存储算法1.哈希取余算法2.一致性哈希算法1.基本介绍2.优点1.容错性2.扩展性 3.缺点：数据倾斜问题 3.哈希槽分区（大厂常用） 2.基础环境搭建1.给六台机器都安装docker1.卸载旧版本的docker2.安装 gcc相关3.安装`yum-utils`软件包4.docker设置阿里云的镜像仓库，最好不要设置国外的5.更新yum包的索引（linux基础，以后使用yum会快一些）6.安装最新版的docker7.启动docker进程并查看docker是否成功启动8.运行docker9.停止docker10.设置docker自启动并确认是否设置成功！11.阿里云镜像加速器配置1.找到容器镜像服务2.得到镜像加速器地址3.创建目录，并通过修改daemon配置文件/etc/docker/daemon.json来使用加速器4.重启daemon5.重启docker 2.部署规划图3.配置一个基础的Redis容器1.拉取redis:6.0.8到本地2.在宿主机新建目录 /app/redis，存放redis的配置文件3.从redis6.0.8中得到一份redis.conf的配置文件1.将压缩包上传到/opt目录下2.进入/opt目录然后解压3.复制一份redis.conf到/app/redis目录下4.查看配置文件 4.对配置文件进行修改1.编辑配置文件2.设置redis密码 requirepass foobared3.使redis支持远程访问 bind 127.0.0.1 和 protected-mode4.设置daemonize no，如果是yes会与docker的-d方式冲突 5.启动Redis6.连接Redis1.使用exec命令进入redis容器2.连接redis-cli3.进行操作测试 7.开放6480端口1.宝塔开启2.腾讯云开启 8.使用Jedis连接Redis测试 4.使用阿里云镜像仓库，将Redis容器制作为镜像发布（暂时使用不了）1.访问阿里云的容器镜像服务2.创建一个命名空间sunxiansheng，设置公开3.创建镜像仓库，记得选择命名空间1.创建仓库2.进行配置，选择命名空间和仓库名称3.选择本地仓库4.创建成功! 4.将redis容器commit到我们的新镜像（在容器外执行）1.命令格式2.查看redis容器的ImageId，并执行命令，构建新镜像 redis-cluster:1.0 5.将本地镜像发布到阿里云镜像仓库（根据阿里云提供的指令即可）1.首先登录阿里云镜像仓库2.根据要求设置要推送的本地镜像3.发布镜像到阿里云镜像仓库 6.测试拉取镜像直接执行1.首先删除本地的镜像2.拉取镜像到本地3.删除之前进行目录挂载的/app/redis目录，为了测试启动镜像时会不会保留之前的配置4.还要删除本地的redis-cluster容器（保持环境干净）5.由于挂载的时候挂载了一个宿主机的/app/redis/redis.conf文件，所以需要手动创建，否则启动会失败6.启动Redis7.自定义镜像需要Dockerfile，等学了之后再来补充 5.配置另外五台机器（方式类似以49.232.227.185为例）1.拉取redis:6.0.8到本地2.在宿主机新建目录 /app/redis，存放redis的配置文件3.从最初的机器上得到配置好的redis.conf1.源服务器使用scp发送文件redis.conf到本服务器的/app/redis下 3.启动Redis6.连接Redis1.使用exec命令进入redis容器2.连接redis-cli3.进行操作测试 7.开放6480端口1.宝塔开启2.腾讯云开启 8.使用Jedis连接Redis测试 3.集群搭建1.六台服务器都要配置1.修改redis.conf配置文件1.编辑配置文件2.设置redis节点连接其他redis的密码 masterauth（与requirepass 一致即可）3.重启redis容器 2.开启总线端口10000 &#43; port1.宝塔开启16480端口2.腾讯云开启16480端口 3.删除容器，更换为集群模式的启动命令1.删除原来的容器2.以集群模式启动的docker命令3.查看目录/app/redis/data，持久化文件以及节点文件都同步过来了！ 2.构建主从关系1.进入一台机器2.测试连接redis-cli（注意此时的ip已经在启动时指定了6480）3.退出redis-cli进行集群构建4.构建成功！5.如果发现一直在构建，原因是需要开启总线的端口也就是10000 &#43; 6480 3.常用命令1.首先进入redis容器的redis-cli2.查看集群信息3.查看集群节点 4.SpringBoot测试连接1.pom.xml2.application.yml3.Redis配置类4.测试的controller5.启动测试 5.报错 Unable to connect to [10.2.8.11:6480]: connection timed out: /10.2.8.11:64801.这个显示的是连接的内网地址，所以需要配置redis.conf的cluster-announce-ip来暴露服务器外网ip2.编辑配置文件3.配置 cluster-announce-ip 为每台服务器的外网ip4.重启redis容器5.此时就不会再出现连接内网超时的问题了 4.主从扩容和主从缩容1.主从扩容1.启动一台主机1.使用配置好的 redis.conf 启动容器2.查看配置data目录是否同步3.开启端口6481和164814.jedis测试连接 2.启动一台从机1.使用配置好的 redis.conf 启动容器2.开启端口6482和164823.jedis测试连接 3.将新增的7号节点作为master节点加入原集群1.进入七号容器内部2.添加七号节点到集群（选择任意一个节点即可）3.检查集群情况，可以看到6481已经作为一个master加入了 4.重新分配槽位1.执行指令，重新分配槽位2.计算平均槽位并分配给新机器3.选择all &#43; yes，意思就是，从其他三台机器共提取4096个槽位给新机器4.检查集群情况，发现分配规则是前几个机器匀了槽位给新机器 5.添加8号从机到7号主机下面1.执行指令添加2.检查集群情况 6.SpringBoot测试连接1.测试是否可以设置key2.检查集群情况，观察是否四个机器都能插入 1.分布式存储算法 1.哈希取余算法 2.一致性哈希算法 1.基本介绍 2.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-20T21:43:56+08:00">
    <meta property="article:modified_time" content="2024-05-20T21:43:56+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis三主三从集群搭建(docker版)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#1_2" rel="nofollow">1.分布式存储算法</a></li><li><ul><li><ul><li><a href="#1_4" rel="nofollow">1.哈希取余算法</a></li><li><a href="#2_10" rel="nofollow">2.一致性哈希算法</a></li><li><ul><li><a href="#1_12" rel="nofollow">1.基本介绍</a></li><li><a href="#2_20" rel="nofollow">2.优点</a></li><li><ul><li><a href="#1_22" rel="nofollow">1.容错性</a></li><li><a href="#2_26" rel="nofollow">2.扩展性</a></li></ul> 
      </li><li><a href="#3_30" rel="nofollow">3.缺点：数据倾斜问题</a></li></ul> 
     </li><li><a href="#3_34" rel="nofollow">3.哈希槽分区（大厂常用）</a></li></ul> 
   </li></ul> 
   </li><li><a href="#2_40" rel="nofollow">2.基础环境搭建</a></li><li><ul><li><ul><li><a href="#1docker_42" rel="nofollow">1.给六台机器都安装docker</a></li><li><ul><li><a href="#1docker_44" rel="nofollow">1.卸载旧版本的docker</a></li><li><a href="#2_gcc_59" rel="nofollow">2.安装 gcc相关</a></li><li><a href="#3yumutils_67" rel="nofollow">3.安装`yum-utils`软件包</a></li><li><a href="#4docker_75" rel="nofollow">4.docker设置阿里云的镜像仓库，最好不要设置国外的</a></li><li><a href="#5yumlinuxyum_85" rel="nofollow">5.更新yum包的索引（linux基础，以后使用yum会快一些）</a></li><li><a href="#6docker_93" rel="nofollow">6.安装最新版的docker</a></li><li><a href="#7dockerdocker_101" rel="nofollow">7.启动docker进程并查看docker是否成功启动</a></li><li><a href="#8docker_109" rel="nofollow">8.运行docker</a></li><li><a href="#9docker_119" rel="nofollow">9.停止docker</a></li><li><a href="#10docker_127" rel="nofollow">10.设置docker自启动并确认是否设置成功！</a></li><li><a href="#11_135" rel="nofollow">11.阿里云镜像加速器配置</a></li><li><ul><li><a href="#1_137" rel="nofollow">1.找到容器镜像服务</a></li><li><a href="#2_143" rel="nofollow">2.得到镜像加速器地址</a></li><li><a href="#3daemonetcdockerdaemonjson_147" rel="nofollow">3.创建目录，并通过修改daemon配置文件/etc/docker/daemon.json来使用加速器</a></li><li><a href="#4daemon_157" rel="nofollow">4.重启daemon</a></li><li><a href="#5docker_163" rel="nofollow">5.重启docker</a></li></ul> 
     </li></ul> 
     </li><li><a href="#2_169" rel="nofollow">2.部署规划图</a></li><li><a href="#3Redis_173" rel="nofollow">3.配置一个基础的Redis容器</a></li><li><ul><li><a href="#1redis608_175" rel="nofollow">1.拉取redis:6.0.8到本地</a></li><li><a href="#2_appredisredis_183" rel="nofollow">2.在宿主机新建目录 /app/redis，存放redis的配置文件</a></li><li><a href="#3redis608redisconf_189" rel="nofollow">3.从redis6.0.8中得到一份redis.conf的配置文件</a></li><li><ul><li><a href="#1opt_191" rel="nofollow">1.将压缩包上传到/opt目录下</a></li><li><a href="#2opt_195" rel="nofollow">2.进入/opt目录然后解压</a></li><li><a href="#3redisconfappredis_201" rel="nofollow">3.复制一份redis.conf到/app/redis目录下</a></li><li><a href="#4_207" rel="nofollow">4.查看配置文件</a></li></ul> 
      </li><li><a href="#4_215" rel="nofollow">4.对配置文件进行修改</a></li><li><ul><li><a href="#1_217" rel="nofollow">1.编辑配置文件</a></li><li><a href="#2redis_requirepass_foobared_223" rel="nofollow">2.设置redis密码 requirepass foobared</a></li><li><a href="#3redis_bind_127001__protectedmode_227" rel="nofollow">3.使redis支持远程访问 bind 127.0.0.1 和 protected-mode</a></li><li><a href="#4daemonize_noyesdockerd_233" rel="nofollow">4.设置daemonize no，如果是yes会与docker的-d方式冲突</a></li></ul> 
      </li><li><a href="#5Redis_237" rel="nofollow">5.启动Redis</a></li><li><a href="#6Redis_256" rel="nofollow">6.连接Redis</a></li><li><ul><li><a href="#1execredis_258" rel="nofollow">1.使用exec命令进入redis容器</a></li><li><a href="#2rediscli_266" rel="nofollow">2.连接redis-cli</a></li><li><a href="#3_277" rel="nofollow">3.进行操作测试</a></li></ul> 
      </li><li><a href="#76480_281" rel="nofollow">7.开放6480端口</a></li><li><ul><li><a href="#1_283" rel="nofollow">1.宝塔开启</a></li><li><a href="#2_291" rel="nofollow">2.腾讯云开启</a></li></ul> 
      </li><li><a href="#8JedisRedis_295" rel="nofollow">8.使用Jedis连接Redis测试</a></li></ul> 
     </li><li><a href="#4Redis_301" rel="nofollow">4.使用阿里云镜像仓库，将Redis容器制作为镜像发布（暂时使用不了）</a></li><li><ul><li><a href="#1_303" rel="nofollow">1.访问阿里云的容器镜像服务</a></li><li><a href="#2sunxiansheng_307" rel="nofollow">2.创建一个命名空间sunxiansheng，设置公开</a></li><li><a href="#3_311" rel="nofollow">3.创建镜像仓库，记得选择命名空间</a></li><li><ul><li><a href="#1_313" rel="nofollow">1.创建仓库</a></li><li><a href="#2_317" rel="nofollow">2.进行配置，选择命名空间和仓库名称</a></li><li><a href="#3_321" rel="nofollow">3.选择本地仓库</a></li><li><a href="#4_325" rel="nofollow">4.创建成功!</a></li></ul> 
      </li><li><a href="#4rediscommit_329" rel="nofollow">4.将redis容器commit到我们的新镜像（在容器外执行）</a></li><li><ul><li><a href="#1_331" rel="nofollow">1.命令格式</a></li><li><a href="#2redisImageId_rediscluster10_337" rel="nofollow">2.查看redis容器的ImageId，并执行命令，构建新镜像 redis-cluster:1.0</a></li></ul> 
      </li><li><a href="#5_345" rel="nofollow">5.将本地镜像发布到阿里云镜像仓库（根据阿里云提供的指令即可）</a></li><li><ul><li><a href="#1_349" rel="nofollow">1.首先登录阿里云镜像仓库</a></li><li><a href="#2_359" rel="nofollow">2.根据要求设置要推送的本地镜像</a></li><li><a href="#3_371" rel="nofollow">3.发布镜像到阿里云镜像仓库</a></li></ul> 
      </li><li><a href="#6_383" rel="nofollow">6.测试拉取镜像直接执行</a></li><li><ul><li><a href="#1_385" rel="nofollow">1.首先删除本地的镜像</a></li><li><a href="#2_389" rel="nofollow">2.拉取镜像到本地</a></li><li><a href="#3appredis_403" rel="nofollow">3.删除之前进行目录挂载的/app/redis目录，为了测试启动镜像时会不会保留之前的配置</a></li><li><a href="#4rediscluster_409" rel="nofollow">4.还要删除本地的redis-cluster容器（保持环境干净）</a></li><li><a href="#5appredisredisconf_417" rel="nofollow">5.由于挂载的时候挂载了一个宿主机的/app/redis/redis.conf文件，所以需要手动创建，否则启动会失败</a></li><li><a href="#6Redis_423" rel="nofollow">6.启动Redis</a></li><li><a href="#7Dockerfile_440" rel="nofollow">7.自定义镜像需要Dockerfile，等学了之后再来补充</a></li></ul> 
     </li></ul> 
     </li><li><a href="#549232227185_442" rel="nofollow">5.配置另外五台机器（方式类似以49.232.227.185为例）</a></li><li><ul><li><a href="#1redis608_444" rel="nofollow">1.拉取redis:6.0.8到本地</a></li><li><a href="#2_appredisredis_452" rel="nofollow">2.在宿主机新建目录 /app/redis，存放redis的配置文件</a></li><li><a href="#3redisconf_458" rel="nofollow">3.从最初的机器上得到配置好的redis.conf</a></li><li><ul><li><a href="#1scpredisconfappredis_460" rel="nofollow">1.源服务器使用scp发送文件redis.conf到本服务器的/app/redis下</a></li></ul> 
      </li><li><a href="#3Redis_468" rel="nofollow">3.启动Redis</a></li><li><a href="#6Redis_487" rel="nofollow">6.连接Redis</a></li><li><ul><li><a href="#1execredis_489" rel="nofollow">1.使用exec命令进入redis容器</a></li><li><a href="#2rediscli_497" rel="nofollow">2.连接redis-cli</a></li><li><a href="#3_508" rel="nofollow">3.进行操作测试</a></li></ul> 
      </li><li><a href="#76480_512" rel="nofollow">7.开放6480端口</a></li><li><ul><li><a href="#1_514" rel="nofollow">1.宝塔开启</a></li><li><a href="#2_522" rel="nofollow">2.腾讯云开启</a></li></ul> 
      </li><li><a href="#8JedisRedis_526" rel="nofollow">8.使用Jedis连接Redis测试</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#3_532" rel="nofollow">3.集群搭建</a></li><li><ul><li><ul><li><a href="#1_534" rel="nofollow">1.六台服务器都要配置</a></li><li><ul><li><a href="#1redisconf_536" rel="nofollow">1.修改redis.conf配置文件</a></li><li><ul><li><a href="#1_538" rel="nofollow">1.编辑配置文件</a></li><li><a href="#2redisredis_masterauthrequirepass__544" rel="nofollow">2.设置redis节点连接其他redis的密码 masterauth（与requirepass 一致即可）</a></li><li><a href="#3redis_548" rel="nofollow">3.重启redis容器</a></li></ul> 
      </li><li><a href="#210000__port_556" rel="nofollow">2.开启总线端口10000 + port</a></li><li><ul><li><a href="#116480_558" rel="nofollow">1.宝塔开启16480端口</a></li><li><a href="#216480_564" rel="nofollow">2.腾讯云开启16480端口</a></li></ul> 
      </li><li><a href="#3_566" rel="nofollow">3.删除容器，更换为集群模式的启动命令</a></li><li><ul><li><a href="#1_568" rel="nofollow">1.删除原来的容器</a></li><li><a href="#2docker_576" rel="nofollow">2.以集群模式启动的docker命令</a></li><li><a href="#3appredisdata_608" rel="nofollow">3.查看目录/app/redis/data，持久化文件以及节点文件都同步过来了！</a></li></ul> 
     </li></ul> 
     </li><li><a href="#2_616" rel="nofollow">2.构建主从关系</a></li><li><ul><li><a href="#1_618" rel="nofollow">1.进入一台机器</a></li><li><a href="#2rediscliip6480_624" rel="nofollow">2.测试连接redis-cli（注意此时的ip已经在启动时指定了6480）</a></li><li><a href="#3rediscli_634" rel="nofollow">3.退出redis-cli进行集群构建</a></li><li><a href="#4_640" rel="nofollow">4.构建成功！</a></li><li><a href="#510000__6480_644" rel="nofollow">5.如果发现一直在构建，原因是需要开启总线的端口也就是10000 + 6480</a></li></ul> 
     </li><li><a href="#3_648" rel="nofollow">3.常用命令</a></li><li><ul><li><a href="#1redisrediscli_650" rel="nofollow">1.首先进入redis容器的redis-cli</a></li><li><a href="#2_656" rel="nofollow">2.查看集群信息</a></li><li><a href="#3_664" rel="nofollow">3.查看集群节点</a></li></ul> 
     </li><li><a href="#4SpringBoot_671" rel="nofollow">4.SpringBoot测试连接</a></li><li><ul><li><a href="#1pomxml_673" rel="nofollow">1.pom.xml</a></li><li><a href="#2applicationyml_738" rel="nofollow">2.application.yml</a></li><li><a href="#3Redis_760" rel="nofollow">3.Redis配置类</a></li><li><a href="#4controller_846" rel="nofollow">4.测试的controller</a></li><li><a href="#5_850" rel="nofollow">5.启动测试</a></li></ul> 
     </li><li><a href="#5_Unable_to_connect_to_1028116480_connection_timed_out_1028116480_854" rel="nofollow">5.报错 Unable to connect to [10.2.8.11:6480]: connection timed out: /10.2.8.11:6480</a></li><li><ul><li><a href="#1redisconfclusterannounceipip_856" rel="nofollow">1.这个显示的是连接的内网地址，所以需要配置redis.conf的cluster-announce-ip来暴露服务器外网ip</a></li><li><a href="#2_858" rel="nofollow">2.编辑配置文件</a></li><li><a href="#3_clusterannounceip_ip_864" rel="nofollow">3.配置 cluster-announce-ip 为每台服务器的外网ip</a></li><li><a href="#4redis_868" rel="nofollow">4.重启redis容器</a></li><li><a href="#5_874" rel="nofollow">5.此时就不会再出现连接内网超时的问题了</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#4_876" rel="nofollow">4.主从扩容和主从缩容</a></li><li><ul><li><ul><li><a href="#1_878" rel="nofollow">1.主从扩容</a></li><li><ul><li><a href="#1_880" rel="nofollow">1.启动一台主机</a></li><li><ul><li><a href="#1_redisconf__882" rel="nofollow">1.使用配置好的 redis.conf 启动容器</a></li><li><a href="#2data_906" rel="nofollow">2.查看配置data目录是否同步</a></li><li><a href="#3648116481_910" rel="nofollow">3.开启端口6481和16481</a></li><li><a href="#4jedis_920" rel="nofollow">4.jedis测试连接</a></li></ul> 
      </li><li><a href="#2_924" rel="nofollow">2.启动一台从机</a></li><li><ul><li><a href="#1_redisconf__926" rel="nofollow">1.使用配置好的 redis.conf 启动容器</a></li><li><a href="#2648216482_942" rel="nofollow">2.开启端口6482和16482</a></li><li><a href="#3jedis_949" rel="nofollow">3.jedis测试连接</a></li></ul> 
      </li><li><a href="#37master_953" rel="nofollow">3.将新增的7号节点作为master节点加入原集群</a></li><li><ul><li><a href="#1_955" rel="nofollow">1.进入七号容器内部</a></li><li><a href="#2_961" rel="nofollow">2.添加七号节点到集群（选择任意一个节点即可）</a></li><li><a href="#36481master_969" rel="nofollow">3.检查集群情况，可以看到6481已经作为一个master加入了</a></li></ul> 
      </li><li><a href="#4_977" rel="nofollow">4.重新分配槽位</a></li><li><ul><li><a href="#1_979" rel="nofollow">1.执行指令，重新分配槽位</a></li><li><a href="#2_987" rel="nofollow">2.计算平均槽位并分配给新机器</a></li><li><a href="#3all__yes4096_995" rel="nofollow">3.选择all + yes，意思就是，从其他三台机器共提取4096个槽位给新机器</a></li><li><a href="#4_1001" rel="nofollow">4.检查集群情况，发现分配规则是前几个机器匀了槽位给新机器</a></li></ul> 
      </li><li><a href="#587_1009" rel="nofollow">5.添加8号从机到7号主机下面</a></li><li><ul><li><a href="#1_1011" rel="nofollow">1.执行指令添加</a></li><li><a href="#2_1021" rel="nofollow">2.检查集群情况</a></li></ul> 
      </li><li><a href="#6SpringBoot_1028" rel="nofollow">6.SpringBoot测试连接</a></li><li><ul><li><a href="#1key_1030" rel="nofollow">1.测试是否可以设置key</a></li><li><a href="#2_1038" rel="nofollow">2.检查集群情况，观察是否四个机器都能插入</a></li></ul> 
     </li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_2"></a>1.分布式存储算法</h3> 
<h5><a id="1_4"></a>1.哈希取余算法</h5> 
<p><img src="https://images2.imgbox.com/c2/8e/AFmE46Yu_o.png" alt="image-20240518211701604"></p> 
<p><img src="https://images2.imgbox.com/d4/36/IMc02EPa_o.png" alt="image-20240518211807592"></p> 
<h5><a id="2_10"></a>2.一致性哈希算法</h5> 
<h6><a id="1_12"></a>1.基本介绍</h6> 
<p><img src="https://images2.imgbox.com/12/ab/qbAumCcc_o.png" alt="image-20240518212126138"></p> 
<p><img src="https://images2.imgbox.com/e3/81/0FxFHyMm_o.png" alt="image-20240518212219010"></p> 
<p><img src="https://images2.imgbox.com/51/d8/fBUxoyp0_o.png" alt="image-20240518212402306"></p> 
<h6><a id="2_20"></a>2.优点</h6> 
<h6><a id="1_22"></a>1.容错性</h6> 
<p><img src="https://images2.imgbox.com/4e/55/ge3xVY8x_o.png" alt="image-20240518212904846"></p> 
<h6><a id="2_26"></a>2.扩展性</h6> 
<p><img src="https://images2.imgbox.com/f4/59/ejiOnP0n_o.png" alt="image-20240518212628037"></p> 
<h6><a id="3_30"></a>3.缺点：数据倾斜问题</h6> 
<p><img src="https://images2.imgbox.com/b5/0f/XVtU5JzP_o.png" alt="image-20240518212832069"></p> 
<h5><a id="3_34"></a>3.哈希槽分区（大厂常用）</h5> 
<p><img src="https://images2.imgbox.com/4d/43/OonSNeDQ_o.png" alt="image-20240518213334786"></p> 
<p><img src="https://images2.imgbox.com/cc/63/xBizUBRc_o.png" alt="image-20240518213434641"></p> 
<h3><a id="2_40"></a>2.基础环境搭建</h3> 
<h5><a id="1docker_42"></a>1.给六台机器都安装docker</h5> 
<h6><a id="1docker_44"></a>1.卸载旧版本的docker</h6> 
<pre><code class="prism language-sh"><span class="token function">sudo</span> yum remove <span class="token function">docker</span> <span class="token punctuation">\</span>
                  docker-client <span class="token punctuation">\</span>
                  docker-client-latest <span class="token punctuation">\</span>
                  docker-common <span class="token punctuation">\</span>
                  docker-latest <span class="token punctuation">\</span>
                  docker-latest-logrotate <span class="token punctuation">\</span>
                  docker-logrotate <span class="token punctuation">\</span>
                  docker-engine
</code></pre> 
<p><img src="https://images2.imgbox.com/c8/14/fSDsEriD_o.png" alt="image-20240517154553368"></p> 
<h6><a id="2_gcc_59"></a>2.安装 gcc相关</h6> 
<pre><code class="prism language-sh">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc <span class="token operator">&amp;&amp;</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc-c++
</code></pre> 
<p><img src="https://images2.imgbox.com/50/b5/ZBd3y8LL_o.png" alt="image-20240518195238121"></p> 
<h6><a id="3yumutils_67"></a>3.安装<code>yum-utils</code>软件包</h6> 
<pre><code class="prism language-sh">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils
</code></pre> 
<p><img src="https://images2.imgbox.com/68/ee/E8geYPlW_o.png" alt="image-20240517155524244"></p> 
<h6><a id="4docker_75"></a>4.docker设置阿里云的镜像仓库，最好不要设置国外的</h6> 
<p><img src="https://images2.imgbox.com/67/41/wCx4YeJl_o.png" alt="image-20240517155332913"></p> 
<pre><code class="prism language-sh">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre> 
<p><img src="https://images2.imgbox.com/e2/f8/LuHmU2Sx_o.png" alt="image-20240517155823043"></p> 
<h6><a id="5yumlinuxyum_85"></a>5.更新yum包的索引（linux基础，以后使用yum会快一些）</h6> 
<pre><code class="prism language-sh">yum makecache fast
</code></pre> 
<p><img src="https://images2.imgbox.com/51/a5/vrMVEwvr_o.png" alt="image-20240517155949744"></p> 
<h6><a id="6docker_93"></a>6.安装最新版的docker</h6> 
<pre><code class="prism language-sh">yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</code></pre> 
<p><img src="https://images2.imgbox.com/f4/a7/d63XXJiS_o.png" alt="image-20240517160300623"></p> 
<h6><a id="7dockerdocker_101"></a>7.启动docker进程并查看docker是否成功启动</h6> 
<pre><code class="prism language-sh">systemctl start <span class="token function">docker</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">docker</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/04/11/siS8V3JH_o.png" alt="image-20240517160628449"></p> 
<h6><a id="8docker_109"></a>8.运行docker</h6> 
<p>在本地找不到，会到远程仓库查找镜像</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run hello-world
</code></pre> 
<p><img src="https://images2.imgbox.com/71/69/3rdDW6Qs_o.png" alt="image-20240517160742958"></p> 
<h6><a id="9docker_119"></a>9.停止docker</h6> 
<pre><code class="prism language-sh">systemctl stop <span class="token function">docker</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">docker</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c6/de/eU5iM50w_o.png" alt="image-20240517161145268"></p> 
<h6><a id="10docker_127"></a>10.设置docker自启动并确认是否设置成功！</h6> 
<pre><code class="prism language-sh">systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span> <span class="token operator">&amp;&amp;</span> systemctl is-enabled <span class="token function">docker</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c8/eb/pF73sq9Y_o.png" alt="image-20240517161257256"></p> 
<h6><a id="11_135"></a>11.阿里云镜像加速器配置</h6> 
<h6><a id="1_137"></a>1.找到容器镜像服务</h6> 
<p>https://cr.console.aliyun.com/cn-beijing/instances</p> 
<p><img src="https://images2.imgbox.com/d6/57/LHg0D5W2_o.png" alt="image-20240517161923588"></p> 
<h6><a id="2_143"></a>2.得到镜像加速器地址</h6> 
<p><img src="https://images2.imgbox.com/2c/25/1qb0Eyt6_o.png" alt="image-20240517162247947"></p> 
<h6><a id="3daemonetcdockerdaemonjson_147"></a>3.创建目录，并通过修改daemon配置文件/etc/docker/daemon.json来使用加速器</h6> 
<pre><code class="prism language-sh"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker <span class="token operator">&amp;&amp;</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
  "registry-mirrors": ["https://s0qrw5u9.mirror.aliyuncs.com"]
}
EOF</span>
</code></pre> 
<h6><a id="4daemon_157"></a>4.重启daemon</h6> 
<pre><code class="prism language-sh">systemctl daemon-reload
</code></pre> 
<h6><a id="5docker_163"></a>5.重启docker</h6> 
<pre><code class="prism language-sh">systemctl restart <span class="token function">docker</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">docker</span>
</code></pre> 
<h5><a id="2_169"></a>2.部署规划图</h5> 
<p><img src="https://images2.imgbox.com/3a/25/6w65wBgx_o.png" alt="image-20240519140622123"></p> 
<h5><a id="3Redis_173"></a>3.配置一个基础的Redis容器</h5> 
<h6><a id="1redis608_175"></a>1.拉取redis:6.0.8到本地</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> pull redis:6.0.8
</code></pre> 
<p><img src="https://images2.imgbox.com/66/ac/0KUmA6mk_o.png" alt="image-20240518155651987"></p> 
<h6><a id="2_appredisredis_183"></a>2.在宿主机新建目录 /app/redis，存放redis的配置文件</h6> 
<pre><code class="prism language-sh"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /app/redis
</code></pre> 
<h6><a id="3redis608redisconf_189"></a>3.从redis6.0.8中得到一份redis.conf的配置文件</h6> 
<h6><a id="1opt_191"></a>1.将压缩包上传到/opt目录下</h6> 
<p><img src="https://images2.imgbox.com/b7/8c/F5geNCbW_o.png" alt="image-20240518163817117"></p> 
<h6><a id="2opt_195"></a>2.进入/opt目录然后解压</h6> 
<pre><code class="prism language-sh"><span class="token builtin class-name">cd</span> /opt <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> redis-6.0.8.tar.gz
</code></pre> 
<h6><a id="3redisconfappredis_201"></a>3.复制一份redis.conf到/app/redis目录下</h6> 
<pre><code class="prism language-sh"><span class="token function">cp</span> /opt/redis-6.0.8/redis.conf /app/redis/redis.conf
</code></pre> 
<h6><a id="4_207"></a>4.查看配置文件</h6> 
<pre><code class="prism language-sh">ll /app/redis
</code></pre> 
<p><img src="https://images2.imgbox.com/79/f3/f1CcnbRc_o.png" alt="image-20240519144336734"></p> 
<h6><a id="4_215"></a>4.对配置文件进行修改</h6> 
<h6><a id="1_217"></a>1.编辑配置文件</h6> 
<pre><code class="prism language-sh"><span class="token function">vim</span> /app/redis/redis.conf
</code></pre> 
<h6><a id="2redis_requirepass_foobared_223"></a>2.设置redis密码 requirepass foobared</h6> 
<p><img src="https://images2.imgbox.com/4a/f4/tq5Q88W0_o.png" alt="image-20240519144542709"></p> 
<h6><a id="3redis_bind_127001__protectedmode_227"></a>3.使redis支持远程访问 bind 127.0.0.1 和 protected-mode</h6> 
<p><img src="https://images2.imgbox.com/05/6d/j8eAGU3N_o.png" alt="image-20240519144638041"></p> 
<p><img src="https://images2.imgbox.com/24/a2/L6SwChnQ_o.png" alt="image-20240519144709268"></p> 
<h6><a id="4daemonize_noyesdockerd_233"></a>4.设置daemonize no，如果是yes会与docker的-d方式冲突</h6> 
<p><img src="https://images2.imgbox.com/38/93/5CTu5Iuc_o.png" alt="image-20240519144746500"></p> 
<h6><a id="5Redis_237"></a>5.启动Redis</h6> 
<ul><li>端口映射为6480</li><li>名字为redis-cluster</li><li>/app/redis/redis.conf 挂载 /etc/redis/redis.conf</li><li>/app/redis/data:/data 挂载 /data</li><li>-d：后台启动</li><li>redis:6.0.8：镜像名字</li><li>redis-server /etc/redis/redis.conf 指定容器中的配置文件来启动</li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">6480</span>:6379 <span class="token parameter variable">--name</span> redis-cluster <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /app/redis/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /app/redis/data:/data <span class="token parameter variable">-d</span> redis:6.0.8 <span class="token punctuation">\</span>
redis-server /etc/redis/redis.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/75/60/Q89jcIGP_o.png" alt="image-20240519145435609"></p> 
<h6><a id="6Redis_256"></a>6.连接Redis</h6> 
<h6><a id="1execredis_258"></a>1.使用exec命令进入redis容器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-cluster /bin/bash
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/bc/K47BPjLT_o.png" alt="image-20240519145545009"></p> 
<h6><a id="2rediscli_266"></a>2.连接redis-cli</h6> 
<ul><li>这里的-p指向的是容器的redis端口默认是6379</li><li>-a参数指定密码</li></ul> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> 
</code></pre> 
<h6><a id="3_277"></a>3.进行操作测试</h6> 
<p><img src="https://images2.imgbox.com/83/72/FTWKAXaA_o.png" alt=""></p> 
<h6><a id="76480_281"></a>7.开放6480端口</h6> 
<h6><a id="1_283"></a>1.宝塔开启</h6> 
<pre><code class="prism language-sh">systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">6480</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">6480</span>/tcp
</code></pre> 
<p><img src="https://images2.imgbox.com/02/32/uMVYr1bh_o.png" alt="image-20240519145834678"></p> 
<h6><a id="2_291"></a>2.腾讯云开启</h6> 
<p><img src="https://images2.imgbox.com/56/8e/n4Dsp7dz_o.png" alt="image-20240519150021568"></p> 
<h6><a id="8JedisRedis_295"></a>8.使用Jedis连接Redis测试</h6> 
<p><img src="https://images2.imgbox.com/d2/af/gnSSw6VZ_o.png" alt="image-20240519150143993"></p> 
<h5><a id="4Redis_301"></a>4.使用阿里云镜像仓库，将Redis容器制作为镜像发布（暂时使用不了）</h5> 
<h6><a id="1_303"></a>1.访问阿里云的容器镜像服务</h6> 
<p>https://cr.console.aliyun.com/cn-beijing/instance/repositories</p> 
<h6><a id="2sunxiansheng_307"></a>2.创建一个命名空间sunxiansheng，设置公开</h6> 
<p><img src="https://images2.imgbox.com/18/f6/DiAvgoHS_o.png" alt="image-20240517203410454"></p> 
<h6><a id="3_311"></a>3.创建镜像仓库，记得选择命名空间</h6> 
<h6><a id="1_313"></a>1.创建仓库</h6> 
<p><img src="https://images2.imgbox.com/72/95/ml8CMhkl_o.png" alt="image-20240519151248701"></p> 
<h6><a id="2_317"></a>2.进行配置，选择命名空间和仓库名称</h6> 
<p><img src="https://images2.imgbox.com/6b/45/A0iT313G_o.png" alt="image-20240519151434596"></p> 
<h6><a id="3_321"></a>3.选择本地仓库</h6> 
<p><img src="https://images2.imgbox.com/b6/77/qNaUUZC5_o.png" alt="image-20240519151459043"></p> 
<h6><a id="4_325"></a>4.创建成功!</h6> 
<p><img src="https://images2.imgbox.com/55/2e/LpWDxTNR_o.png" alt="image-20240519151543236"></p> 
<h6><a id="4rediscommit_329"></a>4.将redis容器commit到我们的新镜像（在容器外执行）</h6> 
<h6><a id="1_331"></a>1.命令格式</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> commit <span class="token parameter variable">-m</span><span class="token operator">=</span><span class="token string">"[提交的信息]"</span> <span class="token parameter variable">-a</span><span class="token operator">=</span><span class="token string">"[作者名字]"</span> <span class="token punctuation">[</span>ImageId<span class="token punctuation">]</span> <span class="token punctuation">[</span>名称:版本号<span class="token punctuation">]</span>
</code></pre> 
<h6><a id="2redisImageId_rediscluster10_337"></a>2.查看redis容器的ImageId，并执行命令，构建新镜像 redis-cluster:1.0</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> commit <span class="token parameter variable">-m</span><span class="token operator">=</span><span class="token string">"redis集群基础镜像"</span> <span class="token parameter variable">-a</span><span class="token operator">=</span><span class="token string">"sun"</span> 85e0dc53515f redis-cluster:1.0
</code></pre> 
<p><img src="https://images2.imgbox.com/7d/ce/QKnRcYvA_o.png" alt="image-20240519152419982"></p> 
<h6><a id="5_345"></a>5.将本地镜像发布到阿里云镜像仓库（根据阿里云提供的指令即可）</h6> 
<p><img src="https://images2.imgbox.com/20/1a/Nbd4WGBA_o.png" alt="image-20240519152736012"></p> 
<h6><a id="1_349"></a>1.首先登录阿里云镜像仓库</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> login <span class="token parameter variable">--username</span><span class="token operator">=</span>aliyun8104181328 registry.cn-beijing.aliyuncs.com
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/c9/nYScRqp7_o.png" alt="image-20240519151711109"></p> 
<p><img src="https://images2.imgbox.com/41/be/wlSdNau8_o.png" alt="image-20240519151740831"></p> 
<h6><a id="2_359"></a>2.根据要求设置要推送的本地镜像</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> tag <span class="token punctuation">[</span>ImageId<span class="token punctuation">]</span> registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-sh"><span class="token function">docker</span> tag 5f123e2adb2c registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:1.0
</code></pre> 
<p><img src="https://images2.imgbox.com/93/6e/FnOGAz5f_o.png" alt="image-20240519152636949"></p> 
<h6><a id="3_371"></a>3.发布镜像到阿里云镜像仓库</h6> 
<pre><code>docker push registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:[镜像版本号]
</code></pre> 
<pre><code class="prism language-sh"><span class="token function">docker</span> push registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:1.0
</code></pre> 
<p><img src="https://images2.imgbox.com/e1/c4/LXY98NId_o.png" alt="image-20240519152932335"></p> 
<h6><a id="6_383"></a>6.测试拉取镜像直接执行</h6> 
<h6><a id="1_385"></a>1.首先删除本地的镜像</h6> 
<p><img src="https://images2.imgbox.com/4f/48/BZBE4ey3_o.png" alt="image-20240519153049429"></p> 
<h6><a id="2_389"></a>2.拉取镜像到本地</h6> 
<p><img src="https://images2.imgbox.com/18/78/iqSOVHXU_o.png" alt="image-20240519153130227"></p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> pull registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-sh"><span class="token function">docker</span> pull registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:1.0
</code></pre> 
<p><img src="https://images2.imgbox.com/d8/f5/PIDda2wU_o.png" alt="image-20240519153234146"></p> 
<h6><a id="3appredis_403"></a>3.删除之前进行目录挂载的/app/redis目录，为了测试启动镜像时会不会保留之前的配置</h6> 
<pre><code class="prism language-sh"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /app/redis
</code></pre> 
<h6><a id="4rediscluster_409"></a>4.还要删除本地的redis-cluster容器（保持环境干净）</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> redis-cluster
</code></pre> 
<p><img src="https://images2.imgbox.com/15/90/awEQLTV8_o.png" alt="image-20240519153836614"></p> 
<h6><a id="5appredisredisconf_417"></a>5.由于挂载的时候挂载了一个宿主机的/app/redis/redis.conf文件，所以需要手动创建，否则启动会失败</h6> 
<pre><code class="prism language-sh"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /app/redis <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> /app/redis/redis.conf
</code></pre> 
<h6><a id="6Redis_423"></a>6.启动Redis</h6> 
<ul><li>端口映射为6480</li><li>容器名字为redis-cluster</li><li>/app/redis/redis.conf 挂载 /etc/redis/redis.conf</li><li>/app/redis/data:/data 挂载 /data</li><li>-d：后台启动</li><li>registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:1.0：镜像名字注意要带标签！</li><li>redis-server /etc/redis/redis.conf 指定容器中的配置文件来启动</li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">6480</span>:6379 <span class="token parameter variable">--name</span> redis-cluster <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /app/redis/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /app/redis/data:/data <span class="token parameter variable">-d</span> registry.cn-beijing.aliyuncs.com/sunxiansheng/redis-cluster:1.0 <span class="token punctuation">\</span>
redis-server /etc/redis/redis.conf
</code></pre> 
<h6><a id="7Dockerfile_440"></a>7.自定义镜像需要Dockerfile，等学了之后再来补充</h6> 
<h5><a id="549232227185_442"></a>5.配置另外五台机器（方式类似以49.232.227.185为例）</h5> 
<h6><a id="1redis608_444"></a>1.拉取redis:6.0.8到本地</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> pull redis:6.0.8
</code></pre> 
<p><img src="https://images2.imgbox.com/2c/18/64H6bnbd_o.png" alt="image-20240518155651987"></p> 
<h6><a id="2_appredisredis_452"></a>2.在宿主机新建目录 /app/redis，存放redis的配置文件</h6> 
<pre><code class="prism language-sh"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /app/redis
</code></pre> 
<h6><a id="3redisconf_458"></a>3.从最初的机器上得到配置好的redis.conf</h6> 
<h6><a id="1scpredisconfappredis_460"></a>1.源服务器使用scp发送文件redis.conf到本服务器的/app/redis下</h6> 
<pre><code class="prism language-sh"><span class="token function">scp</span> 源用户@源ip:源文件 目标用户@目标ip:目标文件夹

</code></pre> 
<h6><a id="3Redis_468"></a>3.启动Redis</h6> 
<ul><li>端口映射为6480</li><li>名字为redis-cluster</li><li>/app/redis/redis.conf 挂载 /etc/redis/redis.conf</li><li>/app/redis/data:/data 挂载 /data</li><li>-d：后台启动</li><li>redis:6.0.8：镜像名字</li><li>redis-server /etc/redis/redis.conf 指定容器中的配置文件来启动</li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">6480</span>:6379 <span class="token parameter variable">--name</span> redis-cluster <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /app/redis/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /app/redis/data:/data <span class="token parameter variable">-d</span> redis:6.0.8 <span class="token punctuation">\</span>
redis-server /etc/redis/redis.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/6d/ef/7cIC9ANs_o.png" alt="image-20240519163328718"></p> 
<h6><a id="6Redis_487"></a>6.连接Redis</h6> 
<h6><a id="1execredis_489"></a>1.使用exec命令进入redis容器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-cluster /bin/bash
</code></pre> 
<p><img src="https://images2.imgbox.com/d6/cb/AEd2jEEI_o.png" alt="image-20240519145545009"></p> 
<h6><a id="2rediscli_497"></a>2.连接redis-cli</h6> 
<ul><li>这里的-p指向的是容器的redis端口默认是6379</li><li>-a参数指定密码</li></ul> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> 
</code></pre> 
<h6><a id="3_508"></a>3.进行操作测试</h6> 
<p><img src="https://images2.imgbox.com/b8/2a/YKMNHLjm_o.png" alt=""></p> 
<h6><a id="76480_512"></a>7.开放6480端口</h6> 
<h6><a id="1_514"></a>1.宝塔开启</h6> 
<pre><code class="prism language-sh">systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">6480</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">6480</span>/tcp
</code></pre> 
<p><img src="https://images2.imgbox.com/7e/5d/AOmXLcU1_o.png" alt="image-20240519145834678"></p> 
<h6><a id="2_522"></a>2.腾讯云开启</h6> 
<p><img src="https://images2.imgbox.com/3d/2a/1pyknMNn_o.png" alt="image-20240519150021568"></p> 
<h6><a id="8JedisRedis_526"></a>8.使用Jedis连接Redis测试</h6> 
<p><img src="https://images2.imgbox.com/2b/b8/NOTsEcua_o.png" alt="image-20240519150143993"></p> 
<h3><a id="3_532"></a>3.集群搭建</h3> 
<h5><a id="1_534"></a>1.六台服务器都要配置</h5> 
<h6><a id="1redisconf_536"></a>1.修改redis.conf配置文件</h6> 
<h6><a id="1_538"></a>1.编辑配置文件</h6> 
<pre><code class="prism language-sh"><span class="token function">vim</span> /app/redis/redis.conf
</code></pre> 
<h6><a id="2redisredis_masterauthrequirepass__544"></a>2.设置redis节点连接其他redis的密码 masterauth（与requirepass 一致即可）</h6> 
<p><img src="https://images2.imgbox.com/49/34/tOdh57TW_o.png" alt="image-20240503115843829"></p> 
<h6><a id="3redis_548"></a>3.重启redis容器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> restart redis-cluster
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/7a/WANLgNaS_o.png" alt="image-20240519171426759"></p> 
<h6><a id="210000__port_556"></a>2.开启总线端口10000 + port</h6> 
<h6><a id="116480_558"></a>1.宝塔开启16480端口</h6> 
<pre><code class="prism language-sh">systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">16480</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">16480</span>/tcp
</code></pre> 
<h6><a id="216480_564"></a>2.腾讯云开启16480端口</h6> 
<h6><a id="3_566"></a>3.删除容器，更换为集群模式的启动命令</h6> 
<h6><a id="1_568"></a>1.删除原来的容器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> redis-cluster
</code></pre> 
<p><img src="https://images2.imgbox.com/32/96/67WQHR1b_o.png" alt="image-20240519173654230"></p> 
<h6><a id="2docker_576"></a>2.以集群模式启动的docker命令</h6> 
<ul><li>-d：后台启动</li><li>–name：容器名字为redis-node-1，<strong>后面依次增加序号</strong></li><li>–net：host表示使用主机的ip和端口，会根据指定配置文件中的端口直接在主机使用不需要映射</li><li>–privileged=true：使用数据卷的标配</li><li>/app/redis/redis.conf 挂载 /etc/redis/redis.conf</li><li>/app/redis/data:/data 挂载 /data</li><li>redis:6.0.8：镜像名字</li><li>redis-server：指定配置文件启动</li><li>–cluster-enabled yes：以集群模式启动</li><li>–appendonly yes：使用aof持久化策略</li><li>–dir /data：设置数据（包括 AOF 文件）存储目录在容器内的/data下，会自动同步到主机，因为前面做了挂载</li><li>–port 6480：指定启动端口为6480</li><li>–cluster-config-file /data/nodes.conf：节点配置文件位置在容器内的/data/nodes.conf，会自动同步到主机</li><li>–cluster-node-timeout：设置节点超时时间为5秒</li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> redis-node-1 <span class="token parameter variable">--net</span><span class="token operator">=</span>host <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /app/redis/data:/data <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /app/redis/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
  redis:6.0.8 <span class="token punctuation">\</span>
  redis-server /etc/redis/redis.conf <span class="token punctuation">\</span>
  --cluster-enabled <span class="token function">yes</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--appendonly</span> <span class="token function">yes</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--dir</span> /data <span class="token punctuation">\</span>
  <span class="token parameter variable">--port</span> <span class="token number">6480</span> <span class="token punctuation">\</span>
  --cluster-config-file /data/nodes.conf <span class="token punctuation">\</span>
  --cluster-node-timeout <span class="token number">5000</span>

</code></pre> 
<h6><a id="3appredisdata_608"></a>3.查看目录/app/redis/data，持久化文件以及节点文件都同步过来了！</h6> 
<pre><code class="prism language-sh">ll /app/redis/data/
</code></pre> 
<p><img src="https://images2.imgbox.com/01/42/W00cdULm_o.png" alt="image-20240519180031322"></p> 
<h5><a id="2_616"></a>2.构建主从关系</h5> 
<h6><a id="1_618"></a>1.进入一台机器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-node-5 /bin/bash
</code></pre> 
<h6><a id="2rediscliip6480_624"></a>2.测试连接redis-cli（注意此时的ip已经在启动时指定了6480）</h6> 
<ul><li>–askpass：询问密码的意思</li></ul> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">-p</span> <span class="token number">6480</span> <span class="token parameter variable">--askpass</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/8b/OlQChYOy_o.png" alt="image-20240519180730143"></p> 
<h6><a id="3rediscli_634"></a>3.退出redis-cli进行集群构建</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token parameter variable">--askpass</span> 
</code></pre> 
<h6><a id="4_640"></a>4.构建成功！</h6> 
<h6><a id="510000__6480_644"></a>5.如果发现一直在构建，原因是需要开启总线的端口也就是10000 + 6480</h6> 
<h5><a id="3_648"></a>3.常用命令</h5> 
<h6><a id="1redisrediscli_650"></a>1.首先进入redis容器的redis-cli</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">6480</span> <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="2_656"></a>2.查看集群信息</h6> 
<pre><code class="prism language-sh">CLUSTER INFO
</code></pre> 
<p><img src="https://images2.imgbox.com/32/74/q9oqRWG6_o.png" alt="image-20240519182825973"></p> 
<h6><a id="3_664"></a>3.查看集群节点</h6> 
<pre><code class="prism language-sh"> CLUSTER NODES
</code></pre> 
<h5><a id="4SpringBoot_671"></a>4.SpringBoot测试连接</h5> 
<h6><a id="1pomxml_673"></a>1.pom.xml</h6> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.sun.redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redis_springboot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Archetype - redis_springboot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://maven.apache.org<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 说 明 : 如 果 这 里 是 spring-boot-start 就 改 成 如 下
            spring-boot-start-web--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- redis --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- spring2.X 集成 redis 所需 common-pool--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--不要带版本号,防止冲突--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.13.2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<h6><a id="2applicationyml_738"></a>2.application.yml</h6> 
<pre><code class="prism language-sh">
<span class="token comment"># redis集群配置</span>
spring:
  redis:
    password: <span class="token comment"># Redis服务器密码</span>
    database: <span class="token number">0</span> <span class="token comment"># 默认数据库为0号</span>
    timeout: 10000ms <span class="token comment"># 连接超时时间是10000毫秒</span>
    lettuce:
      pool:
        max-active: <span class="token number">8</span> <span class="token comment"># 最大活跃连接数,使用负值表示没有限制，最佳配置为核数*2</span>
        max-wait: 10000ms <span class="token comment"># 最大等待时间,单位为毫秒,使用负值表示没有限制，这里设置为10秒</span>
        max-idle: <span class="token number">200</span> <span class="token comment"># 最大空闲连接数</span>
        min-idle: <span class="token number">5</span> <span class="token comment"># 最小空闲连接数</span>
    cluster:
      nodes:


</code></pre> 
<h6><a id="3Redis_760"></a>3.Redis配置类</h6> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonAutoDetect</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonTypeInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertyAccessor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>jsontype<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">LaissezFaireSubTypeValidator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">CachingConfigurerSupport</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">RedisConnectionFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">Jackson2JsonRedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">RedisSerializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Description:
 *
 * @Author sun
 * @Create 2024/4/29 21:29
 * @Version 1.0
 */</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token keyword">extends</span> <span class="token class-name">CachingConfigurerSupport</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"template=&gt;"</span> <span class="token operator">+</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisSerializer <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span>
                <span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">NON_FINAL</span><span class="token punctuation">,</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>As</span><span class="token punctuation">.</span><span class="token constant">WRAPPER_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key 序列化方式</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// value 序列化</span>
        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// value hashmap 序列化</span>
        template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisSerializer <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span>
                <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解决查询缓存转换异常的问题</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span>
                <span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">NON_FINAL</span><span class="token punctuation">,</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>As</span><span class="token punctuation">.</span><span class="token constant">WRAPPER_ARRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置序列化（解决乱码的问题）,过期时间 600 秒</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisCacheManager</span> cacheManager <span class="token operator">=</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cacheManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="4controller_846"></a>4.测试的controller</h6> 
<p><img src="https://images2.imgbox.com/aa/d8/EYJuEPWS_o.png" alt="image-20240519183728717"></p> 
<h6><a id="5_850"></a>5.启动测试</h6> 
<p><img src="https://images2.imgbox.com/9e/7b/TFPQICj5_o.png" alt="image-20240519183932494"></p> 
<h5><a id="5_Unable_to_connect_to_1028116480_connection_timed_out_1028116480_854"></a>5.报错 Unable to connect to [10.2.8.11:6480]: connection timed out: /10.2.8.11:6480</h5> 
<h6><a id="1redisconfclusterannounceipip_856"></a>1.这个显示的是连接的内网地址，所以需要配置redis.conf的cluster-announce-ip来暴露服务器外网ip</h6> 
<h6><a id="2_858"></a>2.编辑配置文件</h6> 
<pre><code class="prism language-sh"><span class="token function">vim</span> /app/redis/redis.conf
</code></pre> 
<h6><a id="3_clusterannounceip_ip_864"></a>3.配置 cluster-announce-ip 为每台服务器的外网ip</h6> 
<h6><a id="4redis_868"></a>4.重启redis容器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> restart 。。。
</code></pre> 
<h6><a id="5_874"></a>5.此时就不会再出现连接内网超时的问题了</h6> 
<h3><a id="4_876"></a>4.主从扩容和主从缩容</h3> 
<h5><a id="1_878"></a>1.主从扩容</h5> 
<h6><a id="1_880"></a>1.启动一台主机</h6> 
<h6><a id="1_redisconf__882"></a>1.使用配置好的 redis.conf 启动容器</h6> 
<ul><li>注意这里的cluster-announce-ip还是使用的配置文件中本服务器的ip</li><li>节点密码也是用的配置文件中的</li><li>需要修改的配置 
  <ul><li>–name redis-node-7</li><li>-v /app/redis/nodes7data:/data</li><li>–cluster-config-file /data/nodes7.conf</li><li>–port 6481</li></ul> </li></ul> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> redis-node-7 <span class="token parameter variable">--net</span><span class="token operator">=</span>host <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /app/redis/nodes7data:/data <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /app/redis/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
  redis:6.0.8 <span class="token punctuation">\</span>
  redis-server /etc/redis/redis.conf <span class="token punctuation">\</span>
  --cluster-enabled <span class="token function">yes</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--appendonly</span> <span class="token function">yes</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--dir</span> /data <span class="token punctuation">\</span>
  <span class="token parameter variable">--port</span> <span class="token number">6481</span> <span class="token punctuation">\</span>
  --cluster-config-file /data/nodes7.conf <span class="token punctuation">\</span>
  --cluster-node-timeout <span class="token number">5000</span>
</code></pre> 
<h6><a id="2data_906"></a>2.查看配置data目录是否同步</h6> 
<p><img src="https://images2.imgbox.com/83/08/coCLfWQC_o.png" alt="image-20240520134108395"></p> 
<h6><a id="3648116481_910"></a>3.开启端口6481和16481</h6> 
<pre><code class="prism language-sh">systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">6481</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">6481</span>/tcp <span class="token operator">&amp;&amp;</span> systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">16481</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">16481</span>/tcp
</code></pre> 
<p><img src="https://images2.imgbox.com/59/80/WOJQafxA_o.png" alt="image-20240520134213034"></p> 
<p><img src="https://images2.imgbox.com/5d/fa/2oZqYVmR_o.png" alt="image-20240520134327012"></p> 
<h6><a id="4jedis_920"></a>4.jedis测试连接</h6> 
<h6><a id="2_924"></a>2.启动一台从机</h6> 
<h6><a id="1_redisconf__926"></a>1.使用配置好的 redis.conf 启动容器</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> redis-node-8 <span class="token parameter variable">--net</span><span class="token operator">=</span>host <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /app/redis/nodes8data:/data <span class="token punctuation">\</span>
  <span class="token parameter variable">-v</span> /app/redis/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
  redis:6.0.8 <span class="token punctuation">\</span>
  redis-server /etc/redis/redis.conf <span class="token punctuation">\</span>
  --cluster-enabled <span class="token function">yes</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--appendonly</span> <span class="token function">yes</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--dir</span> /data <span class="token punctuation">\</span>
  <span class="token parameter variable">--port</span> <span class="token number">6482</span> <span class="token punctuation">\</span>
  --cluster-config-file /data/nodes8.conf <span class="token punctuation">\</span>
  --cluster-node-timeout <span class="token number">5000</span>
</code></pre> 
<h6><a id="2648216482_942"></a>2.开启端口6482和16482</h6> 
<pre><code class="prism language-sh">systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">6482</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">6482</span>/tcp <span class="token operator">&amp;&amp;</span> systemctl start firewalld <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">16482</span>/tcp <span class="token operator">&amp;&amp;</span> firewall-cmd <span class="token parameter variable">--reload</span> <span class="token operator">&amp;&amp;</span> firewall-cmd --query-port<span class="token operator">=</span><span class="token number">1648</span>
<span class="token number">2</span>/tcp
</code></pre> 
<h6><a id="3jedis_949"></a>3.jedis测试连接</h6> 
<h6><a id="37master_953"></a>3.将新增的7号节点作为master节点加入原集群</h6> 
<h6><a id="1_955"></a>1.进入七号容器内部</h6> 
<pre><code class="prism language-sh"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-node-7 /bin/bash
</code></pre> 
<h6><a id="2_961"></a>2.添加七号节点到集群（选择任意一个节点即可）</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="36481master_969"></a>3.检查集群情况，可以看到6481已经作为一个master加入了</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> check  <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="4_977"></a>4.重新分配槽位</h6> 
<h6><a id="1_979"></a>1.执行指令，重新分配槽位</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> reshard  <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="2_987"></a>2.计算平均槽位并分配给新机器</h6> 
<p><img src="https://images2.imgbox.com/d4/e7/bpliHVw0_o.png" alt="image-20240520141445747"></p> 
<h6><a id="3all__yes4096_995"></a>3.选择all + yes，意思就是，从其他三台机器共提取4096个槽位给新机器</h6> 
<p><img src="https://images2.imgbox.com/f1/61/PYSQt84g_o.png" alt="image-20240520141645625"></p> 
<p><img src="https://images2.imgbox.com/fa/47/HEhuRgUD_o.png" alt="image-20240520141703498"></p> 
<h6><a id="4_1001"></a>4.检查集群情况，发现分配规则是前几个机器匀了槽位给新机器</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> check  <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="587_1009"></a>5.添加8号从机到7号主机下面</h6> 
<h6><a id="1_1011"></a>1.执行指令添加</h6> 
<ul><li>a9d42be282f99864cf95500ca909ae55dab5eb6b是主机的id</li></ul> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> add-node  --cluster-slave --cluster-master-id a9d42be282f99864cf95500ca909ae55dab5eb6b <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="2_1021"></a>2.检查集群情况</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> check <span class="token parameter variable">--askpass</span>
</code></pre> 
<h6><a id="6SpringBoot_1028"></a>6.SpringBoot测试连接</h6> 
<h6><a id="1key_1030"></a>1.测试是否可以设置key</h6> 
<p><img src="https://images2.imgbox.com/03/fa/ht6JoDIf_o.png" alt="image-20240520143445686"></p> 
<p><img src="https://images2.imgbox.com/65/9b/m71AsapV_o.png" alt="image-20240520143623117"></p> 
<h6><a id="2_1038"></a>2.检查集群情况，观察是否四个机器都能插入</h6> 
<pre><code class="prism language-sh">redis-cli <span class="token parameter variable">--cluster</span> check <span class="token parameter variable">--askpass</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2fce31104ca278a01e314925361fa2cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[Collection与数据结构] Map与Set(二):哈希表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5d674b10f7daee8be9843e8ba5fb11aa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI积累-CPU（中央处理单元）和GPU（图形处理单元）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>