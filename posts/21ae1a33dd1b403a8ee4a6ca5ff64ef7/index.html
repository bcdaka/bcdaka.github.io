<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>安卓ANR问题最全解析 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/21ae1a33dd1b403a8ee4a6ca5ff64ef7/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="安卓ANR问题最全解析">
  <meta property="og:description" content="目录 前言一、ANR产生原因二、Timeout时长三、典型的ANR场景四、超时检测机制五、前台与后台ANR六、ANR分析流程七、trace.txt文件解读八、ANR定位分析实例8.1 Logcat分析8.2 trace.txt文件分析 九、ANR源码分析十、ANR实例及分析10.1 应用在主线程上进行长时间的计算10.2 应用在主线程上执行耗时的I/O的操作10.3 主线程处于阻塞状态，等待获取锁10.4 主线程与其他线程之间发生死锁10.5 主线程对另一个进程进行同步Binder调用，后者需很长时间才能返回 十一、总结 前言 ANR即Application Not Responding(应用程序无响应)，一般在ANR的时候会弹出一个应用无响应对话框，同时会候产生一个日志文件trace.txt，位于/data/anr/文件夹下面，trace文件是Android Davik虚拟机在收到异常终止信号时产生的，最常见的一个触发条件就是Android应用中产生了FC(force close)。由于该文件的产生是在DVM中的，所以只有运行DVM实例的进程才能产生该文件，也就是说只有Java代码才能产生该文件，App应用的Native层（如Android Library、用c/c&#43;&#43;编译的库）即使异常也不会产生ANR日志文件。我们可以通过ANR产生的traces日志文件分析应用在哪里产生了ANR，以此来有效解决应用中的ANR。
一、ANR产生原因 只用当应用程序的UI线程响应超时才会引起ANR，超时原因一般有两种：
1.当前的事件没有机会得到处理，例如UI线程正在响应另一个事件，当前事件由于某种原因被阻塞了。2.当前的事件正在被处理，但是由于好事太长没有能够及时完成 根据ANR产生的原因不同，超时时间也不尽相同，从本质上讲，产生ANR的场景有四种，大致可以对应到Android中的（Activity、BroadcastReceive、Service、InputDispatch）
第一种：InputDispatching Timeout ：最常见的一种类型，原因是View事件或者触摸事件在特定时间内无法得到响应
第二种：Broadcast Timeout：BroadcastReceiver的onReceive函数运行在主线程，并在特定的时间内无法完成处理
第三种：Service Timeout：Service的各个生命周期函数在特定时间内无法完成响应
第四种：ContentProvider Timeout ：ContentProvider的操作在特定时间内无法完成响应。
二、Timeout时长 对于前台服务，则超时为SERVICE_TIMEOUT=20S;对于后台服务，则超时为SERVICE BACKGROUND TIMEOUT=200S·对于前台广播，则超时为BROADCAST FG TIMEOUT=10S;对于后台广播，则超时为BROADCAST BG TIMEOUT=60s;.ContentProvider超时为CONTENT PROVIDER PUBLISH TIMEOUT = 10S:.InputDispatching Timeout: 输入事件分发超时5s，包括按键和触摸事件。 注意事项: Input的超时机制与其他的不同，对于input来说即便某次事件执行时间超过timeout时长，只要用户后续在没有再生成输入事件，则不会触发ANR
三、典型的ANR场景 1.主线程频繁进行IO操作，比如读写文件或者数据库；2.硬件操作如进行调用照相机或者录音等操作；3.多线程操作的死锁，导致主线程等待超时；4.主线程操作调用join()方法、sleep()方法或者wait()方法；5.耗时动画/耗资源行为导致CPU负载过重6.system server中发生WatchDog ANR；7.service binder的数量达到上限 四、超时检测机制 1.Service超时检测机制:
超过一定时间没有执行完相应操作来触发移除延时消息，则会触发anr; 2.BroadcastReceiver超时检测机制:
有序广播的总执行时间超过 2receiver个数timeout时长，则会触发anr;有序广播的某一个receiver执行过程超过 timeout时长，则会触发anr; 3.另外:
对于Service, Broadcast, Input发生ANR之后,最终都会调用AMS.appNotResponding;对于provider,在其进程启动时publish过程可能会出现ANR,则会直接杀进程以及清理相应信息,而不会弹出ANR的对话框 五、前台与后台ANR 前台ANR：用户能感知，比如拥有前台可见的activity的进程，或者拥有前台通知的fg-service的进程，此时发生ANR对用户体验影响比较大，需要弹框让用户决定是否退出还是等待后台ANR：只抓取发生无响应进程的trace，也不会收集CPU信息，并且会在后台直接杀掉该无响应的进程，不会弹框提示用户 六、ANR分析流程 1. 前台ANR发生后，系统会马上去抓取现场的信息，用于调试分析，收集的信息如下:">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-16T19:01:33+08:00">
    <meta property="article:modified_time" content="2024-07-16T19:01:33+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">安卓ANR问题最全解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">前言</a></li><li><a href="#ANR_16" rel="nofollow">一、ANR产生原因</a></li><li><a href="#Timeout_32" rel="nofollow">二、Timeout时长</a></li><li><a href="#ANR_44" rel="nofollow">三、典型的ANR场景</a></li><li><a href="#_56" rel="nofollow">四、超时检测机制</a></li><li><a href="#ANR_69" rel="nofollow">五、前台与后台ANR</a></li><li><a href="#ANR_76" rel="nofollow">六、ANR分析流程</a></li><li><a href="#tracetxt_98" rel="nofollow">七、trace.txt文件解读</a></li><li><a href="#ANR_266" rel="nofollow">八、ANR定位分析实例</a></li><li><ul><li><a href="#81_Logcat_267" rel="nofollow">8.1 Logcat分析</a></li><li><a href="#82_tracetxt_343" rel="nofollow">8.2 trace.txt文件分析</a></li></ul> 
  </li><li><a href="#ANR_437" rel="nofollow">九、ANR源码分析</a></li><li><a href="#ANR_850" rel="nofollow">十、ANR实例及分析</a></li><li><ul><li><a href="#101__852" rel="nofollow">10.1 应用在主线程上进行长时间的计算</a></li><li><a href="#102_IO_1055" rel="nofollow">10.2 应用在主线程上执行耗时的I/O的操作</a></li><li><a href="#103__1179" rel="nofollow">10.3 主线程处于阻塞状态，等待获取锁</a></li><li><a href="#104__1341" rel="nofollow">10.4 主线程与其他线程之间发生死锁</a></li><li><a href="#105_Binder_1459" rel="nofollow">10.5 主线程对另一个进程进行同步Binder调用，后者需很长时间才能返回</a></li></ul> 
  </li><li><a href="#_1679" rel="nofollow">十一、总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_4"></a>前言</h2> 
<p>ANR即<code>Application Not Responding</code>(应用程序无响应)，一般在ANR的时候会弹出一个应用无响应对话框，同时会候产生一个日志文件trace.txt，位于/data/anr/文件夹下面，trace文件是Android Davik虚拟机在收到异常终止信号时产生的，最常见的一个触发条件就是Android应用中产生了<code>FC(force close)</code>。由于该文件的产生是在DVM中的，所以只有运行DVM实例的进程才能产生该文件，也就是说只有Java代码才能产生该文件，App应用的Native层（如Android Library、用c/c++编译的库）即使异常也不会产生ANR日志文件。我们可以通过ANR产生的traces日志文件分析应用在哪里产生了ANR，以此来有效解决应用中的ANR。</p> 
<h2><a id="ANR_16"></a>一、ANR产生原因</h2> 
<p>只用当应用程序的UI线程响应超时才会引起ANR，超时原因一般有两种：</p> 
<ul><li>1.当前的事件没有机会得到处理，例如UI线程正在响应另一个事件，当前事件由于某种原因被阻塞了。</li><li>2.当前的事件正在被处理，但是由于好事太长没有能够及时完成</li></ul> 
<p>根据ANR产生的原因不同，超时时间也不尽相同，从本质上讲，产生ANR的场景有四种，大致可以对应到Android中的（Activity、BroadcastReceive、Service、InputDispatch）</p> 
<blockquote> 
 <p>第一种：InputDispatching Timeout ：最常见的一种类型，原因是View事件或者触摸事件在特定时间内无法得到响应<br> 第二种：Broadcast Timeout：BroadcastReceiver的onReceive函数运行在主线程，并在特定的时间内无法完成处理<br> 第三种：Service Timeout：Service的各个生命周期函数在特定时间内无法完成响应<br> 第四种：ContentProvider Timeout ：ContentProvider的操作在特定时间内无法完成响应。</p> 
</blockquote> 
<h2><a id="Timeout_32"></a>二、Timeout时长</h2> 
<ul><li>对于前台服务，则超时为SERVICE_TIMEOUT=20S;</li><li>对于后台服务，则超时为SERVICE BACKGROUND TIMEOUT=200S·</li><li>对于前台广播，则超时为BROADCAST FG TIMEOUT=10S;</li><li>对于后台广播，则超时为BROADCAST BG TIMEOUT=60s;.</li><li>ContentProvider超时为CONTENT PROVIDER PUBLISH TIMEOUT = 10S:.</li><li>InputDispatching Timeout: 输入事件分发超时5s，包括按键和触摸事件。</li></ul> 
<blockquote> 
 <p>注意事项: Input的超时机制与其他的不同，对于input来说即便某次事件执行时间超过timeout时长，只要用户后续在没有再生成输入事件，则不会触发ANR</p> 
</blockquote> 
<hr> 
<h2><a id="ANR_44"></a>三、典型的ANR场景</h2> 
<ul><li>1.主线程频繁进行IO操作，比如读写文件或者数据库；</li><li>2.硬件操作如进行调用照相机或者录音等操作；</li><li>3.多线程操作的死锁，导致主线程等待超时；</li><li>4.主线程操作调用join()方法、sleep()方法或者wait()方法；</li><li>5.耗时动画/耗资源行为导致CPU负载过重</li><li>6.system server中发生WatchDog ANR；</li><li>7.service binder的数量达到上限</li></ul> 
<hr> 
<h2><a id="_56"></a>四、超时检测机制</h2> 
<p>1.Service超时检测机制:</p> 
<ul><li>超过一定时间没有执行完相应操作来触发移除延时消息，则会触发anr;</li></ul> 
<p>2.BroadcastReceiver超时检测机制:</p> 
<ul><li>有序广播的总执行时间超过 2<em>receiver个数</em>timeout时长，则会触发anr;</li><li>有序广播的某一个receiver执行过程超过 timeout时长，则会触发anr;</li></ul> 
<p>3.另外:</p> 
<ul><li>对于Service, Broadcast, Input发生ANR之后,最终都会调用AMS.appNotResponding;</li><li>对于provider,在其进程启动时publish过程可能会出现ANR,则会直接杀进程以及清理相应信息,而不会弹出ANR的对话框</li></ul> 
<hr> 
<h2><a id="ANR_69"></a>五、前台与后台ANR</h2> 
<ul><li>前台ANR：用户能感知，比如拥有前台可见的activity的进程，或者拥有前台通知的fg-service的进程，此时发生ANR对用户体验影响比较大，需要弹框让用户决定是否退出还是等待</li><li>后台ANR：只抓取发生无响应进程的trace，也不会收集CPU信息，并且会在后台直接杀掉该无响应的进程，不会弹框提示用户</li></ul> 
<hr> 
<h2><a id="ANR_76"></a>六、ANR分析流程</h2> 
<p><strong>1. 前台ANR发生后，系统会马上去抓取现场的信息，用于调试分析，收集的信息如下:</strong></p> 
<ul><li>将am anr信息输出到EventLog，也就是说ANR触发的时间点最接近的就是EventLog中输出的am anr信息</li><li>收集以下重要进程的各个线程调用栈trace信息，保存在data/anr/traces.txt文件<br> ①当前发生ANR的进程，system server进程以及所有persistent进程<br> ②audioserver,cameraserver, mediaserver, surfaceflinger等重要的native进程<br> ③CPU使用率排名前5的进程</li><li>将发生ANR的reason以及CPU使用情况信息输出到main log。</li><li>将traces文件和CPU使用情况信息保存到dropbox，即data/system/dropbox目录。</li><li>对用户可感知的进程则弹出ANR对话框告知用户，对用户不可感知的进程发生ANR则直接杀掉</li></ul> 
<p><strong>2. 分析步骤</strong></p> 
<p>1.定位发生ANR时间点<br> 2.查看trace信息<br> 3.分析是否有耗时的message,binder调用，锁的竞争，CPU资源的抢占<br> 4.结合具体的业务场景的上下文来分析</p> 
<hr> 
<h2><a id="tracetxt_98"></a>七、trace.txt文件解读</h2> 
<p>1.人为的收集trace.txt的命令</p> 
<pre><code class="prism language-c">adb shell ki11<span class="token operator">-</span><span class="token number">3</span> <span class="token number">888</span> <span class="token comment">//可指定进程pid</span>
</code></pre> 
<p>执行完该命令后traces信息的结果保存到文件/data/anr/traces.txt</p> 
<p>2.trace文件解读</p> 
<pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">888</span> at <span class="token number">2016</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">11</span> <span class="token number">22</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">22</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Cmd</span> line<span class="token operator">:</span>system server
<span class="token constant">ABI</span><span class="token operator">:</span>arm
<span class="token class-name">Build</span> type<span class="token operator">:</span> optimized
<span class="token class-name">Zygote</span> loaded classes<span class="token operator">=</span><span class="token number">4113</span> post zygote classes<span class="token operator">=</span><span class="token number">3239</span>
<span class="token class-name">Intern</span> table<span class="token operator">:</span><span class="token number">57550</span> strong<span class="token punctuation">;</span><span class="token number">9315</span> weak
<span class="token constant">JNI</span><span class="token operator">:</span><span class="token class-name">CheckINI</span> is off<span class="token punctuation">;</span>globals<span class="token operator">=</span><span class="token function">2418</span><span class="token punctuation">(</span>plus <span class="token number">115</span> weak<span class="token punctuation">)</span>
<span class="token class-name">Libraries</span><span class="token operator">:</span><span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libandroid<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libandroid_servers<span class="token punctuation">.</span>so
<span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libaudioeffect jni<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libcompiler rt<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libjavacrypto<span class="token punctuation">.</span>so 
<span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libjnigraphics<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libmedia jni<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>librs_jni<span class="token punctuation">.</span>so 
<span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libsechook<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libshell_jni<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libsoundpool<span class="token punctuation">.</span>so 
<span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libwebviewchromium_loader<span class="token punctuation">.</span>so <span class="token operator">/</span>system<span class="token operator">/</span>lib<span class="token operator">/</span>libwifi<span class="token operator">-</span>service<span class="token punctuation">.</span>so 
<span class="token operator">/</span>vendor<span class="token operator">/</span>lib<span class="token operator">/</span>libalarmservice_jni<span class="token punctuation">.</span>so <span class="token operator">/</span>vendor<span class="token operator">/</span>lib<span class="token operator">/</span>liblocationservice<span class="token punctuation">.</span>so libjavacore<span class="token punctuation">.</span>so <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
<span class="token comment">//已分配堆内存大小40MB，其中29M已用，总分配207772个对象</span>
<span class="token class-name">Heap</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">%</span>free<span class="token punctuation">,</span><span class="token number">29</span><span class="token constant">MB</span><span class="token operator">/</span><span class="token number">40</span><span class="token constant">MB</span><span class="token punctuation">;</span><span class="token number">307772</span> objects
·<span class="token punctuation">.</span>· <span class="token comment">//省略GC相关信息</span>
<span class="token comment">//当前进程总99个线程</span>
<span class="token class-name">DALVIK</span> <span class="token constant">THREADS</span> <span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token comment">//主线程调用栈</span>
<span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> <span class="token class-name">Native</span>
<span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x75bd9fb0</span> self<span class="token operator">=</span><span class="token number">0x5573d4f770</span>
<span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">12078</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa75fafe8</span>
<span class="token operator">|</span> state<span class="token operator">=</span><span class="token class-name">S</span> schedstat<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5907843636</span> <span class="token number">827600677</span> <span class="token number">5112</span><span class="token punctuation">)</span>utm<span class="token operator">=</span><span class="token number">453</span> stm<span class="token operator">=</span><span class="token number">137</span> core<span class="token operator">=</span><span class="token number">0</span> <span class="token constant">HZ</span><span class="token operator">=</span><span class="token number">100</span>
<span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd64ef000</span><span class="token operator">-</span><span class="token number">0x7fd64f1000</span> stackSize<span class="token operator">=</span><span class="token number">8</span><span class="token constant">MB</span>
<span class="token operator">|</span> held mutexes<span class="token operator">=</span>
<span class="token comment">//内核栈</span>
kernel<span class="token operator">:</span>_switch_to<span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">/</span><span class="token number">0x7c</span>
<span class="token class-name">Kernel</span><span class="token operator">:</span><span class="token class-name">SyS_epoll_wait</span><span class="token operator">+</span><span class="token number">0x2a0</span><span class="token operator">/</span><span class="token number">0x324</span>
kernel<span class="token operator">:</span><span class="token class-name">SyS</span> epoll_pwait<span class="token operator">+</span><span class="token number">0xa4</span><span class="token operator">/</span><span class="token number">0x120</span>
kernel<span class="token operator">:</span>cpu_switch_to<span class="token operator">+</span>x48<span class="token operator">/</span><span class="token number">0x4c</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">00</span> pc <span class="token number">0000080000869</span>be4 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>_epoll_pwait<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">01</span> pc <span class="token number">008000000001</span>cca4 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>epoll_pwait<span class="token operator">+</span><span class="token number">32</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">82</span> pc <span class="token number">888808008881</span>ad74 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>_ZN7android6Looper9pollInnerEi<span class="token operator">+</span><span class="token number">144</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">03</span> pc <span class="token number">000000000001</span>b154 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android6Looper8poll0nceEiPiS1 <span class="token class-name">PPv</span><span class="token operator">+</span><span class="token number">80</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">04</span> pc <span class="token number">00000000000d</span><span class="token number">4</span>bc0 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libandroid_runtime<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android18NativeMessageQueue8poll0nceEP7 <span class="token class-name">INIEnvP8</span> jobjecti<span class="token operator">+</span><span class="token number">48</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">05</span> pc <span class="token number">000000000000082</span>c <span class="token operator">/</span>data<span class="token operator">/</span>dalvik<span class="token operator">-</span>cache<span class="token operator">/</span>arm64<span class="token operator">/</span>system<span class="token annotation punctuation">@framework</span><span class="token annotation punctuation">@boot.oat</span>
<span class="token punctuation">(</span><span class="token class-name">Java</span> android os <span class="token class-name">MessageQueue</span> nativePollOnce_JI<span class="token operator">+</span><span class="token number">144</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>MessageQueue</span><span class="token punctuation">.</span><span class="token function">nativePoll0nce</span><span class="token punctuation">(</span><span class="token class-name">Native</span> method<span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>MessageQueue</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token class-name">MessageQueue</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">323</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">135</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span>SystemServer</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SystemServer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">290</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span>SystemServer</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">SystemServer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">175</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Native</span> method<span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>ZygoteInit</span>$<span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>zygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">738</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>ZygoteInit</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">628</span><span class="token punctuation">)</span>

<span class="token string">"Binder 1"</span>prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">8</span> <span class="token class-name">Native</span>
<span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x12c610a0</span> self<span class="token operator">=</span><span class="token number">0x5573e5c750</span>
<span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">12092</span> nice<span class="token operator">=</span><span class="token number">0</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa2743450</span>
<span class="token operator">|</span> state<span class="token operator">=</span><span class="token class-name">S</span> schedstat<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">796240075</span> <span class="token number">863170759</span> <span class="token number">3586</span><span class="token punctuation">)</span>utm<span class="token operator">=</span><span class="token number">50</span> stm<span class="token operator">=</span><span class="token number">29</span> core<span class="token operator">=</span><span class="token number">1</span> <span class="token constant">HZ</span><span class="token operator">=</span><span class="token number">100</span>
<span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fa2647000</span><span class="token operator">-</span><span class="token number">0</span>x7fa2649000stackSize<span class="token operator">=</span><span class="token number">1013</span><span class="token constant">KB</span>
<span class="token operator">|</span> held mutexes<span class="token operator">=</span>
kernel<span class="token operator">:</span>__switch_to<span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">/</span><span class="token number">0x7c</span>
kernel<span class="token operator">:</span>binder_thread_read<span class="token operator">+</span><span class="token number">0xd78</span><span class="token operator">/</span><span class="token number">0xeb0</span>
kernel<span class="token operator">:</span>binder_ioctl_write_read<span class="token operator">+</span><span class="token number">0x178</span><span class="token operator">/</span><span class="token number">0x24c</span>
kernel<span class="token operator">:</span>binder_ioctl<span class="token operator">+</span><span class="token number">0x2b0</span><span class="token operator">/</span><span class="token number">0x5e0</span>
kernel<span class="token operator">:</span>do_vfs_ioct1<span class="token operator">+</span><span class="token number">0x4a4</span><span class="token operator">/</span><span class="token number">0x578</span>
kernel<span class="token operator">:</span><span class="token class-name">SyS_ioctl</span><span class="token operator">+</span>x5c<span class="token operator">/</span><span class="token number">0x88</span>
kernel<span class="token operator">:</span>cpu_switch_to<span class="token operator">+</span>x48<span class="token operator">/</span><span class="token number">0x4c</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">00</span> pc <span class="token number">000000000069</span>cd0<span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>__ioctl<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">01</span> pc <span class="token number">0000000000073</span>cf4 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>ioctl<span class="token operator">+</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">02</span> pc <span class="token number">000000000002d</span><span class="token number">6e8</span> <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android14IPcThreadstate14talkWithDriverEb<span class="token operator">+</span><span class="token number">164</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">03</span> pc <span class="token number">800000000002d</span>f3c <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android14IPCThreadstate20getAndExecuteCommandEv<span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">04</span> pc <span class="token number">800000000002e114</span><span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android14IPcThreadState14ioinThreadPoolEb<span class="token operator">+</span><span class="token number">124</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">05</span> pc <span class="token number">800000800036</span>c38 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">06</span> pc <span class="token number">0000000001579</span>c<span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android6Thread11threadLoopEPv<span class="token operator">+</span><span class="token number">208</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">07</span> pc <span class="token number">0000000000090598</span> <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libandroid_runtime<span class="token punctuation">.</span>so
<span class="token punctuation">(</span>_ZN7android14AndroidRuntime15javaThreadShellEPv<span class="token operator">+</span><span class="token number">96</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">08</span> pc <span class="token number">0000000000014f</span>ec <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">09</span> pc <span class="token number">8888000000067754</span> <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>_ZL15_pthread_startPv<span class="token operator">+</span><span class="token number">52</span><span class="token punctuation">)</span>
<span class="token keyword">native</span><span class="token operator">:</span>#<span class="token number">10</span> pc <span class="token number">000000000001</span>c644 <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span><span class="token punctuation">(</span>_start_thread<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>no managed stack frames<span class="token punctuation">)</span>
<span class="token punctuation">.</span>·<span class="token comment">//此处省略剩余的N个线程</span>
</code></pre> 
<p>3.trace参数解读</p> 
<pre><code class="prism language-c"><span class="token string">"Binder 1"</span>prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">8</span> Native
<span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obi<span class="token operator">=</span><span class="token number">0x12c610a0</span> self<span class="token operator">=</span><span class="token number">0x5573e5c750</span>
<span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">12092</span> nice<span class="token operator">=</span><span class="token number">0</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa2743450</span>
<span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">796240075</span> <span class="token number">863170759</span> <span class="token number">3586</span><span class="token punctuation">)</span>utm<span class="token operator">=</span><span class="token number">50</span> stm<span class="token operator">=</span><span class="token number">29</span> core<span class="token operator">=</span><span class="token number">1</span> HZ<span class="token operator">=</span><span class="token number">100</span>
<span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fa2647000</span><span class="token operator">-</span><span class="token number">0x7fa2649000</span> stackSize<span class="token operator">=</span><span class="token number">1013</span>KB
<span class="token operator">|</span> held mutexes<span class="token operator">=</span>
</code></pre> 
<ul><li>第0行:<br> 线程名: Binder_1(如有daemon则代表守护线程)<br> prio:线程优先级，优先级取值范围[1,10]，详见Thread类：<br> tid: 线程内部id<br> 线程状态: NATIVE。状态取值如下，详见Thread.State枚举类：</li></ul> 
<p>线程优先级</p> 
<pre><code class="prism language-c"><span class="token comment">//最小取值</span>
public final <span class="token keyword">static</span> <span class="token keyword">int</span> MIN_PRIORITY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//默认优先级</span>
public final <span class="token keyword">static</span> <span class="token keyword">int</span> NORM_PRIORITY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">//最大取值</span>
public final <span class="token keyword">static</span> <span class="token keyword">int</span> MAX_PRIORITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p>线程状态</p> 
<pre><code class="prism language-c">NEW<span class="token punctuation">,</span> <span class="token comment">//线程还没启动</span>

RUNNABLE<span class="token punctuation">,</span> <span class="token comment">//正在执行</span>

BLOCKED<span class="token punctuation">,</span> <span class="token comment">//等待获取锁</span>

WAITING<span class="token punctuation">,</span> <span class="token comment">//等待其他线程执行一个特定的动作，比如说调用Object.notify或Object.notifyAll()</span>

TIMED_WAITING<span class="token punctuation">,</span> <span class="token comment">//等待一定时间</span>

TERMINATED <span class="token comment">//执行完毕</span>
</code></pre> 
<ul><li>第1行:<br> group:线程所属的线程组<br> sCount: 线程挂起次数<br> dsCount: 用于调试的线程挂起次数<br> obj: 当前线程关联的java线程对象<br> self: 当前线程地址</li><li>第2行:<br> sysTid:线程真正意义上的tid<br> nice: 调度有优先级<br> cgrp:进程所属的进程调度组<br> sched: 调度策略<br> handle:函数处理地址</li><li>第3行:<br> state: 线程状态<br> schedstat:CPU调度时间统计<br> utm/stm: 用户态/内核态的CPU时间(单位是jiffies)<br> core: 该线程的最后运行所在核<br> HZ: 时钟频率</li><li>第4行:<br> stack:线程栈的地址区间<br> stackSize:栈的大小</li><li>第5行:<br> mutex:所持有mutex类型，有独占锁exclusive和共享锁shared两类</li><li>schedstat含义说明:<br> nice值越小则优先级越高。此处nice=-2,可见优先级还是比较高的;<br> schedstat括号中的3个数字依次是Running、Runable、Switch，紧接着的是utm和stm<br> Running时间:CPU运行的时间，单位ns<br> Runable时间:RQ队列的等待时间，单位ns<br> Switch次数:CPU调度切换次数<br> utm:该线程在用户态所执行的时间，单位是jiffies，jiffies定义为sysconf(_SC_CLK_TCK)，默认等于10ms<br> stm:该线程在内核态所执行的时间，单位是jiffies，默认等于10ms</li></ul> 
<p>可见，该线程Running=796240075 ns,也约等于796ms。在CPU运行时间包括用户态(utm)和内核态(stm)。utm+stm=(50+29)x10 ms=790ms。</p> 
<p>结论:utm+stm=schedstat 第一个参数值</p> 
<hr> 
<h2><a id="ANR_266"></a>八、ANR定位分析实例</h2> 
<h3><a id="81_Logcat_267"></a>8.1 Logcat分析</h3> 
<p><strong>查询关键字(ANR|ActivityManager)</strong></p> 
<pre><code class="prism language-java"><span class="token operator">/</span>system_process <span class="token class-name">E</span><span class="token operator">/</span><span class="token class-name">ActivityManager</span><span class="token operator">:</span>
<span class="token constant">ANR</span> in com<span class="token punctuation">.</span>anrdemo <span class="token punctuation">(</span>com<span class="token punctuation">.</span>anrdemo<span class="token operator">/</span><span class="token punctuation">.</span>MainActivity<span class="token punctuation">)</span>
	<span class="token constant">PID</span><span class="token operator">:</span> <span class="token number">12639</span>
	<span class="token class-name">Reason</span><span class="token operator">:</span> <span class="token class-name">Input</span> dispatching timed out <span class="token punctuation">(</span><span class="token class-name">Waiting</span> <span class="token keyword">to</span> <span class="token namespace">send</span> non<span class="token operator">-</span>key event because the touched window has not finished processing certain input events that were delivered <span class="token keyword">to</span> <span class="token namespace">it</span> over <span class="token number">500.0</span>ms <span class="token class-name"><span class="token namespace">ago<span class="token punctuation">.</span></span>  Wait</span> queue length<span class="token operator">:</span> <span class="token number">6.</span>  <span class="token class-name">Wait</span> queue head age<span class="token operator">:</span> <span class="token number">5841.3</span>ms<span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token class-name">Load</span><span class="token operator">:</span> <span class="token number">13.28</span> <span class="token operator">/</span> <span class="token number">11.53</span> <span class="token operator">/</span> <span class="token number">9.48</span>
	<span class="token constant">CPU</span> usage from <span class="token number">71228</span>ms <span class="token keyword">to</span> <span class="token number">0</span>ms ago <span class="token punctuation">(</span><span class="token number">1970</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">47.864</span> <span class="token keyword">to</span> <span class="token number">1970</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">59.093</span><span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token number">15</span><span class="token operator">%</span> <span class="token number">920</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">9.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">5.9</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">10139</span> minor <span class="token number">285</span> major
	<span class="token number">8.2</span><span class="token operator">%</span> <span class="token number">13985</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>mm<span class="token operator">:</span> <span class="token number">6.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">35481</span> minor <span class="token number">1879</span> major
	<span class="token number">0.1</span><span class="token operator">%</span> <span class="token number">555</span><span class="token operator">/</span>fingerprintd<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">51</span> minor <span class="token number">22</span> major
	<span class="token number">3.5</span><span class="token operator">%</span> <span class="token number">266</span><span class="token operator">/</span>mmcqd<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.5</span><span class="token operator">%</span> kernel
	<span class="token number">3.2</span><span class="token operator">%</span> <span class="token number">4424</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>android<span class="token punctuation">.</span>qqdownloader<span class="token operator">:</span>daemon<span class="token operator">:</span> <span class="token number">1.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">12007</span> minor <span class="token number">357</span> major
	<span class="token number">3.2</span><span class="token operator">%</span> <span class="token number">430</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">2002</span> minor
	<span class="token number">3.1</span><span class="token operator">%</span> <span class="token number">135</span><span class="token operator">/</span>kswapd0<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.1</span><span class="token operator">%</span> kernel
	<span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">12271</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>mobileqq<span class="token operator">:</span> <span class="token number">1.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">8799</span> minor <span class="token number">580</span> major
	<span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">11695</span><span class="token operator">/</span>com<span class="token punctuation">.</span>cleanmaster<span class="token punctuation">.</span>mguard<span class="token operator">:</span> <span class="token number">1.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9171</span> minor <span class="token number">72</span> major
	<span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">13039</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>mm<span class="token operator">:</span>push<span class="token operator">:</span> <span class="token number">0.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9969</span> minor <span class="token number">192</span> major
	<span class="token number">1.2</span><span class="token operator">%</span> <span class="token number">4954</span><span class="token operator">/</span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token operator">:</span> <span class="token number">0.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7546</span> minor <span class="token number">209</span> major
	<span class="token number">1.1</span><span class="token operator">%</span> <span class="token number">342</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">0.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.8</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">628</span> minor <span class="token number">3</span> major
	<span class="token number">1.1</span><span class="token operator">%</span> <span class="token number">1485</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u13<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.1</span><span class="token operator">%</span> kernel
	<span class="token number">1.1</span><span class="token operator">%</span> <span class="token number">10</span><span class="token operator">/</span>rcu_preempt<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.1</span><span class="token operator">%</span> kernel
	<span class="token number">1.1</span><span class="token operator">%</span> <span class="token number">12166</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>vending<span class="token operator">:</span> <span class="token number">0.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9897</span> minor <span class="token number">380</span> major
	<span class="token number">1</span><span class="token operator">%</span> <span class="token number">3846</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>qqmusic<span class="token operator">:</span><span class="token class-name">QQPlayerService</span><span class="token operator">:</span> <span class="token number">0.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7354</span> minor <span class="token number">485</span> major
	<span class="token number">1</span><span class="token operator">%</span> <span class="token number">10486</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u13<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">%</span> kernel
	<span class="token number">1</span><span class="token operator">%</span> <span class="token number">11251</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u13<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">%</span> kernel
	<span class="token number">1</span><span class="token operator">%</span> <span class="token number">9498</span><span class="token operator">/</span>com<span class="token punctuation">.</span>cleanmaster<span class="token punctuation">.</span>security<span class="token operator">:</span><span class="token class-name">DefendService</span><span class="token operator">:</span> <span class="token number">0.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">11998</span> minor <span class="token number">287</span> major
	<span class="token number">0.9</span><span class="token operator">%</span> <span class="token number">1973</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u13<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.9</span><span class="token operator">%</span> kernel
	<span class="token number">0.9</span><span class="token operator">%</span> <span class="token number">14113</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>mm<span class="token operator">:</span>exdevice<span class="token operator">:</span> <span class="token number">0.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">8802</span> minor <span class="token number">142</span> major
	<span class="token number">0.8</span><span class="token operator">%</span> <span class="token number">10814</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>qqmusic<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9823</span> minor <span class="token number">221</span> major
	<span class="token number">0.8</span><span class="token operator">%</span> <span class="token number">2062</span><span class="token operator">/</span>sogou<span class="token punctuation">.</span>mobile<span class="token punctuation">.</span>explorer<span class="token operator">:</span> <span class="token number">0.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">8532</span> minor <span class="token number">1288</span> major
	<span class="token number">0.8</span><span class="token operator">%</span> <span class="token number">528</span><span class="token operator">/</span>netd<span class="token operator">:</span> <span class="token number">0.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">4203</span> minor <span class="token number">35</span> major
	<span class="token number">0.8</span><span class="token operator">%</span> <span class="token number">3925</span><span class="token operator">/</span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token punctuation">.</span>persistent<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">12578</span> minor <span class="token number">546</span> major
	<span class="token number">0.7</span><span class="token operator">%</span> <span class="token number">556</span><span class="token operator">/</span>cnss_diag<span class="token operator">:</span> <span class="token number">0.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">121</span> minor <span class="token number">5</span> major
	<span class="token number">0.6</span><span class="token operator">%</span> <span class="token number">4971</span><span class="token operator">/</span>com<span class="token punctuation">.</span>cleanmaster<span class="token punctuation">.</span>mguard<span class="token operator">:</span>service<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7468</span> minor <span class="token number">174</span> major
	<span class="token number">0.5</span><span class="token operator">%</span> <span class="token number">9180</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>android<span class="token punctuation">.</span>qqdownloader<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9571</span> minor <span class="token number">216</span> major
	<span class="token number">0.5</span><span class="token operator">%</span> <span class="token number">15</span><span class="token operator">/</span>ksoftirqd<span class="token operator">/</span><span class="token number">1</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">3280</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>phone<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">1857</span> minor <span class="token number">133</span> major
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">8489</span><span class="token operator">/</span>kworker<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">3127</span><span class="token operator">/</span>sdcard<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">92</span> minor <span class="token number">17</span> major
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">397</span><span class="token operator">/</span>servicemanager<span class="token operator">:</span> <span class="token number">0.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">127</span> minor
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">11878</span><span class="token operator">/</span>swift<span class="token punctuation">.</span>space<span class="token punctuation">.</span>cleaner<span class="token punctuation">.</span>free<span class="token operator">:</span>service<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">6087</span> minor <span class="token number">140</span> major
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">20</span><span class="token operator">/</span>ksoftirqd<span class="token operator">/</span><span class="token number">2</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel
	<span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">8761</span><span class="token operator">/</span>com<span class="token punctuation">.</span>netease<span class="token punctuation">.</span>cloudmusic<span class="token operator">:</span>play<span class="token operator">:</span> <span class="token number">0.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">4819</span> minor <span class="token number">977</span> major
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">6525</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>qqlive<span class="token operator">:</span>services<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7834</span> minor <span class="token number">483</span> major
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">12250</span><span class="token operator">/</span>com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>mobileqq<span class="token operator">:</span><span class="token constant">MSF</span><span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">5368</span> minor <span class="token number">114</span> major
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">9717</span><span class="token operator">/</span>com<span class="token punctuation">.</span>speed<span class="token punctuation">.</span>boost<span class="token punctuation">.</span>booster<span class="token operator">:</span>service<span class="token operator">:</span> <span class="token number">0.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">5526</span> minor <span class="token number">77</span> major
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">8524</span><span class="token operator">/</span>sogou<span class="token punctuation">.</span>mobile<span class="token punctuation">.</span>explorer<span class="token operator">:</span>push_service<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">6280</span> minor <span class="token number">42</span> major
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">427</span><span class="token operator">/</span>irq<span class="token operator">/</span><span class="token number">215</span><span class="token operator">-</span>fc38800<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">8721</span><span class="token operator">/</span>kworker<span class="token operator">/</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">260</span><span class="token operator">/</span>cfinteractive<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">294</span><span class="token operator">/</span>msm<span class="token operator">-</span>core<span class="token operator">:</span>sampli<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel
	<span class="token number">0.1</span><span class="token operator">%</span> <span class="token number">8756</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u12<span class="token operator">:</span><span class="token number">3</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel
	<span class="token number">0.1</span><span class="token operator">%</span> <span class="token number">11204</span><span class="token operator">/</span>kworker<span class="token operator">/</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel
	<span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">3150</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">0.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">3318</span> minor <span class="token number">129</span> major
	<span class="token number">0.2</span><span class="token operator">%</span> <span class="token number">7244</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u12<span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel
	<span class="token number">0</span><span class="token operator">%</span> <span class="token number">3084</span><span class="token operator">/</span><span class="token class-name">VosMCThread</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kerne
</code></pre> 
<p>可以看到，Logcat日志信息中主要包含如下内容：</p> 
<blockquote> 
 <p>1）导致ANR的类名及所在包名：<br> com.anrdemo (com.anrdemo/.MainActivity)<br> 2）导致ANR的进程名及ID：com.anrdemo，12639<br> 3）ANR产生的原因(类型)：Reason: Input dispatching timed out (Waiting to send non-key event because the touched window has not finished processing certain input events that were delivered to it over 500.0ms ago. Wait queue length: 6. Wait queue head age: 5841.3ms.)，明显属于KeyDispatchTimeout类型。<br> 4）系统中CPU使用率的统计信息及某段时间内的变换情况<br> 从trace.txt文件分析</p> 
</blockquote> 
<p>ANR Logcat信息可以帮助我们分析引发ANR的具体类的信息以及ANR的类型，但是却无法帮助我们定位到具体引发问题的代码行，这时候就需要借助ANR发生过程中生成的堆栈信息文件<code>data/anr/trace.txt</code></p> 
<p>获取trace文件：</p> 
<blockquote> 
 <p>adb pull /data/anr/trace.txt</p> 
</blockquote> 
<h3><a id="82_tracetxt_343"></a>8.2 trace.txt文件分析</h3> 
<p>由于trace文件记录的是整个手机的ANR日志，所以我们需要根据进程名（包名）和ANR发生的时间找到对应日志，具体以pid 进程id开始，以pid进程id结束。由于阻塞始终会发生在主线程，因此我们需要关注线程名为main的线程状态。下面摘出一部分关键日志进行分析：</p> 
<pre><code class="prism language-java"><span class="token comment">//关键日志的起始标记</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">20678</span> at <span class="token number">2024</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">59</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">//应用程序包名</span>
<span class="token class-name">Cmd</span> line<span class="token operator">:</span> com<span class="token punctuation">.</span>anrdemo
<span class="token class-name">Build</span> fingerprint<span class="token operator">:</span> '<span class="token class-name">Android</span><span class="token operator">/</span>aosp_bullhead<span class="token operator">/</span>bullhead<span class="token operator">:</span><span class="token number">7.1</span><span class="token number">.2</span><span class="token operator">/</span><span class="token constant">N2G48C</span><span class="token operator">/</span>han<span class="token operator">-</span>li03221443<span class="token operator">:</span>userdebug<span class="token operator">/</span>test<span class="token operator">-</span>keys'

<span class="token comment">//手机的CPU架构</span>
<span class="token constant">ABI</span><span class="token operator">:</span> <span class="token char">'arm64'</span>

<span class="token comment">//堆内存信息</span>
<span class="token class-name">Heap</span><span class="token operator">:</span> <span class="token number">33</span><span class="token operator">%</span> free<span class="token punctuation">,</span> <span class="token number">4</span><span class="token constant">MB</span><span class="token operator">/</span><span class="token number">6</span><span class="token constant">MB</span><span class="token punctuation">;</span> <span class="token number">27144</span> objects
<span class="token class-name">Dumping</span> cumulative <span class="token class-name">Gc</span> timings

<span class="token class-name">Total</span> time spent in <span class="token constant">GC</span><span class="token operator">:</span> <span class="token number">10.680</span>ms
<span class="token class-name">Mean</span> <span class="token constant">GC</span> size throughput<span class="token operator">:</span> <span class="token number">68</span><span class="token constant">MB</span><span class="token operator">/</span>s
<span class="token class-name">Mean</span> <span class="token constant">GC</span> object throughput<span class="token operator">:</span> <span class="token number">1.32996e+06</span> objects<span class="token operator">/</span>s
<span class="token class-name">Total</span> number of allocations <span class="token number">41348</span>
<span class="token class-name">Total</span> bytes allocated <span class="token number">5</span><span class="token constant">MB</span>
<span class="token class-name">Total</span> bytes freed <span class="token number">753</span><span class="token constant">KB</span>

<span class="token comment">//手机Memory内存信息</span>
<span class="token class-name">Free</span> memory <span class="token number">2</span><span class="token constant">MB</span>
<span class="token class-name">Free</span> memory until <span class="token constant">GC</span> <span class="token number">2</span><span class="token constant">MB</span>
<span class="token class-name">Free</span> memory until <span class="token constant">OOME</span> <span class="token number">187</span><span class="token constant">MB</span>
<span class="token class-name">Total</span> memory <span class="token number">6</span><span class="token constant">MB</span>
<span class="token class-name">Max</span> memory <span class="token number">192</span><span class="token constant">MB</span>
<span class="token class-name">Zygote</span> space size <span class="token number">1128</span><span class="token constant">KB</span>
<span class="token class-name">Total</span> mutator paused time<span class="token operator">:</span> <span class="token number">463</span>us
<span class="token class-name">Total</span> time waiting <span class="token keyword">for</span> <span class="token constant">GC</span> <span class="token keyword">to</span> <span class="token namespace">complete</span><span class="token operator">:</span> <span class="token number">938</span>ns
<span class="token class-name">Total</span> <span class="token constant">GC</span> count<span class="token operator">:</span> <span class="token number">1</span>
<span class="token class-name">Total</span> <span class="token constant">GC</span> time<span class="token operator">:</span> <span class="token number">10.680</span>ms
<span class="token class-name">Total</span> blocking <span class="token constant">GC</span> count<span class="token operator">:</span> <span class="token number">0</span>
<span class="token class-name">Total</span> blocking <span class="token constant">GC</span> time<span class="token operator">:</span> <span class="token number">0</span>

<span class="token comment">//主线程日志分析</span>
<span class="token comment">//基本信息：main-线程名称，prio-线程优先级，tid-线程id，Sleeping-线程状态</span>
<span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> <span class="token class-name">Sleeping</span>
  <span class="token comment">//详细信息：group-线程组名称，sCount-线程被挂起的次数，dsCount-线程被调试器刮起的次数，obj-线程的Java对象地址，self-线程本身的Native对象地址</span>
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x75190ed0</span> self<span class="token operator">=</span><span class="token number">0x7f72095a00</span>
  <span class="token comment">//线程的调度信息：sysTid-linux系统中内核线程id（观察发现主线程的线程号和进程号相同），nice-线程调度的优先级，cgrp-线程调度组，sched-线程调度策略和优先级，handle-线程处理函数地址</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">20678</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7f75fe0a98</span>
  <span class="token comment">//上下文信息：state-线程调度状态，schedstat-线程在CPU中的执行时间、线程等待时间、线程执行的时间片长度，utm-线程在用户状态中调度的时间值，core-最后执行这个线程的CPU核序号</span>
  <span class="token operator">|</span> state<span class="token operator">=</span><span class="token class-name">S</span> schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">274637713</span> <span class="token number">30817705</span> <span class="token number">229</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">20</span> stm<span class="token operator">=</span><span class="token number">6</span> core<span class="token operator">=</span><span class="token number">1</span> <span class="token constant">HZ</span><span class="token operator">=</span><span class="token number">100</span>
  <span class="token comment">//堆栈信息：stack-堆栈地址，stackSize-堆栈大小，余下的为堆栈信息，也是我们分析引发ANR问题的关键</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fc8318000</span><span class="token operator">-</span><span class="token number">0x7fc831a000</span> stackSize<span class="token operator">=</span><span class="token number">8</span><span class="token constant">MB</span>
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span>sleep<span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Native</span> method<span class="token punctuation">)</span>
  <span class="token operator">-</span> sleeping on <span class="token generics"><span class="token punctuation">&lt;</span>0x02f69763<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">371</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x02f69763<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">313</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>anrdemo<span class="token punctuation">.</span></span>MainActivity</span>$<span class="token number">1.</span><span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>View</span><span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5637</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span>View</span>$<span class="token class-name">PerformClick</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22429</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Handler</span><span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">751</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Handler</span><span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">95</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">154</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ActivityThread</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">ActivityThread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6121</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Native</span> method<span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>ZygoteInit</span>$<span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">889</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>ZygoteInit</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">779</span><span class="token punctuation">)</span>

<span class="token string">"Jit thread pool worker thread 0"</span> daemon prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">2</span> <span class="token class-name">Native</span>
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x12c64790</span> self<span class="token operator">=</span><span class="token number">0x7f6a635000</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">20683</span> nice<span class="token operator">=</span><span class="token number">9</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7f71701450</span>
  <span class="token operator">|</span> state<span class="token operator">=</span><span class="token class-name">S</span> schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">696978</span> <span class="token number">5677</span> <span class="token number">2</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">0</span> stm<span class="token operator">=</span><span class="token number">0</span> core<span class="token operator">=</span><span class="token number">2</span> <span class="token constant">HZ</span><span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7f71603000</span><span class="token operator">-</span><span class="token number">0x7f71605000</span> stackSize<span class="token operator">=</span><span class="token number">1021</span><span class="token constant">KB</span>
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  kernel<span class="token operator">:</span> __switch_to<span class="token operator">+</span><span class="token number">0x8c</span><span class="token operator">/</span><span class="token number">0x98</span>
  kernel<span class="token operator">:</span> futex_wait_queue_me<span class="token operator">+</span><span class="token number">0xd4</span><span class="token operator">/</span><span class="token number">0x130</span>
  kernel<span class="token operator">:</span> futex_wait<span class="token operator">+</span><span class="token number">0xfc</span><span class="token operator">/</span><span class="token number">0x210</span>
  kernel<span class="token operator">:</span> do_futex<span class="token operator">+</span><span class="token number">0xe0</span><span class="token operator">/</span><span class="token number">0x920</span>
  kernel<span class="token operator">:</span> <span class="token class-name">SyS_futex</span><span class="token operator">+</span><span class="token number">0x11c</span><span class="token operator">/</span><span class="token number">0x1b0</span>
  kernel<span class="token operator">:</span> cpu_switch_to<span class="token operator">+</span><span class="token number">0x48</span><span class="token operator">/</span><span class="token number">0x4c</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">00</span> pc <span class="token number">000000000001</span>bcec  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>syscall<span class="token operator">+</span><span class="token number">28</span><span class="token punctuation">)</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">01</span> pc <span class="token number">00000000000e7</span>e4c  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN3art17ConditionVariable16WaitHoldingLocksEPNS_6ThreadE<span class="token operator">+</span><span class="token number">156</span><span class="token punctuation">)</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">02</span> pc <span class="token number">000000000046</span>c910  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN3art10ThreadPool7GetTaskEPNS_6ThreadE<span class="token operator">+</span><span class="token number">248</span><span class="token punctuation">)</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">03</span> pc <span class="token number">000000000046</span>bdac  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN3art16ThreadPoolWorker3RunEv<span class="token operator">+</span><span class="token number">124</span><span class="token punctuation">)</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">04</span> pc <span class="token number">000000000046</span>b6d0  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZN3art16ThreadPoolWorker8CallbackEPv<span class="token operator">+</span><span class="token number">132</span><span class="token punctuation">)</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">05</span> pc <span class="token number">0000000000068734</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>_ZL15__pthread_startPv<span class="token operator">+</span><span class="token number">208</span><span class="token punctuation">)</span>
  <span class="token keyword">native</span><span class="token operator">:</span> #<span class="token number">06</span> pc <span class="token number">000000000001d</span>a7c  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span>so <span class="token punctuation">(</span>__start_thread<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span>no managed stack frames<span class="token punctuation">)</span>

<span class="token comment">//关键日志的结束标记</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> end <span class="token number">20678</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre> 
<p>由于ANR只会发生在主线程，所以我们需要关注主线程的状态，从上 面日志中分析可以知道：发生ANR时主线程的状态为Sleep，且引起该状态的地方在MainActivity$1.onClick(MainActivity.java:24)</p> 
<hr> 
<h2><a id="ANR_437"></a>九、ANR源码分析</h2> 
<p>下面分析Service内onCreate发生ANR异常时源代码的执行情况</p> 
<p>大家都知道Android中的四大组件启动时，都会通过跨进程的方式利用Handler消息机制最终将消息Push到ActivityThread中的内部类去处理，因此我先在ActivityThread中搜索service.onCreate调用，然后依次追溯：</p> 
<p>ActivityThread中调用：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleCreateService</span><span class="token punctuation">(</span><span class="token class-name">CreateServiceData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//调用service的onCreate</span>
            service<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>该方法由Activity的内部类H（继承与Handler）接收到Servic onCreate消息时调用，该消息由通过scheduleCreateService发出，该方法被ActiveService类调用</p> 
<pre><code class="prism language-java">        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleCreateService</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
                <span class="token class-name">ServiceInfo</span> info<span class="token punctuation">,</span> <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CreateServiceData</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateServiceData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s<span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
            s<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
            s<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
            <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">CREATE_SERVICE</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>ActiveServicde的realStartServiceLocked方法调用上面方法，这个方法比较关键需要认真分析：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">realStartServiceLocked</span><span class="token punctuation">(</span><span class="token class-name">ServiceRecord</span> r<span class="token punctuation">,</span>
            <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> execInFg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>

        r<span class="token punctuation">.</span>app <span class="token operator">=</span> app<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>restartTime <span class="token operator">=</span> r<span class="token punctuation">.</span>lastActivity <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> newService <span class="token operator">=</span> app<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送delay消息(SERVICE_TIMEOUT_MSG)</span>
        <span class="token function">bumpServiceExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAm<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateServiceForegroundLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token comment">/* oomAdj= */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> created <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>stats<span class="token punctuation">.</span><span class="token function">getBatteryStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span>stats<span class="token punctuation">.</span><span class="token function">startLaunchedLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mAm<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                 <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">NOTIFY_PACKAGE_USE_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//最终执行服务的onCreate()方法</span>
            app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleCreateService</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">,</span>
                    mAm<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>serviceInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span><span class="token function">postNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            created <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeadObjectException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Application dead when creating service "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mAm<span class="token punctuation">.</span><span class="token function">appDiedLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>created<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Keep the executeNesting count accurate.</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> inDestroying <span class="token operator">=</span> mDestroyingServices<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//当service启动完毕，则remove SERVICE_TIMEOUT_MSG消息</span>
                <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> inDestroying<span class="token punctuation">,</span> inDestroying<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Cleanup.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    app<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Retry.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inDestroying<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">scheduleServiceRestartLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>whitelistManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            app<span class="token punctuation">.</span>whitelistManager <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">requestServiceBindingsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">updateServiceClientActivitiesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If the service is in the started state, and there are no</span>
        <span class="token comment">// pending arguments, then fake up one so its onStartCommand() will</span>
        <span class="token comment">// be called.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>startRequested <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>callStart <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>pendingStarts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceRecord<span class="token punctuation">.</span>StartItem</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">makeNextStartId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sendServiceArgsLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> execInFg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>bumpServiceExecutingLocked方法内又调用了scheduleServiceTimeoutLocked方法：</p> 
<pre><code class="prism language-java">   <span class="token keyword">void</span> <span class="token function">scheduleServiceForegroundTransitionTimeoutLocked</span><span class="token punctuation">(</span><span class="token class-name">ServiceRecord</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//指定id为SERVICE_TIMEOUT_MSG的消息</span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>
                <span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token constant">SERVICE_FOREGROUND_TIMEOUT_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> r<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>fgWaiting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//前台Service和后台Service发送的Delay消息时间不同</span>
        mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token constant">SERVICE_START_FOREGROUND_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>serviceDoneExecutingLocked方法</p> 
<pre><code class="prism language-java">   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">serviceDoneExecutingLocked</span><span class="token punctuation">(</span><span class="token class-name">ServiceRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> inDestroying<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> finishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        r<span class="token punctuation">.</span>executeNesting<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeNesting <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SERVICE</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SERVICE</span><span class="token punctuation">,</span>
                        <span class="token string">"Nesting at 0 of "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>shortName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_SERVICE</span> <span class="token operator">||</span> <span class="token constant">DEBUG_SERVICE_EXECUTING</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_SERVICE_EXECUTING</span><span class="token punctuation">,</span>
                            <span class="token string">"No more executingServices of "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>shortName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token comment">//remove掉id为SERVICE_TIMEOUT_MSG的消息，从上面的分析可知，该方法是onCreate调用之前发出的一个Delay执行的消息</span>
                   mAm<span class="token punctuation">.</span>mHandler<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token constant">SERVICE_TIMEOUT_MSG</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>executeFg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Need to re-evaluate whether the app still needs to be in the foreground.</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>executingServices<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>executeFg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>execServicesFg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inDestroying<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mDestroyingServices<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>bindings<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mAm<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span>executeFg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>tracker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mAm<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">.</span><span class="token function">getMemFactorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span><span class="token function">clearCurrentOwner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>tracker <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span>app<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>whitelistManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">updateWhitelistManagerLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                r<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>小结：</p> 
<blockquote> 
 <p>Service启动调用onCreate方法之前send一个Delay执行的消息，当发生异常或者Service的onCreate方法执行完毕之后，remove掉之前send的消息，如果onCreate方法执行时间超过Delay的时间，那么该消息就会被处理，此时如果Delay的时间是我们设定的ANR时间，则发生ANR，系统作出处理，否则该消息被remove，不会被执行。以一种观察者模式的角度去实现。</p> 
</blockquote> 
<p>id为<code>SERVICE_TIMEOUT_MSG</code>的消息被AMS中MainHandler接收</p> 
<pre><code class="prism language-java">           <span class="token keyword">case</span> <span class="token constant">SERVICE_TIMEOUT_MSG</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mDidDexOpt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mDidDexOpt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token class-name">Message</span> nmsg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">SERVICE_TIMEOUT_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nmsg<span class="token punctuation">.</span>obj <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>nmsg<span class="token punctuation">,</span> <span class="token class-name">ActiveServices</span><span class="token punctuation">.</span><span class="token constant">SERVICE_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mServices<span class="token punctuation">.</span><span class="token function">serviceTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p>ActiveService的serviceTimeout方法中调用AppErrors中的appNotResponding方法，很明显是ANR异常处理的方法：</p> 
<pre><code class="prism language-java"> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">appNotResponding</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> activity<span class="token punctuation">,</span>
            <span class="token class-name">ActivityRecord</span> parent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> aboveSystem<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> annotation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> firstPids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> lastPids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mController <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 0 == continue, -1 = kill process immediately</span>
                <span class="token keyword">int</span> res <span class="token operator">=</span> mService<span class="token punctuation">.</span>mController<span class="token punctuation">.</span><span class="token function">appEarlyNotResponding</span><span class="token punctuation">(</span>
                        app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>pid <span class="token operator">!=</span> <span class="token constant">MY_PID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    app<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">"anr"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mService<span class="token punctuation">.</span>mController <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">Watchdog</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setActivityController</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> anrTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token constant">MONITOR_CPU_USAGE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Unless configured otherwise, swallow ANRs in background processes &amp; kill the process.</span>
        <span class="token keyword">boolean</span> showBackground <span class="token operator">=</span> <span class="token class-name">Settings<span class="token punctuation">.</span>Secure</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Settings<span class="token punctuation">.</span>Secure</span><span class="token punctuation">.</span><span class="token constant">ANR_SHOW_BACKGROUND</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isSilentANR<span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// PowerManager.reboot() can block for a long time, so ignore ANRs while shutting down.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mShuttingDown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"During shutdown skipping ANR: "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>notResponding<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Skipping duplicate ANR: "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>crashing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Crashing app skipping ANR: "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>killedByAm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"App already killed by AM skipping ANR: "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Skipping died app ANR: "</span> <span class="token operator">+</span> app <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// In case we come through here for the same app before completing</span>
            <span class="token comment">// this one, mark as anring now so we will bail out.</span>
            app<span class="token punctuation">.</span>notResponding <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">// Log the ANR to the event log.</span>
            <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token class-name">EventLogTags</span><span class="token punctuation">.</span><span class="token constant">AM_ANR</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>info<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Dump thread traces as quickly as we can, starting with "interesting" processes.</span>
            firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Don't dump other PIDs if it's a background ANR</span>
            isSilentANR <span class="token operator">=</span> <span class="token operator">!</span>showBackground <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isInterestingForBackgroundTraces</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> parentPid <span class="token operator">=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    parentPid <span class="token operator">=</span> parent<span class="token punctuation">.</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentPid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parentPid<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">MY_PID</span> <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid <span class="token operator">&amp;&amp;</span> <span class="token constant">MY_PID</span> <span class="token operator">!=</span> parentPid<span class="token punctuation">)</span> firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">MY_PID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">ProcessRecord</span> r <span class="token operator">=</span> mService<span class="token punctuation">.</span>mLruProcesses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> pid <span class="token operator">=</span> r<span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> app<span class="token punctuation">.</span>pid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> parentPid <span class="token operator">&amp;&amp;</span> pid <span class="token operator">!=</span> <span class="token constant">MY_PID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_ANR</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Adding persistent proc: "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>treatLikeActivity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                firstPids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_ANR</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Adding likely IME: "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                lastPids<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_ANR</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Adding ANR proc: "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//输出ANR异常Log</span>

        <span class="token comment">// Log the ANR to the main log.</span>
        <span class="token class-name">StringBuilder</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ANR发生时的进程Name</span>
        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"ANR in "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> activity<span class="token punctuation">.</span>shortComponentName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" ("</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//进程ID</span>
        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"PID: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ANR发生的原因</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Reason: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>annotation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parent <span class="token operator">!=</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Parent: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>shortComponentName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ProcessCpuTracker</span> processCpuTracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessCpuTracker</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// don't dump native PIDs for background ANRs unless it is the process of interest</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nativeProcs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">NATIVE_STACKS_OF_INTEREST</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NATIVE_STACKS_OF_INTEREST</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    nativeProcs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> app<span class="token punctuation">.</span>processName <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            nativeProcs <span class="token operator">=</span> <span class="token constant">NATIVE_STACKS_OF_INTEREST</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pids <span class="token operator">=</span> nativeProcs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">getPidsForCommands</span><span class="token punctuation">(</span>nativeProcs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> nativePids <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pids <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            nativePids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pids<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">:</span> pids<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                nativePids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// For background ANRs, don't pass the ProcessCpuTracker to</span>
        <span class="token comment">// avoid spending 1/2 second collecting stats to rank lastPids.</span>
        <span class="token comment">//dump栈信息</span>
        <span class="token class-name">File</span> tracesFile <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">dumpStackTraces</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> firstPids<span class="token punctuation">,</span>
                                                   <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> processCpuTracker<span class="token punctuation">,</span>
                                                   <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> lastPids<span class="token punctuation">,</span>
                                                   nativePids<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> cpuInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token constant">MONITOR_CPU_USAGE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">updateCpuStatsNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessCpuTracker<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//各进程使用CPU情况</span>
                cpuInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessCpuTracker<span class="token punctuation">.</span><span class="token function">printCurrentState</span><span class="token punctuation">(</span>anrTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//CPU当前负载</span>
            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>processCpuTracker<span class="token punctuation">.</span><span class="token function">printCurrentLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cpuInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        info<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>processCpuTracker<span class="token punctuation">.</span><span class="token function">printCurrentState</span><span class="token punctuation">(</span>anrTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tracesFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// There is no trace file, so dump (only) the alleged culprit's threads to the log</span>
            <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">sendSignal</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">SIGNAL_QUIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将anr信息添加到dropbox</span>
        mService<span class="token punctuation">.</span><span class="token function">addErrorToDropBox</span><span class="token punctuation">(</span><span class="token string">"anr"</span><span class="token punctuation">,</span> app<span class="token punctuation">,</span> app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span>
                cpuInfo<span class="token punctuation">,</span> tracesFile<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mController <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 0 == show dialog, 1 = keep waiting, -1 = kill process immediately</span>
                <span class="token keyword">int</span> res <span class="token operator">=</span> mService<span class="token punctuation">.</span>mController<span class="token punctuation">.</span><span class="token function">appNotResponding</span><span class="token punctuation">(</span>
                        app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>pid <span class="token operator">!=</span> <span class="token constant">MY_PID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        app<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">"anr"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            mService<span class="token punctuation">.</span>mServices<span class="token punctuation">.</span><span class="token function">scheduleServiceTimeoutLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mService<span class="token punctuation">.</span>mController <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">Watchdog</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setActivityController</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span>mBatteryStatsService<span class="token punctuation">.</span><span class="token function">noteProcessAnr</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> app<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSilentANR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                app<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token string">"bg anr"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Set the app's notResponding state, and look up the errorReportReceiver</span>
            <span class="token function">makeAppNotRespondingLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span>
                    activity <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> activity<span class="token punctuation">.</span>shortComponentName <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                    annotation <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"ANR "</span> <span class="token operator">+</span> annotation <span class="token operator">:</span> <span class="token string">"ANR"</span><span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            通过<span class="token class-name">Handler</span>消息机制弹出<span class="token constant">ANR</span>对话框
            <span class="token comment">// Bring up the infamous App Not Responding dialog</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token constant">SHOW_NOT_RESPONDING_UI_MSG</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> map<span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> aboveSystem <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"activity"</span><span class="token punctuation">,</span> activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mService<span class="token punctuation">.</span>mUiHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>Android中的ANR监测以Handler消息机制实现，使用观察者模式，当开始监测时注册消息（该消息在规定时间后执行），事件处理完之后移除消息，当该消息执行时说明事件处理超过了规定的时间，即ANR。</p> 
<hr> 
<h2><a id="ANR_850"></a>十、ANR实例及分析</h2> 
<h3><a id="101__852"></a>10.1 应用在主线程上进行长时间的计算</h3> 
<pre><code class="prism language-java"><span class="token comment">//使用冒泡排序对一个大数组排序</span>
<span class="token keyword">private</span> fun <span class="token function">sortBigArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val currTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    val random <span class="token operator">=</span> <span class="token class-name">IntArray</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i in random<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        random<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">BubbleSort</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"耗时"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i in random<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span>random<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>点击一个按钮调用sortBigArray()方法，内部调用BubbleSort类的sort()方法对一个大数组（100万）进行排序，然后点击几次返回键，然后就出现ANR了。</p> 
<p>看一下Logcat日志输出</p> 
<pre><code class="prism language-c"><span class="token comment">//debug级别日志</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">24.209</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo I<span class="token operator">/</span>art<span class="token operator">:</span> Wrote stack traces to <span class="token char">'/data/anr/traces.txt'</span>

<span class="token comment">//error级别日志</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">28.048</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> ANR in com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">jetpackdemo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">/</span><span class="token punctuation">.</span>StartActivity<span class="token punctuation">)</span>
    PID<span class="token operator">:</span> <span class="token number">15564</span>
    Reason<span class="token operator">:</span> Input dispatching timed <span class="token function">out</span> <span class="token punctuation">(</span>Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it<span class="token punctuation">.</span>  Outbound queue length<span class="token operator">:</span> <span class="token number">0.</span>  Wait queue length<span class="token operator">:</span> <span class="token number">2.</span><span class="token punctuation">)</span>
    Load<span class="token operator">:</span> <span class="token number">7.7</span> <span class="token operator">/</span> <span class="token number">7.48</span> <span class="token operator">/</span> <span class="token number">7.35</span>
    CPU usage from <span class="token number">294322</span>ms to <span class="token number">0</span>ms <span class="token function">ago</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">29.817</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">24.139</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">4.1</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">3.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.9</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">64102</span> minor <span class="token number">6</span> major
      <span class="token number">3.3</span><span class="token operator">%</span> <span class="token number">29428</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">131259</span> minor
      <span class="token number">1.1</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">0.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">18</span> minor
      <span class="token number">0.7</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">0.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">1648</span> minor <span class="token number">1</span> major
      <span class="token number">0.7</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">21</span> minor
      <span class="token number">0.7</span><span class="token operator">%</span> <span class="token number">24463</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>hwid<span class="token punctuation">.</span>persistent<span class="token operator">:</span> <span class="token number">0.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">4650</span> minor <span class="token number">1</span> major
      <span class="token number">0.5</span><span class="token operator">%</span> <span class="token number">4018</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>android<span class="token punctuation">.</span>launcher<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">16025</span> minor <span class="token number">3</span> major
      <span class="token number">0.5</span><span class="token operator">%</span> <span class="token number">24301</span><span class="token operator">/</span>fingerprint_log<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel
      <span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">28932</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>appmarket<span class="token operator">:</span> <span class="token number">0.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">2526</span> minor
     <span class="token comment">//...</span>
   <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">28.048</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> CPU usage from <span class="token number">1721</span>ms to <span class="token number">2250</span>ms <span class="token function">later</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">25.860</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">26.389</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">99</span><span class="token operator">%</span> <span class="token number">15564</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">97</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">37</span> minor
        <span class="token number">99</span><span class="token operator">%</span> <span class="token number">15564</span><span class="token operator">/</span>oid<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">99</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">7.5</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">3.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">5</span> minor
        <span class="token number">5.6</span><span class="token operator">%</span> <span class="token number">2014</span><span class="token operator">/</span>ActivityManager<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2813</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">2001</span>_5<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2862</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">2001</span>_6<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">3089</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">2001</span>_7<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">5.3</span><span class="token operator">%</span> <span class="token number">29428</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">5.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">480</span> minor
        <span class="token number">3.5</span><span class="token operator">%</span> <span class="token number">29430</span><span class="token operator">/</span><span class="token operator">-&gt;</span>transport<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.5</span><span class="token operator">%</span> kernel
        <span class="token number">1.7</span><span class="token operator">%</span> <span class="token number">29428</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.7</span><span class="token operator">%</span> kernel
      <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">53</span><span class="token operator">/</span>rcuop<span class="token operator">/</span><span class="token number">6</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.3</span><span class="token operator">%</span> kernel
    <span class="token number">16</span><span class="token operator">%</span> TOTAL<span class="token operator">:</span> <span class="token number">14</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2.1</span><span class="token operator">%</span> kernel <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> irq <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> softirq
</code></pre> 
<p>上面的日志中输出了堆栈信息的保存在 /data/anr/traces.txt文件中</p> 
<pre><code class="prism language-c">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo I<span class="token operator">/</span>dalvikvm<span class="token operator">:</span> Wrote stack traces to <span class="token char">'/data/anr/traces.txt'</span>
</code></pre> 
<p>发生ANR进程的包名信息，所在的类，进程id和ANR的类型</p> 
<pre><code class="prism language-c"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">28.048</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> ANR in com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">jetpackdemo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">/</span><span class="token punctuation">.</span>StartActivity<span class="token punctuation">)</span>
    PID<span class="token operator">:</span> <span class="token number">15564</span>
    Reason<span class="token operator">:</span> Input dispatching timed <span class="token function">out</span> <span class="token punctuation">(</span>Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it<span class="token punctuation">.</span>  Outbound queue length<span class="token operator">:</span> <span class="token number">0.</span>  Wait queue length<span class="token operator">:</span> <span class="token number">2.</span><span class="token punctuation">)</span>  
</code></pre> 
<p>包名com.example.android.jetpackdemo，<br> 具体的类com.example.android.jetpackdemo.StartActivity，<br> 进程号是PID: 15564，<br> ANR的类型是Input dispatching timed out。</p> 
<pre><code class="prism language-c"> CPU usage from <span class="token number">294322</span>ms to <span class="token number">0</span>ms <span class="token function">ago</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">29.817</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">24.139</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">4.1</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">3.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.9</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">64102</span> minor <span class="token number">6</span> major
      <span class="token number">3.3</span><span class="token operator">%</span> <span class="token number">29428</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">131259</span> minor
      <span class="token number">1.1</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">0.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">18</span> minor
<span class="token comment">//...</span>

<span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">28.048</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> CPU usage from <span class="token number">1721</span>ms to <span class="token number">2250</span>ms <span class="token function">later</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">25.860</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">26.389</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">99</span><span class="token operator">%</span> <span class="token number">15564</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">97</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">37</span> minor
        <span class="token number">99</span><span class="token operator">%</span> <span class="token number">15564</span><span class="token operator">/</span>oid<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">99</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">7.5</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">3.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">5</span> minor
        <span class="token number">5.6</span><span class="token operator">%</span> <span class="token number">2014</span><span class="token operator">/</span>ActivityManager<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2813</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">2001</span>_5<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
<span class="token comment">//...</span>
</code></pre> 
<p><strong>注意：</strong><br> 在ANR发生之前，2020-06-03 21:15:29.817 to 2020-06-03 21:20:24.139，这段时间CPU的使用并不高。</p> 
<p>在ANR发生的时候，2020-06-03 21:20:25.860 to 2020-06-03 21:20:26.389，这段时间CPU的使用相当高，已经达到99%了。</p> 
<pre><code class="prism language-c"><span class="token number">99</span><span class="token operator">%</span> <span class="token number">15564</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">97</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
</code></pre> 
<blockquote> 
 <p>99%：内存占用率<br> 15564/com.example.android.jetpackdemo:进程id和进程名。</p> 
</blockquote> 
<p>这两段CPU 信息分别代表ANR发生前和ANR时的CPU占用率，在输出的CPU使用信息中我们也可以看出一些端倪，注意到进程CPU的占用率比较高，说明我们的进程比较忙碌，这里需要说明一下，进程忙碌并不一定代表主线程忙碌，也可能是进程中的后台线程忙碌。</p> 
<p>现在知道了ANR发生的所在的类，需要分析发生ANR的时候保存的traces.txt文件了。</p> 
<p><strong>导出traces文件</strong><br> 使用adb命令导出traces.txt文件</p> 
<pre><code class="prism language-c">adb pull <span class="token operator">/</span>data<span class="token operator">/</span>anr<span class="token operator">/</span>traces<span class="token punctuation">.</span>txt traces_1<span class="token punctuation">.</span>txt 
<span class="token operator">/</span>data<span class="token operator">/</span>anr<span class="token operator">/</span>traces<span class="token punctuation">.</span>txt<span class="token operator">:</span> <span class="token number">1</span> file pulled<span class="token punctuation">,</span> <span class="token number">0</span> skipped<span class="token punctuation">.</span> <span class="token number">28.5</span> MB<span class="token operator">/</span><span class="token function">s</span> <span class="token punctuation">(</span><span class="token number">701726</span> bytes in <span class="token number">0.023</span>s<span class="token punctuation">)</span>
</code></pre> 
<p>traces.txt部分信息</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">15564</span> at <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">24</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Cmd line<span class="token operator">:</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo
Build fingerprint<span class="token operator">:</span> 'HUAWEI<span class="token operator">/</span>MLA<span class="token operator">-</span>AL10<span class="token operator">/</span>HWMLA<span class="token operator">:</span><span class="token number">7.0</span><span class="token operator">/</span>HUAWEIMLA<span class="token operator">-</span>AL10<span class="token operator">/</span>C00B364<span class="token operator">:</span>user<span class="token operator">/</span>release<span class="token operator">-</span>keys'
ABI<span class="token operator">:</span> <span class="token char">'arm64'</span>
<span class="token comment">//...</span>
</code></pre> 
<p>在traces.txt文件的最顶部，首先输出的是发生ANR的进程号和包名信息，然后在traces.txt中搜索我们的进程号或者包名。</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Runnable
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">0</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">15564</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>R schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">22116939220</span> <span class="token number">18299419</span> <span class="token number">428</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">2209</span> stm<span class="token operator">=</span><span class="token number">2</span> core<span class="token operator">=</span><span class="token number">5</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span> <span class="token string">"mutator lock"</span><span class="token punctuation">(</span>shared held<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>BubbleSort<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>BubbleSort<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">sortBigArray</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">76</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatViewInflater$DeclaredOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>AppCompatViewInflater<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">397</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5646</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View$PerformClick<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22473</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">761</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">98</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6517</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit$MethodAndArgsCaller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">832</span><span class="token punctuation">)</span>
<span class="token comment">//...</span>
</code></pre> 
<p>看一下和线程相关的部分信息。</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Runnable
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">0</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">15564</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>R schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">22116939220</span> <span class="token number">18299419</span> <span class="token number">428</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">2209</span> stm<span class="token operator">=</span><span class="token number">2</span> core<span class="token operator">=</span><span class="token number">5</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span> <span class="token string">"mutator lock"</span><span class="token punctuation">(</span>shared held<span class="token punctuation">)</span>
</code></pre> 
<p><strong>线程基本信息：</strong><br> 线程名：main<br> 线程优先级：prio=5，优先级取值范围[1,10]，详见Thread类：</p> 
<pre><code class="prism language-c"><span class="token comment">//最小取值</span>
public final <span class="token keyword">static</span> <span class="token keyword">int</span> MIN_PRIORITY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//默认优先级</span>
public final <span class="token keyword">static</span> <span class="token keyword">int</span> NORM_PRIORITY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">//最大取值</span>
public final <span class="token keyword">static</span> <span class="token keyword">int</span> MAX_PRIORITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<p>线程id： tid=1，1代表主线程<br> 线程状态：Runnable，状态取值如下，详见Thread.State枚举类：</p> 
<pre><code class="prism language-c">NEW<span class="token punctuation">,</span> <span class="token comment">//线程还没启动</span>

RUNNABLE<span class="token punctuation">,</span> <span class="token comment">//正在执行</span>

BLOCKED<span class="token punctuation">,</span> <span class="token comment">//等待获取锁</span>

WAITING<span class="token punctuation">,</span> <span class="token comment">//等待其他线程执行一个特定的动作，比如说调用Object.notify或Object.notifyAll()</span>

TIMED_WAITING<span class="token punctuation">,</span> <span class="token comment">//等待一定时间</span>

TERMINATED <span class="token comment">//执行完毕</span>
</code></pre> 
<p>线程组名称：group=“main”<br> 线程被挂起的次数：sCount=0<br> 线程被调试器挂起的次数：dsCount=0<br> 线程的java的对象地址：obj= 0x77d21af8<br> 线程本身的Native对象地址：self= 0x7fa2ea2a00</p> 
<p><strong>线程调度信息：</strong><br> Linux系统中内核线程id: sysTid= 15564 与进程号相同<br> 线程调度优先级：nice=-10<br> 线程调度组：cgrp=default<br> 线程调度策略和优先级：sched=0/0<br> 线程处理函数地址：handle= 0x7fa6f4ba98</p> 
<p><strong>线程的堆栈信息：</strong><br> 堆栈地址和大小：stack=0x7fd42e0000-0x7fd42e2000 stackSize=8MB<br> held mutexes：持有互斥锁信息</p> 
<p>从上面traces.txt文件中这段信息可以看出，导致ANR的最终原因是在BubbleSort.java的第45行。</p> 
<pre><code class="prism language-c"> at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>BubbleSort<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>BubbleSort<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">)</span>
 at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">sortBigArray</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">76</span><span class="token punctuation">)</span>
 at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">47</span><span class="token punctuation">)</span>
 at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/52/v40sQbfn_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="102_IO_1055"></a>10.2 应用在主线程上执行耗时的I/O的操作</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 拷贝文件，注意要有读写权限
 */</span>
<span class="token keyword">private</span> fun <span class="token function">doIo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    val prePath <span class="token operator">=</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path
    val file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"${prePath}/test/View.java"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"doIo: ${file.length()}"</span><span class="token punctuation">)</span>

        val reader <span class="token operator">=</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        val fileWriter <span class="token operator">=</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span><span class="token string">"${prePath}/test/ViewCopy.java"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>index in <span class="token number">0</span> until <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> count<span class="token operator">:</span> <span class="token class-name">Int</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>also <span class="token punctuation">{<!-- --></span> count <span class="token operator">=</span> it <span class="token punctuation">}</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                fileWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                reader<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token class-name">IOException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"doIo: error ${e.message}"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用doIo()方法以后，多次点击返回键，制造ANR。</p> 
<p>Logcat日志输出</p> 
<pre><code class="prism language-c"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">24.462</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> ANR in com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">jetpackdemo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">/</span><span class="token punctuation">.</span>StartActivity<span class="token punctuation">)</span>
    PID<span class="token operator">:</span> <span class="token number">16295</span>
    Reason<span class="token operator">:</span> Input dispatching timed <span class="token function">out</span> <span class="token punctuation">(</span>Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it<span class="token punctuation">.</span>  Outbound queue length<span class="token operator">:</span> <span class="token number">0.</span>  Wait queue length<span class="token operator">:</span> <span class="token number">2.</span><span class="token punctuation">)</span>
    Load<span class="token operator">:</span> <span class="token number">7.49</span> <span class="token operator">/</span> <span class="token number">7.45</span> <span class="token operator">/</span> <span class="token number">7.24</span>
    CPU usage from <span class="token number">87491</span>ms to <span class="token number">0</span>ms <span class="token function">ago</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">53.035</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">20.526</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">7.8</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">6.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">34095</span> minor <span class="token number">3</span> major
      <span class="token number">4.2</span><span class="token operator">%</span> <span class="token number">28932</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>appmarket<span class="token operator">:</span> <span class="token number">3.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">12314</span> minor <span class="token number">5</span> major
      <span class="token number">2.8</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">2.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">4222</span> minor <span class="token number">1</span> major
      <span class="token number">2</span><span class="token operator">%</span> <span class="token number">412</span><span class="token operator">/</span>msm<span class="token operator">-</span>core<span class="token operator">:</span>sampli<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">%</span> kernel
      <span class="token number">1.7</span><span class="token operator">%</span> <span class="token number">24463</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>hwid<span class="token punctuation">.</span>persistent<span class="token operator">:</span> <span class="token number">1.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">3317</span> minor <span class="token number">1</span> major
      <span class="token number">1.5</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">24</span> minor
     <span class="token comment">//...    </span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">24.462</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> CPU usage from <span class="token number">1696</span>ms to <span class="token number">2226</span>ms <span class="token function">later</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">22.222</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">22.752</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">84</span><span class="token operator">%</span> <span class="token number">16295</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">84</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">562</span> minor <span class="token number">1</span> major
        <span class="token number">68</span><span class="token operator">%</span> <span class="token number">16295</span><span class="token operator">/</span>oid<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">68</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">12</span><span class="token operator">%</span> <span class="token number">16317</span><span class="token operator">/</span>RenderThread<span class="token operator">:</span> <span class="token number">12</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">16307</span><span class="token operator">/</span>HeapTaskDaemon<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
       <span class="token operator">+</span><span class="token number">0</span><span class="token operator">%</span> <span class="token number">16461</span><span class="token operator">/</span>DeferredSaveThr<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">9.1</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">7.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7</span> minor
        <span class="token number">7.3</span><span class="token operator">%</span> <span class="token number">2014</span><span class="token operator">/</span>ActivityManager<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">7.3</span><span class="token operator">%</span> kernel
        <span class="token number">3.6</span><span class="token operator">%</span> <span class="token number">2536</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">2001</span>_3<span class="token operator">:</span> <span class="token number">3.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">5.5</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">2.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2.7</span><span class="token operator">%</span> kernel
        <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">1.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">658</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">607</span>_1<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.3</span><span class="token operator">%</span> kernel
      <span class="token number">4.3</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">2.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">26</span> minor
        <span class="token number">4.3</span><span class="token operator">%</span> <span class="token number">3614</span><span class="token operator">/</span>RenderThread<span class="token operator">:</span> <span class="token number">2.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.4</span><span class="token operator">%</span> kernel
        <span class="token number">1.4</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>ndroid<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">1.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">25</span><span class="token operator">/</span>rcuop<span class="token operator">/</span><span class="token number">2</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.3</span><span class="token operator">%</span> kernel
      <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">339</span><span class="token operator">/</span>irq<span class="token operator">/</span><span class="token number">171</span><span class="token operator">-</span>tsens_i<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.3</span><span class="token operator">%</span> kernel
      <span class="token number">1.5</span><span class="token operator">%</span> <span class="token number">11851</span><span class="token operator">/</span>mdss_fb0<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">%</span> kernel
      <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">14246</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u16<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
      <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">16318</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u16<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
    <span class="token number">15</span><span class="token operator">%</span> TOTAL<span class="token operator">:</span> <span class="token number">13</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
</code></pre> 
<p>从上面的日志信息中我们也看出来发生ANR的时候，进程<code>com.example.android.jetpackdemo</code>CPU占用率是比较高的，说明我们进程内存在比较忙碌的线程。然后我们继续看一下对应的traces.txt文件。<br> traces.txt部分信息</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">16295</span> at <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">20</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Cmd line<span class="token operator">:</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo
Build fingerprint<span class="token operator">:</span> 'HUAWEI<span class="token operator">/</span>MLA<span class="token operator">-</span>AL10<span class="token operator">/</span>HWMLA<span class="token operator">:</span><span class="token number">7.0</span><span class="token operator">/</span>HUAWEIMLA<span class="token operator">-</span>AL10<span class="token operator">/</span>C00B364<span class="token operator">:</span>user<span class="token operator">/</span>release<span class="token operator">-</span>keys'
</code></pre> 
<p>通过进程号pid 16295搜索</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Runnable
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">0</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">16295</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>R schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">16406184130</span> <span class="token number">12254163</span> <span class="token number">407</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">1630</span> stm<span class="token operator">=</span><span class="token number">10</span> core<span class="token operator">=</span><span class="token number">6</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span> <span class="token string">"mutator lock"</span><span class="token punctuation">(</span>shared held<span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">00</span> pc <span class="token number">0000000000478088</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN3art15DumpNativeStackERNSt3__113basic_ostreamIcNS0_11char_traitsIcEEEEiP12BacktraceMapPKcPNS_9ArtMethodEPv<span class="token operator">+</span><span class="token number">220</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">01</span> pc <span class="token number">0000000000478084</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN3art15DumpNativeStackERNSt3__113basic_ostreamIcNS0_11char_traitsIcEEEEiP12BacktraceMapPKcPNS_9ArtMethodEPv<span class="token operator">+</span><span class="token number">216</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">02</span> pc <span class="token number">000000000044</span>c604  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZNK3art6Thread9DumpStackERNSt3__113basic_ostreamIcNS1_11char_traitsIcEEEEbP12BacktraceMap<span class="token operator">+</span><span class="token number">524</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">03</span> pc <span class="token number">0000000000463f</span><span class="token number">60</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN3art14DumpCheckpoint3RunEPNS_6ThreadE<span class="token operator">+</span><span class="token number">820</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">04</span> pc <span class="token number">000000000044</span>d510  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN3art6Thread21RunCheckpointFunctionEv<span class="token operator">+</span><span class="token number">192</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">05</span> pc <span class="token number">00000000000ff</span><span class="token number">870</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN3art27ScopedObjectAccessUncheckedD2Ev<span class="token operator">+</span><span class="token number">576</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">06</span> pc <span class="token number">000000000010</span>a764  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libart<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN3art8CheckJNI23GetPrimitiveArrayRegionEPKcNS_9Primitive4TypeEP7_JNIEnvP7_jarrayiiPv<span class="token operator">+</span><span class="token number">1164</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">07</span> pc <span class="token number">0000000000022</span>ee4  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libjavacore<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">08</span> pc <span class="token number">00000000004747</span>a8  <span class="token operator">/</span>data<span class="token operator">/</span>dalvik<span class="token operator">-</span>cache<span class="token operator">/</span>arm64<span class="token operator">/</span>system@framework@boot<span class="token operator">-</span>core<span class="token operator">-</span>libart<span class="token punctuation">.</span><span class="token function">oat</span> <span class="token punctuation">(</span>Java_libcore_icu_NativeConverter_encode__J_3CI_3BI_3IZ<span class="token operator">+</span><span class="token number">244</span><span class="token punctuation">)</span>
  at libcore<span class="token punctuation">.</span>icu<span class="token punctuation">.</span>NativeConverter<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span>CharsetEncoderICU<span class="token punctuation">.</span><span class="token function">encodeLoop</span><span class="token punctuation">(</span>CharsetEncoderICU<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">169</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span>CharsetEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>CharsetEncoder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">579</span><span class="token punctuation">)</span>
  at sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>cs<span class="token punctuation">.</span>StreamEncoder<span class="token punctuation">.</span><span class="token function">implWrite</span><span class="token punctuation">(</span>StreamEncoder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">271</span><span class="token punctuation">)</span>
  at sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>cs<span class="token punctuation">.</span>StreamEncoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>StreamEncoder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">125</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> locked <span class="token operator">&lt;</span><span class="token number">0x05b5279d</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileWriter<span class="token punctuation">)</span>
  at sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>cs<span class="token punctuation">.</span>StreamEncoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>StreamEncoder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">113</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>OutputStreamWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>OutputStreamWriter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">194</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">doIo</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">65</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatViewInflater$DeclaredOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>AppCompatViewInflater<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">397</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5646</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View$PerformClick<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22473</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">761</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">98</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6517</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit$MethodAndArgsCaller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">832</span><span class="token punctuation">)</span>
</code></pre> 
<p>重点看一下这段信息</p> 
<pre><code class="prism language-c">at java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>OutputStreamWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>OutputStreamWriter<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">194</span><span class="token punctuation">)</span>
at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">doIo</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">)</span>
at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">65</span><span class="token punctuation">)</span>
</code></pre> 
<p>从上面这段信息可以看出，导致ANR的最终原因是在OutputStreamWriter.java的第194行。而我们的代码出问题的地方是StartActivity.kt的116行。<br> <img src="https://images2.imgbox.com/11/17/pBMYMUZ1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/42/3e/U0VhzaZn_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="103__1179"></a>10.3 主线程处于阻塞状态，等待获取锁</h3> 
<pre><code class="prism language-java"><span class="token comment">//锁资源</span>
val lockedResource<span class="token operator">:</span> <span class="token class-name">Any</span> <span class="token operator">=</span> <span class="token class-name">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

fun <span class="token function">onClick</span><span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token class-name">View</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    when <span class="token punctuation">(</span>v<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnWaitLockedResource <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">LockTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>arrayListOf<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onClick: 主线程先睡眠一会，避免先获取到锁"</span><span class="token punctuation">)</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onClick: 主线程先睡眠结束，尝试获取锁"</span><span class="token punctuation">)</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lockedResource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>index in <span class="token number">0</span> until <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onClick: 主线程获取到锁了$index"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//LockTask后台线程</span>
inner <span class="token keyword">class</span> <span class="token class-name">LockTask</span> <span class="token operator">:</span> <span class="token class-name">AsyncTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">Int</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Int</span><span class="token punctuation">,</span> <span class="token class-name">Unit</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    override fun <span class="token function">doInBackground</span><span class="token punctuation">(</span>vararg params<span class="token operator">:</span> <span class="token class-name">MutableList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lockedResource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            val list <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i in <span class="token number">0</span> until <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            list<span class="token punctuation">.</span>forEach <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"doInBackground: for each element is $it"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用onClick()方法以后，先让后台线程获取锁，然后主线程再尝试获取锁。然后多次点击返回键，制造ANR。</p> 
<p><strong>Logcat日志输出</strong></p> 
<pre><code class="prism language-c"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">04.396</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> ANR in com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">jetpackdemo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">/</span><span class="token punctuation">.</span>StartActivity<span class="token punctuation">)</span>
    PID<span class="token operator">:</span> <span class="token number">20008</span>
    Reason<span class="token operator">:</span> Input dispatching timed <span class="token function">out</span> <span class="token punctuation">(</span>Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it<span class="token punctuation">.</span>  Outbound queue length<span class="token operator">:</span> <span class="token number">0.</span>  Wait queue length<span class="token operator">:</span> <span class="token number">2.</span><span class="token punctuation">)</span>
    Load<span class="token operator">:</span> <span class="token number">8.27</span> <span class="token operator">/</span> <span class="token number">7.73</span> <span class="token operator">/</span> <span class="token number">7.37</span>
    CPU usage from <span class="token number">83152</span>ms to <span class="token number">0</span>ms <span class="token function">ago</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">36.842</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">59.995</span><span class="token punctuation">)</span> with <span class="token number">99</span><span class="token operator">%</span> awake<span class="token operator">:</span>
      <span class="token number">19</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">15</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">533</span> minor <span class="token number">1</span> major
      <span class="token number">5.5</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">3.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">10843</span> minor <span class="token number">7</span> major
      <span class="token number">4.9</span><span class="token operator">%</span> <span class="token number">28932</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>appmarket<span class="token operator">:</span> <span class="token number">4.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">13003</span> minor <span class="token number">79</span> major
      <span class="token number">2.6</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">2.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7158</span> minor <span class="token number">2</span> major
      <span class="token number">1.5</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">0.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">190</span> minor <span class="token number">1</span> major
      <span class="token number">1.2</span><span class="token operator">%</span> <span class="token number">24307</span><span class="token operator">/</span>logcat<span class="token operator">:</span> <span class="token number">0.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel
      <span class="token number">0.8</span><span class="token operator">%</span> <span class="token number">11161</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>settings<span class="token operator">:</span> <span class="token number">0.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9084</span> minor <span class="token number">20</span> major
      <span class="token number">0.6</span><span class="token operator">%</span> <span class="token number">24305</span><span class="token operator">/</span>logcat<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel
      <span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">24301</span><span class="token operator">/</span>fingerprint_log<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.4</span><span class="token operator">%</span> kernel
      <span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">15363</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u16<span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel
      <span class="token number">0.2</span><span class="token operator">%</span> <span class="token number">6831</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u16<span class="token operator">:</span><span class="token number">5</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel
      <span class="token number">0.2</span><span class="token operator">%</span> <span class="token number">837</span><span class="token operator">/</span>imonitor<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel
      <span class="token comment">//...</span>
     <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">04.396</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> CPU usage from <span class="token number">2211</span>ms to <span class="token number">2742</span>ms <span class="token function">later</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">02.206</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">02.737</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">105</span><span class="token operator">%</span> <span class="token number">20008</span><span class="token operator">/</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">:</span> <span class="token number">92</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">13</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">220</span> minor
        <span class="token number">99</span><span class="token operator">%</span> <span class="token number">20096</span><span class="token operator">/</span>AsyncTask #<span class="token number">1</span><span class="token operator">:</span> <span class="token number">86</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">13</span><span class="token operator">%</span> kernel
        <span class="token number">5.6</span><span class="token operator">%</span> <span class="token number">20019</span><span class="token operator">/</span>HeapTaskDaemon<span class="token operator">:</span> <span class="token number">5.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">103</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">99</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">8</span> minor
        <span class="token number">92</span><span class="token operator">%</span> <span class="token number">24315</span><span class="token operator">/</span>logd<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>per<span class="token operator">:</span> <span class="token number">92</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">7.5</span><span class="token operator">%</span> <span class="token number">511</span><span class="token operator">/</span>logd<span class="token punctuation">.</span>writer<span class="token operator">:</span> <span class="token number">5.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
        <span class="token number">3.7</span><span class="token operator">%</span> <span class="token number">24314</span><span class="token operator">/</span>logd<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>per<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">24313</span><span class="token operator">/</span>logd<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>per<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
      <span class="token number">11</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">11</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">52</span> minor
        <span class="token number">9.3</span><span class="token operator">%</span> <span class="token number">3614</span><span class="token operator">/</span>RenderThread<span class="token operator">:</span> <span class="token number">7.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>ndroid<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">9.3</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">9.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">3.7</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">3.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2614</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">607</span>_4<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
      <span class="token number">5.6</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">2</span> minor
        <span class="token number">5.6</span><span class="token operator">%</span> <span class="token number">2014</span><span class="token operator">/</span>ActivityManager<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">5.6</span><span class="token operator">%</span> kernel
      <span class="token number">3.3</span><span class="token operator">%</span> <span class="token number">19794</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">1.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">147</span> minor
        <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">19794</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
        <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">19796</span><span class="token operator">/</span><span class="token operator">-&gt;</span>transport<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
        <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">19797</span><span class="token operator">/</span><span class="token operator">&lt;</span><span class="token operator">-</span>transport<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
      <span class="token number">3.4</span><span class="token operator">%</span> <span class="token number">24307</span><span class="token operator">/</span>logcat<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.4</span><span class="token operator">%</span> kernel
      <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">624</span><span class="token operator">/</span>mm<span class="token operator">-</span>pp<span class="token operator">-</span>dpps<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.3</span><span class="token operator">%</span> kernel
        <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">717</span><span class="token operator">/</span>ABA_THREAD<span class="token operator">:</span> <span class="token number">1.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">18971</span><span class="token operator">/</span>kworker<span class="token operator">/</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
      <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">18974</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u16<span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
      <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">19095</span><span class="token operator">/</span>mdss_fb0<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
      <span class="token number">1.7</span><span class="token operator">%</span> <span class="token number">24301</span><span class="token operator">/</span>fingerprint_log<span class="token operator">:</span> <span class="token number">1.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">1.7</span><span class="token operator">%</span> <span class="token number">24305</span><span class="token operator">/</span>logcat<span class="token operator">:</span> <span class="token number">1.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
    <span class="token number">31</span><span class="token operator">%</span> TOTAL<span class="token operator">:</span> <span class="token number">26</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">4</span><span class="token operator">%</span> kernel <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> irq <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> softirq
</code></pre> 
<p>进程CPU占用率是比较高的，说明进程内存在比较忙碌的线程。然后继续看一下对应的traces.txt文件。</p> 
<p>traces.txt部分信息</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">20008</span> at <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Cmd line<span class="token operator">:</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo
Build fingerprint<span class="token operator">:</span> 'HUAWEI<span class="token operator">/</span>MLA<span class="token operator">-</span>AL10<span class="token operator">/</span>HWMLA<span class="token operator">:</span><span class="token number">7.0</span><span class="token operator">/</span>HUAWEIMLA<span class="token operator">-</span>AL10<span class="token operator">/</span>C00B364<span class="token operator">:</span>user<span class="token operator">/</span>release<span class="token operator">-</span>keys'
</code></pre> 
<p>通过进程号pid 20008搜索</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Blocked
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">20008</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">278831875</span> <span class="token number">7233747</span> <span class="token number">156</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">22</span> stm<span class="token operator">=</span><span class="token number">5</span> core<span class="token operator">=</span><span class="token number">0</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> waiting to lock <span class="token operator">&lt;</span><span class="token number">0x0f8c80b0</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> held by thread <span class="token number">16</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatViewInflater$DeclaredOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>AppCompatViewInflater<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">397</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5646</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View$PerformClick<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22473</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">761</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">98</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6517</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit$MethodAndArgsCaller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">832</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>关键信息</strong></p> 
<pre><code class="prism language-c">at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>
<span class="token operator">-</span> waiting to lock <span class="token operator">&lt;</span><span class="token number">0x0f8c80b0</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object<span class="token punctuation">)</span> held by thread <span class="token number">16</span>
</code></pre> 
<p>在StartActivity的61行，在等待一个锁对象&lt;0x0f8c80b0&gt;，该对象是一个Object对象<br> (a java.lang.Object)，这个锁对象正在被线程id为16的线程持有。那么我们下面在traces.txt文件中搜索一下这个锁对象&lt;0x0f8c80b0&gt;。如下所示：</p> 
<pre><code class="prism language-c">DALVIK <span class="token function">THREADS</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token string">"AsyncTask #1"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">16</span> Runnable
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">0</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x12cd61f0</span> self<span class="token operator">=</span><span class="token number">0x7f93187200</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">20096</span> nice<span class="token operator">=</span><span class="token number">10</span> cgrp<span class="token operator">=</span>bg_non_interactive sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7f84346450</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>R schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">13814173056</span> <span class="token number">6030204</span> <span class="token number">1355</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">1193</span> stm<span class="token operator">=</span><span class="token number">188</span> core<span class="token operator">=</span><span class="token number">3</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7f84244000</span><span class="token operator">-</span><span class="token number">0x7f84246000</span> stackSize<span class="token operator">=</span><span class="token number">1037</span>KB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span> <span class="token string">"mutator lock"</span><span class="token punctuation">(</span>shared held<span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Integer<span class="token punctuation">.</span><span class="token function">stringSize</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">414</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>AbstractStringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>AbstractStringBuilder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">630</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>StringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>StringBuilder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">220</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity$LockTask<span class="token punctuation">.</span><span class="token function">doInBackground</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> locked <span class="token operator">&lt;</span><span class="token number">0x0f8c80b0</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity$LockTask<span class="token punctuation">.</span><span class="token function">doInBackground</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">99</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>AsyncTask$<span class="token number">2.</span><span class="token function">call</span><span class="token punctuation">(</span>AsyncTask<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">316</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>FutureTask<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>FutureTask<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">237</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>AsyncTask$SerialExecutor$<span class="token number">1.</span><span class="token function">run</span><span class="token punctuation">(</span>AsyncTask<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">255</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span>ThreadPoolExecutor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1133</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ThreadPoolExecutor$Worker<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ThreadPoolExecutor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">607</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">776</span><span class="token punctuation">)</span>
</code></pre> 
<p>关键信息</p> 
<pre><code class="prism language-c"> at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity$LockTask<span class="token punctuation">.</span><span class="token function">doInBackground</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> locked <span class="token operator">&lt;</span><span class="token number">0x0f8c80b0</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
</code></pre> 
<p>正是这个AsyncTask在107行持有锁对象0x0f8c80b0，导致主线程无法获取锁而阻塞，最终导致ANR。</p> 
<p><img src="https://images2.imgbox.com/52/ea/LXxbmlhD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="104__1341"></a>10.4 主线程与其他线程之间发生死锁</h3> 
<pre><code class="prism language-c">val resourceFirst <span class="token operator">=</span> <span class="token string">"resourceFirst"</span>
val resourceSecond <span class="token operator">=</span> <span class="token string">"resourceSecond"</span>

private fun <span class="token function">mockDeadLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//启动一个后台线程</span>
    <span class="token function">thread</span><span class="token punctuation">(</span>start <span class="token operator">=</span> false<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span>resourceSecond<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"工作线程获取了锁 resourceSecond"</span><span class="token punctuation">)</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"工作线程尝试获取锁 resourceFirst"</span><span class="token punctuation">)</span>
            <span class="token function">synchronized</span><span class="token punctuation">(</span>resourceFirst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"工作线程 mockDeadLock"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//主线程睡眠30ms后开始获取锁</span>
    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>

    <span class="token function">synchronized</span><span class="token punctuation">(</span>resourceFirst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"主线程获取了锁 resourceFirst"</span><span class="token punctuation">)</span>

        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"主线程尝试获取锁 resourceSecond"</span><span class="token punctuation">)</span>
        <span class="token function">synchronized</span><span class="token punctuation">(</span>resourceSecond<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"主线程获取了锁 resourceFirst"</span><span class="token punctuation">)</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"主线程 mockDeadLock"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面这段代码逻辑：</p> 
<ol><li>工作线程先获取锁<code>resourceSecond</code>，然后睡眠100ms保证主线程能获取到锁<code>resourceFirst</code>。</li><li>主线程睡眠30ms后先获取锁<code>resourceFirst</code>，然后再尝试获取锁<code>resourceSecond</code>，这时候是获取不到的，因为工作线程已经持有锁<code>resourceSecond</code>并且不释放。</li><li>工作线程睡眠结束以后尝试获取锁<code>resourceFirst</code>，这时候是获取不到的，因为主线程持有了锁<code>resourceFirst</code>并且不释放。</li><li>最终，造成死锁。</li></ol> 
<p>调用mockDeadLock()方法以后，多次点击返回键，制造ANR。</p> 
<p><strong>Logcat输出</strong></p> 
<pre><code class="prism language-c"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">41.246</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> ANR in com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">jetpackdemo</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token operator">/</span><span class="token punctuation">.</span>StartActivity<span class="token punctuation">)</span>
    PID<span class="token operator">:</span> <span class="token number">13626</span>
    Reason<span class="token operator">:</span> Input dispatching timed <span class="token function">out</span> <span class="token punctuation">(</span>Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it<span class="token punctuation">.</span>  Outbound queue length<span class="token operator">:</span> <span class="token number">0.</span>  Wait queue length<span class="token operator">:</span> <span class="token number">2.</span><span class="token punctuation">)</span>
    Load<span class="token operator">:</span> <span class="token number">7.53</span> <span class="token operator">/</span> <span class="token number">6.81</span> <span class="token operator">/</span> <span class="token number">6.4</span>
    CPU usage from <span class="token number">177565</span>ms to <span class="token number">0</span>ms <span class="token function">ago</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">39.715</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">37.281</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">11</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">7.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">4.4</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">68219</span> minor <span class="token number">37</span> major
      <span class="token number">3.4</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">2.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">20555</span> minor <span class="token number">29</span> major
      <span class="token number">2</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">0.9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">76</span> minor
      <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">1.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">82</span> minor <span class="token number">1</span> major
      <span class="token number">0</span><span class="token operator">%</span> <span class="token number">24463</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>hwid<span class="token punctuation">.</span>persistent<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">7819</span> minor <span class="token number">24</span> major
      <span class="token number">0.9</span><span class="token operator">%</span> <span class="token number">2823</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>systemmanager<span class="token operator">:</span>service<span class="token operator">:</span> <span class="token number">0.6</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.2</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">13277</span> minor <span class="token number">12</span> major
    <span class="token comment">//...      </span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">41.246</span> <span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> CPU usage from <span class="token number">1714</span>ms to <span class="token number">2243</span>ms <span class="token function">later</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">38.994</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">39.523</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">12</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">3.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">8</span> minor
        <span class="token number">10</span><span class="token operator">%</span> <span class="token number">2014</span><span class="token operator">/</span>ActivityManager<span class="token operator">:</span> <span class="token number">5.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">5.4</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2399</span><span class="token operator">/</span>UEventObserver<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">1.5</span><span class="token operator">%</span> <span class="token number">13652</span><span class="token operator">/</span>kworker<span class="token operator">/</span>u16<span class="token operator">:</span><span class="token number">7</span><span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">%</span> kernel
    <span class="token number">2.3</span><span class="token operator">%</span> TOTAL<span class="token operator">:</span> <span class="token number">1.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.1</span><span class="token operator">%</span> kernel
</code></pre> 
<p>上面的Logcat输出并没有关于我们进程的CUP信息，说明我们的进程CPU占用率很低。那么我们继续看一下traces.txt文件。</p> 
<p><strong>traces.txt部分信息</strong></p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">13626</span> at <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">37</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Cmd line<span class="token operator">:</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo
Build fingerprint<span class="token operator">:</span> 'HUAWEI<span class="token operator">/</span>MLA<span class="token operator">-</span>AL10<span class="token operator">/</span>HWMLA<span class="token operator">:</span><span class="token number">7.0</span><span class="token operator">/</span>HUAWEIMLA<span class="token operator">-</span>AL10<span class="token operator">/</span>C00B364<span class="token operator">:</span>user<span class="token operator">/</span>release<span class="token operator">-</span>keys'
</code></pre> 
<p>通过进程号pid 13626搜索</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Blocked
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">13626</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">288564792</span> <span class="token number">6939269</span> <span class="token number">224</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">23</span> stm<span class="token operator">=</span><span class="token number">5</span> core<span class="token operator">=</span><span class="token number">0</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">mockDeadLock</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">142</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> waiting to lock <span class="token operator">&lt;</span><span class="token number">0x0a43b5c8</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">)</span> held by thread <span class="token number">17</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">70</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span>AppCompatViewInflater$DeclaredOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>AppCompatViewInflater<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">397</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5646</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View$PerformClick<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22473</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">761</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">98</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6517</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit$MethodAndArgsCaller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">832</span><span class="token punctuation">)</span>
</code></pre> 
<p>主线程状态是线程状态是Blocked，说明正在等待获取锁对象，等待获取的锁对象&lt;0x0a43b5c8&gt;是一个String对象(a java.lang.String)，该对象被线程id为17的线程持有。然后我们搜索这个锁对象。</p> 
<pre><code class="prism language-c"><span class="token string">"Thread-2"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">17</span> Blocked
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x12c89dc0</span> self<span class="token operator">=</span><span class="token number">0x7f931cd000</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">13763</span> nice<span class="token operator">=</span><span class="token number">0</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7f84344450</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">886406</span> <span class="token number">280365</span> <span class="token number">2</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">0</span> stm<span class="token operator">=</span><span class="token number">0</span> core<span class="token operator">=</span><span class="token number">0</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7f84242000</span><span class="token operator">-</span><span class="token number">0x7f84244000</span> stackSize<span class="token operator">=</span><span class="token number">1037</span>KB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity$mockDeadLock$<span class="token number">1.</span><span class="token function">invoke</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">127</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> waiting to lock <span class="token operator">&lt;</span><span class="token number">0x0ec26674</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">)</span> held by thread <span class="token number">1</span>
  <span class="token operator">-</span> locked <span class="token operator">&lt;</span><span class="token number">0x0a43b5c8</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>android<span class="token punctuation">.</span>jetpackdemo<span class="token punctuation">.</span>StartActivity$mockDeadLock$<span class="token number">1.</span><span class="token function">invoke</span><span class="token punctuation">(</span>StartActivity<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span>
  at kotlin<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>ThreadsKt$thread$thread$<span class="token number">1.</span><span class="token function">run</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>kt<span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre> 
<p>Thread-2，线程状态是Blocked，说明正在等待获取锁对象，等待获取的锁对象&lt;0x0ec26674&gt;是一个String对象(a java.lang.String)，这个对象被线程id为1的线程（也就是主线程）持有。并且当前线程持有锁对象&lt;0x0a43b5c8&gt;。</p> 
<p>最终，主线程和工作线程Thread-2造成死锁，导致应用无响应。</p> 
<h3><a id="105_Binder_1459"></a>10.5 主线程对另一个进程进行同步Binder调用，后者需很长时间才能返回</h3> 
<p>代码实现是从客户端的两个EditText中获取两个数字，然后通过Binder调用服务端的方法计算两个数的和返回给客户端，然后客户端讲计算结果展示在界面上。</p> 
<p><strong>客户端部分代码</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">IMyAidlInterface</span> iMyAidlInterface<span class="token punctuation">;</span>
    
<span class="token keyword">private</span> <span class="token class-name">ServiceConnection</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token class-name">ComponentName</span> name<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">//获取Binder对象</span>
         iMyAidlInterface <span class="token operator">=</span> <span class="token class-name">IMyAidlInterface<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
    
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>btn_count<span class="token operator">:</span>
            mNum1 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>etNum1<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mNum2 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>etNum2<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//在主线程进行同步binder调用</span>
                mTotal <span class="token operator">=</span> iMyAidlInterface<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mNum1<span class="token punctuation">,</span> mNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onClick: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            editShowResult<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"mTotal="</span> <span class="token operator">+</span> mTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>服务端部分代码</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IRemoteService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"IRemoteService"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">IBinder</span> iBinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IMyAidlInterface<span class="token punctuation">.</span>Stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"remote method add: start sleep thread id ="</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">","</span> <span class="token operator">+</span>
                    <span class="token string">"thread name = "</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//睡眠一段时间，然后才进行计算</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"remote method add: finish sleep return calculate result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">IRemoteService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">onBind</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> iBinder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意：我们需要先把Binder服务端运行起来，然后再运行Binder客户端执行相应的方法。</p> 
<p><strong>Logcat输出</strong></p> 
<pre><code class="prism language-c"><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">47.006</span> <span class="token number">2001</span><span class="token operator">-</span><span class="token number">2014</span><span class="token operator">/</span><span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> ANR in com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span><span class="token function">aidlclient</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlclient<span class="token operator">/</span><span class="token punctuation">.</span>BaseKnowledgeActivity<span class="token punctuation">)</span>
    PID<span class="token operator">:</span> <span class="token number">18096</span>
    Reason<span class="token operator">:</span> Input dispatching timed <span class="token function">out</span> <span class="token punctuation">(</span>Waiting to send key event because the focused window has not finished processing all of the input events that were previously delivered to it<span class="token punctuation">.</span>  Outbound queue length<span class="token operator">:</span> <span class="token number">0.</span>  Wait queue length<span class="token operator">:</span> <span class="token number">2.</span><span class="token punctuation">)</span>
    Load<span class="token operator">:</span> <span class="token number">7.55</span> <span class="token operator">/</span> <span class="token number">7.26</span> <span class="token operator">/</span> <span class="token number">6.87</span>
    CPU usage from <span class="token number">755516</span>ms to <span class="token number">0</span>ms <span class="token function">ago</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">07.545</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">43.062</span><span class="token punctuation">)</span> with <span class="token number">99</span><span class="token operator">%</span> awake<span class="token operator">:</span>
      <span class="token number">5.1</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">3.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">139606</span> minor <span class="token number">17</span> major
      <span class="token number">1.2</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">0.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">35</span> minor
      <span class="token number">0.9</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">0.7</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">13039</span> minor <span class="token number">4</span> major
      <span class="token number">0.8</span><span class="token operator">%</span> <span class="token number">12442</span><span class="token operator">/</span>adbd<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.6</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">23957</span> minor
      <span class="token number">0.7</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">0.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.3</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">183</span> minor <span class="token number">2</span> major
      <span class="token number">0.6</span><span class="token operator">%</span> <span class="token number">28932</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>appmarket<span class="token operator">:</span> <span class="token number">0.5</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.1</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">9311</span> minor <span class="token number">64</span> major
      <span class="token number">0.4</span><span class="token operator">%</span> <span class="token number">24463</span><span class="token operator">/</span>com<span class="token punctuation">.</span>huawei<span class="token punctuation">.</span>hwid<span class="token punctuation">.</span>persistent<span class="token operator">:</span> <span class="token number">0.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">11607</span> minor <span class="token number">6</span> major
      <span class="token number">0.5</span><span class="token operator">%</span> <span class="token number">24301</span><span class="token operator">/</span>fingerprint_log<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0.5</span><span class="token operator">%</span> kernel
      <span class="token number">0.3</span><span class="token operator">%</span> <span class="token number">4128</span><span class="token operator">/</span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>gms<span class="token operator">:</span> <span class="token number">0.2</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">26970</span> minor <span class="token number">16</span> major
      <span class="token comment">//...</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">47.006</span> <span class="token number">2001</span><span class="token operator">-</span><span class="token number">2014</span><span class="token operator">/</span><span class="token operator">?</span> E<span class="token operator">/</span>ActivityManager<span class="token operator">:</span> CPU usage from <span class="token number">1701</span>ms to <span class="token number">2232</span>ms <span class="token function">later</span> <span class="token punctuation">(</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">44.762</span> to <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">45.293</span><span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token number">28</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">21</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">7.2</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">38</span> minor
        <span class="token number">16</span><span class="token operator">%</span> <span class="token number">2010</span><span class="token operator">/</span>HeapTaskDaemon<span class="token operator">:</span> <span class="token number">16</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">9</span><span class="token operator">%</span> <span class="token number">2014</span><span class="token operator">/</span>ActivityManager<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">7.2</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2001</span><span class="token operator">/</span>system_server<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">2540</span><span class="token operator">/</span>NetdConnector<span class="token operator">:</span> <span class="token number">1.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">9</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">9</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">5.4</span><span class="token operator">%</span> <span class="token number">607</span><span class="token operator">/</span>surfaceflinger<span class="token operator">:</span> <span class="token number">5.4</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">658</span><span class="token operator">/</span>Binder<span class="token operator">:</span><span class="token number">607</span>_1<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
        <span class="token number">1.8</span><span class="token operator">%</span> <span class="token number">677</span><span class="token operator">/</span>EventThread<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.8</span><span class="token operator">%</span> kernel
      <span class="token number">7.1</span><span class="token operator">%</span> <span class="token number">2661</span><span class="token operator">/</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>systemui<span class="token operator">:</span> <span class="token number">5.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.7</span><span class="token operator">%</span> kernel <span class="token operator">/</span> faults<span class="token operator">:</span> <span class="token number">38</span> minor
        <span class="token number">8.9</span><span class="token operator">%</span> <span class="token number">3614</span><span class="token operator">/</span>RenderThread<span class="token operator">:</span> <span class="token number">7.1</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.7</span><span class="token operator">%</span> kernel
      <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">508</span><span class="token operator">/</span>logd<span class="token operator">:</span> <span class="token number">1.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
      <span class="token number">1.3</span><span class="token operator">%</span> <span class="token number">624</span><span class="token operator">/</span>mm<span class="token operator">-</span>pp<span class="token operator">-</span>dpps<span class="token operator">:</span> <span class="token number">1.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">0</span><span class="token operator">%</span> kernel
        <span class="token number">2.7</span><span class="token operator">%</span> <span class="token number">717</span><span class="token operator">/</span>ABA_THREAD<span class="token operator">:</span> <span class="token number">1.3</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.3</span><span class="token operator">%</span> kernel
      <span class="token number">1.5</span><span class="token operator">%</span> <span class="token number">15978</span><span class="token operator">/</span>mdss_fb0<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">%</span> kernel
      <span class="token number">1.6</span><span class="token operator">%</span> <span class="token number">18228</span><span class="token operator">/</span>logcat<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">1.6</span><span class="token operator">%</span> kernel
    <span class="token number">8.3</span><span class="token operator">%</span> TOTAL<span class="token operator">:</span> <span class="token number">5.8</span><span class="token operator">%</span> user <span class="token operator">+</span> <span class="token number">2.5</span><span class="token operator">%</span> kernel
</code></pre> 
<p>并没有什么有价值的信息。继续看一下traces.txt文件。<br> traces.txt中客户端相关信息</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">18096</span> at <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">43</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Cmd line<span class="token operator">:</span> com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlclient
Build fingerprint<span class="token operator">:</span> 'HUAWEI<span class="token operator">/</span>MLA<span class="token operator">-</span>AL10<span class="token operator">/</span>HWMLA<span class="token operator">:</span><span class="token number">7.0</span><span class="token operator">/</span>HUAWEIMLA<span class="token operator">-</span>AL10<span class="token operator">/</span>C00B364<span class="token operator">:</span>user<span class="token operator">/</span>release<span class="token operator">-</span>keys'
</code></pre> 
<p>通过进程号pid 18096搜索</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Native
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">18096</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">464662186</span> <span class="token number">22498334</span> <span class="token number">359</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">38</span> stm<span class="token operator">=</span><span class="token number">8</span> core<span class="token operator">=</span><span class="token number">0</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  kernel<span class="token operator">:</span> __switch_to<span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">/</span><span class="token number">0x7c</span>
  kernel<span class="token operator">:</span> binder_thread_read<span class="token operator">+</span><span class="token number">0x4cc</span><span class="token operator">/</span><span class="token number">0x13f0</span>
  kernel<span class="token operator">:</span> binder_ioctl<span class="token operator">+</span><span class="token number">0x53c</span><span class="token operator">/</span><span class="token number">0xbcc</span>
  kernel<span class="token operator">:</span> do_vfs_ioctl<span class="token operator">+</span><span class="token number">0x570</span><span class="token operator">/</span><span class="token number">0x5a8</span>
  kernel<span class="token operator">:</span> SyS_ioctl<span class="token operator">+</span><span class="token number">0x60</span><span class="token operator">/</span><span class="token number">0x88</span>
  kernel<span class="token operator">:</span> el0_svc_naked<span class="token operator">+</span><span class="token number">0x24</span><span class="token operator">/</span><span class="token number">0x28</span>
  native<span class="token operator">:</span> #<span class="token number">00</span> pc <span class="token number">000000000006</span>ad6c  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>__ioctl<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">01</span> pc <span class="token number">000000000001f</span>a48  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>ioctl<span class="token operator">+</span><span class="token number">144</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">02</span> pc <span class="token number">00000000000555</span>a4  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN7android14IPCThreadState14talkWithDriverEb<span class="token operator">+</span><span class="token number">260</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">03</span> pc <span class="token number">0000000000056388</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN7android14IPCThreadState15waitForResponseEPNS_6ParcelEPi<span class="token operator">+</span><span class="token number">352</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">04</span> pc <span class="token number">000000000004</span>b250  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libbinder<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN7android8BpBinder8transactEjRKNS_6ParcelEPS1_j<span class="token operator">+</span><span class="token number">72</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">05</span> pc <span class="token number">0000000000103354</span>  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libandroid_runtime<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">06</span> pc <span class="token number">0000000000</span>b36238  <span class="token operator">/</span>data<span class="token operator">/</span>dalvik<span class="token operator">-</span>cache<span class="token operator">/</span>arm64<span class="token operator">/</span>system@framework@boot<span class="token operator">-</span>framework<span class="token punctuation">.</span><span class="token function">oat</span> <span class="token punctuation">(</span>Java_android_os_BinderProxy_transactNative__ILandroid_os_Parcel_2Landroid_os_Parcel_2I<span class="token operator">+</span><span class="token number">196</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>BinderProxy<span class="token punctuation">.</span><span class="token function">transactNative</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>BinderProxy<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">617</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlserver<span class="token punctuation">.</span>IMyAidlInterface$Stub$Proxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>IMyAidlInterface<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">90</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlclient<span class="token punctuation">.</span>BaseKnowledgeActivity<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>BaseKnowledgeActivity<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">109</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlclient<span class="token punctuation">.</span>BaseKnowledgeActivity_ViewBinding$<span class="token number">1.</span><span class="token function">doClick</span><span class="token punctuation">(</span>BaseKnowledgeActivity_ViewBinding<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">41</span><span class="token punctuation">)</span>
  at butterknife<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>DebouncingOnClickListener<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>DebouncingOnClickListener<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5646</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View$PerformClick<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">22473</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">761</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Handler<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">98</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6517</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit$MethodAndArgsCaller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">832</span><span class="token punctuation">)</span>
</code></pre> 
<p>看到Binder客户端主线程的状态是Native，这个状态是native线程的一个状态，对应java线程的RUNNABLE状态。更详细的对应关系可以参考<a href="https://links.jianshu.com/go?to=https://android.googlesource.com/platform/libcore/%2b/0806909/libdvm/src/main/java/java/lang/VMThread.java" rel="nofollow">VMThread.java</a>。然后从上面的信息中我们只看到BinderProxy调用了transactNative()方法，这是一个本地方法，最终会调用服务端Binder对象的transact()方法，实现真正的跨进程通信。除了这些我们没有看到其他有用的信息了。那么我们接下来看一看服务端的一些信息，看看能不能找到一些线索。</p> 
<p>traces.txt中服务端相关信息</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> pid <span class="token number">17773</span> at <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">43</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
Cmd line<span class="token operator">:</span> com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlserver
Build fingerprint<span class="token operator">:</span> 'HUAWEI<span class="token operator">/</span>MLA<span class="token operator">-</span>AL10<span class="token operator">/</span>HWMLA<span class="token operator">:</span><span class="token number">7.0</span><span class="token operator">/</span>HUAWEIMLA<span class="token operator">-</span>AL10<span class="token operator">/</span>C00B364<span class="token operator">:</span>user<span class="token operator">/</span>release<span class="token operator">-</span>keys'
</code></pre> 
<p>通过进程号pid 17773搜索</p> 
<pre><code class="prism language-c"><span class="token string">"main"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">1</span> Native
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x77d21af8</span> self<span class="token operator">=</span><span class="token number">0x7fa2ea2a00</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">17773</span> nice<span class="token operator">=</span><span class="token number">0</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa6f4ba98</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">213791882</span> <span class="token number">16481247</span> <span class="token number">206</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">18</span> stm<span class="token operator">=</span><span class="token number">3</span> core<span class="token operator">=</span><span class="token number">1</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fd42e0000</span><span class="token operator">-</span><span class="token number">0x7fd42e2000</span> stackSize<span class="token operator">=</span><span class="token number">8</span>MB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  kernel<span class="token operator">:</span> __switch_to<span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">/</span><span class="token number">0x7c</span>
  kernel<span class="token operator">:</span> SyS_epoll_wait<span class="token operator">+</span><span class="token number">0x2d4</span><span class="token operator">/</span><span class="token number">0x394</span>
  kernel<span class="token operator">:</span> SyS_epoll_pwait<span class="token operator">+</span><span class="token number">0xc4</span><span class="token operator">/</span><span class="token number">0x150</span>
  kernel<span class="token operator">:</span> el0_svc_naked<span class="token operator">+</span><span class="token number">0x24</span><span class="token operator">/</span><span class="token number">0x28</span>
  native<span class="token operator">:</span> #<span class="token number">00</span> pc <span class="token number">000000000006</span>ac80  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>__epoll_pwait<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">01</span> pc <span class="token number">000000000001e21</span>c  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libc<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>epoll_pwait<span class="token operator">+</span><span class="token number">64</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">02</span> pc <span class="token number">00000000000181</span>d8  <span class="token operator">/</span>vendor<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN7android6Looper9pollInnerEi<span class="token operator">+</span><span class="token number">156</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">03</span> pc <span class="token number">000000000001808</span>c  <span class="token operator">/</span>vendor<span class="token operator">/</span>lib64<span class="token operator">/</span>libutils<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN7android6Looper8pollOnceEiPiS1_PPv<span class="token operator">+</span><span class="token number">60</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">04</span> pc <span class="token number">00000000000f</span><span class="token number">66</span>dc  <span class="token operator">/</span>system<span class="token operator">/</span>lib64<span class="token operator">/</span>libandroid_runtime<span class="token punctuation">.</span><span class="token function">so</span> <span class="token punctuation">(</span>_ZN7android18NativeMessageQueue8pollOnceEP7_JNIEnvP8_jobjecti<span class="token operator">+</span><span class="token number">48</span><span class="token punctuation">)</span>
  native<span class="token operator">:</span> #<span class="token number">05</span> pc <span class="token number">0000000000</span>b91ec0  <span class="token operator">/</span>data<span class="token operator">/</span>dalvik<span class="token operator">-</span>cache<span class="token operator">/</span>arm64<span class="token operator">/</span>system@framework@boot<span class="token operator">-</span>framework<span class="token punctuation">.</span><span class="token function">oat</span> <span class="token punctuation">(</span>Java_android_os_MessageQueue_nativePollOnce__JI<span class="token operator">+</span><span class="token number">140</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>MessageQueue<span class="token punctuation">.</span><span class="token function">nativePollOnce</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>MessageQueue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>MessageQueue<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">356</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">138</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>ActivityThread<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ActivityThread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6517</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>invoke<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit$MethodAndArgsCaller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ZygoteInit<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>ZygoteInit<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">832</span><span class="token punctuation">)</span>
</code></pre> 
<p>服务端的进程号是pid 17773，我们看到服务端的主线程中也没有什么线索，不要慌，这里我们似乎忘了一点什么，<strong>服务端的Binder对象是运行在服务端的Binder线程池中的</strong>。<br> 那我们怎么找到具体是Binder线程池中的哪个线程呢？其实在traces.txt文件中也是输出了的。</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> binder transactions <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">18096</span><span class="token operator">:</span><span class="token number">18096</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlclient<span class="token operator">:</span>m<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlclient<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">17773</span><span class="token operator">:</span><span class="token number">17788</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlserver<span class="token operator">:</span>Binder<span class="token operator">:</span><span class="token number">17773</span>_2<span class="token punctuation">)</span> code<span class="token operator">:</span> <span class="token number">1</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> end binder transactions <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre> 
<p>上面这段信息的意思就是，我们是在进程id为18096，内核线程为18096的线程（就是主线程）向进程id为17773，内核线id为17788的线程发起跨进程通信。内核线程id为17788的线程的线程名称是<code>Binder:17773_2</code>。那么我们就搜索一下<code>Binder:17773_2</code>。搜索结果如下所示：</p> 
<pre><code class="prism language-c"><span class="token string">"Binder:17773_2"</span> prio<span class="token operator">=</span><span class="token number">5</span> tid<span class="token operator">=</span><span class="token number">10</span> Sleeping
  <span class="token operator">|</span> group<span class="token operator">=</span><span class="token string">"main"</span> sCount<span class="token operator">=</span><span class="token number">1</span> dsCount<span class="token operator">=</span><span class="token number">0</span> obj<span class="token operator">=</span><span class="token number">0x32c064c0</span> self<span class="token operator">=</span><span class="token number">0x7f9a624800</span>
  <span class="token operator">|</span> sysTid<span class="token operator">=</span><span class="token number">17788</span> nice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">10</span> cgrp<span class="token operator">=</span><span class="token keyword">default</span> sched<span class="token operator">=</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span> handle<span class="token operator">=</span><span class="token number">0x7fa0fc3450</span>
  <span class="token operator">|</span> state<span class="token operator">=</span>S schedstat<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token number">3077762</span> <span class="token number">6086666</span> <span class="token number">14</span> <span class="token punctuation">)</span> utm<span class="token operator">=</span><span class="token number">0</span> stm<span class="token operator">=</span><span class="token number">0</span> core<span class="token operator">=</span><span class="token number">6</span> HZ<span class="token operator">=</span><span class="token number">100</span>
  <span class="token operator">|</span> stack<span class="token operator">=</span><span class="token number">0x7fa0ec9000</span><span class="token operator">-</span><span class="token number">0x7fa0ecb000</span> stackSize<span class="token operator">=</span><span class="token number">1005</span>KB
  <span class="token operator">|</span> held mutexes<span class="token operator">=</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>sleep<span class="token operator">!</span><span class="token punctuation">(</span>Native method<span class="token punctuation">)</span>
  <span class="token operator">-</span> sleeping on <span class="token operator">&lt;</span><span class="token number">0x05eea4a7</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">379</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> locked <span class="token operator">&lt;</span><span class="token number">0x05eea4a7</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">321</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlserver<span class="token punctuation">.</span>IRemoteService$<span class="token number">1.</span><span class="token function">add</span><span class="token punctuation">(</span>IRemoteService<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span>
  at com<span class="token punctuation">.</span>hm<span class="token punctuation">.</span>aidlserver<span class="token punctuation">.</span>IMyAidlInterface$Stub<span class="token punctuation">.</span><span class="token function">onTransact</span><span class="token punctuation">(</span>IMyAidlInterface<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">)</span>
  at android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Binder<span class="token punctuation">.</span><span class="token function">execTransact</span><span class="token punctuation">(</span>Binder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">565</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里我们终于发现了原因，我们看到<code>Binder:17773_2</code>状态是<code>Sleeping</code>，就是服务端的Binder对象的add()方法内部第18行调用了Thread.sleep方法造成长时间无法返回，从而使客户端方法执行无法结束，最终导致ANR。<br> <img src="https://images2.imgbox.com/11/25/OkjSDUKz_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_1679"></a>十一、总结</h2> 
<p>当ANR发生时，先通过logcat定位ANR的类型，然后通过trace信息分析产生ANR的原因，需要重点关注主线程（main）的当前状态和CPU的使用情况！当然ANR还是以预防为主，切记不要在主线程做耗时操作，不管是主动发起还是调用系统方法都需要对耗时的地方进行评估！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8d151a54d84a3cf8ba29358433fff70b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring与设计模式实战之策略模式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e74950cca78fbfa726b33e4a433afc6a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MyBatis源码中的设计模式1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>