<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>高性能Web服务器-Nginx的常用模块 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/7bc6d62a12f853bd5cc7d88e21ab016c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="高性能Web服务器-Nginx的常用模块">
  <meta property="og:description" content="文章目录 Nginx安装Nginx平滑升级与回滚平滑升级流程第1步，下载新版本第2步，编译第3步，执行make第4步，对比新旧版本第5步，备份旧nginx二进制文件第6步，模拟用户正在访问nginx第7步，替换旧的nginx二进制文件第8步，发送USR2信号第9步，发送winch信号，第10步，平滑关掉旧版本的master进程 Nginx核心配置主配置文件结构全局配置指定响应报文server首部 实现多虚拟主机root和aliaslocation配置Nginx账户认证Nginx自定义错误页面自定义错误日志检测文件是否存在 Nginx高级配置Nginx状态页Nginx第三方模块Nginx变量使用 Nginx自定义访问日志自定义默认格式日志 Nginx压缩功能Https功能Https实现过程 Rewrite相关功能Rewrite应用背景rewrite模块指令return rewrite案例：自动跳转https动态匹配跳转break和last Nginx防盗链Nginx反向代理实现Http反向代理Nginx和LVS的区别502和504的区别动静分离请求proxy_pass有无“/”的区别 Http反向代理负载均衡upstream配置参数hash调度算法 负载均衡调度算法 Nginx安装 脚本安装
#!/bin/bash # #******************************************************************** #Author:	wangxiaochun #Date: 2020-12-01 #FileName：	install_nginx.sh #URL: http://www.wangxiaochun.com #Description：	The test script #Copyright (C): 2021 All rights reserved #******************************************************************** SRC_DIR=/usr/local/src NGINX_URL=http://nginx.org/download/ NGINX_FILE=nginx-1.20.2 #NGINX_FILE=nginx-1.18.0 TAR=.tar.gz NGINX_INSTALL_DIR=/apps/nginx CPUS=`lscpu |awk &#39;/^CPU\(s\)/{print $2}&#39;` . /etc/os-release color () { RES_COL=60 MOVE_TO_COL=&#34;echo -en \\033[${RES_COL}G&#34; SETCOLOR_SUCCESS=&#34;echo -en \\033[1;32m&#34; SETCOLOR_FAILURE=&#34;echo -en \\033[1;31m&#34; SETCOLOR_WARNING=&#34;echo -en \\033[1;33m&#34; SETCOLOR_NORMAL=&#34;echo -en \E[0m&#34; echo -n &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-27T16:20:45+08:00">
    <meta property="article:modified_time" content="2024-06-27T16:20:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">高性能Web服务器-Nginx的常用模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Nginx_1" rel="nofollow">Nginx安装</a></li><li><a href="#Nginx_133" rel="nofollow">Nginx平滑升级与回滚</a></li><li><ul><li><a href="#_136" rel="nofollow">平滑升级流程</a></li><li><ul><li><a href="#1_154" rel="nofollow">第1步，下载新版本</a></li><li><a href="#2_164" rel="nofollow">第2步，编译</a></li><li><a href="#3make_172" rel="nofollow">第3步，执行make</a></li><li><a href="#4_177" rel="nofollow">第4步，对比新旧版本</a></li><li><a href="#5nginx_180" rel="nofollow">第5步，备份旧nginx二进制文件</a></li><li><a href="#6nginx_182" rel="nofollow">第6步，模拟用户正在访问nginx</a></li><li><a href="#7nginx_191" rel="nofollow">第7步，替换旧的nginx二进制文件</a></li><li><a href="#8USR2_195" rel="nofollow">第8步，发送USR2信号</a></li><li><a href="#9winch_200" rel="nofollow">第9步，发送winch信号，</a></li><li><a href="#10master_210" rel="nofollow">第10步，平滑关掉旧版本的master进程</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Nginx_214" rel="nofollow">Nginx核心配置</a></li><li><ul><li><a href="#_223" rel="nofollow">主配置文件结构</a></li><li><a href="#_262" rel="nofollow">全局配置</a></li><li><ul><li><a href="#server_299" rel="nofollow">指定响应报文server首部</a></li></ul> 
   </li><li><a href="#_313" rel="nofollow">实现多虚拟主机</a></li><li><a href="#rootalias_379" rel="nofollow">root和alias</a></li><li><a href="#location_428" rel="nofollow">location配置</a></li><li><a href="#Nginx_431" rel="nofollow">Nginx账户认证</a></li><li><a href="#Nginx_443" rel="nofollow">Nginx自定义错误页面</a></li><li><a href="#_461" rel="nofollow">自定义错误日志</a></li><li><a href="#_472" rel="nofollow">检测文件是否存在</a></li></ul> 
  </li><li><a href="#Nginx_495" rel="nofollow">Nginx高级配置</a></li><li><ul><li><a href="#Nginx_496" rel="nofollow">Nginx状态页</a></li><li><a href="#Nginx_536" rel="nofollow">Nginx第三方模块</a></li><li><a href="#Nginx_545" rel="nofollow">Nginx变量使用</a></li></ul> 
  </li><li><a href="#Nginx_603" rel="nofollow">Nginx自定义访问日志</a></li><li><ul><li><a href="#_615" rel="nofollow">自定义默认格式日志</a></li></ul> 
  </li><li><a href="#Nginx_635" rel="nofollow">Nginx压缩功能</a></li><li><a href="#Https_665" rel="nofollow">Https功能</a></li><li><ul><li><a href="#Https_668" rel="nofollow">Https实现过程</a></li></ul> 
  </li><li><a href="#Rewrite_748" rel="nofollow">Rewrite相关功能</a></li><li><ul><li><a href="#Rewrite_749" rel="nofollow">Rewrite应用背景</a></li><li><a href="#rewrite_762" rel="nofollow">rewrite模块指令</a></li><li><ul><li><a href="#return_763" rel="nofollow">return</a></li></ul> 
   </li><li><a href="#rewritehttps_833" rel="nofollow">rewrite案例：自动跳转https</a></li><li><a href="#_861" rel="nofollow">动态匹配跳转</a></li><li><a href="#breaklast_888" rel="nofollow">break和last</a></li></ul> 
  </li><li><a href="#Nginx_920" rel="nofollow">Nginx防盗链</a></li><li><a href="#Nginx_1007" rel="nofollow">Nginx反向代理</a></li><li><ul><li><a href="#Http_1011" rel="nofollow">实现Http反向代理</a></li><li><a href="#NginxLVS_1043" rel="nofollow">Nginx和LVS的区别</a></li><li><a href="#502504_1056" rel="nofollow">502和504的区别</a></li><li><a href="#_1080" rel="nofollow">动静分离请求</a></li><li><a href="#proxy_pass_1108" rel="nofollow">proxy_pass有无“/”的区别</a></li></ul> 
  </li><li><a href="#Http_1139" rel="nofollow">Http反向代理负载均衡</a></li><li><ul><li><a href="#upstream_1166" rel="nofollow">upstream配置参数</a></li><li><a href="#hash_1182" rel="nofollow">hash调度算法</a></li></ul> 
  </li><li><a href="#_1215" rel="nofollow">负载均衡调度算法</a></li></ul> 
</div> 
<p></p> 
<h2><a id="Nginx_1"></a>Nginx安装</h2> 
<p>脚本安装</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#</span>
<span class="token comment">#********************************************************************</span>
<span class="token comment">#Author:			wangxiaochun</span>
<span class="token comment">#Date: 				2020-12-01</span>
<span class="token comment">#FileName：			install_nginx.sh</span>
<span class="token comment">#URL: 				http://www.wangxiaochun.com</span>
<span class="token comment">#Description：		The test script</span>
<span class="token comment">#Copyright (C): 	2021 All rights reserved</span>
<span class="token comment">#********************************************************************</span>
<span class="token assign-left variable">SRC_DIR</span><span class="token operator">=</span>/usr/local/src
<span class="token assign-left variable">NGINX_URL</span><span class="token operator">=</span>http://nginx.org/download/
<span class="token assign-left variable">NGINX_FILE</span><span class="token operator">=</span>nginx-1.20.2
<span class="token comment">#NGINX_FILE=nginx-1.18.0</span>
<span class="token assign-left variable">TAR</span><span class="token operator">=</span>.tar.gz
<span class="token assign-left variable">NGINX_INSTALL_DIR</span><span class="token operator">=</span>/apps/nginx
<span class="token assign-left variable">CPUS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>lscpu <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'/^CPU\(s\)/{print $2}'</span><span class="token variable">`</span></span>
<span class="token builtin class-name">.</span> /etc/os-release

<span class="token function-name function">color</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token assign-left variable">RES_COL</span><span class="token operator">=</span><span class="token number">60</span>
    <span class="token assign-left variable">MOVE_TO_COL</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[<span class="token variable">${RES_COL}</span>G"</span>
    <span class="token assign-left variable">SETCOLOR_SUCCESS</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;32m"</span>
    <span class="token assign-left variable">SETCOLOR_FAILURE</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;31m"</span>
    <span class="token assign-left variable">SETCOLOR_WARNING</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;33m"</span>
    <span class="token assign-left variable">SETCOLOR_NORMAL</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\E">\E</span>[0m"</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$MOVE_TO_COL</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"["</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"success"</span> <span class="token parameter variable">-o</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token variable">${SETCOLOR_SUCCESS}</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"  OK  "</span>    
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"failure"</span> <span class="token parameter variable">-o</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"1"</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span> 
        <span class="token variable">${SETCOLOR_FAILURE}</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"FAILED"</span>
    <span class="token keyword">else</span>
        <span class="token variable">${SETCOLOR_WARNING}</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"WARNING"</span>
    <span class="token keyword">fi</span>
    <span class="token variable">${SETCOLOR_NORMAL}</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"]"</span>
    <span class="token builtin class-name">echo</span> 
<span class="token punctuation">}</span>

<span class="token function-name function">os_type</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">awk</span> -F<span class="token string">'[ "]'</span> <span class="token string">'/^NAME/{print $2}'</span> /etc/os-release
<span class="token punctuation">}</span>

<span class="token function-name function">os_version</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">awk</span> -F<span class="token string">'"'</span> <span class="token string">'/^VERSION_ID/{print $2}'</span> /etc/os-release
<span class="token punctuation">}</span>

<span class="token function-name function">check</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span> <span class="token parameter variable">-e</span> <span class="token variable">${NGINX_INSTALL_DIR}</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{<!-- --></span> color <span class="token string">"nginx 已安装,请卸载后再安装"</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token builtin class-name">cd</span>  <span class="token variable">${SRC_DIR}</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span>  <span class="token parameter variable">-e</span> <span class="token variable">${NGINX_FILE}</span><span class="token variable">${TAR}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"相关文件已准备好"</span> <span class="token number">0</span>
    <span class="token keyword">else</span>
        color <span class="token string">'开始下载 nginx 源码包'</span> <span class="token number">0</span>
        <span class="token function">wget</span> <span class="token variable">${NGINX_URL}</span><span class="token variable">${NGINX_FILE}</span><span class="token variable">${TAR}</span> 
        <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{<!-- --></span> color <span class="token string">"下载 <span class="token variable">${NGINX_FILE}</span><span class="token variable">${TAR}</span>文件失败"</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span> 

<span class="token function-name function">install</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    color <span class="token string">"开始安装 nginx"</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token function">id</span> nginx  <span class="token operator">&amp;&gt;</span> /dev/null<span class="token punctuation">;</span><span class="token keyword">then</span>
        color <span class="token string">"nginx 用户已存在"</span> <span class="token number">1</span> 
    <span class="token keyword">else</span>
        <span class="token function">useradd</span> <span class="token parameter variable">-s</span> /sbin/nologin <span class="token parameter variable">-r</span>  nginx
        color <span class="token string">"创建 nginx 用户"</span> <span class="token number">0</span> 
    <span class="token keyword">fi</span>
    color <span class="token string">"开始安装 nginx 依赖包"</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$ID</span> <span class="token operator">==</span> <span class="token string">"centos"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
	    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$VERSION_ID</span> <span class="token operator">=~</span> ^7 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
            yum <span class="token parameter variable">-y</span> <span class="token parameter variable">-q</span>  <span class="token function">install</span> <span class="token function">make</span> gcc pcre-devel openssl-devel zlib-devel perl-ExtUtils-Embed
		<span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$VERSION_ID</span> <span class="token operator">=~</span> ^8 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
            yum <span class="token parameter variable">-y</span> <span class="token parameter variable">-q</span> <span class="token function">install</span> <span class="token function">make</span> gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed 
		<span class="token keyword">else</span> 
            color <span class="token string">'不支持此系统!'</span>  <span class="token number">1</span>
            <span class="token builtin class-name">exit</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$ID</span> <span class="token operator">==</span> <span class="token string">"rocky"</span>  <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
	    yum <span class="token parameter variable">-y</span> <span class="token parameter variable">-q</span> <span class="token function">install</span> <span class="token function">make</span> gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed 
	<span class="token keyword">else</span>
        <span class="token function">apt</span> update <span class="token operator">&amp;&gt;</span> /dev/null
        <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">make</span> gcc libpcre3 libpcre3-dev openssl libssl-dev zlib1g-dev <span class="token operator">&amp;&gt;</span> /dev/null
    <span class="token keyword">fi</span>
    <span class="token builtin class-name">cd</span> <span class="token variable">$SRC_DIR</span>
    <span class="token function">tar</span> xf <span class="token variable">${NGINX_FILE}</span><span class="token variable">${TAR}</span>
    <span class="token assign-left variable">NGINX_DIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">{<!-- --></span>NGINX_FILE<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>TAR<span class="token punctuation">}</span><span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-nr</span> <span class="token string">'s/^(.*[0-9]).*/\1/p'</span><span class="token variable">`</span></span>
    <span class="token builtin class-name">cd</span> <span class="token variable">${NGINX_DIR}</span>
    ./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span><span class="token variable">${NGINX_INSTALL_DIR}</span> <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module 
    <span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token variable">$CPUS</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> 
    <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> color <span class="token string">"nginx 编译安装成功"</span> <span class="token number">0</span> <span class="token operator">||</span>  <span class="token punctuation">{<!-- --></span> color <span class="token string">"nginx 编译安装失败,退出!"</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"PATH=<span class="token variable">${NGINX_INSTALL_DIR}</span>/sbin:<span class="token variable">${<!-- --><span class="token environment constant">PATH</span>}</span>"</span> <span class="token operator">&gt;</span> /etc/profile.d/nginx.sh
    <span class="token function">cat</span> <span class="token operator">&gt;</span> /lib/systemd/system/nginx.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=<span class="token variable">${NGINX_INSTALL_DIR}</span>/logs/nginx.pid
ExecStartPre=/bin/rm -f <span class="token variable">${NGINX_INSTALL_DIR}</span>/logs/nginx.pid
ExecStartPre=<span class="token variable">${NGINX_INSTALL_DIR}</span>/sbin/nginx -t
ExecStart=<span class="token variable">${NGINX_INSTALL_DIR}</span>/sbin/nginx
ExecReload=/bin/kill -s HUP \<span class="token variable">$MAINPID</span>
KillSignal=SIGQUIT
TimeoutStopSec=5
KillMode=process
PrivateTmp=true
LimitNOFILE=100000

[Install]
WantedBy=multi-user.target
EOF</span>
    systemctl daemon-reload
    systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> nginx <span class="token operator">&amp;&gt;</span> /dev/null 
    systemctl is-active nginx <span class="token operator">&amp;&gt;</span> /dev/null <span class="token operator">||</span>  <span class="token punctuation">{<!-- --></span> color <span class="token string">"nginx 启动失败,退出!"</span> <span class="token number">1</span> <span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    color <span class="token string">"nginx 安装完成"</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

check
<span class="token function">install</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/20/4f/PDN6Akkk_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Nginx_133"></a>Nginx平滑升级与回滚</h2> 
<p><img src="https://images2.imgbox.com/17/d2/Khcmmgby_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_136"></a>平滑升级流程</h3> 
<pre><code class="prism language-bash"><span class="token number">1</span>.将旧Nginx二进制文件换成新Nginx程序文件<span class="token punctuation">(</span>注意备份<span class="token punctuation">)</span>；
<span class="token number">2</span>.向master进程发送USR2信号；
<span class="token number">3</span>.master进程修改pid文件名加上后缀.oldbin,成为nginx.pid.oldbin
<span class="token number">4</span>.master进程用新master文件启动新master进程成为旧master的子进程，
  此时系统中将有新旧两个Nginx主进程共同提供Web服务，
  当前新的请求仍然由旧Nginx的woker进程进行处理，将新生成的master进程的PID存放至新生成的pid文件nginx.pid
<span class="token number">5</span>.向旧的Nginx服务进程发送WINCH信号，使旧的Nginx worker进程平滑停止；
<span class="token number">6</span>.向旧master进程发送QUIT信号，关闭老master，并删除Nginx.pid.oldbin文件；
<span class="token number">7</span>.如果升级有问题，可以回滚：向老master发送HUP,向新master发送QUIT；
</code></pre> 
<p>相关信号<br> <img src="https://images2.imgbox.com/d1/e5/ysu3IraJ_o.png" alt="在这里插入图片描述"><br> 当前nginx版本是1.20.2，我们将它升级到1.22.1<br> <img src="https://images2.imgbox.com/49/0e/mLa8K5He_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1_154"></a>第1步，下载新版本</h4> 
<p>下载新版本nginx-1.22.1.tar.gz包并解压</p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://nginx.org/download/nginx-1.22.1.tar.gz
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">tar</span> xvf nginx-1.22.1.tar.gz
</code></pre> 
<p><img src="https://images2.imgbox.com/29/1e/xkwm32Ls_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b0/56/XFRzFbfy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_164"></a>第2步，编译</h4> 
<p>查看Nginx当前使用的版本及编译选项<br> <img src="https://images2.imgbox.com/a6/7f/olUMX3Vk_o.png" alt="在这里插入图片描述"><br> 开始编译</p> 
<pre><code class="prism language-bash">./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/apps/nginx <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</code></pre> 
<p><img src="https://images2.imgbox.com/92/a4/8cBRMo9v_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3make_172"></a>第3步，执行make</h4> 
<p>执行make无需make install<br> make完之后又在objs目录下生成了nginx文件，这个文件存放就是刚编译完的二进制程序，可以查看编译的这个nginx版本<br> <img src="https://images2.imgbox.com/5d/47/kp6sRviA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ea/df/0Kr11lAL_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_177"></a>第4步，对比新旧版本</h4> 
<p>对比下新旧版本的两个文件的大小<br> <img src="https://images2.imgbox.com/18/08/gDGoEDis_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="5nginx_180"></a>第5步，备份旧nginx二进制文件</h4> 
<p><img src="https://images2.imgbox.com/4d/3d/X066WCIb_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="6nginx_182"></a>第6步，模拟用户正在访问nginx</h4> 
<pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/apps/nginx/html/f1.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">100</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cc/62/2fGmpilR_o.png" alt="在这里插入图片描述"><br> 模拟用户下载f1.img资源<br> <img src="https://images2.imgbox.com/43/bb/lFCKrI3E_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="7nginx_191"></a>第7步，替换旧的nginx二进制文件</h4> 
<p><img src="https://images2.imgbox.com/a2/a1/8VSA7Gpn_o.png" alt="在这里插入图片描述"><br> 检测语法<br> <img src="https://images2.imgbox.com/14/c6/0HpafcQQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="8USR2_195"></a>第8步，发送USR2信号</h4> 
<p><img src="https://images2.imgbox.com/c0/1b/t0DpSB7X_o.png" alt="在这里插入图片描述"><br> 此时的进程变化如下<br> <img src="https://images2.imgbox.com/6a/13/edq5OtZd_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/05/5b/XUgZRZPy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="9winch_200"></a>第9步，发送winch信号，</h4> 
<p>使新的master进程工作<br> <img src="https://images2.imgbox.com/f4/8e/7ljd2TAo_o.png" alt="在这里插入图片描述"><br> 以下截图可以看到旧worker进程正在关闭(shutting down)<br> <img src="https://images2.imgbox.com/0a/ba/yMBTUDCe_o.png" alt="在这里插入图片描述"><br> 此时新版本已经改过来了<br> <img src="https://images2.imgbox.com/46/26/s6dh9kBJ_o.png" alt="在这里插入图片描述"><br> 回滚老版本<br> 如果此时想回滚老版本，直接杀死掉当前的nginx.pid，在将我们之前备份的旧的nginx二进制文件拷贝回去即可。<br> <img src="https://images2.imgbox.com/82/e3/FJxKKIBQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="10master_210"></a>第10步，平滑关掉旧版本的master进程</h4> 
<p><img src="https://images2.imgbox.com/69/a2/xXFnJTkx_o.png" alt="在这里插入图片描述"><br> 我停止了模拟用户的访问，此时旧master进程才彻底退出<br> <img src="https://images2.imgbox.com/e3/55/qrnGk9bt_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Nginx_214"></a>Nginx核心配置</h2> 
<p>Nginx官方指令文档<a href="https://nginx.org/en/docs/dirindex.html" rel="nofollow">https://nginx.org/en/docs/dirindex.html</a></p> 
<p>Nginx的配置文件的组成部分</p> 
<pre><code class="prism language-bash"><span class="token number">1</span>.主配置文件 nginx.conf
<span class="token number">2</span>.子配置文件：include conf.d/*.conf
</code></pre> 
<h3><a id="_223"></a>主配置文件结构</h3> 
<p>nginx配置文件格式说明</p> 
<pre><code class="prism language-bash"><span class="token number">1</span>.配置文件由指令与指令块构成；
<span class="token number">2</span>.每条指令以<span class="token punctuation">;</span>号结尾，指令与值之间以空格符号分隔；
<span class="token number">3</span>.指令块以<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>大括号将多条指令组织在一起，且可以嵌套指令块；
<span class="token number">4</span>.include语句允许组合多个配置文件以提升可维护性；
<span class="token number">5</span>.部分指令参数支持正则表达式。
</code></pre> 
<p>可以查看nginx.conf默认的文件结构配置有哪些</p> 
<pre><code class="prism language-bash"><span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'{|}'</span> /apps/nginx/conf/nginx.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/dc/f3/KbbIypC5_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token comment">#事件驱动相关配置</span>
event<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>

<span class="token comment">#http/https 协议相关配置</span>
http<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token punctuation">}</span>

<span class="token comment">#mail协议相关配置项</span>
mail<span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">}</span>

<span class="token comment">#stream 服务器相关配置</span>
stream<span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_262"></a>全局配置</h3> 
<pre><code class="prism language-bash">Main全局配置段常见的配置指令分类
  <span class="token number">1</span>.正常运行必备的配置
  <span class="token number">2</span>.优化性能相关的配置
  <span class="token number">3</span>.用于调试及定位问题相关的配置
  <span class="token number">4</span>.时间驱动相关配置
</code></pre> 
<pre><code class="prism language-bash">user nginx nginx<span class="token punctuation">;</span>  <span class="token comment">#启动Nginx工作进程的用户和组</span>
worker_processes  <span class="token punctuation">[</span>number <span class="token operator">|</span>auto<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment"># 启动Nginx工作进程的数量，一般设为和CPU核数相同</span>
worker_cpu_affinity 0001 0010 0100 <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment"># 将Nginx工作进程绑定到指定的CPU核心，减少了nginx工作进程在不同cpu核心上来回跳转，减少了cpu对进程资源分配与回收以及内存管理，提高nginx性能。</span>
worker_priority <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment"># 工作进程优先级，-20~20(19)</span>
worker_rlimit_nofile <span class="token number">65535</span><span class="token punctuation">;</span> <span class="token comment"># 所有nginx进程能打开的文件数量上限，包括nginx的所有连接(例如与代理服务器的连接等)</span>
daemon off<span class="token punctuation">;</span> <span class="token comment">#前台运行Nginx服务用于测试，docker等环境</span>
master_process off<span class="token operator">|</span>on<span class="token punctuation">;</span> 是否开启nginx的master-worker工作模式，

events<span class="token punctuation">{<!-- --></span>
   worker_connections <span class="token number">65535</span><span class="token punctuation">;</span> <span class="token comment"># 设置单个工作进程的最大并发连接数</span>
   use epoll<span class="token punctuation">;</span> <span class="token comment">#使用epoll事件驱动，nginx支持总舵事件驱动，如:select、poll、 epoll，智能设置在events模块中。</span>
   accept_mutex on<span class="token punctuation">;</span> <span class="token comment"># on为同一时刻一个请求轮流由worker进程处理，而防止唤醒所有的worker；默认为off,新请求会唤醒所有worker进程，此过程也称为‘惊群’，因此nginx刚安装完以后要进行适当的优化，建议设置为on</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置自动匹配机器的CPU核数，我的CPU是4核<br> <img src="https://images2.imgbox.com/56/ee/4WmbWKqq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/df/81/H1VvU17m_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">worker_cpu_affinity  
worker_cpu_affinity 0001 0010 0100 <span class="token number">1000</span> <span class="token operator">|</span> auto<span class="token punctuation">;</span>
<span class="token comment">#将nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行绑定的，绑定不是意味着当前nginx进程独占一个核心CPU,</span>
<span class="token comment">#但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，</span>
<span class="token comment">#减少了cpu对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/08/67/EKrC8KdW_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="server_299"></a>指定响应报文server首部</h4> 
<pre><code class="prism language-bash">charset charset <span class="token operator">|</span> off<span class="token punctuation">;</span>  <span class="token comment"># 是否在响应报文中的Content-Type显示指定的字符集，默认off不显示</span>
<span class="token comment"># charset uft-8</span>

server_tokens on <span class="token operator">|</span> off <span class="token operator">|</span> build <span class="token operator">|</span> string<span class="token punctuation">;</span> <span class="token comment"># 是否在相应报文的server首部显示nginx版本</span>
</code></pre> 
<p>修改server字段</p> 
<pre><code class="prism language-bash">如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译
如果server_token on, 修改src/core/nginx.h 修改如下
<span class="token comment">#define NGINX_VERSION  "1.110.1"</span>
<span class="token comment">#define NGINX_VER      "Leiginx" NGINX_VERSION</span>
</code></pre> 
<h3><a id="_313"></a>实现多虚拟主机</h3> 
<p>马哥教育有两个域名网站，一个是"马哥官网"，一个是"运维派"，但是这两个网站用的是同一个IP地址。这就是通过Nginx实现的多虚拟主机的案例。该功能通过“ngx_http_core_module”模块实现<br> <img src="https://images2.imgbox.com/a0/8c/FUtTWtkR_o.png" alt="在这里插入图片描述"><br> <strong>多虚拟主机实验步骤</strong></p> 
<p><strong>1.实现目标：</strong><br> 创建两个网站，一个PC站点，一个Mobile站点；</p> 
<p><strong>2.创建子配置文件</strong><br> 创建conf.d的目录分别存放pc和mobile的配置文件<br> <img src="https://images2.imgbox.com/1d/94/mV3gSBzY_o.png" alt="在这里插入图片描述"><br> <strong>pc.conf</strong></p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/pc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>mobile.conf</strong></p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name mobile.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/mobile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8d/e7/eHZqdyOc_o.png" alt="在这里插入图片描述"><br> <strong>3.创建两个站点网页</strong><br> pc站点和mobile站点的网页内容<br> <img src="https://images2.imgbox.com/e4/93/flB1a7tk_o.png" alt="在这里插入图片描述"><br> 通过浏览器访问这两个站点。<br> <img src="https://images2.imgbox.com/2c/bd/X9ql8c4R_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/56/21/mozNxpX8_o.png" alt="在这里插入图片描述"><br> 可以看出页面有中文乱码，所以需要配置“charset utf-8”<br> <img src="https://images2.imgbox.com/2c/40/IqhIamJR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9a/c3/Ggcc6I2C_o.png" alt="在这里插入图片描述"><br> 如此就实现了多虚拟主机的实验，<br> <img src="https://images2.imgbox.com/e1/03/ZUjZD9ug_o.png" alt="在这里插入图片描述"><br> 注意DNS解析我配置的是hosts文件。<br> <img src="https://images2.imgbox.com/ac/c6/xWG25lMk_o.png" alt="在这里插入图片描述"><br> 思考，两个站点的访问时是怎么解析的，<br> <img src="https://images2.imgbox.com/d4/15/P7o5j8i3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/22/6e/XsEucGS4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">两个站点的解析主要是我们的http请求携带了host的主机头，nginx根据不同的host主机头去解析不同的配置文件。
</code></pre> 
<p>当curl 主机的ip地址时，则访问的是nginx的默认页面<br> <img src="https://images2.imgbox.com/b4/1b/bR9itT1W_o.png" alt="在这里插入图片描述"><br> 如果我们将include包含的子配置文件从nginx的主配置文件nginx.conf末尾处提前到sever模块前，则nginx会根据子配置文件的字母顺序去访问相应的站点网页。<br> <img src="https://images2.imgbox.com/67/8c/XXHM4cAO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ca/68/wCOwJ2WG_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/40/98/5UeuV8qM_o.png" alt="在这里插入图片描述"><br> curl命令可以携带host主机到去访问具体的域名</p> 
<pre><code class="prism language-bash">-H, <span class="token parameter variable">--header</span> <span class="token operator">&lt;</span>header/@file<span class="token operator">&gt;</span> Pass custom header<span class="token punctuation">(</span>s<span class="token punctuation">)</span> to server
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/47/OapzPeWR_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="rootalias_379"></a>root和alias</h3> 
<p><strong>root：</strong><br> 指定web的家目录，在定义location的时候，文件的绝对路径等于root+location</p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/pc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /about <span class="token punctuation">{<!-- --></span>
    root /opt/html<span class="token punctuation">;</span> <span class="token comment"># 必须在html目录中创建一个名为about的目录才可以访问，否则报错。</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/4f/G1VfWZ2T_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/78/7c/Onw2KDa5_o.png" alt="在这里插入图片描述"><br> 由此可见，root的配置访问规则是当我们访问“/about”时，就去找/apt/html的about目录下的文件。“/opt/html”是“/about”的根。当“/opt/html”这个根下没有about这个子目录时就会报错。<br> <img src="https://images2.imgbox.com/1c/75/bahVWgAw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e1/a3/dzmjiiYj_o.png" alt="在这里插入图片描述"></p> 
<p><strong>alias：</strong><br> 定义路径别名，会把访问的路径重新定义到其指定的路径，文档映射的另一中机制，仅能用于location上限文中。<br> <img src="https://images2.imgbox.com/9c/4f/BVO526U0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b8/3c/s0R8uDOR_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/pc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /about <span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">alias</span> /opt/pc/aboutdir<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>浏览器访问<br> <img src="https://images2.imgbox.com/60/18/y1imwx1f_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/47/87/YA9OKwAY_o.png" alt="在这里插入图片描述"><br> 由此可见 alias连接过去的目录“/opt/pc/aboutdir”下并没有about这个子目录，也就是说alias的访问规则是当我们访问/about时就去找“/opt/pc/aboutdir”这个目录下的文件，“/about”就是“/opt/pc/aboutdir”的别名。</p> 
<h3><a id="location_428"></a>location配置</h3> 
<p>参加我的另一篇博客 <a href="https://blog.csdn.net/flytalei/article/details/124591082">location匹配规则</a></p> 
<h3><a id="Nginx_431"></a>Nginx账户认证</h3> 
<pre><code class="prism language-bash">Syntax:	auth_basic string <span class="token operator">|</span> off<span class="token punctuation">;</span>
Default:	
auth_basic off<span class="token punctuation">;</span>
Context:	http, server, location, limit_except
</code></pre> 
<p>由“ngx_http_auth_basic_module”模块提供功能</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic</a></p> 
<h3><a id="Nginx_443"></a>Nginx自定义错误页面</h3> 
<pre><code class="prism language-bash">Syntax:	error_page code <span class="token punctuation">..</span>. <span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">[</span>response<span class="token punctuation">]</span><span class="token punctuation">]</span> uri<span class="token punctuation">;</span>
Default:	—
Context:	http, server, location, <span class="token keyword">if</span> <span class="token keyword">in</span> location
</code></pre> 
<p>example</p> 
<pre><code class="prism language-bash">error_page <span class="token number">404</span>             /404.html<span class="token punctuation">;</span>
error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
</code></pre> 
<p>自定义错误页，同时也可以用指定的响应状态码进行相应，可配置在http, server, location, if in location等模块中。</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#error_page" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_core_module.html#error_page</a></p> 
<h3><a id="_461"></a>自定义错误日志</h3> 
<pre><code class="prism language-bash">Syntax:	    error_log <span class="token function">file</span> <span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">;</span>
Default:    error_log logs/error.log error<span class="token punctuation">;</span>
Context:    main, http, mail, stream, server, location

<span class="token comment">#The second parameter determines the level of logging, and can be one of the following: debug, info, notice, warn, error, crit, alert, or emerg.</span>
</code></pre> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/ngx_core_module.html#error_log" rel="nofollow">https://nginx.org/en/docs/ngx_core_module.html#error_log</a></p> 
<h3><a id="_472"></a>检测文件是否存在</h3> 
<pre><code class="prism language-bash">Syntax:	try_files <span class="token function">file</span> <span class="token punctuation">..</span>. uri<span class="token punctuation">;</span>
try_files <span class="token function">file</span> <span class="token punctuation">..</span>. <span class="token operator">=</span>code<span class="token punctuation">;</span>
Default:	—
Context:	server, location
</code></pre> 
<p>For example</p> 
<pre><code class="prism language-bash">location /images/ <span class="token punctuation">{<!-- --></span>
    try_files <span class="token variable">$uri</span> /images/default.gif<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

location <span class="token operator">=</span> /images/default.gif <span class="token punctuation">{<!-- --></span>
    expires 30s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>try_files会按照顺序检查文件是否存在，返回第一个找到的文件和文件夹(结尾加斜线表示为文件夹)，如果所有文件和文件夹都找不到，会进行一个内部重定向到最后一个参数，只有最后一个参数可以引起一个内部重定向，之前的参数值设置内部URI的指向，最后一个参数是回退URI且必须存在，否则会出现内部500错误。</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files</a></p> 
<h2><a id="Nginx_495"></a>Nginx高级配置</h2> 
<h3><a id="Nginx_496"></a>Nginx状态页</h3> 
<p>由nginx的"ngx_http_stub_status_module"模块提供</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html#stub_status" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_stub_status_module.html#stub_status</a></p> 
<pre><code class="prism language-bash">Syntax:	stub_status<span class="token punctuation">;</span>
Default:	—
Context:	server, location
</code></pre> 
<pre><code class="prism language-bash">location <span class="token operator">=</span> /basic_status <span class="token punctuation">{<!-- --></span>
    stub_status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/77/ee/u8WGtR8R_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">Active connections:<span class="token comment">#当前处于活动状态的客户端连接数，包括连接等待空闲连接数=reading+writing+waiting</span>

accepts:<span class="token comment">#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。</span>

hand1ed:<span class="token comment">#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因worker_connections限制等被拒绝的连接</span>

requests:<span class="token comment">#统计总值，Nginx自启动后客户端发来的总的请求数。</span>

Reading:<span class="token comment">#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足</span>

writing:<span class="token comment">#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大</span>

waiting:<span class="token comment">#当前状态，正在等待客户端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于active - (reading+writing)</span>
</code></pre> 
<p>范例：分析网站当前访问量</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment">#cur1 http: / /wang:123456@ww.wangxiaochun. com/nginx_status 2&gt;/dev/nu11 |awk '/Reading/{print $2,$4,$6}'</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">15</span>
</code></pre> 
<h3><a id="Nginx_536"></a>Nginx第三方模块</h3> 
<p>第三方模块是对Nginx的功能扩展。第三方模块需要在编译安装Nginx的时候使用参数–add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源模块，nginx的第三方模块需要从源码重新编译进行支持。</p> 
<p><strong>实现流量监控</strong><br> <a href="https://github.com/vozlt/nginx-module-vts">https://github.com/vozlt/nginx-module-vts</a></p> 
<p><strong>实现信息显示</strong><br> <a href="https://github.com/openresty/echo-nginx-module">https://github.com/openresty/echo-nginx-module</a></p> 
<h3><a id="Nginx_545"></a>Nginx变量使用</h3> 
<p>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用<br> 变量可以分为内置变量和自定义变量<br> 内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/varindex.html" rel="nofollow">https://nginx.org/en/docs/varindex.html</a></p> 
<pre><code class="prism language-bash"><span class="token variable">$remote_addr</span><span class="token punctuation">;</span> <span class="token comment">#存放了客户端的地址，注意是客户端的公网IP</span>

<span class="token variable">$proxy_add_x_forwarded_for</span> 
<span class="token comment"># 此变量表示将客户端IP追加请求报文中x-Forwarded-For首部字段，多个ip之间用逗号隔开，如果请求中灭有X-Forwarded-For，就使用$remote_addr</span>

<span class="token variable">$args</span><span class="token punctuation">;</span> <span class="token comment">#存放了URL中的所有参数</span>
<span class="token variable">$is_args</span><span class="token punctuation">;</span> <span class="token comment">#如果有参数为？否则为空</span>
 
<span class="token variable">$document_root</span><span class="token punctuation">;</span> <span class="token comment">#保存了针对当前资源的请求的系统根目录，例如：/apps/nginx/html.</span>
<span class="token variable">$document_uri</span><span class="token punctuation">;</span> <span class="token comment">#保存了当前不包含参数的URI</span>

<span class="token variable">$host</span><span class="token punctuation">;</span> <span class="token comment">#存放了请求的host名称</span>

limit_rate <span class="token number">10240</span><span class="token punctuation">;</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$1imit_rate</span><span class="token punctuation">;</span>
<span class="token comment">#如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置，则显示0</span>

<span class="token variable">$remote_port</span><span class="token punctuation">;</span> <span class="token comment">#客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口</span>
<span class="token variable">$remote_user</span><span class="token punctuation">;</span> <span class="token comment">#已经经过Auth Basic Module验证的用户名</span>

<span class="token variable">$request_body_file</span><span class="token punctuation">;</span> <span class="token comment">#做反向代理时发给后端服务器的本地资源的名称</span>
<span class="token variable">$request_method</span><span class="token punctuation">;</span> <span class="token comment">#请求资源的方式，GET/PUT/DELETE等</span>
<span class="token variable">$request_filename</span><span class="token punctuation">;</span> <span class="token comment">#当前请求的资源文件的磁盘路径，由root或a7ias指令与URI请求生成的文件绝对路径，如: /apps/nginx/htm1/ main/index.html</span>
<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token comment">#包含请求参数的原始URI，不包含主机名，相当于:$document_uri?$args,例如:/main/index.do?id=20190221&amp;partner=search</span>

<span class="token variable">$scheme</span><span class="token punctuation">;</span> <span class="token comment">#请求的协议，例如:http，https,ftp等</span>

<span class="token variable">$server_protoco1</span><span class="token punctuation">;</span> <span class="token comment">#保存了客户端请求资源使用的协议的版本，例如:HTTP/1.0，HTTP/1.1，HTTP/2.0等</span>
<span class="token variable">$server_addr</span><span class="token punctuation">;</span> <span class="token comment">#保存了服务器的IP地址</span>
<span class="token variable">$server_name</span><span class="token punctuation">;</span> <span class="token comment">#请求的服务器的主机名</span>
<span class="token variable">$server_port</span><span class="token punctuation">;</span> <span class="token comment">#请求的服务器的端口号</span>

<span class="token variable">$http_user_agent</span><span class="token punctuation">;</span> <span class="token comment">#客户端浏览器的详细信息</span>
<span class="token variable">$http_cookie</span><span class="token punctuation">;</span> <span class="token comment">#客户端的所有cookie信息</span>

<span class="token variable">$cookie_</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span> <span class="token comment">#name为任意请求报文首部字部cookie的key名</span>
<span class="token variable">$http_</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>
<span class="token comment">#name为任意请求报文首部字段,表示记录请求报文的首部字段，ame的对应的首部字段名需要为小写，如果有横线需要替换为下划线</span>
arbitrary request header field<span class="token punctuation">;</span> the last part of a variable name is the fieldname converted to lower <span class="token keyword">case</span> with dashes replaced by underscores <span class="token comment">#用下划线代替横线</span>
<span class="token comment">#示例:</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$http_user_agent</span><span class="token punctuation">;</span><span class="token builtin class-name">echo</span> <span class="token variable">$http_host</span><span class="token punctuation">;</span>

<span class="token variable">$sent_http_</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>
<span class="token comment">#name为响应报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线,此变量有问题</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$sent_http_server</span><span class="token punctuation">;</span>

<span class="token variable">$arg_</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span><span class="token comment">#此变量存放了URL中的指定参数，name为请求ur1中指定的参数echo $arg_id;</span>
</code></pre> 
<h2><a id="Nginx_603"></a>Nginx自定义访问日志</h2> 
<p>访问日志是记录客户端即用户的具体请求内容的信息，而在全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和记录日志的level，因此两者是不同的，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同server中定义多个，定义一个日志需要使用access_log指定日志的保存路径，使用log_format指定日志的格式，格式中定义要保存的具体日志内容。</p> 
<p>访问日志由ngx_http_log_module模块实现<br> 官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_log_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_log_module.html</a></p> 
<pre><code class="prism language-bash">Syntax:	access_log path <span class="token punctuation">[</span>format <span class="token punctuation">[</span>buffer<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span>gzip<span class="token punctuation">[</span><span class="token operator">=</span>level<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>flush<span class="token operator">=</span>time<span class="token punctuation">]</span> <span class="token punctuation">[</span>if<span class="token operator">=</span>condition<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        access_log off<span class="token punctuation">;</span>
Default: access_log logs/access.log combined<span class="token punctuation">;</span>
Context: http, server, location, <span class="token keyword">if</span> <span class="token keyword">in</span> location, limit_except
</code></pre> 
<h3><a id="_615"></a>自定义默认格式日志</h3> 
<p>Nginx的默认访问日志记录内容相对比较单一，默认的格式也不方便后期做日志统计分析，生产环境中通常将nginx日志转换为json日志，然后配合使用ELK做日志收集,统计和分析。</p> 
<pre><code class="prism language-bash">log_format access_json <span class="token string">'{"@timestamp":"$time_iso8601", '</span>
   <span class="token string">'"host":"$server_addr",'</span>
   <span class="token string">'"clientip":"$remote_addr",'</span>
   <span class="token string">'"size":"$body_bytes_sent",'</span>
   <span class="token string">'"responsetime":"$request_time",'</span>  <span class="token comment">#总的处理时间</span>
   <span class="token string">'"upstreamtime":"$upstream_response_time",'</span>
   <span class="token string">'"upstreamhost":"$upstream_addr",'</span> <span class="token comment">#后端应用服务器处理时间</span>
   <span class="token string">'"http_host":"$host",'</span>
   <span class="token string">'"uri":"$uri",'</span>
   <span class="token string">'"xff":"$http_x_forwarded_for",'</span>
   <span class="token string">'"referer":"$http_referer",'</span>
   <span class="token string">'"tcp_xff":"$proxy_protoco1_addr",'</span>
   <span class="token string">'"http_user_agent":"$http_user_agent",'</span>
   <span class="token string">'"status":"$status"}'</span><span class="token punctuation">;</span>
access_log/apps/nginx/logs/access_json.logaccess_json<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="Nginx_635"></a>Nginx压缩功能</h2> 
<p>Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且还可以设置压缩比例，压缩后的文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相应的CPU资源。</p> 
<p>Nginx对文件的压缩功能是依赖于模块 ngx_http_gzip_module,默认是内置模块<br> 官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_gzip_module.html</a></p> 
<pre><code class="prism language-bash">Syntax:	<span class="token function">gzip</span> on <span class="token operator">|</span> off<span class="token punctuation">;</span>
Default: <span class="token function">gzip</span> off<span class="token punctuation">;</span>
Context: http, server, location, <span class="token keyword">if</span> <span class="token keyword">in</span> location
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">gzip</span> on <span class="token operator">|</span>off<span class="token punctuation">;</span>  <span class="token comment">#启用或禁用gzip压缩，默认关闭</span>

gzip_comp_leve1 level<span class="token punctuation">;</span>  <span class="token comment">#压缩比由低到高从1到9，默认为1</span>
gzip_disab1e <span class="token string">"MSIE [1-6]\."</span><span class="token punctuation">;</span> <span class="token comment">#禁用IE6 gzip功能</span>

gzip_min_length 1k <span class="token punctuation">;</span> <span class="token comment">#gzip压缩的最小文件，小于设置值的文件将不会压缩</span>
gzip_http_version <span class="token number">1.0</span> <span class="token operator">|</span><span class="token number">1.1</span><span class="token punctuation">;</span> <span class="token comment">#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span>

gzip_buffers number size<span class="token punctuation">;</span> <span class="token comment">#指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:324k或者16 8k;</span>
gzip_types mime-type <span class="token punctuation">..</span>.<span class="token punctuation">;</span><span class="token comment">#指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/htm1，不用显示指定，否则出错</span>

gzip_vary on <span class="token operator">|</span> off<span class="token punctuation">;</span><span class="token comment">#如果启用压缩，是否在响应报文首部插入"vary: Accept-Encoding"，一般建议打开</span>

gzip_static on <span class="token operator">|</span> off<span class="token punctuation">;</span>
<span class="token comment">#预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU#注意:来自于ngx_http_gzip_static_modu7e模块</span>
</code></pre> 
<h2><a id="Https_665"></a>Https功能</h2> 
<p>Web网站的登录页面通常都会使用https加密传输的，加密数据以保障数据的安全，HTTPS能够加密信息，以免敏感信息被第三方获取，所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议，HTTPS其实是有两部分组成:HTTP + SSL/TLS，也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。</p> 
<h3><a id="Https_668"></a>Https实现过程</h3> 
<pre><code class="prism language-bash">https实现过程如下:
<span class="token number">1</span>.客户端发起HTTPS请求:
  客户端访问某个web端的https地址，一般都是443端口

<span class="token number">2</span>.服务端的配置:
  采用https协议的服务器必须要有一套证书，可以通过一些组织申请，也可以自己制作，目前国内很多网站都自己做的，
  当你访问一个网站的时候提示证书不可信任就表示证书是自己做的，
  证书就是一个公钥和私钥匙，就像一把锁和钥匙，正常情况下只有你的钥匙可以打开你的锁，
  你可以把这个送给别人让他锁住一个箱子，里面放满了钱或秘密，别人不知道里面放了什么而且别人也打不开，
  只有你的钥匙是可以打开的。

<span class="token number">3</span>.传送证书:
  服务端给客户端传递证书，其实就是公钥，里面包含了很多信息，例如证书得到的颁发机构、过期时间等等。

<span class="token number">4</span>.客户端解析证书:
  这部分工作是有客户端完成的，首先会验证公钥的有效性，比如颁发机构、过期时间等等，
  如果发现异常则会弹出一个警告框提示证书可能存在问题，
  如果证书没有问题就生成一个随机值，然后用证书对该随机值进行加密，就像2步骤所说把随机值锁起来，不让别人看到。

<span class="token number">5</span>.传送4步骤的加密数据:
  就是将用证书加密后的随机值传递给服务器，目的就是为了让服务器得到这个随机值，
  以后客户端和服务端的通信就可以通过这个随机值进行加密解密了。
  
<span class="token number">6</span>.服务端解密信息:
  服务端用私钥解密5步骤加密后的随机值之后，得到了客户端传过来的随机值<span class="token punctuation">(</span>私钥<span class="token punctuation">)</span>，然后把内容通过该值进行对称加密，
  对称加密就是将信息和私钥通过算法混合在一起，这样除非你知道私钥，不然是无法获取其内部的内容，
  而正好客户端和服务端都知道这个私钥，所以只要机密算法够复杂就可以保证数据的安全性。

<span class="token number">7</span>.传输加密后的信息:
  服务端将用私钥加密后的数据传递给客户端，在客户端可以被还原出原数据内容。

<span class="token number">8</span>.客户端解密信息:
  客户端用之前生成的私钥获解密服务端传递过来的数据，由于数据一直是加密的，因此即使第三方获取到数据也无法知道其详细内容。
</code></pre> 
<p><strong>配置参数如下</strong><br> nginx的https功能基于模块ngx_http_ssl_module实现，因此如果是编译安装的nginx要使用参数ngx_http_ssl_module开启ssl功能，但是作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数–with-http_ssl_module开启</p> 
<p>官方帮助文档： <a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_ssl_module.html</a></p> 
<pre><code class="prism language-bash">ss1 on <span class="token operator">|</span> off<span class="token punctuation">;</span>
<span class="token comment">#为指定的虚拟主机配置是否启用ss1功能，此功能在1.15.0废弃，使用1isten [ssl]替代7isten 443 ssl;</span>

ss1_certificate /path/to/file<span class="token punctuation">;</span>
<span class="token comment">#指向包含当前虚拟主机和CA的两个证书信息的文件，一般是crt文件</span>

ss1_certificate_key /path/to/file<span class="token punctuation">;</span>
<span class="token comment">#当前虚拟主机使用的私钥文件，一般是key文件</span>

ss1_protocols <span class="token punctuation">[</span>SSLv2<span class="token punctuation">]</span> <span class="token punctuation">[</span>SSLv3<span class="token punctuation">]</span> <span class="token punctuation">[</span>TLSv1<span class="token punctuation">]</span> <span class="token punctuation">[</span>TLSv1.1<span class="token punctuation">]</span> <span class="token punctuation">[</span>TLSv1.2<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">#支持ss1协议版本，早期为ss1现在是TLs，默认为后三个</span>

ss1_session_cache off <span class="token operator">|</span> none <span class="token operator">|</span> <span class="token punctuation">[</span>builtin<span class="token punctuation">[</span>:size<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>shared:name:size<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">#配置ss1缓存</span>
  off: <span class="token comment">#关闭缓存</span>
  none: <span class="token comment">#通知客户端支持ss1 session cache，但实际不支持</span>
  builtin<span class="token punctuation">[</span>:size<span class="token punctuation">]</span>: <span class="token comment">#使用opensSL内建缓存，为每worker进程私有</span>
  <span class="token punctuation">[</span>shared <span class="token builtin class-name">:</span> name:size<span class="token punctuation">]</span>: <span class="token comment">#在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，一兆可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称</span>
  
ss1_session_timeout <span class="token function">time</span><span class="token punctuation">;</span>
<span class="token comment">#客户端连接可以复用ss1 session cache中缓存的有效时长，默认5m</span>
</code></pre> 
<p>https配置</p> 
<pre><code class="prism language-bash">server <span class="token punctuation">{<!-- --></span>
    1isten <span class="token number">80</span><span class="token punctuation">;</span>
    listen <span class="token number">443</span> ss1<span class="token punctuation">;</span>
    ssl_certificate /apps/nginx/certs/ww.magedu.org. pem<span class="token punctuation">;</span>
    ssl_certificate_key /apps/nginx/certs/www.magedu.org.key<span class="token punctuation">;</span>
    ssl_session_cache shared:sslcache:20m<span class="token punctuation">;</span>
    ssl_session_timeout 10m<span class="token punctuation">;</span>
    root /data/nginx/htm1 <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Rewrite_748"></a>Rewrite相关功能</h2> 
<h3><a id="Rewrite_749"></a>Rewrite应用背景</h3> 
<p>网站的老域名不使用了又不能马上就下线，于是当用户访问老域名时就将其跳转到新域名上。</p> 
<pre><code class="prism language-bash">Rewrite应用背景
  <span class="token number">1</span>.将用户输入的URL地址进行重写，也就是Rewrite将我们输入的地址修改成了别的地址；
  <span class="token number">2</span>.Rewrite重写之后，我们可能会看到一个全新的地址路径；
  <span class="token number">3</span>.Rewrite重写过程支持正则表达式，这个正则表达式和之前的正则表达式有一些区别，它依靠PCRE；
</code></pre> 
<p>Nginx服务器利用ngx_http_rewrite_module模块解析和处理rewrite请求，此功能依靠PCRE(perl compatible regular expression)，因此编译之前要安装PCRE库，rewrite是nginx服务器的重要功能之一，用于实现URL重写，URL重写是非常有用的功能，比如它可以在我们改变网站结构之后，不需要客户端修改原来的书签，也无需其他网站修改我们的链接就可以设置为访问，另外还可以在一定程度上提高网站的安全性。</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html</a></p> 
<p><img src="https://images2.imgbox.com/71/9b/Bv9Q8p5x_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="rewrite_762"></a>rewrite模块指令</h3> 
<h4><a id="return_763"></a>return</h4> 
<p>return用于完成对请求的处理，并直接向客户端返回响应状态码，比如:可以指定重定向URL(对于特殊重定向状态码，301/302等)或者是指定提示文本内容(对于特殊状态码403/500等)，处于此指令后的所有配置都将不被执行，return可以在server、if 和location块进行配置</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">return</span> code <span class="token punctuation">;</span><span class="token comment">#返回给客户端指定的HTTP状态码</span>
<span class="token builtin class-name">return</span> code <span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">#返回给客户端的状态码及响应报文的实体内容，可以调用变量,其中text如果有空格,需要用单或双引号</span>
<span class="token builtin class-name">return</span> code URL<span class="token punctuation">;</span><span class="token comment">#返回给客户端的URL地址</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token number">301</span>  永久跳转 <span class="token punctuation">(</span>浏览器会有缓存，下次再访问时可从磁盘直接读取<span class="token punctuation">)</span>
<span class="token number">302</span>  临时跳转 <span class="token punctuation">(</span>临时的，没有缓存，下次可能不会跳转<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a2/7b/DSeyGRlm_o.png" alt="在这里插入图片描述"><br> <strong>301配置</strong></p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/pc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /main <span class="token punctuation">{<!-- --></span>
     default_type text/html<span class="token punctuation">;</span>
     <span class="token builtin class-name">return</span> <span class="token number">301</span> /about<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">#基于rewrite的配置实现return 301的效果，使用permanent</span>
  location /exam <span class="token punctuation">{<!-- --></span>
     default_type text/html<span class="token punctuation">;</span>
     rewrite .* /about permanent<span class="token punctuation">;</span> <span class="token comment"># 配置301这个数字会报语法错误</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/33/98/4oUxIj5F_o.png" alt="在这里插入图片描述"><br> 浏览器则会帮你从www.leiedu.org/main跳转到www.leiedu.org/about<br> <img src="https://images2.imgbox.com/68/78/TmEINXYv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7b/d2/k506jO5e_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/11/0f/xRUQaSkW_o.png" alt="在这里插入图片描述"></p> 
<p><strong>302配置</strong></p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/pc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /main <span class="token punctuation">{<!-- --></span>
     default_type text/html<span class="token punctuation">;</span>
     <span class="token builtin class-name">return</span> <span class="token number">302</span> /about<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment"># 基于rewrite的配置实现return 302的效果，使用redirect</span>
  location /test <span class="token punctuation">{<!-- --></span>
     default_type text/html<span class="token punctuation">;</span>
     rewrite .* /about redirect<span class="token punctuation">;</span>  <span class="token comment"># 这里写302数字的话会报语法错误；</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/60/c0/oRDgzhs1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6f/65/CeFRa6iM_o.png" alt="在这里插入图片描述"></p> 
<p>我们看下淘宝和京东两个大厂的重定向策略，<br> <img src="https://images2.imgbox.com/0a/93/OCeSlD8I_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="rewritehttps_833"></a>rewrite案例：自动跳转https</h3> 
<p>案例: 基于通信安全考虑公司网站要求全站https，因此要求将在不影响用户请求的情况下将http请求全部自动跳转至https，另外也可以实现部分location 跳转</p> 
<pre><code class="prism language-bash">server <span class="token punctuation">{<!-- --></span>
  listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  ssl_certificate /apps/nginx/certs/www.magedu.org.crt<span class="token punctuation">;</span>
  ssl_certificate_key /apps/nginx /certs/www.magedu.org.key<span class="token punctuation">;</span>
  ssl_session_cache shared:ss1cache:20m<span class="token punctuation">;</span>
  ssl_session_timeout 10m<span class="token punctuation">;</span>
  server_name www.magedu.org<span class="token punctuation">;</span>
  
  location / <span class="token punctuation">{<!-- --></span>  <span class="token comment">#针对全站跳转</span>
    root /data/nginx/htm1/pc<span class="token punctuation">;</span>
    index index.html <span class="token punctuation">;</span>
    if<span class="token punctuation">(</span><span class="token variable">$scheme</span> <span class="token operator">=</span> http<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">#如果没有加条件判断，会导致死循环</span>
       rewrite / https://<span class="token variable">$host</span> redirect<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
   
  location /login <span class="token punctuation">{<!-- --></span>  <span class="token comment">#针对特定的URL进行跳转https</span>
    if<span class="token punctuation">(</span><span class="token variable">$scheme</span> <span class="token operator">=</span> http<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">#如果没有加条件判断，会导致死循环</span>
       rewrite / https://<span class="token variable">$host</span>/login redirect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_861"></a>动态匹配跳转</h3> 
<p>背景需求，现在sz这个子域名换成shenzhen了，但是sz下的子目录仍然保留，<br> www.leiedu.org/sz/时跳转到www.leiedu.org/shenzhen/</p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/pc<span class="token punctuation">;</span>
    <span class="token comment">#return https://www.baidu.com/;</span>
  <span class="token punctuation">}</span>

  location /main <span class="token punctuation">{<!-- --></span>
     default_type text/html<span class="token punctuation">;</span>
     <span class="token builtin class-name">return</span> <span class="token number">302</span> /about<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /sz <span class="token punctuation">{<!-- --></span>
     default_type text/html<span class="token punctuation">;</span>
     rewrite ^/sz/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ /shenzhen/<span class="token variable">$1</span> redirect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/b0/PR8zwAAk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="breaklast_888"></a>break和last</h3> 
<pre><code class="prism language-bash"><span class="token number">1</span>.break只会匹配一次，相当于java中的break一样匹配一次就跳出循环；
<span class="token number">2</span>.last会多次匹配符合条件的表达式；
</code></pre> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  root /data/nginx/html/pc<span class="token punctuation">;</span>
  
  location /break <span class="token punctuation">{<!-- --></span>
     rewrite ^/break/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> /dose/<span class="token variable">$1</span> <span class="token builtin class-name">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /last <span class="token punctuation">{<!-- --></span>
     rewrite ^/last/<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> /dose/<span class="token variable">$1</span> last<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location /dose <span class="token punctuation">{<!-- --></span>
     default_type text/plain<span class="token punctuation">;</span>
     <span class="token builtin class-name">return</span> <span class="token number">999</span> <span class="token string">"new last test"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ec/36/W3qtk7BC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d9/93/fRRg65TT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/07/c1/zwDWOf0u_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/99/d9/xIFAuN0k_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d3/c5/GLtNNp52_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Nginx_920"></a>Nginx防盗链</h2> 
<p><strong>什么是盗链</strong><br> 如果别人只链接了你网站的图片视频或某个单独的资源，而不是打开了你网站的整个页面，且挂着你网站的资源，还不让用户看到你的网站，而他还节省了这些图片视频的存储空间和网络带宽这就是盗链。</p> 
<p>防盗链的目的是防止其他网站未经许可直接引用你网站的资源(视频，图片等)。防盗链基于客户端携带的referer实现，referer是记录打开一个页面之前是从哪个页面跳转过来的标记信息，<br> referer就是之前的那个网站域名，正常的referer信息有以下几种</p> 
<pre><code class="prism language-bash">none:<span class="token comment">#请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。</span>
b1ocked:<span class="token comment">#请求报文有referer首部，但无有效值，比如为空。</span>
server_names:<span class="token comment">#referer首部中包含本主机名及即nginx监听的server_name。</span>

arbitrary_string: <span class="token comment">#自定义指定字符串，但可使用*作通配符。</span>
                  <span class="token comment">#示例:*.magedu.org www.magedu.*regular expression:</span>
                  <span class="token comment">#被指定的正则表达式模式匹配到的字符串,要使用~开头，例如:~。* \.magedu\.com</span>
</code></pre> 
<p><strong>Referer是什么</strong></p> 
<p>在HTTP协议中，Referer（有时也拼写为Referrer）是一个HTTP请求头字段，用于标识从哪里来的请求。具体来说，当一个网页上的链接被点击时，浏览器会在发送HTTP请求时包含Referer头，表明请求是从哪个URL发起的。</p> 
<pre><code class="prism language-bash">Referer作用
  <span class="token number">1</span>.来源追踪：网站可以使用Referer来追踪访问者是从哪个页面或网站跳转过来的。这对于分析网站流量来源、了解用户行为路径非常有用。
  <span class="token number">2</span>.安全性：某些网站通过检查Referer头来确保请求来自于预期的来源，从而防止跨站请求伪造（CSRF）等安全攻击。
  <span class="token number">3</span>.广告和联盟营销：广告商和联盟营销平台使用Referer头来追踪点击广告或联盟链接的来源，从而计算点击率和进行佣金结算。
</code></pre> 
<p><img src="https://images2.imgbox.com/05/b3/naHQTGvi_o.png" alt="在这里插入图片描述"><br> 相关博客参考 <a href="https://www.ruanyifeng.com/blog/2019/06/http-referer.html" rel="nofollow">HTTP Referer 教程</a></p> 
<p><strong>实现盗链</strong><br> 我目前有两个网站www.leiedu.org和mobile.leiedu.org 在mobile.leiedu.org下有一张nginx的png图片，现在我在www.leiedu.org下创建一个referer.html页面，通过链接地址去显示mobile.leiedu.org下的图片<br> <img src="https://images2.imgbox.com/42/02/X0jmqBd1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/34/79/5LR8QSsw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/24/f9/8E8EiPXF_o.png" alt="在这里插入图片描述"><br> referer.html</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>Content-Type</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html;charset=utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>盗链<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://mobile.leiedu.org/nginx.png<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">color</span><span class="token punctuation">:</span>red</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>嘿嘿，我在盗链哦，欢迎大家！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>http://www.magedu.org</span><span class="token punctuation">&gt;</span></span>给咱马哥教育打call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>欢迎你<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/77/ac/xVkbl6bl_o.png" alt="在这里插入图片描述"><br> 查看mobile.leiedu.org的日志可以看出有一个nginx.png的get请求来自于www.leiedu.org，<br> <img src="https://images2.imgbox.com/e6/21/WW53rjGQ_o.png" alt="在这里插入图片描述"><br> 查看referer日志需要打开nginx的主配置文件nginx.conf中access_log main的注释，其中$http_referer的变量就是日志中的referer信息<br> <img src="https://images2.imgbox.com/de/07/3xkxdnKM_o.png" alt="在这里插入图片描述"></p> 
<p><strong>实现防盗链</strong><br> 定义有效的referer，如果是其他的referer就返回状态码403<br> 官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_referer_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_referer_module.html</a><br> <img src="https://images2.imgbox.com/26/d4/xGoIyNop_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name mobile.leiedu.org<span class="token punctuation">;</span>
  access_log /apps/nginx/logs/m.leiedu.org-access.log main<span class="token punctuation">;</span>

  valid_referers none blocked server_names   *.leiedu.com  ~<span class="token punctuation">\</span>.google<span class="token punctuation">\</span>. ~<span class="token punctuation">\</span>.baidu<span class="token punctuation">\</span>. <span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">return</span> <span class="token number">403</span> <span class="token string">"Forbidden Access"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location / <span class="token punctuation">{<!-- --></span>
    root /data/nginx/html/mobile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>谷歌、百度这样的搜索引擎可以是有效的referer，能从谷歌百度上搜索到你，这是你的流量，珍惜。<br> 配置valid_referers的时候防止误杀，别连你自家的referer也被禁止了。<br> <img src="https://images2.imgbox.com/f5/b1/c1F82OYR_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Nginx_1007"></a>Nginx反向代理</h2> 
<p>正向代理代理的是客户端<br> 反向代理代理的是服务器<br> <img src="https://images2.imgbox.com/09/62/9r3laFa6_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Http_1011"></a>实现Http反向代理</h3> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></p> 
<p>我有三台服务器：192.168.10.149，192.168.10.150，192.168.10.151<br> 在150和151的主页分别如下，151的主机域名为www.leiedu.org，现在将151的机器配置为代理服务器，让149通过151去访问150；<br> <img src="https://images2.imgbox.com/5f/dc/1z63pXF3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ce/61/dk27cMqh_o.png" alt="在这里插入图片描述"><br> 没配置151为代理之前，149访问www.leiedu.org时，返回结果如下<br> <img src="https://images2.imgbox.com/ad/e3/L4i2E4H4_o.png" alt="在这里插入图片描述"><br> 配置151为150的代理服务器</p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  root /data/nginx/html/pc<span class="token punctuation">;</span>
  access_log /apps/nginx/logs/pc.leiedu.org-access.log main<span class="token punctuation">;</span>

  location / <span class="token punctuation">{<!-- --></span>
    proxy_pass http://192.168.10.150<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置完代理后，149使用curl命令访问www.leiedu.com时151的主页就出现了，此时浏览器也是的。<br> <img src="https://images2.imgbox.com/1c/d6/bMqdZpeY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ae/f8/lTxsBwvA_o.png" alt="在这里插入图片描述"><br> 如此丝滑的Nginx代理！</p> 
<p>此时查看150的日志可以看出，150根本不知道是使用curl和windos浏览器访问它的ip地址，它只知道代理服务器151是ip<br> <img src="https://images2.imgbox.com/0e/6d/MT8WdVTE_o.png" alt="在这里插入图片描述"><br> 而代理服务器151知道是谁通过它去访问150的。<br> <img src="https://images2.imgbox.com/78/ea/dVe1ZRIL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="NginxLVS_1043"></a>Nginx和LVS的区别</h3> 
<p><img src="https://images2.imgbox.com/f7/4b/VkYr4JOB_o.png" alt="在这里插入图片描述"></p> 
<p>LVS：客户端感知不到LVS的存在，LVS只是一个转发器。<br> Nginx：作为中间代理，分别与客户端和服务端建立三次握手连接。</p> 
<p>我在150的机器上创建了一个1G的大图片，限速149去下载这个大图片，在下载的过程中使用ss命令查看151的TCP是怎么样的一个过程</p> 
<pre><code class="prism language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/nginx/html/test.img <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1000</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/39/2e/3hhp41da_o.png" alt="在这里插入图片描述"><br> 如下图所示，在151上执行ss -nt可以看出，151先和149建立了TCP连接，之后151又和150建立了TCP连接。<br> <img src="https://images2.imgbox.com/ac/0b/1jIPyTR8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="502504_1056"></a>502和504的区别</h3> 
<pre><code class="prism language-bash"><span class="token number">502</span>： 服务器有响应，并明确告诉客户端你就是连不上；
<span class="token number">504</span>： 服务器没有反应，啥也不告诉客户端，客户端一直傻傻等待，等到最后超时了；
</code></pre> 
<p>比如我修改了150的原来的监听端口80为8080，而此时代理服务器151并不知道修改了端口为8080了，此时访问150就报错502了，那么解决此问题就需要将151的proxy_pass也改为8080</p> 
<p>如果后端服务器无法连接(比如：iptables -AINPUT -s nginx_ip -j REJECT或者systemctl stop httpd),关机(无后端服务器arp缓存)，会出现下面502提示<br> <img src="https://images2.imgbox.com/29/e9/PXtH4SRK_o.png" alt="在这里插入图片描述"><br> 151代理服务器上的缓存<br> <img src="https://images2.imgbox.com/96/ea/3B3AenSG_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/42/d1/bqWKerUp_o.png" alt="在这里插入图片描述"><br> 再访问就不报错了<br> <img src="https://images2.imgbox.com/2e/bf/9Jo1II6G_o.png" alt="在这里插入图片描述"><br> 当我在150的机器上设置iptables拒绝代理服务器151的连接之后，149再通过代理访问时就会报错，nginx默认配置是60S的超时时间<br> <img src="https://images2.imgbox.com/de/4d/tq58eu6A_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.10.151 <span class="token parameter variable">-j</span> DROP
</code></pre> 
<p><img src="https://images2.imgbox.com/2a/7c/Qhn4IVvq_o.png" alt="在这里插入图片描述"><br> 默认在1分钟内后端服务器无法响应(比如：iptables -AINPUT -s nginx_ip -j DROP或关机(有后端服务器arp缓存))，会显示下面的504超时提示<br> <img src="https://images2.imgbox.com/52/bc/q0LfPTIA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1080"></a>动静分离请求</h3> 
<p>我的静态资源放在192.168.10.150上；动态资源放在192.168.10.149上，现在实现动静分离请求。</p> 
<pre><code class="prism language-bash">server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  <span class="token comment">#root /data/nginx/html/pc;</span>
  access_log /apps/nginx/logs/pc.leiedu.org-access.log main<span class="token punctuation">;</span>

  location ~ <span class="token punctuation">\</span>.<span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{<!-- --></span>
    proxy_pass http://192.168.10.150:8080<span class="token punctuation">;</span>
    proxy_connect_timeout 10s<span class="token punctuation">;</span>
    <span class="token comment">#root /data/nginx/html/pc;</span>
  <span class="token punctuation">}</span>

  location /api <span class="token punctuation">{<!-- --></span>
    proxy_pass http://192.168.10.149<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/63/39/gUJ1Gcan_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/38/c9/UYv3ZGBj_o.png" alt="在这里插入图片描述"><br> api服务器149上的配置如下<br> <img src="https://images2.imgbox.com/b5/46/mugX1SCw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8e/35/aPDh6gkE_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="proxy_pass_1108"></a>proxy_pass有无“/”的区别</h3> 
<pre><code class="prism language-bash">location /url <span class="token punctuation">{<!-- --></span>
   proxy_pass http://hostname<span class="token punctuation">;</span>         无<span class="token string">"/"</span>,会追加url到后端服务器后面 http://hostname/url
   proxy_pass http://hostname/url2<span class="token punctuation">;</span>    有<span class="token string">"/"</span>,/url2会置换/url http://hostname/url2
<span class="token punctuation">}</span>
</code></pre> 
<p>示例:</p> 
<pre><code class="prism language-bash">location  /web <span class="token punctuation">{<!-- --></span>
   index index.htm1<span class="token punctuation">;</span>
   proxy_pass http://10.0.0.18:8080<span class="token punctuation">;</span>
   <span class="token comment"># 8080后面无uri,即无“/”符号,需要将1ocation后面url附加到proxy_pass指定的url后面,此行为类似于root</span>
   <span class="token comment"># proxy_pass指定的uri不带斜线将访问的/web,等于访问后端服务器http://10.0.0.18:8080/web/index.htm1，即后端服务器配置的站点根目录要有web目录才可以被访问</span>
   <span class="token comment"># http://nginx/web/index.htm1 ==&gt; http://10.0.0.18:8080/web/index.htm1</span>

   proxy_pass http://10.0.0.18:8080/<span class="token punctuation">;</span> 
   <span class="token comment"># 8080后面有uri,即有“/”符号,相当于置换,即访问/web时实际返回proxy_pass后面uri内容.此行为类似于alias</span>
   <span class="token comment"># proxy_pass指定的uri带斜线，等于访问后端服务器的http://10.0.0.18:8080/index.htm1内容返回给客户端</span>
   <span class="token comment"># http://nginx/web/index.htm1 ==&gt; http://10.0.0.18:8080</span>
<span class="token punctuation">}</span>


<span class="token comment">#如果location定义其uri时使用了正则表达式模式(包括~,~*,但不包括A~)，则proxy_pass之后必须不使用uri;即不能有/ ,用户请求时传递的uri将直接附加至后端服务器之后</span>
server <span class="token punctuation">{<!-- --></span>
   server_name <span class="token environment constant">HOSTNAME</span><span class="token punctuation">;</span>
   1ocation ~<span class="token operator">|</span>~* /uri/ <span class="token punctuation">{<!-- --></span>
      proxy_pass  http://host:port<span class="token punctuation">;</span> <span class="token comment">#proxy_pass后面的url不能加/</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Http_1139"></a>Http反向代理负载均衡</h2> 
<p>上面我们通过proxy_pass的配置将客户端的请求转发至单台后端服务器，做了简单的代理转发但是却无法转发至特定的一组服务器，而且不能对后端服务器提供相应的服务器状态监控。那么此时Nginx的ngx_http_upstream_module模块就出现了，该模块提供服务器的分组转发、权重分配、状态检测、调度算法等高级功能。</p> 
<p>官方帮助文档：<a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" rel="nofollow">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></p> 
<p><img src="https://images2.imgbox.com/b7/8b/OUP5XLVK_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">upstream webserver <span class="token punctuation">{<!-- --></span>
  server <span class="token number">192.168</span>.10.149<span class="token punctuation">;</span>
  server <span class="token number">192.168</span>.10.150<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server<span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  charset utf-8<span class="token punctuation">;</span>
  server_name www.leiedu.org<span class="token punctuation">;</span>
  root /data/nginx/html/pc<span class="token punctuation">;</span>
  access_log /apps/nginx/logs/pc.leiedu.org-access.log main<span class="token punctuation">;</span>

  location /<span class="token punctuation">{<!-- --></span>
    proxy_pass http://webserver<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当我使用curl命令访问www.leiedu.org时，已经在轮询显示149和150的首页<br> <img src="https://images2.imgbox.com/43/94/fDDaq1IS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="upstream_1166"></a>upstream配置参数</h3> 
<pre><code class="prism language-bash">server address <span class="token punctuation">[</span>parameters<span class="token punctuation">]</span> <span class="token punctuation">;</span>
<span class="token comment">#配置一个后端web服务器，配置在upstream内，至少要有一个server服务器配置。</span>

<span class="token comment">#server支持的parameters如下:</span>
<span class="token assign-left variable">weight</span><span class="token operator">=</span>number     <span class="token comment">#设置权重，默认为1,实现类似于LVS中的WRR, WLC等</span>
<span class="token assign-left variable">max_conns</span><span class="token operator">=</span>number  <span class="token comment">#给当前后端server设置最大活动链接数，默认为0表示没有限制</span>
<span class="token assign-left variable">max_fai1s</span><span class="token operator">=</span>number  <span class="token comment">#后端服务器的下线条件,当客户端访问时,对本次调度选中的后端服务器连续进行检测多少次,如果都失败就标记为不可用,</span>
                  <span class="token comment">#默认为1次,当客户端访问时,才会利用TCP触发对探测后端服务器健康性检查,而非周期性的探测</span>
<span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span>time <span class="token comment">#后端服务器的上线条件,对已经检测到处于不可用的后端服务器,每隔此时间间隔再次进行检测是否恢复可用，</span>
                  <span class="token comment">#如果发现可用,则将后端服务器参与调度,默认为10秒</span>
backup  <span class="token comment">#设置为备份服务器，当所有后端服务器不可用时,才会启用此备用服务器</span>
down    <span class="token comment">#标记为down状态,可以平滑下线后端服务器,新用户不再调度到此主机,旧用户不受影响</span>
</code></pre> 
<h3><a id="hash_1182"></a>hash调度算法</h3> 
<pre><code class="prism language-bash">将用户的请求调度到哪一台服务器上,为了保持session会话的一致性，当然希望将相同的用户请求调度到同一台服务器上。
nginx可以通过<span class="token variable">$remote_addr</span>、<span class="token variable">$http_cookie</span>这些变量将会话保持一致也就是将相同的原始ip和cookie调度到同一台服务器上。
其实这只是解决seeion会话的一种方案，也可以通过java程序来保存session一致。
</code></pre> 
<pre><code class="prism language-bash">upstream webserver <span class="token punctuation">{<!-- --></span>
  <span class="token comment">#hash $remote_addr;</span>
  <span class="token comment">#hash $http_cookie;</span>
  <span class="token comment">#hash $request_uri;</span>
  server <span class="token number">192.168</span>.10.149<span class="token punctuation">;</span>
  server <span class="token number">192.168</span>.10.150<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token builtin class-name">hash</span> KEY <span class="token punctuation">[</span>consistent<span class="token punctuation">]</span> <span class="token punctuation">;</span>
<span class="token comment">#基于指定请求报文中首部字段或者URI等key做hash计算，使用consistent参数，将使用ketama一致性hash算法，</span>
<span class="token comment">#适用于后端是cache服务器(如varnish）时使用，consistent定义使用一致性hash运算，一致性hash基于取模运算</span>

<span class="token comment">#示例</span>
<span class="token builtin class-name">hash</span> <span class="token variable">$request_uri</span> consistent<span class="token punctuation">;</span><span class="token comment">#基于用户请求的uri做hash</span>
<span class="token builtin class-name">hash</span> <span class="token variable">$cookie_sessionid</span><span class="token comment">#基于cookie中的sessionid这个key进行hash调度,实现会话绑定</span>
ip_hash<span class="token punctuation">;</span>
<span class="token comment">#源地址hash调度方法，基于的客户端的remote_addr(源地址IPv4的前24位或整个IPv6地址)做hashit算，以实现会话保持</span>
<span class="token comment">#hash $remote_addr则是对全部32bit的IPv4进行hash计算</span>

</code></pre> 
<h2><a id="_1215"></a>负载均衡调度算法</h2> 
<p>tcp负载均衡配置由stream提供，需要配置在主配置文件main里</p> 
<pre><code class="prism language-bash">stream <span class="token punctuation">{<!-- --></span> <span class="token comment">#定义stream相关的服务;context:main</span>
   upstream redis-server<span class="token punctuation">{<!-- --></span> <span class="token comment">#定义后端redis服务器</span>
       server <span class="token number">192.168</span>.10.150:6379<span class="token punctuation">;</span>
       server <span class="token number">192.168</span>.10.149:6379<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   upstream mysql-server<span class="token punctuation">{<!-- --></span> <span class="token comment">#定义后端mysql服务器</span>
       server <span class="token number">192.168</span>.10.150:3306<span class="token punctuation">;</span>
       server <span class="token number">192.168</span>.10.149:3306<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   server <span class="token punctuation">{<!-- --></span>
      listen <span class="token number">6379</span><span class="token punctuation">;</span>
      proxy_pass redis-server<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   server <span class="token punctuation">{<!-- --></span>
     listen <span class="token number">3306</span><span class="token punctuation">;</span>
     proxy_pass mysql-server<span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2845e9f0226b7d441c7867733e080c83/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Rust 跨平台-Android 和鸿蒙 OS</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b7eac0e0ba0bcf4da52c01b8a0429e4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">UE4 Unlua的快速使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>