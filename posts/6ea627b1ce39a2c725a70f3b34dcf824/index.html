<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Java原理系列】Java中ClassLoader原理用法示例中文源码分析 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6ea627b1ce39a2c725a70f3b34dcf824/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Java原理系列】Java中ClassLoader原理用法示例中文源码分析">
  <meta property="og:description" content="Java中ClassLoader原理用法示例中文源码分析 文章目录 Java中ClassLoader原理用法示例中文源码分析必看原理用法示例中文源码 必看 类加载器是负责加载类的对象。ClassLoader类是一个抽象类。 给定类的二进制名称，类加载器应该尝试定位或生成构成该类定义的数据。典型的策略是将名称转换为文件名，然后从文件系统中读取该名称的“类文件”。
每个Class对象都包含指向定义它的ClassLoader的引用。
数组类的Class对象不是由类加载器创建的，而是在Java运行时根据需要自动创建的。通过getClassLoader()返回的数组类的类加载器与其元素类型的类加载器相同； 如果元素类型是原始类型，则数组类没有类加载器。
应用程序可以实现ClassLoader的子类以扩展Java虚拟机动态加载类的方式。
类加载器通常由安全管理器用于指示安全域。
ClassLoader类使用委托模型来搜索类和资源。每个ClassLoader实例都有一个关联的父类加载器。在请求查找类或资源时，ClassLoader实例将在尝试自己查找类或资源之前将类或资源的查找委托给其父类加载器。虚拟机内置的类加载器称为“引导类加载器”，它本身没有父类加载器，但可以作为ClassLoader实例的父类。
支持并发加载类的类加载器称为并行可加载类加载器， 它们需要在其类初始化时通过调用ClassLoader.registerAsParallelCapable()方法进行自我注册。 请注意，默认情况下，ClassLoader类已经注册为并行可加载。 然而，如果子类是并行可加载的，则仍然需要注册自己。在非严格层次结构的环境中，类加载器需要具备并行可加载的能力，否则类加载可能会导致死锁，
因为在整个类加载过程中保持了加载器锁（参见loadClass方法）。
通常，Java虚拟机以平台相关的方式从本地文件系统加载类。 例如，在UNIX系统上，虚拟机从CLASSPATH环境变量定义的目录加载类。但是，有些类可能不来自文件；它们可能来自其他来源，如网络，或者可以由应用程序构造。 defineClass方法将字节数组转换为Class实例。 可以使用这个新定义的类的实例来创建对象。
类加载器创建的对象的方法和构造函数可能引用其他类。 为了确定所引用的类，Java虚拟机会调用最初创建该类的类加载器的loadClass方法。
例如，一个应用程序可以创建一个网络类加载器来从服务器下载类文件。 示例代码如下：
ClassLoader loader = new NetworkClassLoader(host, port); Object main = loader.loadClass(&#34;Main&#34;, true).newInstance(); 网络类加载器子类必须定义findClass方法和loadClassData方法来从网络中加载类。 下载组成该类的字节后，应使用defineClass方法创建一个类实例。示例实现如下：
class NetworkClassLoader extends ClassLoader { String host; int port; public Class findClass(String name) { byte[] b = loadClassData(name); return defineClass(name, b, 0, b.length); } private byte[] loadClassData(String name) { // 从连接中加载类数据 .">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-26T13:39:03+08:00">
    <meta property="article:modified_time" content="2023-12-26T13:39:03+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Java原理系列】Java中ClassLoader原理用法示例中文源码分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="JavaClassLoader_0"></a>Java中ClassLoader原理用法示例中文源码分析</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#JavaClassLoader_0" rel="nofollow">Java中ClassLoader原理用法示例中文源码分析</a></li><li><a href="#_3" rel="nofollow">必看</a></li><li><a href="#_55" rel="nofollow">原理</a></li><li><a href="#_71" rel="nofollow">用法</a></li><li><a href="#_90" rel="nofollow">示例</a></li><li><a href="#_172" rel="nofollow">中文源码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_3"></a>必看</h2> 
<p><strong>类加载器是负责加载类的对象</strong>。ClassLoader类是一个<strong>抽象类</strong>。 给定类的二进制名称，类加载器应该尝试定位或生成构成该类定义的数据。典型的策略是将名称转换为文件名，然后从文件系统中读取该名称的“类文件”。</p> 
<p><strong>每个Class对象都包含指向定义它的ClassLoader的引用。</strong></p> 
<p><strong>数组类的Class对象不是由类加载器创建的，而是在Java运行时根据需要自动创建的</strong>。通过getClassLoader()返回的数组类的类加载器与其元素类型的类加载器相同； 如果元素类型是原始类型，则数组类没有类加载器。</p> 
<p><strong>应用程序可以实现ClassLoader的子类以扩展Java虚拟机动态加载类的方式</strong>。</p> 
<p>类加载器通常由安全管理器用于指示安全域。</p> 
<p>ClassLoader类<strong>使用委托模型来搜索类和资源</strong>。每个ClassLoader<strong>实例都有一个关联的父类加载器</strong>。在请求查找类或资源时，ClassLoader实例将<strong>在尝试自己查找类或资源之前将类或资源的查找委托给其父类加载器</strong>。虚拟机内置的类加载器称为“引导类加载器”，它本身没有父类加载器，但可以作为ClassLoader实例的父类。</p> 
<p>支持并发加载类的类加载器称为<strong>并行可加载类加载器</strong>， 它们需要在其类初始化时通过调用ClassLoader.registerAsParallelCapable()方法进行自我注册。 <strong>请注意</strong>，默认情况下，ClassLoader类已经注册为并行可加载。 然而，如果子类是并行可加载的，则仍然需要注册自己。在非严格层次结构的环境中，类加载器需要具备并行可加载的能力，否则类加载可能会导致死锁，<br> 因为在整个类加载过程中保持了加载器锁（参见loadClass方法）。</p> 
<p><strong>通常</strong>，Java虚拟机以平台相关的方式<strong>从本地文件系统加载类</strong>。 例如，在UNIX系统上，<strong>虚拟机从CLASSPATH环境变量定义的目录加载类</strong>。但是，<strong>有些类可能不来自文件</strong>；它们可能来自其他来源，如<strong>网络</strong>，或者可以<strong>由应用程序构造</strong>。 <strong>defineClass方法将字节数组转换为Class实例。</strong> 可以使用这个新定义的类的实例来创建对象。</p> 
<p>类加载器创建的对象的方法和构造函数可能引用其他类。 为了确定所引用的类，Java虚拟机会调用<strong>最初创建该类的类加载器的loadClass方法</strong>。</p> 
<p><strong>例如</strong>，一个应用程序可以创建一个网络类加载器来从服务器下载类文件。 示例代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkClassLoader</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Object</span> main <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"Main"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>网络类加载器子类必须定义findClass方法和loadClassData方法来从网络中加载类。</strong> 下载组成该类的字节后，应使用defineClass方法创建一个类实例。示例实现如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">NetworkClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">String</span> host<span class="token punctuation">;</span>
      <span class="token keyword">int</span> port<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token function">loadClassData</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">loadClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 从连接中加载类数据</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre> 
<p><strong>在ClassLoader的方法中，作为String参数提供的任何类名都必须是由Java语言规范定义的二进制名称。</strong></p> 
<p>二进制名称有效类名的示例包括：<br> “java.lang.String”， “javax.swing.JSpinner<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         D 
        
       
         e 
        
       
         f 
        
       
         a 
        
       
         u 
        
       
         l 
        
       
         t 
        
       
         E 
        
       
         d 
        
       
         i 
        
       
         t 
        
       
         o 
        
       
         r 
        
       
         " 
        
       
         ， 
        
       
         " 
        
       
         j 
        
       
         a 
        
       
         v 
        
       
         a 
        
       
         . 
        
       
         s 
        
       
         e 
        
       
         c 
        
       
         u 
        
       
         r 
        
       
         i 
        
       
         t 
        
       
         y 
        
       
         . 
        
       
         K 
        
       
         e 
        
       
         y 
        
       
         S 
        
       
         t 
        
       
         o 
        
       
         r 
        
       
         e 
        
       
      
        DefaultEditor"， "java.security.KeyStore 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">De</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.0576em;">ltE</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0278em;">or</span><span class="mord">"</span><span class="mord cjk_fallback">，</span><span class="mord">"</span><span class="mord mathnormal">ja</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal">a</span><span class="mord">.</span><span class="mord mathnormal">sec</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right: 0.0359em;">Key</span><span class="mord mathnormal">St</span><span class="mord mathnormal">ore</span></span></span></span></span>Builder$FileBuilder$1”<br> “java.net.URLClassLoader$3$1”</p> 
<h2><a id="_55"></a>原理</h2> 
<p>Java中的ClassLoader类是用于加载Java类的核心类之一。它负责在运行时查找和加载Java类的字节码，并将其转换为可以在Java虚拟机中执行的可执行代码。</p> 
<p>ClassLoader的工作原理如下：</p> 
<ol><li> <p><strong>类加载委派模型</strong>：ClassLoader使用一种称为类加载委派模型的机制来加载类。当应用程序请求加载一个类时，ClassLoader首先检查它是否已经被加载过，如果是，则直接返回该类的定义。如果没有加载过，则将请求传递给父级ClassLoader。这个过程会一直向上层ClassLoader进行传递，直到达到顶级的引导类加载器（Bootstrap ClassLoader）。如果顶级引导类加载器无法找到类的定义，那么会回到初始的ClassLoader，尝试自己加载类。</p> </li><li> <p><strong>双亲委派模型</strong>：ClassLoader通过双亲委派模型来实现类加载的安全性。根据这个模型，ClassLoader在尝试加载类之前，会先委托给其父级ClassLoader去加载。这样可以确保类的加载是从上到下、从外到内的有序加载。这种机制可以防止恶意代码通过替换系统类库中的类来破坏Java运行环境的安全性。</p> </li><li> <p><strong>查找类文件</strong>：当一个ClassLoader需要加载一个类时，它首先会根据类的全限定名转换成类文件的路径。ClassLoader会根据指定的类加载路径（Classpath）来查找类文件。一般情况下，ClassLoader会从文件系统或者JAR文件中查找类文件。</p> </li><li> <p><strong>定义类</strong>：当ClassLoader找到类文件后，会读取类文件的字节码，并将其转换为Java虚拟机可执行的格式。然后使用定义类的方法（defineClass()）将字节码转换为Java类的定义，并返回一个Class对象。</p> </li></ol> 
<p>总之，ClassLoader负责在Java运行时<strong>动态地查找、加载和定义类</strong>。它通过<strong>委派模型和双亲委派机制</strong>保证了类<strong>加载的顺序和安全性</strong>。ClassLoader的工作原理是Java语言实现动态加载和扩展性的重要基础。</p> 
<h2><a id="_71"></a>用法</h2> 
<p>以下是对ClassLoader类全部用法的详细描述：</p> 
<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>loadClass(String name)</code></td><td>加载指定名称的类，并返回对应的Class对象。这个方法使用双亲委派模型，从上至下依次尝试加载类。如果找不到类，则会抛出ClassNotFoundException异常。</td></tr><tr><td><code>findClass(String name)</code></td><td>查找并加载指定名称的类，并返回对应的Class对象。这个方法一般在自定义ClassLoader中重写，以实现自定义的类查找逻辑。如果找不到类，则需要抛出ClassNotFoundException异常。</td></tr><tr><td><code>defineClass(String name, byte[] b, int off, int len)</code></td><td>将字节数组转换为Java类的定义，并返回对应的Class对象。这个方法通常在自定义ClassLoader中被调用，用于加载已经获得的类字节码。</td></tr><tr><td><code>getParent()</code></td><td>获取当前ClassLoader的父级ClassLoader。ClassLoader在加载类时会首先委托给父级ClassLoader去加载。如果没有父级ClassLoader，则返回null。</td></tr><tr><td><code>getSystemClassLoader()</code></td><td>返回系统默认的ClassLoader。这是应用程序的默认ClassLoader，用于加载类路径上的类。</td></tr><tr><td><code>getClassLoader()</code></td><td>获取给定类的ClassLoader。这个方法可以用来获取任意类的ClassLoader，例如通过Class对象的getClassLoader()方法来获取该类的ClassLoader。</td></tr><tr><td><code>setDefaultAssertionStatus(boolean enabled)</code></td><td>设置类加载器的默认断言状态。断言状态决定由ClassLoader加载的类是否默认启用或禁用断言。</td></tr><tr><td><code>setPackageAssertionStatus(String packageName, boolean enabled)</code></td><td>设置指定包的断言状态。可以通过这个方法来控制指定包及其子包下的类是否启用或禁用断言。</td></tr><tr><td><code>setClassAssertionStatus(String className, boolean enabled)</code></td><td>设置指定类的断言状态。可以通过这个方法来控制指定类是否启用或禁用断言。</td></tr><tr><td><code>clearAssertionStatus()</code></td><td>清除类加载器的断言状态，将其重置为默认值。这会清除所有已设置的包和类的断言状态设置。</td></tr></tbody></table> 
<p>ClassLoader类提供了许多用于加载、查找和定义类的方法，以及管理断言状态的功能。这些方法允许开发人员根据自己的需求进行类加载和管理操作，并实现自定义的类加载逻辑。</p> 
<h2><a id="_90"></a>示例</h2> 
<p>下面是一些ClassLoader类的代码示例，展示了其主要用法：</p> 
<ol><li>加载类：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.example.MyClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>查找类：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span><span class="token string">"com.example.MyClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>自定义ClassLoader并重写findClass()方法：</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 自定义类查找逻辑，根据名称加载类字节码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> <span class="token function">loadClassBytes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classBytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用自定义ClassLoader加载类</span>
<span class="token class-name">MyClassLoader</span> classLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.example.MyClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>获取父级ClassLoader：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> parentClassLoader <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li>获取系统ClassLoader：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> systemClassLoader <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="6"><li>获取类加载器链：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
<span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    classLoader <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="7"><li>设置默认断言状态：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
classLoader<span class="token punctuation">.</span><span class="token function">setDefaultAssertionStatus</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="8"><li>设置包和类的断言状态：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
classLoader<span class="token punctuation">.</span><span class="token function">setPackageAssertionStatus</span><span class="token punctuation">(</span><span class="token string">"com.example"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
classLoader<span class="token punctuation">.</span><span class="token function">setClassAssertionStatus</span><span class="token punctuation">(</span><span class="token string">"com.example.MyClass"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="9"><li>清除断言状态：</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
classLoader<span class="token punctuation">.</span><span class="token function">clearAssertionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这些示例展示了ClassLoader类的一些常见用法，涵盖了加载、查找、定义类以及断言状态管理等功能。根据具体需求，可以选择适合的方法来实现所需的类加载和管理操作。</p> 
<h2><a id="_172"></a>中文源码</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 类加载器是负责加载类的对象。ClassLoader类是一个抽象类。
 * 给定类的二进制名称，类加载器应该尝试定位或生成构成该类定义的数据。
 * 典型的策略是将名称转换为文件名，然后从文件系统中读取该名称的“类文件”。
 *
 * 每个Class对象都包含指向定义它的ClassLoader的引用。
 *
 * 数组类的Class对象不是由类加载器创建的，而是在Java运行时根据需要自动创建的。
 * 通过getClassLoader()返回的数组类的类加载器与其元素类型的类加载器相同；
 * 如果元素类型是原始类型，则数组类没有类加载器。
 *
 * 应用程序可以实现ClassLoader的子类以扩展Java虚拟机动态加载类的方式。
 *
 * 类加载器通常由安全管理器用于指示安全域。
 *
 * ClassLoader类使用委托模型来搜索类和资源。
 * 每个ClassLoader实例都有一个关联的父类加载器。
 * 在请求查找类或资源时，ClassLoader实例将在尝试自己查找类或资源之前将类或资源的查找委托给其父类加载器。
 * 虚拟机内置的类加载器称为“引导类加载器”，它本身没有父类加载器，但可以作为ClassLoader实例的父类。
 *
 * 支持并发加载类的类加载器称为并行可加载类加载器，
 * 它们需要在其类初始化时通过调用ClassLoader.registerAsParallelCapable()方法进行自我注册。
 * 请注意，默认情况下，ClassLoader类已经注册为并行可加载。
 * 然而，如果子类是并行可加载的，则仍然需要注册自己。
 * 在非严格层次结构的环境中，类加载器需要具备并行可加载的能力，否则类加载可能会导致死锁，
 * 因为在整个类加载过程中保持了加载器锁（参见loadClass方法）。
 *
 * 通常，Java虚拟机以平台相关的方式从本地文件系统加载类。
 * 例如，在UNIX系统上，虚拟机从CLASSPATH环境变量定义的目录加载类。
 *
 * 但是，有些类可能不来自文件；它们可能来自其他来源，如网络，或者可以由应用程序构造。
 * defineClass方法将字节数组转换为Class实例。
 * 可以使用这个新定义的类的实例来创建对象。
 *
 * 类加载器创建的对象的方法和构造函数可能引用其他类。
 * 为了确定所引用的类，Java虚拟机会调用最初创建该类的类加载器的loadClass方法。
 *
 * 例如，一个应用程序可以创建一个网络类加载器来从服务器下载类文件。
 * 示例代码如下：
 *
 * ClassLoader loader = new NetworkClassLoader(host, port);
 * Object main = loader.loadClass("Main", true).newInstance();
 * ...
 *
 * 网络类加载器子类必须定义findClass方法和loadClassData方法来从网络中加载类。
 * 下载组成该类的字节后，应使用defineClass方法创建一个类实例。示例实现如下：
 *
 * class NetworkClassLoader extends ClassLoader {
 *     String host;
 *     int port;
 *
 *     public Class findClass(String name) {
 *         byte[] b = loadClassData(name);
 *         return defineClass(name, b, 0, b.length);
 *     }
 *
 *     private byte[] loadClassData(String name) {
 *         // 从连接中加载类数据
 *         ...
 *     }
 * }
 *
 * 二进制名称
 *
 * 在ClassLoader的方法中，作为String参数提供的任何类名都必须是由Java语言规范定义的二进制名称。
 *
 * 有效类名的示例包括：
 * "java.lang.String"
 * "javax.swing.JSpinner$DefaultEditor"
 * "java.security.KeyStore$Builder$FileBuilder$1"
 * "java.net.URLClassLoader$3$1"
 *
 * @see      #resolveClass(Class)
 * @since 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 用于委派的父类加载器</span>
    <span class="token comment">// 注意：虚拟机硬编码了这个字段的偏移量，因此所有新字段必须添加到它之后。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 封装并行可加载器类型集合。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ParallelLoaders</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">ParallelLoaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token comment">// 并行可加载器类型集合</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> loaderTypes <span class="token operator">=</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>loaderTypes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> loaderTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 注册给定的类加载器类型为并行可加载。
         * 如果成功注册，则返回true；如果加载器的父类未注册，则返回false。
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>loaderTypes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>loaderTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 仅当所有超类都是并行可加载时，才将类加载器注册为并行可加载。</span>
                    <span class="token comment">// 注意：在当前的类加载顺序下，如果直接超类是并行可加载的，</span>
                    <span class="token comment">// 所有更高级别的超类也必须是并行可加载的。</span>
                    loaderTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 如果给定的类加载器类型已注册为并行可加载，则返回true。
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>loaderTypes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> loaderTypes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当前类加载器支持并发加载类时，将类名映射到相应的锁对象。</span>
    <span class="token comment">// 注意：虚拟机还使用此字段来确定当前类加载器是否支持并发加载，并找到类加载的适当锁对象。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> parallelLockMap<span class="token punctuation">;</span>

    <span class="token comment">// 将包名映射到相应证书的哈希表</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span> <span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> package2certs<span class="token punctuation">;</span>

    <span class="token comment">// 所有无证书类共享的数组</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nocerts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 由该类加载器加载的类。此表的唯一目的是保持类不被GC，直到类加载器被GC。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 此类加载器定义的包。每个包名称都映射到其对应的Package对象。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Package</span><span class="token punctuation">&gt;</span></span> packages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Void</span> <span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SecurityManager</span> security <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            security<span class="token punctuation">.</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token class-name">Void</span> unused<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ParallelLoaders</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            parallelLockMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            assertionLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 没有更细粒度的锁；锁定类加载器实例本身</span>
            parallelLockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            assertionLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用指定的父类加载器创建一个新的类加载器。
     *
     * 如果存在安全管理器，则调用其checkCreateClassLoader方法。
     * 这可能会导致安全异常。
     *
     * @param  parent
     *         父类加载器
     *
     * @throws  SecurityException
     *          如果存在安全管理器并且其checkCreateClassLoader方法不允许创建新的类加载器。
     *
     * @since  1.2
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用由getSystemClassLoader()方法返回的ClassLoader作为父类加载器创建一个新的类加载器。
     *
     * 如果存在安全管理器，则调用其checkCreateClassLoader方法。
     * 这可能会导致安全异常。
     *
     * @throws  SecurityException
     *          如果存在安全管理器并且其checkCreateClassLoader方法不允许创建新的类加载器。
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// -- Class --</span>

    <span class="token comment">/**
     * 加载具有指定二进制名称的类。
     * 此方法与loadClass(String, boolean)方法相同地搜索类。
     * 它是Java虚拟机解析类引用时调用的。
     * 调用此方法等效于调用loadClass(name, false)。
     *
     * @param  name
     *         类的二进制名称
     *
     * @return  结果的Class对象
     *
     * @throws  ClassNotFoundException
     *          如果找不到类
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
<span class="token comment">/**
 * 使用指定的二进制名称加载类。
 * 此方法的默认实现按以下顺序搜索类：
 *
 * 1. 调用findLoadedClass(String)检查类是否已经被加载。
 * 2. 在父类加载器上调用loadClass(String)方法。
 *    如果父类加载器为null，则使用虚拟机内置的类加载器。
 * 3. 调用findClass(String)方法查找类。
 *
 * 如果使用上述步骤找到了类，并且resolve标志为true，
 * 则此方法将在生成的Class对象上调用resolveClass(Class)方法。
 *
 * 鼓励ClassLoader的子类重写findClass(String)方法，而不是这个方法。
 *
 * 除非重写，否则此方法在整个类加载过程中都会同步于getClassLoadingLock(String)方法的结果。
 *
 * @param  name
 *         类的二进制名称
 *
 * @param  resolve
 *         是否解析类
 *
 * @return  结果的Class对象
 *
 * @throws  ClassNotFoundException
 *          如果找不到类
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 首先，检查类是否已经加载</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果父类加载器不为空，从父类加载器中找不到类，则抛出ClassNotFoundException异常</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果仍然找不到，则调用findClass方法查找类</span>
                <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 这是定义类加载器；记录统计信息</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回类加载操作的锁对象。
 * 为了向后兼容性，此方法的默认实现如下所示：
 * 如果此ClassLoader对象已注册为并行可加载，则该方法返回与指定类名相关联的专用对象。
 * 否则，该方法返回此ClassLoader对象。
 *
 * @param  className
 *         要加载的类的名称
 *
 * @return 类加载操作的锁
 *
 * @throws NullPointerException
 *         如果已注册为并行可加载并且className为null
 *
 * @see #loadClass(String, boolean)
 *
 * @since  1.7
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelLockMap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> newLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock <span class="token operator">=</span> parallelLockMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> newLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            lock <span class="token operator">=</span> newLock<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> lock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// JVM在使用此加载器加载类后调用此方法。</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkPackageAccess</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cls<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ReflectUtil</span><span class="token punctuation">.</span><span class="token function">isNonPublicProxyClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> intf<span class="token operator">:</span> cls<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">checkPackageAccess</span><span class="token punctuation">(</span>intf<span class="token punctuation">,</span> pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">String</span> name <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> i <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    sm<span class="token punctuation">.</span><span class="token function">checkPackageAccess</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AccessControlContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtectionDomain</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>pd<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 查找具有指定二进制名称的类。
 * 此方法应该由按照委派模型加载类的类加载器实现重写，
 * 并且将在loadClass方法检查父类加载器是否找到所请求的类后调用。
 * 默认实现会抛出ClassNotFoundException异常。
 *
 * @param  name
 *         类的二进制名称
 *
 * @return  结果的Class对象
 *
 * @throws  ClassNotFoundException
 *          如果找不到类
 *
 * @since  1.2
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将字节数组转换为Class实例。
 * 在使用Class之前，必须解析Class。
 *
 * &lt;p&gt;此方法为新定义的类分配了默认的ProtectionDomain。
 * 该ProtectionDomain实际上被授予与调用Policy.getPolicy().getPermissions(new CodeSource(null, null))时返回的权限集相同的权限。
 * 默认域在第一次调用defineClass方法时创建，并在后续调用中重复使用。
 *
 * &lt;p&gt;要为类分配特定的ProtectionDomain，请使用接受ProtectionDomain作为其参数之一的defineClass方法。
 *
 * @param  name
 *         类的预期二进制名称，如果未知则为null
 *
 * @param  b
 *         组成类数据的字节。位于b[off]到b[off+len-1]的位置的字节应该具有由Java虚拟机规范定义的有效类文件格式。
 *
 * @param  off
 *         类数据在b中的起始偏移量
 *
 * @param  len
 *         类数据的长度
 *
 * @return  从指定的类数据创建的Class对象
 *
 * @throws  ClassFormatError
 *          如果数据不包含有效的类
 *
 * @throws  IndexOutOfBoundsException
 *          如果off或len为负数，或者off+len大于b.length
 *
 * @throws  SecurityException
 *          如果尝试将此类添加到包中，该包包含了与此类不同的一组证书签名的类，
 *          或者如果尝试在完全限定名称以“java.”开头的包中定义类。
 *
 * @see  #loadClass(String, boolean)
 * @see  #resolveClass(Class)
 *
 * @deprecated  使用defineClass(String, byte[], int, int)方法替代
 */</span>
<span class="token annotation punctuation">@Deprecated</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassFormatError</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将字节数组转换为Class实例。
 * 在使用Class之前，必须解析Class。
 *
 * &lt;p&gt;此方法为新定义的类分配了默认的ProtectionDomain。
 * 该ProtectionDomain实际上被授予与调用Policy.getPolicy().getPermissions(new CodeSource(null, null))时返回的权限集相同的权限。
 * 默认域在第一次调用defineClass方法时创建，并在后续调用中重复使用。
 *
 * @param  name
 *         类的预期二进制名称，如果未知则为null
 *
 * @param  b
 *         组成类数据的字节。位于b[off]到b[off+len-1]的位置的字节应该具有由Java虚拟机规范定义的有效类文件格式。
 *
 * @param  off
 *         类数据在b中的起始偏移量
 *
 * @param  len
 *         类数据的长度
 *
 * @return  从指定的类数据创建的Class对象
 *
 * @throws  ClassFormatError
 *          如果数据不包含有效的类
 *
 * @throws  IndexOutOfBoundsException
 *          如果off或len为负数，或者off+len大于b.length
 *
 * @throws  SecurityException
 *          如果尝试将此类添加到包中，该包包含了与此类不同的一组证书签名的类，
 *          或者如果尝试在完全限定名称以“java.”开头的包中定义类。
 *
 * @see  #loadClass(String, boolean)
 * @see  #resolveClass(Class)
 * @see  java.security.CodeSource
 * @see  java.security.SecureClassLoader
 *
 * @since  1.1
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassFormatError</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 确定保护域，并检查：</span>
<span class="token comment">// - 不定义java.*类，</span>
<span class="token comment">// - 此类的签名者与包中其他类的签名者匹配。</span>
<span class="token keyword">private</span> <span class="token class-name">ProtectionDomain</span> <span class="token function">preDefineClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span>
                                        <span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoClassDefFoundError</span><span class="token punctuation">(</span><span class="token string">"IllegalName: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 注意：java.lang.invoke.MemberName.checkForTypeAlias中的检查逻辑依赖于以下事实：如果一个类具有"java.*"形式的名称，则无法伪造该类。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"java."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span>
            <span class="token punctuation">(</span><span class="token string">"Prohibited package name: "</span> <span class="token operator">+</span>
             name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pd <span class="token operator">=</span> defaultDomain<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token function">checkCerts</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pd<span class="token punctuation">.</span><span class="token function">getCodeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">defineClassSourceLocation</span><span class="token punctuation">(</span><span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">CodeSource</span> cs <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">getCodeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cs<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        source <span class="token operator">=</span> cs<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postDefineClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pd<span class="token punctuation">.</span><span class="token function">getCodeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Certificate</span> certs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span><span class="token function">getCodeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>certs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">setSigners</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> certs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将字节数组转换为&lt;tt&gt;Class&lt;/tt&gt;类的实例，可以附加&lt;tt&gt;ProtectionDomain&lt;/tt&gt;。
 * 如果域为&lt;tt&gt;null&lt;/tt&gt;，则将为该类分配一个默认的域，如{@link #defineClass(String, byte[], int, int)}中所述。
 * 在使用该类之前，必须对其进行解析。
 *
 * &lt;p&gt;在一个包中定义的第一个类决定了该包中所有后续定义的类必须包含的确切证书集合。
 * 类的证书集合是从类的&lt;tt&gt;ProtectionDomain&lt;/tt&gt;中的{@link java.security.CodeSource &lt;tt&gt;CodeSource&lt;/tt&gt;}获得的。
 * 添加到该包中的任何类都必须包含相同的证书集合，否则将抛出&lt;tt&gt;SecurityException&lt;/tt&gt;异常。
 * 注意，如果&lt;tt&gt;name&lt;/tt&gt;为&lt;tt&gt;null&lt;/tt&gt;，则不执行此检查。
 * 您应始终传递要定义的类的&lt;a href="#name"&gt;二进制名称&lt;/a&gt;以及字节。
 * 这样可以确保要定义的类确实是您认为的那个类。
 *
 * &lt;p&gt;指定的&lt;tt&gt;name&lt;/tt&gt;不能以“&lt;tt&gt;java.&lt;/tt&gt;”开头，因为“&lt;tt&gt;java.*&lt;/tt&gt;”包中的所有类只能由引导类加载器定义。
 * 如果&lt;tt&gt;name&lt;/tt&gt;不是&lt;tt&gt;null&lt;/tt&gt;，则它必须等于通过字节数组“&lt;tt&gt;b&lt;/tt&gt;”指定的类的&lt;a href="#name"&gt;二进制名称&lt;/a&gt;，否则将抛出{@link NoClassDefFoundError &lt;tt&gt;NoClassDefFoundError&lt;/tt&gt;}异常。
 *
 * @param  name
 *         类的期望&lt;a href="#name"&gt;二进制名称&lt;/a&gt;，如果未知，则为&lt;tt&gt;null&lt;/tt&gt;
 *
 * @param  b
 *         组成类数据的字节数组。从位置&lt;tt&gt;off&lt;/tt&gt;到&lt;tt&gt;off+len-1&lt;/tt&gt;的字节应具有有效类文件的格式，如&lt;cite&gt;Java&amp;trade;虚拟机规范&lt;/cite&gt;中所定义。
 *
 * @param  off
 *         类数据在&lt;tt&gt;b&lt;/tt&gt;中的起始偏移量
 *
 * @param  len
 *         类数据的长度
 *
 * @param  protectionDomain
 *         类的ProtectionDomain
 *
 * @return  从数据创建的&lt;tt&gt;Class&lt;/tt&gt;对象和可选的&lt;tt&gt;ProtectionDomain&lt;/tt&gt;
 *
 * @throws  ClassFormatError
 *          如果数据不包含有效的类
 *
 * @throws  NoClassDefFoundError
 *          如果&lt;tt&gt;name&lt;/tt&gt;不等于&lt;tt&gt;b&lt;/tt&gt;指定的类的&lt;a href="#name"&gt;二进制名称&lt;/a&gt;
 *
 * @throws  IndexOutOfBoundsException
 *          如果&lt;tt&gt;off&lt;/tt&gt;或&lt;tt&gt;len&lt;/tt&gt;为负数，或者&lt;tt&gt;off+len&lt;/tt&gt;大于&lt;tt&gt;b.length&lt;/tt&gt;
 *
 * @throws  SecurityException
 *          如果尝试将此类添加到包中，该包包含由与此类不同的证书集签名的类，或者如果&lt;tt&gt;name&lt;/tt&gt;以“&lt;tt&gt;java.&lt;/tt&gt;”开头
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
                                     <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassFormatError</span>
<span class="token punctuation">{<!-- --></span>
    protectionDomain <span class="token operator">=</span> <span class="token function">preDefineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token function">defineClassSourceLocation</span><span class="token punctuation">(</span>protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">defineClass1</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postDefineClass</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将{@link java.nio.ByteBuffer &lt;tt&gt;ByteBuffer&lt;/tt&gt;}转换为&lt;tt&gt;Class&lt;/tt&gt;类的实例，可以附加&lt;tt&gt;ProtectionDomain&lt;/tt&gt;。
 * 如果域为&lt;tt&gt;null&lt;/tt&gt;，则将为该类分配一个默认的域，如{@link #defineClass(String, byte[], int, int)}中所述。
 * 在使用该类之前，必须对其进行解析。
 *
 * &lt;p&gt;关于在包中定义的第一个类确定包的证书集合的规则以及类名的限制与{@link #defineClass(String, byte[], int, int, ProtectionDomain)}中的文档中指定的相同。
 *
 * &lt;p&gt;以&lt;i&gt;cl&lt;/i&gt;&lt;tt&gt;.defineClass(&lt;/tt&gt;&lt;i&gt;name&lt;/i&gt;&lt;tt&gt;,&lt;/tt&gt;
 * &lt;i&gt;bBuffer&lt;/i&gt;&lt;tt&gt;,&lt;/tt&gt; &lt;i&gt;pd&lt;/i&gt;&lt;tt&gt;)&lt;/tt&gt;形式调用此方法将产生与以下语句完全相同的结果
 *
 *&lt;p&gt; &lt;tt&gt;
 * ...&lt;br&gt;
 * byte[] temp = new byte[bBuffer.{@link
 * java.nio.ByteBuffer#remaining remaining}()];&lt;br&gt;
 *     bBuffer.{@link java.nio.ByteBuffer#get(byte[])
 * get}(temp);&lt;br&gt;
 *     return {@link #defineClass(String, byte[], int, int, ProtectionDomain)
 * cl.defineClass}(name, temp, 0,
 * temp.length, pd);&lt;br&gt;
 * &lt;/tt&gt;&lt;/p&gt;
 *
 * @param  name
 *         类的期望&lt;a href="#name"&gt;二进制名称&lt;/a&gt;，如果未知，则为&lt;tt&gt;null&lt;/tt&gt;
 *
 * @param  b
 *         组成类数据的字节数组。从位置&lt;tt&gt;b.position()&lt;/tt&gt;到&lt;tt&gt;b.position() + b.limit() -1&lt;/tt&gt;的字节应具有有效类文件的格式，如&lt;cite&gt;Java&amp;trade;虚拟机规范&lt;/cite&gt;中所定义。
 *
 * @param  protectionDomain
 *         类的ProtectionDomain，或&lt;tt&gt;null&lt;/tt&gt;
 *
 * @return  从数据创建的&lt;tt&gt;Class&lt;/tt&gt;对象和可选的&lt;tt&gt;ProtectionDomain&lt;/tt&gt;
 *
 * @throws  ClassFormatError
 *          如果数据不包含有效的类
 *
 * @throws  NoClassDefFoundError
 *          如果&lt;tt&gt;name&lt;/tt&gt;不等于&lt;tt&gt;b&lt;/tt&gt;指定的类的&lt;a href="#name"&gt;二进制名称&lt;/a&gt;
 *
 * @throws  SecurityException
 *          如果尝试将此类添加到包中，该包包含由与此类不同的证书集签名的类，或者如果&lt;tt&gt;name&lt;/tt&gt;以“&lt;tt&gt;java.&lt;/tt&gt;”开头
 *
 * @see      #defineClass(String, byte[], int, int, ProtectionDomain)
 *
 * @since  1.5
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span>ByteBuffer</span> b<span class="token punctuation">,</span>
                                     <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassFormatError</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果不是直接的ByteBufer，则使用byte[]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">hasArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               b<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span>
                               protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 没有数组或只读数组</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 从字节缓冲区中获取字节。</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> tb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    protectionDomain <span class="token operator">=</span> <span class="token function">preDefineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token function">defineClassSourceLocation</span><span class="token punctuation">(</span>protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">defineClass2</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> b<span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postDefineClass</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> protectionDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass0</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
                                     <span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass1</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
                                     <span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">,</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">defineClass2</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span>ByteBuffer</span> b<span class="token punctuation">,</span>
                                     <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> pd<span class="token punctuation">,</span>
                                     <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果名称为null或潜在是有效的二进制名称，则为true</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">VM</span><span class="token punctuation">.</span><span class="token function">allowArraySyntax</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'['</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkCerts</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">CodeSource</span> cs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> pname <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> certs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        certs <span class="token operator">=</span> cs<span class="token punctuation">.</span><span class="token function">getCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pcerts <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parallelLockMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pcerts <span class="token operator">=</span> package2certs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pcerts <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                package2certs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pname<span class="token punctuation">,</span> <span class="token punctuation">(</span>certs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> nocerts<span class="token operator">:</span>certs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        pcerts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>package2certs<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">putIfAbsent</span><span class="token punctuation">(</span>pname<span class="token punctuation">,</span> <span class="token punctuation">(</span>certs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> nocerts<span class="token operator">:</span>certs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pcerts <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compareCerts</span><span class="token punctuation">(</span>pcerts<span class="token punctuation">,</span> certs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">"class \""</span><span class="token operator">+</span> name <span class="token operator">+</span>
             <span class="token string">"\"'s signer information does not match signer information of other classes in the same package"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 检查新类（certs）的证书是否与包中第一个插入的类（pcerts）的证书相同。
 */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">compareCerts</span><span class="token punctuation">(</span><span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pcerts<span class="token punctuation">,</span>
                             <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span> certs<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 证书可以为null，表示没有证书。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>certs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>certs<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> pcerts<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 此时长度必须相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>certs<span class="token punctuation">.</span>length <span class="token operator">!=</span> pcerts<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查一个数组中的所有证书是否都在另一个数组中，并反之亦然。</span>
    <span class="token keyword">boolean</span> match<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> certs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        match <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> pcerts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>certs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pcerts<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                match <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 现在对于pcerts执行相同的操作</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pcerts<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        match <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> certs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pcerts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>certs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                match <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 链接指定的类。这个（误导性命名的）方法可以被类加载器用来链接一个类。
 * 如果类&lt;c&gt;已经被链接，那么这个方法只是简单地返回。否则，该类将按照&lt;c&gt;中的“执行”章节中所述进行链接。
 *
 * @param  c
 *         要链接的类
 *
 * @throws  NullPointerException
 *          如果&lt;c&gt;是&lt;tt&gt;null&lt;/tt&gt;
 *
 * @see  #defineClass(String, byte[], int, int)
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">resolveClass0</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">resolveClass0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 查找具有指定&lt;a href="#name"&gt;二进制名称&lt;/a&gt;的类，如果需要加载它。
     *
     * &lt;p&gt;该方法通过系统类加载器（参见{@link #getSystemClassLoader()}）加载类。返回的&lt;tt&gt;Class&lt;/tt&gt;对象可能与一个以上的&lt;tt&gt;ClassLoader&lt;/tt&gt;关联。
     * &lt;tt&gt;ClassLoader&lt;/tt&gt;的子类通常不需要调用此方法，因为大多数类加载器只需覆盖{@link #findClass(String)}。&lt;/p&gt;
     *
     * @param  name
     *         类的&lt;a href="#name"&gt;二进制名称&lt;/a&gt;
     *
     * @return  指定&lt;tt&gt;name&lt;/tt&gt;的&lt;tt&gt;Class&lt;/tt&gt;对象
     *
     * @throws  ClassNotFoundException
     *          如果找不到类
     *
     * @see  #ClassLoader(ClassLoader)
     * @see  #getParent()
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSystemClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ClassLoader</span> system <span class="token operator">=</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>system <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cls <span class="token operator">=</span> <span class="token function">findBootstrapClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cls <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> cls<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> system<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回由引导类加载器加载的类；如果未找到，则返回null。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">findBootstrapClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果未找到，则返回null</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findBootstrapClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 如果Java虚拟机将其记录为具有该&lt;a href="#name"&gt;二进制名称&lt;/a&gt;的类的启动加载器的初始化加载器，则返回具有给定&lt;a href="#name"&gt;二进制名称&lt;/a&gt;的类。
     * 否则，返回&lt;tt&gt;null&lt;/tt&gt;。
     *
     * @param  name
     *         类的&lt;a href="#name"&gt;二进制名称&lt;/a&gt;
     *
     * @return  &lt;tt&gt;Class&lt;/tt&gt;对象，如果未加载类则返回&lt;tt&gt;null&lt;/tt&gt;
     *
     * @since  1.1
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">findLoadedClass0</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findLoadedClass0</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 设置类的签名者。在定义类后应调用此方法。
     *
     * @param  c
     *         &lt;tt&gt;Class&lt;/tt&gt;对象
     *
     * @param  signers
     *         类的签名者
     *
     * @since  1.1
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setSigners</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> signers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">setSigners</span><span class="token punctuation">(</span>signers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// -- 资源 --</span>

    <span class="token comment">/**
     * 查找具有给定名称的资源。资源是一些数据（图像、音频、文本等），可以由类代码以与代码位置无关的方式访问。
     *
     * &lt;p&gt;资源的名称是一个'/'分隔的路径名，用于标识资源。&lt;/p&gt;
     *
     * &lt;p&gt;此方法首先搜索父类加载器中的资源；如果父级为&lt;tt&gt;null&lt;/tt&gt;，则搜索内置于虚拟机中的类加载器的路径。如果找不到资源，则该方法将调用{@link #findResource(String)}来查找资源。&lt;/p&gt;
     *
     * @apiNote 当重写此方法时，建议实现确保任何委托与{@link #getResources(java.lang.String) getResources(String)}方法一致。
     *
     * @param  name
     *         资源名称
     *
     * @return 用于读取资源的&lt;tt&gt;URL&lt;/tt&gt;对象，如果找不到资源或调用者没有足够的权限获取资源，则返回&lt;tt&gt;null&lt;/tt&gt;
     *
     * @since  1.1
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">URL</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">URL</span> url<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            url <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            url <span class="token operator">=</span> <span class="token function">getBootstrapResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            url <span class="token operator">=</span> <span class="token function">findResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查找具有给定名称的所有资源。资源是一些数据（图像、音频、文本等），可以由类代码以与代码位置无关的方式访问。
     *
     * &lt;p&gt;资源的名称是一个'/'分隔的路径名，用于标识资源。&lt;/p&gt;
     *
     * &lt;p&gt;搜索顺序在{@link #getResource(String)}的文档中描述。&lt;/p&gt;
     *
     * @param  name
     *         资源名称
     *
     * @return 资源的{@link java.net.URL &lt;tt&gt;URL&lt;/tt&gt;}对象的枚举。如果找不到资源，则枚举为空。类加载器无法访问的资源将不在枚举中。
     *
     * @throws  IOException
     *          如果发生I/O错误

     * @since  1.2
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tmp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getBootstrapResources</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tmp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">findResources</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompoundEnumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查找具有给定名称的资源。类加载器实现应覆盖此方法以指定资源的查找位置。
     *
     * @param  name
     *         资源名称
     *
     * @return 用于读取资源的&lt;tt&gt;URL&lt;/tt&gt;对象，如果找不到资源则返回&lt;tt&gt;null&lt;/tt&gt;
     *
     * @since  1.2
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">URL</span> <span class="token function">findResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 返回表示具有给定名称的所有资源的{@link java.net.URL &lt;tt&gt;URL&lt;/tt&gt;}对象的枚举。类加载器实现应覆盖此方法以指定从何处加载资源。
     *
     * @param  name
     *         资源名称
     *
     * @return 用于资源的{@link java.net.URL &lt;tt&gt;URL&lt;/tt&gt;}对象的枚举
     *
     * @throws  IOException
     *          如果发生I/O错误
     *
     * @since  1.2
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token function">findResources</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Collections</span><span class="token punctuation">.</span><span class="token function">emptyEnumeration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将调用者注册为并行可用。
     * 当且仅当满足以下所有条件时，注册才成功：
     * &lt;ol&gt;
     * &lt;li&gt; 调用者的任何实例尚未创建&lt;/li&gt;
     * &lt;li&gt; 调用者的所有超类（除了Object类）都已注册为并行可用&lt;/li&gt;
     * &lt;/ol&gt;
     * &lt;p&gt;请注意，一旦将类加载器注册为并行可用，就无法更改它。&lt;/p&gt;
     *
     * @return  如果成功将调用者注册为并行可用，则返回true；否则返回false。
     *
     * @since   1.7
     */</span>
    <span class="token annotation punctuation">@CallerSensitive</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">registerAsParallelCapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span> callerClass <span class="token operator">=</span>
            <span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ParallelLoaders</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>callerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从用于加载类的搜索路径中查找具有指定名称的资源。此方法通过系统类加载器（参见{@link #getSystemClassLoader()}）定位资源。
     *
     * @param  name
     *         资源名称
     *
     * @return 用于读取资源的{@link java.net.URL &lt;tt&gt;URL&lt;/tt&gt;}对象，如果找不到资源则返回&lt;tt&gt;null&lt;/tt&gt;
     *
     * @since  1.1
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">URL</span> <span class="token function">getSystemResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ClassLoader</span> system <span class="token operator">=</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>system <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getBootstrapResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> system<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从用于加载类的搜索路径中查找具有指定名称的所有资源。找到的资源将作为{@link java.util.Enumeration &lt;tt&gt;Enumeration&lt;/tt&gt;}的{@link java.net.URL &lt;tt&gt;URL&lt;/tt&gt;}对象返回。
     *
     * &lt;p&gt;搜索顺序在{@link #getSystemResource(String)}的文档中描述。&lt;/p&gt;
     *
     * @param  name
     *         资源名称
     *
     * @return 资源{@link java.net.URL &lt;tt&gt;URL&lt;/tt&gt;}对象的枚举
     *
     * @throws  IOException
     *          如果发生I/O错误

     * @since  1.2
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token function">getSystemResources</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ClassLoader</span> system <span class="token operator">=</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>system <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">getBootstrapResources</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> system<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从VM的内置类加载器中查找资源。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">URL</span> <span class="token function">getBootstrapResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">URLClassPath</span> ucp <span class="token operator">=</span> <span class="token function">getBootstrapClassPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> res <span class="token operator">=</span> ucp<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> res<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从VM的内置类加载器中查找资源。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token function">getBootstrapResources</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Resource</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span>
            <span class="token function">getBootstrapClassPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">public</span> <span class="token class-name">URL</span> <span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回用于查找系统资源的URLClassPath。</span>
    <span class="token keyword">static</span> <span class="token class-name">URLClassPath</span> <span class="token function">getBootstrapClassPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Launcher</span><span class="token punctuation">.</span><span class="token function">getBootstrapClassPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 返回用于读取指定资源的输入流。
     *
     * &lt;p&gt;搜索顺序在{@link #getResource(String)}的文档中描述。&lt;/p&gt;
     *
     * @param  name
     *         资源名称
     *
     * @return 用于读取资源的输入流，如果找不到资源则返回&lt;tt&gt;null&lt;/tt&gt;
     *
     * @since  1.1
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token function">getResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 打开以读取类加载器用于加载类的搜索路径中具有指定名称的资源。此方法通过系统类加载器（参见{@link #getSystemClassLoader()}）定位资源。
     *
     * @param  name
     *         资源名称
     *
     * @return 用于读取资源的输入流，如果找不到资源则返回&lt;tt&gt;null&lt;/tt&gt;
     *
     * @since  1.1
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">InputStream</span> <span class="token function">getSystemResourceAsStream</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token function">getSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// -- 层次结构 --</span>

    <span class="token comment">/**
     * 返回用于委托的父类加载器。某些实现可能使用&lt;tt&gt;null&lt;/tt&gt;表示引导类加载器。如果此类加载器的父级是引导类加载器，则在此类加载器中，此方法将返回&lt;tt&gt;null&lt;/tt&gt;。
     *
     * &lt;p&gt;如果存在安全管理器，并且调用者的类加载器不是&lt;tt&gt;null&lt;/tt&gt;并且不是此类加载器的祖先，则此方法将使用{@link
     * SecurityManager#checkPermission(java.security.Permission)
     * &lt;tt&gt;checkPermission&lt;/tt&gt;}方法调用安全管理器的以&lt;tt&gt;RuntimePermission("getClassLoader")&lt;/tt&gt;权限验证对父类加载器的访问是否被允许。否则，将抛出&lt;tt&gt;SecurityException&lt;/tt&gt;。&lt;/p&gt;
     *
     * @return  父级&lt;tt&gt;ClassLoader&lt;/tt&gt;
     *
     * @throws  SecurityException
     *          如果存在安全管理器并且其&lt;tt&gt;checkPermission&lt;/tt&gt;方法不允许对此类加载器的父类加载器的访问。
     *
     * @since  1.2
     */</span>
    <span class="token annotation punctuation">@CallerSensitive</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 检查对父类加载器的访问权限</span>
            <span class="token comment">// 如果调用者的类加载器与此类加载器相同，则进行权限检查。</span>
            <span class="token function">checkClassLoaderPermission</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回用于委派的系统类加载器。这是新的ClassLoader实例的默认委派父级，并且通常是启动应用程序时使用的类加载器。
 *
 * &lt;p&gt;此方法在运行时的早期启动序列中首先调用，此时它创建系统类加载器并将其设置为调用线程的上下文类加载器。
 *
 * &lt;p&gt;默认的系统类加载器是此类的特定实现。
 *
 * &lt;p&gt;如果在首次调用此方法时定义了系统属性“java.system.class.loader”，则该属性的值将作为系统类加载器返回。该类使用默认的系统类加载器进行加载，并且必须定义一个以类型为ClassLoader的单个参数的公共构造函数，该参数用作委派父级。然后使用默认的系统类加载器作为参数使用此构造函数创建一个实例。生成的类加载器被定义为系统类加载器。
 *
 * &lt;p&gt;如果存在安全管理器，并且调用者的类加载器不为null且调用者的类加载器与系统类加载器不同且不是系统类加载器的祖先，则此方法将使用SecurityManager的{@link SecurityManager＃checkPermission（java.security.Permission）&lt;tt&gt; checkPermission &lt;/ tt&gt;}方法以{@link RuntimePermission＃RuntimePermission（String）&lt;tt&gt; RuntimePermission（ "getClassLoader"）&lt;/tt&gt;}权限验证对系统类加载器的访问权限。否则，将抛出SecurityException。&lt;/p&gt;
 *
 * @return 委派的系统&lt;tt&gt; ClassLoader &lt;/ tt&gt;，如果没有则为&lt;tt&gt; null &lt;/ tt&gt;
 *
 * @throws SecurityException 如果存在安全管理器，并且其&lt;tt&gt; checkPermission &lt;/ tt&gt;方法不允许访问系统类加载器。
 *
 * @throws IllegalStateException 如果在由“java.system.class.loader”属性指定的类加载器的构造过程中递归调用
 *
 * @throws Error 如果定义了系统属性“java.system.class.loader”，但无法加载命名类，提供程序类未定义所需构造函数或在调用该构造函数时引发异常。可以通过{@link Throwable＃getCause（）}方法检索错误的根本原因。
 *
 * @revised 1.4
 */</span>
<span class="token annotation punctuation">@CallerSensitive</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">initSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">checkClassLoaderPermission</span><span class="token punctuation">(</span>scl<span class="token punctuation">,</span> <span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> scl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">initSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sclSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"recursive invocation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Launcher</span> l <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Launcher</span><span class="token punctuation">.</span><span class="token function">getLauncher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Throwable</span> oops <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            scl <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                scl <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">SystemClassLoaderAction</span><span class="token punctuation">(</span>scl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> pae<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                oops <span class="token operator">=</span> pae<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oops <span class="token keyword">instanceof</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    oops <span class="token operator">=</span> oops<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oops <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oops <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span> oops<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// wrap the exception</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>oops<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        sclSet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果在此类加载器的委派链中找到指定的类加载器，则返回true。</span>
<span class="token keyword">boolean</span> <span class="token function">isAncestor</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> cl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ClassLoader</span> acl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        acl <span class="token operator">=</span> acl<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cl <span class="token operator">==</span> acl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>acl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试类加载器访问是否需要“getClassLoader”权限检查。如果类加载器'from'可以访问类加载器'to'，则类加载器'from'与类加载器'to'相同或者是'to'的祖先。系统域中的类加载器可以访问任何类加载器。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">needsClassLoaderPermissionCheck</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> from<span class="token punctuation">,</span>
                                                       <span class="token class-name">ClassLoader</span> <span class="token keyword">to</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">==</span> <span class="token keyword">to</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">isAncestor</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回类的类加载器，如果没有则返回null。</span>
<span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> caller<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果VM请求该项，则这个值可能为null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 由于这是包私有的，所以绕过安全检查</span>
    <span class="token keyword">return</span> caller<span class="token punctuation">.</span><span class="token function">getClassLoader0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 检查RuntimePermission（“getClassLoader”）权限
 * 如果调用者的类加载器不为null且调用者的类加载器与给定的cl参数不同且不是相同的或给定的cl参数的祖先。
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkClassLoaderPermission</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> cl<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> caller<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果VM请求该项，则调用者可能为空</span>
        <span class="token class-name">ClassLoader</span> ccl <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needsClassLoaderPermissionCheck</span><span class="token punctuation">(</span>ccl<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sm<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">GET_CLASSLOADER_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 系统的类加载器</span>
<span class="token comment">// @GuardedBy（“ClassLoader.class”）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> scl<span class="token punctuation">;</span>

<span class="token comment">// 设置为true一旦设置了系统类加载器</span>
<span class="token comment">// @GuardedBy（“ClassLoader.class”）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> sclSet<span class="token punctuation">;</span>


<span class="token comment">// -- Package --</span>

<span class="token comment">/**
 * 在此&lt;tt&gt; ClassLoader &lt;/ tt&gt;中按名称定义包。这允许类加载器为其类定义包。必须在定义类之前创建包，并且包名在类加载器中必须是唯一的，一旦创建就无法重新定义或更改。
 *
 * @param name 包名
 *
 * @param specTitle 规范标题
 *
 * @param specVersion 规范版本
 *
 * @param specVendor 规范供应商
 *
 * @param implTitle 实现标题
 *
 * @param implVersion 实现版本
 *
 * @param implVendor 实现供应商
 *
 * @param sealBase 如果不是null，则此包使用与给定代码源{@link java.net.URL &lt;tt&gt; URL &lt;/ tt&gt;}对象相关联的封闭基础库。否则，该包未封装。
 *
 * @return 新定义的&lt;tt&gt; Package &lt;/ tt&gt;对象
 *
 * @throws IllegalArgumentException 如果包名与此类加载器或其祖先之一中的现有包重复
 *
 * @since 1.2
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Package</span> <span class="token function">definePackage</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> specTitle<span class="token punctuation">,</span>
                                <span class="token class-name">String</span> specVersion<span class="token punctuation">,</span> <span class="token class-name">String</span> specVendor<span class="token punctuation">,</span>
                                <span class="token class-name">String</span> implTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> implVersion<span class="token punctuation">,</span>
                                <span class="token class-name">String</span> implVendor<span class="token punctuation">,</span> <span class="token class-name">URL</span> sealBase<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>packages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Package</span> pkg <span class="token operator">=</span> <span class="token function">getPackage</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pkg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> specTitle<span class="token punctuation">,</span> specVersion<span class="token punctuation">,</span> specVendor<span class="token punctuation">,</span>
                          implTitle<span class="token punctuation">,</span> implVersion<span class="token punctuation">,</span> implVendor<span class="token punctuation">,</span>
                          sealBase<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        packages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回由此类加载器或任何其祖先定义的&lt;tt&gt; Package &lt;/ tt&gt;。
 *
 * @param name 包名
 *
 * @return 对应于给定名称的&lt;tt&gt; Package &lt;/ tt&gt;，如果未找到则为&lt;tt&gt; null &lt;/ tt&gt;
 *
 * @since 1.2
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Package</span> <span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Package</span> pkg<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>packages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pkg <span class="token operator">=</span> packages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pkg <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            pkg <span class="token operator">=</span> <span class="token class-name">Package</span><span class="token punctuation">.</span><span class="token function">getSystemPackage</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>packages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Package</span> pkg2 <span class="token operator">=</span> packages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg2 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    packages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> pkg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    pkg <span class="token operator">=</span> pkg2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pkg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 返回由此类加载器及其祖先定义的所有&lt;tt&gt; Package &lt;/ tt&gt;。
 *
 * @return 由此&lt;tt&gt; ClassLoader &lt;/ tt&gt;定义的&lt;tt&gt; Package &lt;/ tt&gt;对象数组
 *
 * @since 1.2
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Package</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Package</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>packages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Package</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pkgs<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pkgs <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        pkgs <span class="token operator">=</span> <span class="token class-name">Package</span><span class="token punctuation">.</span><span class="token function">getSystemPackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pkgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> pkgName <span class="token operator">=</span> pkgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pkgName<span class="token punctuation">,</span> pkgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Package</span><span class="token punctuation">[</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// -- Native library access --</span>

<span class="token comment">/**
 * 返回本地库的绝对路径名。VM调用此方法来定位属于使用此类加载器加载的类的本地库。如果此方法返回&lt;tt&gt; null &lt;/ tt&gt;，则VM将沿着指定为“&lt;tt&gt; java.library.path &lt;/ tt&gt;”属性的路径搜索库。
 *
 * @param libname 库名称
 *
 * @return 本地库的绝对路径
 *
 * @see System＃loadLibrary（String）
 * @see System＃mapLibraryName（String）
 *
 * @since 1.2
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">findLibrary</span><span class="token punctuation">(</span><span class="token class-name">String</span> libname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * NativeLibrary内部类表示已加载的本地库实例。
 * 每个类加载器都包含一个加载的本地库向量，存储在private字段&lt;tt&gt;nativeLibraries&lt;/tt&gt;中。系统加载的本地库被输入到&lt;tt&gt;systemNativeLibraries&lt;/tt&gt;向量中。
 *
 * &lt;p&gt;每个本地库都需要特定版本的JNI。这由私有字段&lt;tt&gt;jniVersion&lt;/tt&gt;表示。VM在加载库时设置此字段，并且VM使用它将正确的JNI版本传递给本地方法。&lt;/p&gt;
 *
 * @see      ClassLoader
 * @since    1.2
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">NativeLibrary</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 本地代码中使用的不透明句柄。</span>
    <span class="token keyword">long</span> handle<span class="token punctuation">;</span>
    <span class="token comment">// 本地库所需的JNI环境版本。</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> jniVersion<span class="token punctuation">;</span>
    <span class="token comment">// 加载库的类，也指示该本地库所属的加载器。</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fromClass<span class="token punctuation">;</span>
    <span class="token comment">// 本地库的规范名称或静态库名称。</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 指示本地库是否链接到VM中。</span>
    <span class="token keyword">boolean</span> isBuiltin<span class="token punctuation">;</span>
    <span class="token comment">// 指示本地库是否已加载。</span>
    <span class="token keyword">boolean</span> loaded<span class="token punctuation">;</span>
    <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBuiltin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">unload</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBuiltin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">NativeLibrary</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fromClass<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBuiltin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fromClass <span class="token operator">=</span> fromClass<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isBuiltin <span class="token operator">=</span> isBuiltin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>loadedLibraryNames<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fromClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> loaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* remove the native library name */</span>
                <span class="token keyword">int</span> size <span class="token operator">=</span> loadedLibraryNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loadedLibraryNames<span class="token punctuation">.</span><span class="token function">elementAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        loadedLibraryNames<span class="token punctuation">.</span><span class="token function">removeElementAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/* unload the library. */</span>
                <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>nativeLibraryContext<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">unload</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> isBuiltin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>nativeLibraryContext<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在VM中调用以确定JNI_Load / JNI_Unload中的上下文类。</span>
    <span class="token keyword">static</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFromClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>nativeLibraryContext<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fromClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 我们加载的所有本地库名称。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> loadedLibraryNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 属于系统类的本地库。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NativeLibrary</span><span class="token punctuation">&gt;</span></span> systemNativeLibraries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 与类加载器关联的本地库。</span>
<span class="token keyword">private</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NativeLibrary</span><span class="token punctuation">&gt;</span></span> nativeLibraries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 正在加载/卸载的本地库。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NativeLibrary</span><span class="token punctuation">&gt;</span></span> nativeLibraryContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 用于搜索库的路径</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> usr_paths<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> sys_paths<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initializePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> propname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> ldpath <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>propname<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> ps <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span>pathSeparator<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ldlen <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
    <span class="token comment">// 计算路径中的分隔符数</span>
    i <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
        i <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 分配路径数组 - n :'s = n + 1路径元素</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 从ldpath中填充数组</span>
    n <span class="token operator">=</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            paths<span class="token punctuation">[</span>n<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            paths<span class="token punctuation">[</span>n<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        j <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    paths<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> ldpath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> ldlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> paths<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在java.lang.Runtime类中调用以实现load和loadLibrary。</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fromClass<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
                        <span class="token keyword">boolean</span> isAbsolute<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span>
        <span class="token punctuation">(</span>fromClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> fromClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sys_paths <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        usr_paths <span class="token operator">=</span> <span class="token function">initializePath</span><span class="token punctuation">(</span><span class="token string">"java.library.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sys_paths <span class="token operator">=</span> <span class="token function">initializePath</span><span class="token punctuation">(</span><span class="token string">"sun.boot.library.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAbsolute<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span><span class="token string">"Can't load library: "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> libfilename <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">findLibrary</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>libfilename <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">File</span> libfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>libfilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>libfile<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span>
<span class="token string">"ClassLoader.findLibrary failed to return an absolute path: "</span> <span class="token operator">+</span> libfilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> libfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span><span class="token string">"Can't load "</span> <span class="token operator">+</span> libfilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sys_paths<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">File</span> libfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>sys_paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">mapLibraryName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> libfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        libfile <span class="token operator">=</span> <span class="token class-name">ClassLoaderHelper</span><span class="token punctuation">.</span><span class="token function">mapAlternativeName</span><span class="token punctuation">(</span>libfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>libfile <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">loadLibrary0</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> libfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> usr_paths<span class="token punctuation">.</span>length <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">File</span> libfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>usr_paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">mapLibraryName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadLibrary0</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> libfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            libfile <span class="token operator">=</span> <span class="token class-name">ClassLoaderHelper</span><span class="token punctuation">.</span><span class="token function">mapAlternativeName</span><span class="token punctuation">(</span>libfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>libfile <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">loadLibrary0</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> libfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Oops, it failed</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span><span class="token string">"no "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" in java.library.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">findBuiltinLib</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">loadLibrary0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fromClass<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查是否正在尝试访问静态库</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token function">findBuiltinLib</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isBuiltin <span class="token operator">=</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isBuiltin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> exists <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getCanonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span>
        <span class="token punctuation">(</span>fromClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> fromClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NativeLibrary</span><span class="token punctuation">&gt;</span></span> libs <span class="token operator">=</span>
        loader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> loader<span class="token punctuation">.</span>nativeLibraries <span class="token operator">:</span> systemNativeLibraries<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>libs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> libs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">NativeLibrary</span> lib <span class="token operator">=</span> libs<span class="token punctuation">.</span><span class="token function">elementAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>loadedLibraryNames<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loadedLibraryNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span>
                    <span class="token punctuation">(</span><span class="token string">"Native Library "</span> <span class="token operator">+</span>
                     name <span class="token operator">+</span>
                     <span class="token string">" already loaded in another classloader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/* If the library is being loaded (must be by the same thread,
             * because Runtime.load and Runtime.loadLibrary are
             * synchronous). The reason is can occur is that the JNI_OnLoad
             * function can cause another loadLibrary invocation.
             *
             * Thus we can use a static stack to hold the list of libraries
             * we are loading.
             *
             * If there is a pending load operation for the library, we
             * immediately return success; otherwise, we raise
             * UnsatisfiedLinkError.
             */</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> nativeLibraryContext<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">NativeLibrary</span> lib <span class="token operator">=</span> nativeLibraryContext<span class="token punctuation">.</span><span class="token function">elementAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">==</span> lib<span class="token punctuation">.</span>fromClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span>
                            <span class="token punctuation">(</span><span class="token string">"Native Library "</span> <span class="token operator">+</span>
                             name <span class="token operator">+</span>
                             <span class="token string">" is being loaded in another classloader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">NativeLibrary</span> lib <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeLibrary</span><span class="token punctuation">(</span>fromClass<span class="token punctuation">,</span> name<span class="token punctuation">,</span> isBuiltin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nativeLibraryContext<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>lib<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                lib<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> isBuiltin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                nativeLibraryContext<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lib<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                loadedLibraryNames<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                libs<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span>lib<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在VM类链接代码中调用。</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">findNative</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NativeLibrary</span><span class="token punctuation">&gt;</span></span> libs <span class="token operator">=</span>
        loader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> loader<span class="token punctuation">.</span>nativeLibraries <span class="token operator">:</span> systemNativeLibraries<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>libs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> libs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">NativeLibrary</span> lib <span class="token operator">=</span> libs<span class="token punctuation">.</span><span class="token function">elementAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> entry <span class="token operator">=</span> lib<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// -- 断言管理 --</span>

<span class="token keyword">final</span> <span class="token class-name">Object</span> assertionLock<span class="token punctuation">;</span>

<span class="token comment">// 断言检查的默认切换。</span>
<span class="token comment">// @GuardedBy("assertionLock")</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> defaultAssertionStatus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 将String packageName映射到Boolean package默认断言状态。</span>
<span class="token comment">// 注意，默认包被放置在null映射键下。如果此字段为null，则我们将断言状态查询委托给VM，即没有此ClassLoader的断言状态修改方法之一已被调用。</span>
<span class="token comment">// @GuardedBy("assertionLock")</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> packageAssertionStatus <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// 将String fullyQualifiedClassName映射到Boolean assertionStatus。如果此字段为null，则我们将断言状态查询委托给VM，即没有此ClassLoader的断言状态修改方法之一已被调用。</span>
<span class="token comment">// @GuardedBy("assertionLock")</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> classAssertionStatus <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 设置此类加载器的默认断言状态。此设置确定由此类加载器加载并在将来初始化的类是否默认启用或禁用断言。
 * 可以通过调用{@link #setPackageAssertionStatus(String, boolean)}或{@link #setClassAssertionStatus(String, boolean)}来覆盖此设置。
 *
 * @param  enabled
 *         如果由此类加载器加载的类将默认启用断言，则为&lt;tt&gt;true&lt;/tt&gt;，如果它们将默认禁用断言，则为&lt;tt&gt;false&lt;/tt&gt;。
 *
 * @since  1.4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDefaultAssertionStatus</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>assertionLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classAssertionStatus <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">initializeJavaAssertionMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        defaultAssertionStatus <span class="token operator">=</span> enabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 设置指定包的包默认断言状态。包默认断言状态确定将来初始化的属于指定包或其“子包”中的类的断言状态。
 *
 * &lt;p&gt; 名为p的包的子包是任何名称以"&lt;tt&gt;p.&lt;/tt&gt;"开头的包。例如，&lt;tt&gt;javax.swing.text&lt;/tt&gt;是&lt;tt&gt;javax.swing&lt;/tt&gt;的子包，&lt;tt&gt;java.util&lt;/tt&gt;和&lt;tt&gt;java.lang.reflect&lt;/tt&gt;都是&lt;tt&gt;java&lt;/tt&gt;的子包。
 *
 * &lt;p&gt; 如果多个包默认适用于给定类，则与最特定包相关联的包默认优先于其他包。例如，如果&lt;tt&gt;javax.lang&lt;/tt&gt;和&lt;tt&gt;javax.lang.reflect&lt;/tt&gt;都有与之关联的包默认值，则后一个包默认值适用于&lt;tt&gt;javax.lang.reflect&lt;/tt&gt;中的类。
 *
 * &lt;p&gt; 包默认优先于类加载器的默认断言状态，并且可以通过调用{@link #setClassAssertionStatus(String, boolean)}在每个类的基础上进行覆盖。&lt;/p&gt;
 *
 * @param  packageName
 *         要设置其包默认断言状态的包的名称。null值表示未命名的包，即“当前”包(参见&lt;cite&gt;The Java&amp;trade; Language Specification&lt;/cite&gt;第7.4.2节)。
 *
 * @param  enabled
 *         如果由此类加载器加载并且属于指定包或其子包中的类将默认启用断言，则为&lt;tt&gt;true&lt;/tt&gt;；如果它们将默认禁用断言，则为&lt;tt&gt;false&lt;/tt&gt;。
 *
 * @since  1.4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPackageAssertionStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                      <span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>assertionLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageAssertionStatus <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">initializeJavaAssertionMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        packageAssertionStatus<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 设置此类加载器中指定顶级类及其包含的任何嵌套类的所需断言状态。该设置优先于类加载器的默认断言状态和适用的每个包默认值。如果已经初始化了命名类，则此方法无效。(一旦类被初始化，其断言状态就不能更改。)
 *
 * &lt;p&gt; 如果命名类不是顶级类，则此调用对任何类的实际断言状态没有影响。&lt;/p&gt;
 *
 * @param  className
 *         要设置其断言状态的顶级类的完全限定类名。
 *
 * @param  enabled
 *         如果在初始化时启用(如果有的话)，则命名类将启用断言；如果禁用断言，则类将禁用断言。
 *
 * @since  1.4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setClassAssertionStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>assertionLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classAssertionStatus <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">initializeJavaAssertionMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        classAssertionStatus<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将此类加载器的默认断言状态设置为&lt;tt&gt;false&lt;/tt&gt;，并丢弃与类加载器关联的任何包默认或类断言状态设置。
 * 提供此方法是为了使类加载器可以忽略任何命令行或持久的断言状态设置，并“从一个干净的板开始。”
 *
 * @since  1.4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearAssertionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*
     * 不管是否初始化了“Java断言映射”，都将其设置为空映射，从而有效地忽略任何现有设置。
     */</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>assertionLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        classAssertionStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        packageAssertionStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultAssertionStatus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 如果在调用此方法时指定的类被初始化，返回该类将被分配的断言状态。
 * 如果已设置命名类的断言状态，则返回最新的设置；否则，如果任何包默认的断言状态与该类相关，则返回最特定相关包默认断言状态的最新设置；否则，返回此类加载器的默认断言状态。
 *
 * @param  className
 *         正在查询其所需断言状态的类的完全限定类名。
 *
 * @return  指定类的所需断言状态。
 *
 * @since  1.4
 */</span>
<span class="token keyword">boolean</span> <span class="token function">desiredAssertionStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>assertionLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// assert classAssertionStatus   != null;</span>
        <span class="token comment">// assert packageAssertionStatus != null;</span>

        <span class="token comment">// 检查类条目</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> classAssertionStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 检查最具体包条目</span>
        <span class="token keyword">int</span> dotIndex <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dotIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 默认包</span>
            result <span class="token operator">=</span> packageAssertionStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>dotIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> dotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> packageAssertionStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dotIndex <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> dotIndex<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 返回类加载器默认值</span>
        <span class="token keyword">return</span> defaultAssertionStatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用VM提供的信息设置断言。</span>
<span class="token comment">// 注意：只能在同步块内调用</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializeJavaAssertionMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// assert Thread.holdsLock(assertionLock);</span>

    classAssertionStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    packageAssertionStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AssertionStatusDirectives</span> directives <span class="token operator">=</span> <span class="token function">retrieveDirectives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> directives<span class="token punctuation">.</span>classes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        classAssertionStatus<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>directives<span class="token punctuation">.</span>classes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 directives<span class="token punctuation">.</span>classEnabled<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> directives<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        packageAssertionStatus<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>directives<span class="token punctuation">.</span>packages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                   directives<span class="token punctuation">.</span>packageEnabled<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    defaultAssertionStatus <span class="token operator">=</span> directives<span class="token punctuation">.</span>deflt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从VM检索断言指令。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">AssertionStatusDirectives</span> <span class="token function">retrieveDirectives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">SystemClassLoaderAction</span>
    <span class="token keyword">implements</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">;</span>

    <span class="token class-name">SystemClassLoaderAction</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ClassLoader</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> cls <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.system.class.loader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cls <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ctor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> sys <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span> ctor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> parent <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sys<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>dotIndex <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> dotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> packageAssertionStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dotIndex <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> dotIndex<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 返回类加载器默认值</span>
        <span class="token keyword">return</span> defaultAssertionStatus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用VM提供的信息设置断言。</span>
<span class="token comment">// 注意：只能在同步块内调用</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializeJavaAssertionMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// assert Thread.holdsLock(assertionLock);</span>

    classAssertionStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    packageAssertionStatus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AssertionStatusDirectives</span> directives <span class="token operator">=</span> <span class="token function">retrieveDirectives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> directives<span class="token punctuation">.</span>classes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        classAssertionStatus<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>directives<span class="token punctuation">.</span>classes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 directives<span class="token punctuation">.</span>classEnabled<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> directives<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        packageAssertionStatus<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>directives<span class="token punctuation">.</span>packages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                   directives<span class="token punctuation">.</span>packageEnabled<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    defaultAssertionStatus <span class="token operator">=</span> directives<span class="token punctuation">.</span>deflt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从VM检索断言指令。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">AssertionStatusDirectives</span> <span class="token function">retrieveDirectives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">SystemClassLoaderAction</span>
    <span class="token keyword">implements</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassLoader</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">;</span>

    <span class="token class-name">SystemClassLoaderAction</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ClassLoader</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> cls <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.system.class.loader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cls <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ctor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> sys <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span> ctor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> parent <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>sys<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sys<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/19d2041ac1b2b550e794bbb9d866fc5c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据结构】 链表 - 单链表（C语言实现）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5d8875cbca060b0b7fc1fbf90e7cb654/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java获取两个List集合之间的交集、差集、并集</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>