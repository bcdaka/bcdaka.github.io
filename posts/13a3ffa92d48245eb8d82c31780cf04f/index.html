<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Golang Context详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/13a3ffa92d48245eb8d82c31780cf04f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Golang Context详解">
  <meta property="og:description" content="文章目录 基本介绍context源码剖析Context接口emptyCtxcancelCtxtimerCtxvalueCtx context使用案例协程取消超时控制数据共享 基本介绍 基本介绍
在Go 1.7版本中引入了上下文（context）包，用于在并发编程中管理请求范围的数据、控制生命周期、处理取消信号和超时等。context在Go中具有重要的作用，特别是在并发编程和网络编程中，因此context通常会作为各个函数和方法的首个入参。 context源码剖析 Context接口 Context接口
Context是context包中的一个接口类型，该接口提供了对上下文的基本操作和属性的访问方法，其定义如下：
type Context interface { Deadline() (deadline time.Time, ok bool) Done() &lt;-chan struct{} Err() error Value(key any) any } Context接口中各方法说明：
Deadline方法：返回上下文的截止时间。其第一个返回值表示上下文的截止时间，第二个返回值表示上下文是否存在截止时间。Done方法：返回一个只读的channel，用于接收上下文的取消信号。当上下文被取消时，该channel将会被关闭，从而通知使用者上下文已经被取消。Err方法：返回与上下文关联的错误。当上下文被取消时，返回context.Canceled错误，当上下文到达截止时间时，返回context.DeadlineExceeded错误。Value方法：根据指定的键获取上下文中关联的值。如果找到与键相关的值，则返回该值，如果未找到，则返回nil。 说明一下：
Done方法返回的channel的类型是chan struct{}，而空struct中实际无法存储任何数据，因为该channel本就不是用作数据存储的，而是用作传递取消信号的。在context包中，有四个结构体类型实现了Context接口，分别是emptyCtx、cancelCtx、timerCtx和valueCtx。 emptyCtx emptyCtx
emptyCtx是context包中的一个自定义类型，用于表示一个空的上下文，它实现了Context接口，其定义如下：
type emptyCtx int func (*emptyCtx) Deadline() (deadline time.Time, ok bool) { return } func (*emptyCtx) Done() &lt;-chan struct{} { return nil } func (*emptyCtx) Err() error { return nil } func (*emptyCtx) Value(key any) any { return nil } emptyCtx实现的四个方法说明：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-10T20:15:24+08:00">
    <meta property="article:modified_time" content="2024-06-10T20:15:24+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Golang Context详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">基本介绍</a></li><li><a href="#context_8" rel="nofollow">context源码剖析</a></li><li><ul><li><a href="#Context_9" rel="nofollow">Context接口</a></li><li><a href="#emptyCtx_36" rel="nofollow">emptyCtx</a></li><li><a href="#cancelCtx_99" rel="nofollow">cancelCtx</a></li><li><a href="#timerCtx_435" rel="nofollow">timerCtx</a></li><li><a href="#valueCtx_567" rel="nofollow">valueCtx</a></li></ul> 
  </li><li><a href="#context_685" rel="nofollow">context使用案例</a></li><li><ul><li><a href="#_686" rel="nofollow">协程取消</a></li><li><a href="#_754" rel="nofollow">超时控制</a></li><li><a href="#_828" rel="nofollow">数据共享</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>基本介绍</h2> 
<blockquote> 
 <p>基本介绍</p> 
</blockquote> 
<ul><li>在Go 1.7版本中引入了上下文（context）包，用于在并发编程中管理请求范围的数据、控制生命周期、处理取消信号和超时等。</li><li>context在Go中具有重要的作用，特别是在并发编程和网络编程中，因此context通常会作为各个函数和方法的首个入参。</li></ul> 
<h2><a id="context_8"></a>context源码剖析</h2> 
<h3><a id="Context_9"></a>Context接口</h3> 
<blockquote> 
 <p>Context接口</p> 
</blockquote> 
<p>Context是context包中的一个接口类型，该接口提供了对上下文的基本操作和属性的访问方法，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Value</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> any
<span class="token punctuation">}</span>
</code></pre> 
<p>Context接口中各方法说明：</p> 
<ul><li>Deadline方法：返回上下文的截止时间。其第一个返回值表示上下文的截止时间，第二个返回值表示上下文是否存在截止时间。</li><li>Done方法：返回一个只读的channel，用于接收上下文的取消信号。当上下文被取消时，该channel将会被关闭，从而通知使用者上下文已经被取消。</li><li>Err方法：返回与上下文关联的错误。当上下文被取消时，返回context.Canceled错误，当上下文到达截止时间时，返回context.DeadlineExceeded错误。</li><li>Value方法：根据指定的键获取上下文中关联的值。如果找到与键相关的值，则返回该值，如果未找到，则返回nil。</li></ul> 
<p><strong>说明一下：</strong></p> 
<ul><li>Done方法返回的channel的类型是chan struct{}，而空struct中实际无法存储任何数据，因为该channel本就不是用作数据存储的，而是用作传递取消信号的。</li><li>在context包中，有四个结构体类型实现了Context接口，分别是emptyCtx、cancelCtx、timerCtx和valueCtx。</li></ul> 
<h3><a id="emptyCtx_36"></a>emptyCtx</h3> 
<blockquote> 
 <p>emptyCtx</p> 
</blockquote> 
<p>emptyCtx是context包中的一个自定义类型，用于表示一个空的上下文，它实现了Context接口，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> emptyCtx <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> any <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>emptyCtx实现的四个方法说明：</p> 
<ul><li>Deadline方法：由于emptyCtx不具有截止时间，因此Deadline方法直接返回time.Time和bool类型的零值（false），表示当前上下文不存在截止时间。</li><li>Done方法：由于emptyCtx永远不会被取消，因此Done方法直接将nil作为只读的channel进行返回，使得该channel的读取方无法从中读取到任何取消信号。</li><li>Err方法：由于Err方法返回上下文被取消的原因，而emptyCtx永远不会被取消，因此Err方法直接返回nil。</li><li>Value方法：由于emptyCtx中不存储任何键值对，因此Value方法直接返回nil。</li></ul> 
<p>emptyCtx通常作为默认的顶级上下文使用，表示一个空的上下文，其他上下文类型可以在此基础上添加对应的功能，因此context树的根context一定是emptyCtx。示意图如下：</p> 
<p><img src="https://images2.imgbox.com/31/ae/TtxYjTyy_o.png" alt="在这里插入图片描述"></p> 
<p><strong>说明一下：</strong> 除了emptyCtx以外，其他context都是在已有context的基础上创建的。</p> 
<blockquote> 
 <p>创建emptyCtx</p> 
</blockquote> 
<p>通过context包中的Background函数和TODO函数可以创建emptyCtx，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
	background <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
	todo       <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>emptyCtx<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> background
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Context <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> todo
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>说明一下：</strong></p> 
<ul><li>context包中的Background和TODO函数，返回的都是各自全局复用的emptyCtx类型的实例，它们仅仅在语义上稍有不同。</li><li>Background函数返回的emptyCtx通常作为默认的顶级上下文使用，表示一个空的上下文，其他上下文类型可以在此基础上添加对应的功能。TODO函数返回的emptyCtx通常作为临时占位的上下文使用，表示该上下文后期需要替换为其他的上下文，目前先用emptyCtx进行占位。</li></ul> 
<h3><a id="cancelCtx_99"></a>cancelCtx</h3> 
<blockquote> 
 <p>cancelCtx</p> 
</blockquote> 
<p>cancelCtx是context包中的一个结构体类型，用于传播取消信号和管理取消操作，它实现了Context接口，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> cancelCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Context

	mu       sync<span class="token punctuation">.</span>Mutex            <span class="token comment">// protects following fields</span>
	done     atomic<span class="token punctuation">.</span>Value          <span class="token comment">// of chan struct{}, created lazily, closed by first cancel call</span>
	children <span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment">// set to nil by the first cancel call</span>
	err      <span class="token builtin">error</span>                 <span class="token comment">// set to non-nil by the first cancel call</span>
	cause    <span class="token builtin">error</span>                 <span class="token comment">// set to non-nil by the first cancel call</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>cancelCtx结构体各字段说明：</p> 
<ul><li>Context：嵌套的Context接口类型的匿名结构体，表示当前cancelCtx所继承的父上下文。</li><li>mu：互斥锁，用于保护cancelCtx结构体中各个字段的并发访问。</li><li>done：原子值，用于存储通知上下文已取消的channel。</li><li>children：子context集合，用于保存当前context的子context。</li><li>err：用于表示上下文被取消的错误原因。</li><li>cause：用于表示上下文被取消的具体原因。</li></ul> 
<p>children字段的类型为map[canceler]struct{}，这里的map中value的类型为空struct，表示我们只关心children中是否存在某一个key，而并不关心这个key对应的value。而map中key的类型为canceler，这是context包中的一个不可导出的接口类型，用于表示可以被取消的上下文，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> canceler <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> cause <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>canceler接口中各方法说明：</p> 
<ul><li>cancel方法：用于执行上下文的取消操作，其中removeFromParent参数表示是否将当前上下文从其父上下文中移除，err表示取消的错误原因，cause表示取消的具体原因。</li><li>Done方法：返回一个只读的channel，用于接收上下文的取消信号。当上下文被取消时，该channel将会被关闭，从而通知使用者上下文已经被取消。</li></ul> 
<p><strong>说明一下：</strong></p> 
<ul><li>cancelCtx结构体中的children字段在保存当前context的子context时，map中的key没有直接使用Context接口类型，而是使用的canceler接口类型，因为children字段只需要关注上下文的cancel和Done这两个方法。</li><li>通过定义新的接口，将对象中需要关注的能力暴露出来，同时将无关的细节屏蔽掉。这种做法有助于减少错误风险，体现了编程过程中职责内聚和边界分明的思想，同时提高了代码的可读性和可维护性。</li></ul> 
<blockquote> 
 <p>创建cancelCtx</p> 
</blockquote> 
<p>通过context包中的WithCancel函数和WithCancelCause函数可以创建cancelCtx，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> CancelFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">type</span> CancelCauseFunc <span class="token keyword">func</span><span class="token punctuation">(</span>cause <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c <span class="token operator">:=</span> <span class="token function">withCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
	<span class="token comment">// 3、返回创建的cancelCtx和对应的取消回调函数</span>
	<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithCancelCause</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelCauseFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c <span class="token operator">:=</span> <span class="token function">withCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
	<span class="token comment">// 3、返回创建的cancelCtx和对应的取消回调函数</span>
	<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cause <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">,</span> cause<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">withCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token operator">*</span>cancelCtx <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"cannot create context from nil parent"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 1、创建cancelCtx实例，并用parent对其Context字段进行初始化</span>
	c <span class="token operator">:=</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
	<span class="token comment">// 2、将创建的cancelCtx与parent关联起来</span>
	<span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token operator">*</span>cancelCtx <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>cancelCtx<span class="token punctuation">{<!-- --></span>Context<span class="token punctuation">:</span> parent<span class="token punctuation">}</span> <span class="token comment">// 初始化cancelCtx的父context字段</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建cancelCtx的流程如下：</p> 
<ol><li>创建一个cancelCtx实例，并用给定的父context对cancelCtx的Context字段进行初始化。</li><li>调用propagateCancel函数将创建的cancelCtx与其父context关联起来，保证父context被取消时，子context也会被取消。</li><li>返回创建的cancelCtx，同时返回一个闭包函数，闭包函数内部通过调用cancelCtx的cancel方法执行上下文的取消操作。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>WithCancel函数和WithCancelCause函数的区别在于，WithCancelCause函数返回的闭包函数在调用时支持传入cause，在取消上下文时用于设置cancelCtx的cause字段，而WithCancel函数返回的闭包函数在调用时默认cause为nil。</li></ul> 
<blockquote> 
 <p>propagateCancel函数</p> 
</blockquote> 
<p>propagateCancel是context包中的一个函数，用于将父context和子context关联起来，保证父context被取消时，子context也会被取消，实现取消信号的传播。propagateCancel函数对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> child canceler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 1、如果parent不可取消，则直接返回</span>
	done <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token comment">// parent is never canceled</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2、如果parent已经被取消，则将child也取消后返回</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
		<span class="token comment">// parent is already canceled</span>
		child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Cause</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">parentCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 3、如果从parent中获取cancelCtx成功，则将child添加到parent的children集合中</span>
		p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// parent has already been canceled</span>
			child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>err<span class="token punctuation">,</span> p<span class="token punctuation">.</span>cause<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> p<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				p<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>canceler<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			p<span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 4、如果从parent中获取cancelCtx失败，则启动一个协程监听parent和child的Done通道</span>
		goroutines<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Cause</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>child<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>propagateCancel函数的执行逻辑如下：</p> 
<ol><li>如果父context的Done方法返回的channel为nil，表明父context永远不会被取消，不必实现取消信号的传播，函数直接返回。</li><li>尝试从父context的Done通道中读取取消信号，如果读取成功则说明父context已经被取消，这时直接将子context也取消即可。</li><li>如果从父context中获取cancelCtx成功，并且此时父context没有被取消，则将子context添加到父context的children集合中。</li><li>如果从父context中获取cancelCtx失败，则启动一个协程阻塞监听父context和子context的Done通道，直到父context和子context中有一个被取消，如果监听到子context被取消则协程直接退出，如果监听到父context被取消则先将子context取消然后再退出。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>可被取消的context也可由用户自定义实现，因此从可被取消的context中获取cancelCtx可能会失败。</li></ul> 
<blockquote> 
 <p>Deadline方法</p> 
</blockquote> 
<ul><li>cancelCtx主要用于实现取消上下文的功能，而不涉及截止时间的管理，因此cancelCtx本身并没有实现Deadline方法。</li><li>在调用cancelCtx的Deadline方法时，由于cancelCtx没有实现Deadline方法，这时会调用到其父context的Deadline方法，如果其父context仍然没有实现Deadline方法，那么会继续沿着context树往上查看其各个祖先context是否实现了Deadline方法，如果其祖先context都没有实现Deadline方法，那么最终会调用到根context，即emptyCtx的Deadline方法。</li></ul> 
<blockquote> 
 <p>Done方法</p> 
</blockquote> 
<p>cancelCtx的Done方法会将cancelCtx中done字段存储的channel进行返回，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 1、如果cancelCtx的done字段不为nil，则直接返回</span>
	d <span class="token operator">:=</span> c<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> d <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 2、如果cancelCtx的done字段为nil，则make后返回（双检查加锁）</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d <span class="token operator">=</span> c<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		d <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Done方法的执行逻辑如下：</p> 
<ol><li>如果cancelCtx的done字段不为nil，表明其对应的channel已经创建过了，直接将其返回即可。</li><li>如果cancelCtx的done字段为nil，则需要先通过make的方式创建对应的channel，然后再将其返回。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>从cancelCtx的Done方法的实现可以看出，cancelCtx中的Done通道采用的是懒加载机制，并在创建Done通道的过程中通过双检查加锁的方式，避免后续调用Done方法时频繁的加锁解锁操作。</li></ul> 
<blockquote> 
 <p>Err方法</p> 
</blockquote> 
<p>cancelCtx的Err方法会将cancelCtx中err字段的值进行返回，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> c<span class="token punctuation">.</span>err
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>Value方法</p> 
</blockquote> 
<p>cancelCtx的Value方法会根据指定的key获取上下文中关联的value，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> cancelCtxKey <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> any <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token operator">&amp;</span>cancelCtxKey <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> c
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">value</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Value方法的执行逻辑如下：</p> 
<ol><li>如果指定的key为cancelCtxKey的地址，则返回cancelCtx本身。</li><li>如果指定的key为其他值，则进一步调用value函数依次在其祖父context中查找给定key对应的value值</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>cancelCtxKey是context包中全局复用的一个int类型的变量，当调用cancelCtx的Value方法时，如果传入的是cancelCtxKey变量的地址，表明用户希望获取cancelCtx本身，这是context包中的一种约定。</li><li>cancelCtxKey约定需要用户在调用cancelCtx的Value方法时，传入cancelCtxKey变量的地址，而cancelCtxKey是context包中的一个不可导出的变量，因此该约定并不是提供给外部用户的，而是在context包内部使用的。</li></ul> 
<p>前面说到，在propagateCancel函数内部需要通过调用parentCancelCtx函数，从一个context中获取cancelCtx，而cancelCtxKey约定实际就是为parentCancelCtx函数定制的，该函数对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">parentCancelCtx</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cancelCtx<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 1、如果context的Done通道为nil或已经关闭，则获取cancelCtx失败</span>
	done <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> done <span class="token operator">==</span> closedchan <span class="token operator">||</span> done <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 2、如果调用Value方法（cancelCtxKey约定）从context中获取cancelCtx失败，则失败返回</span>
	p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cancelCtxKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 3、如果获取的cancelCtx的Done通道与context的Done通道不一致，则失败返回</span>
	pdone<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> p<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> pdone <span class="token operator">!=</span> done <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 4、返回获取到的cancelCtx</span>
	<span class="token keyword">return</span> p<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>parentCancelCtx函数的执行逻辑如下：</p> 
<ol><li>如果context的Done通道为nil或closedChan，表明该context不支持取消操作或已经完成了取消，获取cancelCtx失败，直接返回。</li><li>调用context的Value方法并传入cancelCtxKey的地址，如果获取cancelCtx失败，则直接返回。</li><li>如果获取从context中获取cancelCtx成功，但cancelCtx的Done通道与context的Done通道不一致，表明cancelCtx已经发生了变化，此时获取cancelCtx失败返回。</li><li>如果前面的所有检查都通过，则将获取到的cancelCtx返回。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>调用cancelCtx的Value方法时，如果没有用到cancelCtxKey约定，则会进一步调用value函数在context中获取所给key对应的value值，具体的获取过程在下面的valueCtx中进行介绍。</li></ul> 
<blockquote> 
 <p>cancel方法</p> 
</blockquote> 
<p>cancelCtx的cancel方法用于取消当前上下文，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cancelCtx<span class="token punctuation">)</span> <span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> cause <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"context: internal error: missing cancel error"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> cause <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		cause <span class="token operator">=</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// 1、如果cancelCtx的err字段不为nil，表明上下文已经被取消，无需重复取消，直接返回</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token comment">// already canceled</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 2、如果cancelCtx未被取消，则设置其err和cause字段，并关闭其Done通道</span>
	c<span class="token punctuation">.</span>err <span class="token operator">=</span> err
	c<span class="token punctuation">.</span>cause <span class="token operator">=</span> cause
	d<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>closedchan<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">close</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 3、遍历cancelCtx的children集合，依次取消各个子context，并将children集合设置为nil</span>
	<span class="token keyword">for</span> child <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>children <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// NOTE: acquiring the child's lock while holding parent's lock.</span>
		child<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> cause<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token boolean">nil</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 4、如果removeFromParent参数为true，则将当前context从其父context中移除</span>
	<span class="token keyword">if</span> removeFromParent <span class="token punctuation">{<!-- --></span>
		<span class="token function">removeChild</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>cancel方法的执行逻辑如下：</p> 
<ol><li>如果cancelCtx的err字段不为nil，表明上下文已经被取消，无需重复取消，直接返回。</li><li>如果cancelCtx未被取消，则设置其err和cause字段，表明上下文已经被取消，同时关闭其Done通道，使得监听Done通道的相关协程能够得知该context已经被取消。</li><li>遍历cancelCtx的children集合，依次取消各个子context，并将children集合设置为nil，实现取消信号的传播。</li><li>如果removeFromParent参数为true，则将当前context从其父context中移除。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>cancel方法在关闭cancelCtx的Done通道时，如果其对应的Done通道为nil，表明该cancelCtx的Done通道还未通过make创建，这时将其Done通道设置为closedChan即可。closedChan是context包中全局复用的chan struct{}类型的变量，其通过make的方式分配了空间，并在context包的init函数中对closedChan进行了关闭，因此可以用closedChan表示一个已关闭的channel。</li><li>cancel方法的第一个参数removeFromParent，表示在执行取消操作时，是否将当前context从其父context中移除，移除的逻辑通过调用removeChild函数完成，实际就是将当前context从其父context的children集合中删除。</li><li>并不是任何情况下，都需要将被取消的context从其父context中移除，比如cancelCtx的cancel方法在取消当前上下文时，会遍历children集合依次取消各个子context，在取消各个子context时不必将removeFromParent设置为true，因为cancel方法内部在取消完各个子context后会直接将children字段置为nil。</li><li>cancelCtx的cancel方法有两种情况会被调用，第一种是用户通过调用创建cancelCtx时获得的闭包函数执行上下文的取消操作，第二种是cancelCtx的父context被取消时，会遍历children集合依次调用各个子context的cancel方法执行上下文的取消操作。</li></ul> 
<blockquote> 
 <p>协程与context</p> 
</blockquote> 
<p>协程与context类似，协程的并发调用链路所形成的数据结构也是一个树型结构，其中协程树的根协程就是主协程，而其他协程则是程序在运行过程中创建出来的新协程。示意图如下：</p> 
<p><img src="https://images2.imgbox.com/38/62/4e3EqfEB_o.png" alt="在这里插入图片描述"></p> 
<p>通过将协程与context关联起来，可以实现协程的取消。具体操作如下：</p> 
<ol><li>仅在主协程中通过Background函数创建一个emptyCtx，保证全局只有一个context树，并在每次启动新协程的时候，通过协程的启动函数将当前的context传递给各个新协程。</li><li>如果一个协程在某些情况下需要被取消，则在该协程中通过WithCancel函数在已有context的基础上创建一个带有取消功能的cancelCtx，并将其传递给该协程创建的所有新协程，使得该协程创建的所有新协程所持有的context都带有取消能力。</li><li>当用户调用创建cancelCtx时获得的闭包函数，执行context的取消操作时，这个取消事件会从当前context处开始，依次向其子孙context传播，最终导致其所有的子孙context都被取消，即当前协程所创建的各个新协程所持有的context都会被取消。</li><li>各个协程在执行过程中，通过select的方式监听context的Done通道，可以判断各自所持有的context是否被取消，如果未被取消则执行自己的代码逻辑，如果自己所持有的context已被取消，则结束协程的运行，通过这种方式即可保证一个协程被取消时，由该协程创建的各个子孙协程都会被取消。</li></ol> 
<pre><code class="prism language-go">小贴士：在进行并发编程时要做好并发控制，避免协程泄露，如果你在创建一个协程时并不知道该协程什么时候会终止，那么你就不应该创建它。
</code></pre> 
<h3><a id="timerCtx_435"></a>timerCtx</h3> 
<blockquote> 
 <p>timerCtx</p> 
</blockquote> 
<p>timerCtx是context包中的一个结构体类型，其继承了cancelCtx的功能并新增了截止时间的管理功能，它实现了Context接口，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> timerCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">*</span>cancelCtx
	timer <span class="token operator">*</span>time<span class="token punctuation">.</span>Timer <span class="token comment">// Under cancelCtx.mu.</span>

	deadline time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre> 
<p>timerCtx结构体各字段说明：</p> 
<ul><li>cancelCtx：嵌套的cancelCtx类型的匿名结构体指针，用于继承cancelCtx的功能。</li><li>timer：定时器，用于在截止时间到达时触发上下文的取消操作。</li><li>deadline：用于表示上下文的截止时间。</li></ul> 
<p><strong>说明一下：</strong></p> 
<ul><li>timerCtx通过嵌套cancelCtx类型的匿名结构体指针的方式，继承了cancelCtx的各个字段和方法，因此timerCtx所继承的父context，是通过cancelCtx中的Context字段来表示的，timerCtx中各个字段的并发安全，是通过cancelCtx中的mu字段来保证的。</li><li>由于timerCtx继承了cancelCtx的功能，因此当timerCtx到达截止时间触发上下文的取消操作时，这个取消事件也会从当前timerCtx处开始，依次向其子孙context传播，最终导致其所有的子孙context都被取消。</li></ul> 
<blockquote> 
 <p>创建timerCtx</p> 
</blockquote> 
<p>通过context包中的WithDeadline函数和WithTimeout函数可以创建timerCtx，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> d time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"cannot create context from nil parent"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 1、如果parent存在截止时间，并且其截止时间比d早，则创建一个cancelCtx返回</span>
	<span class="token keyword">if</span> cur<span class="token punctuation">,</span> ok <span class="token operator">:=</span> parent<span class="token punctuation">.</span><span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> cur<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// The current deadline is already sooner than the new one.</span>
		<span class="token keyword">return</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 2、创建timerCtx实例，并用parent和d分别对其Context字段和deadline字段进行初始化</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>timerCtx<span class="token punctuation">{<!-- --></span>
		cancelCtx<span class="token punctuation">:</span> <span class="token function">newCancelCtx</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">,</span>
		deadline<span class="token punctuation">:</span>  d<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 3、将创建的timerCtx与parent关联起来</span>
	<span class="token function">propagateCancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token comment">// 4、如果timerCtx的截止时间在当前时间之前，则调用cancel方法对其进行取消后返回</span>
	dur <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token keyword">if</span> dur <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> DeadlineExceeded<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token comment">// deadline has already passed</span>
		<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 5、创建timerCtx的定时器timer字段，使其在截止时间时间到达时执行timerCtx的取消操作</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span>timer <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>dur<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> DeadlineExceeded<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 6、返回创建的timerCtx和对应的取消回调函数</span>
	<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> Canceled<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建timerCtx的流程如下：</p> 
<ol><li>如果给定的父context存在截止时间，并且其截止时间比子context的截止时间早，那么子context没有必要对截止时间进行管理，因为父context会在子context的截止时间到达之前被取消，这时子context也会被连带取消，因此创建一个cancelCtx返回即可。</li><li>如果给定的父context不存在截止时间，或其截止时间比子context的截止时间晚，这时子context需需要创建为timerCtx。在创建timerCtx时，分别根据所给的父context和截止时间，对timerCtx的Context字段和deadline字段进行初始化。</li><li>调用propagateCancel函数将创建的timerCtx与parent关联起来，保证父context被取消时，子context也会被取消。</li><li>如果timerCtx的截止时间在当前时间之前，则调用timerCtx的cancel方法对其进行取消后返回。</li><li>如果timerCtx的截止时间还未到达，则创建timerCtx的定时器timer字段，使其在截止时间时间到达时执行timerCtx的取消操作。</li><li>返回创建的timerCtx，同时返回一个闭包函数，闭包函数内部通过调用timerCtx的cancel方法执行上下文的取消操作。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>timerCtx将会在截止时间到达时自动触发上下文的取消操作，也可以在timerCtx的截止时间到达之前，通过调用创建timerCtx时获得的闭包函数手动执行上下文的取消操作。</li><li>WithTimeout函数和WithDeadline函数的区别在于，WithDeadline函数使用绝对时间来指定timerCtx的截止时间，而WithTimeout函数使用的是相对时间，即从当前时间开始多久后到达截止时间。WithTimeout函数在实现时，会将传入的相对时间转换为绝对时间，然后通过调用WithDeadline函数来创建timerCtx。</li></ul> 
<blockquote> 
 <p>Deadline方法</p> 
</blockquote> 
<p>timerCtx的Deadline方法会将timerCtx中deadline字段的值进行返回，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>timerCtx<span class="token punctuation">)</span> <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>deadline<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>Done、Err和Value方法</p> 
</blockquote> 
<ul><li>timerCtx本身没有实现Done、Err和Value方法，但timerCtx通过嵌套cancelCtx类型的匿名结构体指针的方式继承了cancelCtx，因此在使用timerCtx实例调用Done、Err和Value方法时，会对应调用到cancelCtx实现的Done、Err和Value方法。</li></ul> 
<blockquote> 
 <p>cancel方法</p> 
</blockquote> 
<p>timerCtx的cancel方法用于取消当前上下文，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>timerCtx<span class="token punctuation">)</span> <span class="token function">cancel</span><span class="token punctuation">(</span>removeFromParent <span class="token builtin">bool</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> cause <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 1、调用cancelCtx的cancel方法完成上下文的取消操作</span>
	c<span class="token punctuation">.</span>cancelCtx<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> cause<span class="token punctuation">)</span>
	<span class="token comment">// 2、如果removeFromParent参数为true，则将当前context从其父context中移除</span>
	<span class="token keyword">if</span> removeFromParent <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Remove this timerCtx from its parent cancelCtx's children.</span>
		<span class="token function">removeChild</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cancelCtx<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 3、停止定时器，并将其设置为nil</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>timer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>cancel方法的执行逻辑如下：</p> 
<ol><li>通过timerCtx的cancelCtx字段，调用cancelCtx的cancel方法完成上下文的取消操作，包括设置err和cause字段、关闭Done通道以及遍历children集合依次取消各个子context。</li><li>如果removeFromParent参数为true，则将当前context从其父context中移除。</li><li>停止timerCtx中定时器，并将timer字段设置为nil，表示定时器已被取消。</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>timerCtx在执行取消操作时，借助cancelCtx的cancel方法完成了大部分的取消操作，但没有复用其中removeChild函数的调用，因为在cancelCtx的cancel方法中调用removeChild函数是将当前的cancelCtx从其父context中移除，相当于将timerCtx中的cancelCtx字段从其父context中移除，而我们要做的是将当前的timerCtx从其父context中移除，因此该动作只能在timerCtx的cancel方法中完成。</li><li>由于timerCtx实现了cancel方法和Done方法，其中Done方法是继承的cancelCtx的Done方法，意味着timerCtx也实现了canceler接口，因此cancelCtx的children字段中不仅可以保存cancelCtx，还可以保存timerCtx。</li></ul> 
<h3><a id="valueCtx_567"></a>valueCtx</h3> 
<blockquote> 
 <p>valueCtx</p> 
</blockquote> 
<p>valueCtx是context包中的一个结构体类型，用于在上下文中存储键值对，它实现了Context接口，其定义如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> valueCtx <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Context
	key<span class="token punctuation">,</span> val any
<span class="token punctuation">}</span>
</code></pre> 
<p>valueCtx结构体各字段说明：</p> 
<ul><li>Context：嵌套的Context接口类型的匿名结构体，表示当前valueCtx所继承的父上下文。</li><li>key：表示上下文中存储的键。</li><li>value：表示上下文中存储的键对应的值。</li></ul> 
<p><strong>说明一下：</strong></p> 
<ul><li>valueCtx中的key和value字段都是any类型的，any是interface{}的别名，表示任意类型。</li></ul> 
<blockquote> 
 <p>创建valueCtx</p> 
</blockquote> 
<p>通过context包中的WithValue函数可以创建valueCtx，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WithValue</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val any<span class="token punctuation">)</span> Context <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"cannot create context from nil parent"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"nil key"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 1、如果key对应的类型不支持比较操作，则抛出panic异常</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>reflectlite<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Comparable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"key is not comparable"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 2、创建valueCtx实例，并对其各个字段进行初始化</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>valueCtx<span class="token punctuation">{<!-- --></span>parent<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建valueCtx的流程如下：</p> 
<ol><li>如果key对应的类型不支持比较操作，则抛出panic异常。</li><li>创建valueCtx实例，并用给定的父context、key和value对其各个字段进行初始化</li></ol> 
<p><strong>说明一下：</strong></p> 
<ul><li>WithValue函数中通过反射机制，保证存入valueCtx中的key必须支持比较操作，因为后续在valueCtx中查找指定key对应的value时，需要对key进行比较操作。</li></ul> 
<blockquote> 
 <p>Deadline、Done和Err方法</p> 
</blockquote> 
<ul><li>valueCtx主要用于在上下文中存储键值对，而不涉及上下文的取消以及截止时间的管理，因此valueCtx本身并没有实现Deadline、Done和Err方法。</li><li>在调用valueCtx的Deadline、Done和Err方法时，会调用到其父context对应的方法，如果其父context仍然没有实现对应的方法，那么会继续沿着context树往上查看各个祖先context是否实现了对应的方法，如果其祖先context都没有实现对应的方法，那么最终会调用到根context，即emptyCtx对应的方法。</li></ul> 
<blockquote> 
 <p>Value方法</p> 
</blockquote> 
<p>valueCtx的Value方法会根据指定的key获取上下文中关联的value，其对应的源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>valueCtx<span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span>key any<span class="token punctuation">)</span> any <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 1、如果当前context中的key与给定的key匹配，则返回context中的value</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>key <span class="token operator">==</span> key <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> c<span class="token punctuation">.</span>val
	<span class="token punctuation">}</span>
	<span class="token comment">// 2、调用value函数在依次在其祖父context中查找给定key对应的value值</span>
	<span class="token keyword">return</span> <span class="token function">value</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">value</span><span class="token punctuation">(</span>c Context<span class="token punctuation">,</span> key any<span class="token punctuation">)</span> any <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> ctx <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">*</span>valueCtx<span class="token punctuation">:</span>
			<span class="token keyword">if</span> key <span class="token operator">==</span> ctx<span class="token punctuation">.</span>key <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> ctx<span class="token punctuation">.</span>val
			<span class="token punctuation">}</span>
			c <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Context <span class="token comment">// 向父context迭代</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>cancelCtx<span class="token punctuation">:</span>
			<span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token operator">&amp;</span>cancelCtxKey <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> c
			<span class="token punctuation">}</span>
			c <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Context <span class="token comment">// 向父context迭代</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>timerCtx<span class="token punctuation">:</span>
			<span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token operator">&amp;</span>cancelCtxKey <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">return</span> ctx<span class="token punctuation">.</span>cancelCtx
			<span class="token punctuation">}</span>
			c <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Context <span class="token comment">// 向父context迭代</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>emptyCtx<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token comment">// 用户自定义实现的Context</span>
			<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Value方法的执行逻辑如下：</p> 
<ol><li>如果当前valueCtx中的key字段与给定的key匹配，则直接返回valueCtx中的value字段。</li><li>如果给定的key与当前valueCtx中的key字段不匹配，则进一步调用value函数依次在其祖父context中查找给定key对应的value值。</li></ol> 
<p>value函数会不断向当前context的父context迭代，并对每个context进行类型断言，根据context的类型执行相应的判断逻辑。具体的判断逻辑如下：</p> 
<ul><li>如果context的类型是valueCtx，则判断所给key与valueCtx的key字段是否匹配，如果匹配则返回valueCtx对应的value字段，否则继续向父context迭代。</li><li>如果context的类型是cancelCtx或timerCtx，则判断所给key是否满足cancelCtxKey约定，如果满足则返回对应的cancelCtx，否则继续向父context迭代。</li><li>如果context的类型是emptyCtx，则说明上下文中不存在给定的key值，返回nil。</li><li>如果context的类型是用户自定义实现的Context，则调用其对应的Value方法查找给定key对应的value值。</li></ul> 
<p><strong>说明一下：</strong></p> 
<ul><li>由于每个valueCtx中只存储了一个键值对，因此每向context中添加一个键值对就需要在当前context的基础上创建一个valueCtx，并且从context中查找指定key对应的value值时，其时间复杂度与当前context的层次有关，context的祖父context越多，那么查找的时间复杂度就越高。</li><li>因此不要随意将数据存放在context中，而应该只向context中存放少量与context链路或协程并发调用链路相关的数据，以保证context树不会过于庞大，比如在进行网络编程时，通常会将requestId存放在context中。</li><li>每向context中添加一个键值对时都会创建一个新的valueCtx，并没有对存储的键值对进行任何的去重操作，因此当从context中查找指定key对应的value时，得到的结果可能是不同的，这却决于当前的context位于context树中的哪一个位置。</li><li>如果在协程的启动函数中没有调用WithXxx函数，在已有context的基础上创建出新的context，那么该协程持有的context与其父协程持有的context是同一个，因此一个context可能会被多个协程访问。而一旦协程要向context中添加键值对，那么就需要创建出一个新的context，因此每个valueCtx中只存储一个键值对，在无形中解决了向context中添加键值对的并发写问题。</li></ul> 
<h2><a id="context_685"></a>context使用案例</h2> 
<h3><a id="_686"></a>协程取消</h3> 
<blockquote> 
 <p>协程取消</p> 
</blockquote> 
<p>使用context实现协程取消的步骤如下：</p> 
<ol><li>在需要被取消的协程A对应的启动函数中，通过调用context包中的WithCancel函数，在已有context的基础上创建一个cancelCtx。</li><li>协程A在运行过程中如果需要创建新协程，则通过协程的启动函数将当前带有取消能力的context传递给各个新协程。</li><li>协程A在运行过程中创建的各个新协程，通过select的方式监听context的Done通道，当context被取消时结束协程的运行。</li><li>当需要取消协程A时，通过调用创建cancelCtx时获得的取消函数，执行context的取消操作，这时当前context及其所有子孙context都会被取消，而所有监听这些context的Done通道的协程，在得知其持有的context被取消后就会退出。</li></ol> 
<p>示例代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine exit...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 监听context的取消信号</span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// context已被取消</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine running...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine exit...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token comment">// 创建一个派生的cancelCtx</span>

	<span class="token keyword">go</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine running...%d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用取消函数</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个空的context</span>

	<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main goroutine running..."</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上述代码中，协程A在执行完三次打印后会取消其持有的context并退出，同时协程A在运行过程中创建的协程B和协程C，在收到context的取消信号后也会相继退出。程序运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/52/81/QAdZnAoh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_754"></a>超时控制</h3> 
<blockquote> 
 <p>超时控制</p> 
</blockquote> 
<p>使用context实现协程超时控制的步骤如下：</p> 
<ol><li>在需要进行超时控制的协程A对应的启动函数中，通过调用context包中的WithDeadline函数，在已有context的基础上创建一个timerCtx。</li><li>协程A在运行过程中如果需要创建新协程，则通过协程的启动函数将当前带有截止时间管理能力的context传递给各个新协程。</li><li>协程A及其在运行过程中创建的各个新协程，通过select的方式监听context的Done通道，当context被取消时结束协程的运行。</li><li>当context的截止时间到达时，timerCtx的定时器timer会自动执行context的取消操作，这时当前timerCtx及其所有子孙context都会被取消，而所有监听这些context的Done通道的协程，在得知其持有的context被取消后就会退出。</li></ol> 
<p>示例代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine exit...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 监听context的取消信号</span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// context已被取消</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine running...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine exit...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

	deadline <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithDeadline</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> deadline<span class="token punctuation">)</span> <span class="token comment">// 创建一个派生的timerCtx</span>

	<span class="token keyword">go</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 监听context的取消信号</span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// context已被取消</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine running...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个空的context</span>

	<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main goroutine running..."</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上述代码中，协程A创建的timerCtx会在三秒后自动被取消，此时协程A及其在运行过程中创建的协程B和协程C，在收到context的取消信号后都会相继退出。程序运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/24/c3/piMm25AO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_828"></a>数据共享</h3> 
<blockquote> 
 <p>数据共享</p> 
</blockquote> 
<p>使用context实现协程数据共享的步骤如下：</p> 
<ol><li>在协程A的启动函数中，通过调用context包中的WithValue函数，在已有context的基础上创建一个valueCtx，将需要共享的数据以键值对的方式添加到valueCtx中。</li><li>协程A在运行过程中如果需要创建新协程，则通过协程的启动函数将存有数据的context传递给各个新协程。</li><li>协程A在运行过程中创建的各个新协程，通过调用context的Value方法，即可从context中获取指定key对应的value。</li></ol> 
<p>示例代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">getId</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>processId <span class="token builtin">string</span><span class="token punctuation">,</span> testId <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	processId<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"process_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		processId <span class="token operator">=</span> <span class="token string">"no process_id"</span>
	<span class="token punctuation">}</span>
	testId<span class="token punctuation">,</span> ok <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"test_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
		testId <span class="token operator">=</span> <span class="token string">"no test_id"</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine exit...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

	ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"test_id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token comment">// 创建一个派生的valueCtx</span>

	processId<span class="token punctuation">,</span> testId <span class="token operator">:=</span> <span class="token function">getId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine...process_id = %s, test_id = %s\n"</span><span class="token punctuation">,</span>
			name<span class="token punctuation">,</span> processId<span class="token punctuation">,</span> testId<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine exit...\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>

	ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"process_id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token comment">// 创建一个派生的valueCtx</span>

	<span class="token keyword">go</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"001"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"002"</span><span class="token punctuation">)</span>

	processId<span class="token punctuation">,</span> testId <span class="token operator">:=</span> <span class="token function">getId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s goroutine...process_id = %s, test_id = %s\n"</span><span class="token punctuation">,</span>
			name<span class="token punctuation">,</span> processId<span class="token punctuation">,</span> testId<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个空的context</span>

	<span class="token keyword">go</span> <span class="token function">process</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"8421"</span><span class="token punctuation">)</span>

	processId<span class="token punctuation">,</span> testId <span class="token operator">:=</span> <span class="token function">getId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"main goroutine...process_id = %s, test_id = %s\n"</span><span class="token punctuation">,</span>
			processId<span class="token punctuation">,</span> testId<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上述代码中，协程A在运行过程中向context中添加了process_id，其创建的协程B和协程C又向context中添加了test_id。context树大致如下：</p> 
<p><img src="https://images2.imgbox.com/08/1d/jZZVRojP_o.png" alt="在这里插入图片描述"></p> 
<p>主协程持有的context是图中的emptyCtx，协程A持有的context是图中的valueCtx1，协程B和协程C持有的context分别是图中的valueCtx2和valueCtx3。主协程、协程A、协程B和协程各自持有的是context树中不同的context，因此它们从context中查找指定key对应的value时会得到不同的结果。程序运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/7e/9d/2a4f7XAV_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9d4c6b4cda047a5dd220f1a0216e035c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;进阶】深入STL之 栈与队列：数据结构探索之旅</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e147330e8a12125b950d3b287bc9640/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Golang】Go语言中defer与return的精妙交织：探索延迟执行与返回顺序的微妙关系</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>