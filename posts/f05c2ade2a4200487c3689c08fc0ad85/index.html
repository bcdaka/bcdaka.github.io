<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sleuth--链路追踪 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f05c2ade2a4200487c3689c08fc0ad85/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Sleuth--链路追踪">
  <meta property="og:description" content="1 链路追踪介绍 在大型系统的微服务化构建中，一个系统被拆分成了许多模块。这些模块负责不同的功能，组合成 系统，最终可以提供丰富的功能。在这种架构中，一次请求往往需要涉及到多个服务。互联网应用构建 在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实 现、有可能布在了几千台服务器，横跨多个不同的数据中心，也就意味着这种架构形式也会存在一些问题：
如何快速发现问题？ 如何判断故障影响范围？ 如何梳理服务依赖以及依赖的合理性？ 如何分析链路性能问题以及实时容量规划？ 分布式链路追踪（Distributed Tracing），就是将一次分布式请求还原成调用链路，进行日志记录，性能监控并将一次分布式请求的调用情况集中展示。比如各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等等。 常见的链路追踪技术有下面这些： cat 由大众点评开源，基于Java开发的实时应用监控平台，包括实时应用监控，业务监控 。 集成方案是通过代码埋点的方式来实现监控，比如： 拦截器，过滤器等。 对代码的侵入性很大，集成成本较高。风险较大。 zipkin 由Twitter公司开源，开放源代码分布式的跟踪系统，用于收集服务的定时数据，以解决微服务架构中的延迟问题，包括：数据的收集、存储、查找和展现。该产品结合spring-cloud-sleuth使用较为简单， 集成很方便， 但是功能较简单。 pinpoint Pinpoint是韩国人开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点是支持多种插件，UI功能强大，接入端无代码侵入。 skywalking SkyWalking是本土开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点是支持多种插件，UI功能较强，接入端无代码侵入。目前已加入Apache孵化器。 Sleuth SpringCloud 提供的分布式系统中链路追踪解决方案。 注意： SpringCloud alibaba 技术栈中并没有提供自己的链路追踪技术的，我们可以采用 Sleuth &#43; Zinkin 来做链路追踪解决方案 2 Sleuth入门 2.1 Sleuth介绍 SpringCloud Sleuth主要功能就是在分布式系统中提供追踪解决方案。它大量借用了 Google Dapper 的设计， 先来了解一下 Sleuth 中的术语和相关概念。 Trace 由一组Trace Id相同的Span串联形成一个树状结构。为了实现请求跟踪，当请求到达分布式系统的入口端点时，只需要服务跟踪框架为该请求创建一个唯一的标识（即TraceId），同时在分布式系统内部流转的时候，框架始终保持传递该唯一值，直到整个请求的返回。那么我们就可以使用该唯一标识将所有的请求串联起来，形成一条完整的请求链路。 Span 代表了一组基本的工作单元。为了统计各处理单元的延迟，当请求到达各个服务组件的时候，也通过一个唯一标识（SpanId）来标记它的开始、具体过程和结束。通过SpanId的开始和结束时间戳，就能统计该span的调用时间，除此之外，我们还可以获取如事件的名称。请求信息等元数据。 Annotation 用它记录一段时间内的事件，内部使用的重要注释： cs（Client Send）客户端发出请求，开始一个请求的生命 sr（Server Received）服务端接受到请求开始进行处理， sr－cs = 网络延迟（服务调用的时间） ss（Server Send）服务端处理完毕准备发送到客户端，ss - sr = 服务器上的请求处理时间 cr（Client Reveived）客户端接受到服务端的响应，请求结束。 cr - sr = 请求的总时间 2.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-08T21:15:00+08:00">
    <meta property="article:modified_time" content="2024-07-08T21:15:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Sleuth--链路追踪</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2><span style="color:#333333;"><strong>1 </strong></span><span style="color:#333333;"><strong>链路追踪介绍</strong></span></h2> 
<p> <span style="color:#333333;">        在大型系统的微服务化构建中，一个系统被拆分成了许多模块。这些模块负责不同的功能，组合成 系统，最终可以提供丰富的功能。在这种架构中，一次请求往往需要涉及到多个服务。互联网应用构建 在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实 现、有可能布在了几千台服务器，横跨多个不同的数据中心，也就意味着这种架构形式也会存在一些问题：</span></p> 
<ul><li><span style="color:#333333;">如何快速发现问题？ </span></li><li><span style="color:#333333;">如何判断故障影响范围？ </span></li><li><span style="color:#333333;">如何梳理服务依赖以及依赖的合理性？ </span></li><li><span style="color:#333333;">如何分析链路性能问题以及实时容量规划？</span></li></ul> 
<p><img alt="" height="1052" src="https://images2.imgbox.com/b2/08/7fcTgK7S_o.png" width="1200"></p> 
<div> 
 <span style="color:#333333;">        分布式链路追踪（Distributed Tracing），就是将一次分布式请求还原成调用链路，进行日志记录，性能监控并将一次分布式请求的调用情况集中展示。比如各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等等。</span> 
</div> 
<p></p> 
<div> 
 <span style="color:#333333;">常见的链路追踪技术有下面这些：</span> 
</div> 
<ul><li><span style="color:#333333;"><strong>cat </strong></span><span style="color:#333333;">由大众点评开源，基于</span><span style="color:#333333;">Java</span><span style="color:#333333;">开发的实时应用监控平台，包括实时应用监控，业务监控 。 集成</span><span style="color:#333333;">方案是通过代码埋点的方式来实现监控，比如： 拦截器，过滤器等。 对代码的侵入性很大，集成</span><span style="color:#333333;">成本较高。风险较大。 </span></li><li><span style="color:#333333;"><strong>zipkin </strong></span><span style="color:#333333;">由</span><span style="color:#333333;">Twitter</span><span style="color:#333333;">公司开源，开放源代码分布式的跟踪系统，用于收集服务的定时数据，以解决微</span><span style="color:#333333;">服务架构中的延迟问题，包括：数据的收集、存储、查找和展现。该产品结合</span><span style="color:#333333;">spring-cloud-sleuth</span><span style="color:#333333;">使用较为简单， 集成很方便， 但是功能较简单。 </span></li><li><span style="color:#333333;"><strong>pinpoint </strong></span><span style="color:#333333;">Pinpoint</span><span style="color:#333333;">是韩国人开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点</span><span style="color:#333333;">是支持多种插件，</span><span style="color:#333333;">UI</span><span style="color:#333333;">功能强大，接入端无代码侵入。 </span></li><li><span style="color:#333333;"><strong>skywalking </strong></span><br><span style="color:#333333;">SkyWalking</span><span style="color:#333333;">是本土开源的基于字节码注入的调用链分析，以及应用监控分析工具。特点是支持多</span><span style="color:#333333;">种插件，</span><span style="color:#333333;">UI</span><span style="color:#333333;">功能较强，接入端无代码侵入。目前已加入</span><span style="color:#333333;">Apache</span><span style="color:#333333;">孵化器。 </span></li><li><span style="color:#333333;"><strong>Sleuth </strong></span><br><span style="color:#333333;">SpringCloud </span><span style="color:#333333;">提供的分布式系统中链路追踪解决方案。</span> </li></ul> 
<div> 
 <span style="color:#333333;"><strong>注意：</strong></span> 
 <span style="color:#333333;"><strong>SpringCloud alibaba</strong></span> 
 <span style="color:#333333;"><strong>技术栈中并没有提供自己的链路追踪技术的，我们可以采用</strong></span> 
 <span style="color:#333333;"><strong>Sleuth + </strong></span> 
</div> 
<div> 
 <span style="color:#333333;"><strong>Zinkin</strong></span> 
 <span style="color:#333333;"><strong>来做链路追踪解决方案</strong></span> 
</div> 
<p></p> 
<h2><span style="color:#333333;"><strong>2 Sleuth</strong></span><span style="color:#333333;"><strong>入门</strong></span></h2> 
<h3><span style="color:#333333;"><strong>2.1 Sleuth</strong></span><span style="color:#333333;"><strong>介绍</strong></span></h3> 
<div> 
 <span style="color:#333333;">        SpringCloud Sleuth主要功能就是在分布式系统中提供追踪解决方案。它大量借用了</span> 
 <span style="color:#333333;">Google </span> 
</div> 
<div> 
 <span style="color:#333333;">Dapper</span> 
 <span style="color:#333333;">的设计， 先来了解一下</span> 
 <span style="color:#333333;">Sleuth</span> 
 <span style="color:#333333;">中的术语和相关概念。</span> 
</div> 
<ul><li><span style="color:#333333;">Trace </span><br><span style="color:#333333;">由一组</span><span style="color:#333333;">Trace Id</span><span style="color:#333333;">相同的</span><span style="color:#333333;">Span</span><span style="color:#333333;">串联形成一个树状结构。为了实现请求跟踪，当请求到达分布式系统的</span><span style="color:#333333;">入口端点时，只需要服务跟踪框架为该请求创建一个唯一的标识（即</span><span style="color:#333333;">TraceId</span><span style="color:#333333;">），同时在分布式系</span><span style="color:#333333;">统内部流转的时候，框架始终保持传递该唯一值，直到整个请求的返回。那么我们就可以使用该唯</span><span style="color:#333333;">一标识将所有的请求串联起来，形成一条完整的请求链路。 </span></li><li><span style="color:#333333;">Span </span><span style="color:#333333;">代表了一组基本的工作单元。为了统计各处理单元的延迟，当请求到达各个服务组件的时</span><span style="color:#333333;">候，也通过一个唯一标识（</span><span style="color:#333333;">SpanId</span><span style="color:#333333;">）来标记它的开始、具体过程和结束。通过</span><span style="color:#333333;">SpanId</span><span style="color:#333333;">的开始和结</span><span style="color:#333333;">束时间戳，就能统计该</span><span style="color:#333333;">span</span><span style="color:#333333;">的调用时间，除此之外，我们还可以获取如事件的名称。请求信息等</span><span style="color:#333333;">元数据。 </span></li><li><span style="color:#333333;">Annotation </span><br><span style="color:#333333;">用它记录一段时间内的事件，内部使用的重要注释： </span><br><span style="color:#333333;">cs</span><span style="color:#333333;">（</span><span style="color:#333333;">Client Send</span><span style="color:#333333;">）客户端发出请求，开始一个请求的生命 </span><br><span style="color:#333333;">sr</span><span style="color:#333333;">（</span><span style="color:#333333;">Server Received</span><span style="color:#333333;">）服务端接受到请求开始进行处理，</span><span style="color:#333333;"> sr</span><span style="color:#333333;">－</span><span style="color:#333333;">cs = </span><span style="color:#333333;">网络延迟（服务调用的时间） </span><br><span style="color:#333333;">ss</span><span style="color:#333333;">（</span><span style="color:#333333;">Server Send</span><span style="color:#333333;">）服务端处理完毕准备发送到客户端，</span><span style="color:#333333;">ss - sr = </span><span style="color:#333333;">服务器上的请求处理时间 </span><br><span style="color:#333333;">cr</span><span style="color:#333333;">（</span><span style="color:#333333;">Client Reveived</span><span style="color:#333333;">）客户端接受到服务端的响应，请求结束。</span><span style="color:#333333;"> cr - sr = </span><span style="color:#333333;">请求的总时间</span></li></ul> 
<p><img alt="" height="822" src="https://images2.imgbox.com/b7/d9/ya68Vvap_o.png" width="1200"></p> 
<p></p> 
<h3><span style="color:#333333;"><strong>2.2 Sleuth</strong></span><span style="color:#333333;"><strong>入门</strong></span></h3> 
<div> 
 <span style="color:#333333;">微服务名称</span> 
 <span style="color:#333333;">, traceId, spanid,</span> 
 <span style="color:#333333;">是否将链路的追踪结果输出到第三方平台</span> 
</div> 
<blockquote> 
 <div> 
  <div> 
   <span style="color:#333333;">[api-gateway,3977125f73391553,3977125f73391553,false] </span> 
  </div> 
  <div> 
   <span style="color:#333333;">[service-order,3977125f73391553,57547b5bf71f8242,false] </span> 
  </div> 
  <div> 
   <span style="color:#333333;">[service-product,3977125f73391553,449f5b3f3ef8d5c5,false]</span> 
  </div> 
 </div> 
</blockquote> 
<div> 
 <span style="color:#333333;">接下来通过之前的项目案例整合</span> 
 <span style="color:#333333;">Sleuth</span> 
 <span style="color:#333333;">，完成入门案例的编写。</span> 
</div> 
<div> 
 <span style="color:#333333;">修改父工程引入</span> 
 <span style="color:#333333;">Sleuth</span> 
 <span style="color:#333333;">依赖</span> 
</div> 
<pre><code class="language-XML">        &lt;!--链路追踪 Sleuth--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;
        &lt;/dependency&gt;</code></pre> 
<div> 
 <span style="color:#333333;">启动微服务，调用接口之后，我们可以在控制台观察到</span> 
 <span style="color:#333333;">sleuth</span> 
 <span style="color:#333333;">的日志输出</span> 
</div> 
<div> 
 <img alt="" height="266" src="https://images2.imgbox.com/c2/e3/wd5Q64kD_o.png" width="1184"> 
</div> 
<div> 
 <span style="color:#333333;">        其中 c61d4a753370cbeb是</span> 
 <span style="color:#333333;">TraceId</span> 
 <span style="color:#333333;">， 0e06445e055ed94f是</span> 
 <span style="color:#333333;">SpanId，依次调用有一个全局的 TraceId，将调用链路串起来。仔细分析每个微服务的日志，不难看出请求的具体过程。        </span> 
</div> 
<p></p> 
<div> 
 <span style="color:#333333;">        查看日志文件并不是一个很好的方法，当微服务越来越多日志文件也会越来越多，通过Zipkin可以将日志聚合，并进行可视化展示和全文检索。</span> 
</div> 
<p></p> 
<h2><span style="color:#333333;"><strong>3 Zipkin</strong></span><span style="color:#333333;"><strong>的集成</strong></span></h2> 
<h3><span style="color:#333333;"><strong>3.1 ZipKin</strong></span><span style="color:#333333;"><strong>介绍</strong></span></h3> 
<div> 
 <span style="color:#333333;">        Zipkin 是</span> 
 <span style="color:#333333;"> Twitter </span> 
 <span style="color:#333333;">的一个开源项目，它基于</span> 
 <span style="color:#333333;">Google Dapper实现，它致力于收集服务的定时数据，以解决微服务架构中的延迟问题，包括数据的</span> 
 <span style="color:#333333;"><strong>收集、存储、查找和展现</strong></span> 
 <span style="color:#333333;">。</span> 
</div> 
<p></p> 
<div> 
 <span style="color:#333333;">        我们可以使用它来收集各个服务器上请求链路的跟踪数据，并通过它提供的REST API接口来辅助我们查询跟踪数据以实现对分布式系统的监控程序，从而及时地发现系统中出现的延迟升高问题并找出系统性能瓶颈的根源。</span> 
</div> 
<div></div> 
<div> 
 <div> 
  <span style="color:#333333;">        除了面向开发的 API </span> 
  <span style="color:#333333;">接口之外，它也提供了方便的</span> 
  <span style="color:#333333;">UI组件来帮助我们直观的搜索跟踪信息和分析请求链路明细，比如：可以查询某段时间内各用户请求的处理时间等。</span> 
 </div> 
</div> 
<div></div> 
<div> 
 <span style="color:#333333;">        Zipkin 提供了可插拔数据存储方式：</span> 
 <span style="color:#333333;">In-Memory</span> 
 <span style="color:#333333;">、</span> 
 <span style="color:#333333;">MySql</span> 
 <span style="color:#333333;">、</span> 
 <span style="color:#333333;">Cassandra </span> 
 <span style="color:#333333;">以及</span> 
 <span style="color:#333333;"> Elasticsearch</span> 
 <span style="color:#333333;">。</span> 
</div> 
<p><img alt="" height="845" src="https://images2.imgbox.com/cf/e8/68ZlNSLm_o.png" width="1127"></p> 
<div> 
 <span style="color:#333333;">上图展示了</span> 
 <span style="color:#333333;"> Zipkin </span> 
 <span style="color:#333333;">的基础架构，它主要由</span> 
 <span style="color:#333333;"> 4 </span> 
 <span style="color:#333333;">个核心组件构成：</span> 
</div> 
<div> 
 <ul><li><span style="color:#333333;">Collector</span><span style="color:#333333;">：收集器组件，它主要用于处理从外部系统发送过来的跟踪信息，将这些信息转换为 </span><span style="color:#333333;">Zipkin</span><span style="color:#333333;">内部处理的</span><span style="color:#333333;"> Span </span><span style="color:#333333;">格式，以支持后续的存储、分析、展示等功能。 </span></li><li><span style="color:#333333;">Storage</span><span style="color:#333333;">：存储组件，它主要对处理收集器接收到的跟踪信息，默认会将这些信息存储在内存中，</span><span style="color:#333333;">我们也可以修改此存储策略，通过使用其他存储组件将跟踪信息存储到数据库中。 </span></li><li><span style="color:#333333;">RESTful API</span><span style="color:#333333;">：</span><span style="color:#333333;">API </span><span style="color:#333333;">组件，它主要用来提供外部访问接口。比如给客户端展示跟踪信息，或是外接</span><span style="color:#333333;">系统访问以实现监控等。 </span></li><li><span style="color:#333333;">Web UI</span><span style="color:#333333;">：</span><span style="color:#333333;">UI </span><span style="color:#333333;">组件， 基于</span><span style="color:#333333;">API</span><span style="color:#333333;">组件实现的上层应用。通过</span><span style="color:#333333;">UI</span><span style="color:#333333;">组件用户可以方便而有直观地查询和分</span><span style="color:#333333;">析跟踪信息。</span></li></ul> 
</div> 
<div> 
 <span style="color:#333333;">        Zipkin分为两端，一个是</span> 
 <span style="color:#333333;"> Zipkin</span> 
 <span style="color:#333333;">服务端，一个是</span> 
 <span style="color:#333333;"> Zipkin客户端，客户端也就是微服务的应用。 客户端会配置服务端的</span> 
 <span style="color:#333333;"> URL </span> 
 <span style="color:#333333;">地址，一旦发生服务间的调用的时候，会被配置在微服务里面的</span> 
 <span style="color:#333333;"> Sleuth 的监听器监听，并生成相应的</span> 
 <span style="color:#333333;"> Trace </span> 
 <span style="color:#333333;">和</span> 
 <span style="color:#333333;"> Span </span> 
 <span style="color:#333333;">信息发送给服务端。</span> 
</div> 
<p></p> 
<h3 style="background-color:transparent;"><span style="color:#333333;"><strong>3.2 ZipKin</strong></span><span style="color:#333333;"><strong>服务端安装</strong></span></h3> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">1</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">下载</span> 
 <span style="color:#333333;">ZipKin</span> 
 <span style="color:#333333;">的</span> 
 <span style="color:#333333;">jar</span> 
 <span style="color:#333333;">包</span> 
</div> 
<blockquote> 
 <div> 
  <span style="color:#333333;">https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec</span> 
 </div> 
</blockquote> 
<p> <span style="color:#333333;">访问上面的网址，即可得到一个</span><span style="color:#333333;">jar</span><span style="color:#333333;">包，这就是</span><span style="color:#333333;">ZipKin</span><span style="color:#333333;">服务端的</span><span style="color:#333333;">jar</span><span style="color:#333333;">包</span></p> 
<p></p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">2</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">通过命令行，输入下面的命令启动</span> 
 <span style="color:#333333;">ZipKin Server</span> 
</div> 
<pre><code class="language-XML">java -jar zipkin-server-2.12.9-exec.jar</code></pre> 
<p></p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">3</span> 
 <span style="color:#333333;">步：通过浏览器访问 </span> 
 <span style="color:#4183c4;">http://localhost:9411</span> 
 <span style="color:#333333;">访问</span> 
</div> 
<p><img alt="" height="525" src="https://images2.imgbox.com/48/83/ZFOcnqxx_o.png" width="1200"></p> 
<p></p> 
<h3><span style="color:#333333;"><strong>3.3 Zipkin</strong></span><span style="color:#333333;"><strong>客户端集成</strong></span></h3> 
<div> 
 <span style="color:#333333;">        ZipKin客户端和</span> 
 <span style="color:#333333;">Sleuth</span> 
 <span style="color:#333333;">的集成非常简单，只需要在微服务中添加其依赖和配置即可。</span> 
</div> 
<p></p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">1</span> 
 <span style="color:#333333;">步：在每个微服务上添加依赖</span> 
</div> 
<div></div> 
<pre><code class="language-XML">        &lt;!--zipkin--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
        &lt;/dependency&gt;</code></pre> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">2</span> 
 <span style="color:#333333;">步：添加配置</span> 
</div> 
<div> 
 <pre><code class="language-XML">  # sleuth 和 zipkin 相关配置
spring:
  zipkin:
    base-url: http://127.0.0.1:9411/ #zipkin server的请求地址
    discoveryClientEnabled: false #让nacos把它当成一个URL，而不要当做服务名
  sleuth:
    sampler:
      probability: 1.0 #采样的百分比</code></pre> 
 <div> 
  <span style="color:#333333;">第</span> 
  <span style="color:#333333;">3</span> 
  <span style="color:#333333;">步</span> 
  <span style="color:#333333;">: </span> 
  <span style="color:#333333;">访问微服务接口</span> 
 </div> 
</div> 
<blockquote> 
 <div> 
  <span style="color:#333333;">http://localhost:7000/order-serv/order/prod/1</span> 
 </div> 
</blockquote> 
<p></p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">4</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">访问</span> 
 <span style="color:#333333;">zipkin</span> 
 <span style="color:#333333;">的</span> 
 <span style="color:#333333;">UI</span> 
 <span style="color:#333333;">界面，观察效果</span> 
</div> 
<p><img alt="" height="586" src="https://images2.imgbox.com/c5/84/WhFMLg87_o.png" width="1200"></p> 
<p></p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">5</span> 
 <span style="color:#333333;">步：点击其中一条记录，可观察一次访问的详细线路。</span> 
</div> 
<p><img alt="" height="477" src="https://images2.imgbox.com/de/34/govbVPmG_o.png" width="1200"></p> 
<h2><span style="color:#333333;"><strong>4 ZipKin</strong></span><span style="color:#333333;"><strong>数据持久化</strong></span></h2> 
<div> 
 <span style="color:#333333;">        Zipkin Server默认会将追踪数据信息保存到内存，但这种方式不适合生产环境。</span> 
 <span style="color:#333333;">Zipkin支持将追踪 数据持久化到</span> 
 <span style="color:#333333;">mysql</span> 
 <span style="color:#333333;">数据库或</span> 
 <span style="color:#333333;">elasticsearch</span> 
 <span style="color:#333333;">中。</span> 
</div> 
<p></p> 
<h3><span style="color:#333333;"><strong>4.1 </strong></span><span style="color:#333333;"><strong>使用</strong></span><span style="color:#333333;"><strong>mysql</strong></span><span style="color:#333333;"><strong>实现数据持久化</strong></span></h3> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">1</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">创建</span> 
 <span style="color:#333333;">mysql</span> 
 <span style="color:#333333;">数据环境</span> 
</div> 
<div></div> 
<pre><code class="language-XML">CREATE TABLE
IF
	NOT EXISTS zipkin_spans (
		`trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this
		means the trace uses 128 bit traceIds instead of 64 bit',
		`trace_id` BIGINT NOT NULL,
		`id` BIGINT NOT NULL,
		`name` VARCHAR ( 255 ) NOT NULL,
		`parent_id` BIGINT,
		`debug` BIT ( 1 ),
		`start_ts` BIGINT COMMENT 'Span.timestamp(): epoch micros used for endTs
		query and to implement TTL',
		`duration` BIGINT COMMENT 'Span.duration(): micros used for minDuration
		and maxDuration query' 
	) ENGINE = INNODB ROW_FORMAT = COMPRESSED CHARACTER 
	SET = utf8 COLLATE utf8_general_ci;
ALTER TABLE zipkin_spans ADD UNIQUE KEY ( `trace_id_high`, `trace_id`, `id` ) COMMENT 'ignore insert on duplicate';
ALTER TABLE zipkin_spans ADD INDEX ( `trace_id_high`, `trace_id`, `id` ) COMMENT 'for joining with zipkin_annotations';
ALTER TABLE zipkin_spans ADD INDEX ( `trace_id_high`, `trace_id` ) COMMENT 'for
getTracesByIds';
ALTER TABLE zipkin_spans ADD INDEX ( `name` ) COMMENT 'for getTraces and
getSpanNames';
ALTER TABLE zipkin_spans ADD INDEX ( `start_ts` ) COMMENT 'for getTraces
ordering and range';
CREATE TABLE
IF
	NOT EXISTS zipkin_annotations (
		`trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this
		means the trace uses 128 bit traceIds instead of 64 bit',
		`trace_id` BIGINT NOT NULL COMMENT 'coincides with
		zipkin_spans.trace_id',
		`span_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.id',
		`a_key` VARCHAR ( 255 ) NOT NULL COMMENT 'BinaryAnnotation.key or
		Annotation.value if type == -1',
		`a_value` BLOB COMMENT 'BinaryAnnotation.value(), which must be smaller
		than 64KB',
		`a_type` INT NOT NULL COMMENT 'BinaryAnnotation.type() or -1 if
		Annotation',
		`a_timestamp` BIGINT COMMENT 'Used to implement TTL;
	Annotation.timestamp or zipkin_spans.timestamp',
	`endpoint_ipv4` INT COMMENT 'Null when Binary/Annotation.endpoint is
	null',
	`endpoint_ipv6` BINARY ( 16 ) COMMENT 'Null when Binary/Annotation.endpoint
	is null, or no IPv6 address',
	`endpoint_port` SMALLINT COMMENT 'Null when Binary/Annotation.endpoint
	is null',
	`endpoint_service_name` VARCHAR ( 255 ) COMMENT 'Null when
	Binary/Annotation.endpoint is null' 
) ENGINE = INNODB ROW_FORMAT = COMPRESSED CHARACTER 
SET = utf8 COLLATE utf8_general_ci;
ALTER TABLE zipkin_annotations ADD UNIQUE KEY ( `trace_id_high`, `trace_id`, `span_id`, `a_key`, `a_timestamp` ) COMMENT 'Ignore insert on duplicate';
ALTER TABLE zipkin_annotations ADD INDEX ( `trace_id_high`, `trace_id`, `span_id` ) COMMENT 'for joining with zipkin_spans';
ALTER TABLE zipkin_annotations ADD INDEX ( `trace_id_high`, `trace_id` ) COMMENT 'for getTraces/ByIds';
ALTER TABLE zipkin_annotations ADD INDEX ( `endpoint_service_name` ) COMMENT 'for getTraces and getServiceNames';
ALTER TABLE zipkin_annotations ADD INDEX ( `a_type` ) COMMENT 'for getTraces';
ALTER TABLE zipkin_annotations ADD INDEX ( `a_key` ) COMMENT 'for getTraces';
ALTER TABLE zipkin_annotations ADD INDEX ( `trace_id`, `span_id`, `a_key` ) COMMENT 'for dependencies job';
CREATE TABLE
IF
	NOT EXISTS zipkin_dependencies ( `day` DATE NOT NULL, `parent` VARCHAR ( 255 ) NOT NULL, `child` VARCHAR ( 255 ) NOT NULL, `call_count` BIGINT ) ENGINE = INNODB ROW_FORMAT = COMPRESSED CHARACTER 
	SET = utf8 COLLATE utf8_general_ci;
ALTER TABLE zipkin_dependencies ADD UNIQUE KEY ( `day`, `parent`, `child` );</code></pre> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">2</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">在启动</span> 
 <span style="color:#333333;">ZipKin Server</span> 
 <span style="color:#333333;">的时候</span> 
 <span style="color:#333333;">,</span> 
 <span style="color:#333333;">指定数据保存的</span> 
 <span style="color:#333333;">mysql</span> 
 <span style="color:#333333;">的信息</span> 
</div> 
<div></div> 
<div> 
 <pre><code class="language-XML">java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=mysql --
MYSQL_HOST=127.0.0.1 --MYSQL_TCP_PORT=3306 --MYSQL_DB=zipkin --MYSQL_USER=root -
-MYSQL_PASS=root</code></pre> 
 <h3 style="background-color:transparent;"><span style="color:#333333;"><strong>4.2 </strong></span><span style="color:#333333;"><strong>使用</strong></span><span style="color:#333333;"><strong>elasticsearch</strong></span><span style="color:#333333;"><strong>实现数据持久化</strong></span></h3> 
</div> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">1</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">下载</span> 
 <span style="color:#333333;">elasticsearch</span> 
</div> 
<div></div> 
<div> 
 <span style="color:#333333;">下载地址：</span> 
 <span style="color:#4183c4;">https://www.elastic.co/cn/downloads/past-releases/elasticsearch-6-8-4</span> 
</div> 
<p> </p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">2</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">启动</span> 
 <span style="color:#333333;">elasticsearch</span> 
</div> 
<div> 
 <img alt="" height="182" src="https://images2.imgbox.com/6a/37/VyPAe7zv_o.png" width="676"> 
</div> 
<p> </p> 
<p> 访问：localhost:9200<img alt="" height="390" src="https://images2.imgbox.com/65/2a/JPRNBwwj_o.png" width="820"></p> 
<p>如果需要可视化，可以安装 Kibana</p> 
<p></p> 
<div> 
 <span style="color:#333333;">第</span> 
 <span style="color:#333333;">3</span> 
 <span style="color:#333333;">步</span> 
 <span style="color:#333333;">: </span> 
 <span style="color:#333333;">在启动</span> 
 <span style="color:#333333;">ZipKin Server</span> 
 <span style="color:#333333;">的时候，指定数据保存的</span> 
 <span style="color:#333333;">elasticsearch</span> 
 <span style="color:#333333;">的信息</span> 
</div> 
<pre><code class="hljs">java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=elasticsearch --ESHOST=localhost:9200</code></pre> 
<p></p> 
<p><strong>至于elasticsearch的可视化使用，可以参考：</strong><a href="https://blog.csdn.net/JFENG14/article/details/121852200" title="windows下Elasticsearch 的安装与使用，以及kibana的安装_windowskibanna-CSDN博客">windows下Elasticsearch 的安装与使用，以及kibana的安装_windowskibanna-CSDN博客</a></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9b2f73e59a98321dbff4ec93e5d58892/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Leetcode2542-最大子序列的分数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9657b75a04392b666a833c02439386a4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【LabVIEW学习篇 - 5】：数据类型——数值、字符串</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>