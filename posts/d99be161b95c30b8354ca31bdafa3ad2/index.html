<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spring Boot】网页五子棋项目实现，手把手带你全盘解析（长达两万3千字的干货，坐好了，要发车了......） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d99be161b95c30b8354ca31bdafa3ad2/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Spring Boot】网页五子棋项目实现，手把手带你全盘解析（长达两万3千字的干货，坐好了，要发车了......）">
  <meta property="og:description" content="目录 网页五子棋项目一、项目核心流程二、 登录模块2.1 前端输入用户信息2.2 后端进行数据库查询用户信息 三、 游戏大厅模块3.1 前端通过Ajax请求用户数据，后端从Session中拿取并从数据库中查询后返回3.2 前后端建立WebSocket连接，并进行判断，同时后端进行用户在线处理3.3 前端利用WebSocket发送按钮信息，后端进行等级队列的处理和维护游戏房间 四、游戏对局模块4.1 前端构造新的WebSocket连接,后端在等待两名玩家同时连接上服务器后开始游戏4.2 前端通过监听用户落子的下标返回给后端,后端维护一个二维数组来进行判断胜负并返回给前端 网页五子棋项目 一、项目核心流程 用户管理：使用服务器实现用户注册、登录功能，以及用户信息的管理，包括用户的天梯分数记录和比赛场次记录；
实时游戏互动：利用WebSocket技术实现客户端和服务器之间的实时通信，确保玩家的移动可以立即被对方看到，并由服务器进行处理；
匹配对战系统：设计一个机制以匹配具有相似技能水平的玩家进行对战。涉及到用户评分系统和等待室的实现，以便玩家可以根据自己的排名找到合适的对手；
游戏逻辑：使用服务器处理用户请求、维护游戏状态、执行匹配算法、管理用户会话以及提供必要的游戏逻辑支持，包括棋盘的初始化、落子规则的执行、胜负条件的判断以及棋局的更新显示；
界面设计：使用HTML、CSS和JavaScript技术构建用户友好的游戏界面，包括棋盘的可视化、棋子的放置和游戏状态的反馈；
数据库交互：使用数据库管理系统存储用户信息、游戏记录和其他相关数据，并提供数据的增删改查功能；
在接下来的流程中,我将项目分为了三个板块进行讲解,这样有利于大家的理解,分别是:
登录模块游戏大厅模块游戏对局模块 在这三个模块中以第一个模块最为简单，大家可以先提前适应一下，在2和3模块将会给大家上难度了
二、 登录模块 这个最为简单，只需要前端进行输入用户信息，后端进行数据处理并返回用户信息，前端以后端返回的数据为基础来判断是否要进行跳转进入游戏大厅界面。
前端输入用户信息，并判断数据正确性进行跳转后端进行数据库查询用户信息 2.1 前端输入用户信息 进行前端的界面构建，并提示用户输入信息
前端代码如下
&lt;!DOCTYPE html&gt; &lt;html lang=&#34;en&#34;&gt; &lt;head&gt; &lt;meta charset=&#34;UTF-8&#34;&gt; &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;IE=edge&#34;&gt; &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0&#34;&gt; &lt;title&gt;登录&lt;/title&gt; &lt;link rel=&#34;stylesheet&#34; href=&#34;css/common.css&#34;&gt; &lt;link rel=&#34;stylesheet&#34; href=&#34;css/login.css&#34;&gt; &lt;/head&gt; &lt;body&gt; &lt;div class=&#34;nav&#34;&gt; &lt;h3 class=&#34;pa&#34;&gt;五子棋对战&lt;/h3&gt; &lt;/div&gt; &lt;div class=&#34;login-container&#34;&gt; &lt;!-- 登录界面的对话框 --&gt; &lt;div class=&#34;login-dialog&#34;&gt; &lt;!-- 提示信息 --&gt; &lt;h3&gt;登录&lt;/h3&gt; &lt;!">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-22T19:18:45+08:00">
    <meta property="article:modified_time" content="2024-07-22T19:18:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spring Boot】网页五子棋项目实现，手把手带你全盘解析（长达两万3千字的干货，坐好了，要发车了......）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">网页五子棋项目</a></li><li><ul><li><a href="#_2" rel="nofollow">一、项目核心流程</a></li><li><a href="#__32" rel="nofollow">二、 登录模块</a></li><li><ul><li><a href="#21___38" rel="nofollow">2.1 前端输入用户信息</a></li><li><a href="#22___121" rel="nofollow">2.2 后端进行数据库查询用户信息</a></li></ul> 
   </li><li><a href="#__158" rel="nofollow">三、 游戏大厅模块</a></li><li><ul><li><a href="#31_AjaxSession_164" rel="nofollow">3.1 前端通过Ajax请求用户数据，后端从Session中拿取并从数据库中查询后返回</a></li><li><a href="#32__WebSocket_205" rel="nofollow">3.2 前后端建立WebSocket连接，并进行判断，同时后端进行用户在线处理</a></li><li><a href="#33___WebSocket_274" rel="nofollow">3.3 前端利用WebSocket发送按钮信息，后端进行等级队列的处理和维护游戏房间</a></li></ul> 
   </li><li><a href="#_589" rel="nofollow">四、游戏对局模块</a></li><li><ul><li><a href="#41__WebSocket_596" rel="nofollow">4.1 前端构造新的WebSocket连接,后端在等待两名玩家同时连接上服务器后开始游戏</a></li><li><a href="#42___722" rel="nofollow">4.2 前端通过监听用户落子的下标返回给后端,后端维护一个二维数组来进行判断胜负并返回给前端</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>网页五子棋项目</h2> 
<h3><a id="_2"></a>一、项目核心流程</h3> 
<ol><li> <p>用户管理：使用服务器实现用户注册、登录功能，以及用户信息的管理，包括用户的天梯分数记录和比赛场次记录；</p> </li><li> <p>实时游戏互动：利用WebSocket技术实现客户端和服务器之间的实时通信，确保玩家的移动可以立即被对方看到，并由服务器进行处理；</p> </li><li> <p>匹配对战系统：设计一个机制以匹配具有相似技能水平的玩家进行对战。涉及到用户评分系统和等待室的实现，以便玩家可以根据自己的排名找到合适的对手；</p> </li><li> <p>游戏逻辑：使用服务器处理用户请求、维护游戏状态、执行匹配算法、管理用户会话以及提供必要的游戏逻辑支持，包括棋盘的初始化、落子规则的执行、胜负条件的判断以及棋局的更新显示；</p> </li><li> <p>界面设计：使用HTML、CSS和JavaScript技术构建用户友好的游戏界面，包括棋盘的可视化、棋子的放置和游戏状态的反馈；</p> </li><li> <p>数据库交互：使用数据库管理系统存储用户信息、游戏记录和其他相关数据，并提供数据的增删改查功能；</p> </li></ol> 
<p>在接下来的流程中,我将项目分为了三个板块进行讲解,这样有利于大家的理解,分别是:</p> 
<ol><li><strong>登录模块</strong></li><li><strong>游戏大厅模块</strong></li><li><strong>游戏对局模块</strong></li></ol> 
<p>在这三个模块中以第一个模块最为简单，大家可以先提前适应一下，在2和3模块将会给大家上难度了</p> 
<h3><a id="__32"></a>二、 登录模块</h3> 
<p>这个最为简单，只需要前端进行输入用户信息，后端进行数据处理并返回用户信息，前端以后端返回的数据为基础来判断是否要进行跳转进入游戏大厅界面。</p> 
<ol><li>前端输入用户信息，并判断数据正确性进行跳转</li><li>后端进行数据库查询用户信息</li></ol> 
<h4><a id="21___38"></a>2.1 前端输入用户信息</h4> 
<p>进行前端的界面构建，并提示用户输入信息<br> <img src="https://images2.imgbox.com/9b/cf/7BnIG79L_o.png" alt="在这里插入图片描述"><br> 前端代码如下</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>head<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"X-UA-Compatible"</span> content<span class="token operator">=</span><span class="token string">"IE=edge"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>title<span class="token punctuation">&gt;</span></span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"css/common.css"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"css/login.css"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>body<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"nav"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h3 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"pa"</span><span class="token operator">&gt;</span>五子棋对战<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"login-container"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 登录界面的对话框 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"login-dialog"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 提示信息 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>h3<span class="token punctuation">&gt;</span></span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 这个表示一行 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>span<span class="token punctuation">&gt;</span></span>用户名<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> id<span class="token operator">=</span><span class="token string">"username"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 这是另一行 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">&gt;</span>
                <span class="token generics"><span class="token punctuation">&lt;</span>span<span class="token punctuation">&gt;</span></span>密码<span class="token operator">:</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"password"</span> id<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 提交按钮 <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>提交<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"./js/jquery.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>script<span class="token punctuation">&gt;</span></span>
        let usernameInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#username'<span class="token punctuation">)</span><span class="token punctuation">;</span>
        let passwordInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#password'<span class="token punctuation">)</span><span class="token punctuation">;</span>
        let submitButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#submit'<span class="token punctuation">)</span><span class="token punctuation">;</span>
        submitButton<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                type<span class="token operator">:</span> <span class="token char">'post'</span><span class="token punctuation">,</span>
                url<span class="token operator">:</span> <span class="token char">'/login'</span><span class="token punctuation">,</span>
                data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    username<span class="token operator">:</span> usernameInput<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                    password<span class="token operator">:</span> passwordInput<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                success<span class="token operator">:</span> <span class="token function">function</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 请求执行成功之后的回调函数</span>
                    <span class="token comment">// 判定当前是否登录成功~</span>
                    <span class="token comment">// 如果登录成功, 服务器会返回当前的 User 对象. </span>
                    <span class="token comment">// 如果登录失败, 服务器会返回一个空的 User 对象. </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span> body<span class="token punctuation">.</span>userId <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 登录成功</span>
                        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"登录成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 重定向跳转到 "游戏大厅页面".</span>
                        location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>'<span class="token operator">/</span>game_hall<span class="token punctuation">.</span>html'<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"登录失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                error<span class="token operator">:</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 请求执行失败之后的回调函数</span>
                    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"登录失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> 
<p>在代码中可以看到，如果后端返回的数据类型为空或者为其他类型，前端则进行提示错误，提示用户输入正确的用户名和密码。</p> 
<h4><a id="22___121"></a>2.2 后端进行数据库查询用户信息</h4> 
<p>后端根据前端发出的响应，对拿到的前端的用户名在数据库中进行查找，与用户输入的密码比对是否正确，正确则返回用户的完整信息，并且将该用户的信息存储到服务器的Session中，以便在接下来游戏大厅的获取信息做准备。</p> 
<p>后端代码如下：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">login</span><span class="token punctuation">(</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//判断传进来的是否为空字符串</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token operator">||</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//从数据库中取出该用户的用户信息</span>
        <span class="token class-name">UserInfo</span> user<span class="token operator">=</span>userService<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//判断用户信息是否正确</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//不正确则返回空对象</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"用户登录失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//用户信息正确</span>
        <span class="token comment">//将用户信息存储在Session中</span>
        <span class="token class-name">HttpSession</span> httpSession <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"==============================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span>  user<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

</code></pre> 
<h3><a id="__158"></a>三、 游戏大厅模块</h3> 
<p>接下来我们开始进入主题，开始正式上难度，游戏大厅的流程如下：</p> 
<ol><li>前端通过Ajax请求用户数据，后端从Session中拿取并从数据库中查询后返回</li><li>前后端建立WebSocket连接，并进行判断，同时后端进行用户在线处理</li><li>前端利用WebSocket发送按钮信息，后端进行等级队列的处理和维护游戏房间</li></ol> 
<h4><a id="31_AjaxSession_164"></a>3.1 前端通过Ajax请求用户数据，后端从Session中拿取并从数据库中查询后返回</h4> 
<p>前端请求后端该用户的数据信息，后端根据登录时存储的Session信息，拿到用户Id,根据用户Id进入数据库中进行查找，并返回给前端进行界面用户信息的显示<br> <img src="https://images2.imgbox.com/82/81/cpDVoueN_o.png" alt="在这里插入图片描述"></p> 
<p>前端代码Ajax请求如下：</p> 
<pre><code class="prism language-java">$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            type<span class="token operator">:</span> <span class="token char">'get'</span><span class="token punctuation">,</span>
            url<span class="token operator">:</span> '<span class="token operator">/</span>userInfo'<span class="token punctuation">,</span>
            success<span class="token operator">:</span> <span class="token function">function</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                let screenDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#screen'<span class="token punctuation">)</span><span class="token punctuation">;</span>
                screenDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token char">'玩家: '</span> <span class="token operator">+</span> body<span class="token punctuation">.</span>username <span class="token operator">+</span> <span class="token string">" 分数: "</span> <span class="token operator">+</span> body<span class="token punctuation">.</span>score 
                    <span class="token operator">+</span> <span class="token string">"&lt;br&gt; 比赛场次: "</span> <span class="token operator">+</span> body<span class="token punctuation">.</span>totalCount <span class="token operator">+</span> <span class="token string">" 获胜场数: "</span> <span class="token operator">+</span> body<span class="token punctuation">.</span>winCount
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            error<span class="token operator">:</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"获取用户信息失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>后端根据前端的请求进行数据查询并返回：<br> 后端该部分代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/userInfo"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span>  <span class="token class-name">Object</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HttpSession</span> httpSession <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 拿着这个 user 对象, 去数据库中找, 找到最新的数据</span>
            <span class="token class-name">UserInfo</span> newUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> newUser<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/f9/21ShTLQl_o.png" alt="在这里插入图片描述"><br> 如图可见，已经显示出了该用户的数据库信息</p> 
<h4><a id="32__WebSocket_205"></a>3.2 前后端建立WebSocket连接，并进行判断，同时后端进行用户在线处理</h4> 
<p>什么是WebSocket？其实他的底层原理是Tcp来实现的，作用也和Tcp类似，都是用来建立一个传输通道，进行数据传输，在建立通道前由前端发送一个请求，这时服务器建立连接后应该返回一个类似于Ack的应答报文来告诉前端，咱俩已经连接成功了，可以发送信息了。</p> 
<p>前端发送WebSocket连接请求代码如下：</p> 
<pre><code class="prism language-java"> <span class="token comment">// 此处进行初始化 websocket, 并且实现前端的匹配逻辑. </span>
        <span class="token comment">// 此处的路径必须写作 /findMatch, 千万不要写作 /findMatch/ </span>
        let websocketUrl <span class="token operator">=</span> <span class="token char">'ws://'</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>host <span class="token operator">+</span> '<span class="token operator">/</span>findMatch'<span class="token punctuation">;</span>
        let websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>websocketUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        websocket<span class="token punctuation">.</span>onopen <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onopen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        websocket<span class="token punctuation">.</span>onclose <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onclose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        websocket<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onerror"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 监听页面关闭事件. 在页面关闭之前, 手动调用这里的 websocket 的 close 方法. </span>
        window<span class="token punctuation">.</span>onbeforeunload <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        
</code></pre> 
<p>同时后端在建立请求时要进行一个逻辑的判断，通过维护一个Hash表，Key存储的是用户的Id,Value存储的是用户用来建立连接时WebSocketSession，然后就可以通过前端传入的用户Id在后端进行查询，如果查询到了，那么就意味着该用户已经登录了，没查询到的话就把该用户的信息放进去，表示该用户现在是在线状态。</p> 
<p>后端进行连接处理的代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 玩家上线, 加入到 OnlineUserManager 中</span>


        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//  先判定当前用户是否已经登录过(已经是在线状态), 如果是已经在线, 就不该继续进行后续逻辑.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameHall</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                    <span class="token operator">||</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameRoom</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token comment">// 当前用户已经登录了!!针对这个情况要告知客户端, 你这里重复登录了.</span>
                <span class="token class-name">MatchResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"当前禁止多开!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"repeatConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 拿到了身份信息之后, 就把玩家设置成在线状态了</span>
            onlineUserManagerService<span class="token punctuation">.</span><span class="token function">enterGameHall</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 进入游戏大厅!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[MatchAPI.afterConnectionEstablished] 当前用户未登录!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 出现空指针异常, 说明当前用户的身份信息是空, 用户未登录呢.</span>
            <span class="token comment">// 把当前用户尚未登录这个信息给返回回去</span>
            <span class="token class-name">MatchResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"您尚未登录! 不能进行后续匹配功能!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="33___WebSocket_274"></a>3.3 前端利用WebSocket发送按钮信息，后端进行等级队列的处理和维护游戏房间</h4> 
<p>在WebSocket确定前后端已经建立好通道好就可以发送信息了，如下图可见，前端一共有两个按钮，一个是开始匹配，一个是停止匹配，前端通过用户点击的按钮来构建不同的数据通够WebSocket来发送给后端进行一个数据的处理<br> <img src="https://images2.imgbox.com/53/01/wO43w5lE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/95/vgBAW02M_o.png" alt="在这里插入图片描述"><br> 前端发送不同按钮信息的代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// 一会重点来实现, 要处理服务器返回的响应</span>
        websocket<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 处理服务器返回的响应数据. 这个响应就是针对 "开始匹配" / "结束匹配" 来对应的</span>
            <span class="token comment">// 解析得到的响应对象. 返回的数据是一个 JSON 字符串, 解析成 js 对象</span>
            let resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            let matchButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#match<span class="token operator">-</span>button'<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resp<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"游戏大厅中接收到了失败响应! "</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> 'startMatch'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 开始匹配请求发送成功</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"进入匹配队列成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                matchButton<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> '匹配中<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span>点击停止<span class="token punctuation">)</span>'
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> 'stopMatch'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 结束匹配请求发送成功</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"离开匹配队列成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                matchButton<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token char">'开始匹配'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> 'matchSuccess'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 已经匹配到对手了. </span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"匹配到对手! 进入游戏房间!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// location.assign("/game_room.html");</span>
                location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/game_room.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> 'repeatConnection'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"当前检测到多开! 请使用其他账号登录!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"收到了非法的响应! message="</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 给匹配按钮添加一个点击事件</span>
        let matchButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#match<span class="token operator">-</span>button'<span class="token punctuation">)</span><span class="token punctuation">;</span>
        matchButton<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 在触发 websocket 请求之前, 先确认下 websocket 连接是否好着呢~~ </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>websocket<span class="token punctuation">.</span>readyState <span class="token operator">==</span> websocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果当前 readyState 处在 OPEN 状态, 说明连接好着的~</span>
                <span class="token comment">// 这里发送的数据有两种可能, 开始匹配/停止匹配~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>matchButton<span class="token punctuation">.</span>innerHTML <span class="token operator">==</span> <span class="token char">'开始匹配'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始匹配"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                        message<span class="token operator">:</span> 'startMatch'<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>matchButton<span class="token punctuation">.</span>innerHTML <span class="token operator">==</span> '匹配中<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span>点击停止<span class="token punctuation">)</span>'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"停止匹配"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                        message<span class="token operator">:</span> 'stopMatch'<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 这是说明连接当前是异常的状态</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"当前您的连接已经断开! 请重新登录!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>'<span class="token operator">/</span>login<span class="token punctuation">.</span>html'<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>以上处理完毕后，开始由后端开始接收数据，进行一个数据处理的过程：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">,</span> <span class="token class-name">TextMessage</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 实现处理开始匹配请求和处理停止匹配请求.</span>
        <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取到客户端给服务器发送的数据</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 数据载荷是一个 JSON 格式的字符串, 就需要把它转成 Java 对象. MatchRequest</span>
        <span class="token class-name">MatchRequest</span> request <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token class-name">MatchRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MatchResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"startMatch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 进入匹配队列</span>
            matcherService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 把玩家信息放入匹配队列之后, 就可以返回一个响应给客户端了.</span>
            response<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"startMatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"stopMatch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 退出匹配队列</span>
            matcherService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 移除之后, 就可以返回一个响应给客户端了.</span>
            response<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"stopMatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            response<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"非法的匹配请求"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在该段代码中的主要部分是进行一个等级队列的处理，以及对游戏房间的维护有以下两部分组成：</p> 
<ol><li><strong>天梯分数进行分级</strong></li></ol> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">MatchResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">UserInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">TextMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">WebSocketSession</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Queue</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatcherService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OnlineUserManagerService</span> onlineUserManagerService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RoomManagerService</span> roomManagerService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> normalQueue<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> middleQueue<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> highQueue<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 操作匹配队列的方法.</span>
    <span class="token comment">// 把玩家放到匹配队列中</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>normalQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                normalQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                normalQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 加入到了 normalQueue 中!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2000</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>middleQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                middleQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                middleQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 加入到了 highQueue 中!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>highQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                highQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                highQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 加入到了 veryHighQueue 中!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 当玩家点击停止匹配的时候, 就需要把玩家从匹配队列中删除</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>normalQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                normalQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 移除了 normalQueue!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2000</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>middleQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                middleQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 移除了 highQueue!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>highQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                highQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 移除了 veryHighQueue!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">MatcherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Thread</span> t1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">handlerMatch</span><span class="token punctuation">(</span>normalQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">handlerMatch</span><span class="token punctuation">(</span>middleQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">handlerMatch</span><span class="token punctuation">(</span>highQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlerMatch</span><span class="token punctuation">(</span><span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfo</span><span class="token punctuation">&gt;</span></span> matchQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>matchQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span>matchQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 尝试从队列中取出两个玩家</span>
                <span class="token class-name">UserInfo</span> player1 <span class="token operator">=</span> matchQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">UserInfo</span> player2 <span class="token operator">=</span> matchQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"匹配出两个玩家: "</span> <span class="token operator">+</span> player1<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> player2<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//  获取到玩家的 websocket 的会话</span>
                <span class="token comment">//    获取到会话的目的是为了告诉玩家, 你排到了~~</span>
                <span class="token class-name">WebSocketSession</span> session1 <span class="token operator">=</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameHall</span><span class="token punctuation">(</span>player1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">WebSocketSession</span> session2 <span class="token operator">=</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameHall</span><span class="token punctuation">(</span>player2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 前面的逻辑里进行了处理, 当玩家断开连接的时候就把玩家从匹配队列中移除了.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果玩家1 现在不在线了, 就把玩家2 重新放回到匹配队列中</span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>player2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session2 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果玩家2 现在下线了, 就把玩家1 重新放回匹配队列中</span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>player1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> session2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 把其中的一个玩家放回匹配队列.</span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>player1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//  把这两个玩家放到一个游戏房间中.</span>
                <span class="token class-name">RoomService</span> roomService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoomService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                roomManagerService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>roomService<span class="token punctuation">,</span> player1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> player2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token comment">//    此处是要给两个玩家都返回 "匹配成功" 这样的信息.</span>
                <span class="token comment">//    因此就需要返回两次</span>
                <span class="token class-name">MatchResponse</span> response1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response1<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response1<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"matchSuccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> json1 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                session1<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>json1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">MatchResponse</span> response2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response2<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response2<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"matchSuccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> json2 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                session2<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>json2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>这里的代码至关重要，我这里是根据用户天梯分数的不同来划分出来三个队列，分别是normalQueue、middleQueue、以及highQueue，然后将该用户放入队列中，通过创建三个线程来同时扫描这三个不同队列，这里请同学们一定要注意线程安全的问题，当线程扫描该队列时如果该队列内有没两个用户则线程等待，直到有用户再次放入时唤醒线程，当扫描时发现队列中有两个以上玩家，则将这两名用户进行游戏房间的维护，这是在第二段代码中了。</strong></p> 
<ol start="2"><li><strong>游戏房间的初步维护</strong></li></ol> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoomManagerService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RoomService</span><span class="token punctuation">&gt;</span></span>rooms<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>userIdToRoomID<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">RoomService</span> roomService<span class="token punctuation">,</span> <span class="token class-name">Integer</span> userId1<span class="token punctuation">,</span> <span class="token class-name">Integer</span> userId2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rooms<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>roomService<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> roomService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userIdToRoomID<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId1<span class="token punctuation">,</span> roomService<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userIdToRoomID<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId2<span class="token punctuation">,</span> roomService<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> roomId <span class="token punctuation">,</span><span class="token class-name">Integer</span> userId1<span class="token punctuation">,</span> <span class="token class-name">Integer</span> userId2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        rooms<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userIdToRoomID<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userIdToRoomID<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RoomService</span> <span class="token function">getRoomByRoomId</span><span class="token punctuation">(</span><span class="token class-name">String</span> roomId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">return</span>  rooms<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">RoomService</span> <span class="token function">getRoomByUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> roomId<span class="token operator">=</span>userIdToRoomID<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>roomId<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>  rooms<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><strong>以上代码的主要意义：维护一个游戏房间，在里面创建两个Hash表，因为前面我们使用的并发编程，考虑到线程安全问题，这里我们通过使用ConcurrentHashMap来创建Hash表结构，然后通过UUid来给该房间生成一个唯一的房间id,然后Key设置为该房间Id,Value则设置成Room实体类，里面存储了这两个用户的ID，方便我们后续的操作，当两名用户放入游戏房间后,通过获取存储的UserId来获取该用户的WebSocketSession，然后将这个信息分别返回给这两名用户。</strong></p> 
<p>再后端处理完数据返回给前端之后，前端对后端的数据进行判定，如果数据正确则会进行页面跳转，开始进入游戏页面——game_room页面。</p> 
<h3><a id="_589"></a>四、游戏对局模块</h3> 
<p>游戏对局模块至关重要,主要是将两名玩家在前端的下棋构造成一个响应返回给后端,在后端处理完成之后在返回给前端,前端根据数据来构造棋子显示在页面之上.</p> 
<p>主要分为以下几大步骤:</p> 
<ol><li><strong>前端构造新的WebSocket连接,后端在等待两名玩家同时连接上服务器后开始游戏</strong></li><li><strong>前端通过监听用户落子的下标返回给后端,后端维护一个二维数组来进行判断胜负并返回给前端</strong></li></ol> 
<h4><a id="41__WebSocket_596"></a>4.1 前端构造新的WebSocket连接,后端在等待两名玩家同时连接上服务器后开始游戏</h4> 
<p>前端代码如下:</p> 
<pre><code class="prism language-java"><span class="token comment">// 此处写的路径要写作 /game, 不要写作 /game/</span>
let websocketUrl <span class="token operator">=</span> <span class="token string">"ws://"</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>host <span class="token operator">+</span> <span class="token string">"/game"</span><span class="token punctuation">;</span>
let websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>websocketUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

websocket<span class="token punctuation">.</span>onopen <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"连接游戏房间成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

websocket<span class="token punctuation">.</span>close <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"和游戏服务器断开连接!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

websocket<span class="token punctuation">.</span>onerror <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"和服务器的连接出现异常!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span>onbeforeunload <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>前端game_room.html通过重新创建一个WebSocke通道来进行用户下子的数据传输.</strong></p> 
<p>后端代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name">WebSocketSession</span> session<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">GameReadyResponse</span> readyResponse<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">GameReadyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserInfo</span> user<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserInfo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 先获取到用户的身份信息. (从 HttpSession 里拿到当前用户的对象)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"用户未登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RoomService</span> roomService <span class="token operator">=</span> roomManagerService<span class="token punctuation">.</span><span class="token function">getRoomByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//  判定当前用户是否已经进入房间. (拿着房间管理器进行查询)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>roomService <span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"用户未匹配到"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  判定当前是不是多开 (该用户是不是已经在其他地方进入游戏了)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameHall</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">||</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameRoom</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            readyResponse<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"禁止多开游戏页面"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"repeatConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  设置当前玩家上线!</span>
        onlineUserManagerService<span class="token punctuation">.</span><span class="token function">enterGameRoom</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//  把两个玩家加入到游戏房间中.</span>
        <span class="token comment">//    前面的创建房间/匹配过程, 是在 game_hall.html 页面中完成的.</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>roomService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>roomService<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 第一个玩家还尚未加入房间.</span>
                <span class="token comment">// 就把当前连上 websocket 的玩家作为 user1, 加入到房间中.</span>
                roomService<span class="token punctuation">.</span><span class="token function">setUser1</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 把先连入房间的玩家作为先手方.</span>
                roomService<span class="token punctuation">.</span><span class="token function">setWhiteUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 已经准备就绪! 作为玩家1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>roomService<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果进入到这个逻辑, 说明玩家1 已经加入房间, 现在要给当前玩家作为玩家2 了</span>
                roomService<span class="token punctuation">.</span><span class="token function">setUser2</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 已经准备就绪! 作为玩家2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 当两个玩家都加入成功之后, 就要让服务器, 给这两个玩家都返回 websocket 的响应数据.</span>
                <span class="token comment">// 通知这两个玩家说, 游戏双方都已经准备好了.</span>
                <span class="token function">noticeGameReady</span><span class="token punctuation">(</span>roomService<span class="token punctuation">,</span> roomService<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> roomService<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">noticeGameReady</span><span class="token punctuation">(</span>roomService<span class="token punctuation">,</span> roomService<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> roomService<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  此处如果又有玩家尝试连接同一个房间, 就提示报错.</span>
        <span class="token comment">//    这种情况理论上是不存在的, 为了让程序更加的健壮, 还是做一个判定和提示.</span>
        readyResponse<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        readyResponse<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">"当前房间已满, 您不能加入房间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">noticeGameReady</span><span class="token punctuation">(</span><span class="token class-name">RoomService</span> roomService<span class="token punctuation">,</span> <span class="token class-name">UserInfo</span> thisUser<span class="token punctuation">,</span> <span class="token class-name">UserInfo</span> thatUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">GameReadyResponse</span> gameReadyResponse<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">GameReadyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"gameReady"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setOk</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setRoomId</span><span class="token punctuation">(</span>roomService<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setThisUserId</span><span class="token punctuation">(</span>thisUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setThatUserId</span><span class="token punctuation">(</span>thatUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameReadyResponse<span class="token punctuation">.</span><span class="token function">setWhiteUser</span><span class="token punctuation">(</span>roomService<span class="token punctuation">.</span><span class="token function">getWhiteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WebSocketSession</span> session<span class="token operator">=</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameRoom</span><span class="token punctuation">(</span>thisUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>gameReadyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>当两名玩家进入游戏房间后,开始操作,注意我这里的先手玩家和后手玩家的判定是根据用户先进入房间的顺序,通过将先进入房间的顺序来决定先后手的,那么该如何告诉前端该先后手的顺序呢?这里我采用的是通过构建实体类将先手的UserId传给前端,然后前端进行判定同时进行不同的页面显示,并且在后端返回数据之后构建出了一张棋盘显示给用户.</strong><br> <img src="https://images2.imgbox.com/67/fa/4c8SiYUX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="42___722"></a>4.2 前端通过监听用户落子的下标返回给后端,后端维护一个二维数组来进行判断胜负并返回给前端</h4> 
<p>前端代码如下:</p> 
<pre><code class="prism language-java"> <span class="token comment">// 之前 websocket.onmessage 主要是用来处理了游戏就绪响应. 在游戏就绪之后, 初始化完毕之后, 也就不再有这个游戏就绪响应了. </span>
    <span class="token comment">// 就在这个 initGame 内部, 修改 websocket.onmessage 方法~~, 让这个方法里面针对落子响应进行处理!</span>
    websocket<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[handlerPutChess] "</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        let resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">!=</span> 'putChess'<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"响应类型错误!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 先判定当前这个响应是自己落的子, 还是对方落的子.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>userId <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thisUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 我自己落的子</span>
            <span class="token comment">// 根据我自己子的颜色, 来绘制一个棋子</span>
            <span class="token function">oneStep</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>row<span class="token punctuation">,</span> gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>userId <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thatUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 我的对手落的子</span>
            <span class="token function">oneStep</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>row<span class="token punctuation">,</span> <span class="token operator">!</span>gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 响应错误! userId 是有问题的!</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>'<span class="token punctuation">[</span>handlerPutChess<span class="token punctuation">]</span> resp userId 错误<span class="token operator">!</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 给对应的位置设为 1, 方便后续逻辑判定当前位置是否已经有子了. </span>
        chessBoard<span class="token punctuation">[</span>resp<span class="token punctuation">.</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// 交换双方的落子轮次</span>
        me <span class="token operator">=</span> <span class="token operator">!</span>me<span class="token punctuation">;</span>
        <span class="token function">setScreenText</span><span class="token punctuation">(</span>me<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判定游戏是否结束</span>
        let screenDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'#screen'<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thisUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// alert('你赢了!');</span>
                screenDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token char">'你赢了!'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner <span class="token operator">=</span> gameInfo<span class="token punctuation">.</span>thatUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// alert('你输了!');</span>
                screenDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token char">'你输了!'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"winner 字段错误! "</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span>winner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 回到游戏大厅</span>
            <span class="token comment">// location.assign('/game_hall.html');</span>

            <span class="token comment">// 增加一个按钮, 让玩家点击之后, 再回到游戏大厅~</span>
            let backBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token char">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//let backBtn = document.querySelector('button');</span>
            backBtn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token char">'返回游戏大厅'</span><span class="token punctuation">;</span>
            backBtn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>'<span class="token operator">/</span>game_hall<span class="token punctuation">.</span>html'<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            let fatherDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>'<span class="token punctuation">.</span>container<span class="token operator">&gt;</span>div'<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fatherDiv<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>backBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>前端也创建一个二维的数组用于记录该坐标是否有棋子,前端通过监听用户的鼠标点击位置来确定坐标,然后在二维数组中查询该坐标是否有棋子,若无则将该下子请求返回给后端,等待后端处理结果后在进行响应.</strong></p> 
<p>后端代码如下:</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span></span><span class="token class-name">GoBangProjectApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">UserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">GameRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">GameResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gobangproject<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">UserInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">TextMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">WebSocketSession</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Slf4j</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoomService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> roomId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfo</span> user1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfo</span> user2<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token keyword">int</span> whiteUser<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">RoomManagerService</span> roomManagerService<span class="token punctuation">;</span>

    <span class="token keyword">private</span>  <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">OnlineUserManagerService</span> onlineUserManagerService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_ROW</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_COL</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>board<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token constant">MAX_ROW</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">MAX_COL</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RoomService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>roomId<span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        userMapper<span class="token operator">=</span><span class="token class-name">GoBangProjectApplication</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">UserMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        roomManagerService <span class="token operator">=</span><span class="token class-name">GoBangProjectApplication</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RoomManagerService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        onlineUserManagerService <span class="token operator">=</span> <span class="token class-name">GoBangProjectApplication</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">OnlineUserManagerService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        objectMapper<span class="token operator">=</span><span class="token class-name">GoBangProjectApplication</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putChess</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

         <span class="token class-name">GameRequest</span> request<span class="token operator">=</span>objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span><span class="token class-name">GameRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">GameResponse</span> response<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">GameResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">int</span> chess<span class="token operator">=</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
         <span class="token keyword">int</span> row<span class="token operator">=</span>request<span class="token punctuation">.</span><span class="token function">getRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">int</span> col<span class="token operator">=</span>request<span class="token punctuation">.</span><span class="token function">getCol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
             <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前位置 ("</span> <span class="token operator">+</span> row <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> col <span class="token operator">+</span> <span class="token string">") 已经有子了!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span><span class="token punctuation">;</span>

         <span class="token punctuation">}</span>
         board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token operator">=</span>chess<span class="token punctuation">;</span>


        <span class="token function">printBoard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 进行胜负判定</span>
        <span class="token keyword">int</span> winner <span class="token operator">=</span> <span class="token function">checkWinner</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> chess<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 给房间中的所有客户端都返回响应.</span>
        response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"putChess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRow</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCol</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setWinner</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">WebSocketSession</span> session1 <span class="token operator">=</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameRoom</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebSocketSession</span> session2 <span class="token operator">=</span> onlineUserManagerService<span class="token punctuation">.</span><span class="token function">getFromGameRoom</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 玩家1 已经下线了. 直接认为玩家2 获胜!</span>
            response<span class="token punctuation">.</span><span class="token function">setWinner</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家1 掉线!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session2 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 玩家2 已经下线. 直接认为玩家1 获胜!</span>
            response<span class="token punctuation">.</span><span class="token function">setWinner</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家2 掉线!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 把响应构造成 JSON 字符串, 通过 session 进行传输.</span>
        <span class="token class-name">String</span> respJson <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            session1<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>respJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            session2<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>respJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  如果当前胜负已分, 就可以直接把房间从房间管理器中给移除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 胜负已分</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"游戏结束! 房间即将销毁! roomId="</span> <span class="token operator">+</span> roomId <span class="token operator">+</span> <span class="token string">" 获胜方为: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新获胜方和失败方的信息.</span>
            <span class="token keyword">int</span> winUserId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> loseUserId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userMapper<span class="token punctuation">.</span><span class="token function">userWin</span><span class="token punctuation">(</span>winUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userMapper<span class="token punctuation">.</span><span class="token function">userLose</span><span class="token punctuation">(</span>loseUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 销毁房间</span>
            roomManagerService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>roomId<span class="token punctuation">,</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printBoard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 打印出棋盘</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[打印棋盘信息] "</span> <span class="token operator">+</span> roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"====================================================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token constant">MAX_ROW</span><span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> <span class="token constant">MAX_COL</span><span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 针对一行之内的若干列, 不要打印换行</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>board<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 每次遍历完一行之后, 再打印换行.</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"====================================================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 约定如果玩家1 获胜, 就返回玩家1 的 userId</span>
    <span class="token comment">// 如果玩家2 获胜, 就返回玩家2 的 userId</span>
    <span class="token comment">// 如果胜负未分, 就返回 0</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">checkWinner</span><span class="token punctuation">(</span><span class="token keyword">int</span> row<span class="token punctuation">,</span> <span class="token keyword">int</span> col<span class="token punctuation">,</span> <span class="token keyword">int</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查所有的行</span>
        <span class="token comment">//    先遍历这五种情况</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> c <span class="token operator">=</span> col <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> c <span class="token operator">&lt;=</span> col<span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 针对其中的一种情况, 来判定这五个子是不是连在一起了~</span>
            <span class="token comment">// 不光是这五个子得连着, 而且还得和玩家落的子是一样~~ (才算是获胜)</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//  胜负已分!</span>
                    <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 检查所有列</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> row <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> r <span class="token operator">&lt;=</span> row<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  检查左对角线</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> row <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> c <span class="token operator">=</span> col <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> r <span class="token operator">&lt;=</span> row <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> col<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">,</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//  检查右对角线</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> r <span class="token operator">=</span> row <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> c <span class="token operator">=</span> col <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span> r <span class="token operator">&lt;=</span> row <span class="token operator">&amp;&amp;</span> c <span class="token operator">&gt;=</span> col<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">,</span> c<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>r <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>c <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 胜负未分, 就直接返回 0 了.</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>以上后端代码在接收到前端的下子请求后,会在后端相应的构造出一个二维数组,然后对该数组进行判断,根据传入的该棋子的下标,分别检索其上、下、左对角线、右对角线来判定有无胜负，若未分出胜负则返回0，user1获胜返回该用户id，user2同理，</strong></p> 
<p>结果如下图所示：<br> <img src="https://images2.imgbox.com/5e/26/ZlsuhWUG_o.png" alt="在这里插入图片描述"></p> 
<p>在后端进行判定出胜负之后，不要忘记了对这两名用户的数据修改，修改后如下图所示：</p> 
<p><img src="https://images2.imgbox.com/7d/92/JLUDnsA4_o.png" alt="在这里插入图片描述"><br> 到此，我们的网页五子棋项目算是落下了真正的帷幕，希望小伙伴们能够理解。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c25791d1f81f6e2a1630a77f8dd3aabd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nfs和web服务器的搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/54d5e67cc71671b62bbeec514802e050/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Spring Boot】网页五子棋项目中遇到的困难及解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>