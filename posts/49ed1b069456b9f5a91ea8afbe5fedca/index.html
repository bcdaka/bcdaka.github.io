<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【微服务】Spring Cloud Bus的注意事项和常用案例 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/49ed1b069456b9f5a91ea8afbe5fedca/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【微服务】Spring Cloud Bus的注意事项和常用案例">
  <meta property="og:description" content="文章目录 强烈推荐引言关键方面注意事项1. 消息代理选择2. 消息队列配置3. 消息持久化4. 幂等性5. 安全性6. 消息大小7. 性能监控8. 错误处理9. 版本兼容性10. 测试11. 配置同步12. 日志记录 常用示例示例 1: 配置同步配置服务器 (`config-server`)客户端服务 (`client-service`)触发配置刷新 示例 2: 事件广播示例 3: Spring Cloud Bus 整合 RabbitMQ 总结强烈推荐专栏集锦写在最后 强烈推荐 前些天发现了一个巨牛的人工智能学习网站，通俗易懂，风趣幽默，忍不住分享一下给大家。点击跳转到网站:人工智能
引言 Spring Cloud Bus 是 Spring Cloud 框架中的一个强大功能，它通过轻量级消息代理（如 RabbitMQ 或 Kafka）连接分布式系统（通常是微服务）。它有助于在微服务架构的不同部分之间进行通信，并有助于跨集群传播状态变化。
关键方面 以下是 Spring Cloud Bus 的一些关键方面：
事件传播：
它使用消息代理来传播配置更改和其他状态更改，确保在不同的微服务实例之间保持一致性。
集中配置管理：
结合 Spring Cloud Config，Spring Cloud Bus 可以在不重启应用程序的情况下刷新多个应用程序实例的配置。例如，当在集中配置库中更新配置属性时，Spring Cloud Bus 可以将更改广播到所有相关服务。
可扩展性：
通过利用消息代理，Spring Cloud Bus 允许在分布式系统中进行可扩展的通信。这在大规模系统中尤为有用，因为服务之间的直接通信可能效率不高。
实现：
要实现 Spring Cloud Bus，通常需要在 Spring Boot 应用程序中包含相关依赖项，配置消息代理，并使用注解标记需要传播的配置更改或事件。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-24T00:30:21+08:00">
    <meta property="article:modified_time" content="2024-07-24T00:30:21+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【微服务】Spring Cloud Bus的注意事项和常用案例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#font_colordd0000font_6" rel="nofollow"><font color="#dd0000">强烈推荐</font></a></li><li><a href="#_20" rel="nofollow">引言</a></li><li><a href="#_30" rel="nofollow">关键方面</a></li><li><a href="#_56" rel="nofollow">注意事项</a></li><li><ul><li><a href="#1__64" rel="nofollow">1. 消息代理选择</a></li><li><a href="#2__70" rel="nofollow">2. 消息队列配置</a></li><li><a href="#3__76" rel="nofollow">3. 消息持久化</a></li><li><a href="#4__82" rel="nofollow">4. 幂等性</a></li><li><a href="#5__88" rel="nofollow">5. 安全性</a></li><li><a href="#6__94" rel="nofollow">6. 消息大小</a></li><li><a href="#7__100" rel="nofollow">7. 性能监控</a></li><li><a href="#8__106" rel="nofollow">8. 错误处理</a></li><li><a href="#9__112" rel="nofollow">9. 版本兼容性</a></li><li><a href="#10__118" rel="nofollow">10. 测试</a></li><li><a href="#11__124" rel="nofollow">11. 配置同步</a></li><li><a href="#12__130" rel="nofollow">12. 日志记录</a></li></ul> 
    </li><li><a href="#_140" rel="nofollow">常用示例</a></li><li><ul><li><a href="#_1__146" rel="nofollow">示例 1: 配置同步</a></li><li><ul><li><a href="#_configserver_152" rel="nofollow">配置服务器 (`config-server`)</a></li><li><a href="#_clientservice_207" rel="nofollow">客户端服务 (`client-service`)</a></li><li><a href="#_275" rel="nofollow">触发配置刷新</a></li></ul> 
     </li><li><a href="#_2__287" rel="nofollow">示例 2: 事件广播</a></li><li><a href="#_3_Spring_Cloud_Bus__RabbitMQ_355" rel="nofollow">示例 3: Spring Cloud Bus 整合 RabbitMQ</a></li></ul> 
    </li><li><a href="#_424" rel="nofollow">总结</a></li><li><a href="#font_colordd0000font_440" rel="nofollow"><font color="#dd0000">强烈推荐</font></a></li><li><a href="#_454" rel="nofollow">专栏集锦</a></li><li><a href="#_480" rel="nofollow">写在最后</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br> 
<img src="https://images2.imgbox.com/4e/0a/TO8uz09z_o.gif" alt="579a429daf314744b995f37351b46548"> 
<p></p> 
<h4><a id="font_colordd0000font_6"></a><font color="#dd0000">强烈推荐</font></h4> 
<p><font color="#dd0000">前些天发现了一个巨牛的人工智能学习网站，通俗易懂，风趣幽默，忍不住分享一下给大家。点击跳转到网站:</font><a href="https://www.captainbed.cn/venus" rel="nofollow">人工智能</a></p> 
<p><img src="https://images2.imgbox.com/f1/45/X8EXIqgh_o.jpg" alt="b004071ozy_05_amzn"></p> 
<hr> 
<h4><a id="_20"></a>引言</h4> 
<p>Spring Cloud Bus 是 Spring Cloud 框架中的一个强大功能，它通过轻量级消息代理（如 RabbitMQ 或 Kafka）连接分布式系统（通常是微服务）。它有助于在微服务架构的不同部分之间进行通信，并有助于跨集群传播状态变化。</p> 
<hr> 
<h4><a id="_30"></a>关键方面</h4> 
<p>以下是 Spring Cloud Bus 的一些关键方面：</p> 
<ol><li> <p><strong>事件传播</strong>：</p> <p>它使用消息代理来传播配置更改和其他状态更改，确保在不同的微服务实例之间保持一致性。</p> </li><li> <p><strong>集中配置管理</strong>：</p> <p>结合 Spring Cloud Config，Spring Cloud Bus 可以在不重启应用程序的情况下刷新多个应用程序实例的配置。例如，当在集中配置库中更新配置属性时，Spring Cloud Bus 可以将更改广播到所有相关服务。</p> </li><li> <p><strong>可扩展性</strong>：</p> <p>通过利用消息代理，Spring Cloud Bus 允许在分布式系统中进行可扩展的通信。这在大规模系统中尤为有用，因为服务之间的直接通信可能效率不高。</p> </li><li> <p><strong>实现</strong>：</p> <p>要实现 Spring Cloud Bus，通常需要在 Spring Boot 应用程序中包含相关依赖项，配置消息代理，并使用注解标记需要传播的配置更改或事件。</p> </li></ol> 
<hr> 
<h4><a id="_56"></a>注意事项</h4> 
<p>在使用 Spring Cloud Bus 时，需要注意以下几点：</p> 
<h5><a id="1__64"></a>1. 消息代理选择</h5> 
<p>Spring Cloud Bus 支持多种消息代理（如 RabbitMQ、Kafka），选择适合的消息代理非常重要。需要根据系统的需求和性能要求来决定使用哪一种。</p> 
<h5><a id="2__70"></a>2. 消息队列配置</h5> 
<p>确保消息队列的配置正确，包括连接信息、队列名称、主题等。如果配置不当，可能会导致消息无法正常传递或丢失。</p> 
<h5><a id="3__76"></a>3. 消息持久化</h5> 
<p>确保消息代理配置了持久化策略，以避免在服务重启或崩溃时丢失消息。</p> 
<h5><a id="4__82"></a>4. 幂等性</h5> 
<p>由于网络的不确定性，消息可能会被多次接收和处理。因此，服务处理消息时需要保证幂等性，避免因重复处理消息导致的数据不一致。</p> 
<h5><a id="5__88"></a>5. 安全性</h5> 
<p>考虑到消息中可能包含敏感信息，需配置合适的安全措施，如消息加密、认证授权等，防止消息被非法访问或篡改。</p> 
<h5><a id="6__94"></a>6. 消息大小</h5> 
<p>消息的大小会影响传输性能和系统稳定性。尽量保持消息体积小，如果需要传递大数据，考虑将数据放在共享存储中，仅在消息中传递数据引用或标识符。</p> 
<h5><a id="7__100"></a>7. 性能监控</h5> 
<p>监控消息代理和消息传递的性能，及时发现和解决性能瓶颈。可以使用消息代理提供的监控工具或第三方监控系统。</p> 
<h5><a id="8__106"></a>8. 错误处理</h5> 
<p>建立健全的错误处理机制，确保在消息处理失败时有相应的补救措施，如重试机制、死信队列等。</p> 
<h5><a id="9__112"></a>9. 版本兼容性</h5> 
<p>确保 Spring Cloud Bus 和所使用的消息代理版本之间的兼容性。关注依赖库的更新日志，避免因版本不兼容导致的问题。</p> 
<h5><a id="10__118"></a>10. 测试</h5> 
<p>在生产环境部署前，充分测试消息传递机制，确保在各种情况下消息都能正确传递和处理。</p> 
<h5><a id="11__124"></a>11. 配置同步</h5> 
<p>使用 Spring Cloud Bus 来同步配置时，确保配置中心与各服务实例的同步机制可靠，避免因配置不同步导致的服务异常。</p> 
<h5><a id="12__130"></a>12. 日志记录</h5> 
<p>记录消息的传递和处理日志，方便问题排查和系统维护。</p> 
<hr> 
<h4><a id="_140"></a>常用示例</h4> 
<p>下面是几个常用的 Spring Cloud Bus 示例，展示了如何在微服务架构中使用 Spring Cloud Bus 来实现配置同步和事件广播。</p> 
<h5><a id="_1__146"></a>示例 1: 配置同步</h5> 
<p>假设我们有两个服务 <code>config-server</code> 和 <code>client-service</code>。我们将使用 Spring Cloud Bus 来同步配置。</p> 
<h6><a id="_configserver_152"></a>配置服务器 (<code>config-server</code>)</h6> 
<ol><li> <p><strong>添加依赖</strong></p> <p>在 <code>config-server</code> 的 <code>pom.xml</code> 中添加以下依赖：</p> <pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> </li><li> <p><strong>配置文件</strong></p> <p>在 <code>application.yml</code> 中配置 RabbitMQ：</p> <pre><code>spring:
  cloud:
    config:
      server:
        git:
          uri: https://github.com/your/repo
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
</code></pre> </li><li> <p><strong>主应用类</strong></p> <p>在 <code>ConfigServerApplication.java</code> 中启用配置服务器：</p> <pre><code>@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
</code></pre> </li></ol> 
<h6><a id="_clientservice_207"></a>客户端服务 (<code>client-service</code>)</h6> 
<ol><li> <p><strong>添加依赖</strong></p> <p>在 <code>client-service</code> 的 <code>pom.xml</code> 中添加以下依赖：</p> <pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> </li><li> <p><strong>配置文件</strong></p> <p>在 <code>bootstrap.yml</code> 中配置：</p> <pre><code>spring:
  application:
    name: client-service
  cloud:
    config:
      uri: http://localhost:8888
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
</code></pre> </li><li> <p><strong>刷新端点</strong></p> <p>在 <code>application.yml</code> 中启用 Actuator 端点：</p> <pre><code>management:
  endpoints:
    web:
      exposure:
        include: bus-refresh
</code></pre> </li><li> <p><strong>主应用类</strong></p> <p>在 <code>ClientServiceApplication.java</code> 中启动客户端服务：</p> <pre><code>@SpringBootApplication
public class ClientServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(ClientServiceApplication.class, args);
    }
}
</code></pre> </li></ol> 
<h6><a id="_275"></a>触发配置刷新</h6> 
<p>当你在配置仓库中更改配置文件时，可以通过以下方式触发配置刷新：</p> 
<p>发送 POST 请求到配置服务器的 <code>/actuator/bus-refresh</code> 端点：</p> 
<pre><code>curl -X POST http://localhost:8888/actuator/bus-refresh
</code></pre> 
<h5><a id="_2__287"></a>示例 2: 事件广播</h5> 
<p>使用 Spring Cloud Bus 还可以在多个服务之间广播自定义事件。下面是一个简单的示例。</p> 
<ol><li> <p><strong>定义事件</strong></p> <p>创建一个自定义事件类：</p> <pre><code>public class CustomEvent extends RemoteApplicationEvent {
    private String message;

    // 必须的默认构造函数
    public CustomEvent() {}

    public CustomEvent(Object source, String originService, String destinationService, String message) {
        super(source, originService, destinationService);
        this.message = message;
    }

    public String getMessage() {
        return message;
    }
}
</code></pre> </li><li> <p><strong>发布事件</strong></p> <p>在一个服务中发布事件：</p> <pre><code>@RestController
public class EventController {
    @Autowired
    private ApplicationEventPublisher publisher;

    @PostMapping("/publish")
    public void publishEvent(@RequestParam String message) {
        CustomEvent event = new CustomEvent(this, "origin-service", "destination-service", message);
        publisher.publishEvent(event);
    }
}
</code></pre> </li><li> <p><strong>接收事件</strong></p> <p>在另一个服务中接收事件：</p> <pre><code>@Component
public class CustomEventListener implements ApplicationListener&lt;CustomEvent&gt; {
    @Override
    public void onApplicationEvent(CustomEvent event) {
        System.out.println("Received event with message: " + event.getMessage());
    }
}
</code></pre> </li></ol> 
<h5><a id="_3_Spring_Cloud_Bus__RabbitMQ_355"></a>示例 3: Spring Cloud Bus 整合 RabbitMQ</h5> 
<p>以下是如何使用 Spring Cloud Bus 和 RabbitMQ 的一个简单示例：</p> 
<ol><li> <p><strong>添加依赖</strong>：</p> <p>在 <code>pom.xml</code> 或 <code>build.gradle</code> 文件中添加必要的依赖项。</p> <pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre> </li><li> <p><strong>配置消息代理</strong>：</p> <p>在 <code>application.properties</code> 或 <code>application.yml</code> 文件中配置消息代理设置。</p> <pre><code>spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
</code></pre> </li><li> <p><strong>启用 Bus 刷新</strong>：</p> <p>使用 <code>@RefreshScope</code> 注解表示当收到事件时，bean 应该刷新其配置。</p> <pre><code>@RestController
@RefreshScope
public class MyController {
    @Value("${my.config.property}")
    private String myConfigProperty;
    
    @GetMapping("/property")
    public String getProperty() {
        return myConfigProperty;
    }
}
</code></pre> </li><li> <p><strong>触发刷新</strong>：</p> <p>触发刷新事件（例如，通过 HTTP 端点）来传播配置更改。</p> <pre><code>@RestController
public class RefreshController {
    @Autowired
    private ApplicationContext applicationContext;
    
    @PostMapping("/refresh")
    public void refresh() {
        applicationContext.publishEvent(new RefreshRemoteApplicationEvent(this, "configServer", null));
    }
}
</code></pre> </li></ol> 
<p>Spring Cloud Bus 是在分布式系统中维护一致性和管理状态的强大工具。它简化了跨多个微服务实例处理配置更改和其他状态更改的过程。</p> 
<hr> 
<h4><a id="_424"></a>总结</h4> 
<p>Spring Cloud Bus 是一个强大的工具，能够在分布式系统中实现配置同步和事件广播，有效提高系统的灵活性和可维护性。</p> 
<p>通过选择合适的消息代理、配置持久化和安全措施、保证消息处理的幂等性、建立健全的错误处理机制，并进行充分的测试和日志记录，可以确保 Spring Cloud Bus 的高效运行。</p> 
<p>无论是实现配置的动态同步，还是在服务之间广播事件，Spring Cloud Bus 都能显著提升微服务架构的可靠性和可扩展性。</p> 
<hr> 
<h4><a id="font_colordd0000font_440"></a><font color="#dd0000">强烈推荐</font></h4> 
<p><font color="#dd0000">前些天发现了一个巨牛的人工智能学习网站，通俗易懂，风趣幽默，忍不住分享一下给大家。点击跳转到网站:</font><a href="https://www.captainbed.cn/venus" rel="nofollow">人工智能</a></p> 
<p><img src="https://images2.imgbox.com/b1/98/cmEQ3zcu_o.jpg" alt="b004071ozy_05_amzn"></p> 
<hr> 
<h4><a id="_454"></a>专栏集锦</h4> 
<p>大佬们可以收藏以备不时之需：</p> 
<p>Spring Boot 专栏：http://t.csdnimg.cn/peKde</p> 
<p>ChatGPT 专栏：http://t.csdnimg.cn/cU0na</p> 
<p>Java 专栏：http://t.csdnimg.cn/YUz5e</p> 
<p>Go 专栏：http://t.csdnimg.cn/Jfryo</p> 
<p>Netty 专栏：http://t.csdnimg.cn/0Mp1H</p> 
<p>Redis 专栏：http://t.csdnimg.cn/JuTue</p> 
<p>Mysql 专栏：http://t.csdnimg.cn/p1zU9</p> 
<p>架构之路 专栏：http://t.csdnimg.cn/bXAPS</p> 
<hr> 
<h4><a id="_480"></a>写在最后</h4> 
<p><strong>感谢您的支持和鼓励！ 😊🙏</strong></p> 
<p><strong>如果大家对相关文章感兴趣，可以关注公众号"架构殿堂"，会持续更新AIGC，java基础面试题, netty, spring boot, spring cloud等系列文章，一系列干货随时送达!</strong></p> 
<p><strong>如果有项目或者毕设合作，请V:fengyelin8866,备注项目合作</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3716300ac946602ffa55fddaff24d1d7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">NPOI 导出列太多或者数据太多爆内存</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ba26cd2f6635426a8d5efec2390fb035/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java中定时任务执行的三种方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>