<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>开源C&#43;&#43;智能语音识别库whisper.cpp开发使用入门 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6fc1d9e6973f20b03176fbd9816f036a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="开源C&#43;&#43;智能语音识别库whisper.cpp开发使用入门">
  <meta property="og:description" content="whisper.cpp是一个C&#43;&#43;编写的轻量级开源智能语音识别库，是基于openai的开源python智能语音模型whisper的移植版本，依赖项少，内存占用低，性能更优，方便作为依赖库集成的到应用程序中提供语音识别功能。
以下基于whisper.cpp的源码利用C&#43;&#43; api来开发实例demo演示读取本地音频文件并转成文字。
项目结构 whispercpp_starter - whisper.cpp-v1.5.0 - src |- main.cpp - CMakeLists.txt CMakeLists.txt
cmake_minimum_required(VERSION 3.15) project(whispercpp_starter) set(CMAKE_CXX_STANDARD 14) set(CMAKE_CXX_STANDARD_REQUIRED ON) add_subdirectory(whisper.cpp-v1.5.0) include_directories( ${CMAKE_CURRENT_SOURCE_DIR}/whisper.cpp-v1.5.0 ${CMAKE_CURRENT_SOURCE_DIR}/whisper.cpp-v1.5.0/examples ) file(GLOB SRC src/*.h src/*.cpp ) add_executable(${PROJECT_NAME} ${SRC}) target_link_libraries(${PROJECT_NAME} common whisper # remember to copy dll or so to bin folder ) main.cpp
#include &lt;cmath&gt; #include &lt;fstream&gt; #include &lt;cstdio&gt; #include &lt;string&gt; #include &lt;thread&gt; #include &lt;vector&gt; #include &lt;cstring&gt; #include &#34;common.h&#34; #include &#34;whisper.h&#34; #if defined(_MSC_VER) #pragma warning(disable: 4244 4267) // possible loss of data #endif // Terminal color map.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-28T22:21:43+08:00">
    <meta property="article:modified_time" content="2024-06-28T22:21:43+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">开源C&#43;&#43;智能语音识别库whisper.cpp开发使用入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>whisper.cpp是一个C++编写的轻量级开源智能语音识别库，是基于openai的开源python智能语音模型whisper的移植版本，依赖项少，内存占用低，性能更优，方便作为依赖库集成的到应用程序中提供语音识别功能。</p> 
<p>以下基于whisper.cpp的源码利用C++ api来开发实例demo演示读取本地音频文件并转成文字。</p> 
<h2><a id="_4"></a>项目结构</h2> 
<pre><code class="prism language-bash">whispercpp_starter
	- whisper.cpp-v1.5.0
	- src
	  <span class="token operator">|</span>- main.cpp
	- CMakeLists.txt
</code></pre> 
<p>CMakeLists.txt</p> 
<pre><code class="prism language-bash">cmake_minimum_required<span class="token punctuation">(</span>VERSION <span class="token number">3.15</span><span class="token punctuation">)</span>

project<span class="token punctuation">(</span>whispercpp_starter<span class="token punctuation">)</span>

set<span class="token punctuation">(</span>CMAKE_CXX_STANDARD <span class="token number">14</span><span class="token punctuation">)</span>
set<span class="token punctuation">(</span>CMAKE_CXX_STANDARD_REQUIRED ON<span class="token punctuation">)</span>

add_subdirectory<span class="token punctuation">(</span>whisper.cpp-v1.5.0<span class="token punctuation">)</span>

include_directories<span class="token punctuation">(</span>
    <span class="token variable">${CMAKE_CURRENT_SOURCE_DIR}</span>/whisper.cpp-v1.5.0
    <span class="token variable">${CMAKE_CURRENT_SOURCE_DIR}</span>/whisper.cpp-v1.5.0/examples
<span class="token punctuation">)</span>

file<span class="token punctuation">(</span>GLOB SRC
    src/*.h
    src/*.cpp
<span class="token punctuation">)</span>

add_executable<span class="token punctuation">(</span><span class="token variable">${PROJECT_NAME}</span> <span class="token variable">${SRC}</span><span class="token punctuation">)</span>

target_link_libraries<span class="token punctuation">(</span><span class="token variable">${PROJECT_NAME}</span>
    common
    whisper <span class="token comment"># remember to copy dll or so to bin folder</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>main.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"whisper.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable<span class="token operator">:</span> <span class="token number">4244</span> <span class="token number">4267</span><span class="token punctuation">)</span> </span><span class="token comment">// possible loss of data</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">// Terminal color map. 10 colors grouped in ranges [0.0, 0.1, ..., 0.9]</span>
<span class="token comment">// Lowest is red, middle is yellow, highest is green.</span>
<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> k_colors <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"\033[38;5;196m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;202m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;208m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;214m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;220m"</span><span class="token punctuation">,</span>
    <span class="token string">"\033[38;5;226m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;190m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;154m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;118m"</span><span class="token punctuation">,</span> <span class="token string">"\033[38;5;82m"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//  500 -&gt; 00:05.000</span>
<span class="token comment">// 6000 -&gt; 01:00.000</span>
std<span class="token double-colon punctuation">::</span>string <span class="token function">to_timestamp</span><span class="token punctuation">(</span><span class="token keyword">int64_t</span> t<span class="token punctuation">,</span> <span class="token keyword">bool</span> comma <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int64_t</span> msec <span class="token operator">=</span> t <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> hr <span class="token operator">=</span> msec <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msec <span class="token operator">=</span> msec <span class="token operator">-</span> hr <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> min <span class="token operator">=</span> msec <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msec <span class="token operator">=</span> msec <span class="token operator">-</span> min <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> sec <span class="token operator">=</span> msec <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    msec <span class="token operator">=</span> msec <span class="token operator">-</span> sec <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%02d:%02d:%02d%s%03d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>hr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>min<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sec<span class="token punctuation">,</span> comma <span class="token operator">?</span> <span class="token string">","</span> <span class="token operator">:</span> <span class="token string">"."</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>msec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">timestamp_to_sample</span><span class="token punctuation">(</span><span class="token keyword">int64_t</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> n_samples<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>n_samples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">*</span> WHISPER_SAMPLE_RATE<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// helper function to replace substrings</span>
<span class="token keyword">void</span> <span class="token function">replace_all</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> search<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> replace<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> pos <span class="token operator">+=</span> replace<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        pos <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>search<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> search<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> replace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// command-line parameters</span>
<span class="token keyword">struct</span> <span class="token class-name">whisper_params</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int32_t</span> n_threads <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int32_t</span><span class="token punctuation">)</span>std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> n_processors <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> offset_t_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> offset_n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> duration_ms <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> progress_step <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> max_context <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> max_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> best_of <span class="token operator">=</span> <span class="token function">whisper_full_default_params</span><span class="token punctuation">(</span>WHISPER_SAMPLING_GREEDY<span class="token punctuation">)</span><span class="token punctuation">.</span>greedy<span class="token punctuation">.</span>best_of<span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> beam_size <span class="token operator">=</span> <span class="token function">whisper_full_default_params</span><span class="token punctuation">(</span>WHISPER_SAMPLING_BEAM_SEARCH<span class="token punctuation">)</span><span class="token punctuation">.</span>beam_search<span class="token punctuation">.</span>beam_size<span class="token punctuation">;</span>

    <span class="token keyword">float</span> word_thold <span class="token operator">=</span> <span class="token number">0.01f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> entropy_thold <span class="token operator">=</span> <span class="token number">2.40f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> logprob_thold <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.00f</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> speed_up <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> debug_mode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> translate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> detect_language <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> diarize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> tinydiarize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> split_on_word <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> no_fallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_txt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_vtt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_srt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_wts <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_csv <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_jsn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_jsn_full <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> output_lrc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> print_special <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> print_colors <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> print_progress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> no_timestamps <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> log_score <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> use_gpu <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string language <span class="token operator">=</span> <span class="token string">"en"</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string prompt<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string font_path <span class="token operator">=</span> <span class="token string">"/System/Library/Fonts/Supplemental/Courier New Bold.ttf"</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string model <span class="token operator">=</span> <span class="token string">"models/ggml-base.en.bin"</span><span class="token punctuation">;</span>

    <span class="token comment">// [TDRZ] speaker turn string</span>
    std<span class="token double-colon punctuation">::</span>string tdrz_speaker_turn <span class="token operator">=</span> <span class="token string">" [SPEAKER_TURN]"</span><span class="token punctuation">;</span> <span class="token comment">// TODO: set from command line</span>

    std<span class="token double-colon punctuation">::</span>string openvino_encode_device <span class="token operator">=</span> <span class="token string">"CPU"</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> fname_inp <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> fname_out <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">whisper_print_user_data</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> whisper_params<span class="token operator">*</span> params<span class="token punctuation">;</span>

    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;&gt;</span><span class="token operator">*</span> pcmf32s<span class="token punctuation">;</span>
    <span class="token keyword">int</span> progress_prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

std<span class="token double-colon punctuation">::</span>string <span class="token function">estimate_diarization_speaker</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> pcmf32s<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> t0<span class="token punctuation">,</span> <span class="token keyword">int64_t</span> t1<span class="token punctuation">,</span> <span class="token keyword">bool</span> id_only <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string speaker <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> n_samples <span class="token operator">=</span> pcmf32s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> is0 <span class="token operator">=</span> <span class="token function">timestamp_to_sample</span><span class="token punctuation">(</span>t0<span class="token punctuation">,</span> n_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int64_t</span> is1 <span class="token operator">=</span> <span class="token function">timestamp_to_sample</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> n_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> energy0 <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> energy1 <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int64_t</span> j <span class="token operator">=</span> is0<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> is1<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        energy0 <span class="token operator">+=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>pcmf32s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        energy1 <span class="token operator">+=</span> <span class="token function">fabs</span><span class="token punctuation">(</span>pcmf32s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>energy0 <span class="token operator">&gt;</span> <span class="token number">1.1</span> <span class="token operator">*</span> energy1<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        speaker <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>energy1 <span class="token operator">&gt;</span> <span class="token number">1.1</span> <span class="token operator">*</span> energy0<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        speaker <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        speaker <span class="token operator">=</span> <span class="token string">"?"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//printf("is0 = %lld, is1 = %lld, energy0 = %f, energy1 = %f, speaker = %s\n", is0, is1, energy0, energy1, speaker.c_str());</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id_only<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        speaker<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"(speaker "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        speaker<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> speaker<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">whisper_print_progress_callback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">whisper_context</span><span class="token operator">*</span> <span class="token comment">/*ctx*/</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">whisper_state</span><span class="token operator">*</span> <span class="token comment">/*state*/</span><span class="token punctuation">,</span> <span class="token keyword">int</span> progress<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> user_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> progress_step <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>whisper_print_user_data<span class="token operator">*</span><span class="token punctuation">)</span>user_data<span class="token punctuation">)</span><span class="token operator">-&gt;</span>params<span class="token operator">-&gt;</span>progress_step<span class="token punctuation">;</span>
    <span class="token keyword">int</span><span class="token operator">*</span> progress_prev <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>whisper_print_user_data<span class="token operator">*</span><span class="token punctuation">)</span>user_data<span class="token punctuation">)</span><span class="token operator">-&gt;</span>progress_prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&gt;=</span> <span class="token operator">*</span>progress_prev <span class="token operator">+</span> progress_step<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>progress_prev <span class="token operator">+=</span> progress_step<span class="token punctuation">;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: progress = %3d%%\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">whisper_print_segment_callback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">whisper_context</span><span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">whisper_state</span><span class="token operator">*</span> <span class="token comment">/*state*/</span><span class="token punctuation">,</span> <span class="token keyword">int</span> n_new<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> user_data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> params <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>whisper_print_user_data<span class="token operator">*</span><span class="token punctuation">)</span>user_data<span class="token punctuation">)</span><span class="token operator">-&gt;</span>params<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> pcmf32s <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>whisper_print_user_data<span class="token operator">*</span><span class="token punctuation">)</span>user_data<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pcmf32s<span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> n_segments <span class="token operator">=</span> <span class="token function">whisper_full_n_segments</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string speaker <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token keyword">int64_t</span> t0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int64_t</span> t1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// print the last n_new segments</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> s0 <span class="token operator">=</span> n_segments <span class="token operator">-</span> n_new<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s0 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> s0<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_segments<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>no_timestamps <span class="token operator">||</span> params<span class="token punctuation">.</span>diarize<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            t0 <span class="token operator">=</span> <span class="token function">whisper_full_get_segment_t0</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> <span class="token function">whisper_full_get_segment_t1</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>no_timestamps<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%s --&gt; %s]  "</span><span class="token punctuation">,</span> <span class="token function">to_timestamp</span><span class="token punctuation">(</span>t0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">to_timestamp</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>diarize <span class="token operator">&amp;&amp;</span> pcmf32s<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            speaker <span class="token operator">=</span> <span class="token function">estimate_diarization_speaker</span><span class="token punctuation">(</span>pcmf32s<span class="token punctuation">,</span> t0<span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>print_colors<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">whisper_full_n_tokens</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>print_special <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">const</span> whisper_token id <span class="token operator">=</span> <span class="token function">whisper_full_get_token_id</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> <span class="token function">whisper_token_eot</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> text <span class="token operator">=</span> <span class="token function">whisper_full_get_token_text</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token keyword">float</span>  p <span class="token operator">=</span> <span class="token function">whisper_full_get_token_p</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">const</span> <span class="token keyword">int</span> col <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>k_colors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">pow</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">float</span><span class="token punctuation">(</span>k_colors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%s%s%s"</span><span class="token punctuation">,</span> speaker<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k_colors<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token string">"\033[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> text <span class="token operator">=</span> <span class="token function">whisper_full_get_segment_text</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%s"</span><span class="token punctuation">,</span> speaker<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>tinydiarize<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">whisper_full_get_segment_speaker_turn_next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>tdrz_speaker_turn<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// with timestamps or speakers: each segment on new line</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span>no_timestamps <span class="token operator">||</span> params<span class="token punctuation">.</span>diarize<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">output_txt</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">whisper_context</span><span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fname<span class="token punctuation">,</span> <span class="token keyword">const</span> whisper_params<span class="token operator">&amp;</span> params<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> pcmf32s<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">fout</span><span class="token punctuation">(</span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fout<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: failed to open '%s' for writing\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: saving output to '%s'\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">int</span> n_segments <span class="token operator">=</span> <span class="token function">whisper_full_n_segments</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_segments<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> text <span class="token operator">=</span> <span class="token function">whisper_full_get_segment_text</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string speaker <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>diarize <span class="token operator">&amp;&amp;</span> pcmf32s<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">int64_t</span> t0 <span class="token operator">=</span> <span class="token function">whisper_full_get_segment_t0</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">int64_t</span> t1 <span class="token operator">=</span> <span class="token function">whisper_full_get_segment_t1</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            speaker <span class="token operator">=</span> <span class="token function">estimate_diarization_speaker</span><span class="token punctuation">(</span>pcmf32s<span class="token punctuation">,</span> t0<span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        fout <span class="token operator">&lt;&lt;</span> speaker <span class="token operator">&lt;&lt;</span> text <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string model_file_path <span class="token operator">=</span> <span class="token string">"./ggml-base.en.bin"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string audio_file_path <span class="token operator">=</span> <span class="token string">"sample.wav"</span><span class="token punctuation">;</span> <span class="token comment">// should be wav 16bit format</span>

    <span class="token comment">// set whisper params</span>
    whisper_params params<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>model <span class="token operator">=</span> model_file_path<span class="token punctuation">;</span>
    params<span class="token punctuation">.</span>fname_inp<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>audio_file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// whisper init</span>
    <span class="token keyword">struct</span> <span class="token class-name">whisper_context_params</span> cparams<span class="token punctuation">;</span>
    cparams<span class="token punctuation">.</span>use_gpu <span class="token operator">=</span> params<span class="token punctuation">.</span>use_gpu<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">whisper_context</span><span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token function">whisper_init_from_file_with_params</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cparams<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"error: failed to initialize whisper context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// initialize openvino encoder. this has no effect on whisper.cpp builds that don't have OpenVINO configured</span>
    <span class="token function">whisper_ctx_init_openvino_encoder</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>openvino_encode_device<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> f <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>params<span class="token punctuation">.</span>fname_inp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>f<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">auto</span> fname_inp <span class="token operator">=</span> params<span class="token punctuation">.</span>fname_inp<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">auto</span> fname_out <span class="token operator">=</span> f <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>params<span class="token punctuation">.</span>fname_out<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>params<span class="token punctuation">.</span>fname_out<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> params<span class="token punctuation">.</span>fname_out<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">:</span> params<span class="token punctuation">.</span>fname_inp<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> pcmf32<span class="token punctuation">;</span>               <span class="token comment">// mono-channel F32 PCM</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> pcmf32s<span class="token punctuation">;</span> <span class="token comment">// stereo-channel F32 PCM</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">read_wav</span><span class="token punctuation">(</span>fname_inp<span class="token punctuation">,</span> pcmf32<span class="token punctuation">,</span> pcmf32s<span class="token punctuation">,</span> params<span class="token punctuation">.</span>diarize<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"error: failed to read WAV file '%s'\n"</span><span class="token punctuation">,</span> fname_inp<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// print system information</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"system_info: n_threads = %d / %d | %s\n"</span><span class="token punctuation">,</span>
                params<span class="token punctuation">.</span>n_threads <span class="token operator">*</span> params<span class="token punctuation">.</span>n_processors<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>thread<span class="token double-colon punctuation">::</span><span class="token function">hardware_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">whisper_print_system_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// print some info about the processing</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">whisper_is_multilingual</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>language <span class="token operator">!=</span> <span class="token string">"en"</span> <span class="token operator">||</span> params<span class="token punctuation">.</span>translate<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    params<span class="token punctuation">.</span>language <span class="token operator">=</span> <span class="token string">"en"</span><span class="token punctuation">;</span>
                    params<span class="token punctuation">.</span>translate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: WARNING: model is not multilingual, ignoring language and translation options\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>detect_language<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                params<span class="token punctuation">.</span>language <span class="token operator">=</span> <span class="token string">"auto"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: processing '%s' (%d samples, %.1f sec), %d threads, %d processors, %d beams + best of %d, lang = %s, task = %s, %stimestamps = %d ...\n"</span><span class="token punctuation">,</span>
                <span class="token constant">__func__</span><span class="token punctuation">,</span> fname_inp<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">(</span>pcmf32<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">(</span>pcmf32<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> WHISPER_SAMPLE_RATE<span class="token punctuation">,</span>
                params<span class="token punctuation">.</span>n_threads<span class="token punctuation">,</span> params<span class="token punctuation">.</span>n_processors<span class="token punctuation">,</span> params<span class="token punctuation">.</span>beam_size<span class="token punctuation">,</span> params<span class="token punctuation">.</span>best_of<span class="token punctuation">,</span>
                params<span class="token punctuation">.</span>language<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                params<span class="token punctuation">.</span>translate <span class="token operator">?</span> <span class="token string">"translate"</span> <span class="token operator">:</span> <span class="token string">"transcribe"</span><span class="token punctuation">,</span>
                params<span class="token punctuation">.</span>tinydiarize <span class="token operator">?</span> <span class="token string">"tdrz = 1, "</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                params<span class="token punctuation">.</span>no_timestamps <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// run the inference</span>
        <span class="token punctuation">{<!-- --></span>
            whisper_full_params wparams <span class="token operator">=</span> <span class="token function">whisper_full_default_params</span><span class="token punctuation">(</span>WHISPER_SAMPLING_GREEDY<span class="token punctuation">)</span><span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>strategy <span class="token operator">=</span> params<span class="token punctuation">.</span>beam_size <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> WHISPER_SAMPLING_BEAM_SEARCH <span class="token operator">:</span> WHISPER_SAMPLING_GREEDY<span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>print_realtime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>print_progress <span class="token operator">=</span> params<span class="token punctuation">.</span>print_progress<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>print_timestamps <span class="token operator">=</span> <span class="token operator">!</span>params<span class="token punctuation">.</span>no_timestamps<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>print_special <span class="token operator">=</span> params<span class="token punctuation">.</span>print_special<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>translate <span class="token operator">=</span> params<span class="token punctuation">.</span>translate<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>language <span class="token operator">=</span> params<span class="token punctuation">.</span>language<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>detect_language <span class="token operator">=</span> params<span class="token punctuation">.</span>detect_language<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>n_threads <span class="token operator">=</span> params<span class="token punctuation">.</span>n_threads<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>n_max_text_ctx <span class="token operator">=</span> params<span class="token punctuation">.</span>max_context <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> params<span class="token punctuation">.</span>max_context <span class="token operator">:</span> wparams<span class="token punctuation">.</span>n_max_text_ctx<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>offset_ms <span class="token operator">=</span> params<span class="token punctuation">.</span>offset_t_ms<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>duration_ms <span class="token operator">=</span> params<span class="token punctuation">.</span>duration_ms<span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>token_timestamps <span class="token operator">=</span> params<span class="token punctuation">.</span>output_wts <span class="token operator">||</span> params<span class="token punctuation">.</span>output_jsn_full <span class="token operator">||</span> params<span class="token punctuation">.</span>max_len <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>thold_pt <span class="token operator">=</span> params<span class="token punctuation">.</span>word_thold<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>max_len <span class="token operator">=</span> params<span class="token punctuation">.</span>output_wts <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>max_len <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">60</span> <span class="token operator">:</span> params<span class="token punctuation">.</span>max_len<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>split_on_word <span class="token operator">=</span> params<span class="token punctuation">.</span>split_on_word<span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>speed_up <span class="token operator">=</span> params<span class="token punctuation">.</span>speed_up<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>debug_mode <span class="token operator">=</span> params<span class="token punctuation">.</span>debug_mode<span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>tdrz_enable <span class="token operator">=</span> params<span class="token punctuation">.</span>tinydiarize<span class="token punctuation">;</span> <span class="token comment">// [TDRZ]</span>

            wparams<span class="token punctuation">.</span>initial_prompt <span class="token operator">=</span> params<span class="token punctuation">.</span>prompt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>greedy<span class="token punctuation">.</span>best_of <span class="token operator">=</span> params<span class="token punctuation">.</span>best_of<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>beam_search<span class="token punctuation">.</span>beam_size <span class="token operator">=</span> params<span class="token punctuation">.</span>beam_size<span class="token punctuation">;</span>

            wparams<span class="token punctuation">.</span>temperature_inc <span class="token operator">=</span> params<span class="token punctuation">.</span>no_fallback <span class="token operator">?</span> <span class="token number">0.0f</span> <span class="token operator">:</span> wparams<span class="token punctuation">.</span>temperature_inc<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>entropy_thold <span class="token operator">=</span> params<span class="token punctuation">.</span>entropy_thold<span class="token punctuation">;</span>
            wparams<span class="token punctuation">.</span>logprob_thold <span class="token operator">=</span> params<span class="token punctuation">.</span>logprob_thold<span class="token punctuation">;</span>

            whisper_print_user_data user_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">&amp;</span>params<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pcmf32s<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token comment">// this callback is called on each new segment</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wparams<span class="token punctuation">.</span>print_realtime<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                wparams<span class="token punctuation">.</span>new_segment_callback <span class="token operator">=</span> whisper_print_segment_callback<span class="token punctuation">;</span>
                wparams<span class="token punctuation">.</span>new_segment_callback_user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>user_data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>wparams<span class="token punctuation">.</span>print_progress<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                wparams<span class="token punctuation">.</span>progress_callback <span class="token operator">=</span> whisper_print_progress_callback<span class="token punctuation">;</span>
                wparams<span class="token punctuation">.</span>progress_callback_user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>user_data<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// examples for abort mechanism</span>
            <span class="token comment">// in examples below, we do not abort the processing, but we could if the flag is set to true</span>

            <span class="token comment">// the callback is called before every encoder run - if it returns false, the processing is aborted</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">static</span> <span class="token keyword">bool</span> is_aborted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// NOTE: this should be atomic to avoid data race</span>

                wparams<span class="token punctuation">.</span>encoder_begin_callback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">whisper_context</span><span class="token operator">*</span> <span class="token comment">/*ctx*/</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">whisper_state</span><span class="token operator">*</span> <span class="token comment">/*state*/</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> user_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">bool</span> is_aborted <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">*</span><span class="token punctuation">)</span>user_data<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token operator">!</span>is_aborted<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                wparams<span class="token punctuation">.</span>encoder_begin_callback_user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>is_aborted<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// the callback is called before every computation - if it returns true, the computation is aborted</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">static</span> <span class="token keyword">bool</span> is_aborted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// NOTE: this should be atomic to avoid data race</span>

                wparams<span class="token punctuation">.</span>abort_callback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> user_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">bool</span> is_aborted <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">bool</span><span class="token operator">*</span><span class="token punctuation">)</span>user_data<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> is_aborted<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                wparams<span class="token punctuation">.</span>abort_callback_user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>is_aborted<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">whisper_full_parallel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> wparams<span class="token punctuation">,</span> pcmf32<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pcmf32<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>n_processors<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s: failed to process audio\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// output stuff</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// output to text file</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>output_txt<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> <span class="token keyword">auto</span> fname_txt <span class="token operator">=</span> fname_out <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">;</span>
                <span class="token function">output_txt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fname_txt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> pcmf32s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// whisper release</span>
    <span class="token function">whisper_print_timings</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">whisper_free</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注：</p> 
<ul><li>whisper支持的模型文件需要自己去下载</li><li>whisper.cpp编译可以配置多种类型的增强选项，比如支持CPU/GPU加速，数据计算加速库</li><li>whisper.cpp的编译cmake文件做了少量改动，方便集成到项目，具体可参看demo</li></ul> 
<h2><a id="_512"></a>源码</h2> 
<p><a href="https://download.csdn.net/download/u012234115/88576725">whispercpp_starter</a></p> 
<blockquote> 
 <p>本文由博客一文多发平台 <a href="https://openwrite.cn?from=article_bottom" rel="nofollow">OpenWrite</a> 发布！</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc2982dd83468930e6eee6f217ac4367/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL84 -- ERROR 1524 (HY000): Plugin ‘msql_native_password‘ is not loaded.</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1fb28d82d57d1a4e4ddd860a77f0d92f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用MATLAB编写牛拉法潮流计算(电力系统稳态分析)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>