<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spark On Hive】—— 基于电商数据分析的项目实战 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f1df66e2cbe901b2644aa3b01d09f700/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Spark On Hive】—— 基于电商数据分析的项目实战">
  <meta property="og:description" content="文章目录 Spark On Hive 详解一、项目配置1. 创建工程2. 配置文件3. 工程目录 二、代码实现2.1 Validator2.2 Class SparkFactory2.3 MySQLConfigFactory2.4 测试调用 Spark On Hive 详解 本文基于Spark重构基于Hive的电商数据分析的项目需求，在重构的同时对Spark On Hive的全流程进行详细的讲解。
所谓的Spark On X指的是从X数据源中获取数据并在Spark进行计算之后，将计算结果导入该数据库或者数仓。获取数据和导入数据的地方可以是不同的。
一、项目配置 1. 创建工程 首先，创建一个空的Maven工程，在创建之后，我们需要检查一系列配置，以保证JDK版本的一致性。同时，我们需要创建出Scala的编码环境。具体可参考以下文章:
Maven工程配置与常见问题解决指南
和
Scala01 —— Scala基础
2. 配置文件 2.1 在Spark On Hive的项目中，我们需要有两个核心配置文件。
pom.xml &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.ybg&lt;/groupId&gt; &lt;artifactId&gt;warehouse_ebs_2&lt;/artifactId&gt; &lt;version&gt;1.0&lt;/version&gt; &lt;properties&gt; &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;spark.version&gt;3.1.2&lt;/spark.version&gt; &lt;spark.scala.version&gt;2.12&lt;/spark.scala.version&gt; &lt;hadoop.version&gt;3.1.3&lt;/hadoop.version&gt; &lt;mysql.version&gt;8.0.33&lt;/mysql.version&gt; &lt;hive.version&gt;3.1.2&lt;/hive.version&gt; &lt;hbase.version&gt;2.3.5&lt;/hbase.version&gt; &lt;jackson.version&gt;2.10.0&lt;/jackson.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;!-- spark-core --&gt; &lt;dependency&gt; &lt;groupId&gt;org.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-20T21:25:39+08:00">
    <meta property="article:modified_time" content="2024-07-20T21:25:39+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spark On Hive】—— 基于电商数据分析的项目实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/b0/3f/UVUSApF7_o.gif" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/05/ifRMcuku_o.png" alt="在这里插入图片描述"><br> </p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#Spark_On_Hive__3" rel="nofollow">Spark On Hive 详解</a></li><li><ul><li><ul><li><a href="#_6" rel="nofollow">一、项目配置</a></li><li><ul><li><ul><li><a href="#1__7" rel="nofollow">1. 创建工程</a></li><li><a href="#2__13" rel="nofollow">2. 配置文件</a></li><li><a href="#3__132" rel="nofollow">3. 工程目录</a></li></ul> 
     </li></ul> 
     </li><li><a href="#_134" rel="nofollow">二、代码实现</a></li><li><ul><li><ul><li><a href="#21_Validator_154" rel="nofollow">2.1 Validator</a></li><li><a href="#22_Class_SparkFactory_185" rel="nofollow">2.2 Class SparkFactory</a></li><li><a href="#23_MySQLConfigFactory_529" rel="nofollow">2.3 MySQLConfigFactory</a></li><li><a href="#24__590" rel="nofollow">2.4 测试调用</a></li></ul> 
     </li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="Spark_On_Hive__3"></a>Spark On Hive 详解</h3> 
<p>本文基于Spark重构<a href="https://blog.csdn.net/m0_74120525/article/details/135789514?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172112819716800207048129%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=172112819716800207048129&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-5-135789514-null-null.nonecase&amp;utm_term=Hive&amp;spm=1018.2226.3001.4450">基于Hive的电商数据分析</a>的项目需求，在重构的同时对Spark On Hive的全流程进行详细的讲解。<br> 所谓的<code>Spark On X</code>指的是从X数据源中获取数据并在Spark进行计算之后，将计算结果导入该数据库或者数仓。获取数据和导入数据的地方<strong>可以是不同的</strong>。</p> 
<h5><a id="_6"></a>一、项目配置</h5> 
<h6><a id="1__7"></a>1. 创建工程</h6> 
<p>首先，创建一个空的Maven工程，在创建之后，我们需要检查一系列配置，以保证JDK版本的一致性。同时，我们需要创建出Scala的编码环境。具体可参考以下文章:<br> <a href="https://blog.csdn.net/m0_74120525/article/details/136927619?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172112841416800180633606%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=172112841416800180633606&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-136927619-null-null.nonecase&amp;utm_term=Maven&amp;spm=1018.2226.3001.4450">Maven工程配置与常见问题解决指南</a><br> 和<br> <a href="https://blog.csdn.net/m0_74120525/article/details/137051552?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172112841416800180633606%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=172112841416800180633606&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-2-137051552-null-null.nonecase&amp;utm_term=Maven&amp;spm=1018.2226.3001.4450">Scala01 —— Scala基础</a></p> 
<h6><a id="2__13"></a>2. 配置文件</h6> 
<p><strong>2.1 在<code>Spark On Hive</code>的项目中，我们需要有两个核心配置文件。</strong></p> 
<ul><li>pom.xml</li></ul> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ybg<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>warehouse_ebs_2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.scala.version</span><span class="token punctuation">&gt;</span></span>2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.scala.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hadoop.version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hadoop.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">&gt;</span></span>8.0.33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hive.version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hive.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hbase.version</span><span class="token punctuation">&gt;</span></span>2.3.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hbase.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jackson.version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jackson.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- spark-core --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-core_${spark.scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- spark-sql --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-sql_${spark.scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- spark-hive --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-hive_${spark.scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- hadoop-common --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${hadoop.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- mysql --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mysql.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- hive-exec --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hive-exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${hive.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-slf4j-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- HBase 驱动 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hbase-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${hbase.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- jackson-databind --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${jackson.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- jackson-databind --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${jackson.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>log4j.properties<br> <code>log4j.properties</code> 文件的主要作用是配置日志系统的行为，包括控制日志信息的输出和实现<strong>滚动事件日志</strong>。</li></ul> 
<pre><code class="prism language-properties">log4j.rootLogger=ERROR, stdout, logfile
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
----------------------- 滚动事件日志代码 -----------------------
log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - %m%n
log4j.appender.logfile=org.apache.log4j.DailyRollingFileAppender
log4j.appender.logfile.DatePattern='.'yyyy-MM-dd
log4j.appender.logfile.append=true
---------------------------------------------------------------
log4j.appender.logfile.File=log/spark_first.log
log4j.appender.logfile.layout=org.apache.log4j.PatternLayout
log4j.appender.logfile.layout.ConversionPattern=%d %p [%c] - %m%n
</code></pre> 
<p><strong>2.2 组件核心配置文件</strong><br> <img src="https://images2.imgbox.com/5f/47/xMMzHQzV_o.png" alt="在这里插入图片描述"><br> 在工程的<code>resources</code>目录下，需要存放在虚拟机中大数据服务的核心组件的配置文件，以便于Spark On Hive中调用大数据组件服务能够正常进行。</p> 
<h6><a id="3__132"></a>3. 工程目录</h6> 
<h5><a id="_134"></a>二、代码实现</h5> 
<ul><li> <p>Spark On Hive</p> 
  <ul><li>创建数据校验方法 check：<br> 用于确保配置项的值有效。<br> 检查值是否为 null。<br> 对字符串类型的值进行非空和正则表达式匹配校验。</li><li>创建配置设置方法 set：<br> 先校验配置项名称和值的有效性。<br> 使用 SparkConf.set 方法设置有效的配置项和值。</li><li>trait Builder：<br> 有一系列配置方法，最后end()返回SparkSession。</li><li>SparkFactory类中有一个build()方法，build()方法中新建了Builder对象实现了各类配置方法。</li></ul> </li><li> <p>Spark On MySQL</p> 
  <ul><li>分为Getter和Setter两处</li><li>Setter有四处配置，分别是Driver,Url,User,Password</li><li>Getter有两处配置，分别是Url和Conf</li></ul> </li></ul> 
<p><strong>SparkFactory配置表</strong>如下：<br> <a href="https://claude.site/artifacts/ad0a7b71-206e-45a0-bc61-0b27c60c9da7" rel="nofollow">配置表</a></p> 
<h6><a id="21_Validator_154"></a>2.1 Validator</h6> 
<ul><li>因为check()的校验方法并不只针对于Spark，因此可以创建一个Object作为通用性的校验方法。</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">core</span>


<span class="token keyword">object</span> Validator <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * 数据校验
   *
   * @param title 校验主题
   * @param value 待校验的值
   * @param regex 若待校验值为字符串，且有特定的规则，那么提供正则表达式进一步验证格式
   */</span>
   <span class="token keyword">def</span> check<span class="token punctuation">(</span>title<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">Any</span><span class="token punctuation">,</span> regex<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> RuntimeException<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"value for </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">title</span></span><span class="token string"> null pointer exception"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>isInstanceOf<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>toString<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> RuntimeException<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"value for </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">title</span></span><span class="token string"> empty string exception"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> regex <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>value<span class="token punctuation">.</span>toString<span class="token punctuation">.</span>matches<span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> RuntimeException<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"value for </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">title</span></span><span class="token string"> not match </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">regex</span></span><span class="token string"> exception"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="22_Class_SparkFactory_185"></a>2.2 Class SparkFactory</h6> 
<ul><li>作用：<code>SparkFactory</code>类的作用是能够工厂化地创建和配置<code>SparkSession</code>实例，通过一系列的<code>set</code>和<code>check</code>方法来确保配置项的有效性和正确性，并最终生成一个配置好的<code>SparkSession</code>实例。</li><li>代码</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">core</span>

<span class="token keyword">import</span> <span class="token namespace">core<span class="token punctuation">.</span></span>SparkFactory<span class="token punctuation">.</span>Builder
<span class="token keyword">import</span> <span class="token namespace">core<span class="token punctuation">.</span></span>Validator<span class="token punctuation">.</span>check
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession
<span class="token keyword">class</span> SparkFactory <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">new</span> Builder <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">/**
       * 先检查配置项名称是否正确
       * 再检查配置项的值是否正确
       * @param item 配置项名称
       * @param value 配置项值
       * @param regexValue 配置项正则规则
       */</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> set<span class="token punctuation">(</span>item<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>value<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>regexValue<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        check<span class="token punctuation">(</span><span class="token string">"name_of_config_item"</span><span class="token punctuation">,</span>item<span class="token punctuation">,</span><span class="token string">"^spark\\..*"</span><span class="token punctuation">)</span>
        check<span class="token punctuation">(</span>item<span class="token punctuation">,</span>value<span class="token punctuation">,</span>regexValue<span class="token punctuation">)</span>
        conf<span class="token punctuation">.</span>set<span class="token punctuation">(</span>item<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Base</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setBaseAppName<span class="token punctuation">(</span>appName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.app.name"</span><span class="token punctuation">,</span>appName<span class="token punctuation">,</span><span class="token string">"^\\w+$"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setBaseMaster<span class="token punctuation">(</span>master<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.master"</span><span class="token punctuation">,</span>master<span class="token punctuation">,</span>
          <span class="token string">"local(\\[(\\*|[1-9][0-9]*)])?|spark://([a-z]\\w+|\\d{1,3}(\\.\\d{1,3}){3}):\\d{4,5}|yarn"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setBaseDeployMode<span class="token punctuation">(</span>deployMode<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.submit.deployMode"</span><span class="token punctuation">,</span>deployMode<span class="token punctuation">,</span><span class="token string">"client|cluster"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setBaseEventLogEnabled<span class="token punctuation">(</span>eventLogEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.eventLog.enabled"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">eventLogEnabled</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> baseConfig<span class="token punctuation">(</span>appName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> master<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"local[*]"</span><span class="token punctuation">,</span> deployMode<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"client"</span><span class="token punctuation">,</span> eventLogEnabled<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> Builder <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        setBaseAppName<span class="token punctuation">(</span>appName<span class="token punctuation">)</span>
        setBaseMaster<span class="token punctuation">(</span>master<span class="token punctuation">)</span>
        setBaseDeployMode<span class="token punctuation">(</span>deployMode<span class="token punctuation">)</span>
        setBaseEventLogEnabled<span class="token punctuation">(</span>eventLogEnabled<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Driver</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDriverMemory<span class="token punctuation">(</span>memoryGB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.driver.memory"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">memoryGB</span><span class="token punctuation">}</span></span><span class="token string">g"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*g"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDriverCoreNum<span class="token punctuation">(</span>coreNum<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.driver.cores"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">coreNum</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDriverMaxResultGB<span class="token punctuation">(</span>maxRstGB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.driver.maxResultSize"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">maxRstGB</span><span class="token punctuation">}</span></span><span class="token string">g"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*g"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDriverHost<span class="token punctuation">(</span>driverHost<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.driver.host"</span><span class="token punctuation">,</span>driverHost<span class="token punctuation">,</span><span class="token string">"localhost|[a-z]\\w+"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeDriver<span class="token punctuation">(</span>memoryGB<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> coreNum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> maxRstGB<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> driverHost<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token operator">:</span> Builder <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        setDriverMemory<span class="token punctuation">(</span>memoryGB<span class="token punctuation">)</span>
        setDriverCoreNum<span class="token punctuation">(</span>coreNum<span class="token punctuation">)</span>

        <span class="token comment">/**
         * 每一个Spark行动算子触发的所有分区序列化结果大小上限
         */</span>
        setDriverMaxResultGB<span class="token punctuation">(</span>maxRstGB<span class="token punctuation">)</span>

        <span class="token comment">/**
         * Standalone 模式需要设置 DriverHost，便于 executor 与 master 通信
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"spark.master"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startsWith<span class="token punctuation">(</span><span class="token string">"spark://"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          setDriverHost<span class="token punctuation">(</span>driverHost<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Executor</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setExecutorMemory<span class="token punctuation">(</span>memoryGB<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.executor.memory"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">memoryGB</span><span class="token punctuation">}</span></span><span class="token string">g"</span></span><span class="token punctuation">,</span> <span class="token string">"[1-9]\\d*g"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setExecutorCoreNum<span class="token punctuation">(</span>coreNum<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.executor.cores"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">coreNum</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeExecutor<span class="token punctuation">(</span>memoryGB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>coreNum<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        setExecutorMemory<span class="token punctuation">(</span>memoryGB<span class="token punctuation">)</span>
        <span class="token comment">/**
         * Yarn模式下只能由1个核
         * 其他模式下，核数为所有可用的核
         */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>conf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"spark.master"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"yarn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          setExecutorCoreNum<span class="token punctuation">(</span>coreNum<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Limit</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setLimitMaxCores<span class="token punctuation">(</span>maxCores<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.cores.max"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">maxCores</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setLimitMaxTaskFailure<span class="token punctuation">(</span>maxTaskFailure<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.task.maxFailures"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">maxTaskFailure</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setLimitMaxLocalWaitS<span class="token punctuation">(</span>maxLocalWaitS<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.locality.wait"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">maxLocalWaitS</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*s"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeLimit<span class="token punctuation">(</span>maxCores<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
                                 maxTaskFailure<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                                 maxLocalWaitS<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"spark.master"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startsWith<span class="token punctuation">(</span><span class="token string">"spark://"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          setLimitMaxCores<span class="token punctuation">(</span>maxCores<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 单个任务允许失败最大次数，超出会杀死本次任务
         */</span>
        setLimitMaxTaskFailure<span class="token punctuation">(</span>maxTaskFailure<span class="token punctuation">)</span>

        <span class="token comment">/**
         * 数据本地化读取加载的最大等待时间
         * 大任务：建议适当增加此值
         */</span>
        setLimitMaxLocalWaitS<span class="token punctuation">(</span>maxLocalWaitS<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Serializer</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeSerializer<span class="token punctuation">(</span>serde<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"org.apache.spark.serializer.JavaSerializer"</span>
                                      <span class="token punctuation">,</span>clas<span class="token operator">:</span>Array<span class="token punctuation">[</span>Class<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 设置将需要通过网络发送或快速缓存的对象序列化工具类
         * 默认为JavaSerializer
         * 为了提速，推荐设置为KryoSerializer
         * 若采用 KryoSerializer，需要将所有自定义的实体类(样例类)注册到配置中心
         */</span>
        set<span class="token punctuation">(</span><span class="token string">"spark.serializer"</span><span class="token punctuation">,</span>serde<span class="token punctuation">,</span><span class="token string">"([a-z]+\\.)+[A-Z]\\w*"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>serde<span class="token punctuation">.</span>equals<span class="token punctuation">(</span><span class="token string">"org.apache.spark.serializer.KryoSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          conf<span class="token punctuation">.</span>registerKryoClasses<span class="token punctuation">(</span>clas<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Net</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setNetTimeout<span class="token punctuation">(</span>netTimeoutS<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.network.timeout"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">netTimeoutS</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*s"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setNetSchedulerMode<span class="token punctuation">(</span>schedulerMode<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.scheduler.mode"</span><span class="token punctuation">,</span>schedulerMode<span class="token punctuation">,</span><span class="token string">"FAIR|FIFO"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeNetAbout<span class="token punctuation">(</span>netTimeOusS<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span>schedulerMode<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"FAIR"</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 所有和网络交互相关的超时阈值
         */</span>
        setNetTimeout<span class="token punctuation">(</span>netTimeOusS<span class="token punctuation">)</span>

        <span class="token comment">/**
         * 多人工作模式下，建议设置为FAIR
         */</span>
        setNetSchedulerMode<span class="token punctuation">(</span>schedulerMode<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Dynamic</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDynamicEnabled<span class="token punctuation">(</span>dynamicEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.dynamicAllocation.enabled"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">dynamicEnabled</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDynamicInitialExecutors<span class="token punctuation">(</span>initialExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.dynamicAllocation.initialExecutors"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">initialExecutors</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDynamicMinExecutors<span class="token punctuation">(</span>minExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.dynamicAllocation.minExecutors"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">minExecutors</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">private</span> <span class="token keyword">def</span> setDynamicMaxExecutors<span class="token punctuation">(</span>maxExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.dynamicAllocation.maxExecutors"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">maxExecutors</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeDynamicAllocation<span class="token punctuation">(</span>dynamicEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>initialExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>minExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>maxExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 根据应用的工作需求，动态分配executor
         */</span>
        setDynamicEnabled<span class="token punctuation">(</span>dynamicEnabled<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dynamicEnabled<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          setDynamicInitialExecutors<span class="token punctuation">(</span>initialExecutors<span class="token punctuation">)</span>
          setDynamicMinExecutors<span class="token punctuation">(</span>minExecutors<span class="token punctuation">)</span>
          setDynamicMaxExecutors<span class="token punctuation">(</span>maxExecutors<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Shuffle</span>
      <span class="token keyword">def</span> setShuffleParallelism<span class="token punctuation">(</span>parallelism<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.default.parallelism"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">parallelism</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">def</span> setShuffleCompressEnabled<span class="token punctuation">(</span>shuffleCompressEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.shuffle.compress"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">shuffleCompressEnabled</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">def</span> setShuffleMaxSizePerReducer<span class="token punctuation">(</span>maxSizeMB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.shuffle.maxSizeInFlight"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">maxSizeMB</span><span class="token punctuation">}</span></span><span class="token string">m"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*m"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">def</span> setShuffleServiceEnabled<span class="token punctuation">(</span>shuffleServiceEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.shuffle.service.enabled"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">shuffleServiceEnabled</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeShuffle<span class="token punctuation">(</span>parallelism<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>shuffleCompressEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>
                                   maxSizeMB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">48</span><span class="token punctuation">,</span>shuffleServiceEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 如果用户没有指定分区数，则采用该值作为默认的分区数
         */</span>
        setShuffleParallelism<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment">/**
         * Shuffle 过程中 Map 端的输出数据是否压缩，建议生成过程中，数据规模较大时开启
         */</span>
        setShuffleCompressEnabled<span class="token punctuation">(</span>shuffleCompressEnabled<span class="token punctuation">)</span>

        <span class="token comment">/**
         * 设置Reducer端的缓冲区大小，生产环境中，服务器内存较大时，可以适当调大
         */</span>
        setShuffleMaxSizePerReducer<span class="token punctuation">(</span>maxSizeMB<span class="token punctuation">)</span>

        <span class="token comment">/**
         * 开启一个独立的外部服务，专门存储Executor产生的中间数据
         */</span>
        setShuffleServiceEnabled<span class="token punctuation">(</span>shuffleServiceEnabled<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Speculation</span>
      <span class="token keyword">def</span> setSpeculationEnabled<span class="token punctuation">(</span>speculationEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.speculation"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">speculationEnabled</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">def</span> setSpeculationInterval<span class="token punctuation">(</span>interval<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.speculation.interval"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">interval</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">,</span><span class="token string">"[1-9]\\d*s"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">def</span> setSpeculationQuantile<span class="token punctuation">(</span>quantile<span class="token operator">:</span><span class="token builtin">Float</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.speculation.quantile"</span><span class="token punctuation">,</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"</span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">quantile</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span><span class="token string">"0?\\.\\d+"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> optimizeSpeculation<span class="token punctuation">(</span>speculationEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>interval<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>quantile<span class="token operator">:</span><span class="token builtin">Float</span><span class="token operator">=</span><span class="token number">0.75F</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 是否开启推测执行服务，将各阶段(Stage)中执行慢的任务(Task)重启
         */</span>
        setSpeculationEnabled<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

        <span class="token comment">/**
         * 设置推测执行频次
         */</span>
        setSpeculationInterval<span class="token punctuation">(</span>interval<span class="token punctuation">)</span>

        <span class="token comment">/**
         * 设置推测执行阈值
         */</span>
        setSpeculationQuantile<span class="token punctuation">(</span>quantile<span class="token punctuation">)</span>
        <span class="token keyword">this</span>

      <span class="token punctuation">}</span>
      <span class="token comment">// Warehouse</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> warehouseDir<span class="token punctuation">(</span>hdfs<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        set<span class="token punctuation">(</span><span class="token string">"spark.sql.warehouse.dir"</span><span class="token punctuation">,</span>hdfs<span class="token punctuation">,</span><span class="token string">"hdfs://([a-z]\\w+|\\d{1,3}(\\.\\d{1,3}){3}):\\d{4,5}(/\\w+)+"</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> end<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>SparkSession<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        SparkSession
          <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
          <span class="token punctuation">.</span>enableHiveSupport<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">object</span> SparkFactory <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> apply<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> SparkFactory <span class="token operator">=</span> <span class="token keyword">new</span> SparkFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">trait</span> Builder<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 默认值能给就给</span>
    <span class="token comment">/**
     * 基本配置
     * @param appName
     * @param master 默认是本地方式
     * @param deployMode 默认是集群模式
     * @param eventLogEnabled 生产环境打开，测试环境关闭
     * @return
     */</span>
    <span class="token keyword">def</span> baseConfig<span class="token punctuation">(</span>appName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>master<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"local[*]"</span><span class="token punctuation">,</span>deployMode<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"client"</span><span class="token punctuation">,</span>eventLogEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 驱动端优化配置
     * @param memoryGB 驱动程序的内存大小
     * @param coreNum 驱动程序的核数
     * @param maxRstGB 驱动程序的最大结果大小
     * @param driverHost 驱动程序的主机地址：驱动程序会在主机地址上运行，并且集群中的其他节点会通过这个地址与驱动程序通信
     * @return
     */</span>
    <span class="token keyword">def</span> optimizeDriver<span class="token punctuation">(</span>memoryGB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>coreNum<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>maxRstGB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>driverHost<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token keyword">def</span> optimizeExecutor<span class="token punctuation">(</span>memoryGB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>coreNum<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 整体限制配置
     * @param maxCores 整体可用的最大核数
     * @param maxTaskFailure 单个任务失败的最大次数
     * @param maxLocalWaitS 容错机制：数据读取阶段允许等待的最长时间，超过时间切换到其他副本。
     * @return
     */</span>
    <span class="token keyword">def</span> optimizeLimit<span class="token punctuation">(</span>maxCores<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>maxTaskFailure<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>maxLocalWaitS<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 默认使用：Java序列化
     * 推荐使用：Kryo序列化 提速或对速度又要i去
     * 所有的自定义类型都要注册到Spark中，才能完成序列化。
     * @param serde 全包路径
     * @param classes 自定义类型，默认认为不需要指定，Class[_]表示类型未知。
     * @return Builder
     */</span>
    <span class="token keyword">def</span> optimizeSerializer<span class="token punctuation">(</span>serde<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"org.apache.spark.serializer.JavaSerializer"</span><span class="token punctuation">,</span>clas<span class="token operator">:</span>Array<span class="token punctuation">[</span>Class<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 在Spark的官方配置中，netTimeOutS可能被很多超时的数据调用。
     * @param netTimeOusS 判定网络超时的时间
     * @param schedulerMode 可能很多任务一起跑，因此公平调度
     * @return
     */</span>
    <span class="token keyword">def</span> optimizeNetAbout<span class="token punctuation">(</span>netTimeOusS<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span>schedulerMode<span class="token operator">:</span><span class="token builtin">String</span><span class="token operator">=</span><span class="token string">"FAIR"</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 动态分配-&gt;按需分配
     * 类似于配置线程池中的最大闲置线程数，根据需要去做动态分配
     * @param dynamicEnabled 是否开启动态分配
     * @param initialExecutors 初始启用的Executors的数量
     * @param minExecutors 最小启用的Executors的数量
     * @param maxExecutors 最大启用的Executors的数量
     * @return
     */</span>
    <span class="token keyword">def</span> optimizeDynamicAllocation<span class="token punctuation">(</span>dynamicEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>initialExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>minExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>maxExecutors<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 特指在没有指定分区数时，对分区数的配置。
     * 并行度和初始启用的Executors的数量一致，避免额外开销。
     *
     * @param parallelism
     * @param shuffleCompressEnabled
     * @param maxSizeMB
     * @param shuffleServiceEnabled
     * @return
     */</span>
    <span class="token keyword">def</span> optimizeShuffle<span class="token punctuation">(</span>parallelism<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>shuffleCompressEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>maxSizeMB<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>shuffleServiceEnabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token comment">/**
     * 推测执行，将运行时间长的任务，放到队列中，等待运行时间短的任务运行完成后，再运行。
     * @param enabled
     * @param interval Spark检查任务执行时间的时间间隔，单位是秒。
     * @param quantile 如果某个任务的执行时间超过指定分位数（如75%的任务执行时间），则认为该任务执行时间过长，需要启动推测执行。
     */</span>
    <span class="token keyword">def</span> optimizeSpeculation<span class="token punctuation">(</span>enabled<span class="token operator">:</span><span class="token builtin">Boolean</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span>interval<span class="token operator">:</span><span class="token builtin">Int</span><span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span>quantile<span class="token operator">:</span><span class="token builtin">Float</span><span class="token operator">=</span><span class="token number">0.75f</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token keyword">def</span> warehouseDir<span class="token punctuation">(</span>hdfs<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span>Builder
    <span class="token keyword">def</span> end<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>SparkSession
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="23_MySQLConfigFactory_529"></a>2.3 MySQLConfigFactory</h6> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">core</span>

<span class="token keyword">import</span> <span class="token namespace">core<span class="token punctuation">.</span></span>MySQLConfigFactory<span class="token punctuation">.</span><span class="token punctuation">{<!-- --></span>Getter<span class="token punctuation">,</span> Setter<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">core<span class="token punctuation">.</span></span>Validator<span class="token punctuation">.</span>check
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties

<span class="token keyword">class</span> MySQLConfigFactory <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Setter<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">new</span> Setter <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> setDriver<span class="token punctuation">(</span>driverCla<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Setter <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        check<span class="token punctuation">(</span><span class="token string">"name_of_mysql_driver_class"</span><span class="token punctuation">,</span>driverCla<span class="token punctuation">,</span><span class="token string">"com\\.mysql(\\.cj)?\\.jdbc\\.Driver"</span><span class="token punctuation">)</span>
        conf<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span>driverCla<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> setUrl<span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Setter <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        check<span class="token punctuation">(</span><span class="token string">"url_to_connect_mysql"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://([a-z]\\w+|\\d{1,3}(\\.\\d{1,3}){3}):\\d{4,5}/[a-z]\\w+(\\?.+)?"</span><span class="token punctuation">)</span>
        conf<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> setUser<span class="token punctuation">(</span>user<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Setter <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        check<span class="token punctuation">(</span><span class="token string">"user_to_connect_mysql"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span>
        conf<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> setPassword<span class="token punctuation">(</span>password<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Setter <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        check<span class="token punctuation">(</span><span class="token string">"password_to_connect_mysql"</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        conf<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> finish<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Getter <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> Getter <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">override</span> <span class="token keyword">def</span> getUrl<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> conf<span class="token punctuation">.</span>getProperty<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span>
          <span class="token keyword">override</span> <span class="token keyword">def</span> getConf<span class="token operator">:</span> Properties <span class="token operator">=</span> conf
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">object</span> MySQLConfigFactory <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> apply<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> MySQLConfigFactory <span class="token operator">=</span> <span class="token keyword">new</span> MySQLConfigFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">trait</span> Getter<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">def</span> getUrl<span class="token operator">:</span><span class="token builtin">String</span>
    <span class="token keyword">def</span> getConf<span class="token operator">:</span>Properties
  <span class="token punctuation">}</span>
  <span class="token keyword">trait</span> Setter <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">def</span> setDriver<span class="token punctuation">(</span>driverCla<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span>Setter
    <span class="token keyword">def</span> setUrl<span class="token punctuation">(</span>url<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span>Setter
    <span class="token keyword">def</span> setUser<span class="token punctuation">(</span>user<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span>Setter
    <span class="token keyword">def</span> setPassword<span class="token punctuation">(</span>password<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span>Setter
    <span class="token keyword">def</span> finish<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Getter
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="24__590"></a>2.4 测试调用</h6> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">test</span>

<span class="token keyword">import</span> <span class="token namespace">core<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>MySQLConfigFactory<span class="token punctuation">,</span> SparkFactory<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession

<span class="token keyword">object</span> Test <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Spark On Hive</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>baseConfig<span class="token punctuation">(</span><span class="token string">"ebs_01"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeDriver<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeLimit<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeSerializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeNetAbout<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeDynamicAllocation<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeShuffle<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>optimizeSpeculation<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>warehouseDir<span class="token punctuation">(</span><span class="token string">"hdfs://single01:9000/hive312/warehouse"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>end<span class="token punctuation">(</span><span class="token punctuation">)</span>

    spark<span class="token punctuation">.</span>table<span class="token punctuation">(</span><span class="token string">"yb12211.transaction"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token comment">// Spark On MySQL</span>
    <span class="token keyword">val</span> getter<span class="token operator">:</span> MySQLConfigFactory<span class="token punctuation">.</span>Getter <span class="token operator">=</span> MySQLConfigFactory<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setDriver<span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setUrl<span class="token punctuation">(</span><span class="token string">"jdbc:mysql://single01:3306/yb12211?useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setUser<span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setPassword<span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>finish<span class="token punctuation">(</span><span class="token punctuation">)</span>

    spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>jdbc<span class="token punctuation">(</span>getter<span class="token punctuation">.</span>getUrl<span class="token punctuation">,</span> <span class="token string">"test_table1_for_hbase_import"</span><span class="token punctuation">,</span> getter<span class="token punctuation">.</span>getConf<span class="token punctuation">)</span>

    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/bb/f7/sn25t7Pp_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7d8d25d84414447aa1788be7e1508a3a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Datawhale AI 夏令营——电力需求挑战赛——Task1学习笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9346da4ef5cb479968e7d086d67a0531/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">huawei USG6001v1学习---防火墙高可靠性（双机热备）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>