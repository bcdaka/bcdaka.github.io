<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>unipush 2.0流程及踩坑记录（后端调用接口，前端推送） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/7c2216d4dd46c6139d1962e57fa19309/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="unipush 2.0流程及踩坑记录（后端调用接口，前端推送）">
  <meta property="og:description" content="我发现了一个更好用的，三步搞定在线推送。http://t.csdnimg.cn/YSTYt unipush 在线离线示例
在DCLOUD开发者中心里面创建unipush的应用 如果遇到选择Android 包名后没有自动生成Android 应用签名的话，就是下图这样的。
这个情况多半就是通过直接创建云端证书造成的，没有编辑应用信息
没有云端证书的看这里
在我的应用，找到需要unipush的应用，点击编辑，然后把云端证书里面的内容填进去就好了
云服务空间，直接按照操作搞吧，这个不是我搞得。关联好后然后点击开通
在hbuilder里面找到项目，鼠标右键点击项目名称，创建云函数 这一步可以看官方文档，挺详细的。一定要好好写这一步，然后后端请求接口的时候才会有回调
添加push模块，设置targetSdkersion（targetSdkersion过高有些手机运行不了） 找到刚刚添加的push模块，设置云函数（下面是我的代码截图，上面是官方截图，所以文件名不一样，但是内容都是一样的）
&#39;use strict&#39;; const uniPush = uniCloud.getPushManager({ appId: &#34;__UNI__A4C6D3499&#34; }) exports.main = async (event) =&gt; { let obj = JSON.parse(event.body) const res = await uniPush.sendMessage({ &#34;push_clientid&#34;: obj.cids, // 设备id，支持多个以数组的形式指定多个设备，如[&#34;cid-1&#34;,&#34;cid-2&#34;]，数组长度不大于1000 &#34;title&#34;: obj.title, // 标题 &#34;content&#34;: obj.content, // 内容 &#34;payload&#34;: obj.data, // 数据 &#34;force_notification&#34;: true, // 服务端推送 需要加这一句 &#34;request_id&#34;: obj.request_id //请求唯一标识号，10-32位之间；如果request_id重复，会导致消息丢失 }) return res //一定要return回去 }; 最后上传部署">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-03T16:34:05+08:00">
    <meta property="article:modified_time" content="2024-06-03T16:34:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">unipush 2.0流程及踩坑记录（后端调用接口，前端推送）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2><strong><span style="color:#fe2c24;"> 我发现了一个更好用的，三步搞定在线推送。<a href="http://t.csdnimg.cn/YSTYt" rel="nofollow" title="http://t.csdnimg.cn/YSTYt">http://t.csdnimg.cn/YSTYt</a></span></strong></h2> 
<div class="csdn-video-box"> 
 <iframe id="PLRVIIqs-1700722380141" frameborder="0" src="https://live.csdn.net/v/embed/345835" allowfullscreen="true" data-mediaembed="csdn"></iframe> 
 <p>unipush 在线离线示例</p> 
</div> 
<h2>在<a class="link-info" href="https://dev.dcloud.net.cn/pages/common/login" rel="nofollow" title="DCLOUD开发者中心">DCLOUD开发者中心</a>里面创建unipush的应用</h2> 
<p><img alt="" height="868" src="https://images2.imgbox.com/fa/7b/rNjN5lMU_o.png" width="1200"></p> 
<p>如果遇到<span style="color:#fe2c24;"><strong>选择Android 包名后没有自动生成Android 应用签名</strong></span>的话，就是下图这样的。</p> 
<p><span style="color:#fe2c24;">这个情况多半就是通过直接创建云端证书造成的，没有编辑应用信息</span></p> 
<p><span style="color:#0d0016;">没有云端证书的看<a class="link-info" href="https://blog.csdn.net/m0_59203969/article/details/134573351" title="这里">这里</a></span></p> 
<p><img alt="" height="725" src="https://images2.imgbox.com/87/91/9PM0sSK5_o.png" width="1200"></p> 
<p></p> 
<p>在我的应用，找到需要unipush的应用，点击编辑，然后把云端证书里面的内容填进去就好了</p> 
<p><img alt="" height="808" src="https://images2.imgbox.com/02/38/jB4Kn9XW_o.png" width="1200"></p> 
<p>云服务空间，直接按照操作搞吧，这个不是我搞得。关联好后然后点击开通</p> 
<h2>在hbuilder里面找到项目，鼠标右键点击项目名称，创建云函数</h2> 
<p>这一步可以看<a class="link-info" href="https://ask.dcloud.net.cn/article/40283" rel="nofollow" title="官方文档">官方文档</a>，挺详细的。一定要好好写这一步，然后后端请求接口的时候才会有回调</p> 
<p><img alt="" height="711" src="https://images2.imgbox.com/80/0c/HUVdtHF4_o.png" width="817"></p> 
<p><img alt="" height="915" src="https://images2.imgbox.com/0f/76/v6hLnomY_o.png" width="809"></p> 
<h2>添加push模块，设置targetSdkersion（targetSdkersion过高有些手机运行不了）</h2> 
<p>找到刚刚添加的push模块，设置云函数（下面是我的代码截图，上面是官方截图，所以文件名不一样，但是内容都是一样的）</p> 
<p><img alt="" height="460" src="https://images2.imgbox.com/fd/73/9y27EdkX_o.png" width="1059"></p> 
<pre><code>'use strict';
const uniPush = uniCloud.getPushManager({
	appId: "__UNI__A4C6D3499"
})
exports.main = async (event) =&gt; {
	let obj = JSON.parse(event.body)
	const res = await uniPush.sendMessage({
		"push_clientid": obj.cids, // 设备id，支持多个以数组的形式指定多个设备，如["cid-1","cid-2"]，数组长度不大于1000  
		"title": obj.title, // 标题  
		"content": obj.content, // 内容  
		"payload": obj.data, // 数据  
		"force_notification": true, // 服务端推送 需要加这一句  
		"request_id": obj.request_id //请求唯一标识号，10-32位之间；如果request_id重复，会导致消息丢失   
	})
	return res   //一定要return回去
};</code></pre> 
<p> 最后上传部署</p> 
<p><img alt="" height="501" src="https://images2.imgbox.com/13/66/b5vHAXKr_o.png" width="799"></p> 
<p>在app.vue里面写入这个两行代码，一个是点击推送消息的事件，一个是获取用户cid信息（用于给指定用户推送，例如聊天信息，订单信息，都是指定用户）。然后一定要先检测系统权限，直接复制这个大佬的代码 。有些手机首次进入又会自动提醒是否消息通知，这个自己搞搞兼容吧。自定义基座需要手动打开这个权限。 <a class="link-info" href="https://blog.csdn.net/qq_40745143/article/details/133763326" title="链接地址">链接地址</a></p> 
<p><img alt="" height="432" src="https://images2.imgbox.com/aa/c2/4XpNWeGp_o.png" width="1047"></p> 
<pre><code>// #ifdef APP-PLUS
			plus.push.addEventListener("click", function(msg) {
				console.log(msg);
				uni.switchTab({
					url:'/pages/user/index'
				})
			}, false);
			uni.getPushClientId({
					success: res =&gt; {
						console.log(res.cid);
					}
				})
				this.getQuanxian()
			// #endif</code></pre> 
<p>获取通知权限还有一个方法就是<a class="link-info" href="https://uniapp.dcloud.net.cn/api/system/getappauthorizesetting.html#getappauthorizesetting" rel="nofollow" title="官方文档">官方文档</a></p> 
<pre><code>// #ifdef APP-PLUS 
			const notificationAuthorized = uni.getAppAuthorizeSetting().notificationAuthorized
			if(notificationAuthorized=='denied'){
				uni.showModal({
					title: '提示',
					content: '是否前往打开通知权限',
					success: res =&gt; {
						if (res.confirm) {
							this.openTongZhi()
						} else if (res.cancel) {
							console.log('用户点击取消');
						}
					}
				})
			}
			// that.getQuanxian()
			// #endif </code></pre> 
<p></p> 
<p>然后勾选配置文件（如果要配置离线，请先看离线通知标题那部分）</p> 
<p><img alt="" height="551" src="https://images2.imgbox.com/db/d7/tCchWB4y_o.png" width="966"></p> 
<p><span style="color:#fe2c24;"><strong>有些手机运行自定义基座失败，这个设置成28试一下</strong></span></p> 
<p><img alt="" height="522" src="https://images2.imgbox.com/38/5b/12xB4shJ_o.png" width="1006"></p> 
<h2>打自定义基座包，然后运行</h2> 
<p>然后打包一定是自定义基座才能本地调试</p> 
<p><img alt="" height="1011" src="https://images2.imgbox.com/3c/f3/uW4f2jZn_o.png" width="1200"></p> 
<h2>检测基座</h2> 
<p>运行自定义基座之前，得先卸载手机里面之前所有相关应用，然后拿到cid检测一下，能获取到信息就好了</p> 
<p><img alt="" height="766" src="https://images2.imgbox.com/7e/fb/VW9tvmS3_o.png" width="1200"></p> 
<h2>配置云函数url化（作用是，后端直接调接口然后进行推送）</h2> 
<p><img alt="" height="663" src="https://images2.imgbox.com/a7/93/Ehr0ez5h_o.png" width="1200"></p> 
<p><img alt="" height="803" src="https://images2.imgbox.com/49/aa/pcQy3C8S_o.png" width="1200"></p> 
<p><img alt="" height="664" src="https://images2.imgbox.com/2d/7e/CCL081Jk_o.png" width="1127"></p> 
<p></p> 
<p>这个参数就是一一对应的！！！</p> 
<p><span style="color:#fe2c24;">设备在线离线都是走这个接口！！！</span></p> 
<h2>离线自定义铃声</h2> 
<p>我搞的时候，小米不支持，然后主要是为了离线通知有声音</p> 
<p><a href="https://ext.dcloud.net.cn/plugin?id=7482" rel="nofollow" title="自定义推送铃声和渠道 - DCloud 插件市场">自定义推送铃声和渠道 - DCloud 插件市场</a></p> 
<p>导入插件后使用</p> 
<p><img alt="" height="668" src="https://images2.imgbox.com/56/db/QEK2mFpk_o.png" width="1081"></p> 
<p><img alt="" height="548" src="https://images2.imgbox.com/d5/51/nwwQ0Vyh_o.png" width="1194"></p> 
<p>channelId是</p> 
<p><img alt="" height="569" src="https://images2.imgbox.com/f3/f3/eTFWDwRq_o.png" width="1100"></p> 
<p><span style="color:#fe2c24;">要是没有声音 soundName设置成"", 只要导入了这个 有系统铃声就认命吧</span></p> 
<h2><span style="color:#0d0016;">离线通知（app需要上线的话看这个吧）</span></h2> 
<p><span style="color:#0d0016;">配置文件搜索</span></p> 
<p><img alt="" height="699" src="https://images2.imgbox.com/29/dc/jcQSudwz_o.png" width="1088"></p> 
<p><img alt="" height="877" src="https://images2.imgbox.com/72/b1/IVMcxtsG_o.png" width="1095"></p> 
<p>直接到每个厂商平台，<span style="color:#fe2c24;">上图注意事项</span>那里有厂商地址。搜索<span style="color:#fe2c24;">消息推送</span>开通就好了，我们是大多平台都先上线了的。华为可以不用上线，直接申请。</p> 
<p><img alt="" height="493" src="https://images2.imgbox.com/bd/48/U7IkOIVp_o.png" width="963"></p> 
<p>像华为这种，你直接找对应字段填进来就好了。</p> 
<p><img alt="" height="611" src="https://images2.imgbox.com/3b/a5/p6DXRH54_o.png" width="802"></p> 
<p><img alt="" height="845" src="https://images2.imgbox.com/53/5a/H37QOPCr_o.png" width="1200"></p> 
<h2><strong>总结及遇到的坑</strong></h2> 
<p><strong>0.在dcloud里面，创建unipush2.0的时候，<span style="color:#fe2c24;">找到Android 包名但是没自动生成Android 应用签名。</span></strong></p> 
<p><strong><img alt="" height="466" src="https://images2.imgbox.com/dd/44/eouM5uTv_o.png" width="1200"></strong></p> 
<p><strong>点击修改完善一下</strong></p> 
<p><strong>1.先勾选unipush2.0 不搞离线推送，然后在app.vue里面获取cid好测试。然后创建云函数。</strong></p> 
<p><strong>2.<span style="color:#fe2c24;">自定义基座不能运行：</span>卸载之前手机上所有相关的包，重新运行。要不然就是<span style="color:#fe2c24;">targetSdkersion</span>设置低一点。</strong></p> 
<p><strong>3.<span style="color:#fe2c24;">后端发送请求时没有反应或者报错：</span>没有反应可能是uniapp云函数那里配置有问题，或者是get请求或者post请求都可以，只是请求体不一样。然后就是云函数接受的地方和发送请求的地方参数得一样哦</strong></p> 
<p><img alt="" height="644" src="https://images2.imgbox.com/b6/0e/iBnWM0Ka_o.png" width="1181"></p> 
<p><strong>4.<span style="color:#fe2c24;">没有收到推送消息：</span><span style="color:#0d0016;">先看手机<a class="link-info" href="https://blog.csdn.net/qq_40745143/article/details/133763326" title="消息通知权限">消息通知权限</a>是否打开啊，然后打开app找到通过uni.getPushClientId获取的cid，然后去dcloud里面检查。</span><span style="color:#fe2c24;">或者勾选上离线推送再打包试一下</span></strong></p> 
<p><img alt="" height="765" src="https://images2.imgbox.com/6c/38/lYZOqs5v_o.png" width="1200"></p> 
<p>看能不能查询设备状态，在线都查询不到的话，看看哪个步骤错了，或者卸载之前的app，重新打自定义基座包。可以查询离线，但是收不到消息的话，看下这里</p> 
<p><img alt="" height="716" src="https://images2.imgbox.com/d3/33/jVYvm9HR_o.png" width="1200"></p> 
<p>5.修改配置文件了配置文件啥的，然后运行不了，卸载手机上的，重新打自定义包啊</p> 
<p>6.离线有些手机没有声音。各个厂商配置不一样嘛，唉这个问问个推技术吧，厂商更新了他们知道</p> 
<p>7.个推官方文档，叫你怎样集成各个厂商（主要是离线推送）。<a class="link-info" href="https://docs.getui.com/getui/mobile/vendor/vendor_open/" rel="nofollow" title="链接地址">链接地址</a></p> 
<p>最后最后：个推技术客服真的很友好，不懂得可以直接问他们</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e0e8f019399527043c92a00dd141edf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">常见Rabbitmq面试题及答案总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a768ba39f83239e4f1a65f93cf7a3f31/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;入门到精通】C&#43;&#43; thread线程库 [ C&#43;&#43;入门 ]</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>