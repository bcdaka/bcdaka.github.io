<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python中15个让你代码更优雅的上下文管理器用法 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e7ac478bd165deb19fea177875a2daf3/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python中15个让你代码更优雅的上下文管理器用法">
  <meta property="og:description" content="文末赠免费精品编程资料~~
今天，我们要探索的是Python中一个超级实用又往往被低估的特性——上下文管理器。这可不是普通的魔法，它能让你的代码更加整洁、安全，还能自动处理资源，就像变魔术一样。准备好，让我们一起揭开它的神秘面纱。
1. 自动打开和关闭文件 问题场景：每次操作文件，都要手动打开和关闭，忘了close()可是大忌。
优雅解决方案：
with open(&#39;example.txt&#39;, &#39;r&#39;) as file: content = file.read() 这段代码自动管理了文件句柄，无论是否发生异常，文件都会被正确关闭。魔法在于with关键字，后面跟着的就是上下文管理器对象。
2. 自定义上下文管理器 进阶玩法：自己定义上下文管理器，比如计时器。
class Timer: def __enter__(self): self.start = time.time() def __exit__(self, exc_type, exc_val, exc_tb): self.end = time.time() print(f&#34;操作耗时: {self.end - self.start}秒&#34;) with Timer(): time.sleep(2) 这里，__enter__和__exit__是关键方法，让类变成了上下文管理器。
3. 使用contextlib简化代码 简化秘诀：不想写类？contextlib.contextmanager来帮忙。
from contextlib import contextmanager @contextmanager def simple_timer(): start = time.time() yield end = time.time() print(f&#34;耗时: {end - start}秒&#34;) with simple_timer(): time.sleep(1) yield像一个分界点，之前的是__enter__，之后的是__exit__。
4. 数据库连接管理 实战案例：数据库操作中，自动管理连接和关闭。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-30T23:55:03+08:00">
    <meta property="article:modified_time" content="2024-07-30T23:55:03+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python中15个让你代码更优雅的上下文管理器用法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/5b/a6/vHISpZXv_o.jpg" alt=""></p> 
<p><strong>文末赠免费精品编程资料~~</strong></p> 
<p>今天，我们要探索的是Python中一个超级实用又往往被低估的特性——<strong>上下文管理器</strong>。这可不是普通的魔法，它能让你的代码更加整洁、安全，还能自动处理资源，就像变魔术一样。准备好，让我们一起揭开它的神秘面纱。</p> 
<h3><a id="1__11"></a>1. 自动打开和关闭文件</h3> 
<p><strong>问题场景</strong>：每次操作文件，都要手动打开和关闭，忘了<code>close()</code>可是大忌。</p> 
<p><strong>优雅解决方案</strong>：</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'example.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    content <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这段代码自动管理了文件句柄，无论是否发生异常，文件都会被正确关闭。魔法在于<code>with</code>关键字，后面跟着的就是上下文管理器对象。</p> 
<h3><a id="2__22"></a>2. 自定义上下文管理器</h3> 
<p><strong>进阶玩法</strong>：自己定义上下文管理器，比如计时器。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Timer</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"操作耗时: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>end <span class="token operator">-</span> self<span class="token punctuation">.</span>start<span class="token punctuation">}</span></span><span class="token string">秒"</span></span><span class="token punctuation">)</span>

<span class="token keyword">with</span> Timer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里，<code>__enter__</code>和<code>__exit__</code>是关键方法，让类变成了上下文管理器。</p> 
<h3><a id="3_contextlib_40"></a>3. 使用<code>contextlib</code>简化代码</h3> 
<p><strong>简化秘诀</strong>：不想写类？<code>contextlib.contextmanager</code>来帮忙。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager

<span class="token decorator annotation punctuation">@contextmanager</span>
<span class="token keyword">def</span> <span class="token function">simple_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span>
    end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"耗时: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>end <span class="token operator">-</span> start<span class="token punctuation">}</span></span><span class="token string">秒"</span></span><span class="token punctuation">)</span>

<span class="token keyword">with</span> simple_timer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>yield</code>像一个分界点，之前的是<code>__enter__</code>，之后的是<code>__exit__</code>。</p> 
<h3><a id="4__59"></a>4. 数据库连接管理</h3> 
<p><strong>实战案例</strong>：数据库操作中，自动管理连接和关闭。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> contextlib <span class="token keyword">import</span> closing
<span class="token keyword">import</span> sqlite3

<span class="token keyword">with</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"my_database.db"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    <span class="token keyword">with</span> closing<span class="token punctuation">(</span>connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里，<code>closing</code>也是一个上下文管理器，确保连接在操作完成后关闭。</p> 
<h3><a id="5__74"></a>5. 锁定资源避免并发冲突</h3> 
<p><strong>并发安全</strong>：在多线程环境下，使用<code>threading.Lock</code>作为上下文管理器。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> threading

lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> lock<span class="token punctuation">:</span>
    <span class="token comment"># 在这里进行需要保护的代码</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"我是安全的并发操作"</span><span class="token punctuation">)</span>
</code></pre> 
<p>确保同一时间只有一个线程访问这段代码。</p> 
<h3><a id="6__89"></a>6. 自动重试机制</h3> 
<p><strong>提升稳定性</strong>：利用上下文管理器实现自动重试逻辑。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> retrying <span class="token keyword">import</span> retry

<span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop_max_attempt_number<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">unreliable_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Failed!"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"成功执行了！"</span><span class="token punctuation">)</span>

unreliable_function<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>虽然不是直接的上下文管理器示例，但通过装饰器实现了类似的效果。</p> 
<h3><a id="7__107"></a>7. 临时改变配置或环境变量</h3> 
<p><strong>环境控制</strong>：在特定范围内临时修改配置。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">TempConfig</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>old_value <span class="token operator">=</span> key<span class="token punctuation">,</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span>self<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>value

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>old_value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span>self<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span>self<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>old_value

<span class="token keyword">with</span> TempConfig<span class="token punctuation">(</span><span class="token string">'DEBUG'</span><span class="token punctuation">,</span> <span class="token string">'True'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'DEBUG'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 输出: True</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'DEBUG'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 如果之前没设置，这里可能输出None</span>
</code></pre> 
<h3><a id="8__130"></a>8. 自动清理临时文件</h3> 
<p><strong>资源管理</strong>：生成并自动清理临时文件。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tempfile

<span class="token keyword">with</span> tempfile<span class="token punctuation">.</span>TemporaryFile<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> temp_file<span class="token punctuation">:</span>
    temp_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"Hello, World!"</span><span class="token punctuation">)</span>
    temp_file<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>temp_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 文件自动删除，无需显式调用temp_file.close()</span>
</code></pre> 
<p>临时文件在离开<code>with</code>块后自动消失。</p> 
<h3><a id="9__145"></a>9. 日志上下文管理</h3> 
<p><strong>日志管理</strong>：根据不同的上下文调整日志级别。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">LogLevelManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger
        self<span class="token punctuation">.</span>prev_level <span class="token operator">=</span> logger<span class="token punctuation">.</span>getEffectiveLevel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>level<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>prev_level<span class="token punctuation">)</span>

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

<span class="token keyword">with</span> LogLevelManager<span class="token punctuation">(</span>logger<span class="token punctuation">,</span> logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"这是调试信息"</span><span class="token punctuation">)</span>
</code></pre> 
<p>这样可以在特定代码段内调整日志级别，而不影响全局设置。</p> 
<h3><a id="10__169"></a>10. 错误处理与回滚</h3> 
<p><strong>事务管理</strong>：在数据库操作中，确保要么全成功，要么全失败。</p> 
<pre><code class="prism language-python"><span class="token comment"># 假设有一个数据库事务处理函数</span>
<span class="token keyword">def</span> <span class="token function">transaction_operation</span><span class="token punctuation">(</span>db_connection<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 执行一系列数据库操作</span>
        db_connection<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        db_connection<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> e

<span class="token comment"># 使用上下文管理器包装事务逻辑</span>
<span class="token keyword">with</span> db_connection<span class="token punctuation">:</span>
    transaction_operation<span class="token punctuation">(</span>db_connection<span class="token punctuation">)</span>
</code></pre> 
<p>这里假设<code>db_connection</code>是一个支持上下文管理的数据库连接对象，自动处理提交和回滚。</p> 
<hr> 
<h3><a id="_191"></a>高级用法和最佳实践</h3> 
<h3><a id="11__193"></a>11. 上下文管理器的链式使用</h3> 
<p><strong>高级技巧</strong>：有时候，我们需要同时管理多个资源，这时可以链式使用多个上下文管理器。</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'file.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">,</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'database.db'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"准备存储数据..."</span><span class="token punctuation">)</span>
    cursor <span class="token operator">=</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO table VALUES (?)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>这段代码展示了如何同时管理文件和数据库连接，确保两个资源都被妥善处理。</p> 
<h3><a id="12__205"></a>12. 上下文表达式</h3> 
<p><strong>简洁编码</strong>：Python 3.7+引入了上下文表达式，使得单行上下文管理变得可能。</p> 
<pre><code class="prism language-python">content <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'example.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>虽然这种方式简洁，但在处理可能抛出异常的情况时不如<code>with</code>语句清晰，不推荐用于复杂的资源管理。</p> 
<h3><a id="13___finally_214"></a>13. 上下文管理器的替代方案 - 使用<code>finally</code></h3> 
<p><strong>了解替代方案</strong>：在没有上下文管理器的情况下，<code>try...finally...</code>是确保资源清理的经典方式。</p> 
<pre><code class="prism language-python"><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'file.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>但这不如上下文管理器优雅，且容易忘记。</p> 
<h3><a id="14__227"></a>14. 第三方库中的上下文管理器</h3> 
<p><strong>扩展知识</strong>：许多第三方库提供了自己的上下文管理器，如<code>requests</code>库中的响应对象自动关闭。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

<span class="token keyword">with</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://api.example.com/data'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里，<code>response</code>对象在退出<code>with</code>块时自动关闭连接。</p> 
<h3><a id="15__239"></a>15. 设计模式与上下文管理器</h3> 
<p><strong>设计思维</strong>：将上下文管理器应用于设计模式，如单例模式，确保资源的唯一实例。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SingletonMeta</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instances <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cls <span class="token keyword">not</span> <span class="token keyword">in</span> cls<span class="token punctuation">.</span>_instances<span class="token punctuation">:</span>
            instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__call__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
            cls<span class="token punctuation">.</span>_instances<span class="token punctuation">[</span>cls<span class="token punctuation">]</span> <span class="token operator">=</span> instance
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instances<span class="token punctuation">[</span>cls<span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>SingletonMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token comment"># 使用时</span>
singleton1 <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span>
singleton2 <span class="token operator">=</span> Singleton<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> singleton1 <span class="token keyword">is</span> singleton2
</code></pre> 
<p>虽然这个例子没有直接使用上下文管理器，但它展示了元类如何在更深层次上控制对象的创建，这与上下文管理器在资源控制上的理念相呼应。</p> 
<h3><a id="_263"></a>结语</h3> 
<p>通过这些深入的探讨，你不仅掌握了上下文管理器的基础和高级用法，还学会了如何将其融入更广泛的设计思想中。</p> 
<p>好了，今天的分享就到这里了，我们下期见。如果本文对你有帮助，请<strong>点赞、转发、点个在看</strong>吧！</p> 
<h3><a id="_275"></a>文末福利</h3> 
<p>请关注下方公众号并后台回复<strong>编程资料</strong>免费获取Python编程、人工智能、爬虫等100+本精品电子书。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cde9658693e275761d1728d0c6cf777a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">golang JSON序列化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e4017b7ce80608b4d71d340f243b6b5b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【RabbitMQ】超详细Windows系统下RabbitMQ的安装配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>