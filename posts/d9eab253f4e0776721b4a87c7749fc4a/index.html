<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android手势识别GestureDetector和ScaleGestureDetector介绍与使用，以自定义一个可拖拽拉伸的ImageView为例 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d9eab253f4e0776721b4a87c7749fc4a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android手势识别GestureDetector和ScaleGestureDetector介绍与使用，以自定义一个可拖拽拉伸的ImageView为例">
  <meta property="og:description" content="一、GestureDetector 1. 简介 GestureDetector主要用于检测单指手势，例如单击、长按、滑动等，不支持多指手势。
2. SimpleOnGestureListener 内部类 GestureDetector.SimpleOnGestureListener 是用于处理手势事件的辅助类，它包含了一系列回调方法，用于处理不同类型的单指手势事件。下面是对每个回调方法的简要介绍：
onDown(MotionEvent e): 当用户按下（Down）手指时触发。这个方法返回 true 表示事件被消费了，false 表示未被消费。
onShowPress(MotionEvent e): 当用户按下并保持按压一段时间时触发。它表示按下动作已被识别，但尚未发生其它任何行为。
onSingleTapUp(MotionEvent e): 当用户轻击屏幕时触发。这个方法返回 true 表示事件被消费了，false 表示未被消费。
onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY): 当用户在屏幕上滚动时触发。它提供了滚动开始和结束时的事件信息，以及在X和Y方向上的距离差。
onLongPress(MotionEvent e): 当用户长按屏幕时触发。
onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY): 当用户迅速滑动手指并松开时触发。它提供了滑动开始和结束时的事件信息，以及在X和Y方向上的速度。
onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY): 当用户在屏幕上滚动时触发。与第四个回调方法不同，这个方法在滚动过程中持续触发，而不仅仅是在滚动结束时触发。
onDoubleTap(MotionEvent e): 当用户双击屏幕时触发。
onDoubleTapEvent(MotionEvent e): 当双击事件包含按下、移动和抬起动作时触发。通常与 onDoubleTap() 结合使用，以处理更复杂的双击手势。
onSingleTapConfirmed(MotionEvent e): 当确认发生了单击事件时触发。与 onSingleTapUp() 不同的是，这个方法确保了事件是单击事件而不是双击事件。
这些回调方法提供了处理各种类型手势事件的灵活性，可以根据需求选择实现相应的方法来处理手势事件。
3. 示例 import android.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-07T19:05:37+08:00">
    <meta property="article:modified_time" content="2024-04-07T19:05:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android手势识别GestureDetector和ScaleGestureDetector介绍与使用，以自定义一个可拖拽拉伸的ImageView为例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="GestureDetector_0"></a>一、GestureDetector</h2> 
<h3><a id="1__1"></a>1. 简介</h3> 
<p>GestureDetector主要用于检测单指手势，例如单击、长按、滑动等，不支持多指手势。</p> 
<h3><a id="2_SimpleOnGestureListener__4"></a>2. SimpleOnGestureListener 内部类</h3> 
<p>GestureDetector.SimpleOnGestureListener 是用于处理手势事件的辅助类，它包含了一系列回调方法，用于处理不同类型的单指手势事件。下面是对每个回调方法的简要介绍：</p> 
<ul><li> <p><strong>onDown(MotionEvent e)</strong>: 当用户按下（Down）手指时触发。这个方法返回 true 表示事件被消费了，false 表示未被消费。</p> </li><li> <p><strong>onShowPress(MotionEvent e)</strong>: 当用户按下并保持按压一段时间时触发。它表示按下动作已被识别，但尚未发生其它任何行为。</p> </li><li> <p><strong>onSingleTapUp(MotionEvent e)</strong>: 当用户轻击屏幕时触发。这个方法返回 true 表示事件被消费了，false 表示未被消费。</p> </li><li> <p><strong>onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY)</strong>: 当用户在屏幕上滚动时触发。它提供了滚动开始和结束时的事件信息，以及在X和Y方向上的距离差。</p> </li><li> <p><strong>onLongPress(MotionEvent e)</strong>: 当用户长按屏幕时触发。</p> </li><li> <p><strong>onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY)</strong>: 当用户迅速滑动手指并松开时触发。它提供了滑动开始和结束时的事件信息，以及在X和Y方向上的速度。</p> </li><li> <p><strong>onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY)</strong>: 当用户在屏幕上滚动时触发。与第四个回调方法不同，这个方法在滚动过程中持续触发，而不仅仅是在滚动结束时触发。</p> </li><li> <p><strong>onDoubleTap(MotionEvent e)</strong>: 当用户双击屏幕时触发。</p> </li><li> <p><strong>onDoubleTapEvent(MotionEvent e)</strong>: 当双击事件包含按下、移动和抬起动作时触发。通常与 onDoubleTap() 结合使用，以处理更复杂的双击手势。</p> </li><li> <p><strong>onSingleTapConfirmed(MotionEvent e)</strong>: 当确认发生了单击事件时触发。与 onSingleTapUp() 不同的是，这个方法确保了事件是单击事件而不是双击事件。</p> </li></ul> 
<p>这些回调方法提供了处理各种类型手势事件的灵活性，可以根据需求选择实现相应的方法来处理手势事件。</p> 
<h3><a id="3__29"></a>3. 示例</h3> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AttributeSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">GestureDetector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MotionEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">View</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyView</span> <span class="token keyword">extends</span> <span class="token class-name">View</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">GestureDetector</span> gestureDetector<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyView</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">AttributeSet</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 实例化 GestureDetector，并传入 SimpleOnGestureListener 对象</span>
        gestureDetector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GestureDetector</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyGestureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将触摸事件传递给 GestureDetector</span>
        <span class="token keyword">return</span> gestureDetector<span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MyGestureListener</span> <span class="token keyword">extends</span> <span class="token class-name">GestureDetector<span class="token punctuation">.</span>SimpleOnGestureListener</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onDown</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 用户按下屏幕时触发</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回 true 表示事件被消费</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onSingleTapConfirmed</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 单击事件确认时触发</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onDoubleTap</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 双击事件时触发</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLongPress</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 长按事件时触发</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onScroll</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e1<span class="token punctuation">,</span> <span class="token class-name">MotionEvent</span> e2<span class="token punctuation">,</span> <span class="token keyword">float</span> distanceX<span class="token punctuation">,</span> <span class="token keyword">float</span> distanceY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 滚动事件时触发</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 其他手势事件处理方法...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="ScaleGestureDetector_91"></a>二、ScaleGestureDetector</h2> 
<h3><a id="1__92"></a>1. 简介</h3> 
<p>用于检测缩放手势，即双指捏合或者扩张的手势。它提供了 onScale() 和 onScaleBegin() 等回调方法来处理缩放手势的开始、进行中和结束时的事件。</p> 
<h3><a id="2_SimpleOnGestureListener__95"></a>2. SimpleOnGestureListener 内部类</h3> 
<p>ScaleGestureDetector.SimpleOnGestureListener 用于处理手势事件的辅助类，它包含了一系列回调方法，用于处理不同类型的双指手势事件。下面是对每个回调方法的简要介绍：</p> 
<ul><li> <p><strong>onScale(ScaleGestureDetector detector)</strong>: 当缩放手势进行中时调用。这个方法会在缩放手势进行过程中持续调用，每次缩放都会触发。参数 detector 提供了有关缩放手势的信息，如当前的缩放因子等。</p> </li><li> <p><strong>onScaleBegin(ScaleGestureDetector detector)</strong>: 当缩放手势开始时调用。这个方法在缩放手势的第一次触发时调用，可以用来初始化缩放相关的状态。参数 detector 提供了有关缩放手势的信息。</p> </li><li> <p><strong>onScaleEnd(ScaleGestureDetector detector)</strong>: 当缩放手势结束时调用。这个方法在缩放手势结束后调用，可以用来清理缩放相关的状态。参数 detector 提供了有关缩放手势的信息。</p> </li></ul> 
<h3><a id="3__105"></a>3. 示例</h3> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AttributeSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MotionEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">ScaleGestureDetector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">View</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyScaleView</span> <span class="token keyword">extends</span> <span class="token class-name">View</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">ScaleGestureDetector</span> scaleGestureDetector<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">float</span> scaleFactor <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyScaleView</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">AttributeSet</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleGestureDetector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScaleGestureDetector</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScaleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将触摸事件传递给 ScaleGestureDetector</span>
        scaleGestureDetector<span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDraw</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在画布上绘制内容，并根据 scaleFactor 进行缩放</span>
        canvas<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>scaleFactor<span class="token punctuation">,</span> scaleFactor<span class="token punctuation">,</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2f</span><span class="token punctuation">,</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绘制内容...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ScaleListener</span> <span class="token keyword">extends</span> <span class="token class-name">ScaleGestureDetector<span class="token punctuation">.</span>SimpleOnScaleGestureListener</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onScale</span><span class="token punctuation">(</span><span class="token class-name">ScaleGestureDetector</span> detector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 缩放因子的变化</span>
            scaleFactor <span class="token operator">*=</span> detector<span class="token punctuation">.</span><span class="token function">getScaleFactor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 限制缩放因子的范围（可选）</span>
            scaleFactor <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.1f</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>scaleFactor<span class="token punctuation">,</span> <span class="token number">5.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 重绘 View</span>
            <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="ImageView_153"></a>三、自定义一个可拖拽和拉伸的ImageView</h2> 
<h3><a id="1__154"></a>1. 思路整理</h3> 
<ul><li>首先，我们可以直接继承 ImageView，并通过 Matrix 来控制图片的移动和拉伸。</li><li>其次，使用 GestureDetector 监听移动的相关事件，使用 ScaleGestureDetector 监听拉伸的相关事件。</li><li>最后，我们可能需要控制图片最大和最小缩放的比例。实际应用中还会考虑一些图片边界、双击放大、动画等，可根据需求自行添加。</li></ul> 
<h3><a id="2__159"></a>2. 示例</h3> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Bitmap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Canvas</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span></span><span class="token class-name">Matrix</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span></span><span class="token class-name">BitmapDrawable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span></span><span class="token class-name">ColorDrawable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span></span><span class="token class-name">Drawable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AttributeSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">GestureDetector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MotionEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">ScaleGestureDetector</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NonNull</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Nullable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>widget<span class="token punctuation">.</span></span><span class="token class-name">AppCompatImageView</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DragZoomImageView</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatImageView</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NONE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DRAG</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ZOOM</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> mMode <span class="token operator">=</span> <span class="token constant">NONE</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Matrix</span> mFinalMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Matrix</span> mSavedMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 图像以FitXY显示时使用的Scale大小</span>
    <span class="token keyword">private</span> <span class="token keyword">float</span> mOriginScale <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token comment">// 图像的最小、最大缩放比例</span>
    <span class="token keyword">private</span> <span class="token keyword">float</span> mMinScale <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">float</span> mMaxScale <span class="token operator">=</span> <span class="token number">5.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">float</span> mCurrentScale <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Bitmap</span> mBitmap<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">GestureDetector</span> mGestureDetector<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ScaleGestureDetector</span> mScaleGestureDetector<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DragZoomImageView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DragZoomImageView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">AttributeSet</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DragZoomImageView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">AttributeSet</span> attrs<span class="token punctuation">,</span> <span class="token keyword">int</span> defStyleAttr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setScaleType</span><span class="token punctuation">(</span><span class="token class-name">ScaleType</span><span class="token punctuation">.</span><span class="token constant">MATRIX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mGestureDetector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GestureDetector</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GestureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mScaleGestureDetector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScaleGestureDetector</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScaleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onSizeChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> h<span class="token punctuation">,</span> <span class="token keyword">int</span> oldw<span class="token punctuation">,</span> <span class="token keyword">int</span> oldh<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onSizeChanged</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> oldw<span class="token punctuation">,</span> oldh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Drawable</span> drawable <span class="token operator">=</span> <span class="token function">getDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token function">drawableToBitmap</span><span class="token punctuation">(</span>drawable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Matrix</span> matrix <span class="token operator">=</span> <span class="token function">getFitCenterMatrix</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setImageMatrix</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOriginScale <span class="token operator">=</span> <span class="token function">getMatrixScaleX</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mBitmap <span class="token operator">=</span> bitmap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setImageMatrix</span><span class="token punctuation">(</span><span class="token class-name">Matrix</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setImageMatrix</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFinalMatrix<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setImageBitmap</span><span class="token punctuation">(</span><span class="token class-name">Bitmap</span> bm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bm <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Matrix</span> matrix <span class="token operator">=</span> <span class="token function">getFitCenterMatrix</span><span class="token punctuation">(</span>bm<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bm<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setImageMatrix</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mOriginScale <span class="token operator">=</span> <span class="token function">getMatrixScaleX</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mBitmap <span class="token operator">=</span> bm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBitmap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_MASK</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_DOWN</span><span class="token operator">:</span>  <span class="token comment">// 单指</span>
                mMode <span class="token operator">=</span> <span class="token constant">DRAG</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">MotionEvent</span><span class="token punctuation">.</span><span class="token constant">ACTION_POINTER_DOWN</span><span class="token operator">:</span>  <span class="token comment">// 多指</span>
                mMode <span class="token operator">=</span> <span class="token constant">ZOOM</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mMode <span class="token operator">==</span> <span class="token constant">DRAG</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mGestureDetector<span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mMode <span class="token operator">==</span> <span class="token constant">ZOOM</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mScaleGestureDetector<span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleScale</span><span class="token punctuation">(</span><span class="token keyword">float</span> scale<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">handleScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">,</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleScale</span><span class="token punctuation">(</span><span class="token keyword">float</span> scale<span class="token punctuation">,</span> <span class="token keyword">float</span> px<span class="token punctuation">,</span> <span class="token keyword">float</span> py<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&lt;</span> mMinScale<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scale <span class="token operator">=</span> mMinScale<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> mMaxScale<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            scale <span class="token operator">=</span> mMaxScale<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentScale <span class="token operator">==</span> scale<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mCurrentScale <span class="token operator">=</span> scale<span class="token punctuation">;</span>  <span class="token comment">// record scale</span>
        <span class="token keyword">float</span> newScale <span class="token operator">=</span> scale <span class="token operator">*</span> mOriginScale<span class="token punctuation">;</span>
        <span class="token keyword">float</span> oldScale <span class="token operator">=</span> <span class="token function">getMatrixScaleX</span><span class="token punctuation">(</span>mFinalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> postScale <span class="token operator">=</span> newScale <span class="token operator">/</span> oldScale<span class="token punctuation">;</span>
        mFinalMatrix<span class="token punctuation">.</span><span class="token function">postScale</span><span class="token punctuation">(</span>postScale<span class="token punctuation">,</span> postScale<span class="token punctuation">,</span> px<span class="token punctuation">,</span> py<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setImageMatrix</span><span class="token punctuation">(</span>mFinalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">float</span> <span class="token function">getMatrixScaleX</span><span class="token punctuation">(</span><span class="token class-name">Matrix</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        matrix<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> values<span class="token punctuation">[</span><span class="token class-name">Matrix</span><span class="token punctuation">.</span><span class="token constant">MSCALE_X</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Matrix</span> <span class="token function">getFitCenterMatrix</span><span class="token punctuation">(</span><span class="token keyword">int</span> bitmapWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> bitmapHeight<span class="token punctuation">,</span> <span class="token keyword">int</span> viewWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> viewHeight<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Matrix</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matrix<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> scale<span class="token punctuation">;</span>
        <span class="token keyword">float</span> dx<span class="token punctuation">;</span>
        <span class="token keyword">float</span> dy<span class="token punctuation">;</span>

        scale <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> viewWidth <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> bitmapWidth<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> viewHeight <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> bitmapHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dx <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>viewWidth <span class="token operator">-</span> bitmapWidth <span class="token operator">*</span> scale<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dy <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>viewHeight <span class="token operator">-</span> bitmapHeight <span class="token operator">*</span> scale<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matrix<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        matrix<span class="token punctuation">.</span><span class="token function">postTranslate</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> matrix<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Bitmap</span> <span class="token function">drawableToBitmap</span><span class="token punctuation">(</span><span class="token class-name">Drawable</span> drawable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>drawable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>drawable <span class="token keyword">instanceof</span> <span class="token class-name">BitmapDrawable</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BitmapDrawable</span><span class="token punctuation">)</span> drawable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>drawable <span class="token keyword">instanceof</span> <span class="token class-name">ColorDrawable</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果 Drawable 是 ColorDrawable，则创建一个相同大小的 Bitmap</span>
            <span class="token class-name">ColorDrawable</span> colorDrawable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ColorDrawable</span><span class="token punctuation">)</span> drawable<span class="token punctuation">;</span>
            <span class="token keyword">int</span> width <span class="token operator">=</span> colorDrawable<span class="token punctuation">.</span><span class="token function">getIntrinsicWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> height <span class="token operator">=</span> colorDrawable<span class="token punctuation">.</span><span class="token function">getIntrinsicHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Bitmap</span> bitmap <span class="token operator">=</span> <span class="token class-name">Bitmap</span><span class="token punctuation">.</span><span class="token function">createBitmap</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token class-name">Bitmap<span class="token punctuation">.</span>Config</span><span class="token punctuation">.</span><span class="token constant">ARGB_8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Canvas</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Canvas</span><span class="token punctuation">(</span>bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            colorDrawable<span class="token punctuation">.</span><span class="token function">setBounds</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            colorDrawable<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> bitmap<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果 Drawable 不是 BitmapDrawable 或 ColorDrawable，则返回空</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">GestureListener</span> <span class="token keyword">extends</span> <span class="token class-name">GestureDetector<span class="token punctuation">.</span>SimpleOnGestureListener</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onDown</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mSavedMatrix<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mFinalMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDown</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onScroll</span><span class="token punctuation">(</span><span class="token class-name">MotionEvent</span> e1<span class="token punctuation">,</span> <span class="token class-name">MotionEvent</span> e2<span class="token punctuation">,</span> <span class="token keyword">float</span> distanceX<span class="token punctuation">,</span> <span class="token keyword">float</span> distanceY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Matrix</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Matrix</span><span class="token punctuation">(</span>mSavedMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> dx <span class="token operator">=</span> e2<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> e1<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> dy <span class="token operator">=</span> e2<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> e1<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            matrix<span class="token punctuation">.</span><span class="token function">postTranslate</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setImageMatrix</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ScaleListener</span> <span class="token keyword">extends</span> <span class="token class-name">ScaleGestureDetector<span class="token punctuation">.</span>SimpleOnScaleGestureListener</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> px<span class="token punctuation">;</span>
        <span class="token keyword">float</span> py<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onScaleBegin</span><span class="token punctuation">(</span><span class="token class-name">ScaleGestureDetector</span> detector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            px <span class="token operator">=</span> detector<span class="token punctuation">.</span><span class="token function">getFocusX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            py <span class="token operator">=</span> detector<span class="token punctuation">.</span><span class="token function">getFocusY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onScale</span><span class="token punctuation">(</span><span class="token class-name">ScaleGestureDetector</span> detector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">float</span> scale <span class="token operator">=</span> detector<span class="token punctuation">.</span><span class="token function">getScaleFactor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> mCurrentScale<span class="token punctuation">;</span>
            <span class="token function">handleScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">,</span> px<span class="token punctuation">,</span> py<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1fe10b75aa1ba68a7fa183a53a01d0b6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mysql启动报错：本地计算机上的mysql服务启动后停止,某些服务在未由其他服务或程序使用时将自动停止</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7d544de0f871af4732db7e3e30692d6c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一篇文章教会你如何搭建hive数据库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>