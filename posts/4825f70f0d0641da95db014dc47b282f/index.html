<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive基础知识大全 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4825f70f0d0641da95db014dc47b282f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Hive基础知识大全">
  <meta property="og:description" content="Hive基础知识大全 文章目录 Hive基础知识大全1、Hive基本概念1.1、Hive简介1.2、什么是Hive(面试题)1.3、为什么要使用Hive1.4、Hive的特点1.5、Hive的优缺点1.6、hive和mysql的区别1.7、hive的应用场景1.8、Hive架构1.8.1、Hive Client1.8.2、Hive Metastore(Hive的元数据存储)1.8.3、**sql语句是如何转换成MapReduce任务的**（重点！！！！！！！！！！！！） 2、Hive的三种交互方式(1) 第一种交互方式(2) 第二种交互方式(3) 第三种交互方式(4) hive cli和beeline cli的区别 3、Hive元数据4、Hive的基本操作4.1 Hive库操作4.1.1 创建数据库4.1.2 创建数据库和位置4.1.3 修改数据库4.1.4 数据库详细信息4.1.5 删除数据库（将删除的目录移动到回收站中） 4.2、Hive数据类型4.2.1、基础数据类型4.2.2、复杂数据类型 4.3、Hive表操作4.3.1、创建表建表1：创建内部表(全部使用默认建表方式)建表2：创建外部表建表3：指定存储格式建表4：使用查询语句建表 (这种方式比较常用)建表5：只想建表，不需要加载数据 4.3.2、加载数据1、使用```hdfs dfs -put &#39;本地数据&#39; &#39;hive表对应的HDFS目录下&#39;```2、使用 load data3、create table xxx as SQL语句4、insert into table xxxx SQL语句 （没有as） 4.3.3、对表进行修改4.3.4、工作案例第一步：在hdfs上创建表数据存储的文件夹第二步：将数据上传到hdfs上第三步：创建表 4.3.5、Hive导出数据 Hive分区与排序（内置函数）1、Hive分区(十分重要！！)1.1 静态分区（SP）1.3 动态分区（DP） 2、Hive分桶2.1 业务场景数据分桶的适用场景： 2.2 数据分桶原理2.3 数据分桶优势2.4 分桶实战 3、Hive JDBC启动hiveserver2新建maven项目并添加两个依赖编写JDBC代码 4、Hive的4种排序4.1 全局排序4.2 局部排序(对reduce内部做排序)4.3 分区排序(本身没有排序)4.3 分区并排序 5、Hive内置函数5.1 内置函数分类5.2 UDTF hive中特殊的一个功能（进一出多）5.3 WordCount案例 Hive函数学习1、count(*)、count(1) 、count(&#39;字段名&#39;) 区别2、**hive语句的执行顺序**3、Hive 常用函数3.1、关系运算3.2、数值计算3.3、条件函数(主要使用场景是数据清洗的过程中使用，有些构建表的过程也是需要的)3.4、日期函数重点！！！3.5、字符串函数3.6、例题：Hive 中的wordCount3.7、Hive窗口函数3.7.1、 聚合开窗函数聚合开窗函数实战：实战1：Hive用户购买明细数据分析实战1需求： 3.7.2、 排序开窗函数(重点)实战2：Hive分析学生成绩信息 4、Hive 行转列5、Hive 列转行6、Hive自定义函数UserDefineFunction6.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-24T21:19:32+08:00">
    <meta property="article:modified_time" content="2024-07-24T21:19:32+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive基础知识大全</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Hive_0"></a>Hive基础知识大全</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Hive_0" rel="nofollow">Hive基础知识大全</a></li><li><a href="#1Hive_3" rel="nofollow">1、Hive基本概念</a></li><li><ul><li><a href="#11Hive_5" rel="nofollow">1.1、Hive简介</a></li><li><a href="#12Hive_9" rel="nofollow">1.2、什么是Hive(面试题)</a></li><li><a href="#13Hive_14" rel="nofollow">1.3、为什么要使用Hive</a></li><li><a href="#14Hive_19" rel="nofollow">1.4、Hive的特点</a></li><li><a href="#15Hive_25" rel="nofollow">1.5、Hive的优缺点</a></li><li><a href="#16hivemysql_57" rel="nofollow">1.6、hive和mysql的区别</a></li><li><a href="#17hive_61" rel="nofollow">1.7、hive的应用场景</a></li><li><a href="#18Hive_77" rel="nofollow">1.8、Hive架构</a></li><li><ul><li><a href="#181Hive_Client_81" rel="nofollow">1.8.1、Hive Client</a></li><li><a href="#182Hive_MetastoreHive_99" rel="nofollow">1.8.2、Hive Metastore(Hive的元数据存储)</a></li><li><a href="#183sqlMapReduce_107" rel="nofollow">1.8.3、**sql语句是如何转换成MapReduce任务的**（重点！！！！！！！！！！！！）</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2Hive_115" rel="nofollow">2、Hive的三种交互方式</a></li><li><ul><li><ul><li><ul><li><a href="#1__117" rel="nofollow">(1) 第一种交互方式</a></li><li><a href="#2__127" rel="nofollow">(2) 第二种交互方式</a></li><li><a href="#3__141" rel="nofollow">(3) 第三种交互方式</a></li><li><a href="#4_hive_clibeeline_cli_173" rel="nofollow">(4) hive cli和beeline cli的区别</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#3Hive_177" rel="nofollow">3、Hive元数据</a></li><li><a href="#4Hive_206" rel="nofollow">4、Hive的基本操作</a></li><li><ul><li><a href="#41%09Hive_208" rel="nofollow">4.1 Hive库操作</a></li><li><ul><li><a href="#411%09_210" rel="nofollow">4.1.1 创建数据库</a></li><li><a href="#412%09_226" rel="nofollow">4.1.2 创建数据库和位置</a></li><li><a href="#413%09_232" rel="nofollow">4.1.3 修改数据库</a></li><li><a href="#414%09_240" rel="nofollow">4.1.4 数据库详细信息</a></li><li><a href="#415%09_266" rel="nofollow">4.1.5 删除数据库（将删除的目录移动到回收站中）</a></li></ul> 
   </li><li><a href="#42Hive_286" rel="nofollow">4.2、Hive数据类型</a></li><li><ul><li><a href="#421_288" rel="nofollow">4.2.1、基础数据类型</a></li><li><a href="#422_308" rel="nofollow">4.2.2、复杂数据类型</a></li></ul> 
   </li><li><a href="#43Hive_325" rel="nofollow">4.3、Hive表操作</a></li><li><ul><li><a href="#431_378" rel="nofollow">4.3.1、创建表</a></li><li><ul><li><a href="#1_433" rel="nofollow">建表1：创建内部表(全部使用默认建表方式)</a></li><li><a href="#2_477" rel="nofollow">建表2：创建外部表</a></li><li><a href="#3_506" rel="nofollow">建表3：指定存储格式</a></li><li><a href="#4__525" rel="nofollow">建表4：使用查询语句建表 (这种方式比较常用)</a></li><li><a href="#5_531" rel="nofollow">建表5：只想建表，不需要加载数据</a></li></ul> 
    </li><li><a href="#432_581" rel="nofollow">4.3.2、加载数据</a></li><li><ul><li><ul><li><a href="#1hdfs_dfs_put__hiveHDFS_583" rel="nofollow">1、使用```hdfs dfs -put '本地数据' 'hive表对应的HDFS目录下'```</a></li><li><a href="#2_load_data_589" rel="nofollow">2、使用 load data</a></li><li><a href="#3create_table_xxx_as_SQL_604" rel="nofollow">3、create table xxx as SQL语句</a></li><li><a href="#4insert_into_table_xxxx_SQL_as_606" rel="nofollow">4、insert into table xxxx SQL语句 （没有as）</a></li></ul> 
    </li></ul> 
    </li><li><a href="#433_616" rel="nofollow">4.3.3、对表进行修改</a></li><li><a href="#434_645" rel="nofollow">4.3.4、工作案例</a></li><li><ul><li><a href="#hdfs_653" rel="nofollow">第一步：在hdfs上创建表数据存储的文件夹</a></li><li><a href="#hdfs_661" rel="nofollow">第二步：将数据上传到hdfs上</a></li><li><a href="#_669" rel="nofollow">第三步：创建表</a></li></ul> 
    </li><li><a href="#435Hive_735" rel="nofollow">4.3.5、Hive导出数据</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Hive_821" rel="nofollow">Hive分区与排序（内置函数）</a></li><li><a href="#1Hive_823" rel="nofollow">1、Hive分区(十分重要！！)</a></li><li><ul><li><a href="#11%09SP_839" rel="nofollow">1.1 静态分区（SP）</a></li><li><a href="#13%09DP_966" rel="nofollow">1.3 动态分区（DP）</a></li></ul> 
  </li><li><a href="#2Hive_1080" rel="nofollow">2、Hive分桶</a></li><li><ul><li><a href="#21%09_1082" rel="nofollow">2.1 业务场景</a></li><li><ul><li><a href="#_1084" rel="nofollow">数据分桶的适用场景：</a></li></ul> 
   </li><li><a href="#22%09_1091" rel="nofollow">2.2 数据分桶原理</a></li><li><a href="#23%09_1097" rel="nofollow">2.3 数据分桶优势</a></li><li><a href="#24%09_1107" rel="nofollow">2.4 分桶实战</a></li></ul> 
  </li><li><a href="#3Hive_JDBC_1202" rel="nofollow">3、Hive JDBC</a></li><li><ul><li><ul><li><ul><li><ul><li><a href="#hiveserver2_1204" rel="nofollow">启动hiveserver2</a></li><li><a href="#maven_1212" rel="nofollow">新建maven项目并添加两个依赖</a></li><li><a href="#JDBC_1228" rel="nofollow">编写JDBC代码</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#4Hive4_1254" rel="nofollow">4、Hive的4种排序</a></li><li><ul><li><a href="#41%09_1258" rel="nofollow">4.1 全局排序</a></li><li><a href="#42%09reduce_1268" rel="nofollow">4.2 局部排序(对reduce内部做排序)</a></li><li><a href="#43%09_1290" rel="nofollow">4.3 分区排序(本身没有排序)</a></li><li><a href="#43%09_1310" rel="nofollow">4.3 分区并排序</a></li></ul> 
  </li><li><a href="#5Hive_1322" rel="nofollow">5、Hive内置函数</a></li><li><ul><li><a href="#51%09_1339" rel="nofollow">5.1 内置函数分类</a></li><li><a href="#52%09UDTF_hive_1367" rel="nofollow">5.2 UDTF hive中特殊的一个功能（进一出多）</a></li><li><a href="#53%09WordCount_1448" rel="nofollow">5.3 WordCount案例</a></li></ul> 
  </li><li><a href="#Hive_1493" rel="nofollow">Hive函数学习</a></li><li><a href="#1countcount1_count__1495" rel="nofollow">1、count(*)、count(1) 、count('字段名') 区别</a></li><li><a href="#2hive_1513" rel="nofollow">2、**hive语句的执行顺序**</a></li><li><a href="#3Hive__1598" rel="nofollow">3、Hive 常用函数</a></li><li><ul><li><a href="#31_1600" rel="nofollow">3.1、关系运算</a></li><li><a href="#32_1610" rel="nofollow">3.2、数值计算</a></li><li><a href="#33_1618" rel="nofollow">3.3、条件函数(主要使用场景是数据清洗的过程中使用，有些构建表的过程也是需要的)</a></li><li><a href="#34_1670" rel="nofollow">3.4、日期函数重点！！！</a></li><li><a href="#35_1684" rel="nofollow">3.5、字符串函数</a></li><li><a href="#36Hive_wordCount_1723" rel="nofollow">3.6、例题：Hive 中的wordCount</a></li><li><ul><li><a href="#37Hive_1748" rel="nofollow">3.7、Hive窗口函数</a></li><li><a href="#371%09_1799" rel="nofollow">3.7.1、 聚合开窗函数</a></li><li><ul><li><ul><li><a href="#_1904" rel="nofollow">聚合开窗函数实战：</a></li><li><a href="#1Hive_1906" rel="nofollow">实战1：Hive用户购买明细数据分析</a></li><li><a href="#1_1941" rel="nofollow">实战1需求：</a></li></ul> 
    </li></ul> 
    </li><li><a href="#372%09_1978" rel="nofollow">3.7.2、 排序开窗函数(重点)</a></li><li><ul><li><ul><li><a href="#2Hive_2004" rel="nofollow">实战2：Hive分析学生成绩信息</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#4Hive__2057" rel="nofollow">4、Hive 行转列</a></li><li><a href="#5Hive__2108" rel="nofollow">5、Hive 列转行</a></li><li><a href="#6HiveUserDefineFunction_2143" rel="nofollow">6、Hive自定义函数UserDefineFunction</a></li><li><ul><li><a href="#61UDF_2145" rel="nofollow">6.1、UDF：一进一出</a></li><li><ul><li><a href="#Could_not_transfer_artifact_orgpentahopentahoaggdesigneralgorithmpom515jhyde_2165" rel="nofollow">Could not transfer artifact org.pentaho:pentaho-aggdesigner-algorithm:pom:5.1.5-jhyde</a></li><li><ul><li><ul><li><a href="#_2228" rel="nofollow">函数加载方式</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#62UDTF_2275" rel="nofollow">6.2、UDTF：一进多出</a></li><li><ul><li><ul><li><ul><li><ul><li><a href="#_explodesplit_2307" rel="nofollow">方法一：使用 explode+split</a></li><li><a href="#UDTF_2313" rel="nofollow">方法二：自定UDTF</a></li></ul> 
     </li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#63UDAF_2397" rel="nofollow">6.3、UDAF：多进一出</a></li><li><ul><li><ul><li><a href="#Hive_Shell_2399" rel="nofollow">Hive Shell</a></li><li><ul><li><a href="#_2401" rel="nofollow">第一种：</a></li><li><a href="#_2407" rel="nofollow">第二种：</a></li></ul> 
     </li><li><a href="#_2415" rel="nofollow">连续登陆问题</a></li><li><ul><li><a href="#_2419" rel="nofollow">数据：</a></li><li><a href="#_2465" rel="nofollow">建表语句</a></li><li><a href="#_2475" rel="nofollow">计算逻辑</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1Hive_3"></a>1、Hive基本概念</h2> 
<h3><a id="11Hive_5"></a>1.1、Hive简介</h3> 
<p>Hive本质是将SQL转化为MapReduce的任务进行计算，底层由HDFS来提供数据存储。说白了hive可以理解为一个将SQL转换为MapReduce的任务的工具，甚至更进一步说hive就是MapReduce的一个客户端。</p> 
<h3><a id="12Hive_9"></a>1.2、什么是Hive(面试题)</h3> 
<ul><li>Hive是数据库建模工具之一</li><li>可以向Hive传入一条交互式SQL,在海量数据中查询分析得到结果的平台</li></ul> 
<h3><a id="13Hive_14"></a>1.3、为什么要使用Hive</h3> 
<ul><li>如果使用Hadoop的话，人员学习成本高，MapReduce的实现复杂查询逻辑的开发难度较大。</li><li>如果使用Hive的话，可以直接操作接口采用类SQL语法，免去了写MapReduce,大大提高了开发效率，并且功能扩展很方便（比如：开窗函数）</li></ul> 
<h3><a id="14Hive_19"></a>1.4、Hive的特点</h3> 
<ul><li>可扩展性：Hive可以自由的扩展集群的规模、一般情况下不需要重启服务</li><li>延伸性：Hive支持自定函数，用户可以根据自己的需求来实现自己的函数</li><li>容错：即使节点出现错误，SQL仍然可以完成执行</li></ul> 
<h3><a id="15Hive_25"></a>1.5、Hive的优缺点</h3> 
<blockquote> 
 <p>优点</p> 
</blockquote> 
<ul><li>操作接口采用类SQL语法，提供快速开发的能力（简单，易上手）</li><li>避免了去写MapReduce，减少了开发人员的学习成本</li><li>由于Hive的延迟性比较高，因此Hive常用于数据分析，适用于对实时性要求不高的场合</li><li>由于Hive的执行延迟性比较高（不断的开关JVM虚拟机），Hive的优势在于处理大数据，对于小数据没有优势</li><li>Hive支持自定义函数，用户可以根据自己的需求来实现满足自己需求的函数</li><li>集群可以自由扩展并且有良好的容错性，节点出现问题SQL仍然可以完成执行</li></ul> 
<blockquote> 
 <p>缺点</p> 
</blockquote> 
<ul><li> <p>Hive的HiveSql表达能力有限</p> 
  <ul><li> <p>迭代是算法无法表达（反复调用，mr之间独立，只有一个map一个reduce，反复开关。名词解释：</p> <p><strong>反复调用</strong>：迭代式算法需要多次调用同一组计算，每次调用的结果会影响下一次调用的输入。</p> <p><strong>MR之间独立</strong>：传统的MapReduce任务是独立的，每个任务之间没有状态共享。这意味着每次MapReduce任务运行时，不知道之前任务的结果。</p> <p><strong>只有一个map和一个reduce</strong>：在描述迭代式算法时，这句话可能意味着每次迭代只有一个Map阶段和一个Reduce阶段，但每次都需要重新启动MapReduce作业。</p> <p><strong>反复开关</strong>：每次迭代需要启动和关闭MapReduce作业，这带来了大量的开销，因为每次启动和关闭作业都需要花费时间和资源。）</p> </li></ul> </li><li> <p>Hive的效率比较低</p> 
  <ul><li>Hive自动生成的MapReduce作业，通常情况下不够智能化</li><li>Hive调优比较困难难，粒度较粗（HiveSql根据模本转成MapReduce,不能像自己编写的MapReduce一样精细，无法控制在map处理数据还是reduce处理数据）</li></ul> </li></ul> 
<blockquote> 
 <p>迭代算法：迭代式算法是指那些需要反复执行同一组计算步骤的算法，每次迭代的结果依赖于前一次迭代的结果。</p> 
</blockquote> 
<h3><a id="16hivemysql_57"></a>1.6、hive和mysql的区别</h3> 
<p><img src="https://images2.imgbox.com/eb/58/d5gd4IXQ_o.png" alt="image-20220531213145918"></p> 
<h3><a id="17hive_61"></a>1.7、hive的应用场景</h3> 
<ul><li>日志分析：大部分互联网公司使用hive进行日志分析，如百度、淘宝等。</li><li>统计一个网站一个时间段内的<strong>pv,uv，SKU,SPU,SKC</strong></li><li>多维度数据分析（<strong>数据仓库</strong>）</li><li>海量结构化(关系型)数据离线分析</li><li><strong>构建数据仓库</strong></li></ul> 
<blockquote> 
 <p>名词解释</p> 
</blockquote> 
<pre><code>PV（Page View）访问量, 即页面浏览量或点击量，衡量网站用户访问的网页数量；在一定统计周期内用户每打开或刷新一个页面就记录1次，多次打开或刷新同一页面则浏览量累计。

UV（Unique Visitor）独立访客，统计1天内访问某站点的用户数(以cookie为依据);访问网站的一台电脑客户端为一个访客。可以理解成访问某网站的电脑的数量。网站判断来访电脑的身份是通过来访电脑的cookies实现的。如果更换了IP后但不清除cookies，再访问相同网站，该网站的统计中UV数是不变的。如果用户不保存cookies访问、清除了cookies或者更换设备访问，计数会加1。00:00-24:00内相同的客户端多次访问只计为1个访客。
</code></pre> 
<h3><a id="18Hive_77"></a>1.8、Hive架构</h3> 
<p><img src="https://images2.imgbox.com/f2/13/6thBInMg_o.png" alt="image-20220531214038409"></p> 
<h4><a id="181Hive_Client_81"></a>1.8.1、Hive Client</h4> 
<blockquote> 
 <p>Hive Client 是与Hive交互的工具，用户可以通过它提交HiveQL查询、执行数据操作并获取结果。</p> 
</blockquote> 
<ul><li>Client(hive shell) 
  <ul><li><strong>启动</strong>：可以通过运行<code>hive</code>命令启动Hive CLI。</li><li><strong>功能</strong>：支持执行HiveQL查询、查看表结构、插入数据、创建表等操作。</li><li><strong>局限性</strong>：由于CLI是基于命令行的，操作可能不如图形界面直观，且在某些情况下（如长时间运行的查询）可能不太方便。</li></ul> </li><li>JDBC/ODBC(java访问hive) 
  <ul><li><strong>JDBC客户端</strong>：例如，Java程序可以通过Hive的JDBC驱动与HiveServer2进行连接和操作。</li><li><strong>ODBC客户端</strong>：例如，使用ODBC接口，可以在Windows环境中使用Excel等工具连接Hive。</li><li><strong>优势</strong>：提供与多种应用和工具的集成能力，适合构建复杂的数据处理和分析应用。</li></ul> </li><li>Beeline(Beeline是Hive的JDBC客户端，提供了一种与HiveServer2交互的方式) 
  <ul><li><strong>启动</strong>：通过运行<code>beeline</code>命令启动，可以连接到本地或远程的HiveServer2实例。</li><li><strong>优势</strong>：相比于Hive CLI，Beeline更加轻量级，并且支持更好的多用户并发访问。</li><li><strong>使用方式</strong>：典型的连接命令是<code>!connect jdbc:hive2://hostname:port/default</code>，然后输入用户名和密码进行连接。</li><li><strong>特性</strong>：支持更丰富的SQL语法、参数化查询、脚本执行等。</li></ul> </li></ul> 
<h4><a id="182Hive_MetastoreHive_99"></a>1.8.2、Hive Metastore(Hive的元数据存储)</h4> 
<blockquote> 
 <p>在Apache Hive中，Metastore（元数据存储）扮演着非常重要的角色，它负责管理和存储Hive表的元数据信息。</p> 
 <p>元数据存储在数据库中，默认存在自带的derby数据库（单用户局限性）中，推荐使用Mysql进行存储。</p> 
</blockquote> 
<ul><li>作用：对Hive表的源数据进行存储，元数据包括：表名、表所属的数据库（默认default数据库）、表的拥有者、列名、表的分区字段、表的类型（内部表还是外部表）、表的存储格式、表的存储位置。</li></ul> 
<h4><a id="183sqlMapReduce_107"></a>1.8.3、<strong>sql语句是如何转换成MapReduce任务的</strong>（重点！！！！！！！！！！！！）</h4> 
<ul><li>解析器（SQL Parser）：将SQL字符串转换成抽象语法树（从3.x版本后，转换成一些stage）,在此阶段，Hive会检查语法错误：比如白哦是否在、字段是否存在。</li><li>编译器（Physical Plan）：将抽象语法树（从3.x版本后，转换成一些stage）生存逻辑执行计划。</li><li>优化器（Query Optimizer）：对逻辑执行计划进行优化。</li><li>执行器（Execution）：将逻辑执行计划转换成可以运行的物理执行计划，也就是MapReduce任务</li><li>结果处理：Hive将生成的MapReduce作业提交给Hadoop集群中的YARN进行执行，在任务执行完成后，将结果返回给用户。</li></ul> 
<h2><a id="2Hive_115"></a>2、Hive的三种交互方式</h2> 
<h5><a id="1__117"></a>(1) 第一种交互方式</h5> 
<blockquote> 
 <p>shell交互Hive，用命令hive启动一个hive的shell命令行，在命令行中输入sql或者命令来和Hive交互。</p> 
</blockquote> 
<pre><code class="prism language-shell">服务端启动metastore服务（后台启动）：nohup hive <span class="token parameter variable">--service</span> metastore <span class="token operator">&amp;</span>
进入命令:hive
退出命令行：quit<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="2__127"></a>(2) 第二种交互方式</h5> 
<blockquote> 
 <p><strong>Hive启动为一个服务器，对外提供服务</strong>，其他机器可以通过客户端通过协议连接到服务器，来完成访问操作，这是生产环境用法最多的</p> 
</blockquote> 
<pre><code class="prism language-shell">服务端启动hiveserver2服务：
<span class="token function">nohup</span> hive <span class="token parameter variable">--service</span> metastore <span class="token operator">&amp;</span>
<span class="token function">nohup</span> hiveserver2 <span class="token operator">&amp;</span>

需要稍等一下，启动服务需要时间：
beeline <span class="token parameter variable">-u</span> jdbc:hive2://master:10000 <span class="token parameter variable">-n</span> root
退出命令行：<span class="token operator">!</span>exit
</code></pre> 
<h5><a id="3__141"></a>(3) 第三种交互方式</h5> 
<blockquote> 
 <p>使用 –e 参数来直接执行hql的语句</p> 
</blockquote> 
<pre><code>bin/hive -e "show databases;"
</code></pre> 
<blockquote> 
 <p>使用 –f 参数通过指定文本文件来执行hql的语句</p> 
 <p>特点：执行完sql后，回到linux命令行。</p> 
</blockquote> 
<pre><code class="prism language-sql">vim hive<span class="token punctuation">.</span><span class="token keyword">sql</span>

<span class="token keyword">create</span> <span class="token keyword">database</span> bigdata30_test<span class="token punctuation">;</span>
<span class="token keyword">use</span> bigdata30_test<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> test1
<span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    name string
<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">','</span><span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-shell">hive <span class="token parameter variable">-f</span> hive.sql
</code></pre> 
<h5><a id="4_hive_clibeeline_cli_173"></a>(4) hive cli和beeline cli的区别</h5> 
<p><img src="https://images2.imgbox.com/24/97/c6ZZ279j_o.png" alt="image-20220531230402802"></p> 
<h2><a id="3Hive_177"></a>3、Hive元数据</h2> 
<p>Hive元数据库中一些重要的表结构及用途**，方便Impala、SparkSQL、Hive等组件访问元数据库的理解。</p> 
<p>1、存储Hive版本的<strong>元数据表(VERSION)</strong>，该表比较简单，但很重要,如果这个表出现问题，根本进不来Hive-Cli。比如该表不存在，当启动Hive-Cli的时候，就会报错“Table ‘hive.version’ doesn’t exist”</p> 
<p>2、Hive数据库相关的元数据表(DBS、DATABASE_PARAMS)</p> 
<p>​ <strong>DBS</strong>：该表存储Hive中所有数据库的基本信息。</p> 
<p>​ DATABASE_PARAMS：该表存储数据库的相关参数。</p> 
<p>3、Hive表和视图相关的元数据表</p> 
<p>​ 主要有TBLS、TABLE_PARAMS、TBL_PRIVS，这三张表通过TBL_ID关联。<br> ​ <strong>TBLS</strong>:该表中存储Hive表，视图，索引表的基本信息。<br> ​ TABLE_PARAMS:该表存储表/视图的属性信息。<br> ​ TBL_PRIVS：该表存储表/视图的授权信息。<br> 4、Hive文件存储信息相关的元数据表</p> 
<p>​ 主要涉及SDS、SD_PARAMS、SERDES、SERDE_PARAMS，由于HDFS支持的文件格式很多，而建Hive表时候也可以指定各种文件格式，Hive在将HQL解析成MapReduce时候，需要知道去哪里，使用哪种格式去读写HDFS文件，而这些信息就保存在这几张表中。<br> ​ <strong>SDS</strong>：该表保存文件存储的基本信息，如INPUT_FORMAT、OUTPUT_FORMAT、是否压缩等。TBLS表中的SD_ID与该表关联，可以获取Hive表的存储信息。<br> ​ SD_PARAMS: 该表存储Hive存储的属性信息。<br> ​ SERDES:该表存储序列化使用的类信息。<br> ​ <strong>SERDE_PARAMS</strong>:该表存储序列化的一些属性、格式信息，比如:行、列分隔符。<br> 5、Hive表字段相关的元数据表</p> 
<p>​ 主要涉及COLUMNS_V2：该表存储表对应的字段信息。</p> 
<h2><a id="4Hive_206"></a>4、Hive的基本操作</h2> 
<h3><a id="41%09Hive_208"></a>4.1 Hive库操作</h3> 
<h4><a id="411%09_210"></a>4.1.1 创建数据库</h4> 
<blockquote> 
 <p>1）创建一个数据库，数据库在<strong>HDFS上的默认存储路径是/user/hive/warehouse/*.db</strong>。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> testdb<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>2）避免要创建的数据库已经存在错误，增加if not exists判断。<strong>（标准写法）</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> testdb<span class="token punctuation">;</span> 

<span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> bigdata30_test2<span class="token punctuation">;</span> 
</code></pre> 
<h4><a id="412%09_226"></a>4.1.2 创建数据库和位置</h4> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> bigdata30_test3 location <span class="token string">'/bigdata30/liliangdb'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="413%09_232"></a>4.1.3 修改数据库</h4> 
<blockquote> 
 <p><strong>数据库的其他元数据信息都是不可更改的</strong>，包括数据库名和数据库所在的目录位置。（<strong>重点关注哪些不能改，以及为什么！！</strong>）</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">database</span> dept <span class="token keyword">set</span> dbproperties<span class="token punctuation">(</span><span class="token string">'createtime'</span><span class="token operator">=</span><span class="token string">'20220531'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="414%09_240"></a>4.1.4 数据库详细信息</h4> 
<blockquote> 
 <p>1）显示数据库（show）</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>2）可以通过like进行过滤</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> <span class="token keyword">databases</span> <span class="token operator">like</span> <span class="token string">'t*'</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>3）查看详情（desc）</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">desc</span> <span class="token keyword">database</span> testdb<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>4）切换数据库（use）</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">use</span> testdb<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="415%09_266"></a>4.1.5 删除数据库（将删除的目录移动到回收站中）</h4> 
<blockquote> 
 <p>1）最简写法</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">database</span> testdb<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>2）如果删除的数据库不存在，最好使用if exists判断数据库是否存在。否则会报错：FAILED: SemanticException [Error 10072]: Database does not exist: db_hive</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> testdb<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>3)如果数据库不为空，使用cascade命令进行强制删除。报错信息如下FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. InvalidOperationException(message:Database db_hive is not empty. One or more tables exist.)</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> testdb <span class="token keyword">cascade</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="42Hive_286"></a>4.2、Hive数据类型</h3> 
<h4><a id="421_288"></a>4.2.1、基础数据类型</h4> 
<table><thead><tr><th>类型</th><th>Java数据类型</th><th>描述</th></tr></thead><tbody><tr><td>TINYINT</td><td>byte</td><td>8位有符号整型。取值范围：-128~127。</td></tr><tr><td>SMALLINT</td><td>short</td><td>16位有符号整型。取值范围：-32768~32767。</td></tr><tr><td>INT</td><td>int</td><td>32位有符号整型。取值范围：-2 31 ~2 31 -1。</td></tr><tr><td><strong>BIGINT</strong></td><td>long</td><td>64位有符号整型。取值范围：-2 63 +1~2 63 -1。</td></tr><tr><td>BINARY</td><td></td><td>二进制数据类型，目前长度限制为8MB。</td></tr><tr><td>FLOAT</td><td>float</td><td>32位二进制浮点型。</td></tr><tr><td><strong>DOUBLE</strong></td><td>double</td><td>64位二进制浮点型。</td></tr><tr><td><strong>DECIMAL(precision,scale)</strong></td><td></td><td>10进制精确数字类型。precision：表示最多可以表示多少位的数字。取值范围：1 &lt;= precision &lt;= 38。scale：表示小数部分的位数。取值范围： 0 &lt;= scale &lt;= 38。如果不指定以上两个参数，则默认为decimal(10,0)。</td></tr><tr><td>VARCHAR(n)</td><td></td><td>变长字符类型，n为长度。取值范围：1~65535。</td></tr><tr><td>CHAR(n)</td><td></td><td>固定长度字符类型，n为长度。最大取值255。长度不足则会填充空格，但空格不参与比较。</td></tr><tr><td><strong>STRING</strong></td><td>string</td><td>字符串类型，目前长度限制为8MB。</td></tr><tr><td>DATE</td><td></td><td>日期类型，格式为<code>yyyy-mm-dd</code>。取值范围：0000-01-01~9999-12-31。</td></tr><tr><td>DATETIME</td><td></td><td>日期时间类型。取值范围：0000-01-01 00:00:00.000~9999-12-31 23.59:59.999，精确到毫秒。</td></tr><tr><td><strong>TIMESTAMP</strong></td><td></td><td>与时区无关的时间戳类型。取值范围：0000-01-01 00:00:00.000000000~9999-12-31 23.59:59.999999999，精确到纳秒。说明 对于部分时区相关的函数，例如cast( as string)，要求TIMESTAMP按照与当前时区相符的方式来展现。</td></tr><tr><td><strong>BOOLEAN</strong></td><td>boolean</td><td>BOOLEAN类型。取值：True、False。</td></tr></tbody></table> 
<h4><a id="422_308"></a>4.2.2、复杂数据类型</h4> 
<table><thead><tr><th>类型</th><th>定义方法</th><th>构造方法</th></tr></thead><tbody><tr><td>ARRAY</td><td><code>array&lt;int&gt;``array&lt;struct&lt;a:int, b:string&gt;&gt;</code></td><td><code>array(1, 2, 3)``array(array(1, 2), array(3, 4))</code></td></tr><tr><td>MAP</td><td><code>map&lt;string, string&gt;``map&lt;smallint, array&lt;string&gt;&gt;</code></td><td><code>map(“k1”, “v1”, “k2”, “v2”)``map(1S, array(‘a’, ‘b’), 2S, array(‘x’, ‘y’))</code></td></tr><tr><td>STRUCT</td><td></td><td>struct&lt;x:int, y:int&gt;<code>struct&lt;field1:bigint, field2:array&lt;int&gt;, field3:map&lt;int, int&gt;&gt; named_struct(‘x’, 1, ‘y’, 2)</code>named_struct(‘field1’, 100L, ‘field2’, array(1, 2), ‘field3’, map(1, 100, 2, 200))</td></tr></tbody></table> 
<blockquote> 
 <p>Hive有三种复杂数据类型ARRAY、MAP 和 STRUCT。ARRAY和MAP与Java中的Array和Map类似，而STRUCT与C语言中的Struct类似，它封装了一个命名字段集合，复杂数据类型允许任意层次的嵌套。还有一个uniontype&lt; 所有类型，所有类型… &gt; 。</p> 
 <p>​ 数组：array&lt; 所有类型 &gt;；<br> ​ Map &lt; 基本数据类型，所有数据类型 &gt;；<br> ​ struct &lt; 名：所有类型[注释] &gt;;<br> ​ uniontype&lt; 所有类型，所有类型… &gt;</p> 
</blockquote> 
<h3><a id="43Hive_325"></a>4.3、Hive表操作</h3> 
<blockquote> 
 <p>Hive的存储格式:</p> 
 <p>Hive没有专门的数据文件格式,常见的有以下几种:</p> 
 <p>​ <strong>TEXTFILE</strong><br> ​ SEQUENCEFILE<br> ​ AVRO<br> ​ <strong>RCFILE</strong><br> ​ <strong>ORCFILE</strong><br> ​ <strong>PARQUET</strong></p> 
</blockquote> 
<pre><code>TextFile:
       TEXTFILE 即正常的文本格式，是Hive默认文件存储格式，因为大多数情况下源数据文件都是以text文件格式保存（便于查看验数和防止乱码）。此种格式的表文件在HDFS上是明文，可用hadoop fs -cat命令查看，从HDFS上get下来后也可以直接读取。
        TEXTFILE 存储文件默认每一行就是一条记录，可以指定任意的分隔符进行字段间的分割。但这个格式无压缩，需要的存储空间很大。虽然可结合Gzip、Bzip2、Snappy等使用，使用这种方式，Hive不会对数据进行切分，从而无法对数据进行并行操作。
一般只有与其他系统由数据交互的接口表采用TEXTFILE 格式，其他事实表和维度表都不建议使用。

RCFile:
Record Columnar的缩写。是Hadoop中第一个列文件格式。能够很好的压缩和快速的查询性能。通常写操作比较慢，比非列形式的文件格式需要更多的内存空间和计算量。 RCFile是一种行列存储相结合的存储方式。首先，其将数据按行分块，保证同一个record在一个块上，避免读一个记录需要读取多个block。其次，块数据`列式存储`，有利于数据压缩和快速的列存取。

ORCFile:
Hive从0.11版本开始提供了ORC的文件格式，ORC文件不仅仅是一种列式文件存储格式，最重要的是有着很高的压缩比，并且对于MapReduce来说是可切分（Split）的。因此，在Hive中使用ORC作为表的文件存储格式，不仅可以很大程度的节省HDFS存储资源，而且对数据的查询和处理性能有着非常大的提升，因为ORC较其他文件格式压缩比高，查询任务的输入数据量减少，使用的Task也就减少了。ORC能很大程度的节省存储和计算资源，但它在读写时候需要消耗额外的CPU资源来压缩和解压缩，当然这部分的CPU消耗是非常少的。

Parquet:
通常我们使用关系数据库存储结构化数据，而关系数据库中使用数据模型都是扁平式的，遇到诸如数组、Map和自定义Struct的时候就需要用户在应用层解析。但是在大数据环境下，通常数据的来源是服务端的埋点数据，很可能需要把程序中的某些对象内容作为输出的一部分，而每一个对象都可能是嵌套的，所以如果能够原生的支持这种数据，这样在查询的时候就不需要额外的解析便能获得想要的结果。Parquet的灵感来自于2010年Google发表的Dremel论文，文中介绍了一种支持嵌套结构的存储格式，并且使用了列式存储的方式提升查询性能。Parquet仅仅是一种存储格式，它是语言、平台无关的，并且不需要和任何一种数据处理框架绑定。这也是parquet相较于orc的仅有优势：支持嵌套结构。Parquet 没有太多其他可圈可点的地方,比如他不支持update操作(数据写成后不可修改),不支持ACID等.

SEQUENCEFILE:
SequenceFile是Hadoop API 提供的一种二进制文件，它将数据以&lt;key,value&gt;的形式序列化到文件中。这种二进制文件内部使用Hadoop 的标准的Writable 接口实现序列化和反序列化。它与Hadoop API中的MapFile 是互相兼容的。Hive 中的SequenceFile 继承自Hadoop API 的SequenceFile，不过它的key为空，使用value 存放实际的值， 这样是为了避免MR 在运行map 阶段的排序过程。SequenceFile支持三种压缩选择：NONE, RECORD, BLOCK。 Record压缩率低，一般建议使用BLOCK压缩。 SequenceFile最重要的优点就是Hadoop原生支持较好，有API，但除此之外平平无奇，实际生产中不会使用。

AVRO:
Avro是一种用于支持数据密集型的二进制文件格式。它的文件格式更为紧凑，若要读取大量数据时，Avro能够提供更好的序列化和反序列化性能。并且Avro数据文件天生是带Schema定义的，所以它不需要开发者在API 级别实现自己的Writable对象。Avro提供的机制使动态语言可以方便地处理Avro数据。最近多个Hadoop 子项目都支持Avro 数据格式，如Pig 、Hive、Flume、Sqoop和Hcatalog。
</code></pre> 
<blockquote> 
 <p>Hive的四大常用存储格式存储效率及执行速度对比</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/9c/8d/j0dRzyo4_o.png" alt="image-20220531234505119"><br> <img src="https://images2.imgbox.com/72/5f/GjUDH67J_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>结论：ORCFILE存储文件读操作效率最高</p> 
 <p>耗时比较：ORC&lt;Parquet&lt;RC&lt;Text</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4e/99/nUChDK3o_o.png" alt="image-20220531234659264"></p> 
<blockquote> 
 <p>结论：ORCFILE存储文件占用空间少，压缩效率高</p> 
 <p>占用空间：ORC&lt;Parquet&lt;RC&lt;Text</p> 
</blockquote> 
<h4><a id="431_378"></a>4.3.1、创建表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token punctuation">[</span>EXTERNAL<span class="token punctuation">]</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> table_name 
<span class="token punctuation">[</span><span class="token punctuation">(</span>col_name data_type <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token punctuation">[</span><span class="token keyword">COMMENT</span> table_comment<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name data_type <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> col_comment<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token punctuation">[</span><span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name<span class="token punctuation">,</span> col_name<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> 
<span class="token punctuation">[</span>SORTED <span class="token keyword">BY</span> <span class="token punctuation">(</span>col_name <span class="token punctuation">[</span><span class="token keyword">ASC</span><span class="token operator">|</span><span class="token keyword">DESC</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">INTO</span> num_buckets BUCKETS<span class="token punctuation">]</span> 
<span class="token punctuation">[</span><span class="token keyword">ROW</span> FORMAT row_format<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>STORED <span class="token keyword">AS</span> file_format<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>LOCATION hdfs_path<span class="token punctuation">]</span>


字段解释说明:
<span class="token operator">-</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 
	创建一个指定名字的表。如果相同名字的表已经存在，则抛出异常；用户可以用 <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> 选项来忽略这个异常。

<span class="token operator">-</span> EXTERNAL
	关键字可以让用户创建一个外部表，在建表的同时指定一个指向实际数据的路径（LOCATION）
	创建内部表时，会将数据移动到数据仓库指向的路径（默认位置）；
	创建外部表时，仅记录数据所在的路径，不对数据的位置做任何改变。
	在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。

<span class="token operator">-</span> <span class="token keyword">COMMENT</span>：
	为表和列添加注释。

<span class="token operator">-</span> PARTITIONED <span class="token keyword">BY</span>
	创建分区表

<span class="token operator">-</span> <span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span>
	创建分桶表

<span class="token operator">-</span> SORTED <span class="token keyword">BY</span>
	不常用

<span class="token operator">-</span> <span class="token keyword">ROW</span> FORMAT 
  DELIMITED <span class="token punctuation">[</span><span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token keyword">char</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>COLLECTION ITEMS <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token keyword">char</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>MAP <span class="token keyword">KEYS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token keyword">char</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">LINES</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token keyword">char</span><span class="token punctuation">]</span> <span class="token operator">|</span> SERDE serde_name <span class="token punctuation">[</span><span class="token keyword">WITH</span> SERDEPROPERTIES <span class="token punctuation">(</span>property_name<span class="token operator">=</span>property_value<span class="token punctuation">,</span> property_name<span class="token operator">=</span>property_value<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	用户在建表的时候可以自定义SerDe或者使用自带的SerDe。
	如果没有指定<span class="token keyword">ROW</span> FORMAT 或者<span class="token keyword">ROW</span> FORMAT DELIMITED，将会使用自带的SerDe。
	在建表的时候，用户还需要为表指定列，用户在指定表的列的同时也会指定自定义的SerDe，Hive通过SerDe确定表的具体的列的数据。
	SerDe是Serialize<span class="token operator">/</span>Deserilize的简称，目的是用于序列化和反序列化。

<span class="token operator">-</span> STORED <span class="token keyword">AS</span>指定存储文件类型
	常用的存储文件类型：SEQUENCEFILE（二进制序列文件）、TEXTFILE（文本）、RCFILE（列式存储格式文件）
	如果文件数据是纯文本，可以使用STORED <span class="token keyword">AS</span> TEXTFILE。
	如果数据需要压缩，使用 STORED <span class="token keyword">AS</span> SEQUENCEFILE。

<span class="token operator">-</span> LOCATION ：
	指定表在HDFS上的存储位置。

<span class="token operator">-</span> <span class="token operator">LIKE</span>
	允许用户复制现有的表结构，但是不复制数据。
</code></pre> 
<h5><a id="1_433"></a>建表1：创建内部表(全部使用默认建表方式)</h5> 
<blockquote> 
 <p>当<strong>创建好表的时候，HDFS会在当前表所属的库中创建一个文件夹</strong></p> 
 <p>当设置表路径的时候，如果直接指向一个已有的路径,可以直接去使用文件夹中的数据</p> 
 <p><strong>当load数据的时候，就会将数据文件移动到到表对应的文件夹中</strong></p> 
 <p>而且<strong>数据一旦被load，就不能被修改</strong></p> 
 <p>我们查询数据也是查询文件中的文件,这些数据最终都会存放到HDFS</p> 
 <p>当我们<strong>删除表的时候，表对应的文件夹会被删除，同时数据也会被删除</strong></p> 
 <p><strong>默认建表的类型就是内部表</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">#默认情况下使用的是default数据库</span>
<span class="token comment">#可以在切换到其它数据库：use bigdata30 该数据库在hdfs的具体位置/user/hive/warehouse/bigdata30.db</span>
<span class="token comment">#通过下面的语句创建students表后会在hdfs上生成一个students文件夹，文件夹里面是用来存储将来插入该表的students.txt数据（也可以是其他类型的文件）</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> students
<span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    name string<span class="token punctuation">,</span>
    age <span class="token keyword">int</span><span class="token punctuation">,</span>
    gender string<span class="token punctuation">,</span>
    clazz string
<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'_'</span><span class="token punctuation">;</span> <span class="token comment">// 必选，指定列分隔符 </span>

<span class="token comment">//使用load加载数据：</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/data/students.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>
加载数据的作用就是将hdfs上的<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>students<span class="token punctuation">.</span>txt的数据移动到<span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>bigdata30<span class="token punctuation">.</span>db<span class="token operator">/</span>students文件夹下

<span class="token comment">//使用上传文件的方式加载数据</span>
hadoop fs <span class="token operator">-</span>put students<span class="token punctuation">.</span>txt <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>bigdata30<span class="token punctuation">.</span>db<span class="token operator">/</span>students

<span class="token comment">#在Hive中创建表时指定列分隔符是为了解析数据文件中的列。当Hive读取数据文件时，它会使用指定的列分隔符来识别和分隔每一列的数据。</span>

表的路径为： <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span>hive<span class="token operator">/</span>warehouse<span class="token operator">/</span>bigdata30<span class="token punctuation">.</span>db<span class="token operator">/</span>students 

删除文件后数据和文件夹同时删除
</code></pre> 
<h5><a id="2_477"></a>建表2：创建外部表</h5> 
<blockquote> 
 <p>​ <strong>外部表因为是指定其他的hdfs路径的数据加载到表中来，所以hive会认为自己不完全独占这份数据</strong></p> 
 <p>​ <strong>删除hive表的时候，数据仍然保存在hdfs中，不会删除。</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">// 外部表(一般情况下，建一个与表名相同的文件夹，然后再将数据上传到该文件夹下，在创建表的时候指定location的路径为数据的存储路径即可)</span>
<span class="token keyword">create</span> external <span class="token keyword">table</span> students
<span class="token punctuation">(</span>
    id <span class="token keyword">bigint</span><span class="token punctuation">,</span>
    name string<span class="token punctuation">,</span>
    age <span class="token keyword">int</span><span class="token punctuation">,</span>
    gender string<span class="token punctuation">,</span>
    clazz string
<span class="token punctuation">)</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">','</span>
location <span class="token string">'/data'</span><span class="token punctuation">;</span>

<span class="token comment">//当指定的路径下有数据时，直接将数据加载到表中</span>
表的存储路径hdfs:<span class="token comment">//master:9000/data</span>

<span class="token comment">//当指定的路径下没有数据时，通过hadoop命令将数据上传到location指定的文件夹，数据自动加载到表中</span>
hadoop fs <span class="token operator">-</span>put students<span class="token punctuation">.</span>txt <span class="token operator">/</span><span class="token keyword">data</span>

<span class="token comment">//也可以使用hive命令行中通过命令将本地文件导入到hdfs上</span>
hive<span class="token operator">&gt;</span> dfs <span class="token operator">-</span>put <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>students<span class="token punctuation">.</span>txt <span class="token operator">/</span><span class="token keyword">data</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="3_506"></a>建表3：指定存储格式</h5> 
<pre><code>create table IF NOT EXISTS students
(
    id bigint,
    name string,
    age int,
    gender string,
    clazz string
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS ORC
// 指定储存格式为orcfile，inputFormat:RCFileInputFormat,outputFormat:RCFileOutputFormat，如果不指定，默认为textfile，
注意：除textfile以外，其他的存储格式的数据都不能直接加载，需要使用从表插入数据的方式。
load data inpath '/data/students.txt' into table students;(不可用)
insert into table students_test1 select * from students limit 10;(可用)
</code></pre> 
<h5><a id="4__525"></a>建表4：使用查询语句建表 (这种方式比较常用)</h5> 
<pre><code>create table students1 as select * from students;
</code></pre> 
<h5><a id="5_531"></a>建表5：只想建表，不需要加载数据</h5> 
<pre><code>create table students5 like students;
</code></pre> 
<blockquote> 
 <p><strong>简单用户信息表创建：</strong></p> 
 <pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> students6<span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">,</span>
uname string<span class="token punctuation">,</span>
pwd string<span class="token punctuation">,</span>
gender string<span class="token punctuation">,</span>
age <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>

在Hive中，建表语句中的<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span>是可选的，并不是必须的。这个语句用于指定在加载数据时每行数据的结束符号，默认情况下，Hive会将每行数据以换行符 \n 作为结束标志。如果你的数据文件每行以换行符结束，你可以不用显式地指定这个参数，Hive会自动识别。但如果你的数据文件行结尾使用了其他分隔符，你就需要使用这个参数来告诉Hive如何正确地解析每行数据。
</code></pre> 
 <pre><code>1,admin,123456,nan,18
2,zhangsan,abc123,nan,23
3,lisi,654321,nv,16
</code></pre> 
 <p>复杂人员信息表创建：</p> 
 <pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_person<span class="token punctuation">(</span>
name string<span class="token punctuation">,</span>
friends array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
children map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
address struct<span class="token operator">&lt;</span>street:string <span class="token punctuation">,</span>city:string<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span> <span class="token comment">-- 列与列之间的分隔符</span>
collection items <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'_'</span> <span class="token comment">-- 集合数据类型元素与元素之间分隔符</span>
map <span class="token keyword">keys</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">':'</span> <span class="token comment">-- Map数据类型键与值之间的分隔符</span>
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>  <span class="token comment">-- 行与行之间的换行符</span>
</code></pre> 
 <pre><code class="prism language-sql">songsong<span class="token punctuation">,</span>bingbing_lili<span class="token punctuation">,</span>xiao song:<span class="token number">18</span>_xiaoxiao song:<span class="token number">19</span><span class="token punctuation">,</span>beng bu_anhui
yangyang<span class="token punctuation">,</span>caicai_susu<span class="token punctuation">,</span>xiao yang:<span class="token number">18</span>_xiaoxiao yang:<span class="token number">19</span><span class="token punctuation">,</span>he fei_anhui
</code></pre> 
</blockquote> 
<h4><a id="432_581"></a>4.3.2、加载数据</h4> 
<h6><a id="1hdfs_dfs_put__hiveHDFS_583"></a>1、使用<code>hdfs dfs -put '本地数据' 'hive表对应的HDFS目录下'</code></h6> 
<pre><code class="prism language-sql">hadoop fs <span class="token operator">-</span>put <span class="token operator">/</span>uer<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span>bigdata30<span class="token operator">/</span>students<span class="token punctuation">.</span>txt <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>students
</code></pre> 
<h6><a id="2_load_data_589"></a>2、使用 load data</h6> 
<blockquote> 
 <p>注意：默认情况下加载的新数据会被追加到已有表的末尾，而不会覆盖或者清空已存在的数据</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/data/students.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>

<span class="token comment">// 清空表</span>
<span class="token keyword">truncate</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>
<span class="token comment">// 加上 local 关键字 可以将Linux本地目录下的文件 上传到 hive表对应HDFS 目录下 原文件不会被删除</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/data/students.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>
<span class="token comment">// overwrite 覆盖加载</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/data/students.txt'</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="3create_table_xxx_as_SQL_604"></a>3、create table xxx as SQL语句</h6> 
<h6><a id="4insert_into_table_xxxx_SQL_as_606"></a>4、insert into table xxxx SQL语句 （没有as）</h6> 
<pre><code class="prism language-sql"><span class="token comment">// 将 students表的数据插入到students2 这是复制 不是移动 students表中的表中的数据不会丢失</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">table</span> students1 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students<span class="token punctuation">;</span>

<span class="token comment">// 覆盖插入 把into 换成 overwrite</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> students1 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="433_616"></a>4.3.3、对表进行修改</h4> 
<blockquote> 
 <p>显示表</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">//显示当前数据库下的所有表</span>
<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
<span class="token comment">//显示当前数据库下以u开头的所有表</span>
<span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token operator">like</span> <span class="token string">'u*'</span><span class="token punctuation">;</span>
<span class="token comment">//查看表的结构（表的字段和字段类型）</span>
<span class="token keyword">desc</span> t_person<span class="token punctuation">;</span>
<span class="token comment">//查看表的详细结构，包括表的存储位置，表的存储类型，和表的一些其他的属性</span>
<span class="token keyword">desc</span> formatted students<span class="token punctuation">;</span> 
</code></pre> 
<blockquote> 
 <p>添加列</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> students2 <span class="token keyword">add</span> <span class="token keyword">columns</span> <span class="token punctuation">(</span>education string<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>更新列</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> stduents2 change education educationnew string<span class="token punctuation">;</span>

这条语句将会更改 students2 表中名为 education 的列的数据类型为 STRING，同时将其列名更改为 educationnew。
</code></pre> 
<h4><a id="434_645"></a>4.3.4、工作案例</h4> 
<blockquote> 
 <p>一般在公司中，使用外部表多一点，因为数据可以需要被多个程序使用，避免误删，通常外部表会结合location一起使用</p> 
 <p>外部表还可以将其他数据源中的数据 映射到 hive中，比如说：hbase，ElasticSearch…</p> 
 <p>设计外部表的初衷就是 让 表的元数据 与 数据 解耦</p> 
</blockquote> 
<h5><a id="hdfs_653"></a>第一步：在hdfs上创建表数据存储的文件夹</h5> 
<pre><code class="prism language-sql">hdfs dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>bigdata30<span class="token operator">/</span>dept
hdfs dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>bigdata30<span class="token operator">/</span>emp
hdfs dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>bigdata30<span class="token operator">/</span>salgrade
</code></pre> 
<h5><a id="hdfs_661"></a>第二步：将数据上传到hdfs上</h5> 
<pre><code class="prism language-sql">hadoop fs <span class="token operator">-</span>put <span class="token operator">/</span>uer<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span>bigdata30<span class="token operator">/</span>dept<span class="token punctuation">.</span>txt <span class="token operator">/</span>bigadta30<span class="token operator">/</span>dept
hadoop fs <span class="token operator">-</span>put <span class="token operator">/</span>uer<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span>bigdata30<span class="token operator">/</span>dept<span class="token punctuation">.</span>txt <span class="token operator">/</span>bigadta30<span class="token operator">/</span>emp
hadoop fs <span class="token operator">-</span>put <span class="token operator">/</span>uer<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span>bigdata30<span class="token operator">/</span>dept<span class="token punctuation">.</span>txt <span class="token operator">/</span>bigadta30<span class="token operator">/</span>salgrade
</code></pre> 
<h5><a id="_669"></a>第三步：创建表</h5> 
<blockquote> 
 <p>创建dept表</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> dept <span class="token punctuation">(</span>
  DEPTNO <span class="token keyword">int</span><span class="token punctuation">,</span>
  DNAME <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  LOC <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
location <span class="token string">'/bigdata30/dept'</span><span class="token punctuation">;</span>

<span class="token number">10</span><span class="token punctuation">,</span>ACCOUNTING<span class="token punctuation">,</span>NEW YORK
<span class="token number">20</span><span class="token punctuation">,</span>RESEARCH<span class="token punctuation">,</span>DALLAS
<span class="token number">30</span><span class="token punctuation">,</span>SALES<span class="token punctuation">,</span>CHICAGO
<span class="token number">40</span><span class="token punctuation">,</span>OPERATIONS<span class="token punctuation">,</span>BOSTON
</code></pre> 
<blockquote> 
 <p>创建emp表</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> emp <span class="token punctuation">(</span>
   EMPNO <span class="token keyword">int</span><span class="token punctuation">,</span>
   ENAME <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   JOB <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   MGR <span class="token keyword">int</span><span class="token punctuation">,</span>
   HIREDATE <span class="token keyword">date</span><span class="token punctuation">,</span>
   SAL <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   COMM <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   DEPTNO <span class="token keyword">int</span>
 <span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
 location <span class="token string">'/bigdata30/emp'</span><span class="token punctuation">;</span>
 
<span class="token number">7369</span><span class="token punctuation">,</span>SMITH<span class="token punctuation">,</span>CLERK<span class="token punctuation">,</span><span class="token number">7902</span><span class="token punctuation">,</span><span class="token number">1980</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">20</span>
<span class="token number">7499</span><span class="token punctuation">,</span>ALLEN<span class="token punctuation">,</span>SALESMAN<span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">1600</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7521</span><span class="token punctuation">,</span>WARD<span class="token punctuation">,</span>SALESMAN<span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">1250</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7566</span><span class="token punctuation">,</span>JONES<span class="token punctuation">,</span>MANAGER<span class="token punctuation">,</span><span class="token number">7839</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span><span class="token punctuation">,</span><span class="token number">2975</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">20</span>
<span class="token number">7654</span><span class="token punctuation">,</span>MARTIN<span class="token punctuation">,</span>SALESMAN<span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">1250</span><span class="token punctuation">,</span><span class="token number">1400</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7698</span><span class="token punctuation">,</span>BLAKE<span class="token punctuation">,</span>MANAGER<span class="token punctuation">,</span><span class="token number">7839</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">,</span><span class="token number">2850</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7782</span><span class="token punctuation">,</span>CLARK<span class="token punctuation">,</span>MANAGER<span class="token punctuation">,</span><span class="token number">7839</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">09</span><span class="token punctuation">,</span><span class="token number">2450</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">10</span>
<span class="token number">7788</span><span class="token punctuation">,</span>SCOTT<span class="token punctuation">,</span>ANALYST<span class="token punctuation">,</span><span class="token number">7566</span><span class="token punctuation">,</span><span class="token number">1987</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">20</span>
<span class="token number">7839</span><span class="token punctuation">,</span>KING<span class="token punctuation">,</span>PRESIDENT<span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">10</span>
<span class="token number">7844</span><span class="token punctuation">,</span>TURNER<span class="token punctuation">,</span>SALESMAN<span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7876</span><span class="token punctuation">,</span>ADAMS<span class="token punctuation">,</span>CLERK<span class="token punctuation">,</span><span class="token number">7788</span><span class="token punctuation">,</span><span class="token number">1987</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">1100</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">20</span>
<span class="token number">7900</span><span class="token punctuation">,</span>JAMES<span class="token punctuation">,</span>CLERK<span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">950</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7902</span><span class="token punctuation">,</span>FORD<span class="token punctuation">,</span>ANALYST<span class="token punctuation">,</span><span class="token number">7566</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">20</span>
<span class="token number">7934</span><span class="token punctuation">,</span>MILLER<span class="token punctuation">,</span>CLERK<span class="token punctuation">,</span><span class="token number">7782</span><span class="token punctuation">,</span><span class="token number">1982</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">1300</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">10</span>
</code></pre> 
<blockquote> 
 <p>创建salgrade表</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> salgrade <span class="token punctuation">(</span>
  GRADE <span class="token keyword">int</span><span class="token punctuation">,</span>
  LOSAL <span class="token keyword">int</span><span class="token punctuation">,</span>
  HISAL <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
location <span class="token string">'/bigdata30/salgrade'</span><span class="token punctuation">;</span>

<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">700</span><span class="token punctuation">,</span><span class="token number">1200</span>
<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1201</span><span class="token punctuation">,</span><span class="token number">1400</span>
<span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1401</span><span class="token punctuation">,</span><span class="token number">2000</span>
<span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2001</span><span class="token punctuation">,</span><span class="token number">3000</span>
<span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3001</span><span class="token punctuation">,</span><span class="token number">9999</span>
</code></pre> 
<h4><a id="435Hive_735"></a>4.3.5、Hive导出数据</h4> 
<blockquote> 
 <p>将表中的数据备份</p> 
</blockquote> 
<ul><li>将查询结果存放到本地</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">//创建存放数据的目录</span>
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span>shujia

<span class="token comment">//导出查询结果的数据(导出到Node01上)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">'/usr/local/soft/shujia'</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_person<span class="token punctuation">;</span>
</code></pre> 
<ul><li>按照指定的方式将数据输出到本地</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建存放数据的目录</span>
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>soft<span class="token operator">/</span>shujia

<span class="token comment">-- 导出查询结果的数据</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">'/usr/local/soft/shujia'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span> 
collection items <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'-'</span> 
map <span class="token keyword">keys</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">':'</span> 
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_person<span class="token punctuation">;</span>
</code></pre> 
<ul><li>将查询结果输出到HDFS</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">-- 导出查询结果的数据</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory <span class="token string">'/usr/local/soft/shujia'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span> 
collection items <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'-'</span> 
map <span class="token keyword">keys</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">':'</span> 
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_person<span class="token punctuation">;</span><span class="token comment">-- 创建存放数据的目录</span>
hdfs dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>shujia<span class="token operator">/</span>bigdata30<span class="token operator">/</span>copy

<span class="token comment">-- 导出查询结果的数据</span>
<span class="token keyword">insert</span> overwrite directory <span class="token string">'/data/'</span> <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">','</span> <span class="token keyword">select</span> clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> students <span class="token keyword">group</span> <span class="token keyword">by</span> clazz
</code></pre> 
<ul><li>直接使用HDFS命令保存表对应的文件夹</li></ul> 
<pre><code class="prism language-shell">// 创建存放数据的目录
hdfs dfs <span class="token parameter variable">-mkdir</span> <span class="token parameter variable">-p</span> /bigdata30/data

// 使用HDFS命令拷贝文件到其他目录
hdfs dfs <span class="token parameter variable">-cp</span> /hive/warehouse/t_person/*  /bigdata30/data
</code></pre> 
<ul><li> <p>将表结构和数据同时备份</p> <p>​ 将数据导出到HDFS</p> <pre><code class="prism language-sql"><span class="token comment">//创建存放数据的目录</span>
hdfs dfs <span class="token operator">-</span>mkdir <span class="token operator">-</span>p <span class="token operator">/</span>bigdata30<span class="token operator">/</span>copy

<span class="token comment">//导出查询结果的数据</span>
export <span class="token keyword">table</span> t_person <span class="token keyword">to</span> <span class="token string">'/bigdata30/copy'</span><span class="token punctuation">;</span>
</code></pre> <p>​ 删除表结构</p> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> t_person<span class="token punctuation">;</span>
</code></pre> <p>​ 恢复表结构和数据</p> <pre><code class="prism language-sql"><span class="token comment">// 加上 local 关键字 可以将Linux本地目录下的文件 上传到 hive表对应HDFS 目录下 原文件不会被删除</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/data/students.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>
<span class="token comment">// overwrite 覆盖加载</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/data/students.txt'</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> students<span class="token punctuation">;</span>
</code></pre> 
  <blockquote> 
   <p>注意：时间不同步，会导致导入导出失败</p> 
  </blockquote> </li></ul> 
<h2><a id="Hive_821"></a>Hive分区与排序（内置函数）</h2> 
<h2><a id="1Hive_823"></a>1、Hive分区(十分重要！！)</h2> 
<blockquote> 
 <p><strong>分区的目的：避免全表扫描，加快查询速度！</strong></p> 
</blockquote> 
<blockquote> 
 <p>在大数据中，最常见的一种思想就是<strong>分治</strong>，我们可以<strong>把大的文件切割划分成一个个的小的文件</strong>，这样每次操作一个个小的文件就会很容易了，同样的道理，在hive当中也是支持这种思想的，就是我们可以把大的数据，按照每天或者每小时切分成一个个小的文件，这样去操作小的文件就会容易很多了。</p> 
 <p>假如现在我们公司一天产生3亿的数据量，那么为了方便管理和查询，就做以下的事情。</p> 
 <p>​ 1）建立分区（可按照日期，部门等等具体业务分区）</p> 
 <p>​ 2）分门别类的管理</p> 
</blockquote> 
<h3><a id="11%09SP_839"></a>1.1 静态分区（SP）</h3> 
<blockquote> 
 <p>静态分区（SP）static partition–partition by (字段 类型)</p> 
 <p>​ <strong>借助于物理的文件夹分区，实现快速检索的目的。</strong></p> 
 <p>​ <strong>一般对于查询比较频繁的列设置为分区列。</strong></p> 
 <p>​ <strong>加载数据的时候直接把对应分区中所有数据放到对应的文件夹中</strong>。</p> 
</blockquote> 
<blockquote> 
 <p>创建单分区表语法：</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_student <span class="token punctuation">(</span>
sno <span class="token keyword">int</span><span class="token punctuation">,</span>
sname string
<span class="token punctuation">)</span> partitioned <span class="token keyword">by</span><span class="token punctuation">(</span>grade <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
<span class="token comment">--  分区的字段不要和表的字段相同。相同会报错error10035</span>


<span class="token number">1</span><span class="token punctuation">,</span>xiaohu01<span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">2</span><span class="token punctuation">,</span>xiaohu02<span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">3</span><span class="token punctuation">,</span>xiaohu03<span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">4</span><span class="token punctuation">,</span>xiaohu04<span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">5</span><span class="token punctuation">,</span>xiaohu05<span class="token punctuation">,</span><span class="token number">1</span>

<span class="token number">6</span><span class="token punctuation">,</span>xiaohu06<span class="token punctuation">,</span><span class="token number">2</span>
<span class="token number">7</span><span class="token punctuation">,</span>xiaohu07<span class="token punctuation">,</span><span class="token number">2</span>
<span class="token number">8</span><span class="token punctuation">,</span>xiaohu08<span class="token punctuation">,</span><span class="token number">2</span>

<span class="token number">9</span><span class="token punctuation">,</span>xiaohu09<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">10</span><span class="token punctuation">,</span>xiaohu10<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">11</span><span class="token punctuation">,</span>xiaohu11<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">12</span><span class="token punctuation">,</span>xiaohu12<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">13</span><span class="token punctuation">,</span>xiaohu13<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">14</span><span class="token punctuation">,</span>xiaohu14<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">15</span><span class="token punctuation">,</span>xiaohu15<span class="token punctuation">,</span><span class="token number">3</span>

<span class="token number">16</span><span class="token punctuation">,</span>xiaohu16<span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">17</span><span class="token punctuation">,</span>xiaohu17<span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">18</span><span class="token punctuation">,</span>xiaohu18<span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">19</span><span class="token punctuation">,</span>xiaohu19<span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">20</span><span class="token punctuation">,</span>xiaohu20<span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">21</span><span class="token punctuation">,</span>xiaohu21<span class="token punctuation">,</span><span class="token number">4</span>

<span class="token number">22</span><span class="token punctuation">,</span>xiaohu16<span class="token punctuation">,</span><span class="token number">5</span>
<span class="token number">23</span><span class="token punctuation">,</span>xiaohu17<span class="token punctuation">,</span><span class="token number">4</span>
<span class="token number">24</span><span class="token punctuation">,</span>xiaohu18<span class="token punctuation">,</span><span class="token number">5</span>
<span class="token number">25</span><span class="token punctuation">,</span>xiaohu19<span class="token punctuation">,</span><span class="token number">5</span>
<span class="token number">26</span><span class="token punctuation">,</span>xiaohu20<span class="token punctuation">,</span><span class="token number">5</span>
<span class="token number">27</span><span class="token punctuation">,</span>xiaohu21<span class="token punctuation">,</span><span class="token number">5</span>

<span class="token comment">-- 载入数据</span>
<span class="token comment">-- 将相应年级的数据导入对应分区中(对应的是分区文件夹)</span>
<span class="token comment">--导入一年级的数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/bigdata30/grade1.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t_student <span class="token keyword">partition</span><span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--导入二年级的数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/bigdata30/grade2.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t_student <span class="token keyword">partition</span><span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 演示多拷贝一行上传，分区的列的值是分区的值，不是原来的值</span>
</code></pre> 
<blockquote> 
 <p>静态多分区表语法：</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_teacher <span class="token punctuation">(</span>
tno <span class="token keyword">int</span><span class="token punctuation">,</span>
tname string
<span class="token punctuation">)</span> partitioned <span class="token keyword">by</span><span class="token punctuation">(</span>grade <span class="token keyword">int</span><span class="token punctuation">,</span>clazz <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>

<span class="token comment">--注意：前后两个分区的关系为父子关系，也就是grade文件夹下面有多个clazz子文件夹。</span>
<span class="token number">1</span><span class="token punctuation">,</span>xiaoge01<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">2</span><span class="token punctuation">,</span>xiaoge02<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>

<span class="token number">3</span><span class="token punctuation">,</span>xiaoge03<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
<span class="token number">4</span><span class="token punctuation">,</span>xiaoge04<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>

<span class="token number">5</span><span class="token punctuation">,</span>xiaoge05<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">6</span><span class="token punctuation">,</span>xiaoge06<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>

<span class="token number">7</span><span class="token punctuation">,</span>xiaoge07<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">8</span><span class="token punctuation">,</span>xiaoge08<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span>

<span class="token number">9</span><span class="token punctuation">,</span>xiaoge09<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span>

<span class="token comment">--载入数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/bigdata30/teacher_1.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t_teacher <span class="token keyword">partition</span><span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>clazz<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/bigdata30/teacher_2.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t_teacher <span class="token keyword">partition</span><span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>clazz<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>分区表查询</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">// 全表扫描，不推荐，效率低</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> students_pt1<span class="token punctuation">;</span>
<span class="token comment">//查询分区表的数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_student <span class="token keyword">where</span> grade <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// 使用where条件进行分区裁剪，避免了全表扫描，效率高</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> students_pt1 <span class="token keyword">where</span> grade <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// 也可以在where条件中使用非等值判断</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> students_pt1 <span class="token keyword">where</span> grade<span class="token operator">&lt;</span><span class="token number">3</span> <span class="token operator">and</span> grade<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>查看分区</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">show</span> partitions t_teacher<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>添加分区</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> t_student <span class="token keyword">add</span> <span class="token keyword">partition</span> <span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> t_teacher <span class="token keyword">add</span> <span class="token keyword">partition</span> <span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>clazz<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> location <span class="token string">'/user/hive/warehouse/bigdata29.db/t_teacher/grade=3/clazz=1'</span><span class="token punctuation">;</span>

location:表示hdfs上的分区路径（新添加在该表下的分区路径grade<span class="token operator">=</span><span class="token number">3</span><span class="token operator">/</span>clazz<span class="token operator">=</span><span class="token number">1</span>必须提前创建好）
</code></pre> 
<blockquote> 
 <p>删除分区</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> t_student <span class="token keyword">drop</span> <span class="token keyword">partition</span> <span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="13%09DP_966"></a>1.3 动态分区（DP）</h3> 
<ul><li>动态分区（DP）dynamic partition</li><li>静态分区与动态分区的<strong>主要区别在于静态分区是手动指定，而动态分区是通过数据来进行判断。</strong></li><li>详细来说，静态分区的列是在编译时期通过用户传递来决定的；<strong>动态分区只有在SQL执行时才能决定</strong>。</li></ul> 
<blockquote> 
 <p>开启动态分区首先要在hive会话中设置如下的参数</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment"># 表示开启动态分区</span>
hive<span class="token operator">&gt;</span> <span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment"># 表示动态分区模式：strict（需要配合静态分区一起使用）、nostrict</span>
<span class="token comment"># strict： insert into table students_pt partition(dt='anhui',pt) select ......,pt from students;</span>
hive<span class="token operator">&gt;</span> <span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>

<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span>以下是可选参数<span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span>

<span class="token comment"># 表示支持的最大的分区数量为1000，可以根据业务自己调整</span>
hive<span class="token operator">&gt;</span> <span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>max<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>pernode<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>其余的参数详细配置如下</p> 
</blockquote> 
<pre><code class="prism language-sql">设置为<span class="token boolean">true</span>表示开启动态分区的功能（默认为<span class="token boolean">false</span>）
<span class="token comment">--hive.exec.dynamic.partition=true;</span>

设置为nonstrict，表示允许所有分区都是动态的（默认为strict）
<span class="token comment">-- hive.exec.dynamic.partition.mode=nonstrict; </span>
<span class="token comment">-- hive.exec.dynamic.partition.mode=strict; </span>

每个mapper或reducer可以创建的最大动态分区个数<span class="token punctuation">(</span>默认为<span class="token number">100</span><span class="token punctuation">)</span> 
比如：源数据中包含了一年的数据，即<span class="token keyword">day</span>字段有<span class="token number">365</span>个值，那么该参数就需要设置成大于<span class="token number">365</span>，如果使用默认值<span class="token number">100</span>，则会报错
<span class="token comment">--hive.exec.max.dynamic.partition.pernode=100; </span>

一个动态分区创建可以创建的最大动态分区个数（默认值<span class="token number">1000</span>）
<span class="token comment">--hive.exec.max.dynamic.partitions=1000;</span>

全局可以创建的最大文件个数（默认值<span class="token number">100000</span>）
<span class="token comment">--hive.exec.max.created.files=100000; </span>

当有空分区产生时，是否抛出异常（默认<span class="token boolean">false</span>） 
<span class="token comment">-- hive.error.on.empty.partition=false;  </span>
</code></pre> 
<ul><li>案例1： 动态插入学生年级班级信息</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">--创建外部表</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_student_e <span class="token punctuation">(</span>
sno <span class="token keyword">int</span><span class="token punctuation">,</span>
sname string<span class="token punctuation">,</span>
grade <span class="token keyword">int</span><span class="token punctuation">,</span>
clazz <span class="token keyword">int</span>
<span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
location <span class="token string">"/bigdata30/teachers"</span><span class="token punctuation">;</span>

<span class="token comment">--创建分区表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> t_student_d <span class="token punctuation">(</span>
sno <span class="token keyword">int</span><span class="token punctuation">,</span>
sname string
<span class="token punctuation">)</span> partitioned <span class="token keyword">by</span> <span class="token punctuation">(</span>grade <span class="token keyword">int</span><span class="token punctuation">,</span>clazz <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code>数据：

1,xiaohu01,1,1
2,xiaohu02,1,1
3,xiaohu03,1,1
4,xiaohu04,1,2
5,xiaohu05,1,2
6,xiaohu06,2,3
7,xiaohu07,2,3
8,xiaohu08,2,3
9,xiaohu09,3,3
10,xiaohu10,3,3
11,xiaohu11,3,3
12,xiaohu12,3,4
13,xiaohu13,3,4
14,xiaohu14,3,4
15,xiaohu15,3,4
16,xiaohu16,4,4
17,xiaohu17,4,4
18,xiaohu18,4,5
19,xiaohu19,4,5
20,xiaohu20,4,5
21,xiaohu21,4,5
</code></pre> 
<blockquote> 
 <p>如果静态分区的话，我们插入数据必须指定分区的值。</p> 
 <p>如果想要插入多个班级的数据，我要写很多SQL并且执行24次很麻烦。</p> 
 <p>而且静态分区有可能会产生数据错误问题</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 会报错 </span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> t_student_d <span class="token keyword">partition</span> <span class="token punctuation">(</span>grade<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>clazz<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_student_e<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>如果使用动态分区，动态分区会根据select的结果自动判断数据应该load到哪儿分区去。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> t_student_d <span class="token keyword">partition</span> <span class="token punctuation">(</span>grade<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_student_e<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>优点：不用手动指定了，自动会对数据进行分区</p> 
 <p>缺点：可能会出现<strong>数据倾斜</strong></p> 
</blockquote> 
<h2><a id="2Hive_1080"></a>2、Hive分桶</h2> 
<h3><a id="21%09_1082"></a>2.1 业务场景</h3> 
<blockquote> 
 <h4><a id="_1084"></a>数据分桶的适用场景：</h4> 
 <p>​ 分区提供了一个隔离数据和优化查询的便利方式，不过并非所有的数据都可形成合理的分区，尤其是需要确定合适大小的分区划分方式<br> ​ 不合理的数据分区划分方式可能导致有的分区数据过多，而某些分区没有什么数据的尴尬情况<br> ​ 分桶是将数据集分解为更容易管理的若干部分的另一种技术。<br> ​ 分桶就是将数据按照字段进行划分，可以将数据按照字段划分到多个文件当中去。(都各不相同)</p> 
</blockquote> 
<h3><a id="22%09_1091"></a>2.2 数据分桶原理</h3> 
<ul><li>Hive采用对列值哈希，然后除以桶的个数求余的方式决定该条记录存放在哪个桶当中。 
  <ul><li>bucket num = hash_function(bucketing_column) mod num_buckets ( hash(name)%n == x )</li><li>列的值做哈希取余 决定数据应该存储到哪个桶</li></ul> </li></ul> 
<h3><a id="23%09_1097"></a>2.3 数据分桶优势</h3> 
<blockquote> 
 <p><strong>方便抽样</strong></p> 
 <p>​ 使取样（sampling）更高效。在处理大规模数据集时，在开发和修改查询的阶段，如果能在数据集的一小部分数据上试运行查询，会带来很多方便</p> 
 <p><strong>提高join查询效率</strong></p> 
 <p>​ 获得更高的查询处理效率。桶为表加上了额外的结构，Hive 在处理有些查询时能利用这个结构。具体而言，连接两个在（包含连接列的）相同列上划分了桶的表，可以使用 Map 端连接 （Map-side join）高效的实现。比如JOIN操作。对于JOIN操作两个表有一个相同的列，如果对这两个表都进行了桶操作。那么将保存相同列值的桶进行JOIN操作就可以，可以大大较少JOIN的数据量。</p> 
</blockquote> 
<h3><a id="24%09_1107"></a>2.4 分桶实战</h3> 
<blockquote> 
 <p>​ 首先，分区和分桶是两个不同的概念，很多资料上说需要先分区在分桶，其实不然，分区是对数据进行划分，而分桶是对文件进行划分。</p> 
 <p>​ 当我们的分区之后，最后的文件还是很大怎么办，就引入了分桶的概念。</p> 
 <p>将这个比较大的文件再分成若干个小文件进行存储，我们再去查询的时候，在这个小范围的文件中查询就会快很多。</p> 
 <p>​ 对于hive中的每一张表、分区都可以进一步的进行分桶。</p> 
 <p>​ 当然，分桶不是说将文件随机进行切分存储，而是有规律的进行存储。在看完下面的例子后进行解释，现在干巴巴的解释也不太好理解。它是由列的哈希值除以桶的个数来决定每条数据划分在哪个桶中。</p> 
 <p>创建顺序和分区一样，创建的方式不一样。</p> 
</blockquote> 
<blockquote> 
 <p><strong>首先我们需要开启分桶的支持</strong></p> 
</blockquote> 
<pre><code class="prism language-sql">（依然十分重要，不然无法进行分桶操作！！！！）
<span class="token keyword">set</span> hive<span class="token punctuation">.</span>enforce<span class="token punctuation">.</span>bucketing<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> 
</code></pre> 
<blockquote> 
 <p><strong>数据准备（id,name,age）</strong></p> 
</blockquote> 
<pre><code>1,tom,11
2,cat,22
3,dog,33
4,hive,44
5,hbase,55
6,mr,66
7,alice,77
8,scala,88
</code></pre> 
<blockquote> 
 <p><strong>创建一个普通的表</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> person
<span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">,</span>
name string<span class="token punctuation">,</span>
age <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>将数据load到这张表中</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'文件在Linux上的绝对路径'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> person <span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>创建分桶表</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> psn_bucket
<span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">,</span>
name string<span class="token punctuation">,</span>
age <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">clustered</span> <span class="token keyword">by</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">into</span> <span class="token number">4</span> buckets
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>将数据insert到表psn_bucket中</strong></p> 
 <p><strong>(注意：这里和分区表插入数据有所区别，分区表需要select 和指定分区，而分桶则不需要)</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> psn_bucket <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> person<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>在HDFS上查看数据</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/35/17/a3WfBm7t_o.png" alt="image-20220601223434297"></p> 
<blockquote> 
 <p><strong>查询数据</strong></p> 
 <p><strong>我们在linux中使用Hadoop的命令查看一下（与我们猜想的顺序一致）</strong></p> 
</blockquote> 
<pre><code>hadoop fs -cat /user/hive/warehouse/bigdata30.db/psn_bucket/*
</code></pre> 
<blockquote> 
 <p>这里设置的桶的个数是4 数据按照 年龄%4 进行放桶(文件)<br> 11%4 == 3 -----&gt; 000003_0<br> 22%4 == 2 -----&gt; 000002_0<br> 33%4 == 1 -----&gt; 000001_0<br> 44%4 == 0 -----&gt; 000000_0<br> …以此类推</p> 
</blockquote> 
<h2><a id="3Hive_JDBC_1202"></a>3、Hive JDBC</h2> 
<h6><a id="hiveserver2_1204"></a>启动hiveserver2</h6> 
<pre><code class="prism language-shell"><span class="token function">nohup</span> hiveserver2 <span class="token operator">&amp;</span>
或者
hiveserver2 <span class="token operator">&amp;</span>
</code></pre> 
<h6><a id="maven_1212"></a>新建maven项目并添加两个依赖</h6> 
<pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;
        &lt;artifactId&gt;hadoop-common&lt;/artifactId&gt;
        &lt;version&gt;2.7.6&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.apache.hive/hive-jdbc --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;
        &lt;artifactId&gt;hive-jdbc&lt;/artifactId&gt;
        &lt;version&gt;1.2.1&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre> 
<h6><a id="JDBC_1228"></a>编写JDBC代码</h6> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HiveJDBC</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.apache.hive.jdbc.HiveDriver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:hive2://master:10000/bigdata29"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Statement</span> stat <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token string">"select * from students limit 10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> id <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> age <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> gender <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> clazz <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> gender <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stat<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="4Hive4_1254"></a>4、Hive的4种排序</h2> 
<p><img src="https://images2.imgbox.com/e4/65/d7YUUOfM_o.png" alt="hive的4种排序"></p> 
<h3><a id="41%09_1258"></a>4.1 全局排序</h3> 
<ul><li><strong>order by 会对输入做全局排序，因此只有一个reducer</strong>，会导致当输入规模较大时，需要较长的计算时间</li><li>使用 order by子句排序 :ASC（ascend）升序（默认）| DESC（descend）降序</li><li><strong>order by放在select语句的结尾</strong></li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 <span class="token keyword">order</span> <span class="token keyword">by</span> 字段名<span class="token number">1</span><span class="token punctuation">[</span>，别名<span class="token number">2.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="42%09reduce_1268"></a>4.2 局部排序(对reduce内部做排序)</h3> 
<ul><li><strong>sort by 不是全局排序,其在数据进入reducer前完成排序</strong>。</li><li>如果用sort by进行排序，并且设置mapred.reduce.tasks&gt;1,则sort by 只保证每个reducer的输出有序，<strong>不保证全局有序</strong>。asc,desc</li><li>设置reduce个数</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>查看reduce个数</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token punctuation">;</span>
</code></pre> 
<ul><li>排序</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 sort <span class="token keyword">by</span> 字段名<span class="token punctuation">[</span><span class="token punctuation">,</span>字段名<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="43%09_1290"></a>4.3 分区排序(本身没有排序)</h3> 
<blockquote> 
 <p><strong>distribute by（字段）根据指定的字段将数据</strong>分到不同的reducer，且分发算法是hash散列。</p> 
 <p><strong>类似MR中partition,进行分区，结合sort by使用。</strong>（注意：distribute by 要在sort by之前）</p> 
 <p>对于distrbute by 进行测试，一定要多分配reduce进行处理，否则无法看到distribute by的效果。</p> 
 <p>设置reduce个数</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduce<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>排序</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 distribute <span class="token keyword">by</span> 字段名<span class="token punctuation">[</span><span class="token punctuation">,</span>字段名<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> sort <span class="token keyword">by</span> 字段<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="43%09_1310"></a>4.3 分区并排序</h3> 
<ul><li>cluster by（字段）除了具有Distribute by的功能外，还会对该字段进行排序 asc desc</li><li>cluster by = distribute by + sort by 只能默认升序，不能使用倒序</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 cluster <span class="token keyword">by</span> 字段名<span class="token punctuation">[</span><span class="token punctuation">,</span>字段名<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> 表名 distribute <span class="token keyword">by</span> 字段名<span class="token punctuation">[</span><span class="token punctuation">,</span>字段名<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> sort <span class="token keyword">by</span> 字段名<span class="token punctuation">[</span><span class="token punctuation">,</span>字段名<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="5Hive_1322"></a>5、Hive内置函数</h2> 
<pre><code class="prism language-sql">https:<span class="token comment">//cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">-- 1.查看系统自带函数</span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
<span class="token comment">-- 2.显示自带的函数的用法</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> xxxx<span class="token punctuation">;</span>
<span class="token comment">-- 3.详细显示自带的函数的用法</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> <span class="token keyword">extended</span> upper<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="51%09_1339"></a>5.1 内置函数分类</h3> 
<pre><code class="prism language-sql">关系操作符：包括 <span class="token operator">=</span> 、 <span class="token operator">&lt;&gt;</span> 、 <span class="token operator">&lt;=</span> 、<span class="token operator">&gt;=</span>等

算数操作符：包括 <span class="token operator">+</span> 、 <span class="token operator">-</span> 、 <span class="token operator">*</span>、／等

逻辑操作符：包括<span class="token operator">AND</span> 、 <span class="token operator">&amp;&amp;</span> 、 <span class="token operator">OR</span> 、 <span class="token operator">||</span> 等

复杂类型构造函数：包括map、struct、create_union等

复杂类型操作符：包括A<span class="token punctuation">[</span>n<span class="token punctuation">]</span>、Map<span class="token punctuation">[</span><span class="token keyword">key</span><span class="token punctuation">]</span>、S<span class="token punctuation">.</span>x

数学操作符：包括ln<span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">)</span>、sqrt<span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">)</span>等

集合操作符：包括size<span class="token punctuation">(</span>Array<span class="token punctuation">)</span>、sort_array<span class="token punctuation">(</span>Array<span class="token punctuation">)</span>等

类型转换函数： <span class="token keyword">binary</span><span class="token punctuation">(</span>string<span class="token operator">|</span><span class="token keyword">binary</span><span class="token punctuation">)</span>、cast<span class="token punctuation">(</span>expr <span class="token keyword">as</span> <span class="token punctuation">)</span>

日期函数：包括from_unixtime<span class="token punctuation">(</span><span class="token keyword">bigint</span> unixtime<span class="token punctuation">[</span><span class="token punctuation">,</span> string format<span class="token punctuation">]</span><span class="token punctuation">)</span>、unix_timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span>等

条件函数：包括<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> testCondition<span class="token punctuation">,</span> T valueTrue<span class="token punctuation">,</span> T valueFalseOrNull<span class="token punctuation">)</span>等

字符串函数：包括acat<span class="token punctuation">(</span>string<span class="token operator">|</span><span class="token keyword">binary</span> A<span class="token punctuation">,</span> string<span class="token operator">|</span><span class="token keyword">binary</span> B…<span class="token punctuation">)</span>等

其他：xpath、get_json_objectscii<span class="token punctuation">(</span>string str<span class="token punctuation">)</span>、con
</code></pre> 
<h3><a id="52%09UDTF_hive_1367"></a>5.2 UDTF hive中特殊的一个功能（进一出多）</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- UDF 进一出一</span>


<span class="token comment">-- UDAF 进多出一</span>
<span class="token comment">-- collect_set()和collect_list()将多行数据转成一行，区别就是list里面可重复而set里面是去重的</span>
<span class="token comment">-- concat_ws(':',collect_set(type))   ':' 表示你合并后用什么分隔，collect_set(stage)表示要合并表中的那一列数据</span>
<span class="token keyword">select</span> 字段名<span class="token punctuation">,</span>concat_ws<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>列名<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 别名 <span class="token keyword">from</span> 表名 <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>

<span class="token comment">-- UDTF 进一出多</span>
<span class="token comment">-- explode  可以将一行数据变成多行数据</span>
<span class="token keyword">select</span>  explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>列名<span class="token punctuation">,</span><span class="token string">"数据的分隔符"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> 表名<span class="token punctuation">;</span>
<span class="token comment">-- lateral view 表生成函数，可以将explode的数据生成一个列表</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>列名 <span class="token keyword">from</span> 表<span class="token number">1</span><span class="token punctuation">,</span>lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>表<span class="token number">1.</span>列名<span class="token punctuation">,</span><span class="token string">"数据的分隔符"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>新列名 <span class="token keyword">as</span> 别列名<span class="token punctuation">;</span>

<span class="token comment">--注意：collect_set() 和 collect_list() 是 Hive 中用于聚合操作的集合函数，它们分别用于将列值聚合成集合或列表。</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建数据库表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t_movie1<span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">,</span>
name string<span class="token punctuation">,</span>
<span class="token keyword">types</span> string
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>

<span class="token comment">-- 电影数据  movie1.txt</span>
<span class="token comment">-- 加载数据到数据库 load data inpath '/shujia/movie1.txt' into table t_movie1;</span>
<span class="token number">1</span><span class="token punctuation">,</span>这个杀手不太冷<span class="token punctuation">,</span>剧情<span class="token operator">-</span>动作<span class="token operator">-</span>犯罪
<span class="token number">2</span><span class="token punctuation">,</span>七武士<span class="token punctuation">,</span>动作<span class="token operator">-</span>冒险<span class="token operator">-</span>剧情
<span class="token number">3</span><span class="token punctuation">,</span>勇敢的心<span class="token punctuation">,</span>动作<span class="token operator">-</span>传记<span class="token operator">-</span>剧情<span class="token operator">-</span>历史<span class="token operator">-</span>战争
<span class="token number">4</span><span class="token punctuation">,</span>东邪西毒<span class="token punctuation">,</span>剧情<span class="token operator">-</span>动作<span class="token operator">-</span>爱情<span class="token operator">-</span>武侠<span class="token operator">-</span>古装
<span class="token number">5</span><span class="token punctuation">,</span>霍比特人<span class="token punctuation">,</span>动作<span class="token operator">-</span>奇幻<span class="token operator">-</span>冒险

<span class="token comment">-- explode  可以将一组数组的数据变成一列表</span>
<span class="token keyword">select</span>  explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token keyword">types</span><span class="token punctuation">,</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t_movie1<span class="token punctuation">;</span>

<span class="token comment">-- lateral view 表生成函数，可以将explode的数据生成一个列表</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span><span class="token keyword">type</span> <span class="token keyword">from</span> t_movie1 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token keyword">types</span><span class="token punctuation">,</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> typetable <span class="token keyword">as</span> <span class="token keyword">type</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建数据库表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t_movie2<span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">,</span>
name string<span class="token punctuation">,</span>
<span class="token keyword">type</span> string
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span>
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>

<span class="token comment">-- 电影数据 movie2.txt</span>
<span class="token comment">-- 加载数据到数据库 load data inpath '/shujia/movie2.txt' into table t_movie2;                                    1,这个杀手不太冷,剧情</span>
<span class="token number">1</span><span class="token punctuation">,</span>这个杀手不太冷<span class="token punctuation">,</span>动作
<span class="token number">1</span><span class="token punctuation">,</span>这个杀手不太冷<span class="token punctuation">,</span>犯罪
<span class="token number">2</span><span class="token punctuation">,</span>七武士<span class="token punctuation">,</span>动作
<span class="token number">2</span><span class="token punctuation">,</span>七武士<span class="token punctuation">,</span>冒险
<span class="token number">2</span><span class="token punctuation">,</span>七武士<span class="token punctuation">,</span>剧情
<span class="token number">3</span><span class="token punctuation">,</span>勇敢的心<span class="token punctuation">,</span>动作
<span class="token number">3</span><span class="token punctuation">,</span>勇敢的心<span class="token punctuation">,</span>传记
<span class="token number">3</span><span class="token punctuation">,</span>勇敢的心<span class="token punctuation">,</span>剧情
<span class="token number">3</span><span class="token punctuation">,</span>勇敢的心<span class="token punctuation">,</span>历史
<span class="token number">3</span><span class="token punctuation">,</span>勇敢的心<span class="token punctuation">,</span>战争
<span class="token number">4</span><span class="token punctuation">,</span>东邪西毒<span class="token punctuation">,</span>剧情
<span class="token number">4</span><span class="token punctuation">,</span>东邪西毒<span class="token punctuation">,</span>动作
<span class="token number">4</span><span class="token punctuation">,</span>东邪西毒<span class="token punctuation">,</span>爱情
<span class="token number">4</span><span class="token punctuation">,</span>东邪西毒<span class="token punctuation">,</span>武侠
<span class="token number">4</span><span class="token punctuation">,</span>东邪西毒<span class="token punctuation">,</span>古装
<span class="token number">5</span><span class="token punctuation">,</span>霍比特人<span class="token punctuation">,</span>动作
<span class="token number">5</span><span class="token punctuation">,</span>霍比特人<span class="token punctuation">,</span>奇幻
<span class="token number">5</span><span class="token punctuation">,</span>霍比特人<span class="token punctuation">,</span>冒险

<span class="token comment">-- collect_set()和collect_list()都是对列转成行，区别就是list里面可重复而set里面是去重的</span>
<span class="token comment">-- concat_ws(':',collect_set(type))   ':' 表示你合并后用什么分隔，collect_set(stage)表示要合并表中的那一列数据</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>concat_ws<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">types</span> <span class="token keyword">from</span> t_movie2 <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="53%09WordCount_1448"></a>5.3 WordCount案例</h3> 
<blockquote> 
 <p>数据准备</p> 
</blockquote> 
<pre><code>hello,world
hello,bigdata
like,life
bigdata,good
</code></pre> 
<blockquote> 
 <p>建表</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> wc2
<span class="token punctuation">(</span>
line string
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span>
</code></pre> 
<blockquote> 
 <p>导入数据</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/data/wc1.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> wc<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>步骤1：先对一行数据进行切分</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> split<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token keyword">from</span> wc<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>步骤2：将行转列</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> wc<span class="token punctuation">;</span> 
</code></pre> 
<blockquote> 
 <p><strong>步骤3：将相同的进行分组统计</strong></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> w<span class="token punctuation">.</span>word<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> word <span class="token keyword">from</span> wc<span class="token punctuation">)</span> w <span class="token keyword">group</span> <span class="token keyword">by</span> w<span class="token punctuation">.</span>word<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="Hive_1493"></a>Hive函数学习</h2> 
<h2><a id="1countcount1_count__1495"></a>1、count(*)、count(1) 、count(‘字段名’) 区别</h2> 
<blockquote> 
 <p><strong>从执行结果来看</strong></p> 
 <ul><li>count(*)包括了所有的列，相当于行数，在统计结果的时候，不会忽略列值为NULL 最慢的</li><li>count(1)忽略所有列，只计算行的数量，在统计结果的时候，不会忽略列值为NULL 最快的</li><li>count(列名)只包括列名那一列，在统计结果的时候，会忽略列值为空（这里的空不是只空字符串或者0，而是表示null）的计数，即某个字段值为NULL时，不统计 仅次于count(1)</li></ul> 
 <p><strong>从执行效率来看</strong></p> 
 <ul><li>如果列为主键，count(列名)效率优于count(1)</li><li>如果列不为主键，count(1)效率优于count(列名)</li><li>如果表中存在主键，count(主键列名)效率最优</li><li><strong>如果表中只有一列，则count(*)效率最优</strong></li><li>如果表有多列，且不存在主键，则count(1)效率优于count(*)</li></ul> 
 <p><strong>在工作中如果没有特殊的要求，就使用count(1)来进行计数。</strong></p> 
</blockquote> 
<h2><a id="2hive_1513"></a>2、<strong>hive语句的执行顺序</strong></h2> 
<p>1.from</p> 
<p>2.join on 或 lateral view explode(需炸裂的列) tbl as 炸裂后的列名</p> 
<p>3.where</p> 
<p>4.group by</p> 
<p>5.聚合函数 如Sum() avg() count(1)等</p> 
<p>6.having 在此开始可以使用select中的别名</p> 
<p>7.select 若包含over（）开窗函数，此时select中的内容作为窗口函数的输入，窗口中所选的数据范围也是在group by，having之后，并不是针对where后的数据进行开窗，这点要注意。需要注意开窗函数的执行顺序及时间点。</p> 
<p>8.distinct</p> 
<p>9.order by</p> 
<p>10.limit（建议：今后在大数据环境中，一张表的数据量肯定十分庞大的，养成加limit的习惯）</p> 
<blockquote> 
 <p>where 条件里不支持不等式子查询，实际上是支持 in、not in、exists、not exists( hive3.x版本是支持的 )</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment"># 查询薪资大于SCOTT的薪资员工信息</span>

<span class="token comment">-- 列出与“SCOTT”从事相同工作的所有员工。</span>
<span class="token keyword">select</span>  t1<span class="token punctuation">.</span>EMPNO
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>ENAME
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>JOB
<span class="token keyword">from</span> emp t1
<span class="token keyword">where</span> t1<span class="token punctuation">.</span>ENAME <span class="token operator">!=</span> <span class="token string">"SCOTT"</span> <span class="token operator">and</span> t1<span class="token punctuation">.</span>job <span class="token operator">in</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span>  job
    <span class="token keyword">from</span> emp
    <span class="token keyword">where</span> ENAME <span class="token operator">=</span> <span class="token string">"SCOTT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token number">7900</span><span class="token punctuation">,</span>JAMES<span class="token punctuation">,</span>CLERK<span class="token punctuation">,</span><span class="token number">7698</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">950</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">30</span>
<span class="token number">7902</span><span class="token punctuation">,</span>FORD<span class="token punctuation">,</span>ANALYST<span class="token punctuation">,</span><span class="token number">7566</span><span class="token punctuation">,</span><span class="token number">1981</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">20</span>

<span class="token keyword">select</span>  t1<span class="token punctuation">.</span>EMPNO
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>ENAME
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>JOB
<span class="token keyword">from</span> emp t1
<span class="token keyword">where</span> t1<span class="token punctuation">.</span>ENAME <span class="token operator">!=</span> <span class="token string">"SCOTT"</span> <span class="token operator">and</span> <span class="token keyword">exists</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span>  job
    <span class="token keyword">from</span> emp t2
    <span class="token keyword">where</span> ENAME <span class="token operator">=</span> <span class="token string">"SCOTT"</span>
    <span class="token operator">and</span> t1<span class="token punctuation">.</span>job <span class="token operator">=</span> t2<span class="token punctuation">.</span>job
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>4、hive中大小写不敏感（<strong>列名无所谓大小写</strong>）</p> 
<p>5、在hive中，数据中如果有null字符串，加载到表中的时候会变成 null （不是字符串）</p> 
<blockquote> 
 <p>如果需要判断 null，使用 某个字段名 is null 这样的方式来判断</p> 
 <p>或者使用 nvl() 函数，不能 直接 某个字段名 == null</p> 
</blockquote> 
<p>6、使用explain查看SQL执行计划</p> 
<blockquote> 
 <p>面试题：hive中一条sql语句如何解析成MapReduce作业执行的？（hive的版本）</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span>  t1<span class="token punctuation">.</span>EMPNO
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>ENAME
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>JOB
<span class="token keyword">from</span> emp t1
<span class="token keyword">where</span> t1<span class="token punctuation">.</span>ENAME <span class="token operator">!=</span> <span class="token string">"SCOTT"</span> <span class="token operator">and</span> t1<span class="token punctuation">.</span>job <span class="token operator">in</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span>  job
    <span class="token keyword">from</span> emp
    <span class="token keyword">where</span> ENAME <span class="token operator">=</span> <span class="token string">"SCOTT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token comment"># 查看更加详细的执行计划，加上extended</span>
<span class="token keyword">explain</span> <span class="token keyword">extended</span> <span class="token keyword">select</span>  t1<span class="token punctuation">.</span>EMPNO
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>ENAME
        <span class="token punctuation">,</span>t1<span class="token punctuation">.</span>JOB
<span class="token keyword">from</span> emp t1
<span class="token keyword">where</span> t1<span class="token punctuation">.</span>ENAME <span class="token operator">!=</span> <span class="token string">"SCOTT"</span> <span class="token operator">and</span> t1<span class="token punctuation">.</span>job <span class="token operator">in</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span>  job
    <span class="token keyword">from</span> emp
    <span class="token keyword">where</span> ENAME <span class="token operator">=</span> <span class="token string">"SCOTT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3Hive__1598"></a>3、Hive 常用函数</h2> 
<h3><a id="31_1600"></a>3.1、关系运算</h3> 
<pre><code>// 等值比较 = == &lt; = &gt;
// 不等值比较 != &lt;&gt;
// 区间比较： select * from default.students where id between 1500100001 and 1500100010;
// 空值/非空值判断：isnull、isnotnull、nvl()、isnull()
// like、rlike、regexp用法
</code></pre> 
<h3><a id="32_1610"></a>3.2、数值计算</h3> 
<pre><code class="prism language-sql">取整函数<span class="token punctuation">(</span>四舍五入<span class="token punctuation">)</span>：round
向上取整：ceil
向下取整：floor
</code></pre> 
<h3><a id="33_1618"></a>3.3、条件函数(主要使用场景是数据清洗的过程中使用，有些构建表的过程也是需要的)</h3> 
<ul><li>if： if(表达式,如果表达式成立的返回值,如果表达式不成立的返回值) （<strong>重点</strong>）</li><li>条件表达式?表达式1:表达式2;</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> sc<span class="token punctuation">(</span>
sno string<span class="token punctuation">,</span>
cno string<span class="token punctuation">,</span>
score <span class="token keyword">bigint</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> sal<span class="token punctuation">,</span><span class="token keyword">if</span><span class="token punctuation">(</span>sal<span class="token operator">&lt;</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">'低薪'</span><span class="token punctuation">,</span><span class="token keyword">if</span><span class="token punctuation">(</span>sal<span class="token operator">&gt;=</span><span class="token number">2000</span> <span class="token operator">and</span> sal<span class="token operator">&lt;</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token string">'中等'</span><span class="token punctuation">,</span><span class="token string">'高薪'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">level</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> score<span class="token punctuation">,</span><span class="token keyword">if</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token string">'优秀'</span><span class="token punctuation">,</span><span class="token keyword">if</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token string">'良好'</span><span class="token punctuation">,</span><span class="token keyword">if</span><span class="token punctuation">(</span>score<span class="token operator">&gt;</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token string">'及格'</span><span class="token punctuation">,</span><span class="token string">'不及格'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pingfen <span class="token keyword">from</span> sc<span class="token punctuation">;</span>
</code></pre> 
<ul><li>COALESCE</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 从左往右 依次匹配 直到非空为止</span>
<span class="token keyword">select</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre> 
<ul><li>case when（<strong>重点</strong>）</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> sal<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> sal<span class="token operator">&lt;</span><span class="token number">2000</span> <span class="token keyword">then</span> <span class="token string">'低薪'</span> 
                <span class="token keyword">when</span> sal<span class="token operator">&gt;=</span><span class="token number">2000</span> <span class="token operator">and</span> sal<span class="token operator">&lt;</span><span class="token number">3000</span> <span class="token keyword">then</span> <span class="token string">'中等薪资'</span>
                <span class="token keyword">else</span> <span class="token string">'高薪'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token keyword">level</span>
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token keyword">select</span>  score
        <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> score<span class="token operator">&gt;</span><span class="token number">90</span> <span class="token keyword">then</span> <span class="token string">'优秀'</span>
              <span class="token keyword">when</span> score<span class="token operator">&gt;</span><span class="token number">80</span> <span class="token keyword">then</span> <span class="token string">'良好'</span>
              <span class="token keyword">when</span> score<span class="token operator">&gt;=</span><span class="token number">60</span> <span class="token keyword">then</span> <span class="token string">'及格'</span>
        <span class="token keyword">else</span> <span class="token string">'不及格'</span>
        <span class="token keyword">end</span> <span class="token keyword">as</span> pingfen
<span class="token keyword">from</span> sc<span class="token punctuation">;</span>

<span class="token keyword">select</span>  name
        <span class="token punctuation">,</span><span class="token keyword">case</span> name <span class="token keyword">when</span> <span class="token string">"施笑槐"</span> <span class="token keyword">then</span> <span class="token string">"槐ge"</span>
                  <span class="token keyword">when</span> <span class="token string">"吕金鹏"</span> <span class="token keyword">then</span> <span class="token string">"鹏ge"</span>
                  <span class="token keyword">when</span> <span class="token string">"单乐蕊"</span> <span class="token keyword">then</span> <span class="token string">"蕊jie"</span>
        <span class="token keyword">else</span> <span class="token string">"算了不叫了"</span>
        <span class="token keyword">end</span> <span class="token keyword">as</span> nickname
<span class="token keyword">from</span> students <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注意条件的顺序</p> 
</blockquote> 
<h3><a id="34_1670"></a>3.4、日期函数重点！！！</h3> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1717666208</span><span class="token punctuation">,</span><span class="token string">'YYYY年MM月dd日 hh时mm分ss秒'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span>unix_timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'YYYY/MM/dd HH:mm:ss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// '2021年01月14日' -&gt; '2021-01-14'</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span>unix_timestamp<span class="token punctuation">(</span><span class="token string">'2024年06月06日'</span><span class="token punctuation">,</span><span class="token string">'yyyy年MM月dd日'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// "04牛2021数加16强" -&gt; "2021/04/16"</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span>unix_timestamp<span class="token punctuation">(</span><span class="token string">"04牛2024数加11强"</span><span class="token punctuation">,</span><span class="token string">"MM牛yyyy数加dd强"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"yyyy年MM月dd日"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="35_1684"></a>3.5、字符串函数</h3> 
<pre><code class="prism language-sql">concat<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token string">'456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 123456</span>
concat<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token string">'456'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NULL</span>

<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a#b#c</span>
<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a#b#c 可以指定分隔符，并且会自动忽略NULL</span>
<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">,</span>cast<span class="token punctuation">(</span>id <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span>cast<span class="token punctuation">(</span>age <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span> <span class="token keyword">from</span> students <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> substring<span class="token punctuation">(</span><span class="token string">"abcdefg"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// abcdefg HQL中涉及到位置的时候 是从1开始计数</span>
<span class="token comment">// '2021/01/14' -&gt; '2021-01-14'</span>
<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span>substring<span class="token punctuation">(</span><span class="token string">'2021/01/14'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>substring<span class="token punctuation">(</span><span class="token string">'2021/01/14'</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>substring<span class="token punctuation">(</span><span class="token string">'2021/01/14'</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 建议使用日期函数去做日期</span>
<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span>unix_timestamp<span class="token punctuation">(</span><span class="token string">'2021/01/14'</span><span class="token punctuation">,</span><span class="token string">'yyyy/MM/dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> split<span class="token punctuation">(</span><span class="token string">"abcde,fgh"</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ["abcde","fgh"]</span>
<span class="token keyword">select</span> split<span class="token punctuation">(</span><span class="token string">"a,b,c,d,e,f"</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// c 数组的下标依旧是从0开始</span>

<span class="token keyword">select</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token string">"abcde,fgh"</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// abcde</span>
										<span class="token comment">//  fgh</span>

<span class="token comment">// 解析json格式的数据</span>
<span class="token keyword">select</span> get_json_object<span class="token punctuation">(</span><span class="token string">'{"name":"zhangsan","age":18,"score":[{"course_name":"math","score":100},{"course_name":"english","score":60}]}'</span><span class="token punctuation">,</span><span class="token string">"$.score[0].score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 60</span>

{
	<span class="token string">"name"</span>: <span class="token string">"zhangsan"</span><span class="token punctuation">,</span>
	<span class="token string">"age"</span>: <span class="token number">18</span><span class="token punctuation">,</span>
	<span class="token string">"score"</span>: <span class="token punctuation">[</span>{
		<span class="token string">"course_name"</span>: <span class="token string">"math"</span><span class="token punctuation">,</span>
		<span class="token string">"score"</span>: <span class="token number">100</span>
	}<span class="token punctuation">,</span> {
		<span class="token string">"course_name"</span>: <span class="token string">"english"</span><span class="token punctuation">,</span>
		<span class="token string">"score"</span>: <span class="token number">60</span>
	}<span class="token punctuation">]</span>
}
$<span class="token punctuation">.</span>score<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score
</code></pre> 
<h3><a id="36Hive_wordCount_1723"></a>3.6、例题：Hive 中的wordCount</h3> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> words<span class="token punctuation">(</span>
    words string
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>

<span class="token comment">// 数据</span>
hello<span class="token punctuation">,</span>java<span class="token punctuation">,</span>hello<span class="token punctuation">,</span>java<span class="token punctuation">,</span>scala<span class="token punctuation">,</span>python
hbase<span class="token punctuation">,</span>hadoop<span class="token punctuation">,</span>hadoop<span class="token punctuation">,</span>hdfs<span class="token punctuation">,</span>hive<span class="token punctuation">,</span>hive
hbase<span class="token punctuation">,</span>hadoop<span class="token punctuation">,</span>hadoop<span class="token punctuation">,</span>hdfs<span class="token punctuation">,</span>hive<span class="token punctuation">,</span>hive

<span class="token keyword">select</span> word<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>words<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span> word <span class="token keyword">from</span> words<span class="token punctuation">)</span> a <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>word<span class="token punctuation">;</span>

<span class="token comment">// 结果</span>
hadoop	<span class="token number">4</span>
hbase	<span class="token number">2</span>
hdfs	<span class="token number">2</span>
hello	<span class="token number">2</span>
hive	<span class="token number">4</span>
java	<span class="token number">2</span>
python	<span class="token number">1</span>
scala	<span class="token number">1</span>
</code></pre> 
<h4><a id="37Hive_1748"></a>3.7、Hive窗口函数</h4> 
<blockquote> 
 <p>普通的聚合函数每组(Group by)只返回一个值，而开窗函数则可为窗口中的每行都返回一个值。<br> 简单理解，就是对查询的结果多出一列，这一列可以是聚合值，也可以是排序值。<br> 开窗函数一般就是说的是over()函数，其窗口是由一个 OVER 子句 定义的多行记录<br> 开窗函数一般分为两类,聚合开窗函数和排序开窗函数。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 聚合格式</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>字段名<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 字段名<span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">order</span> <span class="token keyword">by</span> 字段名<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 别名<span class="token punctuation">,</span>
	<span class="token function">max</span><span class="token punctuation">(</span>字段名<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 别名 
<span class="token keyword">from</span> 表名<span class="token punctuation">;</span>

<span class="token comment">-- 排序窗口格式</span>
<span class="token keyword">select</span> rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">partition</span> <span class="token keyword">by</span> 字段名<span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">order</span> <span class="token keyword">by</span> 字段名<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 别名 <span class="token keyword">from</span> 表名<span class="token punctuation">;</span>
</code></pre> 
<p><strong>注意点：</strong></p> 
<ul><li>over()函数中的分区、排序、指定窗口范围可组合使用也可以不指定，根据不同的业务需求结合使用</li><li>over()函数中如果不指定分区，窗口大小是针对查询产生的所有数据，如果指定了分区，窗口大小是针对每个分区的数据</li></ul> 
<blockquote> 
 <p>测试数据</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t_fraction<span class="token punctuation">(</span>
name string<span class="token punctuation">,</span>
subject string<span class="token punctuation">,</span> 
score <span class="token keyword">int</span><span class="token punctuation">)</span> 
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">","</span>
<span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>

<span class="token comment">-- 测试数据 fraction.txt</span>
孙悟空<span class="token punctuation">,</span>语文<span class="token punctuation">,</span><span class="token number">10</span>
孙悟空<span class="token punctuation">,</span>数学<span class="token punctuation">,</span><span class="token number">73</span>
孙悟空<span class="token punctuation">,</span>英语<span class="token punctuation">,</span><span class="token number">15</span>
猪八戒<span class="token punctuation">,</span>语文<span class="token punctuation">,</span><span class="token number">10</span>
猪八戒<span class="token punctuation">,</span>数学<span class="token punctuation">,</span><span class="token number">73</span>
猪八戒<span class="token punctuation">,</span>英语<span class="token punctuation">,</span><span class="token number">11</span>
沙悟净<span class="token punctuation">,</span>语文<span class="token punctuation">,</span><span class="token number">22</span>
沙悟净<span class="token punctuation">,</span>数学<span class="token punctuation">,</span><span class="token number">70</span>
沙悟净<span class="token punctuation">,</span>英语<span class="token punctuation">,</span><span class="token number">31</span>
唐玄奘<span class="token punctuation">,</span>语文<span class="token punctuation">,</span><span class="token number">21</span>
唐玄奘<span class="token punctuation">,</span>数学<span class="token punctuation">,</span><span class="token number">81</span>
唐玄奘<span class="token punctuation">,</span>英语<span class="token punctuation">,</span><span class="token number">23</span>

<span class="token comment">-- 上传数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/usr/local/soft/bigdata17/xiaohu/data/fraction.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> t_fraction<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="371%09_1799"></a>3.7.1、 聚合开窗函数</h4> 
<blockquote> 
 <p>sum(求和)</p> 
 <p>min(最小)</p> 
 <p>max(最大)</p> 
 <p>avg(平均值)</p> 
 <p>count(计数)</p> 
 <p>lag(获取当前行上一行的数据）</p> 
 <p>lead(获取当前行下一行的数据）</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- </span>
<span class="token keyword">select</span> name<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>score<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sumover <span class="token keyword">from</span> t_fraction<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+----------+--------+----------+</span>
<span class="token operator">|</span> name  <span class="token operator">|</span> subject  <span class="token operator">|</span> score  <span class="token operator">|</span> sumover  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+--------+----------+</span>
<span class="token operator">|</span> 唐玄奘   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">23</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 唐玄奘   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">81</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 唐玄奘   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">21</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 沙悟净   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">31</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 沙悟净   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">12</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 沙悟净   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">22</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 猪八戒   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">11</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 猪八戒   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">73</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 猪八戒   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">10</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 孙悟空   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">15</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 孙悟空   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">12</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">|</span> 孙悟空   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">10</span>     <span class="token operator">|</span> <span class="token number">321</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+--------+----------+</span>

<span class="token keyword">select</span> name<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum1<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject<span class="token punctuation">)</span> <span class="token keyword">as</span> sum2<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> sum3<span class="token punctuation">,</span> 

<span class="token comment">-- 由起点到当前行的窗口聚合，和sum3一样</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum4<span class="token punctuation">,</span> 

<span class="token comment">-- 当前行和前面一行的窗口聚合</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">1</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum5<span class="token punctuation">,</span>

<span class="token comment">-- 当前行的前面一行到后面一行的窗口聚合  前一行+当前行+后一行</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">1</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token number">1</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum6<span class="token punctuation">,</span>

<span class="token comment">-- 当前行与后一行之和</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">current</span> <span class="token keyword">row</span> <span class="token operator">and</span> <span class="token number">1</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum6<span class="token punctuation">,</span>

<span class="token comment">-- 当前和后面所有的行</span>
<span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">current</span> <span class="token keyword">row</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum7
<span class="token keyword">from</span> t_fraction<span class="token punctuation">;</span>

<span class="token keyword">rows</span>：行
<span class="token keyword">unbounded</span> <span class="token keyword">preceding</span>：起点
<span class="token keyword">unbounded</span> <span class="token keyword">following</span>：终点
n <span class="token keyword">preceding</span>：前 n 行
n <span class="token keyword">following</span>：后 n 行
<span class="token keyword">current</span> <span class="token keyword">row</span>：当前行


<span class="token operator">+</span><span class="token comment">-------+----------+--------+-------+-------+-------+-------+-------+-------+-------+</span>
<span class="token operator">|</span> name  <span class="token operator">|</span> subject  <span class="token operator">|</span> score  <span class="token operator">|</span> sum1  <span class="token operator">|</span> sum2  <span class="token operator">|</span> sum3  <span class="token operator">|</span> sum4  <span class="token operator">|</span> sum5  <span class="token operator">|</span> sum6  <span class="token operator">|</span> sum7  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+--------+-------+-------+-------+-------+-------+-------+-------+</span>
<span class="token operator">|</span> 孙悟空   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">12</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span> <span class="token number">12</span>    <span class="token operator">|</span> <span class="token number">12</span>    <span class="token operator">|</span> <span class="token number">12</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span>
<span class="token operator">|</span> 沙悟净   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">19</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">104</span>   <span class="token operator">|</span> <span class="token number">173</span>   <span class="token operator">|</span>
<span class="token operator">|</span> 猪八戒   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">73</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span> <span class="token number">104</span>   <span class="token operator">|</span> <span class="token number">104</span>   <span class="token operator">|</span> <span class="token number">92</span>    <span class="token operator">|</span> <span class="token number">173</span>   <span class="token operator">|</span> <span class="token number">154</span>   <span class="token operator">|</span>
<span class="token operator">|</span> 唐玄奘   <span class="token operator">|</span> 数学       <span class="token operator">|</span> <span class="token number">81</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span> <span class="token number">185</span>   <span class="token operator">|</span> <span class="token number">154</span>   <span class="token operator">|</span> <span class="token number">154</span>   <span class="token operator">|</span> <span class="token number">81</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 猪八戒   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">11</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span> <span class="token number">11</span>    <span class="token operator">|</span> <span class="token number">11</span>    <span class="token operator">|</span> <span class="token number">11</span>    <span class="token operator">|</span> <span class="token number">26</span>    <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 孙悟空   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">15</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span> <span class="token number">26</span>    <span class="token operator">|</span> <span class="token number">26</span>    <span class="token operator">|</span> <span class="token number">26</span>    <span class="token operator">|</span> <span class="token number">49</span>    <span class="token operator">|</span> <span class="token number">69</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 唐玄奘   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">23</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span> <span class="token number">49</span>    <span class="token operator">|</span> <span class="token number">49</span>    <span class="token operator">|</span> <span class="token number">38</span>    <span class="token operator">|</span> <span class="token number">69</span>    <span class="token operator">|</span> <span class="token number">54</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 沙悟净   <span class="token operator">|</span> 英语       <span class="token operator">|</span> <span class="token number">31</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span> <span class="token number">80</span>    <span class="token operator">|</span> <span class="token number">54</span>    <span class="token operator">|</span> <span class="token number">54</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 孙悟空   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">10</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span> <span class="token number">10</span>    <span class="token operator">|</span> <span class="token number">10</span>    <span class="token operator">|</span> <span class="token number">10</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 唐玄奘   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">21</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">31</span>    <span class="token operator">|</span> <span class="token number">53</span>    <span class="token operator">|</span> <span class="token number">84</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 沙悟净   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">22</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span> <span class="token number">53</span>    <span class="token operator">|</span> <span class="token number">53</span>    <span class="token operator">|</span> <span class="token number">43</span>    <span class="token operator">|</span> <span class="token number">84</span>    <span class="token operator">|</span> <span class="token number">63</span>    <span class="token operator">|</span>
<span class="token operator">|</span> 猪八戒   <span class="token operator">|</span> 语文       <span class="token operator">|</span> <span class="token number">41</span>     <span class="token operator">|</span> <span class="token number">359</span>   <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span> <span class="token number">94</span>    <span class="token operator">|</span> <span class="token number">63</span>    <span class="token operator">|</span> <span class="token number">63</span>    <span class="token operator">|</span> <span class="token number">41</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+--------+-------+-------+-------+-------+-------+-------+-------+</span>
</code></pre> 
<p><strong>rows必须跟在Order by 子句之后，对排序的结果进行限制，使用固定的行数来限制分区中的数据行数量。</strong></p> 
<blockquote> 
 <p>**OVER()：**指定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变而变化。</p> 
 <p>**CURRENT ROW：**当前行</p> 
 <p>**n PRECEDING：**往前n行数据</p> 
 <p>**n FOLLOWING：**往后n行数据</p> 
 <p>**UNBOUNDED：**起点，UNBOUNDED PRECEDING 表示从前面的起点， UNBOUNDED FOLLOWING表示到后面的终点</p> 
 <p>**LAG(col,n,default_val)：**往前第n行数据，col是列名，n是往上的行数，当第n行为null的时候取default_val</p> 
 <p>**LEAD(col,n, default_val)：**往后第n行数据，col是列名，n是往下的行数，当第n行为null的时候取default_val</p> 
 <p>**NTILE(n)：**把有序分区中的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号。</p> 
 <p><strong>cume_dist（）</strong>，计算某个窗口或分区中某个值的累积分布。假定升序排序，则使用以下公式确定累积分布：</p> 
 <p>​ 小于等于当前值x的行数 / 窗口或partition分区内的总行数。其中，x 等于 order by 子句中指定的列的当前行中的值。</p> 
</blockquote> 
<h6><a id="_1904"></a>聚合开窗函数实战：</h6> 
<h6><a id="1Hive_1906"></a>实战1：Hive用户购买明细数据分析</h6> 
<blockquote> 
 <p>创建表和加载数据</p> 
</blockquote> 
<pre><code class="prism language-sql">name，orderdate，cost
jack<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">,</span><span class="token number">10</span>
tony<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span><span class="token punctuation">,</span><span class="token number">15</span>
jack<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">03</span><span class="token punctuation">,</span><span class="token number">23</span>
tony<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">04</span><span class="token punctuation">,</span><span class="token number">29</span>
jack<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span><span class="token punctuation">,</span><span class="token number">46</span>
jack<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span><span class="token punctuation">,</span><span class="token number">42</span>
tony<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">07</span><span class="token punctuation">,</span><span class="token number">50</span>
jack<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">55</span>
mart<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span><span class="token punctuation">,</span><span class="token number">62</span>
mart<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span><span class="token punctuation">,</span><span class="token number">68</span>
neil<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">12</span>
mart<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">75</span>
neil<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">80</span>
mart<span class="token punctuation">,</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">94</span>


建表加载数据
vim business<span class="token punctuation">.</span>txt

<span class="token keyword">create</span> <span class="token keyword">table</span> business
<span class="token punctuation">(</span>
name string<span class="token punctuation">,</span> 
orderdate string<span class="token punctuation">,</span>
cost <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">','</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">"/shujia/bigdata17/xiaohu/data/business.txt"</span> <span class="token keyword">into</span> <span class="token keyword">table</span> business<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="1_1941"></a>实战1需求：</h6> 
<blockquote> 
 <p>需求1：查询在2017年4月份购买过的顾客及总人数</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment"># 分析：按照日期过滤、分组count求总人数</span>
<span class="token keyword">select</span> t1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>orderdate<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> counts_04 <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span>orderdate <span class="token keyword">from</span> business <span class="token keyword">where</span> <span class="token keyword">month</span><span class="token punctuation">(</span>orderdate<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'04'</span><span class="token punctuation">)</span> t1<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>需求2：查询顾客的购买明细及月购买总额</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment"># 分析：按照顾客分组、sum购买金额</span>
<span class="token keyword">select</span> name<span class="token punctuation">,</span>orderdate<span class="token punctuation">,</span>cost<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name<span class="token punctuation">,</span><span class="token keyword">month</span><span class="token punctuation">(</span>orderdate<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">from</span> business<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>需求3：上述的场景,要将cost按照日期进行累加</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment"># 分析：按照顾客分组、日期升序排序、组内每条数据将之前的金额累加</span>
<span class="token keyword">select</span> name<span class="token punctuation">,</span>orderdate<span class="token punctuation">,</span>cost<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name <span class="token keyword">order</span> <span class="token keyword">by</span> orderdate <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span>  <span class="token keyword">from</span> business<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>需求4：查询顾客上次的购买时间</p> 
</blockquote> 
<pre><code class="prism language-sql">·<span class="token comment"># 分析：查询出明细数据同时获取上一条数据的购买时间(肯定需要按照顾客分组、时间升序排序)</span>
<span class="token keyword">select</span> name<span class="token punctuation">,</span>orderdate<span class="token punctuation">,</span>cost<span class="token punctuation">,</span>lag<span class="token punctuation">(</span>orderdate<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name <span class="token keyword">order</span> <span class="token keyword">by</span> orderdate<span class="token punctuation">)</span> <span class="token keyword">as</span> last_time <span class="token keyword">from</span> business<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>需求5：查询前20%时间的订单信息</p> 
</blockquote> 
<pre><code class="prism language-sql">分析：按照日期升序排序、取前<span class="token number">20</span><span class="token operator">%</span>的数据
<span class="token keyword">select</span> t1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>orderdate<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>cost <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span>orderdate<span class="token punctuation">,</span>cost<span class="token punctuation">,</span>ntile<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> orderdate<span class="token punctuation">)</span> <span class="token keyword">as</span> n <span class="token keyword">from</span> business<span class="token punctuation">)</span> t1 <span class="token keyword">where</span> t1<span class="token punctuation">.</span>n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="372%09_1978"></a>3.7.2、 排序开窗函数(重点)</h4> 
<ul><li>RANK() 排序相同时会重复，总数不会变</li><li>DENSE_RANK() 排序相同时会重复，总数会减少</li><li>ROW_NUMBER() 会根据顺序计算</li><li>PERCENT_RANK()计算给定行的百分比排名。可以用来计算超过了百分之多少的人(当前行的rank值-1)/(分组内的总行数-1)</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> name<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>
score<span class="token punctuation">,</span>
rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rp<span class="token punctuation">,</span>
dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> drp<span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rnp<span class="token punctuation">,</span>
percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> percent_rank 
<span class="token keyword">from</span> t_fraction<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> name<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> row_number<span class="token punctuation">,</span>
percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score<span class="token punctuation">)</span> <span class="token keyword">as</span> percent_rank
<span class="token keyword">from</span> t_fraction<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="2Hive_2004"></a>实战2：Hive分析学生成绩信息</h6> 
<blockquote> 
 <p>创建表语加载数据</p> 
</blockquote> 
<pre><code class="prism language-sql">name	subject	score
李毅	语文	<span class="token number">87</span>
李毅	数学	<span class="token number">95</span>
李毅	英语	<span class="token number">68</span>
黄仙	语文	<span class="token number">94</span>
黄仙	数学	<span class="token number">56</span>
黄仙	英语	<span class="token number">84</span>
小虎	语文	<span class="token number">64</span>
小虎	数学	<span class="token number">86</span>
小虎	英语	<span class="token number">84</span>
许文客	语文	<span class="token number">65</span>
许文客	数学	<span class="token number">85</span>
许文客	英语	<span class="token number">78</span>

建表加载数据
vim score<span class="token punctuation">.</span>txt

<span class="token keyword">create</span> <span class="token keyword">table</span> score2
<span class="token punctuation">(</span>
name string<span class="token punctuation">,</span>
subject string<span class="token punctuation">,</span> 
score <span class="token keyword">int</span>
<span class="token punctuation">)</span> <span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>

<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/shujia/bigdata17/xiaohu/data/score.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> score<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>需求1：每门学科学生成绩排名(是否并列排名、空位排名三种实现)</p> 
</blockquote> 
<pre><code class="prism language-sql">分析：学科分组、成绩降序排序、按照成绩排名

<span class="token keyword">select</span> name<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>score<span class="token punctuation">,</span>
rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rp<span class="token punctuation">,</span>
dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> drp<span class="token punctuation">,</span>
row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> rmp
<span class="token keyword">from</span> 
score<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>需求2：每门学科成绩排名top 2的学生</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> t1<span class="token punctuation">.</span>name<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>subject<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>score <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span>subject<span class="token punctuation">,</span>score<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> subject <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> score2<span class="token punctuation">)</span> t1 <span class="token keyword">where</span> t1<span class="token punctuation">.</span>rn<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="4Hive__2057"></a>4、Hive 行转列</h2> 
<p>lateral view explode</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> testArray2<span class="token punctuation">(</span>
    name string<span class="token punctuation">,</span>
    weight array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited 
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span>
COLLECTION ITEMS <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>

小虎	<span class="token string">"150"</span><span class="token punctuation">,</span><span class="token string">"170"</span><span class="token punctuation">,</span><span class="token string">"180"</span>
火火	<span class="token string">"150"</span><span class="token punctuation">,</span><span class="token string">"180"</span><span class="token punctuation">,</span><span class="token string">"190"</span>



<span class="token keyword">select</span> name<span class="token punctuation">,</span>col1  <span class="token keyword">from</span> testarray2 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>weight<span class="token punctuation">)</span> t1 <span class="token keyword">as</span> col1<span class="token punctuation">;</span>

小虎	<span class="token number">150</span>
小虎	<span class="token number">170</span>
小虎	<span class="token number">180</span>
火火	<span class="token number">150</span>
火火	<span class="token number">180</span>
火火	<span class="token number">190</span>

<span class="token keyword">select</span> <span class="token keyword">key</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> explode<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">'key1'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'key2'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'key3'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">key</span><span class="token punctuation">,</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span>

key1
key2
key3

<span class="token keyword">select</span> name<span class="token punctuation">,</span>col1<span class="token punctuation">,</span>col2  <span class="token keyword">from</span> testarray2 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">'key1'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'key2'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'key3'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> t1 <span class="token keyword">as</span> col1<span class="token punctuation">,</span>col2<span class="token punctuation">;</span>
小虎	key1	<span class="token number">1</span>
小虎	key2	<span class="token number">2</span>
小虎	key3	<span class="token number">3</span>
火火	key1	<span class="token number">1</span>
火火	key2	<span class="token number">2</span>
火火	key3	<span class="token number">3</span>


<span class="token keyword">select</span> name<span class="token punctuation">,</span>pos<span class="token punctuation">,</span>col1  <span class="token keyword">from</span> testarray2 lateral <span class="token keyword">view</span> posexplode<span class="token punctuation">(</span>weight<span class="token punctuation">)</span> t1 <span class="token keyword">as</span> pos<span class="token punctuation">,</span>col1<span class="token punctuation">;</span>

小虎	<span class="token number">0</span>	<span class="token number">150</span>
小虎	<span class="token number">1</span>	<span class="token number">170</span>
小虎	<span class="token number">2</span>	<span class="token number">180</span>
火火	<span class="token number">0</span>	<span class="token number">150</span>
火火	<span class="token number">1</span>	<span class="token number">180</span>
火火	<span class="token number">2</span>	<span class="token number">190</span>
</code></pre> 
<h2><a id="5Hive__2108"></a>5、Hive 列转行</h2> 
<pre><code class="prism language-sql"><span class="token comment">// testLieToLine</span>
name col1
小虎	<span class="token number">150</span>
小虎	<span class="token number">170</span>
小虎	<span class="token number">180</span>
火火	<span class="token number">150</span>
火火	<span class="token number">180</span>
火火	<span class="token number">190</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> testLieToLine<span class="token punctuation">(</span>
    name string<span class="token punctuation">,</span>
    col1 <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited 
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>


<span class="token keyword">select</span> name<span class="token punctuation">,</span>collect_list<span class="token punctuation">(</span>col1<span class="token punctuation">)</span> <span class="token keyword">from</span> testLieToLine <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">;</span>

<span class="token comment">// 结果</span>
小虎	<span class="token punctuation">[</span><span class="token string">"150"</span><span class="token punctuation">,</span><span class="token string">"180"</span><span class="token punctuation">,</span><span class="token string">"190"</span><span class="token punctuation">]</span>
火火	<span class="token punctuation">[</span><span class="token string">"150"</span><span class="token punctuation">,</span><span class="token string">"170"</span><span class="token punctuation">,</span><span class="token string">"180"</span><span class="token punctuation">]</span>

<span class="token keyword">select</span>  t1<span class="token punctuation">.</span>name
        <span class="token punctuation">,</span>collect_list<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>col1<span class="token punctuation">)</span> 
<span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>  name
            <span class="token punctuation">,</span>col1 
    <span class="token keyword">from</span> testarray2 
    lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>weight<span class="token punctuation">)</span> t1 <span class="token keyword">as</span> col1
<span class="token punctuation">)</span> t1 <span class="token keyword">group</span> <span class="token keyword">by</span> t1<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="6HiveUserDefineFunction_2143"></a>6、Hive自定义函数UserDefineFunction</h2> 
<h3><a id="61UDF_2145"></a>6.1、UDF：一进一出</h3> 
<blockquote> 
 <p>定义UDF函数要注意下面几点:</p> 
 <ol><li>继承<code>org.apache.hadoop.hive.ql.exec.UDF</code></li><li>重写<code>evaluate</code>()，这个方法不是由接口定义的,因为它可接受的参数的个数,数据类型都是不确定的。Hive会检查UDF,看能否找到和函数调用相匹配的evaluate()方法</li></ol> 
</blockquote> 
<ul><li>创建maven项目，并加入依赖</li></ul> 
<pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;
            &lt;artifactId&gt;hive-exec&lt;/artifactId&gt;
            &lt;version&gt;1.2.1&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre> 
<blockquote> 
 <p>打包的时候可能会出现错误</p> 
 <h4><a id="Could_not_transfer_artifact_orgpentahopentahoaggdesigneralgorithmpom515jhyde_2165"></a>Could not transfer artifact org.pentaho:pentaho-aggdesigner-algorithm:pom:5.1.5-jhyde</h4> 
</blockquote> 
<blockquote> 
 <p>解决方案：<br> <code>在pom文件中修改hive-exec的配置</code></p> 
</blockquote> 
<pre><code class="prism language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hive-exec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!--排除pentaho-aggdesigner-algorithm依赖，不将它引入--&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.pentaho<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>pentaho-aggdesigner-algorithm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>编写代码，继承org.apache.hadoop.hive.ql.exec.UDF，实现evaluate方法，在evaluate方法中实现自己的逻辑</li></ul> 
<pre><code class="prism language-java">
</code></pre> 
<ul><li>打成jar包并上传至Linux虚拟机</li><li>在hive shell中，使用 <code>add jar 路径</code>将jar包作为资源添加到hive环境中</li></ul> 
<pre><code>add jar /usr/local/soft/bigdata19/hive-bigdata19-1.0-SNAPSHOT.jar;
</code></pre> 
<ul><li>使用jar包资源注册一个临时函数，fxxx1是你的函数名，'MyUDF’是主类名</li></ul> 
<pre><code>create temporary function fxxx1 as 'MyUDF';
</code></pre> 
<ul><li>使用函数名处理数据</li></ul> 
<pre><code>select fxx1(name) as fxx_name from students limit 10;

#施笑槐$
#吕金鹏$
#单乐蕊$
#葛德曜$
#宣谷芹$
#边昂雄$
#尚孤风$
#符半双$
#沈德昌$
#羿彦昌$
</code></pre> 
<p><strong>案例2：转大写</strong></p> 
<pre><code class="prism language-java">
</code></pre> 
<h6><a id="_2228"></a>函数加载方式</h6> 
<blockquote> 
 <p>命令加载</p> 
 <p>这种加载只对本session有效</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 1、将项目打包上传服务器：将打好的jar包传到linux系统中。(不要打依赖)</span>
<span class="token comment"># 进入到hive客户端,执行下面命令</span>
hive<span class="token operator">&gt;</span> <span class="token function">add</span> jar /usr/local/soft/bigdata17/data/xiaohu/hadoop-mapreduce-1.0-SNAPSHOT.jar
<span class="token comment"># 2、创建一个临时函数名,要跟上面hive在同一个session里面：</span>
hive<span class="token operator">&gt;</span> create temporary <span class="token keyword">function</span> toUP as <span class="token string">'com.shujia.testHiveFun.udf.FirstUDF'</span><span class="token punctuation">;</span>

<span class="token number">3</span>、检查函数是否创建成功
show functions<span class="token punctuation">;</span>

<span class="token number">4</span>. 测试功能
<span class="token keyword">select</span> toUp<span class="token punctuation">(</span><span class="token string">'abcdef'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token number">5</span>. 删除函数 
drop temporary <span class="token keyword">function</span> <span class="token keyword">if</span> exists toUp<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>创建永久函数</strong></p> 
 <p>将jar上传HDFS：</p> 
</blockquote> 
<pre><code class="prism language-shell">hadoop fs <span class="token parameter variable">-put</span> hadoop-mapreduce-1.0-SNAPSHOT.jar /jar/
</code></pre> 
<blockquote> 
 <p>在hive命令行中创建永久函数：</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">function</span> myUp <span class="token keyword">as</span> <span class="token string">'com.shujia.testHiveFun.udf.FirstUDF'</span> <span class="token keyword">using</span> jar <span class="token string">'hdfs:/jar/hadoop-mapreduce-1.0-SNAPSHOT.jar'</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">function</span> bfy_fun <span class="token keyword">as</span> <span class="token string">'com.shujia.udfdemo.HiveTest'</span> <span class="token keyword">using</span> jar <span class="token string">'hdfs:/shujia/bigdata19/jar/hive-udf.jar'</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>退出hive，再进入，执行测试：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/df/ce/qMN5f1lm_o.png" alt="image-20220606011312030"></p> 
<p>删除永久函数，并检查：</p> 
<p><img src="https://images2.imgbox.com/86/c8/umyiVyzY_o.png" alt="image-20220606011343387"></p> 
<h3><a id="62UDTF_2275"></a>6.2、UDTF：一进多出</h3> 
<blockquote> 
 <p>UDTF是一对多的输入输出,实现UDTF需要完成下面步骤</p> 
 <p>M1001#xiaohu#S324231212,lkd#M1002#S2543412432,S21312312412#M1003#bfy</p> 
 <p>1001 xiaohu 324231212</p> 
 <p>1002 lkd 2543412432</p> 
 <p>1003 bfy 21312312412</p> 
 <p>继承org.apache.hadoop.hive.ql.udf.generic.GenericUDTF，<br> 重写initlizer（）、process（）、close()。<br> 执行流程如下:</p> 
 <p>UDTF首先会调用initialize方法，此方法返回UDTF的返回行的信息（返回个数，类型）。</p> 
 <p>初始化完成后，会调用process方法,真正的处理过程在process函数中，在process中，每一次forward()调用产生一行；<strong>如果产生多列可以将多个列的值放在一个数组中</strong>，然后将该数组传入到forward()函数。</p> 
 <p>最后close()方法调用，对需要清理的方法进行清理。</p> 
</blockquote> 
<blockquote> 
 <p>“key1:value1,key2:value2,key3:value3”</p> 
 <p>key1 value1</p> 
 <p>key2 value2</p> 
 <p>key3 value3</p> 
</blockquote> 
<h6><a id="_explodesplit_2307"></a>方法一：使用 explode+split</h6> 
<pre><code>
</code></pre> 
<h6><a id="UDTF_2313"></a>方法二：自定UDTF</h6> 
<ul><li>代码</li></ul> 
<pre><code class="prism language-sql">
</code></pre> 
<ul><li>SQL</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">temporary</span> <span class="token keyword">function</span> my_udtf <span class="token keyword">as</span> <span class="token string">'com.shujia.testHiveFun.udtf.HiveUDTF'</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> my_udtf<span class="token punctuation">(</span><span class="token string">"key1:value1,key2:value2,key3:value3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>字段：id,col1,col2,col3,col4,col5,col6,col7,col8,col9,col10,col11,col12 共13列</p> 
 <p>数据：</p> 
 <p>a,1,2,3,4,5,6,7,8,9,10,11,12</p> 
 <p>b,11,12,13,14,15,16,17,18,19,20,21,22</p> 
 <p>c,21,22,23,24,25,26,27,28,29,30,31,32</p> 
 <p>转成3列：id,hours,value</p> 
 <p>例如：</p> 
 <p>a,1,2,3,4,5,6,7,8,9,10,11,12</p> 
 <p>a,0时,1</p> 
 <p>a,2时,2</p> 
 <p>a,4时,3</p> 
 <p>a,6时,4</p> 
 <p>…</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> udtfData<span class="token punctuation">(</span>
    id string
    <span class="token punctuation">,</span>col1 string
    <span class="token punctuation">,</span>col2 string
    <span class="token punctuation">,</span>col3 string
    <span class="token punctuation">,</span>col4 string
    <span class="token punctuation">,</span>col5 string
    <span class="token punctuation">,</span>col6 string
    <span class="token punctuation">,</span>col7 string
    <span class="token punctuation">,</span>col8 string
    <span class="token punctuation">,</span>col9 string
    <span class="token punctuation">,</span>col10 string
    <span class="token punctuation">,</span>col11 string
    <span class="token punctuation">,</span>col12 string
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<p>代码：</p> 
<pre><code class="prism language-java">
</code></pre> 
<p>添加jar资源:</p> 
<pre><code>add jar /usr/local/soft/HiveUDF2-1.0.jar;
</code></pre> 
<p>注册udtf函数：</p> 
<pre><code>create temporary function my_udtf as 'MyUDTF';
</code></pre> 
<p>SQL:</p> 
<pre><code>select id,hours,value from udtfData lateral view my_udtf(col1,col2,col3,col4,col5,col6,col7,col8,col9,col10,col11,col12) t as hours,value ;
</code></pre> 
<h3><a id="63UDAF_2397"></a>6.3、UDAF：多进一出</h3> 
<h5><a id="Hive_Shell_2399"></a>Hive Shell</h5> 
<h6><a id="_2401"></a>第一种：</h6> 
<pre><code>hive -e "select * from test1.students limit 10"
</code></pre> 
<h6><a id="_2407"></a>第二种：</h6> 
<pre><code>hive -f hql文件路径
</code></pre> 
<blockquote> 
 <p>将HQL写在一个文件里，再使用 -f 参数指定该文件</p> 
</blockquote> 
<h5><a id="_2415"></a>连续登陆问题</h5> 
<blockquote> 
 <p>在电商、物流和银行可能经常会遇到这样的需求：统计用户连续交易的总额、连续登陆天数、连续登陆开始和结束时间、间隔天数等</p> 
</blockquote> 
<h6><a id="_2419"></a>数据：</h6> 
<blockquote> 
 <p>注意：每个用户每天可能会有多条记录</p> 
</blockquote> 
<pre><code>id	datestr	  amount
1,2019-02-08,6214.23 
1,2019-02-08,6247.32 
1,2019-02-09,85.63 
1,2019-02-09,967.36 
1,2019-02-10,85.69 
1,2019-02-12,769.85 
1,2019-02-13,943.86 
1,2019-02-14,538.42
1,2019-02-15,369.76
1,2019-02-16,369.76
1,2019-02-18,795.15
1,2019-02-19,715.65
1,2019-02-21,537.71
2,2019-02-08,6214.23 
2,2019-02-08,6247.32 
2,2019-02-09,85.63 
2,2019-02-09,967.36 
2,2019-02-10,85.69 
2,2019-02-12,769.85 
2,2019-02-13,943.86 
2,2019-02-14,943.18
2,2019-02-15,369.76
2,2019-02-18,795.15
2,2019-02-19,715.65
2,2019-02-21,537.71
3,2019-02-08,6214.23 
3,2019-02-08,6247.32 
3,2019-02-09,85.63 
3,2019-02-09,967.36 
3,2019-02-10,85.69 
3,2019-02-12,769.85 
3,2019-02-13,943.86 
3,2019-02-14,276.81
3,2019-02-15,369.76
3,2019-02-16,369.76
3,2019-02-18,795.15
3,2019-02-19,715.65
3,2019-02-21,537.71
</code></pre> 
<h6><a id="_2465"></a>建表语句</h6> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> deal_tb<span class="token punctuation">(</span>
    id string
    <span class="token punctuation">,</span>datestr string
    <span class="token punctuation">,</span>amount string
<span class="token punctuation">)</span><span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="_2475"></a>计算逻辑</h6> 
<ul><li>先按用户和日期分组求和，使每个用户每天只有一条数据</li></ul> 
<pre><code class="prism language-sql">
</code></pre> 
<ul><li> <p>根据用户ID分组按日期排序，将日期和分组序号相减得到连续登陆的开始日期，如果开始日期相同说明连续登陆</p> </li><li> <p><em>datediff(string end_date,string start_date);</em> 等于0说明连续登录</p> </li><li> <p>统计用户连续交易的总额、连续登陆天数、连续登陆开始和结束时间、间隔天数</p> </li></ul> 
<pre><code>
</code></pre> 
<ul><li>结果</li></ul> 
<pre><code>1	2019-02-07	13600.23	3	2019-02-08	2019-02-10 NULL
1	2019-02-08	2991.650	5	2019-02-12	2019-02-16	1
1	2019-02-09	1510.8		2	2019-02-18	2019-02-19	1
1	2019-02-10	537.71		1	2019-02-21	2019-02-21	1
2	2019-02-07	13600.23	3	2019-02-08	2019-02-10 NULL
2	2019-02-08	3026.649	4	2019-02-12	2019-02-15	1
2	2019-02-10	1510.8		2	2019-02-18	2019-02-19	2
2	2019-02-11	537.71		1	2019-02-21	2019-02-21	1
3	2019-02-07	13600.23	3	2019-02-08	2019-02-10 NULL
3	2019-02-08	2730.04		5	2019-02-12	2019-02-16	1
3	2019-02-09	1510.8		2	2019-02-18	2019-02-19	1
3	2019-02-10	537.71		1	2019-02-21	2019-02-21	1
</code></pre> 
<p>inated by ‘,’;</p> 
<pre><code>
代码：

```java

```

添加jar资源:

```
add jar /usr/local/soft/HiveUDF2-1.0.jar;
```

注册udtf函数：

```
create temporary function my_udtf as 'MyUDTF';
```

SQL:

```
select id,hours,value from udtfData lateral view my_udtf(col1,col2,col3,col4,col5,col6,col7,col8,col9,col10,col11,col12) t as hours,value ;
```

## 6.3、UDAF：多进一出

#### Hive Shell

##### 第一种：

```
hive -e "select * from test1.students limit 10"
```

##### 第二种：

```
hive -f hql文件路径
```

&gt; 将HQL写在一个文件里，再使用 -f 参数指定该文件

#### 连续登陆问题

&gt; 在电商、物流和银行可能经常会遇到这样的需求：统计用户连续交易的总额、连续登陆天数、连续登陆开始和结束时间、间隔天数等

##### 数据：

&gt; 注意：每个用户每天可能会有多条记录

```
id	datestr	  amount
1,2019-02-08,6214.23 
1,2019-02-08,6247.32 
1,2019-02-09,85.63 
1,2019-02-09,967.36 
1,2019-02-10,85.69 
1,2019-02-12,769.85 
1,2019-02-13,943.86 
1,2019-02-14,538.42
1,2019-02-15,369.76
1,2019-02-16,369.76
1,2019-02-18,795.15
1,2019-02-19,715.65
1,2019-02-21,537.71
2,2019-02-08,6214.23 
2,2019-02-08,6247.32 
2,2019-02-09,85.63 
2,2019-02-09,967.36 
2,2019-02-10,85.69 
2,2019-02-12,769.85 
2,2019-02-13,943.86 
2,2019-02-14,943.18
2,2019-02-15,369.76
2,2019-02-18,795.15
2,2019-02-19,715.65
2,2019-02-21,537.71
3,2019-02-08,6214.23 
3,2019-02-08,6247.32 
3,2019-02-09,85.63 
3,2019-02-09,967.36 
3,2019-02-10,85.69 
3,2019-02-12,769.85 
3,2019-02-13,943.86 
3,2019-02-14,276.81
3,2019-02-15,369.76
3,2019-02-16,369.76
3,2019-02-18,795.15
3,2019-02-19,715.65
3,2019-02-21,537.71
```

##### 建表语句

```sql
create table deal_tb(
    id string
    ,datestr string
    ,amount string
)row format delimited fields terminated by ',';
```

##### 计算逻辑

* 先按用户和日期分组求和，使每个用户每天只有一条数据

```sql

```



* 根据用户ID分组按日期排序，将日期和分组序号相减得到连续登陆的开始日期，如果开始日期相同说明连续登陆

* *datediff(string end_date,string start_date);* 等于0说明连续登录
* 统计用户连续交易的总额、连续登陆天数、连续登陆开始和结束时间、间隔天数

```

```



* 结果

```
1	2019-02-07	13600.23	3	2019-02-08	2019-02-10 NULL
1	2019-02-08	2991.650	5	2019-02-12	2019-02-16	1
1	2019-02-09	1510.8		2	2019-02-18	2019-02-19	1
1	2019-02-10	537.71		1	2019-02-21	2019-02-21	1
2	2019-02-07	13600.23	3	2019-02-08	2019-02-10 NULL
2	2019-02-08	3026.649	4	2019-02-12	2019-02-15	1
2	2019-02-10	1510.8		2	2019-02-18	2019-02-19	2
2	2019-02-11	537.71		1	2019-02-21	2019-02-21	1
3	2019-02-07	13600.23	3	2019-02-08	2019-02-10 NULL
3	2019-02-08	2730.04		5	2019-02-12	2019-02-16	1
3	2019-02-09	1510.8		2	2019-02-18	2019-02-19	1
3	2019-02-10	537.71		1	2019-02-21	2019-02-21	1
```

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f2621c5918494902900ea7797103dd0c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">奇怪的Excel单元格字体颜色格式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/16012fa681065156c2c023e8a5b84336/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;】透析类和对象（上）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>