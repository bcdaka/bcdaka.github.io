<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据库异常数据恢复（1）-快速恢复和镜像恢复 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/02150e6ffa91be0196c0e1572c59326e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="数据库异常数据恢复（1）-快速恢复和镜像恢复">
  <meta property="og:description" content="(一) 数据库服务器的崩溃和恢复 1. 服务器的修复机制 数据库因为某些原因导致数据库突然异常donw机，为了保证数据库的使用，提供了一些机制进行数据库的恢复
快速恢复：数据库异常down机后重启数据库自己的恢复方式，人工无法干预备份文件恢复：手动进行恢复的方式磁盘镜像和数据复制：都是一种灾备方式，从一定程度上可以机器自主反应保证应用的运行 镜像：两个chunk，一个为主chunk，一个为镜像chunk，主chunk出现问题，会启用镜像chunk，在一定程度上可保证应用的运行数据复制：集群灾备 2. 数据库服务武器崩溃的类型和修复方式 系统崩溃：因为电源或其他原因导致机器donw机，重启计算机后，数据库会通过快速恢复的机制，自动恢复磁盘崩溃：当包含数据库服务器的磁盘因为某些原因不能使用，针对这种，由于数据存放在磁盘中，只能通过备份文件恢复的方式进行恢复机器失败：如果是整个系统失败了，数据复制（HDR或RSS）提供的第二个数据库实例可以马上作为备份系统使用 (二) 数据库异常down机的表现方式和快速恢复 1. 数据库正常关闭和异常崩溃的差异 正常关闭 数据库正常关闭的情况下，最后一次操作是checkpointcheckpoint之后物理日志会被清空逻辑日志最后一条是checkpoint消息日志包含了关闭数据库的时间 异常崩溃 异常关闭的数据库没有执行checkpoint物理日志没有情况逻辑日志最后一条不是checkpoint消息日志没有关闭数据库时间且数据库异常崩溃，可能会有断裂块的情况产生 2. 快速恢复概述 快速恢复是数据库的一种特性，不能被认为干预，不能被关闭快速恢复只适合系统方面的异常崩溃，磁盘不可用的情况无法使用异常崩溃恢复快速恢复的目标有三个 物理日志恢复：恢复到最近的检查点时间，达到物理日志恢复逻辑日志恢复：通过逻辑日志恢复到最近的逻辑一致状态事务回滚：回滚崩溃时没有完成的事务 3. 快速恢复的步骤 物理日志恢复： 由于异常关闭没有清空物理日志，所以将物理日志的内容读取到缓冲池内，清页线索会将内容刷新到磁盘中，刷到磁盘是为了避免出现异常down机前数据更新后脏块刷入了磁盘，但是物理日志未刷新的情况。刷新磁盘可以将磁盘的数据恢复到最后一个检查点时的状态如果物理日志中没有数据，则表示第一步已经完成 逻辑日志前滚恢复到最近的逻辑性一致状态 找到逻辑日志的最后一个checkpoint前滚最后一个checkpoint之后的所有操作记录 回滚没有递交的事务或者系统失败时没有完成的事务 回滚在逻辑日志中没有commit和rollback work配对的事务这样保证数据库内不会留下那些失败没有完成的事务 4. 快速恢复对记录日志开启缓冲和不记录日志两种数据库的差异 数据库开启了日志缓冲：由于数据库开启了缓冲，可能出现日志没有刷新到逻辑日志文件中，但是还存在日志缓冲区的情况 这种情况下：还在逻辑日志缓冲区的事务将丢失针对开启了日志缓冲的数据库，快速恢复无法保证完全恢复 不记录日志的数据库：不会将数据库的操作记录保存记录到逻辑日志中 其最后一次检查点之后的所有事务和操作都丢失 5. 快速恢复后消息日志中的记录 第一步恢复之后记录Physical Recovery Complete的信息第二步恢复之后记录Logical Recovery Complete的信息还会记录提交了多少事务、回滚的事务、仍然打开的锁的当前数量onlog可以详细分析 (三) 镜像崩溃和恢复 1. 镜像情况下主primary chunk和镜像Mchunk的状态 [gbasedbt@iZ2ze2nmdlhki0ezcrioayZ node4_dbs]$ onstat -d Your evaluation license will expire on 2025-03-15 00:00:00 On-Line -- Up 00:02:01 -- 676080 Kbytes Dbspaces address number flags fchunk nchunks pgsize flags owner name 472a8028 1 0x70002 1 1 2048 M BA gbasedbt rootdbs 4a899888 2 0x60001 2 1 2048 N BA gbasedbt llogdbs 4a899ab8 3 0x70001 3 1 2048 N BA gbasedbt plogdbs 4a899ce8 4 0x68001 4 1 2048 N SBA gbasedbt sbspace1 4a9b7028 5 0x42001 5 1 16384 N TBA gbasedbt tmpdbs1 4a9b7258 6 0x60001 6 1 16384 N BA gbasedbt datadbs1 4add9028 7 0x60002 7 1 16384 M BA gbasedbt db1dbs 7 active, 2047 maximum Chunks address chunk/dbs offset size free bpages flags pathname 472a8258 1 1 0 102400 86165 PO-B-D /home/gbasedbt/gbase/node4_dbs/rootdbs 472a9028 1 1 0 102400 0 MD-B-- /home/gbasedbt/gbase/node4_dbs/rootdbs_mirror 4a9b7488 2 2 0 51200 1147 PO-B-D /home/gbasedbt/gbase/node4_dbs/llogdbs 4a9b9028 3 3 0 51200 1447 PO-B-D /home/gbasedbt/gbase/node4_dbs/plogdbs 4a9ba028 4 4 0 51200 47678 47678 POSB-D /home/gbasedbt/gbase/node4_dbs/sbspace1 Metadata 3469 2581 3469 4a9bb028 5 5 0 6400 6347 PO-B-- /home/gbasedbt/gbase/node4_dbs/tmpdbs1 4a9bc028 6 6 0 64000 63413 PO-BED /home/gbasedbt/gbase/node4_dbs/datadbs1_1 4add9258 7 7 0 6250 6197 PO-B-D /home/gbasedbt/gbase/node4_dbs/db1 4ab5c028 7 7 75000 6250 0 MO-B-D /home/gbasedbt/gbase/node4_dbs/db1_mirror 7 active, 32766 maximum NOTE: The values in the &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-19T20:57:58+08:00">
    <meta property="article:modified_time" content="2024-06-19T20:57:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据库异常数据恢复（1）-快速恢复和镜像恢复</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 id="bEd97">(一) 数据库服务器的崩溃和恢复</h3> 
<h4 id="gSTqJ">1. 服务器的修复机制</h4> 
<p id="uda302ea4">数据库因为某些原因导致数据库突然异常donw机，为了保证数据库的使用，提供了一些机制进行数据库的恢复</p> 
<ul><li id="u3e66f5d1">快速恢复：数据库异常down机后重启数据库自己的恢复方式，人工无法干预</li><li id="ubdf68814">备份文件恢复：手动进行恢复的方式</li><li id="u361c1255">磁盘镜像和数据复制：都是一种灾备方式，从一定程度上可以机器自主反应保证应用的运行</li></ul> 
<ul><li> 
  <ul><li id="u91f78267">镜像：两个chunk，一个为主chunk，一个为镜像chunk，主chunk出现问题，会启用镜像chunk，在一定程度上可保证应用的运行</li><li id="ufcdaec3e">数据复制：集群灾备</li></ul></li></ul> 
<h4 id="R8cGo">2. 数据库服务武器崩溃的类型和修复方式</h4> 
<ul><li id="ue5698e7d">系统崩溃：因为电源或其他原因导致机器donw机，重启计算机后，数据库会通过快速恢复的机制，自动恢复</li><li id="ua7a49422">磁盘崩溃：当包含数据库服务器的磁盘因为某些原因不能使用，针对这种，由于数据存放在磁盘中，只能通过备份文件恢复的方式进行恢复</li><li id="u1168b614">机器失败：如果是整个系统失败了，数据复制（HDR或RSS）提供的第二个数据库实例可以马上作为备份系统使用</li></ul> 
<p id="ue218871e"></p> 
<h3 id="Y0sj5">(二) 数据库异常down机的表现方式和快速恢复</h3> 
<h4 id="SHRsK">1. 数据库正常关闭和异常崩溃的差异</h4> 
<ul><li id="u3a8b19d5">正常关闭</li></ul> 
<ul><li> 
  <ul><li id="uda9f03fa">数据库正常关闭的情况下，最后一次操作是checkpoint</li><li id="uaa3078f2">checkpoint之后物理日志会被清空</li><li id="ub26a96b3">逻辑日志最后一条是checkpoint</li><li id="u3de9436f">消息日志包含了关闭数据库的时间</li></ul></li></ul> 
<ul><li id="ue1117619">异常崩溃</li></ul> 
<ul><li> 
  <ul><li id="uda296466">异常关闭的数据库没有执行checkpoint</li><li id="u7304a31e">物理日志没有情况</li><li id="ue69b8fef">逻辑日志最后一条不是checkpoint</li><li id="u0e787492">消息日志没有关闭数据库时间</li><li id="ua26ee500">且数据库异常崩溃，可能会有断裂块的情况产生</li></ul></li></ul> 
<h4 id="VKfoQ">2. 快速恢复概述</h4> 
<ul><li id="u2e4bb480">快速恢复是数据库的一种特性，不能被认为干预，不能被关闭</li><li id="uc20c6c35">快速恢复只适合系统方面的异常崩溃，磁盘不可用的情况无法使用异常崩溃恢复</li><li id="u796d6229">快速恢复的目标有三个</li></ul> 
<ul><li> 
  <ul><li id="u4837a588">物理日志恢复：恢复到最近的检查点时间，达到物理日志恢复</li><li id="ua34be284">逻辑日志恢复：通过逻辑日志恢复到最近的逻辑一致状态</li><li id="ue75e8426">事务回滚：回滚崩溃时没有完成的事务</li></ul></li></ul> 
<h4 id="XwsMR">3. 快速恢复的步骤</h4> 
<ul><li id="uc5129e1c">物理日志恢复：</li></ul> 
<ul><li> 
  <ul><li id="u07c812fb">由于异常关闭没有清空物理日志，所以将物理日志的内容读取到缓冲池内，清页线索会将内容刷新到磁盘中，刷到磁盘是为了避免出现异常down机前数据更新后脏块刷入了磁盘，但是物理日志未刷新的情况。刷新磁盘可以将磁盘的数据恢复到最后一个检查点时的状态</li><li id="u981c2567">如果物理日志中没有数据，则表示第一步已经完成</li></ul></li></ul> 
<ul><li id="u6ef454f5">逻辑日志前滚恢复到最近的逻辑性一致状态</li></ul> 
<ul><li> 
  <ul><li id="u6eb79550">找到逻辑日志的最后一个checkpoint</li><li id="ub8b913a6">前滚最后一个checkpoint之后的所有操作记录</li></ul></li></ul> 
<ul><li id="u2629d8a0">回滚没有递交的事务或者系统失败时没有完成的事务</li></ul> 
<ul><li> 
  <ul><li id="u426c8897">回滚在逻辑日志中没有commit和rollback work配对的事务</li><li id="u0d940e08">这样保证数据库内不会留下那些失败没有完成的事务</li></ul></li></ul> 
<h4 id="ErJvk">4. 快速恢复对记录日志开启缓冲和不记录日志两种数据库的差异</h4> 
<ul><li id="ue01e2749">数据库开启了日志缓冲：由于数据库开启了缓冲，可能出现日志没有刷新到逻辑日志文件中，但是还存在日志缓冲区的情况</li></ul> 
<ul><li> 
  <ul><li id="u9f89b6e0">这种情况下：还在逻辑日志缓冲区的事务将丢失</li><li id="u1a6a3c2b">针对开启了日志缓冲的数据库，快速恢复无法保证完全恢复</li></ul></li></ul> 
<ul><li id="u892efab5">不记录日志的数据库：不会将数据库的操作记录保存记录到逻辑日志中</li></ul> 
<ul><li> 
  <ul><li id="u094d4429">其最后一次检查点之后的所有事务和操作都丢失</li></ul></li></ul> 
<h4 id="rNj9g">5. 快速恢复后消息日志中的记录</h4> 
<ul><li id="u9671b3fe">第一步恢复之后记录Physical Recovery Complete的信息</li><li id="u8022b16a">第二步恢复之后记录Logical Recovery Complete的信息</li><li id="u3a8fd1d3">还会记录提交了多少事务、回滚的事务、仍然打开的锁的当前数量</li><li id="u3f86778b">onlog可以详细分析</li></ul> 
<h3 id="S328O">(三) 镜像崩溃和恢复</h3> 
<h4 id="Ez2U4">1. 镜像情况下主primary chunk和镜像Mchunk的状态</h4> 
<pre id="Er7Ey"><code class="language-bash">
[gbasedbt@iZ2ze2nmdlhki0ezcrioayZ node4_dbs]$ onstat -d
Your evaluation license will expire on 2025-03-15 00:00:00
On-Line -- Up 00:02:01 -- 676080 Kbytes

Dbspaces
address          number   flags      fchunk   nchunks  pgsize   flags    owner    name
472a8028         1        0x70002    1        1        2048     M  BA    gbasedbt rootdbs
4a899888         2        0x60001    2        1        2048     N  BA    gbasedbt llogdbs
4a899ab8         3        0x70001    3        1        2048     N  BA    gbasedbt plogdbs
4a899ce8         4        0x68001    4        1        2048     N SBA    gbasedbt sbspace1
4a9b7028         5        0x42001    5        1        16384    N TBA    gbasedbt tmpdbs1
4a9b7258         6        0x60001    6        1        16384    N  BA    gbasedbt datadbs1
4add9028         7        0x60002    7        1        16384    M  BA    gbasedbt db1dbs
 7 active, 2047 maximum

Chunks
address          chunk/dbs     offset     size       free       bpages     flags pathname
472a8258         1      1      0          102400     86165                 PO-B-D /home/gbasedbt/gbase/node4_dbs/rootdbs
472a9028         1      1      0          102400     0                     MD-B-- /home/gbasedbt/gbase/node4_dbs/rootdbs_mirror
4a9b7488         2      2      0          51200      1147                  PO-B-D /home/gbasedbt/gbase/node4_dbs/llogdbs
4a9b9028         3      3      0          51200      1447                  PO-B-D /home/gbasedbt/gbase/node4_dbs/plogdbs
4a9ba028         4      4      0          51200      47678      47678      POSB-D /home/gbasedbt/gbase/node4_dbs/sbspace1
                                 Metadata 3469       2581       3469
4a9bb028         5      5      0          6400       6347                  PO-B-- /home/gbasedbt/gbase/node4_dbs/tmpdbs1
4a9bc028         6      6      0          64000      63413                 PO-BED /home/gbasedbt/gbase/node4_dbs/datadbs1_1
4add9258         7      7      0          6250       6197                  PO-B-D /home/gbasedbt/gbase/node4_dbs/db1
4ab5c028         7      7      75000      6250       0                     MO-B-D /home/gbasedbt/gbase/node4_dbs/db1_mirror
 7 active, 32766 maximum

NOTE: The values in the "size" and "free" columns for DBspace chunks are
      displayed in terms of "pgsize" of the DBspace to which they belong.


Expanded chunk capacity mode: always
</code></pre> 
<ul><li id="u75d6d48e">镜像功能需要在数据库初始化时进行配置</li><li id="u9df11e9c">从上可以看出带有镜像功能的onstat -d和不带有镜像功能的onstat -d在flags列有着很大的差异</li><li id="u46acf89c">flags参数含义</li></ul> 
<ul><li> 
  <ul><li id="u039393c7">primary主chunk</li></ul></li></ul> 
<ul><li> 
  <ul><li> 
    <ul><li id="u70a29cc0">PO（Primary/Online）：在线</li><li id="ue7b26a77">PD（Primary/Down）：down机</li><li id="u40e75851">PR（Primary/Recovery）：正在从镜像恢复</li><li id="u100da6c3">PI（Primary/Inconsistent）：已经从镜像chunk恢复，但是没有逻辑恢复</li></ul></li></ul></li></ul> 
<ul><li> 
  <ul><li id="u3baafd9d">镜像chunk：</li></ul></li></ul> 
<ul><li> 
  <ul><li> 
    <ul><li id="uddb72843">MO：在线</li><li id="uc0419e02">MD：donw机状态</li><li id="ue5e9f942">MR：正在恢复</li></ul></li></ul></li></ul> 
<h4 id="qCXb9">2. 带有镜像的chunk异常的后果</h4> 
<ul><li id="u660fff2f">如果primary chunk和镜像Mchunk都遇到了IO错误，或者primarychunk遇到了IO错误但是没有使用镜像，会显示离线</li><li id="u852694af">如果离线的数据库是关键数据库，则数据库重启会失败</li><li id="uf32f801f">如果离线的数据空间时非关键数据空间，启动会成功但是需要修复离线的chunk空间</li><li id="ubd649753">离线的chunk不会自动恢复，需要人工介入</li></ul> 
<h4 id="OgGnR">3. 关于镜像chunk出现io错误时的相关参数ONDBSPACEDOWN</h4> 
<ul><li id="u5a87e4ad">ONDBSPACEDOWN</li></ul> 
<ul><li> 
  <ul><li id="ufcbf4baa">0：设备：标记为离线然后继续运行</li><li id="ue66a71f5">1：关闭数据库</li><li id="u372e4724">2：挂起所有的更新操作，直到下次检查点</li></ul></li></ul> 
<ul><li id="u148db3a0">如果IO出现错误的chunk是关键chunk，只能进行关闭</li><li id="uc437f8ff">如果设置为2，服务器会继续检查产产生IO错误的chunk，如果在下次checkpoint时问题已经纠正，则不需要干预，数据库处理会恢复；如果没有恢复，则所有的线索都会挂起</li></ul> 
<h4 id="j5Icu">4. chunk出现IO错误的一般处理方式</h4> 
<ul><li id="ub53ab279">修复chunk设备，关闭数据库并重启，数据库启动成功，chunk会变成在线状态</li><li id="ua0db3bc3">把chunk标记为离线，挂起的线索会继续运行，可以通过onmode -o实现</li></ul> 
<ul><li> 
  <ul><li id="ub442abc6">onmode -o不能在磁盘设备不能恢复时使用，当替换了新磁盘，需要dbspace的热恢复</li></ul></li></ul> 
<h4 id="uFrNM">5. 镜像chunk恢复失败的chunk的命令</h4> 
<ul><li id="u1efddcb6">针对出现问题的chunk使用镜像恢复如下</li></ul> 
<ul><li> 
  <ul><li id="u6a1887a2">实际上是把其中一个chunk的信息恢复到另一个chunk中</li></ul></li></ul> 
<pre id="EtANh"><code class="language-bash">onspaces -s 失效的dbs -p 失效的chunk路径 -o 0 -O</code></pre> 
<ul><li id="u1de94680">当恢复的dbs是blobdbs时，恢复是瞬间的</li><li id="u6bd86881">当针对已经存在的dbspace增加镜像时，时间取决于dbspace的大小</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6fb2acd42fdfa8ae4ac5f52f8c1d3de8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">xcode和iPhone真机或者watch真机连接问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/092c052b258ca8f85fe967f59a041685/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CleanMyMac X for Mac v4.15.4 最新破解激活版</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>